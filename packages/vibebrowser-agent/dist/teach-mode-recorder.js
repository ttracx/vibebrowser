(()=>{"use strict";(()=>{const t="nxtscape-teach-recorder-initialized";if(window[t])return;window[t]=!0;const e=new class{constructor(){this.isRecording=!1,this.eventCounter=0,this.lastHeartbeatTime=Date.now(),this.heartbeatCheckInterval=null,this.initialInputTarget=null,this.initialPointerTarget=null,this.pointerDownTimestamp=0,this.scrollTimer=null,this.lastScrollPosition={x:0,y:0},this.scrollStartPosition={x:0,y:0},this.scrollTarget=null,this.isScrolling=!1,this.handleKeyDown=t=>{if(!t.isTrusted)return;this.setInitialInputTarget(t);["Enter","Tab","Escape","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown"].includes(t.key)&&this.sendEvent({type:"keydown",action:{key:{key:t.key,code:t.code,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey}}})},this.handleKeyUp=t=>{if(!t.isTrusted)return;["Enter","Tab","Escape"].includes(t.key)&&this.sendEvent({type:"keyup",action:{key:{key:t.key,code:t.code}}})},this.handleInput=t=>{t.isTrusted&&this.setInitialInputTarget(t)},this.handleChange=t=>{if(!t.isTrusted)return;if(this.setInitialInputTarget(t),!this.initialInputTarget)return;const{element:e,context:i}=this.initialInputTarget;if(e instanceof HTMLInputElement&&("checkbox"===e.type||"radio"===e.type))return;let n="";"value"in e&&(n=e.value),this.sendEvent({type:"change",target:i,action:{value:n}})},this.handlePointerDown=t=>{t.isTrusted&&(this.pointerDownTimestamp=t.timeStamp,this.setInitialPointerTarget(t))},this.handleClick=t=>{if(!t.isTrusted)return;if(this.setInitialPointerTarget(t),!this.initialPointerTarget)return;const{element:e,context:i}=this.initialPointerTarget,n=e.getBoundingClientRect(),s=t.clientX-n.left,o=t.clientY-n.top;this.sendEvent({type:"click",target:i,action:{mouse:{button:t.button,x:t.pageX,y:t.pageY,offsetX:Math.round(s),offsetY:Math.round(o)},key:t.altKey||t.ctrlKey||t.metaKey||t.shiftKey?{key:"",altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey}:void 0}})},this.handleDoubleClick=t=>{if(!t.isTrusted)return;if(this.setInitialPointerTarget(t),!this.initialPointerTarget)return;const{element:e,context:i}=this.initialPointerTarget,n=e.getBoundingClientRect(),s=t.clientX-n.left,o=t.clientY-n.top;this.sendEvent({type:"dblclick",target:i,action:{mouse:{button:t.button,x:t.pageX,y:t.pageY,offsetX:Math.round(s),offsetY:Math.round(o)}}})},this.handleBeforeUnload=t=>{t.isTrusted&&this.sendEvent({type:"beforeunload",action:{}})},this.handleScroll=t=>{if(!t.isTrusted)return;this.scrollTimer&&clearTimeout(this.scrollTimer);const e=t.target;if(e===document||e===document.documentElement||e===document.body||e===window)this.isScrolling||(this.scrollStartPosition={x:window.scrollX,y:window.scrollY},this.scrollTarget=null,this.isScrolling=!0);else{if(!(e instanceof Element))return;{const t=e;(!this.isScrolling||this.scrollTarget&&this.scrollTarget.element!==t)&&(this.scrollStartPosition={x:t.scrollLeft,y:t.scrollTop},this.scrollTarget={element:t,context:this.computeElementContext(t)},this.isScrolling=!0)}}this.scrollTimer=setTimeout(()=>{this.recordScrollEvent(),this.isScrolling=!1},150)},this.handleWheel=t=>{t.isTrusted},this.getTabId(),this.sendMessage({action:"RECORDER_READY",source:"TeachModeRecorder"})}getTabId(){chrome.runtime.sendMessage({action:"GET_TAB_ID"},t=>{t?.tabId&&(window.__tabId=t.tabId)})}start(){this.isRecording&&this.stop(),this.isRecording=!0,this.lastHeartbeatTime=Date.now(),this.heartbeatCheckInterval=setInterval(()=>{Date.now()-this.lastHeartbeatTime>200&&this.stop()},100),this.lastScrollPosition={x:window.scrollX,y:window.scrollY},window.addEventListener("keydown",this.handleKeyDown,!0),window.addEventListener("keyup",this.handleKeyUp,!0),window.addEventListener("input",this.handleInput,!0),window.addEventListener("change",this.handleChange,!0),window.addEventListener("pointerdown",this.handlePointerDown,!0),window.addEventListener("click",this.handleClick,!0),window.addEventListener("auxclick",this.handleClick,!0),window.addEventListener("dblclick",this.handleDoubleClick,!0),window.addEventListener("scroll",this.handleScroll,!0),window.addEventListener("wheel",this.handleWheel,{passive:!0,capture:!0})}stop(){this.isRecording&&(this.isRecording=!1,this.heartbeatCheckInterval&&(clearInterval(this.heartbeatCheckInterval),this.heartbeatCheckInterval=null),this.scrollTimer&&(clearTimeout(this.scrollTimer),this.scrollTimer=null),this.isScrolling=!1,this.scrollTarget=null,window.removeEventListener("keydown",this.handleKeyDown,!0),window.removeEventListener("keyup",this.handleKeyUp,!0),window.removeEventListener("input",this.handleInput,!0),window.removeEventListener("change",this.handleChange,!0),window.removeEventListener("pointerdown",this.handlePointerDown,!0),window.removeEventListener("click",this.handleClick,!0),window.removeEventListener("auxclick",this.handleClick,!0),window.removeEventListener("dblclick",this.handleDoubleClick,!0),window.removeEventListener("scroll",this.handleScroll,!0),window.removeEventListener("wheel",this.handleWheel,!0),window.removeEventListener("beforeunload",this.handleBeforeUnload,!0))}computeElementContext(t){const e={};try{e.css=this.getCSSSelector(t)}catch(t){}try{e.xpath=this.getXPath(t)}catch(t){}const i=t.getAttribute("aria-label"),n=(t.getAttribute("aria-labelledby"),t.getAttribute("role"));i&&(e.ariaLabel=i),n&&(e.css=`[role="${n}"]${e.css?` ${e.css}`:""}`);const s=t.textContent?.trim();s&&s.length<100&&(e.text=s);const o=t.getBoundingClientRect(),r={};for(const e of t.attributes)r[e.name]=e.value;const a=t.getAttribute("data-testid")||t.getAttribute("data-test-id");a&&(e.dataTestId=a);return{selectors:e,element:{tagName:t.tagName.toLowerCase(),type:t.getAttribute("type")||void 0,text:t.textContent?.trim()||void 0,value:"value"in t?t.value:void 0,placeholder:t.getAttribute("placeholder")||void 0,attributes:r,boundingBox:{x:o.x,y:o.y,width:o.width,height:o.height},isVisible:o.width>0&&o.height>0,isInteractive:!t.hasAttribute("disabled"),isDisabled:t.hasAttribute("disabled")}}}getCSSSelector(t){if(t.id)return`#${CSS.escape(t.id)}`;const e=t.getAttribute("data-testid")||t.getAttribute("data-test-id");if(e)return`[data-testid="${CSS.escape(e)}"]`;let i=t.tagName.toLowerCase();if(t.className&&"string"==typeof t.className){const e=t.className.trim().split(/\s+/).filter(t=>t.length>0).map(t=>`.${CSS.escape(t)}`).join("");e&&(i+=e)}const n=t.getAttribute("type"),s=t.getAttribute("name");return n&&(i+=`[type="${CSS.escape(n)}"]`),s&&(i+=`[name="${CSS.escape(s)}"]`),i}getXPath(t){const e=[];let i=t;for(;i&&i.nodeType===Node.ELEMENT_NODE;){let t=0,n=i.previousSibling;for(;n;)n.nodeType===Node.ELEMENT_NODE&&n.tagName===i.tagName&&t++,n=n.previousSibling;const s=i.tagName.toLowerCase(),o=t>0?`${s}[${t+1}]`:s;e.unshift(o),i=i.parentElement}return e.length>0?`//${e.join("/")}`:""}sendEvent(t){if(!this.isRecording)return;const e=window.__tabId,i={action:"EVENT_CAPTURED",source:"TeachModeRecorder",event:{id:"content_event_"+this.eventCounter++,timestamp:Date.now(),tabId:e,action:{type:t.type,...t.action},target:t.target}};this.sendMessage(i)}sendMessage(t){try{chrome.runtime.sendMessage(t)}catch(t){}}setInitialInputTarget(t){const e=t.composedPath()[0];e instanceof Element&&this.initialInputTarget?.element!==e&&(this.initialInputTarget={element:e,context:this.computeElementContext(e)})}setInitialPointerTarget(t){const e=t.composedPath()[0];e instanceof Element&&this.initialPointerTarget?.element!==e&&(this.initialPointerTarget={element:e,context:this.computeElementContext(e)})}recordScrollEvent(){let t=0,e=0,i=0,n=0;if(this.scrollTarget){const s=this.scrollTarget.element;t=s.scrollLeft,e=s.scrollTop,i=t-this.scrollStartPosition.x,n=e-this.scrollStartPosition.y}else t=window.scrollX,e=window.scrollY,i=t-this.scrollStartPosition.x,n=e-this.scrollStartPosition.y;0===i&&0===n||(this.sendEvent({type:"scroll",target:this.scrollTarget?.context,action:{scroll:{x:t,y:e,deltaX:i,deltaY:n}}}),this.lastScrollPosition={x:t,y:e})}};chrome.runtime.onMessage.addListener((t,i,n)=>{const s=t;if("TeachModeService"===s.source){switch(s.action){case"START_RECORDING":s.targetTabId&&(window.__tabId=s.targetTabId),e.isRecording||e.start(),n({success:!0});break;case"STOP_RECORDING":e.stop(),n({success:!0});break;case"HEARTBEAT_PING":e.lastHeartbeatTime=Date.now(),n({success:!0,alive:!0,timestamp:Date.now(),isRecording:e.isRecording});break;default:return}return!0}})})()})();
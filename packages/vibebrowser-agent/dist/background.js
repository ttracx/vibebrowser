(()=>{var e={58:(e,t,n)=>{"use strict";n.d(t,{DS:()=>u,Tr:()=>l,bO:()=>a,gI:()=>o,xW:()=>c});var r=n(765),s=n(4350),i=n(9830);class a extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new a({start:e=>function n(){return t.read().then(({done:t,value:r})=>{if(!t)return e.enqueue(r),n();e.close()})}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new a({async pull(t){const{value:n,done:r}=await e.next();r&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function o(e,t=2){const n=Array.from({length:t},()=>[]);return n.map(async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of n)e.push(t)}else{if(t[0].done)return;yield t.shift().value}})}function c(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const n={...e};for(const[e,r]of Object.entries(t))e in n&&!Array.isArray(n[e])?n[e]=c(n[e],r):n[e]=r;return n}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class l{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,n)=>{s.Nx.runWithConfig((0,r.DY)(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,n):this.firstResult.then(e=>t(void 0),n)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?s.Nx.runWithConfig((0,r.DY)(this.config),this.signal?async()=>(0,i.o)(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function u(e,t,n,r,...s){const i=new l({generator:t,startSetup:n,signal:r}),a=await i.setup;return{output:e(i,a,...s),setup:a}}},144:(e,t,n)=>{"use strict";const r=n(3908);e.exports=(e,t,n=!1)=>{if(e instanceof r)return e;try{return new r(e,t)}catch(e){if(!n)return null;throw e}}},194:(e,t,n)=>{"use strict";n.d(t,{fL:()=>a,qG:()=>r.qG});var r=n(5787),s=n(7671);function i(e,t){const n="number"==typeof t?void 0:t;return{name:e.name,description:e.description,parameters:(0,s.PF)(e.schema),...void 0!==n?.strict?{strict:n.strict}:{}}}function a(e,t){const n="number"==typeof t?void 0:t;let s;return s=(0,r.qG)(e)?{type:"function",function:i(e)}:e,void 0!==n?.strict&&(s.function.strict=n.strict),s}},199:(e,t,n)=>{"use strict";function r(e){return!(!e||"object"!=typeof e||!("type"in e)||"tool_call"!==e.type)}function s(e){return!!(e&&"object"==typeof e&&"toolCall"in e&&null!=e.toolCall&&"object"==typeof e.toolCall&&"id"in e.toolCall&&"string"==typeof e.toolCall.id)}n.d(t,{Ky:()=>r,hR:()=>s,qe:()=>i});class i extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}},211:(e,t,n)=>{"use strict";n.d(t,{mg:()=>s,uo:()=>a});var r=n(1346);const s={small:512,medium:768,large:1028};class i{constructor(){}static getInstance(){return i.instance||(i.instance=new i),i.instance}async getInteractiveSnapshot(e,t){try{return new Promise((n,r)=>{t?chrome.browserOS.getInteractiveSnapshot(e,t,e=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError?.message||"Unknown error")):n(e)}):chrome.browserOS.getInteractiveSnapshot(e,e=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError?.message||"Unknown error")):n(e)})})}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed to get interactive snapshot: ${t}`)}}async click(e,t){try{return new Promise((n,r)=>{chrome.browserOS.click(e,t,()=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError?.message||"Unknown error")):n()})})}catch(e){const n=e instanceof Error?e.message:String(e);throw new Error(`Failed to click node ${t}: ${n}`)}}async inputText(e,t,n){try{return new Promise((r,s)=>{chrome.browserOS.inputText(e,t,n,()=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError?.message||"Unknown error")):r()})})}catch(e){const n=e instanceof Error?e.message:String(e);throw new Error(`Failed to input text into node ${t}: ${n}`)}}async clear(e,t){try{return new Promise((n,r)=>{chrome.browserOS.clear(e,t,()=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError?.message||"Unknown error")):n()})})}catch(e){const n=e instanceof Error?e.message:String(e);throw new Error(`Failed to clear node ${t}: ${n}`)}}async scrollToNode(e,t){try{return new Promise((n,r)=>{chrome.browserOS.scrollToNode(e,t,e=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError?.message||"Unknown error")):n(e)})})}catch(e){const n=e instanceof Error?e.message:String(e);throw new Error(`Failed to scroll to node ${t}: ${n}`)}}async sendKeys(e,t){try{return new Promise((n,r)=>{chrome.browserOS.sendKeys(e,t,()=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError?.message||"Unknown error")):n()})})}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed to send keys: ${t}`)}}async getPageLoadStatus(e){try{return new Promise((t,n)=>{chrome.browserOS.getPageLoadStatus(e,e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError?.message||"Unknown error")):t(e)})})}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed to get page load status: ${t}`)}}async getAccessibilityTree(e){try{return new Promise((t,n)=>{chrome.browserOS.getAccessibilityTree(e,e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError?.message||"Unknown error")):t(e)})})}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed to get accessibility tree: ${t}`)}}async captureScreenshot(e,t,n,r,i){try{return new Promise((a,o)=>{if(void 0!==r&&void 0!==i)chrome.browserOS.captureScreenshot(e,0,n||!1,r,i,e=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError?.message||"Unknown error")):a(e)});else if(void 0!==t||void 0!==n){const r=t?s[t]:0;void 0!==n?chrome.browserOS.captureScreenshot(e,r,n,e=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError?.message||"Unknown error")):a(e)}):chrome.browserOS.captureScreenshot(e,r,e=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError?.message||"Unknown error")):a(e)})}else chrome.browserOS.captureScreenshot(e,e=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError?.message||"Unknown error")):a(e)})})}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed to capture screenshot: ${t}`)}}async getSnapshot(e,t,n){try{const s=(0,r.k)().isEnabled("NEW_SNAPSHOT_FORMAT");return new Promise((r,i)=>{const a=e=>{chrome.runtime.lastError?i(new Error(chrome.runtime.lastError.message)):r(e)};s?n?chrome.browserOS.getSnapshot(e,n,a):chrome.browserOS.getSnapshot(e,a):n?chrome.browserOS.getSnapshot(e,t,n,a):chrome.browserOS.getSnapshot(e,t,a)})}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed to get snapshot: ${t}`)}}async getTextSnapshot(e,t){return this.getSnapshot(e,"text",t)}async getLinksSnapshot(e,t){return this.getSnapshot(e,"links",t)}async invokeAPI(e,...t){try{if(!(e in chrome.browserOS))throw new Error(`Unknown VibeBrowser API method: ${e}`);return await chrome.browserOS[e](...t)}catch(t){const n=t instanceof Error?t.message:String(t);throw new Error(`Failed to invoke VibeBrowser API ${e}: ${n}`)}}isAPIAvailable(e){return e in chrome.browserOS}getAvailableAPIs(){return Object.keys(chrome.browserOS).filter(e=>"function"==typeof chrome.browserOS[e])}async getVersion(){try{return new Promise((e,t)=>{"getVersionNumber"in chrome.browserOS&&"function"==typeof chrome.browserOS.getVersionNumber?chrome.browserOS.getVersionNumber(n=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError?.message||"Unknown error")):e(n)}):e(null)})}catch(e){e instanceof Error?e.message:String(e);return null}}async logMetric(e,t){try{return new Promise((n,r)=>{"logMetric"in chrome.browserOS&&"function"==typeof chrome.browserOS.logMetric?t?chrome.browserOS.logMetric(e,t,()=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError?.message||"Unknown error")):n()}):chrome.browserOS.logMetric(e,()=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError?.message||"Unknown error")):n()}):n()})}catch(e){e instanceof Error?e.message:String(e);return}}async executeJavaScript(e,t){try{return new Promise((n,r)=>{"executeJavaScript"in chrome.browserOS&&"function"==typeof chrome.browserOS.executeJavaScript?chrome.browserOS.executeJavaScript(e,t,e=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError?.message||"Unknown error")):n(e)}):r(new Error("executeJavaScript API not available"))})}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed to execute JavaScript: ${t}`)}}async clickCoordinates(e,t,n){try{return new Promise((r,s)=>{"clickCoordinates"in chrome.browserOS&&"function"==typeof chrome.browserOS.clickCoordinates?chrome.browserOS.clickCoordinates(e,t,n,()=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError?.message||"Unknown error")):r()}):s(new Error("clickCoordinates API not available"))})}catch(e){const r=e instanceof Error?e.message:String(e);throw new Error(`Failed to click at coordinates (${t}, ${n}): ${r}`)}}async typeAtCoordinates(e,t,n,r){try{return new Promise((s,i)=>{"typeAtCoordinates"in chrome.browserOS&&"function"==typeof chrome.browserOS.typeAtCoordinates?chrome.browserOS.typeAtCoordinates(e,t,n,r,()=>{chrome.runtime.lastError?i(new Error(chrome.runtime.lastError?.message||"Unknown error")):s()}):i(new Error("typeAtCoordinates API not available"))})}catch(e){const r=e instanceof Error?e.message:String(e);throw new Error(`Failed to type at coordinates (${t}, ${n}): ${r}`)}}async getPref(e){try{if(!chrome?.browserOS||"function"!=typeof chrome.browserOS.getPref)throw new Error("chrome.browserOS.getPref is not available");return new Promise((t,n)=>{chrome.browserOS.getPref(e,e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError?.message||"Unknown error")):t(e)})})}catch(t){const n=t instanceof Error?t.message:String(t);throw new Error(`Failed to get preference ${e}: ${n}`)}}async setPref(e,t,n){try{if(!chrome?.browserOS||"function"!=typeof chrome.browserOS.setPref)throw new Error("chrome.browserOS.setPref is not available");return new Promise((r,s)=>{void 0!==n?chrome.browserOS.setPref(e,t,n,e=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError?.message||"Unknown error")):r(e)}):chrome.browserOS.setPref(e,t,e=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError?.message||"Unknown error")):r(e)})})}catch(t){const n=t instanceof Error?t.message:String(t);throw new Error(`Failed to set preference ${e}: ${n}`)}}async getAllPrefs(){try{if(!chrome?.browserOS||"function"!=typeof chrome.browserOS.getAllPrefs)throw new Error("chrome.browserOS.getAllPrefs is not available");return new Promise((e,t)=>{chrome.browserOS.getAllPrefs(n=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError?.message||"Unknown error")):e(n)})})}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed to get all preferences: ${t}`)}}}i.instance=null;const a=()=>i.getInstance()},228:e=>{"use strict";var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,r,i,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,i||e,a),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function a(e,t){0===--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,i=r.length,a=new Array(i);s<i;s++)a[s]=r[s].fn;return a},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,i,a){var o=n?n+e:e;if(!this._events[o])return!1;var c,l,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,i),!0;case 6:return u.fn.call(u.context,t,r,s,i,a),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var h,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),d){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,r);break;case 4:u[l].fn.call(u[l].context,t,r,s);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];u[l].fn.apply(u[l].context,c)}}return!0},o.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,s){var i=n?n+e:e;if(!this._events[i])return this;if(!t)return a(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||a(this,i);else{for(var c=0,l=[],u=o.length;c<u;c++)(o[c].fn!==t||s&&!o[c].once||r&&o[c].context!==r)&&l.push(o[c]);l.length?this._events[i]=1===l.length?l[0]:l:a(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o},269:(e,t,n)=>{"use strict";n.d(t,{O7:()=>b,Xe:()=>_});var r=n(621),s=n(7439),i=n(9531),a=n(6739),o=n(7966),c=n(454),l=n(2080);const u="gpt-4o",d="claude-4-sonnet",h="qwen3:4b",p="openai",m="gemini-2.5-flash",g="high",f=l.Ik({temperature:l.ai().min(0).max(1).optional(),maxTokens:l.ai().positive().optional(),intelligence:l.k5(["low","high"]).default(g).optional()});class y{constructor(){this.currentProvider=null,this.modelConfigCache=null,this.CACHE_DURATION_MS=3e5}static getInstance(){return y.instance||(y.instance=new y),y.instance}async getLLM(e){const t=e?f.parse(e):{},n=await o.Q.read();this.currentProvider=n,c.y7.log("LangChainProvider",`Creating new LLM for provider: ${n.name}`,"info");const r=await this._createLLMFromProvider(n,t),s=this._calculateMaxTokens(n,t.maxTokens);return await c.y7.logMetric("llm.created",{provider:n.name,provider_type:n.type,model_name:n.modelId||this._getDefaultModelForProvider(n.type,e?.intelligence),max_tokens:s,temperature:t.temperature??n.modelConfig?.temperature??.2,intelligence:t.intelligence??g}),r}async getModelCapabilities(){const e=await o.Q.read(),t=e.capabilities?.supportsImages??this._getDefaultImageSupport(e.type);let n;if(e.modelConfig?.contextWindow)n=e.modelConfig.contextWindow;else switch(e.type){case"vibebrowser":n=1e6;break;case"openai":case"openai_compatible":case"openrouter":const t=e.modelId||u;n=t.includes("gpt-5")||t.includes("gpt-6")?4e5:t.includes("gpt-4")||t.includes("o1")||t.includes("o3")||t.includes("o4")?128e3:32768;break;case"anthropic":const r=e.modelId||d;n=r.includes("claude-3.7")||r.includes("claude-4")?2e5:1e5;break;case"google_gemini":const s=e.modelId||m;n=s.includes("2.5")||s.includes("2.0")?15e5:1e6;break;case"ollama":const i=e.modelId||h;n=i.includes("mixtral")||i.includes("llama")||i.includes("qwen")||i.includes("deepseek")?32768:8192;break;case"custom":n=32768;break;default:n=8192}return{maxTokens:n,supportsImages:t}}async getCurrentProviderType(){return(await o.Q.read()).type}getCurrentProvider(){return this.currentProvider}clearCache(){this.currentProvider=null,this.modelConfigCache=null}_isReasoningModel(e){return["o1","o3","o4","gpt-5","gpt-6"].some(t=>e.toLowerCase().includes(t))}_isO1StyleReasoningModel(e){return["o1","o3","o4"].some(t=>e.toLowerCase().includes(t))}_isGPT5StyleReasoningModel(e){return["gpt-5","gpt-6"].some(t=>e.toLowerCase().includes(t))}_getDefaultModelForProvider(e,t="high"){switch(e){case"vibebrowser":return this.modelConfigCache?"low"===t?this.modelConfigCache.config.fast:"high"===t?this.modelConfigCache.config.smart:this.modelConfigCache.config.default:p;case"openai":case"openai_compatible":case"openrouter":case"custom":return u;case"anthropic":return d;case"google_gemini":return m;case"ollama":return h;default:return"unknown"}}_getDefaultImageSupport(e){switch(e){case"vibebrowser":case"openai":case"openai_compatible":case"anthropic":case"google_gemini":case"openrouter":return!0;default:return!1}}_patchTokenCounting(e){const t=e;return y.SKIP_TOKEN_COUNTING?(t.getNumTokens=async()=>100,t.getNumTokensFromMessages=async()=>5e3,e):(t.getNumTokens=async function(e){return e.length+3>>2},t.getNumTokensFromMessages=async function(e){let t=20*e.length;for(const n of e){const e=n.content;"string"!=typeof e?Array.isArray(e)?t+=e.length<<6:e&&(t+=100):t+=e.length}return t+3>>2},e)}_calculateMaxTokens(e,t){const n=e.modelConfig?.contextWindow;return t?n?Math.min(t,n):t:n?Math.min(4096,Math.floor(.5*n)):4096}async _createLLMFromProvider(e,t){const n=t?.temperature??e.modelConfig?.temperature??.2,r=this._calculateMaxTokens(e,t?.maxTokens),s=true;switch(e.type){case"vibebrowser":const i=t?.intelligence??g;return await this._createVibeBrowserLLM(n,r,s,i);case"openai":case"openai_compatible":case"openrouter":case"custom":return this._createOpenAICompatibleLLM(e,n,r,s);case"anthropic":return this._createAnthropicLLM(e,n,r,s);case"google_gemini":return this._createGeminiLLM(e,n,r);case"ollama":return this._createOllamaLLM(e,n,r);default:c.y7.log("LangChainProvider",`Unknown provider type: ${e.type}, falling back to VibeBrowser`,"warning");const a=t?.intelligence??g;return await this._createVibeBrowserLLM(n,r,s,a)}}async _fetchModelConfig(){if(this.modelConfigCache){if(Date.now()-this.modelConfigCache.timestamp<this.CACHE_DURATION_MS)return this.modelConfigCache.config}try{const e=await fetch("https://llm.vibebrowser.com/api/model_family");if(e.ok){const t=await e.json(),n={default:t.default||t.model_family||p,fast:t.fast||t.model_family||p,smart:t.smart||t.model_family||p};return this.modelConfigCache={config:n,timestamp:Date.now()},c.y7.log("LangChainProvider",`VibeBrowser model config fetched - default: ${n.default}, fast: ${n.fast}, smart: ${n.smart}`,"info"),n}}catch(e){c.y7.log("LangChainProvider",`Failed to fetch model config, using fallbacks: ${e}`,"warning")}return{default:p,fast:p,smart:p}}async _createVibeBrowserLLM(e,t,n=!0,i=g){const a=await this._fetchModelConfig();let o,c,l;"low"===i?(o=a.fast,c="https://llm.vibebrowser.com/fast/"):(o=a.smart,c="https://llm.vibebrowser.com/smart/");if(-1!==o.indexOf("claude")||-1!==o.indexOf("anthropic"))l=new s.ChatAnthropic({modelName:o,temperature:e,maxTokens:t,streaming:n,anthropicApiKey:"nokey",anthropicApiUrl:c});else{const s=this._isReasoningModel(o),i={modelName:o,temperature:s?1:e,streaming:n,openAIApiKey:"nokey",configuration:{baseURL:c,apiKey:"nokey",dangerouslyAllowBrowser:!0}};s&&t?this._isO1StyleReasoningModel(o)?i.modelKwargs={max_completion_tokens:t}:this._isGPT5StyleReasoningModel(o):t&&(i.maxTokens=t),l=new r.ChatOpenAI(i)}return this._patchTokenCounting(l)}_createOpenAICompatibleLLM(e,t,n,s=!0){e.apiKey||"custom"===e.type||c.y7.log("LangChainProvider",`Warning: No API key for ${e.name} provider, using default`,"warning");const i=e.modelId||u,a=this._isReasoningModel(i),o={modelName:i,streaming:s,openAIApiKey:e.apiKey||"nokey",configuration:{baseURL:e.baseUrl||"https://api.openai.com/v1",apiKey:e.apiKey||"nokey",dangerouslyAllowBrowser:!0}};a?(o.temperature=1,n&&(this._isO1StyleReasoningModel(i)?o.modelKwargs={max_completion_tokens:n}:this._isGPT5StyleReasoningModel(i))):(o.temperature=t,n&&(o.maxTokens=n));const l=new r.ChatOpenAI(o);return this._patchTokenCounting(l)}_createAnthropicLLM(e,t,n,r=!0){if(!e.apiKey)throw new Error(`API key required for ${e.name} provider`);const i=e.modelId||d,a=new s.ChatAnthropic({modelName:i,temperature:t,maxTokens:n,streaming:r,anthropicApiKey:e.apiKey,anthropicApiUrl:e.baseUrl||"https://api.anthropic.com"});return this._patchTokenCounting(a)}_createGeminiLLM(e,t,n){if(!e.apiKey)throw new Error(`API key required for ${e.name} provider`);const r=e.modelId||m,s=new a.ChatGoogleGenerativeAI({model:r,temperature:t,maxOutputTokens:n,apiKey:e.apiKey,convertSystemMessageToHumanContent:!0,baseUrl:e.baseUrl||"https://generativelanguage.googleapis.com"});return this._patchTokenCounting(s)}_createOllamaLLM(e,t,n){let r=e.baseUrl||"http://127.0.0.1:11434";r.includes("localhost")&&(r=r.replace("localhost","127.0.0.1"),c.y7.log("LangChainProvider",'Replaced "localhost" with "127.0.0.1" in Ollama URL for better compatibility',"info"));const s={model:e.modelId||h,temperature:t,maxRetries:2,baseUrl:r};e.modelConfig?.contextWindow&&(s.numCtx=e.modelConfig.contextWindow);const a=new i.ChatOllama(s);return this._patchTokenCounting(a)}}y.SKIP_TOKEN_COUNTING=!1;const _=y.getInstance();async function b(e){return _.getLLM(e)}},270:(e,t,n)=>{"use strict";const r=n(3908),s=n(8311);e.exports=(e,t,n)=>{let i=null,a=null,o=null;try{o=new s(t,n)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(i&&1!==a.compare(e)||(i=e,a=new r(i,n)))}),i}},342:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var r=n(5616),s=n(9115);const i=(e,t)=>{let n;switch(e.code){case r.eq.invalid_type:n=e.received===s.Zp.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case r.eq.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,s.ZS.jsonStringifyReplacer)}`;break;case r.eq.unrecognized_keys:n=`Unrecognized key(s) in object: ${s.ZS.joinValues(e.keys,", ")}`;break;case r.eq.invalid_union:n="Invalid input";break;case r.eq.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${s.ZS.joinValues(e.options)}`;break;case r.eq.invalid_enum_value:n=`Invalid enum value. Expected ${s.ZS.joinValues(e.options)}, received '${e.received}'`;break;case r.eq.invalid_arguments:n="Invalid function arguments";break;case r.eq.invalid_return_type:n="Invalid function return type";break;case r.eq.invalid_date:n="Invalid date";break;case r.eq.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:s.ZS.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case r.eq.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type||"bigint"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case r.eq.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case r.eq.custom:n="Invalid input";break;case r.eq.invalid_intersection_types:n="Intersection results could not be merged";break;case r.eq.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case r.eq.not_finite:n="Number must be finite";break;default:n=t.defaultError,s.ZS.assertNever(e)}return{message:n}}},454:(e,t,n)=>{"use strict";n.d(t,{y7:()=>l});var r=n(1611),s=n(823),i=n(211),a=n(2080),o=n(5476);const c=a.k5(["info","error","warning"]);a.Ik({source:a.Yj(),message:a.Yj(),level:c,timestamp:a.Yj()});class l{static initialize(e={}){this.debugMode=e.debugMode||!1,this.posthogApiKey&&!this.posthogInitialized&&(o.Ay.init(this.posthogApiKey,{api_host:"https://us.i.posthog.com",person_profiles:"identified_only"}),this.posthogInitialized=!0)}static registerPort(e,t){this.connectedPorts.set(e,t)}static unregisterPort(e){this.connectedPorts.delete(e)}static log(e,t,n="info"){if(!this.debugMode&&"info"===n)return;const i={source:e,message:t,level:n,timestamp:(new Date).toISOString()};let a=!1;if((0,s.D5)()){let e,t;for(const[n,r]of this.connectedPorts.entries())if("options"===n){e=r,t=n;break}if(e&&t)try{void 0!==e.name?(e.postMessage({type:r.Go.LOG,payload:i}),a=!0):this.unregisterPort(t)}catch(e){this.unregisterPort(t)}}!a&&"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage({type:r.Go.LOG,payload:i}).catch(e=>{})}static async logMetric(e,t,n=1){if(Math.random()>n)return;const r=`agent.${e}`;let s;try{s=chrome.runtime.getManifest().version}catch{}const a={...t,...s&&{version:s}};try{await(0,i.uo)().logMetric(r,a)}catch(t){if(this.posthogApiKey&&this.posthogInitialized)try{o.Ay.capture("agent.metric_api_failed",{event:e,...s&&{version:s}}),o.Ay.capture(r,a)}catch(e){}}}}l.connectedPorts=new Map,l.debugMode=!1,l.posthogInitialized=!1,l.posthogApiKey=""},528:(e,t,n)=>{"use strict";n.d(t,{ZE:()=>F,j_:()=>Y,Z2:()=>U,VC:()=>D});var r="object"==typeof window?window:{},s="0123456789abcdef".split(""),i=[-2147483648,8388608,32768,128],a=[24,16,8,0],o=[];function c(e){e?(o[0]=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0,this.blocks=o):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}c.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===r.ArrayBuffer&&(e=new Uint8Array(e));for(var n,s,i=0,o=e.length||0,c=this.blocks;i<o;){if(this.hashed&&(this.hashed=!1,c[0]=this.block,c[16]=c[1]=c[2]=c[3]=c[4]=c[5]=c[6]=c[7]=c[8]=c[9]=c[10]=c[11]=c[12]=c[13]=c[14]=c[15]=0),t)for(s=this.start;i<o&&s<64;++i)c[s>>2]|=e[i]<<a[3&s++];else for(s=this.start;i<o&&s<64;++i)(n=e.charCodeAt(i))<128?c[s>>2]|=n<<a[3&s++]:n<2048?(c[s>>2]|=(192|n>>6)<<a[3&s++],c[s>>2]|=(128|63&n)<<a[3&s++]):n<55296||n>=57344?(c[s>>2]|=(224|n>>12)<<a[3&s++],c[s>>2]|=(128|n>>6&63)<<a[3&s++],c[s>>2]|=(128|63&n)<<a[3&s++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++i)),c[s>>2]|=(240|n>>18)<<a[3&s++],c[s>>2]|=(128|n>>12&63)<<a[3&s++],c[s>>2]|=(128|n>>6&63)<<a[3&s++],c[s>>2]|=(128|63&n)<<a[3&s++]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=c[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},c.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=i[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},c.prototype.hash=function(){var e,t,n=this.h0,r=this.h1,s=this.h2,i=this.h3,a=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)n=(t=(r=(t=(s=(t=(i=(t=(a=(t=n<<5|n>>>27)+(r&s|~r&i)+a+1518500249+o[e]|0)<<5|a>>>27)+(n&(r=r<<30|r>>>2)|~n&s)+i+1518500249+o[e+1]|0)<<5|i>>>27)+(a&(n=n<<30|n>>>2)|~a&r)+s+1518500249+o[e+2]|0)<<5|s>>>27)+(i&(a=a<<30|a>>>2)|~i&n)+r+1518500249+o[e+3]|0)<<5|r>>>27)+(s&(i=i<<30|i>>>2)|~s&a)+n+1518500249+o[e+4]|0,s=s<<30|s>>>2;for(;e<40;e+=5)n=(t=(r=(t=(s=(t=(i=(t=(a=(t=n<<5|n>>>27)+(r^s^i)+a+1859775393+o[e]|0)<<5|a>>>27)+(n^(r=r<<30|r>>>2)^s)+i+1859775393+o[e+1]|0)<<5|i>>>27)+(a^(n=n<<30|n>>>2)^r)+s+1859775393+o[e+2]|0)<<5|s>>>27)+(i^(a=a<<30|a>>>2)^n)+r+1859775393+o[e+3]|0)<<5|r>>>27)+(s^(i=i<<30|i>>>2)^a)+n+1859775393+o[e+4]|0,s=s<<30|s>>>2;for(;e<60;e+=5)n=(t=(r=(t=(s=(t=(i=(t=(a=(t=n<<5|n>>>27)+(r&s|r&i|s&i)+a-1894007588+o[e]|0)<<5|a>>>27)+(n&(r=r<<30|r>>>2)|n&s|r&s)+i-1894007588+o[e+1]|0)<<5|i>>>27)+(a&(n=n<<30|n>>>2)|a&r|n&r)+s-1894007588+o[e+2]|0)<<5|s>>>27)+(i&(a=a<<30|a>>>2)|i&n|a&n)+r-1894007588+o[e+3]|0)<<5|r>>>27)+(s&(i=i<<30|i>>>2)|s&a|i&a)+n-1894007588+o[e+4]|0,s=s<<30|s>>>2;for(;e<80;e+=5)n=(t=(r=(t=(s=(t=(i=(t=(a=(t=n<<5|n>>>27)+(r^s^i)+a-899497514+o[e]|0)<<5|a>>>27)+(n^(r=r<<30|r>>>2)^s)+i-899497514+o[e+1]|0)<<5|i>>>27)+(a^(n=n<<30|n>>>2)^r)+s-899497514+o[e+2]|0)<<5|s>>>27)+(i^(a=a<<30|a>>>2)^n)+r-899497514+o[e+3]|0)<<5|r>>>27)+(s^(i=i<<30|i>>>2)^a)+n-899497514+o[e+4]|0,s=s<<30|s>>>2;this.h0=this.h0+n|0,this.h1=this.h1+r|0,this.h2=this.h2+s|0,this.h3=this.h3+i|0,this.h4=this.h4+a|0},c.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,i=this.h4;return s[e>>28&15]+s[e>>24&15]+s[e>>20&15]+s[e>>16&15]+s[e>>12&15]+s[e>>8&15]+s[e>>4&15]+s[15&e]+s[t>>28&15]+s[t>>24&15]+s[t>>20&15]+s[t>>16&15]+s[t>>12&15]+s[t>>8&15]+s[t>>4&15]+s[15&t]+s[n>>28&15]+s[n>>24&15]+s[n>>20&15]+s[n>>16&15]+s[n>>12&15]+s[n>>8&15]+s[n>>4&15]+s[15&n]+s[r>>28&15]+s[r>>24&15]+s[r>>20&15]+s[r>>16&15]+s[r>>12&15]+s[r>>8&15]+s[r>>4&15]+s[15&r]+s[i>>28&15]+s[i>>24&15]+s[i>>20&15]+s[i>>16&15]+s[i>>12&15]+s[i>>8&15]+s[i>>4&15]+s[15&i]},c.prototype.toString=c.prototype.hex,c.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,s=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,s>>24&255,s>>16&255,s>>8&255,255&s]},c.prototype.array=c.prototype.digest,c.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};let l=!1;var u="0123456789abcdef".split(""),d=[-2147483648,8388608,32768,128],h=[24,16,8,0],p=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],m=[];function g(e,t){t?(m[0]=m[16]=m[1]=m[2]=m[3]=m[4]=m[5]=m[6]=m[7]=m[8]=m[9]=m[10]=m[11]=m[12]=m[13]=m[14]=m[15]=0,this.blocks=m):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}g.prototype.update=function(e){if(!this.finalized){var t,n=typeof e;if("string"!==n){if("object"!==n)throw new Error(ERROR);if(null===e)throw new Error(ERROR);if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||ARRAY_BUFFER&&ArrayBuffer.isView(e)))throw new Error(ERROR);t=!0}for(var r,s,i=0,a=e.length,o=this.blocks;i<a;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(s=this.start;i<a&&s<64;++i)o[s>>>2]|=e[i]<<h[3&s++];else for(s=this.start;i<a&&s<64;++i)(r=e.charCodeAt(i))<128?o[s>>>2]|=r<<h[3&s++]:r<2048?(o[s>>>2]|=(192|r>>>6)<<h[3&s++],o[s>>>2]|=(128|63&r)<<h[3&s++]):r<55296||r>=57344?(o[s>>>2]|=(224|r>>>12)<<h[3&s++],o[s>>>2]|=(128|r>>>6&63)<<h[3&s++],o[s>>>2]|=(128|63&r)<<h[3&s++]):(r=65536+((1023&r)<<10|1023&e.charCodeAt(++i)),o[s>>>2]|=(240|r>>>18)<<h[3&s++],o[s>>>2]|=(128|r>>>12&63)<<h[3&s++],o[s>>>2]|=(128|r>>>6&63)<<h[3&s++],o[s>>>2]|=(128|63&r)<<h[3&s++]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=o[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},g.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=d[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},g.prototype.hash=function(){var e,t,n,r,s,i,a,o,c,l=this.h0,u=this.h1,d=this.h2,h=this.h3,m=this.h4,g=this.h5,f=this.h6,y=this.h7,_=this.blocks;for(e=16;e<64;++e)t=((s=_[e-15])>>>7|s<<25)^(s>>>18|s<<14)^s>>>3,n=((s=_[e-2])>>>17|s<<15)^(s>>>19|s<<13)^s>>>10,_[e]=_[e-16]+t+_[e-7]+n|0;for(c=u&d,e=0;e<64;e+=4)this.first?(this.is224?(i=300032,y=(s=_[0]-1413257819)-150054599|0,h=s+24177077|0):(i=704751109,y=(s=_[0]-210244248)-1521486534|0,h=s+143694565|0),this.first=!1):(t=(l>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10),r=(i=l&u)^l&d^c,y=h+(s=y+(n=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(m&g^~m&f)+p[e]+_[e])|0,h=s+(t+r)|0),t=(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),r=(a=h&l)^h&u^i,f=d+(s=g+(n=(y>>>6|y<<26)^(y>>>11|y<<21)^(y>>>25|y<<7))+(f&y^~f&m)+p[e+1]+_[e+1])|0,t=((d=s+(t+r)|0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),r=(o=d&h)^d&l^a,g=u+(s=m+(n=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7))+(g&f^~g&y)+p[e+2]+_[e+2])|0,t=((u=s+(t+r)|0)>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),r=(c=u&d)^u&h^o,m=l+(s=m+(n=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7))+(g&f^~g&y)+p[e+3]+_[e+3])|0,l=s+(t+r)|0,this.chromeBugWorkAround=!0;this.h0=this.h0+l|0,this.h1=this.h1+u|0,this.h2=this.h2+d|0,this.h3=this.h3+h|0,this.h4=this.h4+m|0,this.h5=this.h5+g|0,this.h6=this.h6+f|0,this.h7=this.h7+y|0},g.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=u[e>>>28&15]+u[e>>>24&15]+u[e>>>20&15]+u[e>>>16&15]+u[e>>>12&15]+u[e>>>8&15]+u[e>>>4&15]+u[15&e]+u[t>>>28&15]+u[t>>>24&15]+u[t>>>20&15]+u[t>>>16&15]+u[t>>>12&15]+u[t>>>8&15]+u[t>>>4&15]+u[15&t]+u[n>>>28&15]+u[n>>>24&15]+u[n>>>20&15]+u[n>>>16&15]+u[n>>>12&15]+u[n>>>8&15]+u[n>>>4&15]+u[15&n]+u[r>>>28&15]+u[r>>>24&15]+u[r>>>20&15]+u[r>>>16&15]+u[r>>>12&15]+u[r>>>8&15]+u[r>>>4&15]+u[15&r]+u[s>>>28&15]+u[s>>>24&15]+u[s>>>20&15]+u[s>>>16&15]+u[s>>>12&15]+u[s>>>8&15]+u[s>>>4&15]+u[15&s]+u[i>>>28&15]+u[i>>>24&15]+u[i>>>20&15]+u[i>>>16&15]+u[i>>>12&15]+u[i>>>8&15]+u[i>>>4&15]+u[15&i]+u[a>>>28&15]+u[a>>>24&15]+u[a>>>20&15]+u[a>>>16&15]+u[a>>>12&15]+u[a>>>8&15]+u[a>>>4&15]+u[15&a];return this.is224||(c+=u[o>>>28&15]+u[o>>>24&15]+u[o>>>20&15]+u[o>>>16&15]+u[o>>>12&15]+u[o>>>8&15]+u[o>>>4&15]+u[15&o]),c},g.prototype.toString=g.prototype.hex,g.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,c=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,n>>>24&255,n>>>16&255,n>>>8&255,255&n,r>>>24&255,r>>>16&255,r>>>8&255,255&r,s>>>24&255,s>>>16&255,s>>>8&255,255&s,i>>>24&255,i>>>16&255,i>>>8&255,255&i,a>>>24&255,a>>>16&255,a>>>8&255,255&a];return this.is224||c.push(o>>>24&255,o>>>16&255,o>>>8&255,255&o),c},g.prototype.array=g.prototype.digest,g.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e};var f=n(6362);const y=(...e)=>{return t=e.join("_"),l||(l=!0),new c(!0).update(t).hex();var t};class _{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:y})}makeDefaultKeyEncoder(e){this.keyEncoder=e}}const b=new Map;class w extends _{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,n){this.cache.set(this.keyEncoder(e,t),n)}static global(){return new w(b)}}var v=n(8999),E=n(5454);class S extends v.y{}class x extends S{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new E.xc(this.value)]}}class k extends S{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return(0,f.Sw)(this.messages)}toChatMessages(){return this.messages}}var T=n(9624),I=n(7526),O=Object.defineProperty;function C(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;n.length>1;){let r=null;for(let s=0;s<n.length-1;s++){const i=e.slice(n[s].start,n[s+1].end),a=t.get(i.join(","));null!=a&&(null==r||a<r[0])&&(r=[a,s])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map(n=>t.get(e.slice(n.start,n.end).join(","))).filter(e=>null!=e)}var A,P=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const n=e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{const[n,r,...s]=t.split(" "),i=Number.parseInt(r,10);return s.forEach((t,n)=>e[t]=i+n),e},{});for(const[e,t]of Object.entries(n)){const n=I.toByteArray(e);this.rankMap.set(n.join(","),t),this.textMap.set(t,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),s=P.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===n?Object.keys(this.specialTokens).filter(e=>!a.has(e)):n);if(o.size>0){const t=P.specialTokenRegex([...o]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let c=0;for(;;){let t=null,n=c;for(;s.lastIndex=n,t=s.exec(e),null!=t&&!a.has(t[0]);)n=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),n=this.rankMap.get(e.join(","));null==n?i.push(...C(e,this.rankMap)):i.push(n)}if(null==t)break;let l=this.specialTokens[t[0]];i.push(l),c=t.index+t[0].length}return i}decode(e){const t=[];let n=0;for(let r=0;r<e.length;++r){const s=e[r],i=this.textMap.get(s)??this.inverseSpecialTokens[s];null!=i&&(t.push(i),n+=i.length)}const r=new Uint8Array(n);let s=0;for(const e of t)r.set(e,s),s+=e.length;return this.textDecoder.decode(r)}},M=P;((e,t,n)=>{t in e?O(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(M,"symbol"!=typeof(A="specialTokenRegex")?A+"":A,e=>new RegExp(e.map(e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")).join("|"),"g"));const R={},$=new T.g({});async function j(e){return async function(e){return e in R||(R[e]=$.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(e=>e.json()).then(e=>new M(e)).catch(t=>{throw delete R[e],t})),await R[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":return"o200k_base";default:throw new Error("Unknown model")}}(e))}var N=n(3292);const L=e=>e.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":e.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":e.startsWith("gpt-4-32k")?"gpt-4-32k":e.startsWith("gpt-4-")?"gpt-4":e.startsWith("gpt-4o")?"gpt-4o":e;function D(e){return!("object"!=typeof e||!e)&&!!("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&e.function&&"name"in e.function&&"parameters"in e.function)}const U=async({prompt:e,modelName:t})=>{let n;try{n=(await j(L(t))).encode(e).length}catch(t){n=Math.ceil(e.length/4)}const r=(e=>{switch(L(e)){case"gpt-3.5-turbo-16k":return 16384;case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":default:return 4097;case"text-curie-001":case"text-babbage-001":case"text-ada-001":case"code-cushman-001":return 2048;case"code-davinci-002":return 8e3}})(t);return r-n};class F extends N.YN{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class Y extends F{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){const{cache:r,...s}=n;super({callbacks:e??t,...s}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache="object"==typeof r?r:r?w.global():void 0,this.caller=new T.g(n??{})}async getNumTokens(e){let t;t="string"==typeof e?e:e.map(e=>"string"==typeof e?e:"text"===e.type&&"text"in e?e.text:"").join("");let n=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await j("modelName"in this?L(this.modelName):"gpt2")}catch(e){}if(this._encoding)try{n=this._encoding.encode(t).length}catch(e){}return n}static _convertInputToPromptValue(e){return"string"==typeof e?new x(e):Array.isArray(e)?new k(e.map(f.K0)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(n).filter(([e,t])=>void 0!==t),s=r.map(([e,t])=>`${e}:${JSON.stringify(t)}`).sort().join(",");return s}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}},560:(e,t,n)=>{"use strict";const r=n(3908);e.exports=(e,t,n)=>new r(e,n).compare(new r(t,n))},621:(e,t,n)=>{"use strict";function r(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n}function s(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}n.d(t,{ChatOpenAI:()=>_i});let i=function(){const{crypto:e}=globalThis;if(e?.randomUUID)return i=e.randomUUID.bind(e),e.randomUUID();const t=new Uint8Array(1),n=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(+e^n()&15>>+e/4).toString(16))};function a(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}const o=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){const t=new Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return new Error(JSON.stringify(e))}catch{}}return new Error(e)};class c extends Error{}class l extends c{constructor(e,t,n,r){super(`${l.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.requestID=r?.get("x-request-id"),this.error=t;const s=t;this.code=s?.code,this.param=s?.param,this.type=s?.type}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e||!r)return new d({message:n,cause:o(t)});const s=t?.error;return 400===e?new p(e,s,n,r):401===e?new m(e,s,n,r):403===e?new g(e,s,n,r):404===e?new f(e,s,n,r):409===e?new y(e,s,n,r):422===e?new _(e,s,n,r):429===e?new b(e,s,n,r):e>=500?new w(e,s,n,r):new l(e,s,n,r)}}class u extends l{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class d extends l{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class h extends d{constructor({message:e}={}){super({message:e??"Request timed out."})}}class p extends l{}class m extends l{}class g extends l{}class f extends l{}class y extends l{}class _ extends l{}class b extends l{}class w extends l{}class v extends c{constructor(){super("Could not parse response content as the length limit was reached")}}class E extends c{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class S extends Error{constructor(e){super(e)}}const x=/^[a-z][a-z0-9+.-]*:/i;let k=e=>(k=Array.isArray,k(e)),T=k;function I(e){return"object"!=typeof e?{}:e??{}}function O(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}const C=e=>new Promise(t=>setTimeout(t,e)),A="5.19.1";const P=()=>{const e="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":A,"X-Stainless-OS":R(Deno.build.os),"X-Stainless-Arch":M(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":A,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":A,"X-Stainless-OS":R(globalThis.process.platform??"unknown"),"X-Stainless-Arch":M(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const t=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":A,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":A,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const M=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",R=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let $;function j(...e){const t=globalThis.ReadableStream;if(void 0===t)throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function N(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return j({start(){},async pull(e){const{done:n,value:r}=await t.next();n?e.close():e.enqueue(r)},async cancel(){await(t.return?.())}})}function L(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const D=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),U="RFC3986",F=e=>String(e),Y={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:F},G="RFC1738";let B=(e,t)=>(B=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),B(e,t));const H=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})();const z=1024;function q(e,t){if(k(e)){const n=[];for(let r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)}const K={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},W=function(e,t){Array.prototype.push.apply(e,k(t)?t:[t])};let V;const J={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,r,s)=>{if(0===e.length)return e;let i=e;if("symbol"==typeof e?i=Symbol.prototype.toString.call(e):"string"!=typeof e&&(i=String(e)),"iso-8859-1"===n)return escape(i).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let a="";for(let e=0;e<i.length;e+=z){const t=i.length>=z?i.slice(e,e+z):i,n=[];for(let e=0;e<t.length;++e){let r=t.charCodeAt(e);45===r||46===r||95===r||126===r||r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||s===G&&(40===r||41===r)?n[n.length]=t.charAt(e):r<128?n[n.length]=H[r]:r<2048?n[n.length]=H[192|r>>6]+H[128|63&r]:r<55296||r>=57344?n[n.length]=H[224|r>>12]+H[128|r>>6&63]+H[128|63&r]:(e+=1,r=65536+((1023&r)<<10|1023&t.charCodeAt(e)),n[n.length]=H[240|r>>18]+H[128|r>>12&63]+H[128|r>>6&63]+H[128|63&r])}a+=n.join("")}return a},encodeValuesOnly:!1,format:U,formatter:F,indices:!1,serializeDate:e=>(V??(V=Function.prototype.call.bind(Date.prototype.toISOString)))(e),skipNulls:!1,strictNullHandling:!1};const Z={};function X(e,t,n,r,s,i,a,o,c,l,u,d,h,p,m,g,f,y){let _=e,b=y,w=0,v=!1;for(;void 0!==(b=b.get(Z))&&!v;){const t=b.get(e);if(w+=1,void 0!==t){if(t===w)throw new RangeError("Cyclic object value");v=!0}void 0===b.get(Z)&&(w=0)}if("function"==typeof l?_=l(t,_):_ instanceof Date?_=h?.(_):"comma"===n&&k(_)&&(_=q(_,function(e){return e instanceof Date?h?.(e):e})),null===_){if(i)return c&&!g?c(t,J.encoder,f,"key",p):t;_=""}if("string"==typeof(E=_)||"number"==typeof E||"boolean"==typeof E||"symbol"==typeof E||"bigint"==typeof E||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(_)){if(c){const e=g?t:c(t,J.encoder,f,"key",p);return[m?.(e)+"="+m?.(c(_,J.encoder,f,"value",p))]}return[m?.(t)+"="+m?.(String(_))]}var E;const S=[];if(void 0===_)return S;let x;if("comma"===n&&k(_))g&&c&&(_=q(_,c)),x=[{value:_.length>0?_.join(",")||null:void 0}];else if(k(l))x=l;else{const e=Object.keys(_);x=u?e.sort(u):e}const T=o?String(t).replace(/\./g,"%2E"):String(t),I=r&&k(_)&&1===_.length?T+"[]":T;if(s&&k(_)&&0===_.length)return I+"[]";for(let t=0;t<x.length;++t){const b=x[t],v="object"==typeof b&&void 0!==b.value?b.value:_[b];if(a&&null===v)continue;const E=d&&o?b.replace(/\./g,"%2E"):b,T=k(_)?"function"==typeof n?n(I,E):I:I+(d?"."+E:"["+E+"]");y.set(e,w);const O=new WeakMap;O.set(Z,y),W(S,X(v,T,n,r,s,i,a,o,"comma"===n&&g&&k(_)?null:c,l,u,d,h,p,m,g,f,O))}return S}function Q(e,t={}){let n=e;const r=function(e=J){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||J.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=U;if(void 0!==e.format){if(!B(Y,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const r=Y[n];let s,i=J.filter;if(("function"==typeof e.filter||k(e.filter))&&(i=e.filter),s=e.arrayFormat&&e.arrayFormat in K?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":J.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=void 0===e.allowDots?1==!!e.encodeDotInKeys||J.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:J.addQueryPrefix,allowDots:a,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:J.allowEmptyArrays,arrayFormat:s,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:J.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?J.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:J.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:J.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:J.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:J.encodeValuesOnly,filter:i,format:n,formatter:r,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:J.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:J.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:J.strictNullHandling}}(t);let s,i;"function"==typeof r.filter?(i=r.filter,n=i("",n)):k(r.filter)&&(i=r.filter,s=i);const a=[];if("object"!=typeof n||null===n)return"";const o=K[r.arrayFormat],c="comma"===o&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);const l=new WeakMap;for(let e=0;e<s.length;++e){const t=s[e];r.skipNulls&&null===n[t]||W(a,X(n[t],t,o,c,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,l))}const u=a.join(r.delimiter);let d=!0===r.addQueryPrefix?"?":"";return r.charsetSentinel&&("iso-8859-1"===r.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}let ee,te;function ne(e){let t;return(ee??(t=new globalThis.TextEncoder,ee=t.encode.bind(t)))(e)}function re(e){let t;return(te??(t=new globalThis.TextDecoder,te=t.decode.bind(t)))(e)}var se,ie;class ae{constructor(){se.set(this,void 0),ie.set(this,void 0),r(this,se,new Uint8Array,"f"),r(this,ie,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?ne(e):e;r(this,se,function(e){let t=0;for(const n of e)t+=n.length;const n=new Uint8Array(t);let r=0;for(const t of e)n.set(t,r),r+=t.length;return n}([s(this,se,"f"),t]),"f");const n=[];let i;for(;null!=(i=oe(s(this,se,"f"),s(this,ie,"f")));){if(i.carriage&&null==s(this,ie,"f")){r(this,ie,i.index,"f");continue}if(null!=s(this,ie,"f")&&(i.index!==s(this,ie,"f")+1||i.carriage)){n.push(re(s(this,se,"f").subarray(0,s(this,ie,"f")-1))),r(this,se,s(this,se,"f").subarray(s(this,ie,"f")),"f"),r(this,ie,null,"f");continue}const e=null!==s(this,ie,"f")?i.preceding-1:i.preceding,t=re(s(this,se,"f").subarray(0,e));n.push(t),r(this,se,s(this,se,"f").subarray(i.index),"f"),r(this,ie,null,"f")}return n}flush(){return s(this,se,"f").length?this.decode("\n"):[]}}function oe(e,t){for(let n=t??0;n<e.length;n++){if(10===e[n])return{preceding:n,index:n+1,carriage:!1};if(13===e[n])return{preceding:n,index:n+1,carriage:!0}}return null}function ce(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}se=new WeakMap,ie=new WeakMap,ae.NEWLINE_CHARS=new Set(["\n","\r"]),ae.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const le={off:0,error:200,warn:300,info:400,debug:500},ue=(e,t,n)=>{var r,s;if(e)return r=le,s=e,Object.prototype.hasOwnProperty.call(r,s)?e:void ge(n).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(le))}`)};function de(){}function he(e,t,n){return!t||le[e]>le[n]?de:t[e].bind(t)}const pe={error:de,warn:de,info:de,debug:de};let me=new WeakMap;function ge(e){const t=e.logger,n=e.logLevel??"off";if(!t)return pe;const r=me.get(t);if(r&&r[0]===n)return r[1];const s={error:he("error",t,n),warn:he("warn",t,n),info:he("info",t,n),debug:he("debug",t,n)};return me.set(t,[n,s]),s}const fe=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);var ye,_e,be;class we{constructor(e,t,n){this.iterator=e,ye.set(this,void 0),this.controller=t,r(this,ye,n,"f")}static fromSSEResponse(e,t,n){let r=!1;const s=n?ge(n):console;return new we(async function*(){if(r)throw new c("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const r of async function*(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new c("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new c("Attempted to iterate over a response with no body")}const n=new ve,r=new ae,s=L(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?ne(n):n;let r,s=new Uint8Array(t.length+e.length);for(s.set(t),s.set(e,t.length),t=s;-1!==(r=ce(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(s))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!n)if(r.data.startsWith("[DONE]"))n=!0;else if(null!==r.event&&r.event.startsWith("thread.")){let e;try{e=JSON.parse(r.data)}catch(e){throw e}if("error"==r.event)throw new l(void 0,e.error,e.message,void 0);yield{event:r.event,data:e}}else{let t;try{t=JSON.parse(r.data)}catch(e){throw s.error("Could not parse message into JSON:",r.data),s.error("From chunk:",r.raw),e}if(t&&t.error)throw new l(void 0,t.error,void 0,e.headers);yield t}n=!0}catch(e){if(a(e))return;throw e}finally{n||t.abort()}},t,n)}static fromReadableStream(e,t,n){let r=!1;return new we(async function*(){if(r)throw new c("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const t of async function*(){const t=new ae,n=L(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())n||t&&(yield JSON.parse(t));n=!0}catch(e){if(a(e))return;throw e}finally{n||t.abort()}},t,n)}[(ye=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new we(()=>r(e),this.controller,s(this,ye,"f")),new we(()=>r(t),this.controller,s(this,ye,"f"))]}toReadableStream(){const e=this;let t;return j({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:n,done:r}=await t.next();if(r)return e.close();const s=ne(JSON.stringify(n)+"\n");e.enqueue(s)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class ve{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(t);if(-1!==n)return[e.substring(0,n),t,e.substring(n+t.length)];return[e,"",""]}(e,":");return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}async function Ee(e,t){const{response:n,requestLogID:r,retryOfRequestLogID:s,startTime:i}=t,a=await(async()=>{if(t.options.stream)return ge(e).debug("response",n.status,n.url,n.headers,n.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(n,t.controller,e):we.fromSSEResponse(n,t.controller,e);if(204===n.status)return null;if(t.options.__binaryResponse)return n;const r=n.headers.get("content-type"),s=r?.split(";")[0]?.trim();if(s?.includes("application/json")||s?.endsWith("+json")){return Se(await n.json(),n)}return await n.text()})();return ge(e).debug(`[${r}] response parsed`,fe({retryOfRequestLogID:s,url:n.url,status:n.status,body:a,durationMs:Date.now()-i})),a}function Se(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class xe extends Promise{constructor(e,t,n=Ee){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=n,_e.set(this,void 0),r(this,_e,e,"f")}_thenUnwrap(e){return new xe(s(this,_e,"f"),this.responsePromise,async(t,n)=>Se(e(await this.parseResponse(t,n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(s(this,_e,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}_e=new WeakMap;class ke{constructor(e,t,n,s){be.set(this,void 0),r(this,be,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new c("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await s(this,be,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(be=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Te extends xe{constructor(e,t,n){super(e,t,async(e,t)=>new n(e,t.response,await Ee(e,t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}class Ie extends ke{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class Oe extends ke{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...I(this.options.query),after:t}}:null}}class Ce extends ke{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.has_more=n.has_more||!1,this.last_id=n.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...I(this.options.query),after:e}}:null}}const Ae=()=>{if("undefined"==typeof File){const{process:e}=globalThis,t="string"==typeof e?.versions?.node&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Pe(e,t,n){return Ae(),new File(e,t??"unknown_file",n)}function Me(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}const Re=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],$e=async(e,t)=>({...e,body:await Ne(e.body,t)}),je=new WeakMap;const Ne=async(e,t)=>{if(!await function(e){const t="function"==typeof e?e:e.fetch,n=je.get(t);if(n)return n;const r=(async()=>{try{const e="Response"in t?t.Response:(await t("data:,")).constructor,n=new FormData;return n.toString()!==await new e(n).text()}catch{return!0}})();return je.set(t,r),r}(t))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const n=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>De(n,e,t))),n},Le=e=>e instanceof Blob&&"name"in e,De=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if(n instanceof Response)e.append(t,Pe([await n.blob()],Me(n)));else if(Re(n))e.append(t,Pe([await new Response(N(n)).blob()],Me(n)));else if(Le(n))e.append(t,n,Me(n));else if(Array.isArray(n))await Promise.all(n.map(n=>De(e,t+"[]",n)));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map(([n,r])=>De(e,`${t}[${n}]`,r)))}}},Ue=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function Fe(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Ue(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else{if(!Re(e)){const t=e?.constructor?.name;throw new Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function(e){if("object"!=typeof e||null===e)return"";const t=Object.getOwnPropertyNames(e);return`; props: [${t.map(e=>`"${e}"`).join(", ")}]`}(e)}`)}for await(const n of e)t.push(...await Fe(n))}return t}class Ye{constructor(e){this._client=e}}function Ge(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const Be=Object.freeze(Object.create(null)),He=(e=Ge)=>function(t,...n){if(1===t.length)return t[0];let r=!1;const s=[],i=t.reduce((t,i,a)=>{/[?#]/.test(i)&&(r=!0);const o=n[a];let c=(r?encodeURIComponent:e)(""+o);return a!==n.length&&(null==o||"object"==typeof o&&o.toString===Object.getPrototypeOf(Object.getPrototypeOf(o.hasOwnProperty??Be)??Be)?.toString)&&(c=o+"",s.push({start:t.length+i.length,length:c.length,error:`Value of type ${Object.prototype.toString.call(o).slice(8,-1)} is not a valid path parameter`})),t+i+(a===n.length?"":c)},""),a=i.split(/[?#]/,1)[0],o=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;let l;for(;null!==(l=o.exec(a));)s.push({start:l.index,length:l[0].length,error:`Value "${l[0]}" can't be safely passed as a path parameter`});if(s.sort((e,t)=>e.start-t.start),s.length>0){let e=0;const t=s.reduce((t,n)=>{const r=" ".repeat(n.start-e),s="^".repeat(n.length);return e=n.start+n.length,t+r+s},"");throw new c(`Path parameters result in path with invalid segments:\n${s.map(e=>e.error).join("\n")}\n${i}\n${t}`)}return i},ze=He(Ge);class qe extends Ye{list(e,t={},n){return this._client.getAPIList(ze`/chat/completions/${e}/messages`,Oe,{query:t,...n})}}function Ke(e){return void 0!==e&&"function"in e&&void 0!==e.function}function We(e){return"auto-parseable-response-format"===e?.$brand}function Ve(e){return"auto-parseable-tool"===e?.$brand}function Je(e,t){const n=e.choices.map(e=>{if("length"===e.finish_reason)throw new v;if("content_filter"===e.finish_reason)throw new E;return et(e.message.tool_calls),{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>function(e,t){const n=e.tools?.find(e=>Ke(e)&&e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:Ve(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?Ze(t,e.message.content):null}}});return{...e,choices:n}}function Ze(e,t){if("json_schema"!==e.response_format?.type)return null;if("json_schema"===e.response_format?.type){if("$parseRaw"in e.response_format){return e.response_format.$parseRaw(t)}return JSON.parse(t)}return null}function Xe(e,t){if(!e||!("tools"in e)||!e.tools)return!1;const n=e.tools?.find(e=>Ke(e)&&e.function?.name===t.function.name);return Ke(n)&&(Ve(n)||n?.function.strict||!1)}function Qe(e){return!!We(e.response_format)||(e.tools?.some(e=>Ve(e)||"function"===e.type&&!0===e.function.strict)??!1)}function et(e){for(const t of e||[])if("function"!==t.type)throw new c(`Currently only \`function\` tool calls are supported; Received \`${t.type}\``)}const tt=e=>"assistant"===e?.role,nt=e=>"tool"===e?.role;var rt,st,it,at,ot,ct,lt,ut,dt,ht,pt,mt,gt,ft,yt,_t,bt,wt,vt,Et,St;class xt{constructor(){rt.add(this),this.controller=new AbortController,st.set(this,void 0),it.set(this,()=>{}),at.set(this,()=>{}),ot.set(this,void 0),ct.set(this,()=>{}),lt.set(this,()=>{}),ut.set(this,{}),dt.set(this,!1),ht.set(this,!1),pt.set(this,!1),mt.set(this,!1),r(this,st,new Promise((e,t)=>{r(this,it,e,"f"),r(this,at,t,"f")}),"f"),r(this,ot,new Promise((e,t)=>{r(this,ct,e,"f"),r(this,lt,t,"f")}),"f"),s(this,st,"f").catch(()=>{}),s(this,ot,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},s(this,rt,"m",gt).bind(this))},0)}_connected(){this.ended||(s(this,it,"f").call(this),this._emit("connect"))}get ended(){return s(this,dt,"f")}get errored(){return s(this,ht,"f")}get aborted(){return s(this,pt,"f")}abort(){this.controller.abort()}on(e,t){return(s(this,ut,"f")[e]||(s(this,ut,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=s(this,ut,"f")[e];if(!n)return this;const r=n.findIndex(e=>e.listener===t);return r>=0&&n.splice(r,1),this}once(e,t){return(s(this,ut,"f")[e]||(s(this,ut,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{r(this,mt,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)})}async done(){r(this,mt,!0,"f"),await s(this,ot,"f")}_emit(e,...t){if(s(this,dt,"f"))return;"end"===e&&(r(this,dt,!0,"f"),s(this,ct,"f").call(this));const n=s(this,ut,"f")[e];if(n&&(s(this,ut,"f")[e]=n.filter(e=>!e.once),n.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return s(this,mt,"f")||n?.length||Promise.reject(e),s(this,at,"f").call(this,e),s(this,lt,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];s(this,mt,"f")||n?.length||Promise.reject(e),s(this,at,"f").call(this,e),s(this,lt,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function kt(e){return"function"==typeof e.parse}st=new WeakMap,it=new WeakMap,at=new WeakMap,ot=new WeakMap,ct=new WeakMap,lt=new WeakMap,ut=new WeakMap,dt=new WeakMap,ht=new WeakMap,pt=new WeakMap,mt=new WeakMap,rt=new WeakSet,gt=function(e){if(r(this,ht,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new u),e instanceof u)return r(this,pt,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){const t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))};const Tt=10;class It extends xt{constructor(){super(...arguments),ft.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),nt(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(tt(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionToolCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new c("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),s(this,ft,"m",yt).call(this)}async finalMessage(){return await this.done(),s(this,ft,"m",_t).call(this)}async finalFunctionToolCall(){return await this.done(),s(this,ft,"m",bt).call(this)}async finalFunctionToolCallResult(){return await this.done(),s(this,ft,"m",wt).call(this)}async totalUsage(){return await this.done(),s(this,ft,"m",vt).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=s(this,ft,"m",_t).call(this);t&&this._emit("finalMessage",t);const n=s(this,ft,"m",yt).call(this);n&&this._emit("finalContent",n);const r=s(this,ft,"m",bt).call(this);r&&this._emit("finalFunctionToolCall",r);const i=s(this,ft,"m",wt).call(this);null!=i&&this._emit("finalFunctionToolCallResult",i),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",s(this,ft,"m",vt).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),s(this,ft,"m",Et).call(this,t);const i=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Je(i,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runTools(e,t,n){const r="tool",{tool_choice:i="auto",stream:a,...o}=t,l="string"!=typeof i&&"function"===i.type&&i?.function?.name,{maxChatCompletions:u=Tt}=n||{},d=t.tools.map(e=>{if(Ve(e)){if(!e.$callback)throw new c("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),h={};for(const e of d)"function"===e.type&&(h[e.function.name||e.function.function.name]=e.function);const p="tools"in t?d.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<u;++t){const t=await this._createChatCompletion(e,{...o,tool_choice:i,tools:p,messages:[...this.messages]},n),a=t.choices[0]?.message;if(!a)throw new c("missing message in ChatCompletion response");if(!a.tool_calls?.length)return;for(const e of a.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:i}=e.function,a=h[n];if(!a){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(h).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}if(l&&l!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}let o;try{o=kt(a)?await a.parse(i):i}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:r,tool_call_id:t,content:n});continue}const c=await a.function(o,this),u=s(this,ft,"m",St).call(this,c);if(this._addMessage({role:r,tool_call_id:t,content:u}),l)return}}}}ft=new WeakSet,yt=function(){return s(this,ft,"m",_t).call(this).content??null},_t=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(tt(t)){return{...t,content:t.content??null,refusal:t.refusal??null}}}throw new c("stream ended without producing a ChatCompletionMessage with role=assistant")},bt=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(tt(t)&&t?.tool_calls?.length)return t.tool_calls.filter(e=>"function"===e.type).at(-1)?.function}},wt=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(nt(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},vt=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Et=function(e){if(null!=e.n&&e.n>1)throw new c("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},St=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class Ot extends It{static runTools(e,t,n){const r=new Ot,s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,s)),r}_addMessage(e,t=!0){super._addMessage(e,t),tt(e)&&e.content&&this._emit("content",e.content)}}const Ct=1,At=2,Pt=4,Mt=8,Rt=16,$t=32,jt=64,Nt=128,Lt=256,Dt=511;class Ut extends Error{}class Ft extends Error{}const Yt=(e,t)=>{const n=e.length;let r=0;const s=e=>{throw new Ut(`${e} at position ${r}`)},i=e=>{throw new Ft(`${e} at position ${r}`)},a=()=>(d(),r>=n&&s("Unexpected end of input"),'"'===e[r]?o():"{"===e[r]?c():"["===e[r]?l():"null"===e.substring(r,r+4)||Rt&t&&n-r<4&&"null".startsWith(e.substring(r))?(r+=4,null):"true"===e.substring(r,r+4)||$t&t&&n-r<4&&"true".startsWith(e.substring(r))?(r+=4,!0):"false"===e.substring(r,r+5)||$t&t&&n-r<5&&"false".startsWith(e.substring(r))?(r+=5,!1):"Infinity"===e.substring(r,r+8)||Nt&t&&n-r<8&&"Infinity".startsWith(e.substring(r))?(r+=8,1/0):"-Infinity"===e.substring(r,r+9)||Lt&t&&1<n-r&&n-r<9&&"-Infinity".startsWith(e.substring(r))?(r+=9,-1/0):"NaN"===e.substring(r,r+3)||jt&t&&n-r<3&&"NaN".startsWith(e.substring(r))?(r+=3,NaN):u()),o=()=>{const a=r;let o=!1;for(r++;r<n&&('"'!==e[r]||o&&"\\"===e[r-1]);)o="\\"===e[r]&&!o,r++;if('"'==e.charAt(r))try{return JSON.parse(e.substring(a,++r-Number(o)))}catch(e){i(String(e))}else if(Ct&t)try{return JSON.parse(e.substring(a,r-Number(o))+'"')}catch(t){return JSON.parse(e.substring(a,e.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},c=()=>{r++,d();const i={};try{for(;"}"!==e[r];){if(d(),r>=n&&Mt&t)return i;const s=o();d(),r++;try{const e=a();Object.defineProperty(i,s,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(Mt&t)return i;throw e}d(),","===e[r]&&r++}}catch(e){if(Mt&t)return i;s("Expected '}' at end of object")}return r++,i},l=()=>{r++;const n=[];try{for(;"]"!==e[r];)n.push(a()),d(),","===e[r]&&r++}catch(e){if(Pt&t)return n;s("Expected ']' at end of array")}return r++,n},u=()=>{if(0===r){"-"===e&&At&t&&s("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(At&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}i(String(n))}}const a=r;for("-"===e[r]&&r++;e[r]&&!",]}".includes(e[r]);)r++;r!=n||At&t||s("Unterminated number literal");try{return JSON.parse(e.substring(a,r))}catch(n){"-"===e.substring(a,r)&&At&t&&s("Not sure what '-' is");try{return JSON.parse(e.substring(a,e.lastIndexOf("e")))}catch(e){i(String(e))}}},d=()=>{for(;r<n&&" \n\r\t".includes(e[r]);)r++};return a()},Gt=e=>function(e,t=Dt){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return Yt(e.trim(),t)}(e,Dt^At);var Bt,Ht,zt,qt,Kt,Wt,Vt,Jt,Zt,Xt,Qt,en;class tn extends It{constructor(e){super(),Bt.add(this),Ht.set(this,void 0),zt.set(this,void 0),qt.set(this,void 0),r(this,Ht,e,"f"),r(this,zt,[],"f")}get currentChatCompletionSnapshot(){return s(this,qt,"f")}static fromReadableStream(e){const t=new tn(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const r=new tn(t);return r._run(()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(e,t,n){super._createChatCompletion;const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),s(this,Bt,"m",Kt).call(this);const i=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of i)s(this,Bt,"m",Vt).call(this,e);if(i.controller.signal?.aborted)throw new u;return this._addChatCompletion(s(this,Bt,"m",Xt).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),s(this,Bt,"m",Kt).call(this),this._connected();const r=we.fromReadableStream(e,this.controller);let i;for await(const e of r)i&&i!==e.id&&this._addChatCompletion(s(this,Bt,"m",Xt).call(this)),s(this,Bt,"m",Vt).call(this,e),i=e.id;if(r.controller.signal?.aborted)throw new u;return this._addChatCompletion(s(this,Bt,"m",Xt).call(this))}[(Ht=new WeakMap,zt=new WeakMap,qt=new WeakMap,Bt=new WeakSet,Kt=function(){this.ended||r(this,qt,void 0,"f")},Wt=function(e){let t=s(this,zt,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},s(this,zt,"f")[e.index]=t,t)},Vt=function(e){if(this.ended)return;const t=s(this,Bt,"m",en).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const r=s(this,Bt,"m",Wt).call(this,e);e.finish_reason&&(s(this,Bt,"m",Zt).call(this,e),null!=r.current_tool_call_index&&s(this,Bt,"m",Jt).call(this,e,r.current_tool_call_index));for(const t of n.delta.tool_calls??[])r.current_tool_call_index!==t.index&&(s(this,Bt,"m",Zt).call(this,e),null!=r.current_tool_call_index&&s(this,Bt,"m",Jt).call(this,e,r.current_tool_call_index)),r.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&("function"===n?.type?this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):sn(n?.type))}}},Jt=function(e,t){if(s(this,Bt,"m",Wt).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=s(this,Ht,"f")?.tools?.find(e=>Ke(e)&&e.function.name===n.function.name);this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:Ve(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},Zt=function(e){const t=s(this,Bt,"m",Wt).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=s(this,Bt,"m",Qt).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Xt=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");const e=s(this,qt,"f");if(!e)throw new c("request ended without sending any chunks");return r(this,qt,void 0,"f"),r(this,zt,[],"f"),function(e,t){const{id:n,choices:r,created:s,model:i,system_fingerprint:a,...o}=e,l={...o,id:n,choices:r.map(({message:t,finish_reason:n,index:r,logprobs:s,...i})=>{if(!n)throw new c(`missing finish_reason for choice ${r}`);const{content:a=null,function_call:o,tool_calls:l,...u}=t,d=t.role;if(!d)throw new c(`missing role for choice ${r}`);if(o){const{arguments:e,name:l}=o;if(null==e)throw new c(`missing function_call.arguments for choice ${r}`);if(!l)throw new c(`missing function_call.name for choice ${r}`);return{...i,message:{content:a,function_call:{arguments:e,name:l},role:d,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:s}}return l?{...i,index:r,finish_reason:n,logprobs:s,message:{...u,role:d,content:a,refusal:t.refusal??null,tool_calls:l.map((t,n)=>{const{function:s,type:i,id:a,...o}=t,{arguments:l,name:u,...d}=s||{};if(null==a)throw new c(`missing choices[${r}].tool_calls[${n}].id\n${nn(e)}`);if(null==i)throw new c(`missing choices[${r}].tool_calls[${n}].type\n${nn(e)}`);if(null==u)throw new c(`missing choices[${r}].tool_calls[${n}].function.name\n${nn(e)}`);if(null==l)throw new c(`missing choices[${r}].tool_calls[${n}].function.arguments\n${nn(e)}`);return{...o,id:a,type:i,function:{...d,name:u,arguments:l}}})}}:{...i,message:{...u,content:a,role:d,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:s}}),created:s,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return function(e,t){return t&&Qe(t)?Je(e,t):{...e,choices:e.choices.map(e=>(et(e.message.tool_calls),{...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(l,t)}(e,s(this,Ht,"f"))},Qt=function(){const e=s(this,Ht,"f")?.response_format;return We(e)?e:null},en=function(e){var t,n,i,a;let o=s(this,qt,"f");const{choices:c,...l}=e;o?Object.assign(o,l):o=r(this,qt,{...l,choices:[]},"f");for(const{delta:r,finish_reason:c,index:l,logprobs:u=null,...d}of e.choices){let e=o.choices[l];if(e||(e=o.choices[l]={finish_reason:c,index:l,message:{},logprobs:u,...d}),u)if(e.logprobs){const{content:r,refusal:s,...i}=u;rn(i),Object.assign(e.logprobs,i),r&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...r)),s&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...s))}else e.logprobs=Object.assign({},u);if(c&&(e.finish_reason=c,s(this,Ht,"f")&&Qe(s(this,Ht,"f")))){if("length"===c)throw new v;if("content_filter"===c)throw new E}if(Object.assign(e,d),!r)continue;const{content:h,refusal:p,function_call:m,role:g,tool_calls:f,...y}=r;if(rn(y),Object.assign(e.message,y),p&&(e.message.refusal=(e.message.refusal||"")+p),g&&(e.message.role=g),m&&(e.message.function_call?(m.name&&(e.message.function_call.name=m.name),m.arguments&&((i=e.message.function_call).arguments??(i.arguments=""),e.message.function_call.arguments+=m.arguments)):e.message.function_call=m),h&&(e.message.content=(e.message.content||"")+h,!e.message.refusal&&s(this,Bt,"m",Qt).call(this)&&(e.message.parsed=Gt(e.message.content))),f){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:r,function:i,...o}of f){const c=(a=e.message.tool_calls)[t]??(a[t]={});Object.assign(c,o),n&&(c.id=n),r&&(c.type=r),i&&(c.function??(c.function={name:i.name??"",arguments:""})),i?.name&&(c.function.name=i.name),i?.arguments&&(c.function.arguments+=i.arguments,Xe(s(this,Ht,"f"),c)&&(c.function.parsed_arguments=Gt(c.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",n=>{const r=t.shift();r?r.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new we(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function nn(e){return JSON.stringify(e)}function rn(e){}function sn(e){}class an extends tn{static fromReadableStream(e){const t=new an(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,n){const r=new an(t),s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,s)),r}}class on extends Ye{constructor(){super(...arguments),this.messages=new qe(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(ze`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(ze`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/chat/completions",Oe,{query:e,...t})}delete(e,t){return this._client.delete(ze`/chat/completions/${e}`,t)}parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new c(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new c(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>Je(t,e))}runTools(e,t){return e.stream?an.runTools(this._client,e,t):Ot.runTools(this._client,e,t)}stream(e,t){return tn.createChatCompletion(this._client,e,t)}}on.Messages=qe;class cn extends Ye{constructor(){super(...arguments),this.completions=new on(this._client)}}cn.Completions=on;const ln=Symbol("brand.privateNullableHeaders");function*un(e){if(!e)return;if(ln in e){const{values:t,nulls:n}=e;yield*t.entries();for(const e of n)yield[e,null];return}let t,n=!1;e instanceof Headers?t=e.entries():T(e)?t=e:(n=!0,t=Object.entries(e??{}));for(let e of t){const t=e[0];if("string"!=typeof t)throw new TypeError("expected header name to be a string");const r=T(e[1])?e[1]:[e[1]];let s=!1;for(const e of r)void 0!==e&&(n&&!s&&(s=!0,yield[t,null]),yield[t,e])}}const dn=e=>{const t=new Headers,n=new Set;for(const r of e){const e=new Set;for(const[s,i]of un(r)){const r=s.toLowerCase();e.has(r)||(t.delete(s),e.add(r)),null===i?(t.delete(s),n.add(r)):(t.append(s,i),n.delete(r))}}return{[ln]:!0,values:t,nulls:n}};class hn extends Ye{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:dn([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}}class pn extends Ye{create(e,t){return this._client.post("/audio/transcriptions",$e({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class mn extends Ye{create(e,t){return this._client.post("/audio/translations",$e({body:e,...t,__metadata:{model:e.model}},this._client))}}class gn extends Ye{constructor(){super(...arguments),this.transcriptions=new pn(this._client),this.translations=new mn(this._client),this.speech=new hn(this._client)}}gn.Transcriptions=pn,gn.Translations=mn,gn.Speech=hn;class fn extends Ye{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(ze`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",Oe,{query:e,...t})}cancel(e,t){return this._client.post(ze`/batches/${e}/cancel`,t)}}class yn extends Ye{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(ze`/assistants/${e}`,{...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(ze`/assistants/${e}`,{body:t,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",Oe,{query:e,...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(ze`/assistants/${e}`,{...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class _n extends Ye{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class bn extends Ye{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class wn extends Ye{constructor(){super(...arguments),this.sessions=new _n(this._client),this.transcriptionSessions=new bn(this._client)}}wn.Sessions=_n,wn.TranscriptionSessions=bn;class vn extends Ye{create(e,t,n){return this._client.post(ze`/threads/${e}/messages`,{body:t,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{thread_id:r}=t;return this._client.get(ze`/threads/${r}/messages/${e}`,{...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{thread_id:r,...s}=t;return this._client.post(ze`/threads/${r}/messages/${e}`,{body:s,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(ze`/threads/${e}/messages`,Oe,{query:t,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t,n){const{thread_id:r}=t;return this._client.delete(ze`/threads/${r}/messages/${e}`,{...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}class En extends Ye{retrieve(e,t,n){const{thread_id:r,run_id:s,...i}=t;return this._client.get(ze`/threads/${r}/runs/${s}/steps/${e}`,{query:i,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t,n){const{thread_id:r,...s}=t;return this._client.getAPIList(ze`/threads/${r}/runs/${e}/steps`,Oe,{query:s,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}const Sn=e=>void 0!==globalThis.process?globalThis.process.env?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;var xn,kn,Tn,In,On,Cn,An,Pn,Mn,Rn,$n,jn,Nn,Ln,Dn,Un,Fn,Yn,Gn,Bn,Hn,zn,qn,Kn,Wn,Vn,Jn,Zn,Xn,Qn,er;class tr extends xt{constructor(){super(...arguments),xn.add(this),Tn.set(this,[]),In.set(this,{}),On.set(this,{}),Cn.set(this,void 0),An.set(this,void 0),Pn.set(this,void 0),Mn.set(this,void 0),Rn.set(this,void 0),$n.set(this,void 0),jn.set(this,void 0),Nn.set(this,void 0),Ln.set(this,void 0)}[(Tn=new WeakMap,In=new WeakMap,On=new WeakMap,Cn=new WeakMap,An=new WeakMap,Pn=new WeakMap,Mn=new WeakMap,Rn=new WeakMap,$n=new WeakMap,jn=new WeakMap,Nn=new WeakMap,Ln=new WeakMap,xn=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const r=t.shift();r?r.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new kn;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const r=we.fromReadableStream(e,this.controller);for await(const e of r)s(this,xn,"m",Dn).call(this,e);if(r.controller.signal?.aborted)throw new u;return this._addRun(s(this,xn,"m",Un).call(this))}toReadableStream(){return new we(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r){const s=new kn;return s._run(()=>s._runToolAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createToolAssistantStream(e,t,n,r){const i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},o=await e.submitToolOutputs(t,a,{...r,signal:this.controller.signal});this._connected();for await(const e of o)s(this,xn,"m",Dn).call(this,e);if(o.controller.signal?.aborted)throw new u;return this._addRun(s(this,xn,"m",Un).call(this))}static createThreadAssistantStream(e,t,n){const r=new kn;return r._run(()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(e,t,n,r){const s=new kn;return s._run(()=>s._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return s(this,jn,"f")}currentRun(){return s(this,Nn,"f")}currentMessageSnapshot(){return s(this,Cn,"f")}currentRunStepSnapshot(){return s(this,Ln,"f")}async finalRunSteps(){return await this.done(),Object.values(s(this,In,"f"))}async finalMessages(){return await this.done(),Object.values(s(this,On,"f"))}async finalRun(){if(await this.done(),!s(this,An,"f"))throw Error("Final run was not received.");return s(this,An,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const i={...t,stream:!0},a=await e.createAndRun(i,{...n,signal:this.controller.signal});this._connected();for await(const e of a)s(this,xn,"m",Dn).call(this,e);if(a.controller.signal?.aborted)throw new u;return this._addRun(s(this,xn,"m",Un).call(this))}async _createAssistantStream(e,t,n,r){const i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},o=await e.create(t,a,{...r,signal:this.controller.signal});this._connected();for await(const e of o)s(this,xn,"m",Dn).call(this,e);if(o.controller.signal?.aborted)throw new u;return this._addRun(s(this,xn,"m",Un).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof r)t+=r;else if("number"==typeof t&&"number"==typeof r)t+=r;else{if(!O(t)||!O(r)){if(Array.isArray(t)&&Array.isArray(r)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...r);continue}for(const e of r){if(!O(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const r=t[n];null==r?t.push(e):t[n]=this.accumulateDelta(r,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${t}`)}t=this.accumulateDelta(t,r)}e[n]=t}else e[n]=r;else e[n]=r}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r){return await this._createToolAssistantStream(t,e,n,r)}}kn=tr,Dn=function(e){if(!this.ended)switch(r(this,jn,e,"f"),s(this,xn,"m",Gn).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":s(this,xn,"m",qn).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":s(this,xn,"m",Yn).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":s(this,xn,"m",Fn).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Un=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");if(!s(this,An,"f"))throw Error("Final run has not been received");return s(this,An,"f")},Fn=function(e){const[t,n]=s(this,xn,"m",Hn).call(this,e,s(this,Cn,"f"));r(this,Cn,t,"f"),s(this,On,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,r=t.content[n.index];if(!r||"text"!=r.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,r.text)}if(n.index!=s(this,Pn,"f")){if(s(this,Mn,"f"))switch(s(this,Mn,"f").type){case"text":this._emit("textDone",s(this,Mn,"f").text,s(this,Cn,"f"));break;case"image_file":this._emit("imageFileDone",s(this,Mn,"f").image_file,s(this,Cn,"f"))}r(this,Pn,n.index,"f")}r(this,Mn,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==s(this,Pn,"f")){const t=e.data.content[s(this,Pn,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,s(this,Cn,"f"));break;case"text":this._emit("textDone",t.text,s(this,Cn,"f"))}}s(this,Cn,"f")&&this._emit("messageDone",e.data),r(this,Cn,void 0,"f")}},Yn=function(e){const t=s(this,xn,"m",Bn).call(this,e);switch(r(this,Ln,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==s(this,Rn,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(s(this,$n,"f")&&this._emit("toolCallDone",s(this,$n,"f")),r(this,Rn,e.index,"f"),r(this,$n,t.step_details.tool_calls[e.index],"f"),s(this,$n,"f")&&this._emit("toolCallCreated",s(this,$n,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":r(this,Ln,void 0,"f");"tool_calls"==e.data.step_details.type&&s(this,$n,"f")&&(this._emit("toolCallDone",s(this,$n,"f")),r(this,$n,void 0,"f")),this._emit("runStepDone",e.data,t)}},Gn=function(e){s(this,Tn,"f").push(e),this._emit("event",e)},Bn=function(e){switch(e.event){case"thread.run.step.created":return s(this,In,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=s(this,In,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=kn.accumulateDelta(t,n.delta);s(this,In,"f")[e.data.id]=r}return s(this,In,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":s(this,In,"f")[e.data.id]=e.data}if(s(this,In,"f")[e.data.id])return s(this,In,"f")[e.data.id];throw new Error("No snapshot available")},Hn=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const e of r.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=s(this,xn,"m",zn).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},zn=function(e,t){return kn.accumulateDelta(t,e)},qn=function(e){switch(r(this,Nn,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":r(this,An,e.data,"f"),s(this,$n,"f")&&(this._emit("toolCallDone",s(this,$n,"f")),r(this,$n,void 0,"f"))}};class nr extends Ye{constructor(){super(...arguments),this.steps=new En(this._client)}create(e,t,n){const{include:r,...s}=t;return this._client.post(ze`/threads/${e}/runs`,{query:{include:r},body:s,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:t.stream??!1})}retrieve(e,t,n){const{thread_id:r}=t;return this._client.get(ze`/threads/${r}/runs/${e}`,{...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{thread_id:r,...s}=t;return this._client.post(ze`/threads/${r}/runs/${e}`,{body:s,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(ze`/threads/${e}/runs`,Oe,{query:t,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}cancel(e,t,n){const{thread_id:r}=t;return this._client.post(ze`/threads/${r}/runs/${e}/cancel`,{...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(r.id,{thread_id:e},n)}createAndStream(e,t,n){return tr.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r=dn([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:s,response:i}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=i.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await C(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,n){return tr.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n){const{thread_id:r,...s}=t;return this._client.post(ze`/threads/${r}/runs/${e}/submit_tool_outputs`,{body:s,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,n){const r=await this.submitToolOutputs(e,t,n);return await this.poll(r.id,t,n)}submitToolOutputsStream(e,t,n){return tr.createToolAssistantStream(e,this._client.beta.threads.runs,t,n)}}nr.Steps=En;class rr extends Ye{constructor(){super(...arguments),this.runs=new nr(this._client),this.messages=new vn(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(ze`/threads/${e}`,{...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(ze`/threads/${e}`,{body:t,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t){return this._client.delete(ze`/threads/${e}`,{...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.id,{thread_id:n.thread_id},t)}createAndRunStream(e,t){return tr.createThreadAssistantStream(e,this._client.beta.threads,t)}}rr.Runs=nr,rr.Messages=vn;class sr extends Ye{constructor(){super(...arguments),this.realtime=new wn(this._client),this.assistants=new yn(this._client),this.threads=new rr(this._client)}}sr.Realtime=wn,sr.Assistants=yn,sr.Threads=rr;class ir extends Ye{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class ar extends Ye{retrieve(e,t,n){const{container_id:r}=t;return this._client.get(ze`/containers/${r}/files/${e}/content`,{...n,headers:dn([{Accept:"application/binary"},n?.headers]),__binaryResponse:!0})}}class or extends Ye{constructor(){super(...arguments),this.content=new ar(this._client)}create(e,t,n){return this._client.post(ze`/containers/${e}/files`,$e({body:t,...n},this._client))}retrieve(e,t,n){const{container_id:r}=t;return this._client.get(ze`/containers/${r}/files/${e}`,n)}list(e,t={},n){return this._client.getAPIList(ze`/containers/${e}/files`,Oe,{query:t,...n})}delete(e,t,n){const{container_id:r}=t;return this._client.delete(ze`/containers/${r}/files/${e}`,{...n,headers:dn([{Accept:"*/*"},n?.headers])})}}or.Content=ar;class cr extends Ye{constructor(){super(...arguments),this.files=new or(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(ze`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",Oe,{query:e,...t})}delete(e,t){return this._client.delete(ze`/containers/${e}`,{...t,headers:dn([{Accept:"*/*"},t?.headers])})}}cr.Files=or;class lr extends Ye{create(e,t,n){const{include:r,...s}=t;return this._client.post(ze`/conversations/${e}/items`,{query:{include:r},body:s,...n})}retrieve(e,t,n){const{conversation_id:r,...s}=t;return this._client.get(ze`/conversations/${r}/items/${e}`,{query:s,...n})}list(e,t={},n){return this._client.getAPIList(ze`/conversations/${e}/items`,Ce,{query:t,...n})}delete(e,t,n){const{conversation_id:r}=t;return this._client.delete(ze`/conversations/${r}/items/${e}`,n)}}class ur extends Ye{constructor(){super(...arguments),this.items=new lr(this._client)}create(e,t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(ze`/conversations/${e}`,t)}update(e,t,n){return this._client.post(ze`/conversations/${e}`,{body:t,...n})}delete(e,t){return this._client.delete(ze`/conversations/${e}`,t)}}ur.Items=lr;class dr extends Ye{create(e,t){const n=!!e.encoding_format;let r=n?e.encoding_format:"base64";n&&ge(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const s=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return n?s:(ge(this._client).debug("embeddings/decoding base64 embeddings from base64"),s._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return Array.from(new Float32Array(r.buffer))}})(t)}),e)))}}class hr extends Ye{retrieve(e,t,n){const{eval_id:r,run_id:s}=t;return this._client.get(ze`/evals/${r}/runs/${s}/output_items/${e}`,n)}list(e,t,n){const{eval_id:r,...s}=t;return this._client.getAPIList(ze`/evals/${r}/runs/${e}/output_items`,Oe,{query:s,...n})}}class pr extends Ye{constructor(){super(...arguments),this.outputItems=new hr(this._client)}create(e,t,n){return this._client.post(ze`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){const{eval_id:r}=t;return this._client.get(ze`/evals/${r}/runs/${e}`,n)}list(e,t={},n){return this._client.getAPIList(ze`/evals/${e}/runs`,Oe,{query:t,...n})}delete(e,t,n){const{eval_id:r}=t;return this._client.delete(ze`/evals/${r}/runs/${e}`,n)}cancel(e,t,n){const{eval_id:r}=t;return this._client.post(ze`/evals/${r}/runs/${e}`,n)}}pr.OutputItems=hr;class mr extends Ye{constructor(){super(...arguments),this.runs=new pr(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(ze`/evals/${e}`,t)}update(e,t,n){return this._client.post(ze`/evals/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/evals",Oe,{query:e,...t})}delete(e,t){return this._client.delete(ze`/evals/${e}`,t)}}mr.Runs=pr;class gr extends Ye{create(e,t){return this._client.post("/files",$e({body:e,...t},this._client))}retrieve(e,t){return this._client.get(ze`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",Oe,{query:e,...t})}delete(e,t){return this._client.delete(ze`/files/${e}`,t)}content(e,t){return this._client.get(ze`/files/${e}/content`,{...t,headers:dn([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const r=new Set(["processed","error","deleted"]),s=Date.now();let i=await this.retrieve(e);for(;!i.status||!r.has(i.status);)if(await C(t),i=await this.retrieve(e),Date.now()-s>n)throw new h({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return i}}class fr extends Ye{}class yr extends Ye{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class _r extends Ye{constructor(){super(...arguments),this.graders=new yr(this._client)}}_r.Graders=yr;class br extends Ye{create(e,t,n){return this._client.getAPIList(ze`/fine_tuning/checkpoints/${e}/permissions`,Ie,{body:t,method:"post",...n})}retrieve(e,t={},n){return this._client.get(ze`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}delete(e,t,n){const{fine_tuned_model_checkpoint:r}=t;return this._client.delete(ze`/fine_tuning/checkpoints/${r}/permissions/${e}`,n)}}class wr extends Ye{constructor(){super(...arguments),this.permissions=new br(this._client)}}wr.Permissions=br;class vr extends Ye{list(e,t={},n){return this._client.getAPIList(ze`/fine_tuning/jobs/${e}/checkpoints`,Oe,{query:t,...n})}}class Er extends Ye{constructor(){super(...arguments),this.checkpoints=new vr(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(ze`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",Oe,{query:e,...t})}cancel(e,t){return this._client.post(ze`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return this._client.getAPIList(ze`/fine_tuning/jobs/${e}/events`,Oe,{query:t,...n})}pause(e,t){return this._client.post(ze`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(ze`/fine_tuning/jobs/${e}/resume`,t)}}Er.Checkpoints=vr;class Sr extends Ye{constructor(){super(...arguments),this.methods=new fr(this._client),this.jobs=new Er(this._client),this.checkpoints=new wr(this._client),this.alpha=new _r(this._client)}}Sr.Methods=fr,Sr.Jobs=Er,Sr.Checkpoints=wr,Sr.Alpha=_r;class xr extends Ye{}class kr extends Ye{constructor(){super(...arguments),this.graderModels=new xr(this._client)}}kr.GraderModels=xr;class Tr extends Ye{createVariation(e,t){return this._client.post("/images/variations",$e({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",$e({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class Ir extends Ye{retrieve(e,t){return this._client.get(ze`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Ie,e)}delete(e,t){return this._client.delete(ze`/models/${e}`,t)}}class Or extends Ye{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class Cr extends Ye{create(e,t){return this._client.post("/realtime/client_secrets",{body:e,...t})}}class Ar extends Ye{constructor(){super(...arguments),this.clientSecrets=new Cr(this._client)}}function Pr(e,t){return t&&function(e){if(We(e.text?.format))return!0;return!1}(t)?Mr(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}function Mr(e,t){const n=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:Nr(t,e)};if("message"===e.type){const n=e.content.map(e=>"output_text"===e.type?{...e,parsed:Rr(t,e.text)}:e);return{...e,content:n}}return e}),r=Object.assign({},e,{output:n});return Object.getOwnPropertyDescriptor(e,"output_text")||Lr(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const e of r.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),r}function Rr(e,t){if("json_schema"!==e.text?.format?.type)return null;if("$parseRaw"in e.text?.format){const n=e.text?.format;return n.$parseRaw(t)}return JSON.parse(t)}function $r(e){return"auto-parseable-tool"===e?.$brand}function jr(e,t){return e.find(e=>"function"===e.type&&e.name===t)}function Nr(e,t){const n=jr(e.tools??[],t.name);return{...t,...t,parsed_arguments:$r(n)?n.$parseRaw(t.arguments):n?.strict?JSON.parse(t.arguments):null}}function Lr(e){const t=[];for(const n of e.output)if("message"===n.type)for(const e of n.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}Ar.ClientSecrets=Cr;class Dr extends xt{constructor(e){super(),Kn.add(this),Wn.set(this,void 0),Vn.set(this,void 0),Jn.set(this,void 0),r(this,Wn,e,"f")}static createResponse(e,t,n){const r=new Dr(t);return r._run(()=>r._createOrRetrieveResponse(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createOrRetrieveResponse(e,t,n){const r=n?.signal;let i;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),s(this,Kn,"m",Zn).call(this);let a=null;"response_id"in t?(i=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):i=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const e of i)s(this,Kn,"m",Xn).call(this,e,a);if(i.controller.signal?.aborted)throw new u;return s(this,Kn,"m",Qn).call(this)}[(Wn=new WeakMap,Vn=new WeakMap,Jn=new WeakMap,Kn=new WeakSet,Zn=function(){this.ended||r(this,Vn,void 0,"f")},Xn=function(e,t){if(this.ended)return;const n=(e,n)=>{(null==t||n.sequence_number>t)&&this._emit(e,n)},r=s(this,Kn,"m",er).call(this,e);switch(n("event",e),e.type){case"response.output_text.delta":{const t=r.output[e.output_index];if(!t)throw new c(`missing output at index ${e.output_index}`);if("message"===t.type){const r=t.content[e.content_index];if(!r)throw new c(`missing content at index ${e.content_index}`);if("output_text"!==r.type)throw new c(`expected content to be 'output_text', got ${r.type}`);n("response.output_text.delta",{...e,snapshot:r.text})}break}case"response.function_call_arguments.delta":{const t=r.output[e.output_index];if(!t)throw new c(`missing output at index ${e.output_index}`);"function_call"===t.type&&n("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:n(e.type,e)}},Qn=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");const e=s(this,Vn,"f");if(!e)throw new c("request ended without sending any events");r(this,Vn,void 0,"f");const t=function(e,t){return Pr(e,t)}(e,s(this,Wn,"f"));return r(this,Jn,t,"f"),t},er=function(e){let t=s(this,Vn,"f");if(!t){if("response.created"!==e.type)throw new c(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=r(this,Vn,e.response,"f"),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const n=t.output[e.output_index];if(!n)throw new c(`missing output at index ${e.output_index}`);"message"===n.type&&n.content.push(e.part);break}case"response.output_text.delta":{const n=t.output[e.output_index];if(!n)throw new c(`missing output at index ${e.output_index}`);if("message"===n.type){const t=n.content[e.content_index];if(!t)throw new c(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new c(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const n=t.output[e.output_index];if(!n)throw new c(`missing output at index ${e.output_index}`);"function_call"===n.type&&(n.arguments+=e.delta);break}case"response.completed":r(this,Vn,e.response,"f")}return t},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const r=t.shift();r?r.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=s(this,Jn,"f");if(!e)throw new c("stream ended without producing a ChatCompletion");return e}}class Ur extends Ye{list(e,t={},n){return this._client.getAPIList(ze`/responses/${e}/input_items`,Oe,{query:t,...n})}}class Fr extends Ye{constructor(){super(...arguments),this.inputItems=new Ur(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&Lr(e),e))}retrieve(e,t={},n){return this._client.get(ze`/responses/${e}`,{query:t,...n,stream:t?.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&Lr(e),e))}delete(e,t){return this._client.delete(ze`/responses/${e}`,{...t,headers:dn([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>Mr(t,e))}stream(e,t){return Dr.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(ze`/responses/${e}/cancel`,t)}}Fr.InputItems=Ur;class Yr extends Ye{create(e,t,n){return this._client.post(ze`/uploads/${e}/parts`,$e({body:t,...n},this._client))}}class Gr extends Ye{constructor(){super(...arguments),this.parts=new Yr(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(ze`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(ze`/uploads/${e}/complete`,{body:t,...n})}}Gr.Parts=Yr;class Br extends Ye{create(e,t,n){return this._client.post(ze`/vector_stores/${e}/file_batches`,{body:t,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{vector_store_id:r}=t;return this._client.get(ze`/vector_stores/${r}/file_batches/${e}`,{...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}cancel(e,t,n){const{vector_store_id:r}=t;return this._client.post(ze`/vector_stores/${r}/file_batches/${e}/cancel`,{...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n){const{vector_store_id:r,...s}=t;return this._client.getAPIList(ze`/vector_stores/${r}/file_batches/${e}/files`,Oe,{query:s,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async poll(e,t,n){const r=dn([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:s,response:i}=await this.retrieve(t,{vector_store_id:e},{...n,headers:r}).withResponse();switch(s.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=i.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await C(e);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const s=r?.maxConcurrency??5,i=Math.min(s,t.length),a=this._client,o=t.values(),c=[...n];const l=Array(i).fill(o).map(async function(e){for(let t of e){const e=await a.files.create({file:t,purpose:"assistants"},r);c.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),n=t.filter(e=>"rejected"===e.status);if(n.length){for(const e of n);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const e of t)"fulfilled"===e.status&&r.push(e.value);return r})(l),await this.createAndPoll(e,{file_ids:c})}}class Hr extends Ye{create(e,t,n){return this._client.post(ze`/vector_stores/${e}/files`,{body:t,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{vector_store_id:r}=t;return this._client.get(ze`/vector_stores/${r}/files/${e}`,{...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{vector_store_id:r,...s}=t;return this._client.post(ze`/vector_stores/${r}/files/${e}`,{body:s,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(ze`/vector_stores/${e}/files`,Oe,{query:t,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t,n){const{vector_store_id:r}=t;return this._client.delete(ze`/vector_stores/${r}/files/${e}`,{...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r=dn([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const s=await this.retrieve(t,{vector_store_id:e},{...n,headers:r}).withResponse(),i=s.data;switch(i.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await C(e);break;case"failed":case"completed":return i}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}content(e,t,n){const{vector_store_id:r}=t;return this._client.getAPIList(ze`/vector_stores/${r}/files/${e}/content`,Ie,{...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}class zr extends Ye{constructor(){super(...arguments),this.files=new Hr(this._client),this.fileBatches=new Br(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(ze`/vector_stores/${e}`,{...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(ze`/vector_stores/${e}`,{body:t,...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",Oe,{query:e,...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(ze`/vector_stores/${e}`,{...t,headers:dn([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,n){return this._client.getAPIList(ze`/vector_stores/${e}/search`,Ie,{body:t,method:"post",...n,headers:dn([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}var qr,Kr,Wr,Vr,Jr,Zr,Xr;zr.Files=Hr,zr.FileBatches=Br;class Qr extends Ye{constructor(){super(...arguments),qr.add(this)}async unwrap(e,t,n=this._client.webhookSecret,r=300){return await this.verifySignature(e,t,n,r),JSON.parse(e)}async verifySignature(e,t,n=this._client.webhookSecret,r=300){if("undefined"==typeof crypto||"function"!=typeof crypto.subtle.importKey||"function"!=typeof crypto.subtle.verify)throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");s(this,qr,"m",Kr).call(this,n);const i=dn([t]).values,a=s(this,qr,"m",Wr).call(this,i,"webhook-signature"),o=s(this,qr,"m",Wr).call(this,i,"webhook-timestamp"),c=s(this,qr,"m",Wr).call(this,i,"webhook-id"),l=parseInt(o,10);if(isNaN(l))throw new S("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-l>r)throw new S("Webhook timestamp is too old");if(l>u+r)throw new S("Webhook timestamp is too new");const d=a.split(" ").map(e=>e.startsWith("v1,")?e.substring(3):e),h=n.startsWith("whsec_")?Buffer.from(n.replace("whsec_",""),"base64"):Buffer.from(n,"utf-8"),p=c?`${c}.${o}.${e}`:`${o}.${e}`,m=await crypto.subtle.importKey("raw",h,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const e of d)try{const t=Buffer.from(e,"base64");if(await crypto.subtle.verify("HMAC",m,t,(new TextEncoder).encode(p)))return}catch{continue}throw new S("The given webhook signature does not match the expected signature")}}qr=new WeakSet,Kr=function(e){if("string"!=typeof e||0===e.length)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Wr=function(e,t){if(!e)throw new Error("Headers are required");const n=e.get(t);if(null==n)throw new Error(`Missing required header: ${t}`);return n};class es{constructor({baseURL:e=Sn("OPENAI_BASE_URL"),apiKey:t=Sn("OPENAI_API_KEY"),organization:n=Sn("OPENAI_ORG_ID")??null,project:s=Sn("OPENAI_PROJECT_ID")??null,webhookSecret:i=Sn("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(Vr.add(this),Zr.set(this,void 0),this.completions=new ir(this),this.chat=new cn(this),this.embeddings=new dr(this),this.files=new gr(this),this.images=new Tr(this),this.audio=new gn(this),this.moderations=new Or(this),this.models=new Ir(this),this.fineTuning=new Sr(this),this.graders=new kr(this),this.vectorStores=new zr(this),this.webhooks=new Qr(this),this.beta=new sr(this),this.batches=new fn(this),this.uploads=new Gr(this),this.responses=new Fr(this),this.realtime=new Ar(this),this.conversations=new ur(this),this.evals=new mr(this),this.containers=new cr(this),void 0===t)throw new c("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const o={apiKey:t,organization:n,project:s,webhookSecret:i,...a,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new c("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=o.baseURL,this.timeout=o.timeout??Jr.DEFAULT_TIMEOUT,this.logger=o.logger??console;const l="warn";this.logLevel=l,this.logLevel=ue(o.logLevel,"ClientOptions.logLevel",this)??ue(Sn("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??l,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),r(this,Zr,D,"f"),this._options=o,this.apiKey="string"==typeof t?t:"Missing Key",this.organization=n,this.project=s,this.webhookSecret=i}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return dn([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return Q(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${A}`}defaultIdempotencyKey(){return`stainless-node-retry-${i()}`}makeStatusError(e,t,n,r){return l.generate(e,t,n,r)}async _callApiKey(){const e=this._options.apiKey;if("function"!=typeof e)return!1;let t;try{t=await e()}catch(e){if(e instanceof c)throw e;throw new c(`Failed to get token from 'apiKey' function: ${e.message}`,{cause:e})}if("string"!=typeof t||!t)throw new c(`Expected 'apiKey' function argument to return a string but it returned ${t}`);return this.apiKey=t,!0}buildURL(e,t,n){const r=!s(this,Vr,"m",Xr).call(this)&&n||this.baseURL,i=(e=>x.test(e))(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return function(e){if(!e)return!0;for(const t in e)return!1;return!0}(a)||(t={...a,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:t,options:n}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(n=>({method:e,path:t,...n})))}request(e,t=null){return new xe(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,n){const r=await e,s=r.maxRetries??this.maxRetries;null==t&&(t=s),await this.prepareOptions(r);const{req:i,url:c,timeout:l}=await this.buildRequest(r,{retryCount:s-t});await this.prepareRequest(i,{url:c,options:r});const p="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),m=void 0===n?"":`, retryOf: ${n}`,g=Date.now();if(ge(this).debug(`[${p}] sending request`,fe({retryOfRequestLogID:n,method:r.method,url:c,options:r,headers:i.headers})),r.signal?.aborted)throw new u;const f=new AbortController,y=await this.fetchWithTimeout(c,i,l,f).catch(o),_=Date.now();if(y instanceof globalThis.Error){const e=`retrying, ${t} attempts remaining`;if(r.signal?.aborted)throw new u;const s=a(y)||/timed? ?out/i.test(String(y)+("cause"in y?String(y.cause):""));if(t)return ge(this).info(`[${p}] connection ${s?"timed out":"failed"} - ${e}`),ge(this).debug(`[${p}] connection ${s?"timed out":"failed"} (${e})`,fe({retryOfRequestLogID:n,url:c,durationMs:_-g,message:y.message})),this.retryRequest(r,t,n??p);if(ge(this).info(`[${p}] connection ${s?"timed out":"failed"} - error; no more retries left`),ge(this).debug(`[${p}] connection ${s?"timed out":"failed"} (error; no more retries left)`,fe({retryOfRequestLogID:n,url:c,durationMs:_-g,message:y.message})),s)throw new h;throw new d({cause:y})}const b=`[${p}${m}${[...y.headers.entries()].filter(([e])=>"x-request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join("")}] ${i.method} ${c} ${y.ok?"succeeded":"failed"} with status ${y.status} in ${_-g}ms`;if(!y.ok){const e=await this.shouldRetry(y);if(t&&e){const e=`retrying, ${t} attempts remaining`;return await async function(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void await(e[Symbol.asyncIterator]().return?.());const t=e.getReader(),n=t.cancel();t.releaseLock(),await n}(y.body),ge(this).info(`${b} - ${e}`),ge(this).debug(`[${p}] response error (${e})`,fe({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,durationMs:_-g})),this.retryRequest(r,t,n??p,y.headers)}const s=e?"error; no more retries left":"error; not retryable";ge(this).info(`${b} - ${s}`);const i=await y.text().catch(e=>o(e).message),a=(e=>{try{return JSON.parse(e)}catch(e){return}})(i),c=a?void 0:i;ge(this).debug(`[${p}] response error (${s})`,fe({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,message:c,durationMs:Date.now()-g}));throw this.makeStatusError(y.status,a,c,y.headers)}return ge(this).info(b),ge(this).debug(`[${p}] response start`,fe({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,durationMs:_-g})),{response:y,options:r,controller:f,requestLogID:p,retryOfRequestLogID:n,startTime:g}}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}requestAPIList(e,t){const n=this.makeRequest(t,null,void 0);return new Te(this,n,e)}async fetchWithTimeout(e,t,n,r){const{signal:s,method:i,...a}=t||{};s&&s.addEventListener("abort",()=>r.abort());const o=setTimeout(()=>r.abort(),n),c=globalThis.ReadableStream&&a.body instanceof globalThis.ReadableStream||"object"==typeof a.body&&null!==a.body&&Symbol.asyncIterator in a.body,l={signal:r.signal,...c?{duplex:"half"}:{},method:"GET",...a};i&&(l.method=i.toUpperCase());try{return await this.fetch.call(void 0,e,l)}finally{clearTimeout(o)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,n,r){let s;const i=r?.get("retry-after-ms");if(i){const e=parseFloat(i);Number.isNaN(e)||(s=e)}const a=r?.get("retry-after");if(a&&!s){const e=parseFloat(a);s=Number.isNaN(e)?Date.parse(a)-Date.now():1e3*e}if(!(s&&0<=s&&s<6e4)){const n=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,n)}return await C(s),this.makeRequest(e,t-1,n)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}async buildRequest(e,{retryCount:t=0}={}){const n={...e},{method:r,path:s,query:i,defaultBaseURL:a}=n,o=this.buildURL(s,i,a);"timeout"in n&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new c(`${e} must be an integer`);if(t<0)throw new c(`${e} must be a positive integer`)})("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const{bodyHeaders:l,body:u}=this.buildBody({options:n});return{req:{method:r,headers:await this.buildHeaders({options:e,method:r,bodyHeaders:l,retryCount:t}),...n.signal&&{signal:n.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...this.fetchOptions??{},...n.fetchOptions??{}},url:o,timeout:n.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:n,retryCount:r}){let s={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);const i=dn([s,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...$??($=P()),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,n,e.headers]);return this.validateHeaders(i),i.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const n=dn([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&n.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:N(e)}:s(this,Zr,"f").call(this,{body:e,headers:n})}}Jr=es,Zr=new WeakMap,Vr=new WeakSet,Xr=function(){return"https://api.openai.com/v1"!==this.baseURL},es.OpenAI=Jr,es.DEFAULT_TIMEOUT=6e5,es.OpenAIError=c,es.APIError=l,es.APIConnectionError=d,es.APIConnectionTimeoutError=h,es.APIUserAbortError=u,es.NotFoundError=f,es.ConflictError=y,es.RateLimitError=b,es.BadRequestError=p,es.AuthenticationError=m,es.InternalServerError=w,es.PermissionDeniedError=g,es.UnprocessableEntityError=_,es.InvalidWebhookSignatureError=S,es.toFile=async function(e,t,n){if(Ae(),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&Ue(e))(e=await e))return e instanceof File?e:Pe([await e.arrayBuffer()],e.name);if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const r=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),Pe(await Fe(r),t,n)}const r=await Fe(e);if(t||(t=Me(e)),!n?.type){const e=r.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(n={...n,type:e})}return Pe(r,t,n)},es.Completions=ir,es.Chat=cn,es.Embeddings=dr,es.Files=gr,es.Images=Tr,es.Audio=gn,es.Moderations=Or,es.Models=Ir,es.FineTuning=Sr,es.Graders=kr,es.VectorStores=zr,es.Webhooks=Qr,es.Beta=sr,es.Batches=fn,es.Uploads=Gr,es.Responses=Fr,es.Realtime=Ar,es.Conversations=ur,es.Evals=mr,es.Containers=cr;new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/batches","/images/edits"]);var ts=n(9958),ns=n(3025),rs=n(9497),ss=n(3279),is=n(9583),as=n(1830),os=n(2778),cs=n(8687),ls=n(8557),us=n(6792),ds=n(3263),hs=n(5721),ps=n(7765),ms=n(7942);function gs(e,t){if(void 0===e.function)return;let n;if(t?.partial)try{n=(0,ds.d1)(e.function.arguments??"{}")}catch(e){return}else try{n=JSON.parse(e.function.arguments)}catch(t){throw new us.CC([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const r={name:e.function.name,args:n,type:"tool_call"};return t?.returnId&&(r.id=e.id),r}function fs(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function ys(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}class _s extends hs.T{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){const n=e[0].message;let r;if((0,ps.KX)(n)&&n.tool_calls?.length)r=n.tool_calls.map(e=>{const{id:t,...n}=e;return this.returnId?{id:t,...n}:n});else if(void 0!==n.additional_kwargs.tool_calls){r=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(e=>gs(e,{returnId:this.returnId,partial:t}))}if(!r)return[];const s=[];for(const e of r)if(void 0!==e){const t={type:e.name,args:e.args,id:e.id};s.push(t)}return s}}class bs extends _s{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await(0,ms.K3)(this.zodSchema,e);if(t.success)return t.data;throw new us.CC(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const t=(await super.parsePartialResult(e)).filter(e=>e.type===this.keyName);let n=t;if(t.length)return this.returnId||(n=t.map(e=>e.args)),this.returnSingle?n[0]:n}async parseResult(e){const t=(await super.parsePartialResult(e,!1)).filter(e=>e.type===this.keyName);let n=t;if(!t.length)return;if(this.returnId||(n=t.map(e=>e.args)),this.returnSingle)return this._validateResult(n[0]);return await Promise.all(n.map(e=>this._validateResult(e)))}}const ws=Symbol("Let zodToJsonSchema decide on which parser to use"),vs={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Es=e=>"_def"in e?e._def:e;const Ss=e=>{const t=(e=>"string"==typeof e?{...vs,basePath:["#"],definitions:{},name:e}:{...vs,basePath:["#"],definitions:{},...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([e,n])=>[Es(n),{def:Es(n),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}};var xs=n(2080);function ks(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function Ts(e,t,n,r,s){e[t]=n,ks(e,t,r,s)}function Is(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((n,r)=>Is(e,t,n))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Os(e,t)}}const Os=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":Ts(n,"minimum",r.value,r.message,t);break;case"max":Ts(n,"maximum",r.value,r.message,t)}return n};let Cs;const As=/^[cC][^\s-]{8,}$/,Ps=/^[0-9a-z]+$/,Ms=/^[0-9A-HJKMNP-TV-Z]{26}$/,Rs=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,$s=()=>(void 0===Cs&&(Cs=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Cs),js=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Ns=/^[a-zA-Z0-9_-]{21}$/;function Ls(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?Ds(e):e}if(e.checks)for(const s of e.checks)switch(s.kind){case"min":Ts(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,s.value):s.value,s.message,t);break;case"max":Ts(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,s.value):s.value,s.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Us(n,"email",s.message,t);break;case"format:idn-email":Us(n,"idn-email",s.message,t);break;case"pattern:zod":Fs(n,Rs,s.message,t)}break;case"url":Us(n,"uri",s.message,t);break;case"uuid":Us(n,"uuid",s.message,t);break;case"regex":Fs(n,s.regex,s.message,t);break;case"cuid":Fs(n,As,s.message,t);break;case"cuid2":Fs(n,Ps,s.message,t);break;case"startsWith":Fs(n,RegExp(`^${r(s.value)}`),s.message,t);break;case"endsWith":Fs(n,RegExp(`${r(s.value)}$`),s.message,t);break;case"datetime":Us(n,"date-time",s.message,t);break;case"date":Us(n,"date",s.message,t);break;case"time":Us(n,"time",s.message,t);break;case"duration":Us(n,"duration",s.message,t);break;case"length":Ts(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,s.value):s.value,s.message,t),Ts(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,s.value):s.value,s.message,t);break;case"includes":Fs(n,RegExp(r(s.value)),s.message,t);break;case"ip":"v6"!==s.version&&Us(n,"ipv4",s.message,t),"v4"!==s.version&&Us(n,"ipv6",s.message,t);break;case"emoji":Fs(n,$s,s.message,t);break;case"ulid":Fs(n,Ms,s.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Us(n,"binary",s.message,t);break;case"contentEncoding:base64":Ts(n,"contentEncoding","base64",s.message,t);break;case"pattern:zod":Fs(n,js,s.message,t)}break;case"nanoid":Fs(n,Ns,s.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:(()=>{})()}return n}const Ds=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Us=(e,t,n,r)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Ts(e,"format",t,n,r)},Fs=(e,t,n,r)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:Ys(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Ts(e,"pattern",Ys(t,r),n,r)},Ys=(e,t)=>{const n="function"==typeof e?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const r=n.flags.includes("i"),s=n.flags.includes("m"),i=n.flags.includes("s"),a=r?n.source.toLowerCase():n.source;let o="",c=!1,l=!1,u=!1;for(let e=0;e<a.length;e++)if(c)o+=a[e],c=!1;else{if(r)if(l){if(a[e].match(/[a-z]/)){u?(o+=a[e],o+=`${a[e-2]}-${a[e]}`.toUpperCase(),u=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(o+=a[e],u=!0):o+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){o+=`[${a[e]}${a[e].toUpperCase()}]`;continue}if(s){if("^"===a[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===a[e]){o+="($|(?=[\r\n]))";continue}}i&&"."===a[e]?o+=l?`${a[e]}\r\n`:`[${a[e]}\r\n]`:(o+=a[e],"\\"===a[e]?c=!0:l&&"]"===a[e]?l=!1:l||"["!==a[e]||(l=!0))}try{new RegExp(o)}catch{return n.source}return o};function Gs(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===xs.kY.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,r)=>({...n,[r]:qs(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:qs(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===xs.kY.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(Ls(e.keyType._def,t)).reduce((e,[t,n])=>"type"===t?e:{...e,[t]:n},{});return{...n,propertyNames:r}}return e.keyType?._def.typeName===xs.kY.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const Bs={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};const Hs=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,n)=>qs(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return n.length?{anyOf:n}:void 0};function zs(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:qs(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:qs(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function qs(e,t,n=!1){const r=t.seen.get(e);if(t.override){const s=t.override?.(e,t,r,n);if(s!==ws)return s}if(r&&!n){const e=Ks(r,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}const s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);const i=Vs(e,e.typeName,t,n);return i&&Js(e,t,i),s.jsonSchema=i,i}const Ks=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const n=e.path.slice(t.basePath.length+1).join("_");return n!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[n]=e.def),{$ref:[...t.basePath,t.definitionPath,n].join("/")};case"relative":return{$ref:Ws(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,n)=>t.currentPath[n]===e)||"seen"===t.$refStrategy?{}:void 0}},Ws=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},Vs=(e,t,n,r)=>{switch(t){case xs.kY.ZodString:return Ls(e,n);case xs.kY.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",ks(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?Ts(n,"minimum",r.value,r.message,t):Ts(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Ts(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Ts(n,"maximum",r.value,r.message,t):Ts(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Ts(n,"maximum",r.value,r.message,t));break;case"multipleOf":Ts(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case xs.kY.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const s=[...t.currentPath,"properties",n],i=qs(r._def,{...t,currentPath:s,propertyPath:s});if(void 0===i)return e;if(t.openaiStrictMode&&r.isOptional()&&!r.isNullable()&&void 0===r._def?.defaultValue)throw new Error(`Zod field at \`${s.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...e.properties,[n]:i},required:r.isOptional()&&!t.openaiStrictMode?e.required:[...e.required,n]}},{properties:{},required:[]}),additionalProperties:zs(e,t)};return n.required.length||delete n.required,n}(e,n);case xs.kY.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?Ts(n,"minimum",r.value,r.message,t):Ts(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Ts(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Ts(n,"maximum",r.value,r.message,t):Ts(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Ts(n,"maximum",r.value,r.message,t));break;case"multipleOf":Ts(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case xs.kY.ZodBoolean:return{type:"boolean"};case xs.kY.ZodDate:return Is(e,n);case xs.kY.ZodUndefined:return{not:{}};case xs.kY.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case xs.kY.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==xs.kY.ZodAny&&(n.items=qs(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Ts(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Ts(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Ts(n,"minItems",e.exactLength.value,e.exactLength.message,t),Ts(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case xs.kY.ZodUnion:case xs.kY.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Hs(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every(e=>e._def.typeName in Bs&&(!e._def.checks||!e._def.checks.length))){const e=n.reduce((e,t)=>{const n=Bs[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e},[]);return{type:e.length>1?e:e[0]}}if(n.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=n.reduce((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===n.length){const t=e.filter((e,t,n)=>n.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:n.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(n.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:n.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return Hs(e,t)}(e,n);case xs.kY.ZodIntersection:return function(e,t){const n=[qs(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),qs(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;s.push(t)}else s.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t}),s.length?{allOf:s,...r}:void 0}(e,n);case xs.kY.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,n)=>qs(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:qs(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,n)=>qs(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,n);case xs.kY.ZodRecord:return Gs(e,n);case xs.kY.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case xs.kY.ZodEnum:return function(e){return{type:"string",enum:[...e.values]}}(e);case xs.kY.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),r=Array.from(new Set(n.map(e=>typeof e)));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case xs.kY.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target||"property"===t.nullableStrategy?{type:Bs[e.innerType._def.typeName],nullable:!0}:{type:[Bs[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=qs(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=qs(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case xs.kY.ZodOptional:return((e,t)=>{if(t.propertyPath&&t.currentPath.slice(0,t.propertyPath.length).toString()===t.propertyPath.toString())return qs(e.innerType._def,{...t,currentPath:t.currentPath});const n=qs(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case xs.kY.ZodMap:return function(e,t){return"record"===t.mapStrategy?Gs(e,t):{type:"array",maxItems:125,items:{type:"array",items:[qs(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},qs(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case xs.kY.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:qs(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Ts(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Ts(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case xs.kY.ZodLazy:return qs(e.getter()._def,n);case xs.kY.ZodPromise:return function(e,t){return qs(e.type._def,t)}(e,n);case xs.kY.ZodNaN:case xs.kY.ZodNever:return{not:{}};case xs.kY.ZodEffects:return function(e,t,n){return"input"===t.effectStrategy?qs(e.schema._def,t,n):{}}(e,n,r);case xs.kY.ZodAny:case xs.kY.ZodUnknown:return{};case xs.kY.ZodDefault:return function(e,t){return{...qs(e.innerType._def,t),default:e.defaultValue()}}(e,n);case xs.kY.ZodBranded:return function(e,t){return qs(e.type._def,t)}(e,n);case xs.kY.ZodReadonly:case xs.kY.ZodCatch:return((e,t)=>qs(e.innerType._def,t))(e,n);case xs.kY.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return qs(e.in._def,t);if("output"===t.pipeStrategy)return qs(e.out._def,t);const n=qs(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,qs(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter(e=>void 0!==e)}})(e,n);case xs.kY.ZodFunction:case xs.kY.ZodVoid:case xs.kY.ZodSymbol:default:return}},Js=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n);function Zs(e,t){return((e,t)=>{const n=Ss(t),r="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,s=qs(e._def,void 0===r?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},i="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==i&&(s.title=i);const a=(()=>{if(function(e){if(!e)return!0;for(const t in e)return!1;return!0}(n.definitions))return;const e={},t=new Set;for(let r=0;r<500;r++){const r=Object.entries(n.definitions).filter(([e])=>!t.has(e));if(0===r.length)break;for(const[s,i]of r)e[s]=qs(Es(i),{...n,currentPath:[...n.basePath,n.definitionPath,s]},!0)??{},t.add(s)}return e})(),o=void 0===r?a?{...s,[n.definitionPath]:a}:s:"duplicate-ref"===n.nameStrategy?{...s,...a||n.seenRefs.size?{[n.definitionPath]:{...a,...n.seenRefs.size?{[r]:s}:void 0}}:void 0}:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...a,[r]:s}};return"jsonSchema7"===n.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o})(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Xs(e,t,n){return function(e,t){const n={...e};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),n}({type:"json_schema",json_schema:{...n,name:t,strict:!0,schema:Zs(e,{name:t})}},t=>e.parse(JSON.parse(t)))}var Qs=n(6615);function ei(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:i,azureADTokenProvider:a,azureOpenAIEndpoint:o}=e;if((r||a)&&s&&t)return`${s}/${t}`;if((r||a)&&o&&t)return`${o}/openai/deployments/${t}`;if(r||a){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return i}var ti=n(194);function ni(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}function ri(e){let t;return e.constructor.name===h.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===u.name?(t=new Error(e.message),t.name="AbortError"):t=400===e.status&&e.message.includes("tool_calls")?ni(e,"INVALID_TOOL_RESULTS"):401===e.status?ni(e,"MODEL_AUTHENTICATION"):429===e.status?ni(e,"MODEL_RATE_LIMIT"):404===e.status?ni(e,"MODEL_NOT_FOUND"):e,t}function si(e){return e?"any"===e||"required"===e?"required":"auto"===e?"auto":"none"===e?"none":"string"==typeof e?{type:"function",function:{name:e}}:e:void 0}function ii(e,t){const n=[];for(const[r,s]of Object.entries(e.properties??{}))s.description&&t<2&&n.push(`// ${s.description}`),e.required?.includes(r)?n.push(`${r}: ${ai(s,t)},`):n.push(`${r}?: ${ai(s,t)},`);return n.map(e=>" ".repeat(t)+e).join("\n")}function ai(e,t){if(void 0!==(n=e).anyOf&&Array.isArray(n.anyOf))return e.anyOf.map(e=>ai(e,t)).join(" | ");var n;switch(e.type){case"string":return e.enum?e.enum.map(e=>`"${e}"`).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map(e=>`${e}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",ii(e,t+2),"}"].join("\n");case"array":return e.items?`${ai(e.items,t)}[]`:"any[]";default:return""}}function oi(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!rs.cM.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&e.role,e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}const ci={providerName:"ChatOpenAI",fromStandardTextBlock:e=>({type:"text",text:e.text}),fromStandardImageBlock(e){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};if("base64"===e.source_type){return{type:"image_url",image_url:{url:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.detail?{detail:e.metadata.detail}:{}}}}throw new Error(`Image content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(e){if("url"===e.source_type){const t=(0,rs.Q7)({dataUrl:e.url});if(!t)throw new Error(`URL audio blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);const n=t.mime_type||e.mime_type||"";let r;try{r=(0,rs.Ej)(n)}catch{throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==r.type||"wav"!==r.subtype&&"mp3"!==r.subtype)throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:r.subtype,data:t.data}}}if("base64"===e.source_type){let t;try{t=(0,rs.Ej)(e.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==t.type||"wav"!==t.subtype&&"mp3"!==t.subtype)throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:t.subtype,data:e.data}}}throw new Error(`Audio content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(e){if("url"===e.source_type){if(!(0,rs.Q7)({dataUrl:e.url}))throw new Error(`URL file blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:e.url,...e.metadata?.filename||e.metadata?.name?{filename:e.metadata?.filename||e.metadata?.name}:{}}}}if("base64"===e.source_type)return{type:"file",file:{file_data:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.filename||e.metadata?.name||e.metadata?.title?{filename:e.metadata?.filename||e.metadata?.name||e.metadata?.title}:{}}};if("id"===e.source_type)return{type:"file",file:{file_id:e.id}};throw new Error(`File content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)}};function li(e,t){return e.flatMap(e=>{let n=oi(e);"system"===n&&yi(t)&&(n="developer");const r={role:n,content:"string"==typeof e.content?e.content:e.content.map(e=>(0,rs.Fz)(e)?(0,rs.up)(e,ci):e)};if(null!=e.name&&(r.name=e.name),null!=e.additional_kwargs.function_call&&(r.function_call=e.additional_kwargs.function_call,r.content=""),(0,rs.KX)(e)&&e.tool_calls?.length?(r.tool_calls=e.tool_calls.map(fs),r.content=""):(null!=e.additional_kwargs.tool_calls&&(r.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(r.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio){return[r,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]}return r})}const ui="__openai_function_call_ids__";function di(e,t,n){return e.flatMap(e=>{const r=e.additional_kwargs;let s=oi(e);if("system"===s&&yi(t)&&(s="developer"),"function"===s)throw new Error("Function messages are not supported in Responses API");if("tool"===s){const t=e;if("computer_call_output"===r?.type){return{type:"computer_call_output",output:(()=>{if("string"==typeof t.content)return{type:"computer_screenshot",image_url:t.content};if(Array.isArray(t.content)){const e=t.content.find(e=>"computer_screenshot"===e.type);if(e)return e;const n=t.content.find(e=>"image_url"===e.type);if(n)return{type:"computer_screenshot",image_url:"string"==typeof n.image_url?n.image_url:n.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:t.tool_call_id}}return{type:"function_call_output",call_id:t.tool_call_id,id:t.id?.startsWith("fc_")?t.id:void 0,output:"string"!=typeof t.content?JSON.stringify(t.content):t.content}}if("assistant"===s){if(!n&&null!=e.response_metadata.output&&Array.isArray(e.response_metadata.output)&&e.response_metadata.output.length>0&&e.response_metadata.output.every(e=>"type"in e))return e.response_metadata.output;const t=[];if(r?.reasoning&&!n){const e=function(e){const t=(e.summary.length>1?e.summary.reduce((e,t)=>{const n=e.at(-1);return n.index===t.index?n.text+=t.text:e.push(t),e},[{...e.summary[0]}]):e.summary).map(e=>Object.fromEntries(Object.entries(e).filter(([e])=>"index"!==e)));return{...e,summary:t}}(r.reasoning);t.push(e)}let{content:s}=e;r?.refusal&&("string"==typeof s&&(s=[{type:"output_text",text:s,annotations:[]}]),s=[...s,{type:"refusal",refusal:r.refusal}]),t.push({type:"message",role:"assistant",...e.id&&!n&&e.id.startsWith("msg_")?{id:e.id}:{},content:"string"==typeof s?s:s.flatMap(e=>"text"===e.type?{type:"output_text",text:e.text,annotations:e.annotations??[]}:"output_text"===e.type||"refusal"===e.type?e:[])});const i=r?.[ui];(0,rs.KX)(e)&&e.tool_calls?.length?t.push(...e.tool_calls.map(e=>({type:"function_call",name:e.name,arguments:JSON.stringify(e.args),call_id:e.id,...n?{id:i?.[e.id]}:{}}))):r?.tool_calls&&t.push(...r.tool_calls.map(e=>({type:"function_call",name:e.function.name,call_id:e.id,arguments:e.function.arguments,...n?{id:i?.[e.id]}:{}})));const a=e.response_metadata.output?.length?e.response_metadata.output:r.tool_outputs,o=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(null!=a){const e=a,n=e?.filter(e=>o.includes(e.type));n.length>0&&t.push(...n)}return t}if("user"===s||"system"===s||"developer"===s){if("string"==typeof e.content)return{type:"message",role:s,content:e.content};const t=[],n=e.content.flatMap(e=>("mcp_approval_response"===e.type&&t.push({type:"mcp_approval_response",approval_request_id:e.approval_request_id,approve:e.approve}),(0,rs.Fz)(e)?(0,rs.up)(e,ci):"text"===e.type?{type:"input_text",text:e.text}:"image_url"===e.type?{type:"input_image",image_url:"string"==typeof e.image_url?e.image_url:e.image_url.url,detail:"string"==typeof e.image_url?"auto":e.image_url.detail}:"input_text"===e.type||"input_image"===e.type||"input_file"===e.type?e:[]));return n.length>0&&t.push({type:"message",role:s,content:n}),t}return[]})}function hi(e){if(e.error){const t=new Error(e.error.message);throw t.name=e.error.code,t}let t;const n=[],r=[],s=[],i={model:e.model,created_at:e.created_at,id:e.id,incomplete_details:e.incomplete_details,metadata:e.metadata,object:e.object,status:e.status,user:e.user,service_tier:e.service_tier,model_name:e.model},a={};for(const i of e.output)if("message"===i.type)t=i.id,n.push(...i.content.flatMap(e=>"output_text"===e.type?("parsed"in e&&null!=e.parsed&&(a.parsed=e.parsed),{type:"text",text:e.text,annotations:e.annotations}):"refusal"===e.type?(a.refusal=e.refusal,[]):e));else if("function_call"===i.type){const e={function:{name:i.name,arguments:i.arguments},id:i.call_id};try{r.push(gs(e,{returnId:!0}))}catch(t){let n;"object"==typeof t&&null!=t&&"message"in t&&"string"==typeof t.message&&(n=t.message),s.push(ys(e,n))}a[ui]??={},i.id&&(a[ui][i.call_id]=i.id)}else"reasoning"===i.type?a.reasoning=i:(a.tool_outputs??=[],a.tool_outputs.push(i));return new rs.Od({id:t,content:n,tool_calls:r,invalid_tool_calls:s,usage_metadata:e.usage,additional_kwargs:a,response_metadata:i})}function pi(e){const t=[];let n,r={};const s=[],i={},a={};let o;if("response.output_text.delta"===e.type)t.push({type:"text",text:e.delta,index:e.content_index});else if("response.output_text_annotation.added"===e.type)t.push({type:"text",text:"",annotations:[e.annotation],index:e.content_index});else if("response.output_item.added"===e.type&&"message"===e.item.type)o=e.item.id;else if("response.output_item.added"===e.type&&"function_call"===e.item.type)s.push({type:"tool_call_chunk",name:e.item.name,args:e.item.arguments,id:e.item.call_id,index:e.output_index}),a[ui]={[e.item.call_id]:e.item.id};else if("response.output_item.done"===e.type&&["web_search_call","file_search_call","computer_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call"].includes(e.item.type))a.tool_outputs=[e.item];else if("response.created"===e.type)i.id=e.response.id,i.model_name=e.response.model,i.model=e.response.model;else if("response.completed"===e.type){const t=hi(e.response);n=e.response.usage,"json_schema"===e.response.text?.format?.type&&(a.parsed??=JSON.parse(t.text));for(const[t,n]of Object.entries(e.response))"id"!==t&&(i[t]=n)}else if("response.function_call_arguments.delta"===e.type)s.push({type:"tool_call_chunk",args:e.delta,index:e.output_index});else if("response.web_search_call.completed"===e.type||"response.file_search_call.completed"===e.type)r={tool_outputs:{id:e.item_id,type:e.type.replace("response.","").replace(".completed",""),status:"completed"}};else if("response.refusal.done"===e.type)a.refusal=e.refusal;else if("response.output_item.added"===e.type&&"item"in e&&"reasoning"===e.item.type){const t=e.item.summary?e.item.summary.map((e,t)=>({...e,index:t})):void 0;a.reasoning={id:e.item.id,type:e.item.type,...t?{summary:t}:{}}}else if("response.reasoning_summary_part.added"===e.type)a.reasoning={type:"reasoning",summary:[{...e.part,index:e.summary_index}]};else{if("response.reasoning_summary_text.delta"!==e.type)return e.type,null;a.reasoning={type:"reasoning",summary:[{text:e.delta,type:"summary_text",index:e.summary_index}]}}return new ss.Cf({text:t.map(e=>e.text).join(""),message:new rs.H({id:o,content:t,tool_call_chunks:s,usage_metadata:n,additional_kwargs:a,response_metadata:i}),generationInfo:r})}function mi(e){return"type"in e&&"function"!==e.type}function gi(e,t){const n=[];for(const r of e)mi(r)?("image_generation"===r.type&&t?.stream&&(r.partial_images=1),n.push(r)):(0,os.VC)(r)&&n.push({type:"function",name:r.function.name,parameters:r.function.parameters,description:r.function.description,strict:t?.strict??null});return n}function fi(e,t){return(0,os.VC)(e)?void 0!==t?.strict?{...e,function:{...e.function,strict:t.strict}}:e:function(e,t){let n;return n=(0,ti.qG)(e)?(0,ti.fL)(e):e,void 0!==t?.strict&&(n.function.strict=t.strict),n}(e,t)}function yi(e){return e&&/^o\d/.test(e)}class _i extends as.xV{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort","service_tier"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","useResponsesApi","zdrEnabled","reasoning"]}constructor(e){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoning",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zdrEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"service_tier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??(0,is.Az)("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=e?.configuration?.organization??(0,is.Az)("OPENAI_ORGANIZATION"),this.model=e?.model??e?.modelName??this.model,this.modelName=this.model,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort??e?.reasoning?.effort,this.reasoning=e?.reasoning??(e?.reasoningEffort?{effort:e.reasoningEffort}:void 0),this.maxTokens=e?.maxCompletionTokens??e?.maxTokens,this.useResponsesApi=e?.useResponsesApi??this.useResponsesApi,this.disableStreaming=e?.disableStreaming??this.disableStreaming,this.streaming=e?.streaming??!1,this.disableStreaming&&(this.streaming=!1),this.streamUsage=e?.streamUsage??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration},void 0!==e?.supportsStrictToolCalling&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),void 0!==e?.service_tier&&(this.service_tier=e.service_tier),this.zdrEnabled=e?.zdrEnabled??!1}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let n;return void 0!==t?.strict?n=t.strict:void 0!==this.supportsStrictToolCalling&&(n=this.supportsStrictToolCalling),this.withConfig({tools:e.map(e=>mi(e)?e:fi(e,{strict:n})),...t})}createResponseFormat(e){return e&&"json_schema"===e.type&&e.json_schema.schema&&(0,ms.c9)(e.json_schema.schema)?function(e,t,n){if((0,ms.IU)(e))return Xs(e,t,n);if((0,ms.Pq)(e))return function(e,t){const n={...e};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),n}({type:"json_schema",json_schema:{...n,name:t,strict:!0,schema:ts.b(e,{cycles:"ref",reused:"ref",override(e){e.jsonSchema.title=t}})}},t=>ns.qg(e,JSON.parse(t)));throw new Error("Unsupported schema response format")}(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}getReasoningParams(e){if(!yi(this.model))return;let t;return void 0!==this.reasoningEffort&&(t={effort:this.reasoningEffort}),void 0!==this.reasoning&&(t={...t,...this.reasoning}),void 0!==e?.reasoning_effort&&(t={...t,effort:e.reasoning_effort}),void 0!==e?.reasoning&&(t={...t,...e.reasoning}),t}invocationParams(e,t){let n;if(void 0!==e?.strict?n=e.strict:void 0!==this.supportsStrictToolCalling&&(n=this.supportsStrictToolCalling),this._useResponseApi(e)){const t={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e?.previous_response_id,truncation:e?.truncation,include:e?.include,tools:e?.tools?.length?gi(e.tools,{stream:this.streaming,strict:n}):void 0,tool_choice:(r=e?.tool_choice,null!=r&&"object"==typeof r&&"type"in r&&"function"!==r.type?e?.tool_choice:(()=>{const t=si(e?.tool_choice);return"object"==typeof t&&"type"in t?{type:"function",name:t.function.name}:void 0})()),text:(()=>{if(e?.text)return e.text;const t=this.createResponseFormat(e?.response_format);return"json_schema"===t?.type?null!=t.json_schema.schema?{format:{type:"json_schema",schema:t.json_schema.schema,description:t.json_schema.description,name:t.json_schema.name,strict:t.json_schema.strict}}:void 0:{format:t}})(),parallel_tool_calls:e?.parallel_tool_calls,max_output_tokens:-1===this.maxTokens?void 0:this.maxTokens,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},s=this.getReasoningParams(e);return void 0!==s&&(t.reasoning=s),t}var r;let s={};void 0!==e?.stream_options?s={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(s={stream_options:{include_usage:!0}});const i={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(e=>fi(e,{strict:n})):void 0,tool_choice:si(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...s,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};void 0!==e?.prediction&&(i.prediction=e.prediction),void 0!==this.service_tier&&(i.service_tier=this.service_tier),void 0!==e?.service_tier&&(i.service_tier=e.service_tier);const a=this.getReasoningParams(e);return void 0!==a&&void 0!==a.effort&&(i.reasoning_effort=a.effort),yi(i.model)?i.max_completion_tokens=-1===this.maxTokens?void 0:this.maxTokens:i.max_tokens=-1===this.maxTokens?void 0:this.maxTokens,i}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const n=e.tool_calls;if("assistant"===e.role){const r=[],s=[];for(const e of n??[])try{r.push(gs(e,{returnId:!0}))}catch(t){s.push(ys(e,t.message))}const i={function_call:e.function_call,tool_calls:n};void 0!==this.__includeRawResponse&&(i.__raw_response=t);const a={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(i.audio=e.audio),new rs.Od({content:e.content||"",tool_calls:r,invalid_tool_calls:s,additional_kwargs:i,response_metadata:a,id:t.id})}return new rs.cM(e.content||"",e.role??"unknown")}_convertOpenAIDeltaToBaseMessageChunk(e,t,n){const r=e.role??n,s=e.content??"";let i;i=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},this.__includeRawResponse&&(i.__raw_response=t),e.audio&&(i.audio={...e.audio,index:t.choices[0].index});const a={usage:{...t.usage}};if("user"===r)return new rs.a7({content:s,response_metadata:a});if("assistant"===r){const n=[];if(Array.isArray(e.tool_calls))for(const t of e.tool_calls)n.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new rs.H({content:s,tool_call_chunks:n,additional_kwargs:i,id:t.id,response_metadata:a})}return"system"===r?new rs.uU({content:s,response_metadata:a}):"developer"===r?new rs.uU({content:s,response_metadata:a,additional_kwargs:{__openai_role__:"developer"}}):"function"===r?new rs.FK({content:s,additional_kwargs:i,name:e.name,response_metadata:a}):"tool"===r?new rs.dr({content:s,additional_kwargs:i,tool_call_id:e.tool_call_id,response_metadata:a}):new rs.XU({content:s,role:r,response_metadata:a})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){if(this._useResponseApi(t)){const n=await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:di(e,this.model,this.zdrEnabled),stream:!0},t);for await(const e of n){const t=pi(e);null!=t&&(yield t)}return}const r=li(e,this.model),s={...this.invocationParams(t,{streaming:!0}),messages:r,stream:!0};let i;const a=await this.completionWithRetry(s,t);let o;for await(const e of a){const r=e?.choices?.[0];if(e.usage&&(o=e.usage),!r)continue;const{delta:s}=r;if(!s)continue;const a=this._convertOpenAIDeltaToBaseMessageChunk(s,e,i);i=s.role??i;const c={prompt:t.promptIndex??0,completion:r.index??0};if("string"!=typeof a.content)continue;const l={...c};null!=r.finish_reason&&(l.finish_reason=r.finish_reason,l.system_fingerprint=e.system_fingerprint,l.model_name=e.model,l.service_tier=e.service_tier),this.logprobs&&(l.logprobs=r.logprobs);const u=new ss.Cf({message:a,text:a.content,generationInfo:l});yield u,await(n?.handleLLMNewToken(u.text??"",c,void 0,void 0,void 0,{chunk:u}))}if(o){const e={...null!==o.prompt_tokens_details?.audio_tokens&&{audio:o.prompt_tokens_details?.audio_tokens},...null!==o.prompt_tokens_details?.cached_tokens&&{cache_read:o.prompt_tokens_details?.cached_tokens}},t={...null!==o.completion_tokens_details?.audio_tokens&&{audio:o.completion_tokens_details?.audio_tokens},...null!==o.completion_tokens_details?.reasoning_tokens&&{reasoning:o.completion_tokens_details?.reasoning_tokens}},n=new ss.Cf({message:new rs.H({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield n}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,n){const r=this.invocationParams(t);if(r.stream){const r=this._streamResponseChunks(e,t,n);let s;for await(const e of r)e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},s=s?.concat(e)??e;return{generations:s?[s]:[],llmOutput:{estimatedTokenUsage:s?.message?.usage_metadata}}}const s=di(e,this.model,this.zdrEnabled),i=await this.responseApiWithRetry({input:s,...r},{signal:t?.signal,...t?.options});return{generations:[{text:i.output_text,message:hi(i)}],llmOutput:{id:i.id,estimatedTokenUsage:i.usage?{promptTokens:i.usage.input_tokens,completionTokens:i.usage.output_tokens,totalTokens:i.usage.total_tokens}:void 0}}}_useResponseApi(e){const t=e?.tools?.some(mi),n=null!=e?.previous_response_id||null!=e?.text||null!=e?.truncation||null!=e?.include||null!=e?.reasoning?.summary||null!=this.reasoning?.summary;return this.useResponsesApi||t||n}async _generate(e,t,n){if(this._useResponseApi(t))return this._responseApiGenerate(e,t,n);const r={},s=this.invocationParams(t),i=li(e,this.model);if(s.stream){const s=this._streamResponseChunks(e,t,n),i={};for await(const e of s){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===i[t]?i[t]=e:i[t]=i[t].concat(e)}const a=Object.entries(i).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),{functions:o,function_call:c}=this.invocationParams(t),l=await this.getEstimatedTokenCountFromPrompt(e,o,c),u=await this.getNumTokensFromGenerations(a);return r.input_tokens=l,r.output_tokens=u,r.total_tokens=l+u,{generations:a,llmOutput:{estimatedTokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}{let e;e=t.response_format&&"json_schema"===t.response_format.type?await this.betaParsedCompletionWithRetry({...s,stream:!1,messages:i},{signal:t?.signal,...t?.options}):await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t?.signal,...t?.options});const{completion_tokens:n,prompt_tokens:a,total_tokens:o,prompt_tokens_details:c,completion_tokens_details:l}=e?.usage??{};n&&(r.output_tokens=(r.output_tokens??0)+n),a&&(r.input_tokens=(r.input_tokens??0)+a),o&&(r.total_tokens=(r.total_tokens??0)+o),null===c?.audio_tokens&&null===c?.cached_tokens||(r.input_token_details={...null!==c?.audio_tokens&&{audio:c?.audio_tokens},...null!==c?.cached_tokens&&{cache_read:c?.cached_tokens}}),null===l?.audio_tokens&&null===l?.reasoning_tokens||(r.output_token_details={...null!==l?.audio_tokens&&{audio:l?.audio_tokens},...null!==l?.reasoning_tokens&&{reasoning:l?.reasoning_tokens}});const u=[];for(const t of e?.choices??[]){const n={text:t.message?.content??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(t.message??{role:"assistant"},e)};n.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},(0,rs.KX)(n.message)&&(n.message.usage_metadata=r),n.message=new rs.Od(Object.fromEntries(Object.entries(n.message).filter(([e])=>!e.startsWith("lc_")))),u.push(n)}return{generations:u,llmOutput:{tokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){const e=function(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(ii(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);r+=await this.getNumTokens(e),r+=9}return t&&e.find(e=>"system"===e._getType())&&(r-=4),"none"===n?r+=1:"object"==typeof n&&(r+=await this.getNumTokens(n.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)))).reduce((e,t)=>e+t,0)}async getNumTokensFromMessages(e){let t=0,n=0,r=0;"gpt-3.5-turbo-0301"===this.model?(n=4,r=-1):(n=3,r=1);const s=await Promise.all(e.map(async e=>{const s=await this.getNumTokens(e.content),i=await this.getNumTokens(oi(e)),a=void 0!==e.name?r+await this.getNumTokens(e.name):0;let o=s+n+i+a;const c=e;if("function"===c._getType()&&(o-=2),c.additional_kwargs?.function_call&&(o+=3),c?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(c.additional_kwargs.function_call?.name)),c.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(c.additional_kwargs.function_call?.arguments)))}catch(e){o+=await this.getNumTokens(c.additional_kwargs.function_call?.arguments)}return t+=o,o}));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,n)}catch(e){throw ri(e)}})}async responseApiWithRetry(e,t){return this.caller.call(async()=>{const n=this._getClientOptions(t);try{return"json_schema"!==e.text?.format?.type||e.stream?await this.client.responses.create(e,n):await this.client.responses.parse(e,n)}catch(e){throw ri(e)}})}async betaParsedCompletionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.parse(e,n)}catch(e){throw ri(e)}})}_getClientOptions(e){if(!this.client){const e=ei({baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new es(t)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,r,s,i;var a;let o,c;if(void 0!==(a=e)&&"object"==typeof a.schema?(n=e.schema,r=e.name,s=e.method,i=e.includeRaw):(n=e,r=t?.name,s=t?.method,i=t?.includeRaw),void 0!==t?.strict&&"jsonMode"===s)throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(this.model.startsWith("gpt-3")||this.model.startsWith("gpt-4-")||"gpt-4"===this.model||void 0===s&&(s="jsonSchema"),"jsonMode"===s){let e;(0,ms.c9)(n)?(c=ls._6.fromZodSchema(n),e=(0,Qs.PF)(n)):c=new ls.hU,o=this.withConfig({response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"jsonMode"},schema:e}})}else if("jsonSchema"===s)if(o=this.withConfig({response_format:{type:"json_schema",json_schema:{name:r??"extract",description:(0,ms.cg)(n),schema:n,strict:t?.strict}},ls_structured_output_format:{kwargs:{method:"jsonSchema"},schema:(0,Qs.PF)(n)}}),(0,ms.c9)(n)){const e=ls._6.fromZodSchema(n);c=cs.jY.from(t=>"parsed"in t.additional_kwargs?t.additional_kwargs.parsed:e)}else c=new ls.hU;else{let e=r??"extract";if((0,ms.c9)(n)){const r=(0,Qs.PF)(n);o=this.withConfig({tools:[{type:"function",function:{name:e,description:r.description,parameters:r}}],tool_choice:{type:"function",function:{name:e}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:r},...void 0!==t?.strict?{strict:t.strict}:{}}),c=new bs({returnSingle:!0,keyName:e,zodSchema:n})}else{let r;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(r=n,e=n.name):(e=n.title??e,r={name:e,description:n.description??"",parameters:n}),o=this.withConfig({tools:[{type:"function",function:r}],tool_choice:{type:"function",function:{name:e}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:(0,Qs.PF)(n)},...void 0!==t?.strict?{strict:t.strict}:{}}),c=new bs({returnSingle:!0,keyName:e})}}if(!i)return o.pipe(c);const l=cs.kI.assign({parsed:(e,t)=>c.invoke(e.raw,t)}),u=cs.kI.assign({parsed:()=>null}),d=l.withFallbacks({fallbacks:[u]});return cs.zZ.from([{raw:o},d])}}var bi=n(9614);n(1535);bi.P;var wi=n(2540);wi.J;var vi=n(7889);class Ei extends vi.NL{static lc_name(){return"DallEAPIWrapper"}constructor(e){void 0!==e?.responseFormat&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??(0,is.Az)("OPENAI_API_KEY"),organization:e?.organization??(0,is.Az)("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0,baseURL:e?.baseUrl};this.client=new es(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return"url"===this.dallEResponseFormat?e.flatMap(e=>e.data?.flatMap(e=>e.url?{type:"image_url",image_url:e.url}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"string"==typeof e.image_url&&void 0!==e.image_url)??[]):e.flatMap(e=>e.data?.flatMap(e=>e.b64_json?{type:"image_url",image_url:{url:e.b64_json}}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"object"==typeof e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&void 0!==e.image_url.url)??[])}async _call(e){const t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){const e=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(e)}const n=await this.client.images.generate(t);let r="";return"url"===this.dallEResponseFormat?[r]=n.data?.map(e=>e.url).filter(e=>"undefined"!==e)??[]:[r]=n.data?.map(e=>e.b64_json).filter(e=>"undefined"!==e)??[],r}}Object.defineProperty(Ei,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"})},639:(e,t,n)=>{"use strict";n.d(t,{q:()=>s});var r=n(4785);const s=()=>(0,r.Jz)("PROJECT")??(0,r.Az)("LANGCHAIN_SESSION")??"default"},747:(e,t,n)=>{"use strict";n.d(t,{Yx:()=>o,rO:()=>a});var r=n(4785);const s=(...e)=>fetch(...e),i=Symbol.for("ls:fetch_implementation"),a=()=>{const e=globalThis[i];return!!e&&("function"==typeof e&&"Headers"in e&&"Request"in e&&"Response"in e)},o=e=>async(...t)=>{if(e||"true"===(0,r.Jz)("DEBUG")){const[e,n]=t}const n=await(globalThis[i]??s)(...t);return e||(0,r.Jz)("DEBUG"),n}},765:(e,t,n)=>{"use strict";n.d(t,{DY:()=>d,SV:()=>o,ZI:()=>l,kJ:()=>a,p_:()=>i,tn:()=>u});var r=n(9149),s=n(4350);const i=25;async function a(e){return r.Td._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function o(...e){const t={};for(const n of e.filter(e=>!!e))for(const e of Object.keys(n))if("metadata"===e)t[e]={...t[e],...n[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(n[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...n[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=n.timeout:void 0!==n.timeout&&(t.timeout=Math.min(t.timeout,n.timeout));else if("signal"===e)void 0===t.signal?t.signal=n.signal:void 0!==n.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,n.signal]):t.signal=n.signal);else if("callbacks"===e){const e=t.callbacks,s=n.callbacks;if(Array.isArray(s))if(e)if(Array.isArray(e))t.callbacks=e.concat(s);else{const n=e.copy();for(const e of s)n.addHandler((0,r.tW)(e),!0);t.callbacks=n}else t.callbacks=s;else if(s)if(e)if(Array.isArray(e)){const n=s.copy();for(const t of e)n.addHandler((0,r.tW)(t),!0);t.callbacks=n}else t.callbacks=new r.Td(s._parentRunId,{handlers:e.handlers.concat(s.handlers),inheritableHandlers:e.inheritableHandlers.concat(s.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(s.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(s.inheritableTags))),metadata:{...e.metadata,...s.metadata}});else t.callbacks=s}else{const r=e;t[r]=n[r]??t[r]}return t}const c=new Set(["string","number","boolean"]);function l(e){const t=s.Nx.getRunnableConfig();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,runName:r,...s}=t;n=Object.entries(s).reduce((e,[t,n])=>(void 0!==n&&(e[t]=n),e),n)}if(e&&(n=Object.entries(e).reduce((e,[t,n])=>(void 0!==n&&(e[t]=n),e),n)),n?.configurable)for(const e of Object.keys(n.configurable))c.has(typeof n.configurable[e])&&!n.metadata?.[e]&&(n.metadata||(n.metadata={}),n.metadata[e]=n.configurable[e]);if(void 0!==n.timeout){if(n.timeout<=0)throw new Error("Timeout must be a positive number");const e=AbortSignal.timeout(n.timeout);void 0!==n.signal?"any"in AbortSignal&&(n.signal=AbortSignal.any([n.signal,e])):n.signal=e,delete n.timeout}return n}function u(e={},{callbacks:t,maxConcurrency:n,recursionLimit:r,runName:s,configurable:i,runId:a}={}){const o=l(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==n&&(o.maxConcurrency=n),void 0!==s&&(o.runName=s),void 0!==i&&(o.configurable={...o.configurable,...i}),void 0!==a&&delete o.runId,o}function d(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}},780:(e,t,n)=>{"use strict";function r(e,t=s){const n=(e=e.trim()).indexOf("```");if(-1===n)return t(e);let r=e.substring(n+3);r.startsWith("json\n")?r=r.substring(5):r.startsWith("json")?r=r.substring(4):r.startsWith("\n")&&(r=r.substring(1));const i=r.indexOf("```");let a=r;return-1!==i&&(a=r.substring(0,i)),t(a.trim())}function s(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const n=[];let r=!1,s=!1;for(let i of e){if(r)'"'!==i||s?"\n"!==i||s?s="\\"===i&&!s:i="\\n":r=!1;else if('"'===i)r=!0,s=!1;else if("{"===i)n.push("}");else if("["===i)n.push("]");else if("}"===i||"]"===i){if(!n||n[n.length-1]!==i)return null;n.pop()}t+=i}r&&(t+='"');for(let e=n.length-1;e>=0;e-=1)t+=n[e];try{return JSON.parse(t)}catch(e){return null}}n.d(t,{D:()=>r,d:()=>s})},823:(e,t,n)=>{"use strict";n.d(t,{$W:()=>s,Bo:()=>l,D5:()=>i,Zd:()=>a,h6:()=>d,kF:()=>o,uW:()=>c,yP:()=>u});var r=n(2080);r.Ik({DEV_MODE:r.zM(),MOCK_LLM_SETTINGS:r.zM(),VERSION:r.Yj(),LOG_LEVEL:r.k5(["info","error","warning","debug"]).default("info")});const s={DEV_MODE:!1,MOCK_LLM_SETTINGS:!1,VERSION:"0.1.0",LOG_LEVEL:"info"};function i(){return s.DEV_MODE}function a(){return s.MOCK_LLM_SETTINGS}const o=!1,c="",l="vibebrowser-agent-online",u="",d=""},909:(e,t,n)=>{"use strict";const r=n(3908);e.exports=(e,t,n)=>{const s=new r(e,n),i=new r(t,n);return s.compare(i)||s.compareBuild(i)}},1123:e=>{"use strict";const t=/^[0-9]+$/,n=(e,n)=>{const r=t.test(e),s=t.test(n);return r&&s&&(e=+e,n=+n),e===n?0:r&&!s?-1:s&&!r?1:e<n?-1:1};e.exports={compareIdentifiers:n,rcompareIdentifiers:(e,t)=>n(t,e)}},1125:(e,t,n)=>{"use strict";var r;n.d(t,{r:()=>r}),function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(r||(r={}))},1259:(e,t,n)=>{"use strict";n.d(t,{Kj:()=>r.Kj,gk:()=>r.gk,q7:()=>r.q7});var r=n(6928)},1261:(e,t,n)=>{"use strict";const r=n(3908),s=n(8311),i=n(5580);e.exports=(e,t)=>{e=new s(e,t);let n=new r("0.0.0");if(e.test(n))return n;if(n=new r("0.0.0-0"),e.test(n))return n;n=null;for(let t=0;t<e.set.length;++t){const s=e.set[t];let a=null;s.forEach(e=>{const t=new r(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":a&&!i(t,a)||(a=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}}),!a||n&&!i(n,a)||(n=a)}return n&&e.test(n)?n:null}},1346:(e,t,n)=>{"use strict";n.d(t,{k:()=>c});var r=n(211),s=n(454);const i={TEACH_MODE:"137.0.7212.69",MCP_SERVER:"137.0.7216.69",WEBSOCKET_AGENT:"137.0.7220.69",NEW_SNAPSHOT_FORMAT:"137.0.7220.69"};class a{static parseVersion(e){return e.split(".").map(e=>parseInt(e,10)||0)}static isVersionAtLeast(e,t){const n=this.parseVersion(e),r=this.parseVersion(t);for(let e=0;e<Math.max(n.length,r.length);e++){const t=n[e]||0,s=r[e]||0;if(t>s)return!0;if(t<s)return!1}return!0}}class o{constructor(){this.browserVersion=null,this.initialized=!1}static getInstance(){return this.instance||(this.instance=new o),this.instance}async initialize(){if(!this.initialized)try{const e=(0,r.uo)();this.browserVersion=await e.getVersion(),this.initialized=!0,s.y7.log("FeatureFlags",`Initialized with VibeBrowser version: ${this.browserVersion}`)}catch(e){s.y7.log("FeatureFlags",`Failed to get VibeBrowser version, using defaults: ${e}`),this.initialized=!0}}isEnabled(e){if(!this.browserVersion)return s.y7.log("FeatureFlags",`No version available, feature '${e}' disabled`),!1;const t=i[e],n=a.isVersionAtLeast(this.browserVersion,t);return s.y7.log("FeatureFlags",`Feature '${e}' requires v${t}, current v${this.browserVersion}: ${n?"ENABLED":"DISABLED"}`),n}getVersion(){return this.browserVersion}getFeatureStatus(){const e={};for(const[t,n]of Object.entries(i))e[t]={required:n,enabled:this.isEnabled(t)};return e}}o.instance=null;const c=()=>o.getInstance()},1356:(e,t,n)=>{"use strict";n.d(t,{gk:()=>b,sh:()=>y});var r=n(7237),s=n(8568);const i=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;const a=function(e){return"string"==typeof e&&i.test(e)};const o=function(e){if(!a(e))throw TypeError("Invalid UUID");var t,n=new Uint8Array(16);return n[0]=(t=parseInt(e.slice(0,8),16))>>>24,n[1]=t>>>16&255,n[2]=t>>>8&255,n[3]=255&t,n[4]=(t=parseInt(e.slice(9,13),16))>>>8,n[5]=255&t,n[6]=(t=parseInt(e.slice(14,18),16))>>>8,n[7]=255&t,n[8]=(t=parseInt(e.slice(19,23),16))>>>8,n[9]=255&t,n[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,n[11]=t/4294967296&255,n[12]=t>>>24&255,n[13]=t>>>16&255,n[14]=t>>>8&255,n[15]=255&t,n};function c(e,t,n,r){switch(e){case 0:return t&n^~t&r;case 1:case 3:return t^n^r;case 2:return t&n^t&r^n&r}}function l(e,t){return e<<t|e>>>32-t}const u=function(e,t,n){function r(e,r,i,a){var c;if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],n=0;n<e.length;++n)t.push(e.charCodeAt(n));return t}(e)),"string"==typeof r&&(r=o(r)),16!==(null===(c=r)||void 0===c?void 0:c.length))throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var l=new Uint8Array(16+e.length);if(l.set(r),l.set(e,r.length),(l=n(l))[6]=15&l[6]|t,l[8]=63&l[8]|128,i){a=a||0;for(var u=0;u<16;++u)i[a+u]=l[u];return i}return(0,s.k)(l)}try{r.name=e}catch(e){}return r.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",r.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",r}("v5",80,function(e){var t=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var r=unescape(encodeURIComponent(e));e=[];for(var s=0;s<r.length;++s)e.push(r.charCodeAt(s))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var i=e.length/4+2,a=Math.ceil(i/16),o=new Array(a),u=0;u<a;++u){for(var d=new Uint32Array(16),h=0;h<16;++h)d[h]=e[64*u+4*h]<<24|e[64*u+4*h+1]<<16|e[64*u+4*h+2]<<8|e[64*u+4*h+3];o[u]=d}o[a-1][14]=8*(e.length-1)/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=8*(e.length-1)&4294967295;for(var p=0;p<a;++p){for(var m=new Uint32Array(80),g=0;g<16;++g)m[g]=o[p][g];for(var f=16;f<80;++f)m[f]=l(m[f-3]^m[f-8]^m[f-14]^m[f-16],1);for(var y=n[0],_=n[1],b=n[2],w=n[3],v=n[4],E=0;E<80;++E){var S=Math.floor(E/20),x=l(y,5)+c(S,_,b,w)+v+t[S]+m[E]>>>0;v=w,w=b,b=l(_,30)>>>0,_=y,y=x}n[0]=n[0]+y>>>0,n[1]=n[1]+_>>>0,n[2]=n[2]+b>>>0,n[3]=n[3]+w>>>0,n[4]=n[4]+v>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,255&n[0],n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,255&n[1],n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,255&n[2],n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,255&n[3],n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,255&n[4]]});var d=n(9033),h=n(4785);var p=n(8152);const m=Symbol.for("lc:context_variables");var g=n(639),f=n(6232);function y(e,t,n=1){const r=n.toFixed(0).slice(0,3).padStart(3,"0"),s=`${new Date(e).toISOString().slice(0,-1)}${r}Z`;return{dottedOrder:(i=s,i.replace(/[-:.]/g,"")+t),microsecondPrecisionDatestring:s};var i}class _{constructor(e,t,n,r){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=n,this.replicas=r}static fromHeader(e){const t=e.split(",");let n,r,s={},i=[];for(const e of t){const[t,a]=e.split("="),o=decodeURIComponent(a);"langsmith-metadata"===t?s=JSON.parse(o):"langsmith-tags"===t?i=o.split(","):"langsmith-project"===t?n=o:"langsmith-replicas"===t&&(r=JSON.parse(o))}return new _(s,i,n,r)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class b{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),null!=(t=e)&&"function"==typeof t.createChild&&"function"==typeof t.postRun)return void Object.assign(this,{...e});var t;const n=b.getDefaultConfig(),{metadata:r,...s}=e,i=s.client??b.getSharedClient(),a={...r,...s?.extra?.metadata};if(s.extra={...s.extra,metadata:a},Object.assign(this,{...n,...s,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=function(e){if(e)return e.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e);return function(){const e=(0,h.Az)("LANGSMITH_RUNS_ENDPOINTS");if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t)){const e=[];for(const n of t)"object"==typeof n&&null!==n&&"string"==typeof n.api_url&&"string"==typeof n.api_key&&e.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key});return e}if("object"==typeof t&&null!==t){!function(e){if(Object.keys(e).length>0&&(0,h.Jz)("ENDPOINT"))throw new p.tE}(t);const e=[];for(const[n,r]of Object.entries(t)){const t=n.replace(/\/$/,"");"string"==typeof r&&e.push({apiUrl:t,apiKey:r})}return e}return[]}catch(e){if((0,p.J_)(e))throw e;return[]}}()}(this.replicas),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){const{dottedOrder:e,microsecondPrecisionDatestring:t}=y(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e,this._serialized_start_time=t}}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){return{id:r.A(),run_type:"chain",project_name:(0,g.q)(),child_runs:[],api_url:(0,h.Az)("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:(0,h.Az)("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return b.sharedClient||(b.sharedClient=new d.Kj),b.sharedClient}createChild(e){const t=this.child_execution_order+1,n=new b({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});m in this&&(n[m]=this[m]);const r=Symbol.for("lc:child_config"),s=e.extra?.[r]??this.extra[r];if(null!=(i=s)&&"object"==typeof i.callbacks&&(v(i.callbacks?.handlers)||v(i.callbacks))){const e={...s},t=function(e){return"object"==typeof e&&null!=e&&Array.isArray(e.handlers)}(e.callbacks)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:n.id}),t.handlers?.find(w)?.updateFromRunTree?.(n),e.callbacks=t),n.extra[r]=e}var i;const a=new Set;let o=this;for(;null!=o&&!a.has(o.id);)a.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(n),n}async end(e,t,n=Date.now(),r){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??n,r&&Object.keys(r).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...r}}:{metadata:r})}_convertToCreate(e,t,n=!0){const r=e.extra??{};if(void 0===r?.runtime?.library&&(r.runtime||(r.runtime={}),t))for(const[e,n]of Object.entries(t))r.runtime[e]||(r.runtime[e]=n);let s,i;return n?(i=e.parent_run?.id??e.parent_run_id,s=[]):(s=e.child_runs.map(e=>this._convertToCreate(e,t,n)),i=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:r,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:s,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,t,n=!0){const r=this._convertToCreate(this,t,n);if(e===this.project_name)return r;const s=t=>u(`${t}:${e}`,u.DNS),i=s(r.id),a=r.trace_id?s(r.trace_id):void 0,o=r.parent_run_id?s(r.parent_run_id):void 0;let c;if(r.dotted_order){const e=r.dotted_order.split(".").map(e=>{const t=e.slice(0,-36),n=e.slice(-36),r=parseInt(t.slice(0,4)),s=parseInt(t.slice(4,6))-1,i=parseInt(t.slice(6,8)),a=parseInt(t.slice(9,11)),o=parseInt(t.slice(11,13)),c=parseInt(t.slice(13,15)),l=parseInt(t.slice(15,21));return[new Date(r,s,i,a,o,c,l/1e3),n]}),t=[];for(let n=0;n<e.length-1;n++){const[r,i]=e[n],a=s(i);t.push(r.toISOString().replace(/[-:]/g,"").replace(".","")+a)}const[n]=e[e.length-1];t.push(n.toISOString().replace(/[-:]/g,"").replace(".","")+i),c=t.join(".")}else c=void 0;return{...r,id:i,trace_id:a,parent_run_id:o,dotted_order:c,session_name:e}}async postRun(e=!0){try{const t=(0,h.Ec)();if(this.replicas&&this.replicas.length>0)for(const{projectName:e,apiKey:n,apiUrl:r,workspaceId:s}of this.replicas){const i=this._remapForProject(e??this.project_name,t,!0);await this.client.createRun(i,{apiKey:n,apiUrl:r,workspaceId:s})}else{const n=this._convertToCreate(this,t,e);await this.client.createRun(n)}if(!e){(0,f.m)("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const e of this.child_runs)await e.postRun(!1)}}catch(e){}}async patchRun(e){if(this.replicas&&this.replicas.length>0)for(const{projectName:t,apiKey:n,apiUrl:r,workspaceId:s,updates:i}of this.replicas){const a=this._remapForProject(t??this.project_name),o={id:a.id,outputs:a.outputs,error:a.error,parent_run_id:a.parent_run_id,session_name:a.session_name,reference_example_id:a.reference_example_id,end_time:a.end_time,dotted_order:a.dotted_order,trace_id:a.trace_id,events:a.events,tags:a.tags,extra:a.extra,attachments:this.attachments,...i};e?.excludeInputs||(o.inputs=a.inputs),await this.client.updateRun(a.id,o,{apiKey:n,apiUrl:r,workspaceId:s})}else try{const t={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e?.excludeInputs||(t.inputs=this.inputs),await this.client.updateRun(this.id,t)}catch(e){}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),"string"==typeof e?this.events.push({name:"event",time:(new Date).toISOString(),message:e}):this.events.push({...e,time:e.time??(new Date).toISOString()})}static fromRunnableConfig(e,t){const n=e?.callbacks;let r,s,i,a=(e=>void 0!==e?e:!!["TRACING_V2","TRACING"].find(e=>"true"===(0,h.Jz)(e)))();if(n){const e=n?.getParentRunId?.()??"",t=n?.handlers?.find(e=>"langchain_tracer"==e?.name);r=t?.getRun?.(e),s=t?.projectName,i=t?.client,a=a||!!t}if(!r)return new b({...t,client:i,tracingEnabled:a,project_name:s});return new b({name:r.name,id:r.id,trace_id:r.trace_id,dotted_order:r.dotted_order,client:i,tracingEnabled:a,project_name:s,tags:[...new Set((r?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...r?.extra?.metadata,...e?.metadata}}}).createChild(t)}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const n="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,r=n["langsmith-trace"];if(!r||"string"!=typeof r)return;const s=r.trim(),i=s.split(".").map(e=>{const[t,n]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:n}}),a=i[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:i.at(-1)?.uuid,trace_id:a,dotted_order:s};if(n.baggage&&"string"==typeof n.baggage){const e=_.fromHeader(n.baggage);o.metadata=e.metadata,o.tags=e.tags,o.project_name=e.project_name,o.replicas=e.replicas}return new b(o)}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new _(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[n,r]of Object.entries(t))e.set(n,r);return t}}function w(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function v(e){return Array.isArray(e)&&e.some(e=>w(e))}Object.defineProperty(b,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null})},1368:(e,t,n)=>{"use strict";function r(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}n.d(t,{Y:()=>r})},1400:e=>{"use strict";var t,n=Object.defineProperty,r=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};((e,t)=>{for(var r in t)n(e,r,{get:t[r],enumerable:!0})})(a,{CITY_HEADER_NAME:()=>o,COUNTRY_HEADER_NAME:()=>c,EMOJI_FLAG_UNICODE_STARTING_POSITION:()=>g,IP_HEADER_NAME:()=>l,LATITUDE_HEADER_NAME:()=>u,LONGITUDE_HEADER_NAME:()=>d,POSTAL_CODE_HEADER_NAME:()=>p,REGION_HEADER_NAME:()=>h,REQUEST_ID_HEADER_NAME:()=>m,geolocation:()=>w,ipAddress:()=>b}),e.exports=(t=a,((e,t,a,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let c of s(t))i.call(e,c)||c===a||n(e,c,{get:()=>t[c],enumerable:!(o=r(t,c))||o.enumerable});return e})(n({},"__esModule",{value:!0}),t));const o="x-vercel-ip-city",c="x-vercel-ip-country",l="x-real-ip",u="x-vercel-ip-latitude",d="x-vercel-ip-longitude",h="x-vercel-ip-country-region",p="x-vercel-ip-postal-code",m="x-vercel-id",g=127397;function f(e,t){return e.get(t)??void 0}function y(e,t){const n=f(e.headers,t);return n?decodeURIComponent(n):void 0}function _(e){const t=new RegExp("^[A-Z]{2}$").test(e);if(e&&t)return String.fromCodePoint(...e.split("").map(e=>g+e.charCodeAt(0)))}function b(e){return f("headers"in e?e.headers:e,l)}function w(e){return{city:y(e,o),country:f(e.headers,c),flag:_(f(e.headers,c)),countryRegion:f(e.headers,h),region:(t=f(e.headers,m),t?t.split(":")[0]:"dev1"),latitude:f(e.headers,u),longitude:f(e.headers,d),postalCode:f(e.headers,p)};var t}},1535:(e,t,n)=>{"use strict";n.d(t,{l:()=>r});const r=(e,t)=>e.reduce((e,n,r)=>{const s=Math.floor(r/t),i=e[s]||[];return e[s]=i.concat([n]),e},[])},1566:(e,t,n)=>{"use strict";n.d(t,{gs:()=>P,Ay:()=>M});var r=n(2080),s=n(454),i=n(211),a=n(823);const o=new Map,c=[],l=[];let u=null;function d(e){return null===u&&(u=e),Math.round(1e3*(e-u))}function h(e){if(a.$W.DEV_MODE)try{const t=performance.now();o.set(e,t),c.push(e),performance.mark(`${e}-start`),l.push({name:e,cat:"profile",ph:"B",ts:d(t),pid:1,tid:1})}catch(e){}}function p(e){if(a.$W.DEV_MODE)try{const t=o.get(e);if(void 0!==t){const t=performance.now();o.delete(e);const n=c.lastIndexOf(e);-1!==n&&c.splice(n,1),performance.mark(`${e}-end`),performance.measure(e,`${e}-start`,`${e}-end`),l.push({name:e,cat:"profile",ph:"E",ts:d(t),pid:1,tid:1}),performance.clearMarks(`${e}-start`),performance.clearMarks(`${e}-end`)}}catch(e){}}async function m(e,t){h(e);try{return await t()}finally{p(e)}}function g(){if(!a.$W.DEV_MODE)return[];try{return performance.getEntriesByType("measure")}catch(e){return[]}}function f(){a.$W.DEV_MODE}function y(){if(!a.$W.DEV_MODE)return{totalTime:0,totalCount:0,avgTime:0,topOperations:[],frequentOperations:[]};const e=g();if(0===e.length)return{totalTime:0,totalCount:0,avgTime:0,topOperations:[],frequentOperations:[]};let t=0;const n={};e.forEach(e=>{t+=e.duration,n[e.name]||(n[e.name]={count:0,totalDuration:0,maxDuration:0}),n[e.name].count++,n[e.name].totalDuration+=e.duration,n[e.name].maxDuration=Math.max(n[e.name].maxDuration,e.duration)});const r=t/e.length,s=Object.entries(n).map(([e,t])=>({name:e,count:t.count,totalDuration:t.totalDuration,avgDuration:t.totalDuration/t.count,maxDuration:t.maxDuration})),i=[...s].sort((e,t)=>t.maxDuration-e.maxDuration).slice(0,5).map(e=>({name:e.name,duration:e.maxDuration,count:e.count,avgDuration:e.avgDuration})),o=[...s].sort((e,t)=>t.count-e.count).slice(0,5).map(e=>({name:e.name,count:e.count,totalDuration:e.totalDuration,avgDuration:e.avgDuration}));return{totalTime:t,totalCount:e.length,avgTime:r,topOperations:i,frequentOperations:o}}function _(){a.$W.DEV_MODE}function b(){if(!a.$W.DEV_MODE)return'{"traceEvents":[]}';const e={traceEvents:[{name:"process_name",ph:"M",ts:0,pid:1,tid:1,cat:"__metadata",args:{name:"Browser Extension"}},{name:"thread_name",ph:"M",ts:0,pid:1,tid:1,cat:"__metadata",args:{name:"Main Thread"}},...l]};return JSON.stringify(e)}function w(){if(!a.$W.DEV_MODE)return"[]";const e=[{name:"process_name",ph:"M",ts:0,pid:1,tid:1,cat:"__metadata",args:{name:"Browser Extension"}},{name:"thread_name",ph:"M",ts:0,pid:1,tid:1,cat:"__metadata",args:{name:"Main Thread"}},...l];return JSON.stringify(e)}function v(){l.length=0,c.length=0,u=null,o.clear()}function E(){return l.length}function S(){a.$W.DEV_MODE&&(v(),h("main"),h("processData"),h("fetchData"),p("fetchData"),h("parseData"),p("parseData"),p("processData"),h("renderResults"),p("renderResults"),p("main"))}a.$W.DEV_MODE&&(globalThis.__profileReport=f,globalThis.__profileMeasures=g,globalThis.__profileStart=h,globalThis.__profileEnd=p,globalThis.__profileSummary=_,globalThis.__profileGetSummary=y,globalThis.__profileExportTrace=b,globalThis.__profileExportTraceLegacy=w,globalThis.__profileClearTrace=v,globalThis.__profileTraceCount=E,globalThis.__profileTestTrace=S,globalThis.profiler={start:h,end:p,report:f,measures:g,summary:_,getSummary:y,exportTrace:b,exportTraceLegacy:w,clearTrace:v,traceCount:E,testTrace:S});class x{constructor(e=!1){this.simplified=e}formatElements(e,t=!1){const n=t;let r=[...e];n&&(r=r.filter(e=>"false"!==e.attributes?.in_viewport)),r.sort((e,t)=>e.nodeId-t.nodeId);const s=[];for(const e of r){const t=this.formatElement(e);t&&s.push(t)}return n&&s.push("--- IMPORTANT: OUT OF VIEWPORT ELEMENTS, SCROLL TO INTERACT ---"),s.join("\n")}formatElement(e){let t=!0;let n=!0,r=!1,s=!0;this.simplified&&(n=!1,s=!1,r=!1,t=!1);const i=[];if(t){const t=parseInt(e.attributes?.depth||"0",10),n=" ".repeat(2*t);i.push(n)}i.push(`[${e.nodeId}]`),i.push(`<${this._getTypeSymbol(e.type)}>`);{const t=e.attributes?.["html-tag"]||e.attributes?.role||"div";i.push(`<${t}>`)}if(e.name){const t=this._truncateText(e.name,40);i.push(`"${t}"`)}else if("typeable"===e.type){const t=e.attributes?.placeholder,n=e.attributes?.id,r=e.attributes?.["input-type"]||"text";t?i.push(`placeholder="${this._truncateText(t,30)}"`):n?i.push(`id="${this._truncateText(n,10)}"`):i.push(`type="${r}"`)}if(n&&e.attributes?.context){const t=this._truncateText(e.attributes.context,60);i.push(`ctx:"${t}"`)}if(r&&e.attributes?.path){const t=this._formatPath(e.attributes.path);t&&i.push(`path:"${t}"`)}if(s){const t=this._formatAttributes(e);t&&i.push(`attr:"${t}"`)}if(!s&&"typeable"===e.type&&e.attributes?.value){const t=this._truncateText(e.attributes.value,40);i.push(`value="${t}"`)}{const t="false"!==e.attributes?.in_viewport;i.push(t?"(visible)":"(hidden)")}return i.join(" ")}_getTypeSymbol(e){switch(e){case"clickable":case"selectable":return"C";case"typeable":return"T";default:return"O"}}_truncateText(e,t){return!e||e.length<=t?e:e.substring(0,t-3)+"..."}_formatPath(e){if(!e)return"";const t=e.split(" > ").filter(e=>e&&"root"!==e).slice(-3);return t.length>0?t.join(">"):""}_formatAttributes(e){if(!e.attributes)return"";const t=["type","placeholder","value","aria-label"],n=[];for(const r of t)if(r in e.attributes){const t=e.attributes[r];null!=t&&""!==t&&n.push(`${r}=${t}`)}return n.join(" ")}}const k=new x(!1),T=new x(!0),I=new Set(["staticText","heading","paragraph","link","button","textField","checkBox","comboBoxSelect","labelText","menuListOption","toggleButton","status","alert","image","rootWebArea","navigation","main"]);r.Ik({nodeId:r.ai(),text:r.Yj(),tag:r.Yj()});const O=class{constructor(e,t,n){this._browserOS=(0,i.uo)(),this._snapshotCache=null,this._nodeIdToNodeMap=new Map,this._snapshotCacheTimestamp=0,this._snapshotCacheTTL=100,this._tabId=e,this._url=t,this._title=n,s.y7.log("BrowserPage",`Page created for tab ${this._tabId}`)}get tabId(){return this._tabId}url(){return this._url}async title(){try{const e=await chrome.tabs.get(this._tabId);return this._title=e.title||"",this._title}catch{return this._title}}_invalidateCache(){this._snapshotCache=null,this._snapshotCacheTimestamp=0,this._nodeIdToNodeMap.clear(),s.y7.log("BrowserPage",`Snapshot cache invalidated for tab ${this._tabId}`,"info")}_isCacheValid(){return null!==this._snapshotCache&&this._snapshotCacheTimestamp>0&&Date.now()-this._snapshotCacheTimestamp<this._snapshotCacheTTL}async _getSnapshot(){return m("BrowserPage._getSnapshot",async()=>{if(this._isCacheValid())return s.y7.log("BrowserPage",`Using cached snapshot for tab ${this._tabId}`,"info"),this._snapshotCache;try{s.y7.log("BrowserPage",`Fetching fresh snapshot for tab ${this._tabId}`,"info");const e=await this._browserOS.getInteractiveSnapshot(this._tabId);this._snapshotCache=e,this._snapshotCacheTimestamp=Date.now(),this._nodeIdToNodeMap.clear();for(const t of e.elements)"clickable"!==t.type&&"typeable"!==t.type&&"selectable"!==t.type||this._nodeIdToNodeMap.set(t.nodeId,t);return e}catch(e){return s.y7.log("BrowserPage",`Failed to get snapshot: ${e}`,"error"),this._invalidateCache(),null}})}async getClickableElementsString(e=!1,t=!1){const n=await this._getSnapshot();if(!n)return"";const r=e?T:k,s=n.elements.filter(e=>"clickable"===e.type||"selectable"===e.type);return r.formatElements(s,t)}async getTypeableElementsString(e=!1,t=!1){const n=await this._getSnapshot();if(!n)return"";const r=e?T:k,s=n.elements.filter(e=>"typeable"===e.type);return r.formatElements(s,t)}async getClickableElements(){const e=await this._getSnapshot();if(!e)return[];const t=[];for(const n of e.elements)"clickable"!==n.type&&"selectable"!==n.type||t.push({nodeId:n.nodeId,text:n.name||"",tag:n.attributes?.["html-tag"]||n.attributes?.role||""});return t}async getTypeableElements(){const e=await this._getSnapshot();if(!e)return[];const t=[];for(const n of e.elements)"typeable"===n.type&&t.push({nodeId:n.nodeId,text:n.name||"",tag:n.attributes?.["html-tag"]||n.attributes?.role||""});return t}async getElementByIndex(e){return this._snapshotCache||await this._getSnapshot(),this._nodeIdToNodeMap.get(e)||null}async getInteractiveElements(){return await this._getSnapshot(),new Map(this._nodeIdToNodeMap)}async getHierarchicalStructure(){const e=await this._getSnapshot();return e?.hierarchicalStructure||null}async getHierarchicalText(){const e=await this._browserOS.getAccessibilityTree(this._tabId);return this._extractHierarchicalText(e)}_extractHierarchicalText(e){if(!e||!e.nodes||!e.rootId)return s.y7.log("BrowserPage","Invalid accessibility tree structure","warning"),"";const t=[],n=[];for(n.push({nodeId:e.rootId,depth:0});n.length>0;){const{nodeId:r,depth:s}=n.pop(),i=e.nodes[String(r)];if(i){if(I.has(i.role)&&i.name){const e="\t".repeat(s);t.push(`${e}${i.name}`)}if(i.childIds&&Array.isArray(i.childIds))for(let e=i.childIds.length-1;e>=0;e--)n.push({nodeId:i.childIds[e],depth:s+1})}}const r=t.join("\n");return s.y7.log("BrowserPage",`Extracted hierarchical text: ${t.length} lines`,"info"),r}async _showPointerForElement(e,t){try{const n=await this.getElementByIndex(e);if(!n||!n.rect)return;const r=n.rect;let s,i;switch(t.toLowerCase()){case"click":default:s=r.x+r.width/2,i=r.y+r.height/2;break;case"type":case"input":s=r.x+10,i=r.y+r.height/2;break;case"clear":s=r.x+r.width-10,i=r.y+r.height/2}await this.showPointer(s,i,t)}catch(t){s.y7.log("BrowserPage",`Failed to show pointer for element ${e}: ${t}`,"warning")}}async clickElement(e){await m(`BrowserPage.clickElement[${e}]`,async()=>{await this._showPointerForElement(e,"Click"),await this._browserOS.click(this._tabId,e),await this.waitForStability(),this._invalidateCache()})}async inputText(e,t){await m(`BrowserPage.inputText[${e}]`,async()=>{const n=t.length>20?`${t.substring(0,20)}...`:t;await this._showPointerForElement(e,`Type: ${n}`),await this._browserOS.clear(this._tabId,e),await this._browserOS.inputText(this._tabId,e,t),await this.waitForStability(),this._invalidateCache()})}async clearElement(e){await this._showPointerForElement(e,"Clear"),await this._browserOS.clear(this._tabId,e),await this.waitForStability(),this._invalidateCache()}async scrollToElement(e){return await this._browserOS.scrollToNode(this._tabId,e)}async ensureElementInViewport(e){const t=await this.getElementByIndex(e);if(!t)return{element:null,scrollMessage:""};let n="";if("false"===t.attributes?.in_viewport){const r=await this.scrollToElement(e);if(await new Promise(e=>setTimeout(e,500)),this._invalidateCache(),await this._getSnapshot(),n=r?" (auto-scrolled to element)":" (attempted scroll)",r&&t.rect){const e=t.rect.x+t.rect.width/2,n=t.rect.y+t.rect.height/2;await this.showPointer(e,n,"Scrolled to element")}}return{element:t,scrollMessage:n}}async sendKeys(e){const t=["Enter","Delete","Backspace","Tab","Escape","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown"];if(!t.includes(e))throw new Error(`Unsupported key: "${e}". Supported keys are: ${t.join(", ")}`);await this._browserOS.sendKeys(this._tabId,e),await this.waitForStability();["Enter","Delete","Backspace","Tab"].includes(e)&&this._invalidateCache()}async scrollDown(e){const t=e||1,n=await this.executeJavaScript("window.scrollY");for(let e=0;e<t;e++)await this._browserOS.sendKeys(this._tabId,"PageDown"),e<t-1&&await new Promise(e=>setTimeout(e,50));await new Promise(e=>setTimeout(e,100));return{didScroll:await this.executeJavaScript("window.scrollY")>n}}async scrollUp(e){const t=e||1,n=await this.executeJavaScript("window.scrollY");for(let e=0;e<t;e++)await this._browserOS.sendKeys(this._tabId,"PageUp"),e<t-1&&await new Promise(e=>setTimeout(e,50));await new Promise(e=>setTimeout(e,100));return{didScroll:await this.executeJavaScript("window.scrollY")<n}}async navigateTo(e){await m("BrowserPage.navigateTo",async()=>{await chrome.tabs.update(this._tabId,{url:e}),await this.waitForStability(),this._invalidateCache(),this._url=e})}async refreshPage(){await chrome.tabs.reload(this._tabId),await this.waitForStability(),this._invalidateCache()}async goBack(){await chrome.tabs.goBack(this._tabId),await this.waitForStability(),this._invalidateCache()}async goForward(){await chrome.tabs.goForward(this._tabId),await this.waitForStability(),this._invalidateCache()}invalidateCache(){this._invalidateCache()}async waitForStability(){await new Promise(e=>setTimeout(e,500)),await m("BrowserPage.waitForStability",async()=>{const e=3e4,t=Date.now();for(;Date.now()-t<e;){try{const e=await this._browserOS.getPageLoadStatus(this._tabId);if(e.isDOMContentLoaded){s.y7.log("BrowserPage",`Page fully loaded for tab ${this._tabId} (DOM loaded, resources finished)`,"info");break}(Date.now()-t)%5e3<100&&s.y7.log("BrowserPage",`Waiting for stability - DOM: ${e.isDOMContentLoaded}, Resources loading: ${e.isResourcesLoading}`,"info")}catch(e){s.y7.log("BrowserPage",`Error checking page load status: ${e}`,"warning");break}await new Promise(e=>setTimeout(e,100))}Date.now()-t>=e&&s.y7.log("BrowserPage",`waitForStability timeout after 30000ms for tab ${this._tabId}`,"warning")})}async takeScreenshot(e,t){try{return await this._browserOS.captureScreenshot(this._tabId,e,t)}catch(e){return s.y7.log("BrowserPage",`Failed to take screenshot: ${e}`,"error"),null}}async takeScreenshotWithDimensions(e,t,n){try{return await this._browserOS.captureScreenshot(this._tabId,void 0,n,e,t)}catch(e){return s.y7.log("BrowserPage",`Failed to take screenshot with dimensions: ${e}`,"error"),null}}async executeJavaScript(e){try{return await this._browserOS.executeJavaScript(this._tabId,e)}catch(e){throw s.y7.log("BrowserPage",`Failed to execute JavaScript: ${e}`,"error"),e}}async clickAtCoordinates(e,t){await m(`BrowserPage.clickAtCoordinates[${e},${t}]`,async()=>{await this.showPointer(e,t,"Click"),await this._browserOS.clickCoordinates(this._tabId,e,t),await this.waitForStability(),this._invalidateCache()})}async typeAtCoordinates(e,t,n){await m(`BrowserPage.typeAtCoordinates[${e},${t}]`,async()=>{await this.showPointer(e,t,`Type: ${n.substring(0,20)}`),await this._browserOS.typeAtCoordinates(this._tabId,e,t,n),await this.waitForStability(),this._invalidateCache()})}async showPointer(e,t,n){const r=`nxtscape-pointer-${Date.now()}`;await this.executeJavaScript(`\n      (function() {\n        // Remove any existing pointer\n        const existing = document.querySelector('.nxtscape-pointer');\n        if (existing) existing.remove();\n        \n        // Create pointer container\n        const pointer = document.createElement('div');\n        pointer.className = 'nxtscape-pointer';\n        pointer.id = '${r}';\n        \n        // Style the pointer container\n        pointer.style.cssText = \`\n          position: fixed;\n          left: \${${e}}px;\n          top: \${${t}}px;\n          z-index: 2147483647;\n          pointer-events: none;\n        \`;\n        \n        // Create large CSS arrow cursor\n        const arrow = document.createElement('div');\n        arrow.style.cssText = \`\n          position: absolute;\n          width: 0;\n          height: 0;\n          border-style: solid;\n          border-width: 0 12px 20px 12px;\n          border-color: transparent transparent #FB6618 transparent;\n          transform: translate(-3px, -3px) rotate(45deg);\n          filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.4));\n        \`;\n        pointer.appendChild(arrow);\n        \n        // Add optional text label\n        ${n?`\n        const label = document.createElement('div');\n        label.textContent = '${n.replace(/'/g,"\\'")}';\n        label.style.cssText = \`\n          position: absolute;\n          top: 20px;\n          left: 12px;\n          background: rgba(0,0,0,0.9);\n          color: white;\n          padding: 4px 8px;\n          border-radius: 4px;\n          font-size: 12px;\n          white-space: nowrap;\n          font-family: monospace;\n          box-shadow: 0 2px 4px rgba(0,0,0,0.5);\n        \`;\n        pointer.appendChild(label);\n        `:""}\n        \n        document.body.appendChild(pointer);\n        \n        // Auto-remove after 3 seconds\n        setTimeout(() => {\n          const el = document.getElementById('${r}');\n          if (el) el.remove();\n        }, 3000);\n      })();\n    `)}async close(){try{await chrome.tabs.remove(this._tabId)}catch(e){s.y7.log("BrowserPage",`Error closing tab: ${e}`,"error")}}async getTextSnapshot(e){return await this._browserOS.getTextSnapshot(this._tabId,e)}async getLinksSnapshot(e){return await this._browserOS.getLinksSnapshot(this._tabId,e)}async getTextSnapshotString(e){const t=await this._browserOS.getSnapshot(this._tabId,"text",e);return this._formatSnapshot(t,!1)}async getTextWithLinksString(e){const t=await this._browserOS.getSnapshot(this._tabId,"links",e);return this._formatSnapshot(t,!0)}async getLinksSnapshotString(e){const t=await this._browserOS.getLinksSnapshot(this._tabId,e);if(this._isNewSnapshot(t))return this._formatSnapshot(t,!0);const n=[];for(const e of t.sections)if(e.linksResult?.links)for(const t of e.linksResult.links){const e=t.text?`${t.text}: ${t.url}`:t.url;n.push(e)}return[...new Set(n)].join("\n").trim()}_isNewSnapshot(e){return"items"in e&&Array.isArray(e.items)}_formatSnapshot(e,t){return this._isNewSnapshot(e)?this._formatNewSnapshot(e,t):this._formatOldSnapshot(e,t)}_formatNewSnapshot(e,t){if(!e.items||0===e.items.length)return"";let n="";for(const r of e.items)if("heading"===r.type){n+=`${"#".repeat(r.level||1)} ${r.text}\n`}else"text"===r.type?n+=`${r.text}\n`:"link"===r.type&&t&&(n+=`[${r.text}](${r.url})\n`);return n.trim()}_formatOldSnapshot(e,t){const n=[];for(const r of e.sections)if(r.textResult?.text&&n.push(r.textResult.text),t&&r.linksResult?.links)for(const e of r.linksResult.links){const t=e.text?`[${e.text}](${e.url})`:e.url;n.push(t)}return n.join("\n\n").trim()}isFileUploader(e){return"input"===e.tagName&&"file"===e.attributes?.type}async getDropdownOptions(e){throw new Error("Not implemented")}async selectDropdownOption(e,t){throw new Error("Not implemented")}async getPageDetails(){try{const e=await chrome.tabs.get(this._tabId);this._url=e.url||this._url,this._title=e.title||this._title}catch(e){s.y7.log("BrowserPage",`Error getting tab details: ${e}`,"warning")}return{url:this._url,title:this._title,tabId:this._tabId}}},C=(r.Ik({width:r.ai().int().positive(),height:r.ai().int().positive()}),r.Ik({maximumWaitPageLoadTime:r.ai().default(5),waitBetweenActions:r.ai().default(.1),homePageUrl:r.Yj().default("https://www.google.com")}).parse({})),A=r.Ik({id:r.ai().int().positive(),url:r.Yj(),title:r.Yj()});r.Ik({tabId:r.ai(),url:r.Yj(),title:r.Yj(),tabs:r.YO(A),clickableElements:r.YO(r.Ik({nodeId:r.ai(),text:r.Yj(),tag:r.Yj()})),typeableElements:r.YO(r.Ik({nodeId:r.ai(),text:r.Yj(),tag:r.Yj()})),clickableElementsString:r.Yj(),typeableElementsString:r.Yj(),hierarchicalStructure:r.Yj().nullable().optional()});Error;class P{constructor(e={}){this._userSelectedTabIds=null,this._executionLockedTabId=null,this._pageCache=new Map,this._config={...C,...e}}getConfig(){return this._config}updateConfig(e){this._config={...this._config,...e}}async _getOrCreatePage(e){if(!e.id)throw new Error("Tab ID is not available");const t=this._pageCache.get(e.id);if(t)return t;const n=new O(e.id,e.url||"Unknown URL",e.title||"Unknown Title");return this._pageCache.set(e.id,n),s.y7.log("BrowserContextV2",`Created page for tab ${e.id}`),n}async getCurrentPage(){return m("BrowserContext.getCurrentPage",async()=>{const e=await this.getTargetTab();if(!e.id)throw new Error("Target tab has no ID");const t=await this._getOrCreatePage(e);return this._executionLockedTabId||this.lockExecutionToTab(e.id),t})}async switchTab(e){return m(`BrowserContext.switchTab[${e}]`,async()=>{s.y7.log("BrowserContextV2",`Switching to tab ${e}`),await chrome.tabs.update(e,{active:!0});const t=await chrome.tabs.get(e),n=await this._getOrCreatePage(t);return this._executionLockedTabId=e,n})}async getTabs(){const e=await chrome.tabs.query({}),t=[];for(const n of e)n.id&&n.url&&n.title&&t.push({id:n.id,url:n.url,title:n.title});return t}async navigateTo(e){const t=await this.getCurrentPage();await t.navigateTo(e)}async openTab(e){return m("BrowserContext.openTab",async()=>{const t=await chrome.tabs.create({url:e,active:!0});if(!t.id)throw new Error("No tab ID available");await new Promise(e=>setTimeout(e,100));const n=await chrome.tabs.get(t.id),r=await this._getOrCreatePage(n);return this._executionLockedTabId=t.id,r})}async closeTab(e){this._pageCache.delete(e),await chrome.tabs.remove(e),this._executionLockedTabId===e&&(this._executionLockedTabId=null),this._userSelectedTabIds&&this._userSelectedTabIds.includes(e)&&(this._userSelectedTabIds=this._userSelectedTabIds.filter(t=>t!==e))}async getBrowserStateString(e=!1,t=!1){return m("BrowserContext.getBrowserStateString",async()=>{try{const n=await this.getBrowserState(e,t),r=`{id: ${n.tabId}, url: ${n.url}, title: ${n.title}}`;if(e){const e=[];n.clickableElementsString&&e.push("Clickable:\n"+n.clickableElementsString),n.typeableElementsString&&e.push("Inputs:\n"+n.typeableElementsString);return`BROWSER STATE:\nCurrent tab: ${r}\n\nElements:\n${e.join("\n\n")||"No interactive elements found"}`}{const e=n.tabs.filter(e=>e.id!==n.tabId).map(e=>`- {id: ${e.id}, url: ${e.url}, title: ${e.title}}`),t=(new Date).toISOString().slice(0,16).replace("T"," ");let s="";const i=[];n.clickableElementsString&&i.push("Clickable elements:\n"+n.clickableElementsString),n.typeableElementsString&&i.push("Input fields:\n"+n.typeableElementsString),s=i.join("\n\n")||"No interactive elements found";return`\nBROWSER STATE:\nCurrent tab: ${r}\nOther available tabs:\n  ${e.join("\n  ")}\nCurrent date and time: ${t}\n\nInteractive elements from the current page (numbers in [brackets] are nodeIds):\n${s}\n`}}catch(e){s.y7.log("BrowserContextV2",`Failed to get detailed browser state: ${e}`,"warning");const t=await this.getCurrentPage();return`BROWSER STATE:\nCurrent page: ${await t.url()} - ${await t.title()}`}})}async getPages(e){try{if(!e||0===e.length){return[await this.getCurrentPage()]}const t=[];for(const n of e)try{const e=await chrome.tabs.get(n),r=await this._getOrCreatePage(e);t.push(r)}catch(e){s.y7.log("BrowserContextV2",`Failed to get page for tab ${n}: ${e}`,"warning")}if(0===t.length)throw new Error(`Failed to get any of the selected tabs (${e.join(", ")})`);return t}catch(e){return s.y7.log("BrowserContextV2",`Error getting pages: ${e}`,"error"),[]}}async getAllTabIds(){try{const e=await chrome.tabs.query({currentWindow:!0});return new Set(e.map(e=>e.id).filter(e=>void 0!==e))}catch(e){return s.y7.log("BrowserContextV2",`Failed to get tab IDs: ${e}`,"warning"),new Set}}async _getActiveTab(){let e;if([e]=await chrome.tabs.query({active:!0,currentWindow:!0}),!e?.id){const t=await chrome.windows.getAll({populate:!1}),n=t.find(e=>e.focused)||t.find(e=>"normal"===e.state);n&&([e]=await chrome.tabs.query({active:!0,windowId:n.id}))}if(!e?.id){e=(await chrome.tabs.query({currentWindow:!0}))[0]}if(!e?.id){e=(await chrome.tabs.query({}))[0]}if(e?.id||(s.y7.log("BrowserContextV2","No existing tabs found, creating a new tab"),e=await chrome.tabs.create({url:this._config.homePageUrl,active:!0})),!e?.id)throw new Error("Unable to find or create a tab");return e}async getTargetTab(){if(this._executionLockedTabId)try{const e=await chrome.tabs.get(this._executionLockedTabId);if(e)return e}catch(e){s.y7.log("BrowserContextV2",`Execution-locked tab ${this._executionLockedTabId} no longer exists`,"warning"),this._executionLockedTabId=null}return this._getActiveTab()}lockExecutionToTab(e){this._executionLockedTabId=e,s.y7.log("BrowserContextV2",`Execution locked to tab ${e}`)}async unlockExecution(){const e=this._executionLockedTabId;this._executionLockedTabId=null,s.y7.log("BrowserContextV2","Execution unlocked"+(e?` (was locked to tab ${e})`:""))}async getCurrentWindow(){try{const e=await this.getTargetTab();if(e&&e.windowId){const t=await chrome.windows.get(e.windowId);if(t)return t}}catch(e){s.y7.log("BrowserContextV2",`Failed to get window from target tab: ${e}`,"warning")}try{const e=await chrome.windows.getCurrent();if(e)return e}catch(e){s.y7.log("BrowserContextV2",`Failed to get current window: ${e}`,"error")}throw new Error("No window found")}async getBrowserState(e=!1,t=!1){return m("BrowserContext.getBrowserState",async()=>{try{const n=await this.getCurrentPage(),r=await this.getTabs(),s=await n.url(),i=await n.title(),a=n.tabId,o=await n.getClickableElementsString(e,t),c=await n.getTypeableElementsString(e,t),l=await n.getClickableElements(),u=await n.getTypeableElements(),d=e?null:await n.getHierarchicalStructure();return{tabId:a,url:s,title:i,tabs:r,clickableElements:l,typeableElements:u,clickableElementsString:o,typeableElementsString:c,hierarchicalStructure:d}}catch(e){s.y7.log("BrowserContextV2",`Failed to get state: ${e}`,"warning");return{tabId:0,url:"about:blank",title:"New Tab",tabs:[],clickableElements:[],typeableElements:[],clickableElementsString:"",typeableElementsString:"",hierarchicalStructure:null}}})}async cleanup(){try{s.y7.log("BrowserContextV2","Cleaning up browser context"),this._pageCache.clear(),this._executionLockedTabId=null,this._userSelectedTabIds=null,s.y7.log("BrowserContextV2","Browser context cleaned up successfully")}catch(e){s.y7.log("BrowserContextV2",`Error during cleanup: ${e}`,"error")}}}const M=P},1590:(e,t,n)=>{"use strict";n.d(t,{J:()=>l,j:()=>c});var r=n(1688),s=n(5960),i=n(9583);function a(e,t){if(e)return new r.gk({...e,start_time:e._serialized_start_time??e.start_time,parent_run:a(t),child_runs:e.child_runs.map(e=>a(e)).filter(e=>void 0!==e),extra:{...e.extra,runtime:(0,i.VS)()},tracingEnabled:!1})}function o(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function c(e){return"function"==typeof e._addRunToRunMap}class l extends s.NK{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"runTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!1})}copy(){return this}getRunById(e){if(void 0!==e)return this.usesRunTreeMap?(e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e})(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const{dottedOrder:t,microsecondPrecisionDatestring:n}=(0,r.sh)(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},i=this.getRunById(s.parent_run_id);if(void 0!==s.parent_run_id?i&&(this._addChildRun(i,s),i.child_execution_order=Math.max(i.child_execution_order,s.child_execution_order),s.trace_id=i.trace_id,void 0!==i.dotted_order&&(s.dotted_order=[i.dotted_order,t].join("."),s._serialized_start_time=n)):(s.trace_id=s.id,s.dotted_order=t,s._serialized_start_time=n),this.usesRunTreeMap){const e=a(s,i);void 0!==e&&this.runTreeMap.set(s.id,e)}else this.runMap.set(s.id,s);return s}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await(this.onRunUpdate?.(e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=void 0!==e&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,n,r,s,i,a,o){const c=this._getExecutionOrder(r),l=Date.now(),u=a?{...s,metadata:a}:s,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:i||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,n,r,s,i,a,o){const c=this.getRunById(n)??this._createRunForLLMStart(e,t,n,r,s,i,a,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}_createRunForChatModelStart(e,t,n,r,s,i,a,o){const c=this._getExecutionOrder(r),l=Date.now(),u=a?{...s,metadata:a}:s,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:i||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,n,r,s,i,a,o){const c=this.getRunById(n)??this._createRunForChatModelStart(e,t,n,r,s,i,a,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}async handleLLMEnd(e,t,n,r,s){const i=this.getRunById(t);if(!i||"llm"!==i?.run_type)throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...s},await(this.onLLMEnd?.(i)),await this._endTrace(i),i}async handleLLMError(e,t,n,r,s){const i=this.getRunById(t);if(!i||"llm"!==i?.run_type)throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...s},await(this.onLLMError?.(i)),await this._endTrace(i),i}_createRunForChainStart(e,t,n,r,s,i,a,o){const c=this._getExecutionOrder(r),l=Date.now(),u={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:a??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(u)}async handleChainStart(e,t,n,r,s,i,a,o){const c=this.getRunById(n)??this._createRunForChainStart(e,t,n,r,s,i,a,o);return await(this.onRunCreate?.(c)),await(this.onChainStart?.(c)),c}async handleChainEnd(e,t,n,r,s){const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=o(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),void 0!==s?.inputs&&(i.inputs=o(s.inputs,"input")),await(this.onChainEnd?.(i)),await this._endTrace(i),i}async handleChainError(e,t,n,r,s){const i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),void 0!==s?.inputs&&(i.inputs=o(s.inputs,"input")),await(this.onChainError?.(i)),await this._endTrace(i),i}_createRunForToolStart(e,t,n,r,s,i,a){const o=this._getExecutionOrder(r),c=Date.now(),l={id:n,name:a??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,n,r,s,i,a){const o=this.getRunById(n)??this._createRunForToolStart(e,t,n,r,s,i,a);return await(this.onRunCreate?.(o)),await(this.onToolStart?.(o)),o}async handleToolEnd(e,t){const n=this.getRunById(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onToolEnd?.(n)),await this._endTrace(n),n}async handleToolError(e,t){const n=this.getRunById(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onToolError?.(n)),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.getRunById(t);if(!n||"chain"!==n?.run_type)return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(n))}async handleAgentEnd(e,t){const n=this.getRunById(t);n&&"chain"===n?.run_type&&(n.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(n)))}_createRunForRetrieverStart(e,t,n,r,s,i,a){const o=this._getExecutionOrder(r),c=Date.now(),l={id:n,name:a??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,n,r,s,i,a){const o=this.getRunById(n)??this._createRunForRetrieverStart(e,t,n,r,s,i,a);return await(this.onRunCreate?.(o)),await(this.onRetrieverStart?.(o)),o}async handleRetrieverEnd(e,t){const n=this.getRunById(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverEnd?.(n)),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.getRunById(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverError?.(n)),await this._endTrace(n),n}async handleText(e,t){const n=this.getRunById(t);n&&"chain"===n?.run_type&&(n.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(n)))}async handleLLMNewToken(e,t,n,r,s,i){const a=this.getRunById(n);if(!a||"llm"!==a?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return a.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(a,e,{chunk:i?.chunk})),a}}},1611:(e,t,n)=>{"use strict";n.d(t,{Go:()=>r});var r,s=n(2080);!function(e){e.LOG="LOG",e.WORKFLOW_STATUS="WORKFLOW_STATUS",e.EXECUTE_QUERY="EXECUTE_QUERY",e.HEARTBEAT="HEARTBEAT",e.HEARTBEAT_ACK="HEARTBEAT_ACK",e.AGENT_STREAM_UPDATE="AGENT_STREAM_UPDATE",e.CANCEL_TASK="CANCEL_TASK",e.CLOSE_PANEL="CLOSE_PANEL",e.RESET_CONVERSATION="RESET_CONVERSATION",e.GET_LLM_PROVIDERS="GET_LLM_PROVIDERS",e.SAVE_LLM_PROVIDERS="SAVE_LLM_PROVIDERS",e.GLOW_START="GLOW_START",e.GLOW_STOP="GLOW_STOP",e.MCP_INSTALL_SERVER="MCP_INSTALL_SERVER",e.MCP_SERVER_STATUS="MCP_SERVER_STATUS",e.MCP_GET_INSTALLED_SERVERS="MCP_GET_INSTALLED_SERVERS",e.MCP_DELETE_SERVER="MCP_DELETE_SERVER",e.HUMAN_INPUT_RESPONSE="HUMAN_INPUT_RESPONSE",e.PLAN_EDIT_RESPONSE="PLAN_EDIT_RESPONSE",e.GENERATE_PLAN="GENERATE_PLAN",e.REFINE_PLAN="REFINE_PLAN",e.PLAN_GENERATION_UPDATE="PLAN_GENERATION_UPDATE",e.GET_MCP_SERVERS="GET_MCP_SERVERS",e.CONNECT_MCP_SERVER="CONNECT_MCP_SERVER",e.DISCONNECT_MCP_SERVER="DISCONNECT_MCP_SERVER",e.CALL_MCP_TOOL="CALL_MCP_TOOL",e.LOG_MESSAGE="LOG_MESSAGE",e.LOG_METRIC="LOG_METRIC",e.EXECUTE_IN_SIDEPANEL="EXECUTE_IN_SIDEPANEL",e.EXECUTION_STARTING="EXECUTION_STARTING",e.EXTRACT_PAGE_CONTENT="EXTRACT_PAGE_CONTENT",e.SETTINGS_GET_PREF="SETTINGS_GET_PREF",e.SETTINGS_GET_PREF_RESPONSE="SETTINGS_GET_PREF_RESPONSE",e.SETTINGS_SET_PREF="SETTINGS_SET_PREF",e.SETTINGS_SET_PREF_RESPONSE="SETTINGS_SET_PREF_RESPONSE",e.SETTINGS_GET_ALL_PREFS="SETTINGS_GET_ALL_PREFS",e.SETTINGS_GET_ALL_PREFS_RESPONSE="SETTINGS_GET_ALL_PREFS_RESPONSE",e.SETTINGS_TEST_PROVIDER="SETTINGS_TEST_PROVIDER",e.SETTINGS_TEST_PROVIDER_RESPONSE="SETTINGS_TEST_PROVIDER_RESPONSE",e.SETTINGS_TEST_MCP="SETTINGS_TEST_MCP",e.SETTINGS_TEST_MCP_RESPONSE="SETTINGS_TEST_MCP_RESPONSE",e.TEACH_MODE_START="TEACH_MODE_START",e.TEACH_MODE_STOP="TEACH_MODE_STOP",e.TEACH_MODE_STATUS="TEACH_MODE_STATUS",e.TEACH_MODE_LIST="TEACH_MODE_LIST",e.TEACH_MODE_GET="TEACH_MODE_GET",e.TEACH_MODE_DELETE="TEACH_MODE_DELETE",e.TEACH_MODE_CLEAR="TEACH_MODE_CLEAR",e.TEACH_MODE_EXPORT="TEACH_MODE_EXPORT",e.TEACH_MODE_IMPORT="TEACH_MODE_IMPORT",e.TEACH_MODE_STATS="TEACH_MODE_STATS",e.TEACH_MODE_SEARCH="TEACH_MODE_SEARCH",e.TEACH_MODE_GET_WORKFLOW="TEACH_MODE_GET_WORKFLOW",e.TEACH_MODE_UPDATE_WORKFLOW="TEACH_MODE_UPDATE_WORKFLOW",e.EXECUTE_TEACH_MODE_WORKFLOW="EXECUTE_TEACH_MODE_WORKFLOW",e.ERROR="ERROR"}(r||(r={}));const i=s.fc(r),a=s.Ik({type:i,payload:s.L5()}),o=a.extend({type:s.eu(r.LOG),payload:s.Ik({source:s.Yj(),message:s.Yj(),level:s.k5(["info","error","warning"]),timestamp:s.Yj()})}),c=a.extend({type:s.eu(r.WORKFLOW_STATUS),payload:s.Ik({workflowId:s.Yj(),steps:s.YO(s.Ik({id:s.Yj(),status:s.Yj(),message:s.Yj().optional(),error:s.Yj().optional()})),output:s.L5().optional()})}),l=s.Ik({source:s.k5(["newtab","sidepanel","popup"]).optional(),executionMode:s.k5(["dynamic","predefined"]).default("dynamic"),predefinedPlan:s.Ik({agentId:s.Yj(),steps:s.YO(s.Yj()),goal:s.Yj(),name:s.Yj().optional()}).optional(),workflow:s.bz().optional()}),u=a.extend({type:s.eu(r.EXECUTE_QUERY),payload:s.Ik({query:s.Yj(),tabIds:s.YO(s.ai()).optional(),chatMode:s.zM().optional(),metadata:l.optional()})}),d=a.extend({type:s.eu(r.HEARTBEAT),payload:s.Ik({timestamp:s.ai()})}),h=a.extend({type:s.eu(r.HEARTBEAT_ACK),payload:s.Ik({timestamp:s.ai()})}),p=a.extend({type:s.eu(r.AGENT_STREAM_UPDATE),payload:s.Ik({step:s.ai(),action:s.Yj(),status:s.k5(["thinking","executing","completed","error","debug"]),details:s.Ik({content:s.Yj().optional(),toolName:s.Yj().optional(),toolArgs:s.bz().optional(),toolResult:s.Yj().optional(),error:s.Yj().optional(),messageType:s.Yj().optional(),messageId:s.Yj().optional(),segmentId:s.ai().optional(),data:s.bz().optional(),timestamp:s.Yj().optional()})})}),m=a.extend({type:s.eu(r.CANCEL_TASK),payload:s.Ik({reason:s.Yj().optional(),source:s.Yj().optional()})}),g=a.extend({type:s.eu(r.CLOSE_PANEL),payload:s.Ik({reason:s.Yj().optional()})}),f=a.extend({type:s.eu(r.RESET_CONVERSATION),payload:s.Ik({source:s.Yj().optional()})}),y=a.extend({type:s.eu(r.GLOW_START),payload:s.Ik({tabId:s.ai()})}),_=a.extend({type:s.eu(r.GLOW_STOP),payload:s.Ik({tabId:s.ai()})}),b=a.extend({type:s.eu(r.GENERATE_PLAN),payload:s.Ik({input:s.Yj(),context:s.Yj().optional(),maxSteps:s.ai().int().positive().optional()})}),w=a.extend({type:s.eu(r.REFINE_PLAN),payload:s.Ik({currentPlan:s.Ik({goal:s.Yj().optional(),steps:s.YO(s.Yj()).default([])}),feedback:s.Yj(),maxSteps:s.ai().int().positive().optional()})}),v=a.extend({type:s.eu(r.PLAN_GENERATION_UPDATE),payload:s.Ik({status:s.k5(["queued","started","thinking","done","error"]),content:s.Yj().optional(),plan:s.Ik({goal:s.Yj().optional(),name:s.Yj().optional(),steps:s.YO(s.Yj())}).optional(),structured:s.Ik({steps:s.YO(s.Ik({action:s.Yj(),reasoning:s.Yj()})),goal:s.Yj().optional(),name:s.Yj().optional()}).optional(),error:s.Yj().optional()})});s.gM("type",[o,c,u,d,h,p,m,g,f,y,_,b,w,v])},1673:(e,t,n)=>{"use strict";n.d(t,{Od:()=>r.Od,H:()=>r.H,cM:()=>i.cM,XU:()=>i.XU,FK:()=>a.FK,xc:()=>o.xc,a7:()=>o.a7,tn:()=>c.tn,uU:()=>c.uU,uf:()=>d.uf,dr:()=>d.dr,K0:()=>l.K0,Vi:()=>h.Vi,up:()=>h.up,Sw:()=>l.Sw,KX:()=>r.KX,jm:()=>r.jm,cJ:()=>h.cJ,ny:()=>s.ny,Fz:()=>h.Fz,wk:()=>d.wk,W:()=>h.W,Q7:()=>h.Q7,Ej:()=>h.Ej});var r=n(7765),s=n(3490),i=n(4301),a=n(8675),o=n(5454),c=n(7974),l=n(6362);n(3292);class u extends s.XQ{constructor(e){super({...e,content:""}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.id=e.id}_getType(){return"remove"}get _printableFields(){return{...super._printableFields,id:this.id}}}var d=n(8009);o.xc,o.a7,r.Od,r.H,c.tn,c.uU,c.tn,c.uU,d.uf,d.dr,a.mg,a.FK,i.cM,i.XU;var h=n(4291)},1688:(e,t,n)=>{"use strict";n.d(t,{gk:()=>r.gk,sh:()=>r.sh});var r=n(1356)},1729:(e,t,n)=>{"use strict";const r=n(144);e.exports=(e,t)=>{const n=r(e,t);return n&&n.prerelease.length?n.prerelease:null}},1763:(e,t,n)=>{"use strict";const r=n(560);e.exports=(e,t)=>r(e,t,!0)},1830:(e,t,n)=>{"use strict";n.d(t,{xV:()=>m});var r=n(1673),s=n(8028),i=n(528),a=n(9149),o=n(3292),c=n(58),l=n(2037),u=n(7942),d=n(5960),h=n(7671);function p(e){const t=[];for(const n of e){let e=n;if(Array.isArray(n.content))for(let t=0;t<n.content.length;t++){const s=n.content[t];((0,r.W)(s)||(0,r.cJ)(s))&&e===n&&(e=new n.constructor({...e,content:[...n.content.slice(0,t),(0,r.Vi)(s),...n.content.slice(t+1)]}))}t.push(e)}return t}class m extends i.j_{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async invoke(e,t){const n=m._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===m.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{const n=m._convertInputToPromptValue(e).toChatMessages(),[s,i]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...s.metadata,...this.getLsParams(i)},c=await a.Td.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this?.invocationParams(i),batch_size:1},u=await(c?.handleChatModelStart(this.toJSON(),[p(n)],s.runId,void 0,l,void 0,void 0,s.runName));let d,h;try{for await(const e of this._streamResponseChunks(n,i,u?.[0])){if(null==e.message.id){const t=u?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,d=d?d.concat(e):e,(0,r.jm)(e.message)&&void 0!==e.message.usage_metadata&&(h={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((u??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((u??[]).map(e=>e?.handleLLMEnd({generations:[[d]],llmOutput:h})))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,n,i){const o=e.map(e=>e.map(r.K0));let l;if(void 0!==i&&i.length===o.length)l=i;else{const e={...n.metadata,...this.getLsParams(t)},r=await a.Td.configure(n.callbacks,this.callbacks,n.tags,this.tags,e,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this?.invocationParams(t),batch_size:1};l=await(r?.handleChatModelStart(this.toJSON(),o.map(p),n.runId,void 0,s,void 0,void 0,n.runName))}const u=[],h=[];if(!!l?.[0].handlers.find(d.xL)&&!this.disableStreaming&&1===o.length&&this._streamResponseChunks!==m.prototype._streamResponseChunks)try{const e=await this._streamResponseChunks(o[0],t,l?.[0]);let n,s;for await(const t of e){if(null==t.message.id){const e=l?.at(0)?.runId;null!=e&&t.message._updateId(`run-${e}`)}n=void 0===n?t:(0,c.xW)(n,t),(0,r.jm)(t.message)&&void 0!==t.message.usage_metadata&&(s={tokenUsage:{promptTokens:t.message.usage_metadata.input_tokens,completionTokens:t.message.usage_metadata.output_tokens,totalTokens:t.message.usage_metadata.total_tokens}})}if(void 0===n)throw new Error("Received empty response from chat model call.");u.push([n]),await(l?.[0].handleLLMEnd({generations:u,llmOutput:s}))}catch(e){throw await(l?.[0].handleLLMError(e)),e}else{const e=await Promise.allSettled(o.map((e,n)=>this._generate(e,{...t,promptIndex:n},l?.[n])));await Promise.all(e.map(async(e,t)=>{if("fulfilled"===e.status){const n=e.value;for(const e of n.generations){if(null==e.message.id){const t=l?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),u[t]=n.generations,h[t]=n.llmOutput,l?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}return await(l?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)}))}const g={generations:u,llmOutput:h.length?this._combineLLMOutput?.(...h):void 0};return Object.defineProperty(g,s.SP,{value:l?{runIds:l?.map(e=>e.runId)}:void 0,configurable:!0}),g}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:i,handledOptions:o}){const c=e.map(e=>e.map(r.K0)),l={...o.metadata,...this.getLsParams(i)},u=await a.Td.configure(o.callbacks,this.callbacks,o.tags,this.tags,l,this.metadata,{verbose:this.verbose}),d={options:i,invocation_params:this?.invocationParams(i),batch_size:1},h=await(u?.handleChatModelStart(this.toJSON(),c.map(p),o.runId,void 0,d,void 0,void 0,o.runName)),g=[],f=(await Promise.allSettled(c.map(async(e,r)=>{const s=m._convertInputToPromptValue(e).toString(),i=await t.lookup(s,n);return null==i&&g.push(r),i}))).map((e,t)=>({result:e,runManager:h?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),y=[];await Promise.all(f.map(async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const s=e.value;return y[n]=s.map(e=>("message"in e&&(0,r.ny)(e.message)&&(0,r.KX)(e.message)&&(e.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),s.length&&await(t?.handleLLMNewToken(s[0].text)),t?.handleLLMEnd({generations:[s]},void 0,void 0,void 0,{cached:!0})}return await(t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(e.reason)}));const _={generations:y,missingPromptIndices:g,startedRunManagers:h};return Object.defineProperty(_,s.SP,{value:h?{runIds:h?.map(e=>e.runId)}:void 0,configurable:!0}),_}async generate(e,t,n){let s;s=Array.isArray(t)?{stop:t}:t;const i=e.map(e=>e.map(r.K0)),[a,o]=this._separateRunnableConfigFromCallOptionsCompat(s);if(a.callbacks=a.callbacks??n,!this.cache)return this._generateUncached(i,o,a);const{cache:c}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:d,startedRunManagers:h}=await this._generateCached({messages:i,cache:c,llmStringKey:l,parsedOptions:o,handledOptions:a});let p={};if(d.length>0){const e=await this._generateUncached(d.map(e=>i[e]),o,a,void 0!==h?d.map(e=>h?.[e]):void 0);await Promise.all(e.generations.map(async(e,t)=>{const n=d[t];u[n]=e;const r=m._convertInputToPromptValue(i[n]).toString();return c.update(r,l,e)})),p=e.llmOutput??{}}return{generations:u,llmOutput:p}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const r=e.map(e=>e.toChatMessages());return this.generate(r,t,n)}async call(e,t,n){return(await this.generate([e.map(r.K0)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const r=e.toChatMessages();return this.call(r,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const s=new r.xc(e),i=await this.call([s],t,n);if("string"!=typeof i.content)throw new Error("Cannot use predict when output is not a string.");return i.content}withStructuredOutput(e,t){if("function"!=typeof this.bindTools)throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw new Error('"strict" mode is not supported for this model by default.');const n=e,r=t?.name,s=(0,u.cg)(n)??"A function available to call.",i=t?.method,a=t?.includeRaw;if("jsonMode"===i)throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let c,d=r??"extract";(0,u.c9)(n)?c=[{type:"function",function:{name:d,description:s,parameters:(0,h.PF)(n)}}]:("name"in n&&(d=n.name),c=[{type:"function",function:{name:d,description:s,parameters:n}}]);const p=this.bindTools(c),m=o.jY.from(e=>{if(!e.tool_calls||0===e.tool_calls.length)throw new Error("No tool calls found in the response.");const t=e.tool_calls.find(e=>e.name===d);if(!t)throw new Error(`No tool call found with name ${d}.`);return t.args});if(!a)return p.pipe(m).withConfig({runName:"StructuredOutput"});const g=l.k.assign({parsed:(e,t)=>m.invoke(e.raw,t)}),f=l.k.assign({parsed:()=>null}),y=g.withFallbacks({fallbacks:[f]});return o.zZ.from([{raw:p},y]).withConfig({runName:"StructuredOutputRunnable"})}}},1832:(e,t,n)=>{"use strict";const r=n(144);e.exports=(e,t)=>{const n=r(e,null,!0),s=r(t,null,!0),i=n.compare(s);if(0===i)return null;const a=i>0,o=a?n:s,c=a?s:n,l=!!o.prerelease.length;if(!!c.prerelease.length&&!l){if(!c.patch&&!c.minor)return"major";if(0===c.compareMain(o))return c.minor&&!c.patch?"minor":"patch"}const u=l?"pre":"";return n.major!==s.major?u+"major":n.minor!==s.minor?u+"minor":n.patch!==s.patch?u+"patch":"prerelease"}},2037:(e,t,n)=>{"use strict";n.d(t,{k:()=>a});var r=n(58),s=n(3292),i=n(765);class a extends s.YN{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=(0,i.ZI)(t);return this.func&&await this.func(e,n),this._callWithConfig(e=>Promise.resolve(e),e,n)}async*transform(e,t){const n=(0,i.ZI)(t);let s,a=!0;for await(const t of this._transformStreamWithConfig(e,e=>e,n))if(yield t,a)if(void 0===s)s=t;else try{s=(0,r.xW)(s,t)}catch{s=void 0,a=!1}this.func&&void 0!==s&&await this.func(s,n)}static assign(e){return new s.B2(new s.ck({steps:e}))}}},2080:(e,t,n)=>{"use strict";n.d(t,{Ik:()=>Ae,KC:()=>Me,L5:()=>Oe,Nl:()=>Ee,YO:()=>Ce,Yj:()=>Se,ai:()=>xe,bz:()=>Ie,ch:()=>Te,eu:()=>je,fc:()=>Le,g1:()=>$e,gM:()=>Re,k5:()=>Ne,kY:()=>ve,lq:()=>De,re:()=>Pe,zM:()=>ke});var r=n(5616),s=(n(7958),n(342),n(1125)),i=n(4104),a=n(9115);class o{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const c=(e,t)=>{if((0,i.fn)(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new r.G(e.common.issues);return this._error=t,this._error}}};function l(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:s}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');if(t)return{errorMap:t,description:s};return{errorMap:(t,s)=>{const{message:i}=e;return"invalid_enum_value"===t.code?{message:i??s.defaultError}:void 0===s.data?{message:i??r??s.defaultError}:"invalid_type"!==t.code?{message:s.defaultError}:{message:i??n??s.defaultError}},description:s}}class u{get description(){return this._def.description}_getType(e){return(0,a.CR)(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:(0,a.CR)(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new i.MY,ctx:{common:e.parent.common,data:e.data,parsedType:(0,a.CR)(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if((0,i.xP)(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:(0,a.CR)(e)},r=this._parseSync({data:e,path:n.path,parent:n});return c(n,r)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:(0,a.CR)(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return(0,i.fn)(n)?{value:n.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>(0,i.fn)(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:(0,a.CR)(e)},r=this._parse({data:e,path:n.path,parent:n}),s=await((0,i.xP)(r)?r:Promise.resolve(r));return c(n,s)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,s)=>{const i=e(t),a=()=>s.addIssue({code:r.eq.custom,...n(t)});return"undefined"!=typeof Promise&&i instanceof Promise?i.then(e=>!!e||(a(),!1)):!!i||(a(),!1)})}refinement(e,t){return this._refinement((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1))}_refinement(e){return new de({schema:this,typeName:ve.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return he.create(this,this._def)}nullable(){return pe.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return K.create(this)}promise(){return ue.create(this,this._def)}or(e){return J.create([this,e],this._def)}and(e){return ee.create(this,e,this._def)}transform(e){return new de({...l(this._def),schema:this,typeName:ve.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new me({...l(this._def),innerType:this,defaultValue:t,typeName:ve.ZodDefault})}brand(){return new ye({typeName:ve.ZodBranded,type:this,...l(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new ge({...l(this._def),innerType:this,catchValue:t,typeName:ve.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return _e.create(this,e)}readonly(){return be.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const d=/^c[^\s-]{8,}$/i,h=/^[0-9a-z]+$/,p=/^[0-9A-HJKMNP-TV-Z]{26}$/i,m=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,g=/^[a-z0-9_-]{21}$/i,f=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,y=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,_=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let b;const w=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,v=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,E=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,S=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,x=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,k=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,T="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",I=new RegExp(`^${T}$`);function O(e){let t="[0-5]\\d";e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`);return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function C(e){return new RegExp(`^${O(e)}$`)}function A(e){let t=`${T}T${O(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function P(e,t){return!("v4"!==t&&t||!w.test(e))||!("v6"!==t&&t||!E.test(e))}function M(e,t){if(!f.test(e))return!1;try{const[n]=e.split(".");if(!n)return!1;const r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),s=JSON.parse(atob(r));return"object"==typeof s&&null!==s&&((!("typ"in s)||"JWT"===s?.typ)&&(!!s.alg&&(!t||s.alg===t)))}catch{return!1}}function R(e,t){return!("v4"!==t&&t||!v.test(e))||!("v6"!==t&&t||!S.test(e))}class $ extends u{_parse(e){this._def.coerce&&(e.data=String(e.data));if(this._getType(e)!==a.Zp.string){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.string,received:t.parsedType}),i.uY}const t=new i.MY;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const a=e.data.length>s.value,o=e.data.length<s.value;(a||o)&&(n=this._getOrReturnCtx(e,n),a?(0,i.zn)(n,{code:r.eq.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&(0,i.zn)(n,{code:r.eq.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)_.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"email",code:r.eq.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)b||(b=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),b.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"emoji",code:r.eq.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)m.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"uuid",code:r.eq.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)g.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"nanoid",code:r.eq.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)d.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"cuid",code:r.eq.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)h.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"cuid2",code:r.eq.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)p.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"ulid",code:r.eq.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"url",code:r.eq.invalid_string,message:s.message}),t.dirty()}else if("regex"===s.kind){s.regex.lastIndex=0;s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"regex",code:r.eq.invalid_string,message:s.message}),t.dirty())}else if("trim"===s.kind)e.data=e.data.trim();else if("includes"===s.kind)e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty());else if("toLowerCase"===s.kind)e.data=e.data.toLowerCase();else if("toUpperCase"===s.kind)e.data=e.data.toUpperCase();else if("startsWith"===s.kind)e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty());else if("endsWith"===s.kind)e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty());else if("datetime"===s.kind){A(s).test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.invalid_string,validation:"datetime",message:s.message}),t.dirty())}else if("date"===s.kind){I.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.invalid_string,validation:"date",message:s.message}),t.dirty())}else if("time"===s.kind){C(s).test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.invalid_string,validation:"time",message:s.message}),t.dirty())}else"duration"===s.kind?y.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"duration",code:r.eq.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?P(e.data,s.version)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"ip",code:r.eq.invalid_string,message:s.message}),t.dirty()):"jwt"===s.kind?M(e.data,s.alg)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"jwt",code:r.eq.invalid_string,message:s.message}),t.dirty()):"cidr"===s.kind?R(e.data,s.version)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"cidr",code:r.eq.invalid_string,message:s.message}),t.dirty()):"base64"===s.kind?x.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"base64",code:r.eq.invalid_string,message:s.message}),t.dirty()):"base64url"===s.kind?k.test(e.data)||(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{validation:"base64url",code:r.eq.invalid_string,message:s.message}),t.dirty()):a.ZS.assertNever(s);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(t=>e.test(t),{validation:t,code:r.eq.invalid_string,...s.r.errToObj(n)})}_addCheck(e){return new $({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...s.r.errToObj(e)})}url(e){return this._addCheck({kind:"url",...s.r.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...s.r.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...s.r.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...s.r.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...s.r.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...s.r.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...s.r.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...s.r.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...s.r.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...s.r.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...s.r.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...s.r.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...s.r.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...s.r.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...s.r.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...s.r.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...s.r.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...s.r.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...s.r.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...s.r.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...s.r.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...s.r.errToObj(t)})}nonempty(e){return this.min(1,s.r.errToObj(e))}trim(){return new $({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new $({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new $({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function j(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,s=n>r?n:r;return Number.parseInt(e.toFixed(s).replace(".",""))%Number.parseInt(t.toFixed(s).replace(".",""))/10**s}$.create=e=>new $({checks:[],typeName:ve.ZodString,coerce:e?.coerce??!1,...l(e)});class N extends u{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){this._def.coerce&&(e.data=Number(e.data));if(this._getType(e)!==a.Zp.number){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.number,received:t.parsedType}),i.uY}let t;const n=new i.MY;for(const s of this._def.checks)if("int"===s.kind)a.ZS.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),(0,i.zn)(t,{code:r.eq.invalid_type,expected:"integer",received:"float",message:s.message}),n.dirty());else if("min"===s.kind){(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),(0,i.zn)(t,{code:r.eq.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty())}else if("max"===s.kind){(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),(0,i.zn)(t,{code:r.eq.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty())}else"multipleOf"===s.kind?0!==j(e.data,s.value)&&(t=this._getOrReturnCtx(e,t),(0,i.zn)(t,{code:r.eq.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):"finite"===s.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),(0,i.zn)(t,{code:r.eq.not_finite,message:s.message}),n.dirty()):a.ZS.assertNever(s);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,s.r.toString(t))}gt(e,t){return this.setLimit("min",e,!1,s.r.toString(t))}lte(e,t){return this.setLimit("max",e,!0,s.r.toString(t))}lt(e,t){return this.setLimit("max",e,!1,s.r.toString(t))}setLimit(e,t,n,r){return new N({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:s.r.toString(r)}]})}_addCheck(e){return new N({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:s.r.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:s.r.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:s.r.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:s.r.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:s.r.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:s.r.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:s.r.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:s.r.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:s.r.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&a.ZS.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}N.create=e=>new N({checks:[],typeName:ve.ZodNumber,coerce:e?.coerce||!1,...l(e)});class L extends u{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==a.Zp.bigint)return this._getInvalidInput(e);let t;const n=new i.MY;for(const s of this._def.checks)if("min"===s.kind){(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),(0,i.zn)(t,{code:r.eq.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty())}else if("max"===s.kind){(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),(0,i.zn)(t,{code:r.eq.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty())}else"multipleOf"===s.kind?e.data%s.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),(0,i.zn)(t,{code:r.eq.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):a.ZS.assertNever(s);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.bigint,received:t.parsedType}),i.uY}gte(e,t){return this.setLimit("min",e,!0,s.r.toString(t))}gt(e,t){return this.setLimit("min",e,!1,s.r.toString(t))}lte(e,t){return this.setLimit("max",e,!0,s.r.toString(t))}lt(e,t){return this.setLimit("max",e,!1,s.r.toString(t))}setLimit(e,t,n,r){return new L({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:s.r.toString(r)}]})}_addCheck(e){return new L({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:s.r.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:s.r.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:s.r.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:s.r.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:s.r.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}L.create=e=>new L({checks:[],typeName:ve.ZodBigInt,coerce:e?.coerce??!1,...l(e)});class D extends u{_parse(e){this._def.coerce&&(e.data=Boolean(e.data));if(this._getType(e)!==a.Zp.boolean){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.boolean,received:t.parsedType}),i.uY}return(0,i.OK)(e.data)}}D.create=e=>new D({typeName:ve.ZodBoolean,coerce:e?.coerce||!1,...l(e)});class U extends u{_parse(e){this._def.coerce&&(e.data=new Date(e.data));if(this._getType(e)!==a.Zp.date){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.date,received:t.parsedType}),i.uY}if(Number.isNaN(e.data.getTime())){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_date}),i.uY}const t=new i.MY;let n;for(const s of this._def.checks)"min"===s.kind?e.data.getTime()<s.value&&(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),t.dirty()):"max"===s.kind?e.data.getTime()>s.value&&(n=this._getOrReturnCtx(e,n),(0,i.zn)(n,{code:r.eq.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),t.dirty()):a.ZS.assertNever(s);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new U({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:s.r.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:s.r.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}U.create=e=>new U({checks:[],coerce:e?.coerce||!1,typeName:ve.ZodDate,...l(e)});class F extends u{_parse(e){if(this._getType(e)!==a.Zp.symbol){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.symbol,received:t.parsedType}),i.uY}return(0,i.OK)(e.data)}}F.create=e=>new F({typeName:ve.ZodSymbol,...l(e)});class Y extends u{_parse(e){if(this._getType(e)!==a.Zp.undefined){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.undefined,received:t.parsedType}),i.uY}return(0,i.OK)(e.data)}}Y.create=e=>new Y({typeName:ve.ZodUndefined,...l(e)});class G extends u{_parse(e){if(this._getType(e)!==a.Zp.null){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.null,received:t.parsedType}),i.uY}return(0,i.OK)(e.data)}}G.create=e=>new G({typeName:ve.ZodNull,...l(e)});class B extends u{constructor(){super(...arguments),this._any=!0}_parse(e){return(0,i.OK)(e.data)}}B.create=e=>new B({typeName:ve.ZodAny,...l(e)});class H extends u{constructor(){super(...arguments),this._unknown=!0}_parse(e){return(0,i.OK)(e.data)}}H.create=e=>new H({typeName:ve.ZodUnknown,...l(e)});class z extends u{_parse(e){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.never,received:t.parsedType}),i.uY}}z.create=e=>new z({typeName:ve.ZodNever,...l(e)});class q extends u{_parse(e){if(this._getType(e)!==a.Zp.undefined){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.void,received:t.parsedType}),i.uY}return(0,i.OK)(e.data)}}q.create=e=>new q({typeName:ve.ZodVoid,...l(e)});class K extends u{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),s=this._def;if(t.parsedType!==a.Zp.array)return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.array,received:t.parsedType}),i.uY;if(null!==s.exactLength){const e=t.data.length>s.exactLength.value,a=t.data.length<s.exactLength.value;(e||a)&&((0,i.zn)(t,{code:e?r.eq.too_big:r.eq.too_small,minimum:a?s.exactLength.value:void 0,maximum:e?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(null!==s.minLength&&t.data.length<s.minLength.value&&((0,i.zn)(t,{code:r.eq.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),null!==s.maxLength&&t.data.length>s.maxLength.value&&((0,i.zn)(t,{code:r.eq.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((e,n)=>s.type._parseAsync(new o(t,e,t.path,n)))).then(e=>i.MY.mergeArray(n,e));const c=[...t.data].map((e,n)=>s.type._parseSync(new o(t,e,t.path,n)));return i.MY.mergeArray(n,c)}get element(){return this._def.type}min(e,t){return new K({...this._def,minLength:{value:e,message:s.r.toString(t)}})}max(e,t){return new K({...this._def,maxLength:{value:e,message:s.r.toString(t)}})}length(e,t){return new K({...this._def,exactLength:{value:e,message:s.r.toString(t)}})}nonempty(e){return this.min(1,e)}}function W(e){if(e instanceof V){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=he.create(W(r))}return new V({...e._def,shape:()=>t})}return e instanceof K?new K({...e._def,type:W(e.element)}):e instanceof he?he.create(W(e.unwrap())):e instanceof pe?pe.create(W(e.unwrap())):e instanceof te?te.create(e.items.map(e=>W(e))):e}K.create=(e,t)=>new K({type:e,minLength:null,maxLength:null,exactLength:null,typeName:ve.ZodArray,...l(t)});class V extends u{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=a.ZS.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==a.Zp.object){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.object,received:t.parsedType}),i.uY}const{status:t,ctx:n}=this._processInputParams(e),{shape:s,keys:c}=this._getCached(),l=[];if(!(this._def.catchall instanceof z&&"strip"===this._def.unknownKeys))for(const e in n.data)c.includes(e)||l.push(e);const u=[];for(const e of c){const t=s[e],r=n.data[e];u.push({key:{status:"valid",value:e},value:t._parse(new o(n,r,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof z){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of l)u.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)l.length>0&&((0,i.zn)(n,{code:r.eq.unrecognized_keys,keys:l}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of l){const r=n.data[t];u.push({key:{status:"valid",value:t},value:e._parse(new o(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of u){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e}).then(e=>i.MY.mergeObjectSync(t,e)):i.MY.mergeObjectSync(t,u)}get shape(){return this._def.shape()}strict(e){return s.r.errToObj,new V({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{const r=this._def.errorMap?.(t,n).message??n.defaultError;return"unrecognized_keys"===t.code?{message:s.r.errToObj(e).message??r}:{message:r}}}:{}})}strip(){return new V({...this._def,unknownKeys:"strip"})}passthrough(){return new V({...this._def,unknownKeys:"passthrough"})}extend(e){return new V({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new V({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:ve.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new V({...this._def,catchall:e})}pick(e){const t={};for(const n of a.ZS.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new V({...this._def,shape:()=>t})}omit(e){const t={};for(const n of a.ZS.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new V({...this._def,shape:()=>t})}deepPartial(){return W(this)}partial(e){const t={};for(const n of a.ZS.objectKeys(this.shape)){const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()}return new V({...this._def,shape:()=>t})}required(e){const t={};for(const n of a.ZS.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof he;)e=e._def.innerType;t[n]=e}return new V({...this._def,shape:()=>t})}keyof(){return oe(a.ZS.objectKeys(this.shape))}}V.create=(e,t)=>new V({shape:()=>e,unknownKeys:"strip",catchall:z.create(),typeName:ve.ZodObject,...l(t)}),V.strictCreate=(e,t)=>new V({shape:()=>e,unknownKeys:"strict",catchall:z.create(),typeName:ve.ZodObject,...l(t)}),V.lazycreate=(e,t)=>new V({shape:e,unknownKeys:"strip",catchall:z.create(),typeName:ve.ZodObject,...l(t)});class J extends u{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map(async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map(e=>new r.G(e.ctx.common.issues));return(0,i.zn)(t,{code:r.eq.invalid_union,unionErrors:n}),i.uY});{let e;const s=[];for(const r of n){const n={...t,common:{...t.common,issues:[]},parent:null},i=r._parseSync({data:t.data,path:t.path,parent:n});if("valid"===i.status)return i;"dirty"!==i.status||e||(e={result:i,ctx:n}),n.common.issues.length&&s.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const a=s.map(e=>new r.G(e));return(0,i.zn)(t,{code:r.eq.invalid_union,unionErrors:a}),i.uY}}get options(){return this._def.options}}J.create=(e,t)=>new J({options:e,typeName:ve.ZodUnion,...l(t)});const Z=e=>e instanceof ie?Z(e.schema):e instanceof de?Z(e.innerType()):e instanceof ae?[e.value]:e instanceof ce?e.options:e instanceof le?a.ZS.objectValues(e.enum):e instanceof me?Z(e._def.innerType):e instanceof Y?[void 0]:e instanceof G?[null]:e instanceof he?[void 0,...Z(e.unwrap())]:e instanceof pe?[null,...Z(e.unwrap())]:e instanceof ye||e instanceof be?Z(e.unwrap()):e instanceof ge?Z(e._def.innerType):[];class X extends u{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==a.Zp.object)return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.object,received:t.parsedType}),i.uY;const n=this.discriminator,s=t.data[n],o=this.optionsMap.get(s);return o?t.common.async?o._parseAsync({data:t.data,path:t.path,parent:t}):o._parseSync({data:t.data,path:t.path,parent:t}):((0,i.zn)(t,{code:r.eq.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),i.uY)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const r=new Map;for(const n of t){const t=Z(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const s of t){if(r.has(s))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(s)}`);r.set(s,n)}}return new X({typeName:ve.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...l(n)})}}function Q(e,t){const n=(0,a.CR)(e),r=(0,a.CR)(t);if(e===t)return{valid:!0,data:e};if(n===a.Zp.object&&r===a.Zp.object){const n=a.ZS.objectKeys(t),r=a.ZS.objectKeys(e).filter(e=>-1!==n.indexOf(e)),s={...e,...t};for(const n of r){const r=Q(e[n],t[n]);if(!r.valid)return{valid:!1};s[n]=r.data}return{valid:!0,data:s}}if(n===a.Zp.array&&r===a.Zp.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const s=Q(e[r],t[r]);if(!s.valid)return{valid:!1};n.push(s.data)}return{valid:!0,data:n}}return n===a.Zp.date&&r===a.Zp.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}class ee extends u{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=(e,s)=>{if((0,i.G4)(e)||(0,i.G4)(s))return i.uY;const a=Q(e.value,s.value);return a.valid?(((0,i.DM)(e)||(0,i.DM)(s))&&t.dirty(),{status:t.value,value:a.data}):((0,i.zn)(n,{code:r.eq.invalid_intersection_types}),i.uY)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([e,t])=>s(e,t)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}ee.create=(e,t,n)=>new ee({left:e,right:t,typeName:ve.ZodIntersection,...l(n)});class te extends u{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==a.Zp.array)return(0,i.zn)(n,{code:r.eq.invalid_type,expected:a.Zp.array,received:n.parsedType}),i.uY;if(n.data.length<this._def.items.length)return(0,i.zn)(n,{code:r.eq.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),i.uY;!this._def.rest&&n.data.length>this._def.items.length&&((0,i.zn)(n,{code:r.eq.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...n.data].map((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new o(n,e,n.path,t)):null}).filter(e=>!!e);return n.common.async?Promise.all(s).then(e=>i.MY.mergeArray(t,e)):i.MY.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new te({...this._def,rest:e})}}te.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new te({items:e,typeName:ve.ZodTuple,rest:null,...l(t)})};class ne extends u{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==a.Zp.object)return(0,i.zn)(n,{code:r.eq.invalid_type,expected:a.Zp.object,received:n.parsedType}),i.uY;const s=[],c=this._def.keyType,l=this._def.valueType;for(const e in n.data)s.push({key:c._parse(new o(n,e,n.path,e)),value:l._parse(new o(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?i.MY.mergeObjectAsync(t,s):i.MY.mergeObjectSync(t,s)}get element(){return this._def.valueType}static create(e,t,n){return new ne(t instanceof u?{keyType:e,valueType:t,typeName:ve.ZodRecord,...l(n)}:{keyType:$.create(),valueType:e,typeName:ve.ZodRecord,...l(t)})}}class re extends u{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==a.Zp.map)return(0,i.zn)(n,{code:r.eq.invalid_type,expected:a.Zp.map,received:n.parsedType}),i.uY;const s=this._def.keyType,c=this._def.valueType,l=[...n.data.entries()].map(([e,t],r)=>({key:s._parse(new o(n,e,n.path,[r,"key"])),value:c._parse(new o(n,t,n.path,[r,"value"]))}));if(n.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const n of l){const r=await n.key,s=await n.value;if("aborted"===r.status||"aborted"===s.status)return i.uY;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}})}{const e=new Map;for(const n of l){const r=n.key,s=n.value;if("aborted"===r.status||"aborted"===s.status)return i.uY;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}}}}re.create=(e,t,n)=>new re({valueType:t,keyType:e,typeName:ve.ZodMap,...l(n)});class se extends u{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==a.Zp.set)return(0,i.zn)(n,{code:r.eq.invalid_type,expected:a.Zp.set,received:n.parsedType}),i.uY;const s=this._def;null!==s.minSize&&n.data.size<s.minSize.value&&((0,i.zn)(n,{code:r.eq.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),null!==s.maxSize&&n.data.size>s.maxSize.value&&((0,i.zn)(n,{code:r.eq.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const c=this._def.valueType;function l(e){const n=new Set;for(const r of e){if("aborted"===r.status)return i.uY;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const u=[...n.data.values()].map((e,t)=>c._parse(new o(n,e,n.path,t)));return n.common.async?Promise.all(u).then(e=>l(e)):l(u)}min(e,t){return new se({...this._def,minSize:{value:e,message:s.r.toString(t)}})}max(e,t){return new se({...this._def,maxSize:{value:e,message:s.r.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}se.create=(e,t)=>new se({valueType:e,minSize:null,maxSize:null,typeName:ve.ZodSet,...l(t)});class ie extends u{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}ie.create=(e,t)=>new ie({getter:e,typeName:ve.ZodLazy,...l(t)});class ae extends u{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{received:t.data,code:r.eq.invalid_literal,expected:this._def.value}),i.uY}return{status:"valid",value:e.data}}get value(){return this._def.value}}function oe(e,t){return new ce({values:e,typeName:ve.ZodEnum,...l(t)})}ae.create=(e,t)=>new ae({value:e,typeName:ve.ZodLiteral,...l(t)});class ce extends u{_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return(0,i.zn)(t,{expected:a.ZS.joinValues(n),received:t.parsedType,code:r.eq.invalid_type}),i.uY}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return(0,i.zn)(t,{received:t.data,code:r.eq.invalid_enum_value,options:n}),i.uY}return(0,i.OK)(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return ce.create(e,{...this._def,...t})}exclude(e,t=this._def){return ce.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}ce.create=oe;class le extends u{_parse(e){const t=a.ZS.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==a.Zp.string&&n.parsedType!==a.Zp.number){const e=a.ZS.objectValues(t);return(0,i.zn)(n,{expected:a.ZS.joinValues(e),received:n.parsedType,code:r.eq.invalid_type}),i.uY}if(this._cache||(this._cache=new Set(a.ZS.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=a.ZS.objectValues(t);return(0,i.zn)(n,{received:n.data,code:r.eq.invalid_enum_value,options:e}),i.uY}return(0,i.OK)(e.data)}get enum(){return this._def.values}}le.create=(e,t)=>new le({values:e,typeName:ve.ZodNativeEnum,...l(t)});class ue extends u{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==a.Zp.promise&&!1===t.common.async)return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.promise,received:t.parsedType}),i.uY;const n=t.parsedType===a.Zp.promise?t.data:Promise.resolve(t.data);return(0,i.OK)(n.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}ue.create=(e,t)=>new ue({type:e,typeName:ve.ZodPromise,...l(t)});class de extends u{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===ve.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=this._def.effect||null,s={addIssue:e=>{(0,i.zn)(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(s.addIssue=s.addIssue.bind(s),"preprocess"===r.type){const e=r.transform(n.data,s);if(n.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return i.uY;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?i.uY:"dirty"===r.status||"dirty"===t.value?(0,i.jm)(r.value):r});{if("aborted"===t.value)return i.uY;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?i.uY:"dirty"===r.status||"dirty"===t.value?(0,i.jm)(r.value):r}}if("refinement"===r.type){const e=e=>{const t=r.refinement(e,s);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?i.uY:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(n=>"aborted"===n.status?i.uY:("dirty"===n.status&&t.dirty(),e(n.value).then(()=>({status:t.value,value:n.value}))))}if("transform"===r.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!(0,i.fn)(e))return i.uY;const a=r.transform(e.value,s);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(e=>(0,i.fn)(e)?Promise.resolve(r.transform(e.value,s)).then(e=>({status:t.value,value:e})):i.uY)}a.ZS.assertNever(r)}}de.create=(e,t,n)=>new de({schema:e,typeName:ve.ZodEffects,effect:t,...l(n)}),de.createWithPreprocess=(e,t,n)=>new de({schema:t,effect:{type:"preprocess",transform:e},typeName:ve.ZodEffects,...l(n)});class he extends u{_parse(e){return this._getType(e)===a.Zp.undefined?(0,i.OK)(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}he.create=(e,t)=>new he({innerType:e,typeName:ve.ZodOptional,...l(t)});class pe extends u{_parse(e){return this._getType(e)===a.Zp.null?(0,i.OK)(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}pe.create=(e,t)=>new pe({innerType:e,typeName:ve.ZodNullable,...l(t)});class me extends u{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===a.Zp.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}me.create=(e,t)=>new me({innerType:e,typeName:ve.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...l(t)});class ge extends u{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return(0,i.xP)(s)?s.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new r.G(n.common.issues)},input:n.data})})):{status:"valid",value:"valid"===s.status?s.value:this._def.catchValue({get error(){return new r.G(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}ge.create=(e,t)=>new ge({innerType:e,typeName:ve.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...l(t)});class fe extends u{_parse(e){if(this._getType(e)!==a.Zp.nan){const t=this._getOrReturnCtx(e);return(0,i.zn)(t,{code:r.eq.invalid_type,expected:a.Zp.nan,received:t.parsedType}),i.uY}return{status:"valid",value:e.data}}}fe.create=e=>new fe({typeName:ve.ZodNaN,...l(e)});Symbol("zod_brand");class ye extends u{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class _e extends u{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async){return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?i.uY:"dirty"===e.status?(t.dirty(),(0,i.jm)(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})()}{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?i.uY:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new _e({in:e,out:t,typeName:ve.ZodPipeline})}}class be extends u{_parse(e){const t=this._def.innerType._parse(e),n=e=>((0,i.fn)(e)&&(e.value=Object.freeze(e.value)),e);return(0,i.xP)(t)?t.then(e=>n(e)):n(t)}unwrap(){return this._def.innerType}}function we(e,t){const n="function"==typeof e?e(t):"string"==typeof e?{message:e}:e;return"string"==typeof n?{message:n}:n}be.create=(e,t)=>new be({innerType:e,typeName:ve.ZodReadonly,...l(t)});V.lazycreate;var ve;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(ve||(ve={}));const Ee=(e,t={message:`Input not instance of ${e.name}`})=>function(e,t={},n){return e?B.create().superRefine((r,s)=>{const i=e(r);if(i instanceof Promise)return i.then(e=>{if(!e){const e=we(t,r),i=e.fatal??n??!0;s.addIssue({code:"custom",...e,fatal:i})}});if(!i){const e=we(t,r),i=e.fatal??n??!0;s.addIssue({code:"custom",...e,fatal:i})}}):B.create()}(t=>t instanceof e,t),Se=$.create,xe=N.create,ke=(fe.create,L.create,D.create),Te=(U.create,F.create,Y.create,G.create),Ie=B.create,Oe=H.create,Ce=(z.create,q.create,K.create),Ae=V.create,Pe=V.strictCreate,Me=J.create,Re=X.create,$e=(ee.create,te.create,ne.create),je=(re.create,se.create,ie.create,ae.create),Ne=ce.create,Le=le.create,De=(ue.create,de.create,he.create);pe.create,de.createWithPreprocess,_e.create},2111:(e,t,n)=>{"use strict";const r=n(4641),s=n(3999),i=n(5580),a=n(4089),o=n(7059),c=n(5200);e.exports=(e,t,n,l)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e===n;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e!==n;case"":case"=":case"==":return r(e,n,l);case"!=":return s(e,n,l);case">":return i(e,n,l);case">=":return a(e,n,l);case"<":return o(e,n,l);case"<=":return c(e,n,l);default:throw new TypeError(`Invalid operator: ${t}`)}}},2525:(e,t,n)=>{"use strict";const r=n(7638),s=n(560);e.exports=(e,t,n)=>{const i=[];let a=null,o=null;const c=e.sort((e,t)=>s(e,t,n));for(const e of c){r(e,t,n)?(o=e,a||(a=e)):(o&&i.push([a,o]),o=null,a=null)}a&&i.push([a,null]);const l=[];for(const[e,t]of i)e===t?l.push(e):t||e!==c[0]?t?e===c[0]?l.push(`<=${t}`):l.push(`${e} - ${t}`):l.push(`>=${e}`):l.push("*");const u=l.join(" || "),d="string"==typeof t.raw?t.raw:String(t);return u.length<d.length?u:t}},2540:(e,t,n)=>{"use strict";n.d(t,{J:()=>s});var r=n(9624);class s{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new r.g(e??{})}}},2729:e=>{"use strict";const t=/[\p{Lu}]/u,n=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,s=/([\p{Alpha}\p{N}_]|$)/u,i=/[_.\- ]+/,a=new RegExp("^"+i.source),o=new RegExp(i.source+s.source,"gu"),c=new RegExp("\\d+"+s.source,"gu"),l=(e,s)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(s={pascalCase:!1,preserveConsecutiveUppercase:!1,...s},0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length)return"";const i=!1===s.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(s.locale),l=!1===s.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(s.locale);if(1===e.length)return s.pascalCase?l(e):i(e);return e!==i(e)&&(e=((e,r,s)=>{let i=!1,a=!1,o=!1;for(let c=0;c<e.length;c++){const l=e[c];i&&t.test(l)?(e=e.slice(0,c)+"-"+e.slice(c),i=!1,o=a,a=!0,c++):a&&o&&n.test(l)?(e=e.slice(0,c-1)+"-"+e.slice(c-1),o=a,a=!1,i=!0):(i=r(l)===l&&s(l)!==l,o=a,a=s(l)===l&&r(l)!==l)}return e})(e,i,l)),e=e.replace(a,""),e=s.preserveConsecutiveUppercase?((e,t)=>(r.lastIndex=0,e.replace(r,e=>t(e))))(e,i):i(e),s.pascalCase&&(e=l(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,c.lastIndex=0,e.replace(o,(e,n)=>t(n)).replace(c,e=>t(e))))(e,l)};e.exports=l,e.exports.default=l},2778:(e,t,n)=>{"use strict";n.d(t,{VC:()=>r.VC,Z2:()=>r.Z2});var r=n(528)},2783:(e,t,n)=>{"use strict";n.d(t,{D:()=>s});var r=n(454);class s{constructor(e){this.subscribers=new Set,this.messageBuffer=[],this.MAX_BUFFER_SIZE=200,this.isDestroyed=!1,this.executionId=e,r.y7.log("PubSubChannel",`Created channel for execution ${e}`)}publishMessage(e){if(this.isDestroyed)return;const t={type:"message",payload:e};this._publish(t)}publishHumanInputRequest(e){if(this.isDestroyed)return;const t={type:"human-input-request",payload:e};this._publish(t)}publishHumanInputResponse(e){if(this.isDestroyed)return;const t={type:"human-input-response",payload:e};this._publish(t)}publishTeachModeEvent(e){if(this.isDestroyed)return;const t={type:"teach-mode-event",payload:e};this._publish(t),r.y7.log("PubSubChannel",`Published teach mode event: ${e.eventType} for session ${e.sessionId}`)}subscribe(e){return this.isDestroyed?{unsubscribe:()=>{}}:(this.subscribers.add(e),this.messageBuffer.forEach(t=>{try{e(t)}catch(e){}}),{unsubscribe:()=>{this.subscribers.delete(e)}})}getBuffer(){return[...this.messageBuffer]}clearBuffer(){this.messageBuffer=[]}_publish(e){this.messageBuffer.push(e),this.messageBuffer.length>this.MAX_BUFFER_SIZE&&(this.messageBuffer=this.messageBuffer.slice(-this.MAX_BUFFER_SIZE)),this.subscribers.forEach(t=>{try{t(e)}catch(e){}})}isActive(){return!this.isDestroyed}getSubscriberCount(){return this.subscribers.size}getStats(){return{executionId:this.executionId,subscribers:this.subscribers.size,bufferSize:this.messageBuffer.length,isActive:!this.isDestroyed}}destroy(){this.isDestroyed||(this.subscribers.clear(),this.messageBuffer=[],this.isDestroyed=!0,r.y7.log("PubSubChannel",`Destroyed channel for execution ${this.executionId}`))}static generateId(e="msg"){return`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static createMessage(e,t="thinking"){return{msgId:s.generateId(`msg_${t}`),content:e,role:t,ts:Date.now()}}static createMessageWithId(e,t,n="thinking"){return{msgId:e,content:t,role:n,ts:Date.now()}}}},2788:(e,t,n)=>{"use strict";var r,s=Object.defineProperty,i=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyNames,o=Object.prototype.hasOwnProperty,c={};((e,t)=>{for(var n in t)s(e,n,{get:t[n],enumerable:!0})})(c,{waitUntil:()=>u}),e.exports=(r=c,((e,t,n,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let c of a(t))o.call(e,c)||c===n||s(e,c,{get:()=>t[c],enumerable:!(r=i(t,c))||r.enumerable});return e})(s({},"__esModule",{value:!0}),r));var l=n(5784);const u=e=>{if(null===e||"object"!=typeof e||"function"!=typeof e.then)throw new TypeError("waitUntil can only be called with a Promise, got "+typeof e);return(0,l.getContext)().waitUntil?.(e)}},2938:(e,t,n)=>{"use strict";const r=n(3908);e.exports=(e,t)=>new r(e,t).major},3007:(e,t,n)=>{"use strict";const r=n(3908);e.exports=(e,t,n,s,i)=>{"string"==typeof n&&(i=s,s=n,n=void 0);try{return new r(e instanceof r?e.version:e,n).inc(t,s,i).version}catch(e){return null}}},3025:(e,t,n)=>{"use strict";n.d(t,{qg:()=>c,EJ:()=>l,xL:()=>u,bp:()=>d});var r=n(5435),s=n(7048);const i=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),Object.defineProperty(e,"message",{get:()=>JSON.stringify(t,s.k8,2),enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},a=(0,r.xI)("$ZodError",i),o=(0,r.xI)("$ZodError",i,{Parent:Error});const c=(e=>(t,n,i,a)=>{const o=i?Object.assign(i,{async:!1}):{async:!1},c=t._zod.run({value:n,issues:[]},o);if(c instanceof Promise)throw new r.GT;if(c.issues.length){const t=new(a?.Err??e)(c.issues.map(e=>s.iR(e,o,r.$W())));throw s.gx(t,a?.callee),t}return c.value})(o),l=(e=>async(t,n,i,a)=>{const o=i?Object.assign(i,{async:!0}):{async:!0};let c=t._zod.run({value:n,issues:[]},o);if(c instanceof Promise&&(c=await c),c.issues.length){const t=new(a?.Err??e)(c.issues.map(e=>s.iR(e,o,r.$W())));throw s.gx(t,a?.callee),t}return c.value})(o),u=(e=>(t,n,i)=>{const o=i?{...i,async:!1}:{async:!1},c=t._zod.run({value:n,issues:[]},o);if(c instanceof Promise)throw new r.GT;return c.issues.length?{success:!1,error:new(e??a)(c.issues.map(e=>s.iR(e,o,r.$W())))}:{success:!0,data:c.value}})(o),d=(e=>async(t,n,i)=>{const a=i?Object.assign(i,{async:!0}):{async:!0};let o=t._zod.run({value:n,issues:[]},a);return o instanceof Promise&&(o=await o),o.issues.length?{success:!1,error:new e(o.issues.map(e=>s.iR(e,a,r.$W())))}:{success:!0,data:o.value}})(o)},3263:(e,t,n)=>{"use strict";n.d(t,{d1:()=>i.d,hU:()=>a});var r=n(5721),s=n(9641),i=n(780);class a extends r.T{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?(0,s.U)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return(0,i.D)(e[0].text)}async parse(e){return(0,i.D)(e,JSON.parse)}getFormatInstructions(){return""}}},3279:(e,t,n)=>{"use strict";n.d(t,{Cf:()=>r.Cf,mu:()=>r.mu});var r=n(8028)},3290:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(228),s=n(6641),i=n(4774),a=()=>{},o=new s.TimeoutError;t.default=class extends r{constructor(e){var t,n,r,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=a,this._resolveIdle=a,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:i.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(s=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==s?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=a,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=a,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((n,r)=>{this._queue.enqueue(async()=>{this._pendingCount++,this._intervalCount++;try{const i=void 0===this._timeout&&void 0===t.timeout?e():s.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(o)});n(await i)}catch(e){r(e)}this._next()},t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async e=>this.add(e,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},3292:(e,t,n)=>{"use strict";n.d(t,{YN:()=>K,B2:()=>re,fJ:()=>W,jY:()=>ee,ck:()=>X,zZ:()=>Z,GH:()=>q,Bp:()=>ne});var r=n(2080),s=n(4116),i=n(9120),a=n(3389),o=n(6150),c=n(1590),l=n(58),u=n(7765);class d{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=(0,o.X6)({},t);return new h({ops:t,state:n[n.length-1].newDocument})}}class h extends d{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=(0,o.X6)(this.state,e.ops);return new h({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const t=(0,o.X6)({},e.ops);return new h({ops:e.ops,state:t[t.length-1].newDocument})}}const p=e=>"log_stream_tracer"===e.name;async function m(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=e;return["retriever","llm","prompt"].includes(e.run_type)?n:1!==Object.keys(n).length||""!==n?.input?n.input:void 0}async function g(e,t){const{outputs:n}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?n:void 0!==n&&1===Object.keys(n).length&&void 0!==n?.output?n.output:n}class f extends c.J{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=l.bO.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(n=n||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(n=n&&t.every(e=>!this.excludeTags?.includes(e))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new d({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new d({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(n.inputs=await m(e,this._schemaFormat)),await this.writer.write(new d({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const n=[];"streaming_events"===this._schemaFormat&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await m(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await g(e,this._schemaFormat)}),void 0!==e.end_time&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new d({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new d({ops:[{op:"replace",path:"/final_output",value:await g(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let s;var i;void 0!==e.inputs.messages?(i=n?.chunk,s=void 0!==i&&void 0!==i.message?n?.chunk:new u.H({id:`run-${e.id}`,content:t})):s=t;const a=new d({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:s}]});await this.writer.write(a)}}var y=n(8028);function _({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const b=e=>"event_stream_tracer"===e.name;class w extends c.J{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=l.bO.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(n=n||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(n=n&&t.every(e=>!this.excludeTags?.includes(e))),n}async*tapOutputIterable(e,t){const n=await t.next();if(n.done)return;const r=this.runInfoMap.get(e);if(void 0===r)return void(yield n.value);function s(e,t){return"llm"===e&&"string"==typeof t?new y.mu({text:t}):t}let i=this.tappedPromises.get(e);if(void 0===i){let a;i=new Promise(e=>{a=e}),this.tappedPromises.set(e,i);try{const i={event:`on_${r.runType}_stream`,run_id:e,name:r.name,tags:r.tags,metadata:r.metadata,data:{}};await this.send({...i,data:{chunk:s(r.runType,n.value)}},r),yield n.value;for await(const e of t)"tool"!==r.runType&&"retriever"!==r.runType&&await this.send({...i,data:{chunk:s(r.runType,e)}},r),yield e}finally{a()}}else{yield n.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const n=this.tappedPromises.get(e.run_id);void 0!==n?n.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){const t=_(e),n=void 0!==e.inputs.messages?"chat_model":"llm",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,r);const s=`on_${n}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onLLMNewToken(e,t,n){const r=this.runInfoMap.get(e.id);let s,i;if(void 0===r)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===r.runType)i="on_chat_model_stream",s=void 0===n?.chunk?new u.H({content:t,id:`run-${e.id}`}):n.chunk.message;else{if("llm"!==r.runType)throw new Error(`Unexpected run type ${r.runType}`);i="on_llm_stream",s=void 0===n?.chunk?new y.mu({text:t}):n.chunk}await this.send({event:i,data:{chunk:s},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let n;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const r=e.outputs?.generations;let s;if("chat_model"===t.runType){for(const e of r??[]){if(void 0!==s)break;s=e[0]?.message}n="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);s={generations:r?.map(e=>e.map(e=>({text:e.text,generationInfo:e.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},n="on_llm_end"}await this.sendEndEvent({event:n,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=_(e),n=e.run_type??"chain",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let s={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(s={},r.inputs={}):void 0!==e.inputs.input?(s.input=e.inputs.input,r.inputs=e.inputs.input):(s.input=e.inputs,r.inputs=e.inputs),this.runInfoMap.set(e.id,r),await this.send({event:`on_${n}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,r=e.inputs??t.inputs??{},s={output:e.outputs?.output??e.outputs,input:r};r.input&&1===Object.keys(r).length&&(s.input=r.input,t.inputs=r.input),await this.sendEndEvent({event:n,data:s,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=_(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},n)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=_(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,n),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){const r=this.runInfoMap.get(n);if(void 0===r)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:r.tags,metadata:r.metadata,data:t},r)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}var v=n(8999),E=n(9830),S=n(765),x=n(9624);class k extends c.J{constructor({config:e,onStart:t,onEnd:n,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function T(e){return!!e&&e.lc_runnable}class I{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(t)),void 0!==this.includeTags&&(n=n||r.some(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(n=n&&r.every(e=>!this.excludeTags?.includes(e))),n}}var O=n(4350);const C=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;const A=function(e){return"string"==typeof e&&C.test(e)};function P(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const M=["*","_","`"];function R(e,t,n){const{firstNode:r,lastNode:s,nodeColors:i,withStyles:a=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=n??{};let l=a?`%%{init: {'flowchart': {'curve': '${o}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(a){const t="default",n={[t]:"{0}({1})"};void 0!==r&&(n[r]="{0}([{1}]):::first"),void 0!==s&&(n[s]="{0}([{1}]):::last");for(const[r,s]of Object.entries(e)){const e=s.name.split(":").pop()??"";let i=M.some(t=>e.startsWith(t)&&e.endsWith(t))?`<p>${e}</p>`:e;Object.keys(s.metadata??{}).length&&(i+=`<hr/><small><em>${Object.entries(s.metadata??{}).map(([e,t])=>`${e} = ${t}`).join("\n")}</em></small>`);const a=(n[r]??n[t]).replace("{0}",P(r)).replace("{1}",i);l+=`\t${a}\n`}}const u={};for(const e of t){const t=e.source.split(":"),n=e.target.split(":"),r=t.filter((e,t)=>e===n[t]).join(":");u[r]||(u[r]=[]),u[r].push(e)}const d=new Set;function h(e,t){const n=1===e.length&&e[0].source===e[0].target;if(t&&!n){const e=t.split(":").pop();if(d.has(e))throw new Error(`Found duplicate subgraph '${e}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(e),l+=`\tsubgraph ${e}\n`}for(const t of e){const{source:e,target:n,data:r,conditional:s}=t;let i="";if(void 0!==r){let e=r;const t=e.split(" ");t.length>c&&(e=Array.from({length:Math.ceil(t.length/c)},(e,n)=>t.slice(n*c,(n+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),i=s?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --\x3e `}else i=s?" -.-> ":" --\x3e ";l+=`\t${P(e)}${i}${P(n)};\n`}for(const e in u)e.startsWith(`${t}:`)&&e!==t&&h(u[e],e);t&&!n&&(l+="\tend\n")}h(u[""]??[],"");for(const e in u)e.includes(":")||""===e||h(u[e],e);return a&&(l+=function(e){let t="";for(const[n,r]of Object.entries(e))t+=`\tclassDef ${n} ${r};\n`;return t}(i??{})),l}var $=n(7671);function j(e,t){if(void 0!==e&&!A(e))return e;if(!T(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch(e){return t.getName()}}function N(e){return T(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...(0,$.PF)(e.data.schema),title:e.data.name}}}class L{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,n)=>{e[t.id]=A(t.id)?n:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...N(t)})),edges:this.edges.map(t=>{const n={source:e[t.source],target:e[t.target]};return void 0!==t.data&&(n.data=t.data),void 0!==t.conditional&&(n.conditional=t.conditional),n})}}addNode(e,t,n){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const r=t??(0,i.A)(),s={id:r,data:e,name:j(t,e),metadata:n};return this.nodes[r]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,n,r){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const s={source:e.id,target:t.id,data:n,conditional:r};return this.edges.push(s),s}firstNode(){return D(this)}lastNode(){return U(this)}extend(e,t=""){let n=t;Object.values(e.nodes).map(e=>e.id).every(A)&&(n="");const r=e=>n?`${n}:${e}`:e;Object.entries(e.nodes).forEach(([e,t])=>{this.nodes[r(e)]={...t,id:r(e)}});const s=e.edges.map(e=>({...e,source:r(e.source),target:r(e.target)}));this.edges=[...this.edges,...s];const i=e.firstNode(),a=e.lastNode();return[i?{id:r(i.id),data:i.data}:void 0,a?{id:r(a.id),data:a.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&D(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&U(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(e=>[e.id,e.name])),t=new Map;Object.values(e).forEach(e=>{t.set(e,(t.get(e)||0)+1)});const n=n=>{const r=e[n];return A(n)&&1===t.get(r)?r:n};return new L({nodes:Object.fromEntries(Object.entries(this.nodes).map(([e,t])=>[n(e),{...t,id:n(e)}])),edges:this.edges.map(e=>({...e,source:n(e.source),target:n(e.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:n,nodeColors:r={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:s}=e??{},i=this.reid(),a=i.firstNode(),o=i.lastNode();return R(i.nodes,i.edges,{firstNode:a?.id,lastNode:o?.id,withStyles:t,curveStyle:n,nodeColors:r,wrapLabelNWords:s})}async drawMermaidPng(e){return async function(e,t){let{backgroundColor:n="white"}=t??{};const r=btoa(e);void 0!==n&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const s=`https://mermaid.ink/img/${r}?bgColor=${n}`,i=await fetch(s);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join("\n"));return await i.blob()}(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function D(e,t=[]){const n=new Set(e.edges.filter(e=>!t.includes(e.source)).map(e=>e.target)),r=[];for(const s of Object.values(e.nodes))t.includes(s.id)||n.has(s.id)||r.push(s);return 1===r.length?r[0]:void 0}function U(e,t=[]){const n=new Set(e.edges.filter(e=>!t.includes(e.target)).map(e=>e.source)),r=[];for(const s of Object.values(e.nodes))t.includes(s.id)||n.has(s.id)||r.push(s);return 1===r.length?r[0]:void 0}function F(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function Y(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*G(e,t){for(;;){const{value:n,done:r}=O.Nx.runWithConfig((0,S.DY)(e),t.next.bind(t),!0);if(r)break;yield n}}async function*B(e,t){const n=t[Symbol.asyncIterator]();for(;;){const{value:r,done:s}=await O.Nx.runWithConfig((0,S.DY)(e),n.next.bind(t),!0);if(s)break;yield r}}var H=n(199),z=n(7942);function q(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class K extends v.y{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new W({bound:this,kwargs:e,config:{}})}map(){return new V({bound:this})}withRetry(e){return new J({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new W({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new te({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(S.ZI);if(t>1&&!Array.isArray(e)&&e.runId){const n=Object.fromEntries(Object.entries(e).filter(([e])=>"runId"!==e));return Array.from({length:t},(t,r)=>(0,S.ZI)(0===r?e:n))}return Array.from({length:t},()=>(0,S.ZI)(e))}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),s=r[0]?.maxConcurrency??n?.maxConcurrency,i=new x.g({maxConcurrency:s,onFailedAttempt:e=>{throw e}}),a=e.map((e,t)=>i.call(async()=>{try{return await this.invoke(e,r[t])}catch(e){if(n?.returnExceptions)return e;throw e}}));return Promise.all(a)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=(0,S.ZI)(t),r=new l.Tr({generator:this._streamIterator(e,n),config:n});return await r.setup,l.bO.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;t=void 0===e?(0,S.ZI)(e):(0,S.ZI)({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[t,n]}async _callWithConfig(e,t,n){const r=(0,S.ZI)(n),s=await(0,S.kJ)(r),i=await(s?.handleChainStart(this.toJSON(),q(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let a;delete r.runId;try{const s=e.call(this,t,r,i);a=await(0,E.o)(s,n?.signal)}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(q(a,"output"))),a}async _batchWithConfig(e,t,n,r){const s=this._getOptionsList(n??{},t.length),i=await Promise.all(s.map(S.kJ)),a=await Promise.all(i.map(async(e,n)=>{const r=await(e?.handleChainStart(this.toJSON(),q(t[n],"input"),s[n].runId,s[n].runType,void 0,void 0,s[n].runName??this.getName()));return delete s[n].runId,r}));let o;try{const n=e.call(this,t,s,a,r);o=await(0,E.o)(n,s?.[0]?.signal)}catch(e){throw await Promise.all(a.map(t=>t?.handleChainError(e))),e}return await Promise.all(a.map(e=>e?.handleChainEnd(q(o,"output")))),o}_concatOutputChunks(e,t){return(0,l.xW)(e,t)}async*_transformStreamWithConfig(e,t,n){let r,s,i=!0,a=!0;const o=(0,S.ZI)(n),c=await(0,S.kJ)(o),u=this;let d;try{const h=await(0,l.DS)(t.bind(this),async function*(){for await(const t of e){if(i)if(void 0===r)r=t;else try{r=u._concatOutputChunks(r,t)}catch{r=void 0,i=!1}yield t}}(),async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName()),n?.signal,o);delete o.runId,d=h.setup;const m=d?.handlers.find(b);let g=h.output;void 0!==m&&void 0!==d&&(g=m.tapOutputIterable(d.runId,g));const f=d?.handlers.find(p);void 0!==f&&void 0!==d&&(g=f.tapOutputIterable(d.runId,g));for await(const e of g)if(yield e,a)if(void 0===s)s=e;else try{s=this._concatOutputChunks(s,e)}catch{s=void 0,a=!1}}catch(e){throw await(d?.handleChainError(e,void 0,void 0,void 0,{inputs:q(r,"input")})),e}await(d?.handleChainEnd(s??{},void 0,void 0,void 0,{inputs:q(r,"input")}))}getGraph(e){const t=new L,n=t.addNode({name:`${this.getName()}Input`,schema:r.bz()}),s=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:r.bz()});return t.addEdge(n,s),t.addEdge(s,i),t}pipe(e){return new Z({first:this,last:ne(e)})}pick(e){return this.pipe(new se(e))}assign(e){return this.pipe(new re(new X({steps:e})))}async*transform(e,t){let n;for await(const t of e)n=void 0===n?t:this._concatOutputChunks(n,t);yield*this._streamIterator(n,(0,S.ZI)(t))}async*streamLog(e,t,n){const r=new f({...n,autoClose:!1,_schemaFormat:"original"}),s=(0,S.ZI)(t);yield*this._streamLog(e,r,s)}async*_streamLog(e,t,n){const{callbacks:r}=n;if(void 0===r)n.callbacks=[t];else if(Array.isArray(r))n.callbacks=r.concat([t]);else{const e=r.copy();e.addHandler(t,!0),n.callbacks=e}const s=this.stream(e,n);const i=async function(){try{const e=await s;for await(const n of e){const e=new d({ops:[{op:"add",path:"/streamed_output/-",value:n}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await i}}streamEvents(e,t,n){let r;if("v1"===t.version)r=this._streamEventsV1(e,t,n);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');r=this._streamEventsV2(e,t,n)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,n=new ReadableStream({async start(n){for await(const r of e)n.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));n.enqueue(t.encode("event: end\n\n")),n.close()}});return l.bO.fromReadableStream(n)}(r):l.bO.fromAsyncGenerator(r)}async*_streamEventsV2(e,t,n){const r=new w({...n,autoClose:!1}),s=(0,S.ZI)(t),a=s.runId??(0,i.A)();s.runId=a;const o=s.callbacks;if(void 0===o)s.callbacks=[r];else if(Array.isArray(o))s.callbacks=o.concat(r);else{const e=o.copy();e.addHandler(r,!0),s.callbacks=e}const c=new AbortController,l=this;const u=async function(){let n,i=null;try{t?.signal?"any"in AbortSignal?n=AbortSignal.any([c.signal,t.signal]):(n=t.signal,i=()=>{c.abort()},t.signal.addEventListener("abort",i,{once:!0})):n=c.signal;const o=await l.stream(e,{...s,signal:n}),u=r.tapOutputIterable(a,o);for await(const e of u)if(c.signal.aborted)break}finally{await r.finish(),n&&i&&n.removeEventListener("abort",i)}}();let d,h=!1;try{for await(const t of r)h?(t.run_id===d&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,h=!0,d=t.run_id,yield t)}finally{c.abort(),await u}}async*_streamEventsV1(e,t,n){let r,s=!1;const i=(0,S.ZI)(t),a=i.tags??[],o=i.metadata??{},c=i.runName??this.getName(),l=new f({...n,autoClose:!1,_schemaFormat:"streaming_events"}),u=new I({...n}),d=this._streamLog(e,l,i);for await(const t of d){if(r=r?r.concat(t):h.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;const t={...r.state},n={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:a,metadata:o,data:{input:e}};u.includeEvent(n,t.type)&&(yield n)}const n=t.ops.filter(e=>e.path.startsWith("/logs/")).map(e=>e.path.split("/")[2]),i=[...new Set(n)];for(const e of i){let t,n={};const s=r.state.logs[e];if(t=void 0===s.end_time?s.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==s.inputs&&(n.input=s.inputs);else if("end"===t)void 0!==s.inputs&&(n.input=s.inputs),n.output=s.final_output;else if("stream"===t){const e=s.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${s.name}"`);n={chunk:s.streamed_output[0]},s.streamed_output=[]}yield{event:`on_${s.type}_${t}`,name:s.name,run_id:s.id,tags:s.tags,metadata:s.metadata,data:n}}const{state:l}=r;if(l.streamed_output.length>0){const e=l.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${l.name}"`);const t={chunk:l.streamed_output[0]};l.streamed_output=[];const n={event:`on_${l.type}_stream`,run_id:l.id,tags:a,metadata:o,name:c,data:t};u.includeEvent(n,l.type)&&(yield n)}}const p=r?.state;if(void 0!==p){const e={event:`on_${p.type}_end`,name:c,run_id:p.id,tags:a,metadata:o,data:{output:p.final_output}};u.includeEvent(e,p.type)&&(yield e)}}static isRunnable(e){return T(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new W({bound:this,config:{},configFactories:[r=>({callbacks:[new k({config:r,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return function(e,t){const n=t.name??e.getName(),s=t.description??(0,z.cg)(t.schema);if((0,z.yQ)(t.schema))return new ie({name:n,description:s,schema:r.Ik({input:r.Yj()}).transform(e=>e.input),bound:e});return new ie({name:n,description:s,schema:t.schema,bound:e})}(this,e)}}class W extends K{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=(0,S.SV)(this.config,...e);return(0,S.SV)(t,...this.configFactories?await Promise.all(this.configFactories.map(async e=>await e(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new J({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig((0,S.ZI)(t),this.kwargs))}async batch(e,t,n){const r=Array.isArray(t)?await Promise.all(t.map(async e=>this._mergeConfig((0,S.ZI)(e),this.kwargs))):await this._mergeConfig((0,S.ZI)(t),this.kwargs);return this.bound.batch(e,r,n)}_concatOutputChunks(e,t){return this.bound._concatOutputChunks(e,t)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig((0,S.ZI)(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig((0,S.ZI)(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig((0,S.ZI)(t),this.kwargs))}streamEvents(e,t,n){const r=this;return l.bO.fromAsyncGenerator(async function*(){yield*r.bound.streamEvents(e,{...await r._mergeConfig((0,S.ZI)(t),r.kwargs),version:t.version},n)}())}static isRunnableBinding(e){return e.bound&&K.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new W({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new k({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class V extends K{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new V({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,n){return this.bound.batch(e,(0,S.tn)(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new V({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class J extends W{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const r=e>1?`retry:attempt:${e}`:void 0;return(0,S.tn)(t,{callbacks:n?.getChild(r)})}async _invoke(e,t,n){return s(r=>super.invoke(e,this._patchConfigForRetry(r,t,n)),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,n,r){const i={};try{await s(async s=>{const a=e.map((e,t)=>t).filter(e=>void 0===i[e.toString()]||i[e.toString()]instanceof Error),o=a.map(t=>e[t]),c=a.map(e=>this._patchConfigForRetry(s,t?.[e],n?.[e])),l=await super.batch(o,c,{...r,returnExceptions:!0});let u;for(let e=0;e<l.length;e+=1){const t=l[e],n=a[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),i[n.toString()]=t}if(u)throw u;return l},{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(i).sort((e,t)=>parseInt(e,10)-parseInt(t,10)).map(e=>i[parseInt(e,10)])}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class Z extends K{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=(0,S.ZI)(t),r=await(0,S.kJ)(n),s=await(r?.handleChainStart(this.toJSON(),q(e,"input"),n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;let i,a=e;try{const e=[this.first,...this.middle];for(let r=0;r<e.length;r+=1){const i=e[r].invoke(a,(0,S.tn)(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${r+1}`)}));a=await(0,E.o)(i,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");i=await this.last.invoke(a,(0,S.tn)(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(q(i,"output"))),i}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),s=await Promise.all(r.map(S.kJ)),i=await Promise.all(s.map(async(t,n)=>{const s=await(t?.handleChainStart(this.toJSON(),q(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,s}));let a=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e].batch(a,i.map((t,n)=>{const s=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return(0,S.tn)(r[n],{callbacks:s})}),n);a=await(0,E.o)(t,r[0]?.signal)}}catch(e){throw await Promise.all(i.map(t=>t?.handleChainError(e))),e}return await Promise.all(i.map(e=>e?.handleChainEnd(q(a,"output")))),a}_concatOutputChunks(e,t){return this.last._concatOutputChunks(e,t)}async*_streamIterator(e,t){const n=await(0,S.kJ)(t),{runId:r,...s}=t??{},i=await(n?.handleChainStart(this.toJSON(),q(e,"input"),r,void 0,void 0,void 0,s?.runName)),a=[this.first,...this.middle,this.last];let o,c=!0;try{let n=a[0].transform(async function*(){yield e}(),(0,S.tn)(s,{callbacks:i?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let e=1;e<a.length;e+=1){const t=a[e];n=await t.transform(n,(0,S.tn)(s,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`)}))}for await(const e of n)if(t?.signal?.throwIfAborted(),yield e,c)if(void 0===o)o=e;else try{o=this._concatOutputChunks(o,e)}catch(e){o=void 0,c=!1}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(q(o,"output")))}getGraph(e){const t=new L;let n=null;return this.steps.forEach((r,s)=>{const i=r.getGraph(e);0!==s&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const a=i.firstNode();if(!a)throw new Error(`Runnable ${r} has no first node`);n&&t.addEdge(n,a),n=i.lastNode()}),t}pipe(e){return Z.isRunnableSequence(e)?new Z({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Z({first:this.first,middle:[...this.middle,this.last],last:ne(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&K.isRunnable(e)}static from([e,...t],n){let r={};return"string"==typeof n?r.name=n:void 0!==n&&(r=n),new Z({...r,first:ne(e),middle:t.slice(0,-1).map(ne),last:ne(t[t.length-1])})}}class X extends K{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=ne(n)}static from(e){return new X({steps:e})}async invoke(e,t){const n=(0,S.ZI)(t),r=await(0,S.kJ)(n),s=await(r?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;const i={};try{const r=Object.entries(this.steps).map(async([t,r])=>{i[t]=await r.invoke(e,(0,S.tn)(n,{callbacks:s?.getChild(`map:key:${t}`)}))});await(0,E.o)(Promise.all(r),t?.signal)}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(i)),i}async*_transform(e,t,n){const r={...this.steps},s=(0,l.gI)(e,Object.keys(r).length),i=new Map(Object.entries(r).map(([e,r],i)=>{const a=r.transform(s[i],(0,S.tn)(n,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,a.next().then(t=>({key:e,gen:a,result:t}))]}));for(;i.size;){const e=Promise.race(i.values()),{key:t,result:r,gen:s}=await(0,E.o)(e,n?.signal);i.delete(t),r.done||(yield{[t]:r.value},i.set(t,s.next().then(e=>({key:t,gen:s,result:e}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=(0,S.ZI)(t),r=new l.Tr({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,l.bO.fromAsyncGenerator(r)}}class Q extends K{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!(0,a.GZ)(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[n]=this._getOptionsList(t??{},1),r=await(0,S.kJ)(n),s=this.func((0,S.tn)(n,{callbacks:r}),e);return(0,E.o)(s,n?.signal)}async*_streamIterator(e,t){const[n]=this._getOptionsList(t??{},1),r=await this.invoke(e,t);var s;if(Y(r))for await(const e of r)n?.signal?.throwIfAborted(),yield e;else if(null!=(s=r)&&"object"==typeof s&&"next"in s&&"function"==typeof s.next)for(;;){n?.signal?.throwIfAborted();const e=r.next();if(e.done)break;yield e.value}else yield r}static from(e){return new Q({func:e})}}class ee extends K{static lc_name(){return"RunnableLambda"}constructor(e){if((0,a.GZ)(e.func))return Q.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){if((0,a.GZ)(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(e){return new ee({func:e})}async _invoke(e,t,n){return new Promise((r,s)=>{const i=(0,S.tn)(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??S.p_)-1});O.Nx.runWithConfig((0,S.DY)(i),async()=>{try{let n=await this.func(e,{...i});if(n&&K.isRunnable(n)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");n=await n.invoke(e,{...i,recursionLimit:(i.recursionLimit??S.p_)-1})}else if(Y(n)){let e;for await(const r of B(i,n))if(t?.signal?.throwIfAborted(),void 0===e)e=r;else try{e=this._concatOutputChunks(e,r)}catch(t){e=r}n=e}else if(F(n)){let e;for(const r of G(i,n))if(t?.signal?.throwIfAborted(),void 0===e)e=r;else try{e=this._concatOutputChunks(e,r)}catch(t){e=r}n=e}r(n)}catch(e){s(e)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,n){let r;for await(const t of e)if(void 0===r)r=t;else try{r=this._concatOutputChunks(r,t)}catch(e){r=t}const s=(0,S.tn)(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??S.p_)-1}),i=await new Promise((e,t)=>{O.Nx.runWithConfig((0,S.DY)(s),async()=>{try{const t=await this.func(r,{...s,config:s});e(t)}catch(e){t(e)}})});if(i&&K.isRunnable(i)){if(0===n?.recursionLimit)throw new Error("Recursion limit reached.");const e=await i.stream(r,s);for await(const t of e)yield t}else if(Y(i))for await(const e of B(s,i))n?.signal?.throwIfAborted(),yield e;else if(F(i))for(const e of G(s,i))n?.signal?.throwIfAborted(),yield e;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=(0,S.ZI)(t),r=new l.Tr({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,l.bO.fromAsyncGenerator(r)}}class te extends K{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=(0,S.ZI)(t),r=await(0,S.kJ)(n),{runId:s,...i}=n,a=await(r?.handleChainStart(this.toJSON(),q(e,"input"),s,void 0,void 0,void 0,i?.runName)),o=(0,S.tn)(i,{callbacks:a?.getChild()});return await O.Nx.runWithConfig(o,async()=>{let t;for(const r of this.runnables()){n?.signal?.throwIfAborted();try{const t=await r.invoke(e,o);return await(a?.handleChainEnd(q(t,"output"))),t}catch(e){void 0===t&&(t=e)}}if(void 0===t)throw new Error("No error stored at end of fallback.");throw await(a?.handleChainError(t)),t})}async*_streamIterator(e,t){const n=(0,S.ZI)(t),r=await(0,S.kJ)(n),{runId:s,...i}=n,a=await(r?.handleChainStart(this.toJSON(),q(e,"input"),s,void 0,void 0,void 0,i?.runName));let o,c,l;for(const t of this.runnables()){n?.signal?.throwIfAborted();const r=(0,S.tn)(i,{callbacks:a?.getChild()});try{c=B(r,await t.stream(e,r));break}catch(e){void 0===o&&(o=e)}}if(void 0===c){const e=o??new Error("No error stored at end of fallback.");throw await(a?.handleChainError(e)),e}try{for await(const e of c){yield e;try{l=void 0===l?l:this._concatOutputChunks(l,e)}catch(e){l=void 0}}}catch(e){throw await(a?.handleChainError(e)),e}await(a?.handleChainEnd(q(l,"output")))}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),s=await Promise.all(r.map(e=>(0,S.kJ)(e))),i=await Promise.all(s.map(async(t,n)=>{const s=await(t?.handleChainStart(this.toJSON(),q(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,s}));let a;for(const t of this.runnables()){r[0].signal?.throwIfAborted();try{const s=await t.batch(e,i.map((e,t)=>(0,S.tn)(r[t],{callbacks:e?.getChild()})),n);return await Promise.all(i.map((e,t)=>e?.handleChainEnd(q(s[t],"output")))),s}catch(e){void 0===a&&(a=e)}}if(!a)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(i.map(e=>e?.handleChainError(a))),a}}function ne(e){if("function"==typeof e)return new ee({func:e});if(K.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[n,r]of Object.entries(e))t[n]=ne(r);return new X({steps:t})}}class re extends K{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof X&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const r=this.mapper.getStepsKeys(),[s,i]=(0,l.gI)(e),a=this.mapper.transform(i,(0,S.tn)(n,{callbacks:t?.getChild()})),o=a.next();for await(const e of s){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter(([e])=>!r.includes(e)));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of a)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=(0,S.ZI)(t),r=new l.Tr({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,l.bO.fromAsyncGenerator(r)}}class se extends K{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map(t=>[t,e[t]]).filter(e=>void 0!==e[1]);return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=(0,S.ZI)(t),r=new l.Tr({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,l.bO.fromAsyncGenerator(r)}}class ie extends W{constructor(e){super({bound:Z.from([ee.from(async e=>{let t;if((0,H.Ky)(e))try{t=await(0,z.hZ)(this.schema,e.args)}catch(t){throw new H.qe("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}},3389:(e,t,n)=>{"use strict";n.d(t,{vR:()=>a,GZ:()=>o});const r=Symbol.for("ls:tracing_async_local_storage"),s=new class{getStore(){}run(e,t){return t()}};const i=new class{getInstance(){return globalThis[r]??s}initializeGlobalInstance(e){void 0===globalThis[r]&&(globalThis[r]=e)}};function a(e=!1){const t=i.getInstance().getStore();if(!e&&void 0===t)throw new Error("Could not get the current run tree.\n\nPlease make sure you are calling this method within a traceable function and that tracing is enabled.");return t}Symbol.for("langsmith:traceable:root");function o(e){return"function"==typeof e&&"langsmith:traceable"in e}},3490:(e,t,n)=>{"use strict";n.d(t,{AJ:()=>m,F7:()=>u,Iv:()=>a,Vt:()=>l,XQ:()=>o,_I:()=>i,dp:()=>h,gj:()=>d,ns:()=>c,ny:()=>p});var r=n(8999),s=n(4291);function i(e,t){return"string"==typeof e?""===e?t:"string"==typeof t?e+t:Array.isArray(t)&&t.some(e=>(0,s.Fz)(e))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?l(e,t)??[...e,...t]:""===t?e:Array.isArray(e)&&e.some(e=>(0,s.Fz)(e))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}function a(e,t){return"error"===e||"error"===t?"error":"success"}class o extends r.y{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:Array.isArray(this.content)?this.content.map(e=>"string"==typeof e?e:"text"===e.type?e.text:"").join(""):""}getType(){return this._getType()}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(null===e)return this;const t=(n=this._printableFields,r=Math.max(4,e),JSON.stringify(function e(t,n){if("object"!=typeof t||null==t)return t;if(n>=r)return Array.isArray(t)?"[Array]":"[Object]";if(Array.isArray(t))return t.map(t=>e(t,n+1));const s={};for(const r of Object.keys(t))s[r]=e(t[r],n+1);return s}(n,0),null,2));var n,r;return`${this.constructor.lc_name()} ${t}`}}function c(e,t){const n={...e};for(const[e,r]of Object.entries(t))if(null==n[e])n[e]=r;else{if(null==r)continue;if(typeof n[e]!=typeof r||Array.isArray(n[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof n[e]){if("type"===e)continue;n[e]+=r}else if("object"!=typeof n[e]||Array.isArray(n[e])){if(Array.isArray(n[e]))n[e]=l(n[e],r);else if(n[e]===r)continue}else n[e]=c(n[e],r)}return n}function l(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const n=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=n.findIndex(t=>t.index===e.index);-1!==t?n[t]=c(n[t],e):n.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;n.push(e)}return n}}}function u(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(e&&t){if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.\nLeft ${typeof e}\nRight ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return l(e,t);if("object"==typeof e&&"object"==typeof t)return c(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.\nLeft ${e}\nRight ${t}`)}return e||t}class d extends o{}function h(e){return"string"==typeof e.role}function p(e){return"function"==typeof e?._getType}function m(e){return p(e)&&"function"==typeof e.concat}},3795:(e,t,n)=>{"use strict";n.d(t,{fd:()=>i,rs:()=>r});Symbol("ZodOutput"),Symbol("ZodInput");class r{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){const n=t[0];if(this._map.set(e,n),n&&"object"==typeof n&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const n={...this.get(t)??{}};return delete n.id,{...n,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function s(){return new r}const i=s()},3874:(e,t,n)=>{"use strict";const r=n(8311);e.exports=(e,t)=>{try{return new r(e,t).range||"*"}catch(e){return null}}},3904:(e,t,n)=>{"use strict";const r=Symbol("SemVer ANY");class s{static get ANY(){return r}constructor(e,t){if(t=i(t),e instanceof s){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),l("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===r?this.value="":this.value=this.operator+this.semver.version,l("comp",this)}parse(e){const t=this.options.loose?a[o.COMPARATORLOOSE]:a[o.COMPARATOR],n=e.match(t);if(!n)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==n[1]?n[1]:"","="===this.operator&&(this.operator=""),n[2]?this.semver=new u(n[2],this.options.loose):this.semver=r}toString(){return this.value}test(e){if(l("Comparator.test",e,this.options.loose),this.semver===r||e===r)return!0;if("string"==typeof e)try{e=new u(e,this.options)}catch(e){return!1}return c(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof s))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new d(e.value,t).test(this.value):""===e.operator?""===e.value||new d(this.value,t).test(e.semver):(!(t=i(t)).includePrerelease||"<0.0.0-0"!==this.value&&"<0.0.0-0"!==e.value)&&(!(!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0")))&&(!(!this.operator.startsWith(">")||!e.operator.startsWith(">"))||(!(!this.operator.startsWith("<")||!e.operator.startsWith("<"))||(!(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))||(!!(c(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))||!!(c(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))))))}}e.exports=s;const i=n(8587),{safeRe:a,t:o}=n(9718),c=n(2111),l=n(7272),u=n(3908),d=n(8311)},3908:(e,t,n)=>{"use strict";const r=n(7272),{MAX_LENGTH:s,MAX_SAFE_INTEGER:i}=n(6874),{safeRe:a,t:o}=n(9718),c=n(8587),{compareIdentifiers:l}=n(1123);class u{constructor(e,t){if(t=c(t),e instanceof u){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>s)throw new TypeError(`version is longer than ${s} characters`);r("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const n=e.trim().match(t.loose?a[o.LOOSE]:a[o.FULL]);if(!n)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>i||this.major<0)throw new TypeError("Invalid major version");if(this.minor>i||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>i||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map(e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<i)return t}return e}):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(r("SemVer.compare",this.version,this.options,e),!(e instanceof u)){if("string"==typeof e&&e===this.version)return 0;e=new u(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof u||(e=new u(e,this.options)),l(this.major,e.major)||l(this.minor,e.minor)||l(this.patch,e.patch)}comparePre(e){if(e instanceof u||(e=new u(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const n=this.prerelease[t],s=e.prerelease[t];if(r("prerelease compare",t,n,s),void 0===n&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===n)return-1;if(n!==s)return l(n,s)}while(++t)}compareBuild(e){e instanceof u||(e=new u(e,this.options));let t=0;do{const n=this.build[t],s=e.build[t];if(r("build compare",t,n,s),void 0===n&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===n)return-1;if(n!==s)return l(n,s)}while(++t)}inc(e,t,n){if(e.startsWith("pre")){if(!t&&!1===n)throw new Error("invalid increment argument: identifier is empty");if(t){const e=`-${t}`.match(this.options.loose?a[o.PRERELEASELOOSE]:a[o.PRERELEASE]);if(!e||e[1]!==t)throw new Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,n),this.inc("pre",t,n);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,n),this.inc("pre",t,n);break;case"release":if(0===this.prerelease.length)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(n)?1:0;if(0===this.prerelease.length)this.prerelease=[e];else{let r=this.prerelease.length;for(;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);if(-1===r){if(t===this.prerelease.join(".")&&!1===n)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let r=[t,e];!1===n&&(r=[t]),0===l(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=r):this.prerelease=r}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}e.exports=u},3927:(e,t,n)=>{"use strict";const r=n(909);e.exports=(e,t)=>e.sort((e,n)=>r(e,n,t))},3961:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},n),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){this.attempt(e)},t.prototype.start=function(e){this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var s=this._errors[r],i=s.message,a=(e[i]||0)+1;e[i]=a,a>=n&&(t=s,n=a)}return t}},3999:(e,t,n)=>{"use strict";const r=n(560);e.exports=(e,t,n)=>0!==r(e,t,n)},4089:(e,t,n)=>{"use strict";const r=n(560);e.exports=(e,t,n)=>r(e,t,n)>=0},4104:(e,t,n)=>{"use strict";n.d(t,{DM:()=>h,G4:()=>d,MY:()=>o,OK:()=>u,fn:()=>p,jm:()=>l,uY:()=>c,xP:()=>m,y7:()=>i,zn:()=>a});var r=n(7958),s=n(342);const i=e=>{const{data:t,path:n,errorMaps:r,issueData:s}=e,i=[...n,...s.path||[]],a={...s,path:i};if(void 0!==s.message)return{...s,path:i,message:s.message};let o="";const c=r.filter(e=>!!e).slice().reverse();for(const e of c)o=e(a,{data:t,defaultError:o}).message;return{...s,path:i,message:o}};function a(e,t){const n=(0,r.$W)(),a=i({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===s.A?void 0:s.A].filter(e=>!!e)});e.common.issues.push(a)}class o{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return c;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return o.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:s}=r;if("aborted"===t.status)return c;if("aborted"===s.status)return c;"dirty"===t.status&&e.dirty(),"dirty"===s.status&&e.dirty(),"__proto__"===t.value||void 0===s.value&&!r.alwaysSet||(n[t.value]=s.value)}return{status:e.value,value:n}}}const c=Object.freeze({status:"aborted"}),l=e=>({status:"dirty",value:e}),u=e=>({status:"valid",value:e}),d=e=>"aborted"===e.status,h=e=>"dirty"===e.status,p=e=>"valid"===e.status,m=e=>"undefined"!=typeof Promise&&e instanceof Promise},4116:(e,t,n)=>{"use strict";const r=n(5617),s=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class i extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const a=(e,t)=>new Promise((n,a)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=r.operation(t);o.attempt(async r=>{try{n(await e(r))}catch(e){if(!(e instanceof Error))return void a(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof i)o.stop(),a(e.originalError);else if(e instanceof TypeError&&(c=e.message,!s.includes(c)))o.stop(),a(e);else{((e,t,n)=>{const r=n.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,r,t);try{await t.onFailedAttempt(e)}catch(e){return void a(e)}o.retry(e)||a(o.mainError())}}var c})});e.exports=a,e.exports.default=a,e.exports.AbortError=i},4277:(e,t,n)=>{"use strict";const r=n(909);e.exports=(e,t)=>e.sort((e,n)=>r(n,e,t))},4291:(e,t,n)=>{"use strict";function r(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"source_type"in e&&("url"===e.source_type||"base64"===e.source_type||"text"===e.source_type||"id"===e.source_type)}function s(e){return r(e)&&"url"===e.source_type&&"url"in e&&"string"==typeof e.url}function i(e){return r(e)&&"base64"===e.source_type&&"data"in e&&"string"==typeof e.data}function a(e){if(r(e)){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url}};if("base64"===e.source_type){if(!e.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${e.mime_type};base64,${e.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function o(e){const t=e.split(";")[0].split("/");if(2!==t.length)throw new Error(`Invalid mime type: "${e}" - does not match type/subtype format.`);const n=t[0].trim(),r=t[1].trim();if(""===n||""===r)throw new Error(`Invalid mime type: "${e}" - type or subtype is empty.`);const s={};for(const t of e.split(";").slice(1)){const n=t.split("=");if(2!==n.length)throw new Error(`Invalid parameter syntax in mime type: "${e}".`);const r=n[0].trim(),i=n[1].trim();if(""===r)throw new Error(`Invalid parameter syntax in mime type: "${e}".`);s[r]=i}return{type:n,subtype:r,parameters:s}}function c({dataUrl:e,asTypedArray:t=!1}){const n=e.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let r;if(n){r=n[1].toLowerCase();return{mime_type:r,data:t?Uint8Array.from(atob(n[2]),e=>e.charCodeAt(0)):n[2]}}}function l(e,t){if("text"===e.type){if(!t.fromStandardTextBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardTextBlock\` method.`);return t.fromStandardTextBlock(e)}if("image"===e.type){if(!t.fromStandardImageBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardImageBlock\` method.`);return t.fromStandardImageBlock(e)}if("audio"===e.type){if(!t.fromStandardAudioBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardAudioBlock\` method.`);return t.fromStandardAudioBlock(e)}if("file"===e.type){if(!t.fromStandardFileBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardFileBlock\` method.`);return t.fromStandardFileBlock(e)}throw new Error(`Unable to convert content block type '${e.type}' to provider-specific format: not recognized.`)}n.d(t,{Ej:()=>o,Fz:()=>r,Q7:()=>c,Vi:()=>a,W:()=>s,cJ:()=>i,up:()=>l})},4301:(e,t,n)=>{"use strict";n.d(t,{XU:()=>i,cM:()=>s});var r=n(3490);class s extends r.XQ{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return s}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}get _printableFields(){return{...super._printableFields,role:this.role}}}class i extends r.gj{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new i({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}},4350:(e,t,n)=>{"use strict";n.d(t,{Nx:()=>c});var r=n(1259),s=n(6968),i=n(9149);const a=new class{getStore(){}run(e,t){return t()}enterWith(e){}},o=Symbol.for("lc:child_config");const c=new class{getInstance(){return(0,s.X0)()??a}getRunnableConfig(){const e=this.getInstance();return e.getStore()?.extra?.[o]}runWithConfig(e,t,n){const a=i.Td._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),c=this.getInstance(),l=c.getStore(),u=a?.getParentRunId(),d=a?.handlers?.find(e=>"langchain_tracer"===e?.name);let h;return d&&u?h=d.getRunTreeWithTracingConfig(u):n||(h=new r.gk({name:"<runnable_lambda>",tracingEnabled:!1})),h&&(h.extra={...h.extra,[o]:e}),void 0!==l&&void 0!==l[s.hr]&&(void 0===h&&(h={}),h[s.hr]=l[s.hr]),c.run(h,t)}initializeGlobalInstance(e){void 0===(0,s.X0)()&&(0,s.pH)(e)}}},4493:(e,t,n)=>{"use strict";const r=n(3908);e.exports=(e,t)=>new r(e,t).patch},4508:(e,t,n)=>{"use strict";n.d(t,{YN:()=>r.YN,jY:()=>r.jY,kI:()=>s.k,zZ:()=>r.zZ});var r=n(3292),s=(n(765),n(2037));r.YN;n(58);r.YN;n(1673);r.fJ},4617:e=>{"use strict";e.exports=(e,t)=>(t=t||(()=>{}),e.then(e=>new Promise(e=>{e(t())}).then(()=>e),e=>new Promise(e=>{e(t())}).then(()=>{throw e})))},4640:e=>{"use strict";var t,n=Object.defineProperty,r=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};function o(e,t){if(e?.request?.headers){if(!(e.request.headers instanceof Headers))throw new Error("request.headers must be an instance of Headers");const n=[];for(const[r,s]of e.request.headers)t.set("x-middleware-request-"+r,s),n.push(r);t.set("x-middleware-override-headers",n.join(","))}}function c(e,t){const n=new Headers(t?.headers??{});return n.set("x-middleware-rewrite",String(e)),o(t,n),new Response(null,{...t,headers:n})}function l(e){const t=new Headers(e?.headers??{});return t.set("x-middleware-next","1"),o(e,t),new Response(null,{...e,headers:t})}((e,t)=>{for(var r in t)n(e,r,{get:t[r],enumerable:!0})})(a,{next:()=>l,rewrite:()=>c}),e.exports=(t=a,((e,t,a,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let c of s(t))i.call(e,c)||c===a||n(e,c,{get:()=>t[c],enumerable:!(o=r(t,c))||o.enumerable});return e})(n({},"__esModule",{value:!0}),t))},4641:(e,t,n)=>{"use strict";const r=n(560);e.exports=(e,t,n)=>0===r(e,t,n)},4774:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9998);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const s=r.default(this._queue,n,(e,t)=>t.priority-e.priority);this._queue.splice(s,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(e=>e.run)}get size(){return this._queue.length}}},4785:(e,t,n)=>{"use strict";n.d(t,{Az:()=>h,Ec:()=>l,Jz:()=>p,QK:()=>m,_$:()=>a,yk:()=>u});var r=n(6928);let s;const i=()=>"undefined"!=typeof Deno,a=()=>s||(s="undefined"!=typeof Bun?"bun":"undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||i()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom")?"jsdom":i()?"deno":"other":"node",s);let o,c;function l(){if(void 0===o){const e=a(),t=function(){if(void 0!==c)return c;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const n of e){const e=h(n);void 0!==e&&(t[n]=e)}return c=t,t}();o={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:r.Ls,...t}}return o}function u(){const e=d()||{},t={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,s]of Object.entries(e))!r.startsWith("LANGCHAIN_")&&!r.startsWith("LANGSMITH_")||"string"!=typeof s||n.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=s:t[r]=s);return t}function d(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce((e,[t,n])=>(e[t]=String(n),e),{}):void 0}catch(e){return}}function h(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function p(e){return h(`LANGSMITH_${e}`)||h(`LANGCHAIN_${e}`)}function m(){return"true"===h("OTEL_ENABLED")||"true"===p("OTEL_ENABLED")}},4853:(e,t,n)=>{"use strict";n.d(t,{D:()=>a});var r=n(9497),s=n(454);const i=3;async function a(e,t,n=i,a){let o=null;for(let i=1;i<=n;i++){const c=[...t];o&&c.push(new r.Od(`Previous attempt failed with error: ${o.message}\nPlease correct your response format if required, or try again.`));try{return a?.signal?await e.invoke(c,{signal:a.signal}):await e.invoke(c)}catch(e){if(o=e,s.y7.log("invokeWithRetry",`Attempt ${i} failed: ${o.message}`),i===n)throw e}}throw o}},5032:(e,t,n)=>{"use strict";const r=n(8311),s=n(3904),{ANY:i}=s,a=n(7638),o=n(560),c=[new s(">=0.0.0-0")],l=[new s(">=0.0.0")],u=(e,t,n)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===i){if(1===t.length&&t[0].semver===i)return!0;e=n.includePrerelease?c:l}if(1===t.length&&t[0].semver===i){if(n.includePrerelease)return!0;t=l}const r=new Set;let s,u,p,m,g,f,y;for(const t of e)">"===t.operator||">="===t.operator?s=d(s,t,n):"<"===t.operator||"<="===t.operator?u=h(u,t,n):r.add(t.semver);if(r.size>1)return null;if(s&&u){if(p=o(s.semver,u.semver,n),p>0)return null;if(0===p&&(">="!==s.operator||"<="!==u.operator))return null}for(const e of r){if(s&&!a(e,String(s),n))return null;if(u&&!a(e,String(u),n))return null;for(const r of t)if(!a(e,String(r),n))return!1;return!0}let _=!(!u||n.includePrerelease||!u.semver.prerelease.length)&&u.semver,b=!(!s||n.includePrerelease||!s.semver.prerelease.length)&&s.semver;_&&1===_.prerelease.length&&"<"===u.operator&&0===_.prerelease[0]&&(_=!1);for(const e of t){if(y=y||">"===e.operator||">="===e.operator,f=f||"<"===e.operator||"<="===e.operator,s)if(b&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===b.major&&e.semver.minor===b.minor&&e.semver.patch===b.patch&&(b=!1),">"===e.operator||">="===e.operator){if(m=d(s,e,n),m===e&&m!==s)return!1}else if(">="===s.operator&&!a(s.semver,String(e),n))return!1;if(u)if(_&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===_.major&&e.semver.minor===_.minor&&e.semver.patch===_.patch&&(_=!1),"<"===e.operator||"<="===e.operator){if(g=h(u,e,n),g===e&&g!==u)return!1}else if("<="===u.operator&&!a(u.semver,String(e),n))return!1;if(!e.operator&&(u||s)&&0!==p)return!1}return!(s&&f&&!u&&0!==p)&&(!(u&&y&&!s&&0!==p)&&(!b&&!_))},d=(e,t,n)=>{if(!e)return t;const r=o(e.semver,t.semver,n);return r>0?e:r<0||">"===t.operator&&">="===e.operator?t:e},h=(e,t,n)=>{if(!e)return t;const r=o(e.semver,t.semver,n);return r<0?e:r>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,n={})=>{if(e===t)return!0;e=new r(e,n),t=new r(t,n);let s=!1;e:for(const r of e.set){for(const e of t.set){const t=u(r,e,n);if(s=s||null!==t,t)continue e}if(s)return!1}return!0}},5157:(e,t,n)=>{"use strict";n.r(t),n.d(t,{TeachModeService:()=>T});var r=n(454),s=n(823),i=n(8851);class a{constructor(){this.browserContext=null,this.captureQueue=new Map}setBrowserContext(e){this.browserContext=e}scheduleCapture(e,t,n=100){return new Promise(r=>{const s=this.captureQueue.get(e);s&&clearTimeout(s);const i=setTimeout(async()=>{this.captureQueue.delete(e);const n=await this.captureState(t);r(n)},n);this.captureQueue.set(e,i)})}async captureState(e){try{if(!this.browserContext)return r.y7.log("StateCapture","No browser context available","warning"),null;const t=await this.browserContext.getCurrentPage(),n=await this._getBrowserStateString();if(!n)return r.y7.log("StateCapture","Failed to get browser state string","warning"),null;const s=await this._captureScreenshot(t),i=await chrome.tabs.get(e),a={timestamp:Date.now(),page:{url:i.url||"",title:i.title||""},browserState:{string:n},screenshot:s||void 0,viewport:void 0};return r.y7.log("StateCapture",`Captured state for tab ${e} - state string: ${n.length} chars, screenshot: ${s?"yes":"no"}`),a}catch(e){return r.y7.log("StateCapture",`Failed to capture state: ${e}`,"error"),null}}async _getBrowserStateString(e=!1){try{if(!this.browserContext)return null;return await this.browserContext.getBrowserStateString(e)}catch(e){return r.y7.log("StateCapture",`Failed to get browser state string: ${e}`,"warning"),null}}async _captureScreenshot(e){try{return await e.takeScreenshot("large",!1)}catch(e){return r.y7.log("StateCapture",`Failed to capture screenshot: ${e}`,"warning"),null}}cancelAll(){for(const e of this.captureQueue.values())clearTimeout(e);this.captureQueue.clear()}cleanup(){this.cancelAll(),this.browserContext=null}}class o{constructor(e,t,n){this.events=[],this.eventCounter=0,this.isDebugMode=(0,s.D5)(),this.browserContext=null,this.session={id:`recording_${Date.now()}`,startTimestamp:Date.now(),tabId:e,url:t},this.activeTabId=e,this.pubsub=i.Gd.getChannel("main"),this.stateCapture=new a,this.browserContext=n||null,this.browserContext&&this.stateCapture.setBrowserContext(this.browserContext),this.addEvent({type:"session_start",action:{url:t}}),r.y7.log("RecordingSession",`Started recording session ${this.session.id} on tab ${e}`),this.pubsub.publishTeachModeEvent({eventType:"recording_started",sessionId:this.session.id,data:{tabId:e,url:t}})}addViewport(e){this.viewport=e,r.y7.log("RecordingSession",`Set viewport: ${e.width}x${e.height}`),this.pubsub.publishTeachModeEvent({eventType:"viewport_updated",sessionId:this.session.id,data:e})}setNarration(e){e.trim()&&(this.narration={transcript:e,language:"en"},r.y7.log("RecordingSession",`Set narration with ${e.length} characters`))}setAudio(e){e.trim()&&(this.audio=e,r.y7.log("RecordingSession",`Set audio with ${e.length} bytes (base64)`))}addEvent(e){const t={id:`event_${this.session.id}_${this.eventCounter++}`,timestamp:Date.now(),action:{type:e.type,...e.action},target:e.target};this.events.push(t),r.y7.log("RecordingSession",`Added event: ${t.action.type} (${t.id})`),this.pubsub.publishTeachModeEvent({eventType:"event_captured",sessionId:this.session.id,data:{event:t,index:this.events.length-1}});["click","dblclick","change","scroll","type","navigation","session_start","session_end","tab_switched","tab_opened","tab_closed"].includes(t.action.type)&&this.browserContext&&this._scheduleStateCapture(t)}handleNavigation(e,t){this.addEvent({type:"navigation",action:{url:e}})}stop(){this.addEvent({type:"session_end",action:{}}),this.session.endTimestamp=Date.now(),this.stateCapture.cleanup();const e={session:this.session,narration:this.narration,audio:this.audio,viewport:this.viewport,events:this.events};return r.y7.log("RecordingSession",`Stopped recording session ${this.session.id} with ${this.events.length} events`),this.pubsub.publishTeachModeEvent({eventType:"recording_stopped",sessionId:this.session.id,data:{eventCount:this.events.length}}),e}getRecording(){return{session:{...this.session},narration:this.narration,audio:this.audio,viewport:this.viewport,events:[...this.events]}}getSession(){return{...this.session}}getActiveTabId(){return this.activeTabId}setActiveTabId(e){const t=this.activeTabId;this.activeTabId=e,r.y7.log("RecordingSession",`Active tab changed to ${e}`),t!==e&&this.pubsub.publishTeachModeEvent({eventType:"tab_switched",sessionId:this.session.id,data:{fromTabId:t,toTabId:e}})}setBrowserContext(e){this.browserContext=e,this.stateCapture.setBrowserContext(e)}async _scheduleStateCapture(e){try{const t=await this.stateCapture.scheduleCapture(e.id,this.activeTabId,100);if(t){const n=this.events.findIndex(t=>t.id===e.id);-1!==n&&(this.events[n].state=t,r.y7.log("RecordingSession",`Added state to event ${e.id}`),this.pubsub.publishTeachModeEvent({eventType:"state_captured",sessionId:this.session.id,data:{eventId:e.id,state:t}}))}}catch(t){r.y7.log("RecordingSession",`Failed to capture state for event ${e.id}: ${t}`,"warning")}}}var c=n(1566);const l="teach_recording_",u="teach_workflow_",d="teach_recordings_index";class h{constructor(){}static getInstance(){return h.instance||(h.instance=new h),h.instance}async save(e,t,n){try{const s=e.session.id,i=`${l}${s}`,a=JSON.stringify(e),o=new Blob([a]).size,c={id:s,title:t||`Recording ${new Date(e.session.startTimestamp).toLocaleString()}`,description:n,url:e.session.url,tabId:e.session.tabId,startTimestamp:e.session.startTimestamp,endTimestamp:e.session.endTimestamp||Date.now(),eventCount:e.events.length,stepCount:0,sizeBytes:o,createdAt:Date.now()};return await chrome.storage.local.set({[i]:a}),await this._updateIndex(c),r.y7.log("RecordingStorage",`Saved recording ${s} (${o} bytes, ${e.events.length} events)`),s}catch(e){throw r.y7.log("RecordingStorage",`Failed to save recording: ${e}`,"error"),e}}async saveWorkflow(e,t){try{const n=`${u}${e}`,s=JSON.stringify(t);await chrome.storage.local.set({[n]:s});const i=await this._getIndex(),a=i.recordings.find(t=>t.id===e);return a&&(a.title=t.metadata.name||"Untitled Workflow",a.stepCount=t.steps.length,i.lastUpdated=Date.now(),await chrome.storage.local.set({[d]:i}),r.y7.log("RecordingStorage",`Updated recording ${e}: title="${a.title}", steps=${t.steps.length}`)),r.y7.log("RecordingStorage",`Saved workflow for recording ${e}`),e}catch(e){throw r.y7.log("RecordingStorage",`Failed to save workflow: ${e}`,"error"),e}}async updateWorkflow(e,t){try{const n=await this.getWorkflow(e);if(!n)return r.y7.log("RecordingStorage",`Workflow for recording ${e} not found`,"warning"),!1;const s={...n,metadata:{...n.metadata,...t.metadata||{}},steps:t.steps||n.steps};return await this.saveWorkflow(e,s),r.y7.log("RecordingStorage",`Updated workflow for recording ${e}`),!0}catch(t){return r.y7.log("RecordingStorage",`Failed to update workflow for ${e}: ${t}`,"error"),!1}}async get(e){try{const t=`${l}${e}`,n=await chrome.storage.local.get(t);if(!n[t])return r.y7.log("RecordingStorage",`Recording ${e} not found`,"warning"),null;const s=JSON.parse(n[t]);return r.y7.log("RecordingStorage",`Retrieved recording ${e}`),s}catch(t){return r.y7.log("RecordingStorage",`Failed to get recording ${e}: ${t}`,"error"),null}}async getWorkflow(e){try{const t=`${u}${e}`,n=await chrome.storage.local.get(t);if(!n[t])return r.y7.log("RecordingStorage",`Workflow for recording ${e} not found`,"warning"),null;const s=JSON.parse(n[t]);return r.y7.log("RecordingStorage",`Retrieved workflow for recording ${e}`),s}catch(t){return r.y7.log("RecordingStorage",`Failed to get workflow for ${e}: ${t}`,"error"),null}}async list(){try{const e=[...(await this._getIndex()).recordings].sort((e,t)=>t.createdAt-e.createdAt);return r.y7.log("RecordingStorage",`Listed ${e.length} recordings`),e}catch(e){return r.y7.log("RecordingStorage",`Failed to list recordings: ${e}`,"error"),[]}}async delete(e){try{const t=`${l}${e}`;await chrome.storage.local.remove(t);const n=await this._getIndex();return n.recordings=n.recordings.filter(t=>t.id!==e),n.totalSize=n.recordings.reduce((e,t)=>e+t.sizeBytes,0),n.lastUpdated=Date.now(),await chrome.storage.local.set({[d]:n}),r.y7.log("RecordingStorage",`Deleted recording ${e}`),!0}catch(t){return r.y7.log("RecordingStorage",`Failed to delete recording ${e}: ${t}`,"error"),!1}}async deleteWorkflow(e){try{const t=`${u}${e}`;return await chrome.storage.local.remove(t),!0}catch(t){return r.y7.log("RecordingStorage",`Failed to delete workflow ${e}: ${t}`,"error"),!1}}async clear(){try{const e=await this._getIndex(),t=[...e.recordings.map(e=>`${l}${e.id}`),...e.recordings.map(e=>`${u}${e.id}`)];t.push(d),await chrome.storage.local.remove(t),r.y7.log("RecordingStorage",`Cleared ${e.recordings.length} recordings`)}catch(e){throw r.y7.log("RecordingStorage",`Failed to clear recordings: ${e}`,"error"),e}}async export(e){try{const t=await this.get(e);if(!t)throw new Error(`Recording ${e} not found`);const n=JSON.stringify(t,null,2),s=new Date(t.session.startTimestamp),i=`teach-mode-recording-${s.toISOString().slice(0,19).replace(/[:.]/g,"-")}.json`,a=`data:application/json;base64,${btoa(unescape(encodeURIComponent(n)))}`;await chrome.downloads.download({url:a,filename:i,saveAs:!0}),r.y7.log("RecordingStorage",`Exported recording ${e} as ${i}`)}catch(t){throw r.y7.log("RecordingStorage",`Failed to export recording ${e}: ${t}`,"error"),t}}async import(e,t){try{const n=JSON.parse(e);if(!n.session||!n.events||!Array.isArray(n.events))throw new Error("Invalid recording format");n.session.id=`recording_imported_${Date.now()}`;const s=await this.save(n,t||`Imported: ${n.session.id}`,"Imported recording");return r.y7.log("RecordingStorage",`Imported recording as ${s}`),s}catch(e){throw r.y7.log("RecordingStorage",`Failed to import recording: ${e}`,"error"),e}}async getStats(){try{const e=await this._getIndex(),t={recordingCount:e.recordings.length,totalSize:e.totalSize,availableSpace:-1,oldestRecording:void 0,newestRecording:void 0};if(e.recordings.length>0){const n=[...e.recordings].sort((e,t)=>e.createdAt-t.createdAt);t.oldestRecording=new Date(n[0].createdAt),t.newestRecording=new Date(n[n.length-1].createdAt)}return t}catch(e){return r.y7.log("RecordingStorage",`Failed to get storage stats: ${e}`,"error"),{recordingCount:0,totalSize:0,availableSpace:-1}}}async search(e){try{const t=await this._getIndex(),n=e.toLowerCase(),r=t.recordings.filter(e=>e.title.toLowerCase().includes(n)||e.url.toLowerCase().includes(n)||e.description&&e.description.toLowerCase().includes(n));return r.sort((e,t)=>{const r=e.title.toLowerCase().includes(n)?1:0,s=t.title.toLowerCase().includes(n)?1:0;return r!==s?s-r:t.createdAt-e.createdAt}),r}catch(e){return r.y7.log("RecordingStorage",`Failed to search recordings: ${e}`,"error"),[]}}async _getIndex(){try{const e=await chrome.storage.local.get(d);return e[d]?e[d]:{recordings:[],totalSize:0,lastUpdated:Date.now()}}catch(e){return r.y7.log("RecordingStorage",`Failed to get index: ${e}`,"error"),{recordings:[],totalSize:0,lastUpdated:Date.now()}}}async _updateIndex(e){try{const t=await this._getIndex(),n=t.recordings.findIndex(t=>t.id===e.id);n>=0&&(t.totalSize-=t.recordings[n].sizeBytes,t.recordings.splice(n,1)),t.recordings.push(e),t.totalSize+=e.sizeBytes,t.lastUpdated=Date.now(),await chrome.storage.local.set({[d]:t}),r.y7.log("RecordingStorage",`Updated index with recording ${e.id}`)}catch(e){throw r.y7.log("RecordingStorage",`Failed to update index: ${e}`,"error"),e}}async cleanupOldRecordings(e=50){try{const t=await this._getIndex();if(t.recordings.length<=e)return 0;const n=[...t.recordings].sort((e,t)=>e.createdAt-t.createdAt).slice(0,t.recordings.length-e);let s=0;for(const e of n)await this.delete(e.id)&&s++;return r.y7.log("RecordingStorage",`Cleaned up ${s} old recordings`),s}catch(e){return r.y7.log("RecordingStorage",`Failed to cleanup old recordings: ${e}`,"error"),0}}}var p=n(2080),m=n(9497),g=n(269),f=n(4853);const y=p.k5(["session_start","session_end","click","dblclick","input","change","keydown","keyup","beforeunload","navigation","scroll","type","keypress","navigate","tab_switched","tab_opened","tab_closed"]),_=p.Ik({nodeId:p.ai().optional(),selectors:p.Ik({css:p.Yj().optional(),xpath:p.Yj().optional(),text:p.Yj().optional(),ariaLabel:p.Yj().optional(),dataTestId:p.Yj().optional(),id:p.Yj().optional(),className:p.Yj().optional()}),element:p.Ik({tagName:p.Yj(),type:p.Yj().optional(),text:p.Yj().optional(),value:p.Yj().optional(),placeholder:p.Yj().optional(),attributes:p.g1(p.Yj(),p.Yj()),boundingBox:p.Ik({x:p.ai(),y:p.ai(),width:p.ai(),height:p.ai()}),isVisible:p.zM(),isInteractive:p.zM().optional(),isDisabled:p.zM().optional()})}),b=p.Ik({timestamp:p.ai(),page:p.Ik({url:p.Yj(),title:p.Yj()}),browserState:p.Ik({string:p.Yj()}).optional(),screenshot:p.Yj().optional(),viewport:p.Ik({scrollX:p.ai(),scrollY:p.ai(),innerWidth:p.ai(),innerHeight:p.ai()}).optional()}),w=p.Ik({id:p.Yj(),timestamp:p.ai(),tabId:p.ai().optional(),action:p.Ik({type:y,value:p.Yj().optional(),key:p.Ik({key:p.Yj(),code:p.Yj().optional(),altKey:p.zM().optional(),ctrlKey:p.zM().optional(),metaKey:p.zM().optional(),shiftKey:p.zM().optional()}).optional(),mouse:p.Ik({button:p.ai(),x:p.ai(),y:p.ai(),offsetX:p.ai().optional(),offsetY:p.ai().optional()}).optional(),url:p.Yj().optional(),scroll:p.Ik({x:p.ai(),y:p.ai(),deltaX:p.ai().optional(),deltaY:p.ai().optional()}).optional(),tabId:p.ai().optional(),fromTabId:p.ai().optional(),toTabId:p.ai().optional(),fromUrl:p.Yj().optional(),toUrl:p.Yj().optional()}),target:_.optional(),state:b.optional(),narration:p.Yj().optional()}),v=p.Ik({session:p.Ik({id:p.Yj(),startTimestamp:p.ai(),endTimestamp:p.ai().optional(),tabId:p.ai(),url:p.Yj()}),narration:p.Ik({transcript:p.Yj(),duration:p.ai().optional(),segments:p.YO(p.Ik({text:p.Yj(),startTime:p.ai(),endTime:p.ai(),confidence:p.ai().optional()})).optional(),vapiSessionId:p.Yj().optional(),language:p.Yj().default("en")}).optional(),audio:p.Yj().optional(),viewport:p.Ik({width:p.ai(),height:p.ai(),deviceScaleFactor:p.ai(),isMobile:p.zM(),hasTouch:p.zM(),isLandscape:p.zM()}).optional(),events:p.YO(w)}),E=p.Ik({metadata:p.Ik({recordingId:p.Yj(),name:p.Yj(),goal:p.Yj(),description:p.Yj().optional(),transcript:p.Yj().optional(),createdAt:p.ai(),duration:p.ai().optional()}),steps:p.YO(p.Ik({id:p.Yj(),intent:p.Yj(),action:p.Ik({type:p.Yj(),description:p.Yj(),nodeIdentificationStrategy:p.Yj().optional().nullable(),validationStrategy:p.Yj(),timeoutMs:p.ai().default(5e3)}),sourceEventIds:p.YO(p.Yj()),stateBefore:b.optional(),stateAfter:b.optional()}))});p.gM("action",[p.Ik({action:p.eu("START_RECORDING"),source:p.eu("TeachModeService"),targetTabId:p.ai().optional(),config:p.Ik({captureVoice:p.zM().optional(),captureScreenshots:p.zM().optional(),captureBeforeState:p.zM().optional()}).optional()}),p.Ik({action:p.eu("STOP_RECORDING"),source:p.eu("TeachModeService"),targetTabId:p.ai().optional()}),p.Ik({action:p.eu("HEARTBEAT_PING"),source:p.eu("TeachModeService")}),p.Ik({action:p.eu("EVENT_CAPTURED"),source:p.eu("TeachModeRecorder"),event:w}),p.Ik({action:p.eu("RECORDER_READY"),source:p.eu("TeachModeRecorder"),viewport:p.Ik({width:p.ai(),height:p.ai(),deviceScaleFactor:p.ai()}).optional()}),p.Ik({action:p.eu("NARRATION_UPDATE"),source:p.eu("TeachModeRecorder"),segment:p.Ik({text:p.Yj(),startTime:p.ai(),endTime:p.ai()})})]);const S=p.Ik({intent:p.Yj(),actionDescription:p.Yj(),nodeIdentificationStrategy:p.Yj().optional().nullable(),validationStrategy:p.Yj(),timeoutMs:p.ai().default(5e3),updatedWorkflowSummary:p.Yj()}),x=p.Ik({workflowDescription:p.Yj(),userGoal:p.Yj(),workflowName:p.Yj()});class k{constructor(e,t){this.pubsub=null,this.sessionId=null,this.pubsub=e||null,this.sessionId=t||null,r.y7.log("PreprocessAgent","Agent instance created","info")}async processRecording(e){try{const t=v.parse(e),n=t.events.length;r.y7.log("PreprocessAgent",`Processing recording with ${n} events`,"info"),this._emitProgress("preprocessing_started",{totalEvents:n});let s=t.narration?.transcript||"";if(!s&&t.audio){r.y7.log("PreprocessAgent","Transcribing audio recording...","info"),this._emitProgress("preprocessing_progress",{stage:"transcription",current:0,total:n,message:"Transcribing audio narration..."});try{s=await this._transcribeAudio(t.audio),r.y7.log("PreprocessAgent",`Transcription complete: ${s.length} characters`,"info"),r.y7.logMetric("teachmode.transcription.completed",{transcriptLength:s.length,success:!0}).catch(()=>{}),this._emitDebug("Transcript extracted",s),this._emitProgress("preprocessing_progress",{stage:"transcription",current:0,total:n,message:"Transcription completed",transcript:s})}catch(e){r.y7.log("PreprocessAgent",`Transcription failed: ${e}`,"warning"),r.y7.logMetric("teachmode.transcription.completed",{transcriptLength:0,success:!1}).catch(()=>{}),this._emitProgress("preprocessing_progress",{stage:"transcription",current:0,total:n,message:"Continuing without transcription",error:String(e)})}}const i=[];let a,o="This is the first action in the workflow.",c=0;for(let e=0;e<t.events.length;e++){const l=t.events[e];c++,r.y7.log("PreprocessAgent",`Processing event ${c}/${n}: ${l.action.type}`,"info"),this._emitProgress("preprocessing_progress",{stage:"event_processing",current:c,total:n,actionType:l.action.type,message:`Processing ${l.action.type} (${c}/${n})`});try{const e=await this._processEvent(l,c,n,s,a,o);i.push(e),o=e.updatedWorkflowSummary||o,a=l.state}catch(e){r.y7.log("PreprocessAgent",`Failed to process event ${c}: ${e}`,"warning")}}r.y7.log("PreprocessAgent",`Generating workflow metadata with ${i.length} steps and transcript: ${s?"available":"none"}`,"info");const l=await this._generateWorkflowMetadata(s,i);r.y7.log("PreprocessAgent",`Generated workflow metadata - Name: "${l.workflowName}", Goal: "${l.userGoal}"`,"info"),this._emitDebug("Workflow metadata generated",l);const u={metadata:{recordingId:t.session.id,name:l.workflowName,goal:l.userGoal,description:l.workflowDescription,transcript:s||void 0,createdAt:Date.now(),duration:t.session.endTimestamp?t.session.endTimestamp-t.session.startTimestamp:void 0},steps:i};r.y7.log("PreprocessAgent",`Successfully created workflow with ${i.length} steps`,"info"),this._emitDebug("Workflow created",{name:u.metadata.name,goal:u.metadata.goal,description:u.metadata.description,totalSteps:u.steps.length,stepIntents:u.steps.map(e=>e.intent)});const d={};return t.events.forEach(e=>{const t=e.action.type;d[t]=(d[t]||0)+1}),r.y7.logMetric("teachmode.preprocessing.completed",{eventsCount:t.events.length,stepsGenerated:i.length,workflowGoal:u.metadata.goal,hasTranscript:!!s,transcript:s||void 0,actionTypeCounts:d,steps:u.steps.map(e=>({intent:e.intent,type:e.action.type}))}).catch(()=>{}),this._emitProgress("preprocessing_completed",{workflowName:u.metadata.name,totalSteps:i.length}),E.parse(u)}catch(e){const t=e instanceof Error?e.message:String(e);throw r.y7.log("PreprocessAgent",`Processing failed: ${t}`,"error"),this._emitProgress("preprocessing_failed",{error:t}),new Error(`Failed to process recording: ${t}`)}}async _processEvent(e,t,n,s,i,a){try{const r=await this._analyzeEventWithLLM(e,t,n,s,a,i);return{id:`step-${t}`,intent:r.intent,action:{type:e.action.type,description:r.actionDescription,nodeIdentificationStrategy:["click","input","type","change"].includes(e.action.type)?r.nodeIdentificationStrategy:void 0,validationStrategy:r.validationStrategy,timeoutMs:r.timeoutMs},sourceEventIds:[e.id],stateBefore:i,stateAfter:e.state,updatedWorkflowSummary:r.updatedWorkflowSummary}}catch(e){const t=e instanceof Error?e.message:String(e);throw r.y7.log("PreprocessAgent",`Event analysis failed: ${t}`,"error"),new Error(`Failed to analyze event: ${t}`)}}async _analyzeEventWithLLM(e,t,n,s,i,a){try{this._emitDebug(`Analyzing event ${t}`,{actionType:e.action.type,eventId:e.id,targetElement:e.target?.element?.tagName||"none"});const r=(await(0,g.O7)({temperature:.3,maxTokens:2048})).withStructuredOutput(S),o="\nYou are an expert browser automation analyst. Your job is to analyze individual user actions and convert them into clear, executable instructions for an automation agent.\n\n## Context Provided:\n\n### User Narration (if available)\nThe user may have recorded a voice narration explaining what they're trying to achieve. Use this to understand the high-level goal and intent behind the actions.\n\n### Action Context\n- **Position**: Which action this is in the sequence (e.g., \"Action 3 of 8\")\n- **Previous Actions**: Summary of what has been accomplished so far\n- **Current Action**: The specific browser action being performed (click, type, navigate, etc.) with any arguments\n\n### Page State (Before & After)\nYou'll see the page state before and after this action, including:\n- URL and page title\n- Interactive elements visible on the page\n- Screenshots showing visual context\n\n## Your Task:\n\nAnalyze this action and provide structured guidance:\n\n### 1. Intent\nWhat is the user trying to accomplish with THIS specific action? Consider:\n- The narration context (if provided)\n- The action's position in the workflow\n- What was done before this action\n- How this moves toward the overall goal\n\n### 2. Action Description\nProvide clear, actionable instructions that:\n- Explain how to reproduce this action\n- Are generic enough to work in similar scenarios\n- Focus on the desired outcome, not technical details\n- Can be understood by an automation agent\n\n### 3. Element Identification (for click/type actions only)\nDescribe how to reliably find the target element:\n- Use visual cues (colors, size, position)\n- Reference text content and labels\n- Describe surrounding context\n- Avoid brittle selectors (no exact class names/IDs)\n- Think: \"How would a human describe finding this element?\"\n\nExample: \"The blue 'Continue' button at the bottom of the checkout form\" NOT \"button.btn-checkout-continue\"\n\n### 4. Validation\nExplain how to verify this action succeeded:\n- What should change? (URL, page content, element visibility)\n- Multiple verification methods (don't rely on just one)\n- Account for loading delays and async behavior\n- Provide fallback checks\n- Be specific about success indicators\n\n### 5. Updated Workflow Summary\nUpdate the progress summary to reflect completion of this action:\n- Incorporate this action into the ongoing workflow narrative\n- Focus on what's been achieved toward the user's objective\n- This summary will be passed to the next action for context\n- Make it as better as possible so that when you process next action, you can use this summary to understand the progress made so far. As you wont be passed the previous actions details.\n\n## Guidelines:\n- Use all available context (narration, previous actions, page states)\n- Make instructions robust and handle edge cases\n- Keep the overall workflow goal in mind\n- Be specific but flexible enough for variations\n",c=this._buildWorkflowAndActionMessage(e,s,t,n,i),l=this._buildStateMessage("BEFORE",a),u=this._buildStateMessage("AFTER",e.state),d=[new m.tn(o),new m.HumanMessage(c),new m.HumanMessage(l),new m.HumanMessage(u)];return await(0,f.D)(r,d,3)}catch(e){const t=e instanceof Error?e.message:String(e);throw r.y7.log("PreprocessAgent",`LLM analysis failed: ${t}`,"error"),new Error(`LLM analysis failed: ${t}`)}}_buildWorkflowAndActionMessage(e,t,n,r,s){const i=[];Object.entries(e.action).forEach(([e,t])=>{"type"!==e&&null!=t&&("object"==typeof t?i.push(`${e}: ${JSON.stringify(t)}`):i.push(`${e}: ${t}`))});const a=i.length>0?i.join(", "):"No additional action data";return`\n## User Narration\n${t?`"${t}"`:"(No narration provided)"}\n\n## Action Context\n- **Position**: Action ${n} of ${r}\n- **Previous Actions**: ${s}\n\n## Current Action Details\n- **Action Type**: ${e.action.type.toUpperCase()}\n- **Action Data**: ${a}\n- **Target Element**: ${e.target?`${e.target.element.tagName} with text "${e.target.element.text||"N/A"}"`:"No target specified"}\n`}_buildStateMessage(e,t){return t?`\n## ${e} State\n- **URL**: ${t.page.url}\n- **Title**: ${t.page.title}\n- **Timestamp**: ${new Date(t.timestamp).toISOString()}\n- **Interactive Elements**: ${t.browserState?.string||"No browser state available"}\n- **Screenshot**: ${t.screenshot?`[Base64 image data: ${t.screenshot.substring(0,50)}...]`:"No screenshot available"}\n`:`\n## ${e} State\n- **State**: No state information available for ${e.toLowerCase()} action\n`}_emitProgress(e,t){this.pubsub&&this.sessionId&&this.pubsub.publishTeachModeEvent({eventType:e,sessionId:this.sessionId,data:t})}_emitDebug(e,t,n=200){if(!(0,s.D5)())return;let i=`[PreprocessAgent] ${e}`;if(null!=t){let e;e="object"==typeof t?JSON.stringify(t,null,2):String(t),e.length>n&&(e=e.substring(0,n)+"..."),i=`${i}: ${e}`}this._emitProgress("preprocessing_progress",{stage:"debug",message:i,timestamp:Date.now()}),r.y7.log("PreprocessAgent",i,"info")}async _generateWorkflowMetadata(e,t){try{if(0===t.length){const e=new Date;return{workflowDescription:"No actions were recorded",userGoal:"No specific goal provided",workflowName:`Workflow ${e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})}`}}this._emitDebug("Generating workflow metadata",{stepCount:t.length,hasNarration:!!e});const n=(await(0,g.O7)({temperature:.3,maxTokens:1024})).withStructuredOutput(x),r='\nYou are analyzing a complete browser automation workflow to extract comprehensive metadata. The user demonstrated a workflow by performing browser actions, possibly with voice narration explaining their intent.\n\nYou will receive:\n1. **Narration** (optional): The user\'s voice explanation during the demonstration\n2. **Workflow Steps**: All the semantic actions performed (each with intent, description, validation details)\n\nYour task is to generate three pieces of metadata that work together:\n\n## 1. Workflow Description\nSummarize what the user demonstrated in their browser session:\n- Clearly describe the process performed\n- Be concise but complete (2-4 sentences)\n- Stand alone without additional context\n- Capture key actions and flow\n- Focus on WHAT was demonstrated, not intent\n\n## 2. User Goal\nIdentify what the user wants the automation agent to accomplish:\n- Be actionable and specific\n- May be SAME as demonstrated, or MODIFIED based on narration\n- Consider if user specified different parameters, targets, or scale\n- Written as clear, executable instruction\n- Focus on WHAT should be done\n\n**Decision Logic:**\n- Narration specifies NEW parameters/targets/scale  MODIFIED workflow\n- No changes specified  EXACT SAME workflow as demonstrated\n\n## 3. Workflow Name\nCreate a concise 2-3 word name capturing the essence:\n- **Length**: Exactly 2-3 words (prefer 2)\n- **Style**: Action-oriented with verbs\n- **Specificity**: Specific to task, not generic\n- **Format**: Title case\n- **Priority**: Actual steps > User goal > Narration\n\n## Examples:\n\n**Example 1 - Modified Workflow:**\nNarration: "I navigated to LinkedIn, searched for Meta, and sent a connection request to one Meta employee. Now do the same for Google employees, send requests to 20 people."\nSteps: [\n  1. Navigate to linkedin.com\n  2. Search for "Meta" in company search\n  3. Click on employee profile\n  4. Click connect button\n  5. Add personalized note\n  6. Send connection request\n]\n\nOutput:\n{\n  "workflowDescription": "The user demonstrated how to navigate to LinkedIn, search for a specific company (Meta), locate an employee profile, and send a personalized connection request.",\n  "userGoal": "Navigate to LinkedIn, search for Google employees, and send personalized connection requests to 20 Google employees.",\n  "workflowName": "LinkedIn Connect"\n}\n\n**Example 2 - Same Workflow:**\nNarration: "I went to Gmail, found newsletter emails, and unsubscribed from one. Continue doing this for all newsletters."\nSteps: [\n  1. Navigate to gmail.com\n  2. Open promotions tab\n  3. Select newsletter email\n  4. Click unsubscribe link\n  5. Confirm unsubscribe\n]\n\nOutput:\n{\n  "workflowDescription": "The user demonstrated how to navigate to Gmail, access the promotions tab, identify newsletter emails, and unsubscribe from them using the unsubscribe link.",\n  "userGoal": "Open Gmail, identify all newsletter emails in the promotions tab, and unsubscribe from all remaining newsletters.",\n  "workflowName": "Gmail Unsubscribe"\n}\n\n**Example 3 - No Narration:**\nNarration: (none)\nSteps: [\n  1. Navigate to amazon.com\n  2. Search for "laptop"\n  3. Select product from results\n  4. Add to cart\n  5. Proceed to checkout\n]\n\nOutput:\n{\n  "workflowDescription": "The user demonstrated how to navigate to Amazon, search for a product (laptop), select an item from search results, add it to the shopping cart, and proceed to checkout.",\n  "userGoal": "Navigate to Amazon, search for laptop, select and add a product to cart, then proceed to checkout.",\n  "workflowName": "Amazon Checkout"\n}\n\n## Name Categories & Examples:\n\n**Email/Communication:** Gmail Unsubscribe, Email Cleanup, Inbox Filter, Message Forward\n**Social Media:** LinkedIn Connect, Twitter Follow, Post Schedule, Profile Update\n**E-commerce:** Product Search, Cart Checkout, Price Compare, Order Track\n**Data/Research:** Data Entry, Startup Research, Contact Scrape, Report Generate\n**Forms:** Form Submit, Job Apply, Account Setup, Survey Complete\n**General:** Tab Management, Bookmark Save, Site Navigation\n\n## Guidelines:\n- Use narration to understand intent, but rely on steps for description\n- Distinguish between what was demonstrated vs. what should be done\n- Keep descriptions factual and goal-oriented\n- Names should be memorable and immediately convey purpose\n- Never use generic names like "Web Automation" or "Browser Task"\n- Description focuses on demonstrated actions\n- Goal focuses on what agent should execute\n- Name is catchy and domain-specific when possible\n',s=`\nNarration: ${e||"(No narration provided)"}\n\nWorkflow Steps:\n${t.map((e,t)=>`${t+1}. ${e.intent} (${e.action.type}${e.action.nodeIdentificationStrategy?`: ${e.action.nodeIdentificationStrategy}`:""})`).join("\n")}\n`,i=[new m.tn(r),new m.HumanMessage(s)];return await(0,f.D)(n,i,3)}catch(n){r.y7.log("PreprocessAgent",`Workflow metadata generation failed: ${n}`,"warning");const s=t[t.length-1],i=s.stateAfter||s.stateBefore;let a="Browser Workflow";if(i?.page?.url)try{const e=new URL(i.page.url).hostname.replace("www.","").split(".")[0],t=e.charAt(0).toUpperCase()+e.slice(1),n=new Date;a=`${t} ${n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})}`}catch{}return{workflowDescription:`The user performed ${t.length} actions including: ${t.map(e=>e.intent).slice(0,3).join(", ")}${t.length>3?"...":""}.`,userGoal:e||"Perform the same workflow as demonstrated",workflowName:a}}}async _transcribeAudio(e){try{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);const r=new Blob([n],{type:"audio/webm;codecs=opus"}),s=new FormData;s.append("file",r,"recording.webm"),s.append("response_format","json");const i=await fetch("https://llm.vibebrowser.com/api/transcribe",{method:"POST",body:s});if(!i.ok)throw new Error(`Transcription API error: ${i.status}`);const a=await i.json();return a.text?.trim()||""}catch(e){throw r.y7.log("PreprocessAgent",`Failed to transcribe: ${e}`,"error"),e}}}class T{constructor(){this.currentSession=null,this.browserContext=null,this.navigationListener=null,this.messageListener=null,this.activeTabId=null,this.tabActivatedListener=null,this.tabCreatedListener=null,this.tabRemovedListener=null,this.heartbeatInterval=null,this._setupNavigationListener(),this._setupMessageListener(),this._setupTabListeners()}static getInstance(){return T.instance||(T.instance=new T),T.instance}async startRecording(e){try{this.currentSession&&await this.stopRecording();const t=await chrome.tabs.get(e);if(!t.url)throw new Error("Tab has no URL");r.y7.logMetric("teachmode.recording.started").catch(()=>{});try{this.browserContext=new c.gs,r.y7.log("TeachModeService",`Initialized browser context for tab ${e}`)}catch(e){r.y7.log("TeachModeService",`Failed to initialize browser context: ${e}`,"warning"),this.browserContext=null}this.currentSession=new o(e,t.url,this.browserContext||void 0);const n=await this._captureViewport(e);n&&this.currentSession.addViewport(n),this.activeTabId=e,this._startHeartbeat(e),this.tabActivatedListener&&chrome.tabs.onActivated.addListener(this.tabActivatedListener),this.tabCreatedListener&&chrome.tabs.onCreated.addListener(this.tabCreatedListener),this.tabRemovedListener&&chrome.tabs.onRemoved.addListener(this.tabRemovedListener),await this._injectAndStartRecording(e),r.y7.log("TeachModeService",`Started recording on tab ${e}`)}catch(e){throw r.y7.log("TeachModeService",`Failed to start recording: ${e}`,"error"),e}}async stopRecording(e){try{if(!this.currentSession)return r.y7.log("TeachModeService","No active recording to stop","warning"),null;e&&this.currentSession.setAudio(e);const t=this.activeTabId||this.currentSession.getActiveTabId();try{await chrome.tabs.sendMessage(t,{action:"STOP_RECORDING",source:"TeachModeService"})}catch(e){r.y7.log("TeachModeService",`Failed to send stop message: ${e}`,"warning")}const n=this.currentSession.stop();if(this.currentSession=null,this.activeTabId=null,r.y7.logMetric("teachmode.recording.stopped",{eventsCount:n.events.length}).catch(()=>{}),this._stopHeartbeat(),this.tabActivatedListener&&chrome.tabs.onActivated.removeListener(this.tabActivatedListener),this.tabCreatedListener&&chrome.tabs.onCreated.removeListener(this.tabCreatedListener),this.tabRemovedListener&&chrome.tabs.onRemoved.removeListener(this.tabRemovedListener),this.browserContext){try{await this.browserContext.cleanup()}catch(e){r.y7.log("TeachModeService",`Failed to clean up browser context: ${e}`,"warning")}this.browserContext=null}return await this._saveRecording(n),r.y7.log("TeachModeService",`Stopped recording with ${n.events.length} events`),n}catch(e){throw r.y7.log("TeachModeService",`Failed to stop recording: ${e}`,"error"),e}}isRecording(){return null!==this.currentSession}getCurrentSession(){return this.currentSession}async _captureViewport(e){try{const t=await chrome.scripting.executeScript({target:{tabId:e},func:()=>({width:window.innerWidth,height:window.innerHeight,deviceScaleFactor:window.devicePixelRatio||1,isMobile:!1,hasTouch:"ontouchstart"in window,isLandscape:window.innerWidth>window.innerHeight})});if(t&&t[0]?.result)return t[0].result}catch(e){r.y7.log("TeachModeService",`Failed to capture viewport: ${e}`,"warning")}return null}_setupNavigationListener(){this.navigationListener=e=>{0===e.frameId&&this.currentSession&&this.activeTabId===e.tabId&&this.currentSession.handleNavigation(e.url,e.transitionType)},chrome.webNavigation.onCommitted.addListener(this.navigationListener)}async _injectAndStartRecording(e){try{if(await this._isScriptAlive(e))return await chrome.tabs.sendMessage(e,{action:"START_RECORDING",source:"TeachModeService",targetTabId:e}),void r.y7.log("TeachModeService",`Script already alive on tab ${e}, started recording`);await chrome.scripting.executeScript({target:{tabId:e},files:["teach-mode-recorder.js"]}),await new Promise(e=>setTimeout(e,100)),await chrome.tabs.sendMessage(e,{action:"START_RECORDING",source:"TeachModeService",targetTabId:e}),r.y7.log("TeachModeService",`Injected and started recording on tab ${e}`)}catch(t){r.y7.log("TeachModeService",`Failed to inject/start recording on tab ${e}: ${t}`,"error")}}async _isScriptAlive(e){try{const t=await chrome.tabs.sendMessage(e,{action:"HEARTBEAT_PING",source:"TeachModeService"});return!0===t?.alive}catch{return!1}}_startHeartbeat(e){this._stopHeartbeat(),this.heartbeatInterval=setInterval(async()=>{const e=this.activeTabId;if(e&&this.currentSession)try{await chrome.tabs.sendMessage(e,{action:"HEARTBEAT_PING",source:"TeachModeService"})}catch(t){r.y7.log("TeachModeService",`Heartbeat failed for tab ${e}, reinjecting`),await this._injectAndStartRecording(e)}else this._stopHeartbeat()},100)}_stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}_setupMessageListener(){this.messageListener=(e,t,n)=>{if("GET_TAB_ID"===e.action)return n({tabId:t.tab?.id||-1}),!0;const s=e;if("TeachModeRecorder"===s.source){switch(s.action){case"EVENT_CAPTURED":this._handleCapturedEvent(s.event,t.tab?.id),n({success:!0});break;case"RECORDER_READY":r.y7.log("TeachModeService",`Recorder ready on tab ${t.tab?.id}`),n({success:!0});break;default:return}return!0}},chrome.runtime.onMessage.addListener(this.messageListener)}_handleCapturedEvent(e,t){this.currentSession?t===this.activeTabId?this.currentSession.addEvent({type:e.action.type,action:e.action,target:e.target}):r.y7.log("TeachModeService",`Event from non-active tab ${t}, active is ${this.activeTabId}`,"warning"):r.y7.log("TeachModeService","Received event but no active session","warning")}async _saveRecording(e){try{const t=h.getInstance(),n=new URL(e.session.url),s=new Date(e.session.startTimestamp).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),i=`Processing - ${n.hostname} ${s}`,a=await t.save(e,i);return r.y7.log("TeachModeService",`Saved recording ${a} with ${e.events.length} events`),this._startAsyncPreprocessing(a,e),a}catch(e){return r.y7.log("TeachModeService",`Failed to save recording: ${e}`,"error"),null}}async _startAsyncPreprocessing(e,t){const n=h.getInstance(),s=i.Gd.getChannel("main");try{s.publishTeachModeEvent({eventType:"preprocessing_started",sessionId:t.session.id,data:{recordingId:e,totalEvents:t.events.filter(e=>"session_start"!==e.action.type&&"session_end"!==e.action.type).length}});const i=new k(s,t.session.id),a=await i.processRecording(t);r.y7.log("TeachModeService",`Created workflow with ${a.steps.length} steps`),await n.saveWorkflow(e,a),s.publishTeachModeEvent({eventType:"preprocessing_completed",sessionId:t.session.id,data:{recordingId:e,workflowSteps:a.steps.length}})}catch(n){const i=n instanceof Error?n.message:String(n);r.y7.log("TeachModeService",`Async preprocessing failed: ${i}`,"error"),s.publishTeachModeEvent({eventType:"preprocessing_failed",sessionId:t.session.id,data:{recordingId:e,error:i}})}}handleTabClosed(e){this.currentSession&&this.activeTabId===e&&(r.y7.log("TeachModeService",`Active recording tab ${e} was closed, stopping recording`),this.stopRecording())}cleanup(){this.browserContext&&(this.browserContext.cleanup().catch(e=>{r.y7.log("TeachModeService",`Failed to clean up browser context: ${e}`,"warning")}),this.browserContext=null),this.currentSession=null,this.activeTabId=null}async getRecordings(){const e=h.getInstance();return await e.list()}async getRecording(e){const t=h.getInstance();return await t.get(e)}async deleteRecording(e){const t=h.getInstance();return await t.delete(e)}async getWorkflow(e){const t=h.getInstance();return await t.getWorkflow(e)}async updateWorkflow(e,t){const n=h.getInstance();return await n.updateWorkflow(e,t)}async deleteWorkflow(e){const t=h.getInstance();return await t.deleteWorkflow(e)}async clearAllRecordings(){const e=h.getInstance();await e.clear()}async exportRecording(e){const t=h.getInstance();await t.export(e)}async importRecording(e,t){const n=h.getInstance();return await n.import(e,t)}async getStorageStats(){const e=h.getInstance();return await e.getStats()}async searchRecordings(e){const t=h.getInstance();return await t.search(e)}_setupTabListeners(){this.tabActivatedListener=async e=>{if(!this.currentSession)return;const t=e.tabId,n=this.activeTabId;if(t!==n){if(r.y7.log("TeachModeService",`Tab switched from ${n} to ${t} during recording`),null!==n)try{const[e,r]=await Promise.all([chrome.tabs.get(n).catch(()=>null),chrome.tabs.get(t)]);this.currentSession.addEvent({type:"tab_switched",action:{fromTabId:n,toTabId:t,fromUrl:e?.url||"",toUrl:r.url||""}})}catch(e){this.currentSession.addEvent({type:"tab_switched",action:{fromTabId:n,toTabId:t}})}if(this.activeTabId=t,this.currentSession.setActiveTabId(t),null!==n)try{await chrome.tabs.sendMessage(n,{action:"STOP_RECORDING",source:"TeachModeService",targetTabId:n}),await new Promise(e=>setTimeout(e,50))}catch(e){r.y7.log("TeachModeService",`Could not stop recording on previous tab: ${e}`,"warning")}}},this.tabCreatedListener=async e=>{if(!this.currentSession||!e.id)return;e.openerTabId===this.activeTabId?(r.y7.log("TeachModeService",`New tab ${e.id} opened from recording tab ${e.openerTabId} with URL: ${e.url}`),this.currentSession.addEvent({type:"tab_opened",action:{tabId:e.id,url:e.url||"",toUrl:e.url||"",fromTabId:e.openerTabId}})):r.y7.log("TeachModeService",`New tab ${e.id} opened independently during recording`)},this.tabRemovedListener=async(e,t)=>{if(this.currentSession&&e===this.activeTabId){r.y7.log("TeachModeService",`Active recording tab closed: ${e}`),this.currentSession.addEvent({type:"tab_closed",action:{tabId:e,url:""}});const t=await chrome.tabs.query({active:!0,currentWindow:!0});t.length>0&&t[0].id?(this.activeTabId=t[0].id,this.currentSession.setActiveTabId(this.activeTabId)):this.activeTabId=null}}}}},5200:(e,t,n)=>{"use strict";const r=n(560);e.exports=(e,t,n)=>r(e,t,n)<=0},5342:(e,t,n)=>{"use strict";const r=n(7075);e.exports=(e,t,n)=>r(e,t,"<",n)},5435:(e,t,n)=>{"use strict";n.d(t,{$W:()=>a,GT:()=>s,xI:()=>r});Object.freeze({status:"aborted"});function r(e,t,n){function r(n,r){var s;Object.defineProperty(n,"_zod",{value:n._zod??{},enumerable:!1}),(s=n._zod).traits??(s.traits=new Set),n._zod.traits.add(e),t(n,r);for(const e in a.prototype)e in n||Object.defineProperty(n,e,{value:a.prototype[e].bind(n)});n._zod.constr=a,n._zod.def=r}const s=n?.Parent??Object;class i extends s{}function a(e){var t;const s=n?.Parent?new i:this;r(s,e),(t=s._zod).deferred??(t.deferred=[]);for(const e of s._zod.deferred)e();return s}return Object.defineProperty(i,"name",{value:e}),Object.defineProperty(a,"init",{value:r}),Object.defineProperty(a,Symbol.hasInstance,{value:t=>!!(n?.Parent&&t instanceof n.Parent)||t?._zod?.traits?.has(e)}),Object.defineProperty(a,"name",{value:e}),a}Symbol("zod_brand");class s extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const i={};function a(e){return e&&Object.assign(i,e),i}},5454:(e,t,n)=>{"use strict";n.d(t,{a7:()=>i,xc:()=>s});var r=n(3490);class s extends r.XQ{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}}class i extends r.gj{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}constructor(e,t){super(e,t)}concat(e){return new i({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),id:this.id??e.id})}}},5476:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>Qa});var r="undefined"!=typeof window?window:void 0,s="undefined"!=typeof globalThis?globalThis:r,i=Array.prototype,a=i.forEach,o=i.indexOf,c=null==s?void 0:s.navigator,l=null==s?void 0:s.document,u=null==s?void 0:s.location,d=null==s?void 0:s.fetch,h=null!=s&&s.XMLHttpRequest&&"withCredentials"in new s.XMLHttpRequest?s.XMLHttpRequest:void 0,p=null==s?void 0:s.AbortController,m=null==c?void 0:c.userAgent,g=null!=r?r:{},f={DEBUG:!1,LIB_VERSION:"1.261.6"};function y(){return y=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},y.apply(null,arguments)}function _(e,t){if(null==e)return{};var n={};for(var r in e)if({}.hasOwnProperty.call(e,r)){if(-1!==t.indexOf(r))continue;n[r]=e[r]}return n}var b=["$snapshot","$pageview","$pageleave","$set","survey dismissed","survey sent","survey shown","$identify","$groupidentify","$create_alias","$$client_ingestion_warning","$web_experiment_applied","$feature_enrollment_update","$feature_flag_called"];function w(e,t){return-1!==e.indexOf(t)}var v=function(e){return e.trim()},E=function(e){return e.replace(/^\$/,"")},S=Array.isArray,x=Object.prototype,k=x.hasOwnProperty,T=x.toString,I=S||function(e){return"[object Array]"===T.call(e)},O=e=>"function"==typeof e,C=e=>e===Object(e)&&!I(e),A=e=>{if(C(e)){for(var t in e)if(k.call(e,t))return!1;return!0}return!1},P=e=>void 0===e,M=e=>"[object String]"==T.call(e),R=e=>M(e)&&0===e.trim().length,$=e=>null===e,j=e=>P(e)||$(e),N=e=>"[object Number]"==T.call(e),L=e=>"[object Boolean]"===T.call(e),D=e=>w(b,e),U=[!0,"true",1,"1","yes"],F=e=>w(U,e),Y=[!1,"false",0,"0","no"];function G(e,t,n,r,s){return t>n&&(r.warn("min cannot be greater than max."),t=n),N(e)?e>n?(r.warn(" cannot be  greater than max: "+n+". Using max value instead."),n):e<t?(r.warn(" cannot be less than min: "+t+". Using min value instead."),t):e:(r.warn(" must be a number. using max or fallback. max: "+n+", fallback: "+s),G(s||n,t,n,r))}class B{stop(){this.t&&(clearInterval(this.t),this.t=void 0)}constructor(e){this.i=e,this.o={},this.h=()=>{Object.keys(this.o).forEach(e=>{var t=this.m(e)+this.S;t>=this.$?delete this.o[e]:this.k(e,t)})},this.m=e=>this.o[String(e)],this.k=(e,t)=>{this.o[String(e)]=t},this.consumeRateLimit=e=>{var t,n=null!=(t=this.m(e))?t:this.$;if(0===(n=Math.max(n-1,0)))return!0;this.k(e,n);var r,s=0===n;return s&&(null==(r=this.I)||r.call(this,e)),s},this.I=this.i.I,this.$=G(this.i.bucketSize,0,100,this.i.R),this.S=G(this.i.refillRate,0,this.$,this.i.R),this.P=G(this.i.refillInterval,0,864e5,this.i.R),this.t=setInterval(()=>{this.h()},this.P)}}var H=e=>{var t={T:function(t){if(r&&(f.DEBUG||g.POSTHOG_DEBUG)&&!P(r.console)&&r.console){for(var n=("__rrweb_original__"in r.console[t]?r.console[t].__rrweb_original__:r.console[t]),s=arguments.length,i=new Array(s>1?s-1:0),a=1;a<s;a++)i[a-1]=arguments[a];n(e,...i)}},info:function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];t.T("log",...n)},warn:function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];t.T("warn",...n)},error:function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];t.T("error",...n)},critical:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n]},uninitializedWarning:e=>{t.error("You must initialize PostHog before calling "+e)},createLogger:t=>H(e+" "+t)};return t},z=H("[PostHog.js]"),q=z.createLogger,K=q("[ExternalScriptsLoader]"),W=(e,t,n)=>{if(e.config.disable_external_dependency_loading)return K.warn(t+" was requested but loading of external scripts is disabled."),n("Loading of external scripts is disabled");var r=null==l?void 0:l.querySelectorAll("script");if(r)for(var s,i=function(){if(r[a].src===t){var e=r[a];return e.__posthog_loading_callback_fired?{v:n()}:(e.addEventListener("load",t=>{e.__posthog_loading_callback_fired=!0,n(void 0,t)}),e.onerror=e=>n(e),{v:void 0})}},a=0;a<r.length;a++)if(s=i())return s.v;var o=()=>{if(!l)return n("document not found");var r=l.createElement("script");if(r.type="text/javascript",r.crossOrigin="anonymous",r.src=t,r.onload=e=>{r.__posthog_loading_callback_fired=!0,n(void 0,e)},r.onerror=e=>n(e),e.config.prepare_external_dependency_script&&(r=e.config.prepare_external_dependency_script(r)),!r)return n("prepare_external_dependency_script returned null");var s,i=l.querySelectorAll("body > script");i.length>0?null==(s=i[0].parentNode)||s.insertBefore(r,i[0]):l.body.appendChild(r)};null!=l&&l.body?o():null==l||l.addEventListener("DOMContentLoaded",o)};g.__PosthogExtensions__=g.__PosthogExtensions__||{},g.__PosthogExtensions__.loadExternalDependency=(e,t,n)=>{var r="/static/"+t+".js?v="+e.version;if("remote-config"===t&&(r="/array/"+e.config.token+"/config.js"),"toolbar"===t){var s=3e5;r=r+"&t="+Math.floor(Date.now()/s)*s}var i=e.requestRouter.endpointFor("assets",r);W(e,i,n)},g.__PosthogExtensions__.loadSiteApp=(e,t,n)=>{var r=e.requestRouter.endpointFor("api",t);W(e,r,n)};var V={};function J(e,t,n){if(I(e))if(a&&e.forEach===a)e.forEach(t,n);else if("length"in e&&e.length===+e.length)for(var r=0,s=e.length;r<s;r++)if(r in e&&t.call(n,e[r],r)===V)return}function Z(e,t,n){if(!j(e)){if(I(e))return J(e,t,n);if((e=>e instanceof FormData)(e)){for(var r of e.entries())if(t.call(n,r[1],r[0])===V)return}else for(var s in e)if(k.call(e,s)&&t.call(n,e[s],s)===V)return}}var X=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return J(n,function(t){for(var n in t)void 0!==t[n]&&(e[n]=t[n])}),e},Q=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return J(n,function(t){J(t,function(t){e.push(t)})}),e};function ee(e){for(var t=Object.keys(e),n=t.length,r=new Array(n);n--;)r[n]=[t[n],e[t[n]]];return r}var te=function(e){try{return e()}catch(e){return}},ne=function(e){return function(){try{for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.apply(this,n)}catch(e){z.critical("Implementation error. Please turn on debug mode and open a ticket on https://app.posthog.com/home#panel=support%3Asupport%3A."),z.critical(e)}}},re=function(e){var t={};return Z(e,function(e,n){(M(e)&&e.length>0||N(e))&&(t[n]=e)}),t};var se=["herokuapp.com","vercel.app","netlify.app"];function ie(e){var t=null==e?void 0:e.hostname;if(!M(t))return!1;var n=t.split(".").slice(-2).join(".");for(var r of se)if(n===r)return!1;return!0}function ae(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return e[n]}function oe(e,t,n,r){var{capture:s=!1,passive:i=!0}=null!=r?r:{};null==e||e.addEventListener(t,n,{capture:s,passive:i})}var ce="$people_distinct_id",le="__alias",ue="__timers",de="$autocapture_disabled_server_side",he="$heatmaps_enabled_server_side",pe="$exception_capture_enabled_server_side",me="$error_tracking_suppression_rules",ge="$error_tracking_capture_extension_exceptions",fe="$web_vitals_enabled_server_side",ye="$dead_clicks_enabled_server_side",_e="$web_vitals_allowed_metrics",be="$session_recording_enabled_server_side",we="$console_log_recording_enabled_server_side",ve="$session_recording_network_payload_capture",Ee="$session_recording_masking",Se="$session_recording_canvas_recording",xe="$replay_sample_rate",ke="$replay_minimum_duration",Te="$replay_script_config",Ie="$sesid",Oe="$session_is_sampled",Ce="$session_recording_url_trigger_activated_session",Ae="$session_recording_event_trigger_activated_session",Pe="$enabled_feature_flags",Me="$early_access_features",Re="$feature_flag_details",$e="$stored_person_properties",je="$stored_group_properties",Ne="$surveys",Le="$surveys_activated",De="$flag_call_reported",Ue="$user_state",Fe="$client_session_props",Ye="$capture_rate_limit",Ge="$initial_campaign_params",Be="$initial_referrer_info",He="$initial_person_info",ze="$epp",qe="__POSTHOG_TOOLBAR__",Ke="$posthog_cookieless",We=[ce,le,"__cmpns",ue,be,he,Ie,Pe,me,Ue,Me,Re,je,$e,Ne,De,Fe,Ye,Ge,Be,ze,He];function Ve(e){return e instanceof Element&&(e.id===qe||!(null==e.closest||!e.closest(".toolbar-global-fade-container")))}function Je(e){return!!e&&1===e.nodeType}function Ze(e,t){return!!e&&!!e.tagName&&e.tagName.toLowerCase()===t.toLowerCase()}function Xe(e){return!!e&&3===e.nodeType}function Qe(e){return!!e&&11===e.nodeType}function et(e){return e?v(e).split(/\s+/):[]}function tt(e){var t=null==r?void 0:r.location.href;return!!(t&&e&&e.some(e=>t.match(e)))}function nt(e){var t="";switch(typeof e.className){case"string":t=e.className;break;case"object":t=(e.className&&"baseVal"in e.className?e.className.baseVal:null)||e.getAttribute("class")||"";break;default:t=""}return et(t)}function rt(e){return j(e)?null:v(e).split(/(\s+)/).filter(e=>ft(e)).join("").replace(/[\r\n]/g," ").replace(/[ ]+/g," ").substring(0,255)}function st(e){var t="";return ct(e)&&!lt(e)&&e.childNodes&&e.childNodes.length&&Z(e.childNodes,function(e){var n;Xe(e)&&e.textContent&&(t+=null!==(n=rt(e.textContent))&&void 0!==n?n:"")}),v(t)}function it(e){return P(e.target)?e.srcElement||null:null!=(t=e.target)&&t.shadowRoot?e.composedPath()[0]||null:e.target||null;var t}var at=["a","button","form","input","select","textarea","label"];function ot(e){var t=e.parentNode;return!(!t||!Je(t))&&t}function ct(e){for(var t=e;t.parentNode&&!Ze(t,"body");t=t.parentNode){var n=nt(t);if(w(n,"ph-sensitive")||w(n,"ph-no-capture"))return!1}if(w(nt(e),"ph-include"))return!0;var r=e.type||"";if(M(r))switch(r.toLowerCase()){case"hidden":case"password":return!1}var s=e.name||e.id||"";return!M(s)||!/^cc|cardnum|ccnum|creditcard|csc|cvc|cvv|exp|pass|pwd|routing|seccode|securitycode|securitynum|socialsec|socsec|ssn/i.test(s.replace(/[^a-zA-Z0-9]/g,""))}function lt(e){return!!(Ze(e,"input")&&!["button","checkbox","submit","reset"].includes(e.type)||Ze(e,"select")||Ze(e,"textarea")||"true"===e.getAttribute("contenteditable"))}var ut="(4[0-9]{12}(?:[0-9]{3})?)|(5[1-5][0-9]{14})|(6(?:011|5[0-9]{2})[0-9]{12})|(3[47][0-9]{13})|(3(?:0[0-5]|[68][0-9])[0-9]{11})|((?:2131|1800|35[0-9]{3})[0-9]{11})",dt=new RegExp("^(?:"+ut+")$"),ht=new RegExp(ut),pt="\\d{3}-?\\d{2}-?\\d{4}",mt=new RegExp("^("+pt+")$"),gt=new RegExp("("+pt+")");function ft(e,t){if(void 0===t&&(t=!0),j(e))return!1;if(M(e)){if(e=v(e),(t?dt:ht).test((e||"").replace(/[- ]/g,"")))return!1;if((t?mt:gt).test(e))return!1}return!0}function yt(e){var t=st(e);return ft(t=(t+" "+_t(e)).trim())?t:""}function _t(e){var t="";return e&&e.childNodes&&e.childNodes.length&&Z(e.childNodes,function(e){var n;if(e&&"span"===(null==(n=e.tagName)?void 0:n.toLowerCase()))try{var r=st(e);t=(t+" "+r).trim(),e.childNodes&&e.childNodes.length&&(t=(t+" "+_t(e)).trim())}catch(e){z.error("[AutoCapture]",e)}}),t}function bt(e){return function(e){var t=e.map(e=>{var t,n,r="";if(e.tag_name&&(r+=e.tag_name),e.attr_class)for(var s of(e.attr_class.sort(),e.attr_class))r+="."+s.replace(/"/g,"");var i=y({},e.text?{text:e.text}:{},{"nth-child":null!==(t=e.nth_child)&&void 0!==t?t:0,"nth-of-type":null!==(n=e.nth_of_type)&&void 0!==n?n:0},e.href?{href:e.href}:{},e.attr_id?{attr_id:e.attr_id}:{},e.attributes),a={};return ee(i).sort((e,t)=>{var[n]=e,[r]=t;return n.localeCompare(r)}).forEach(e=>{var[t,n]=e;return a[wt(t.toString())]=wt(n.toString())}),(r+=":")+ee(a).map(e=>{var[t,n]=e;return t+'="'+n+'"'}).join("")});return t.join(";")}(function(e){return e.map(e=>{var t,n,r={text:null==(t=e.$el_text)?void 0:t.slice(0,400),tag_name:e.tag_name,href:null==(n=e.attr__href)?void 0:n.slice(0,2048),attr_class:vt(e),attr_id:e.attr__id,nth_child:e.nth_child,nth_of_type:e.nth_of_type,attributes:{}};return ee(e).filter(e=>{var[t]=e;return 0===t.indexOf("attr__")}).forEach(e=>{var[t,n]=e;return r.attributes[t]=n}),r})}(e))}function wt(e){return e.replace(/"|\\"/g,'\\"')}function vt(e){var t=e.attr__class;return t?I(t)?t:et(t):void 0}class Et{constructor(){this.clicks=[]}isRageClick(e,t,n){var r=this.clicks[this.clicks.length-1];if(r&&Math.abs(e-r.x)+Math.abs(t-r.y)<30&&n-r.timestamp<1e3){if(this.clicks.push({x:e,y:t,timestamp:n}),3===this.clicks.length)return!0}else this.clicks=[{x:e,y:t,timestamp:n}];return!1}}var St="$copy_autocapture",xt=function(e){return e.GZipJS="gzip-js",e.Base64="base64",e}({}),kt=["fatal","error","warning","log","info","debug"],Tt=["localhost","127.0.0.1"],It=e=>{var t=null==l?void 0:l.createElement("a");return P(t)?null:(t.href=e,t)},Ot=function(e,t){for(var n,r=((e.split("#")[0]||"").split(/\?(.*)/)[1]||"").replace(/^\?+/g,"").split("&"),s=0;s<r.length;s++){var i=r[s].split("=");if(i[0]===t){n=i;break}}if(!I(n)||n.length<2)return"";var a=n[1];try{a=decodeURIComponent(a)}catch(e){z.error("Skipping decoding for malformed query param: "+a)}return a.replace(/\+/g," ")},Ct=function(e,t,n){if(!e||!t||!t.length)return e;for(var r=e.split("#"),s=r[0]||"",i=r[1],a=s.split("?"),o=a[1],c=a[0],l=(o||"").split("&"),u=[],d=0;d<l.length;d++){var h=l[d].split("=");I(h)&&(t.includes(h[0])?u.push(h[0]+"="+n):u.push(l[d]))}var p=c;return null!=o&&(p+="?"+u.join("&")),null!=i&&(p+="#"+i),p},At=function(e,t){var n=e.match(new RegExp(t+"=([^&]*)"));return n?n[1]:null},Pt=q("[AutoCapture]");function Mt(e,t){return t.length>e?t.slice(0,e)+"...":t}function Rt(e){if(e.previousElementSibling)return e.previousElementSibling;var t=e;do{t=t.previousSibling}while(t&&!Je(t));return t}function $t(e,t){for(var n,s,{e:i,maskAllElementAttributes:a,maskAllText:o,elementAttributeIgnoreList:c,elementsChainAsString:l}=t,u=[e],d=e;d.parentNode&&!Ze(d,"body");)Qe(d.parentNode)?(u.push(d.parentNode.host),d=d.parentNode.host):(u.push(d.parentNode),d=d.parentNode);var h,p=[],m={},g=!1,f=!1;if(Z(u,e=>{var t=ct(e);"a"===e.tagName.toLowerCase()&&(g=e.getAttribute("href"),g=t&&g&&ft(g)&&g),w(nt(e),"ph-no-capture")&&(f=!0),p.push(function(e,t,n,r){var s=e.tagName.toLowerCase(),i={tag_name:s};at.indexOf(s)>-1&&!n&&("a"===s.toLowerCase()||"button"===s.toLowerCase()?i.$el_text=Mt(1024,yt(e)):i.$el_text=Mt(1024,st(e)));var a=nt(e);a.length>0&&(i.classes=a.filter(function(e){return""!==e})),Z(e.attributes,function(n){var s;if((!lt(e)||-1!==["name","id","class","aria-label"].indexOf(n.name))&&(null==r||!r.includes(n.name))&&!t&&ft(n.value)&&(s=n.name,!M(s)||"_ngcontent"!==s.substring(0,10)&&"_nghost"!==s.substring(0,7))){var a=n.value;"class"===n.name&&(a=et(a).join(" ")),i["attr__"+n.name]=Mt(1024,a)}});for(var o=1,c=1,l=e;l=Rt(l);)o++,l.tagName===e.tagName&&c++;return i.nth_child=o,i.nth_of_type=c,i}(e,a,o,c));var n=function(e){if(!ct(e))return{};var t={};return Z(e.attributes,function(e){if(e.name&&0===e.name.indexOf("data-ph-capture-attribute")){var n=e.name.replace("data-ph-capture-attribute-",""),r=e.value;n&&r&&ft(r)&&(t[n]=r)}}),t}(e);X(m,n)}),f)return{props:{},explicitNoCapture:f};if(o||("a"===e.tagName.toLowerCase()||"button"===e.tagName.toLowerCase()?p[0].$el_text=yt(e):p[0].$el_text=st(e)),g){var y,_;p[0].attr__href=g;var b=null==(y=It(g))?void 0:y.host,v=null==r||null==(_=r.location)?void 0:_.host;b&&v&&b!==v&&(h=g)}return{props:X({$event_type:i.type,$ce_version:1},l?{}:{$elements:p},{$elements_chain:bt(p)},null!=(n=p[0])&&n.$el_text?{$el_text:null==(s=p[0])?void 0:s.$el_text}:{},h&&"click"===i.type?{$external_click_url:h}:{},m)}}class jt{constructor(e){this.C=!1,this.M=null,this.rageclicks=new Et,this.O=!1,this.instance=e,this.F=null}get A(){var e,t,n=C(this.instance.config.autocapture)?this.instance.config.autocapture:{};return n.url_allowlist=null==(e=n.url_allowlist)?void 0:e.map(e=>new RegExp(e)),n.url_ignorelist=null==(t=n.url_ignorelist)?void 0:t.map(e=>new RegExp(e)),n}D(){if(this.isBrowserSupported()){if(r&&l){var e=e=>{e=e||(null==r?void 0:r.event);try{this.j(e)}catch(e){Pt.error("Failed to capture event",e)}};if(oe(l,"submit",e,{capture:!0}),oe(l,"change",e,{capture:!0}),oe(l,"click",e,{capture:!0}),this.A.capture_copied_text){var t=e=>{e=e||(null==r?void 0:r.event),this.j(e,St)};oe(l,"copy",t,{capture:!0}),oe(l,"cut",t,{capture:!0})}}}else Pt.info("Disabling Automatic Event Collection because this browser is not supported")}startIfEnabled(){this.isEnabled&&!this.C&&(this.D(),this.C=!0)}onRemoteConfig(e){e.elementsChainAsString&&(this.O=e.elementsChainAsString),this.instance.persistence&&this.instance.persistence.register({[de]:!!e.autocapture_opt_out}),this.M=!!e.autocapture_opt_out,this.startIfEnabled()}setElementSelectors(e){this.F=e}getElementSelectors(e){var t,n=[];return null==(t=this.F)||t.forEach(t=>{var r=null==l?void 0:l.querySelectorAll(t);null==r||r.forEach(r=>{e===r&&n.push(t)})}),n}get isEnabled(){var e,t,n=null==(e=this.instance.persistence)?void 0:e.props[de],r=this.M;if($(r)&&!L(n)&&!this.instance.L())return!1;var s=null!==(t=this.M)&&void 0!==t?t:!!n;return!!this.instance.config.autocapture&&!s}j(e,t){if(void 0===t&&(t="$autocapture"),this.isEnabled){var n,s=it(e);Xe(s)&&(s=s.parentNode||null),"$autocapture"===t&&"click"===e.type&&e instanceof MouseEvent&&this.instance.config.rageclick&&null!=(n=this.rageclicks)&&n.isRageClick(e.clientX,e.clientY,(new Date).getTime())&&this.j(e,"$rageclick");var i=t===St;if(s&&function(e,t,n,s,i){var a,o,c;if(void 0===n&&(n=void 0),!r||!e||Ze(e,"html")||!Je(e))return!1;if(null!=(a=n)&&a.url_allowlist&&!tt(n.url_allowlist))return!1;if(null!=(o=n)&&o.url_ignorelist&&tt(n.url_ignorelist))return!1;if(null!=(c=n)&&c.dom_event_allowlist){var l=n.dom_event_allowlist;if(l&&!l.some(e=>t.type===e))return!1}for(var u=!1,d=[e],h=!0,p=e;p.parentNode&&!Ze(p,"body");)if(Qe(p.parentNode))d.push(p.parentNode.host),p=p.parentNode.host;else{if(!(h=ot(p)))break;if(s||at.indexOf(h.tagName.toLowerCase())>-1)u=!0;else{var m=r.getComputedStyle(h);m&&"pointer"===m.getPropertyValue("cursor")&&(u=!0)}d.push(h),p=h}if(!function(e,t){var n=null==t?void 0:t.element_allowlist;if(P(n))return!0;var r,s=function(e){if(n.some(t=>e.tagName.toLowerCase()===t))return{v:!0}};for(var i of e)if(r=s(i))return r.v;return!1}(d,n))return!1;if(!function(e,t){var n=null==t?void 0:t.css_selector_allowlist;if(P(n))return!0;var r,s=function(e){if(n.some(t=>e.matches(t)))return{v:!0}};for(var i of e)if(r=s(i))return r.v;return!1}(d,n))return!1;var g=r.getComputedStyle(e);if(g&&"pointer"===g.getPropertyValue("cursor")&&"click"===t.type)return!0;var f=e.tagName.toLowerCase();switch(f){case"html":return!1;case"form":return(i||["submit"]).indexOf(t.type)>=0;case"input":case"select":case"textarea":return(i||["change","click"]).indexOf(t.type)>=0;default:return u?(i||["click"]).indexOf(t.type)>=0:(i||["click"]).indexOf(t.type)>=0&&(at.indexOf(f)>-1||"true"===e.getAttribute("contenteditable"))}}(s,e,this.A,i,i?["copy","cut"]:void 0)){var{props:a,explicitNoCapture:o}=$t(s,{e,maskAllElementAttributes:this.instance.config.mask_all_element_attributes,maskAllText:this.instance.config.mask_all_text,elementAttributeIgnoreList:this.A.element_attribute_ignorelist,elementsChainAsString:this.O});if(o)return!1;var c=this.getElementSelectors(s);if(c&&c.length>0&&(a.$element_selectors=c),t===St){var l,u=rt(null==r||null==(l=r.getSelection())?void 0:l.toString()),d=e.type||"clipboard";if(!u)return!1;a.$selected_content=u,a.$copy_type=d}return this.instance.capture(t,a),!0}}}isBrowserSupported(){return O(null==l?void 0:l.querySelectorAll)}}Math.trunc||(Math.trunc=function(e){return e<0?Math.ceil(e):Math.floor(e)}),Number.isInteger||(Number.isInteger=function(e){return N(e)&&isFinite(e)&&Math.floor(e)===e});var Nt="0123456789abcdef";class Lt{constructor(e){if(this.bytes=e,16!==e.length)throw new TypeError("not 128-bit length")}static fromFieldsV7(e,t,n,r){if(!Number.isInteger(e)||!Number.isInteger(t)||!Number.isInteger(n)||!Number.isInteger(r)||e<0||t<0||n<0||r<0||e>0xffffffffffff||t>4095||n>1073741823||r>4294967295)throw new RangeError("invalid field value");var s=new Uint8Array(16);return s[0]=e/Math.pow(2,40),s[1]=e/Math.pow(2,32),s[2]=e/Math.pow(2,24),s[3]=e/Math.pow(2,16),s[4]=e/Math.pow(2,8),s[5]=e,s[6]=112|t>>>8,s[7]=t,s[8]=128|n>>>24,s[9]=n>>>16,s[10]=n>>>8,s[11]=n,s[12]=r>>>24,s[13]=r>>>16,s[14]=r>>>8,s[15]=r,new Lt(s)}toString(){for(var e="",t=0;t<this.bytes.length;t++)e=e+Nt.charAt(this.bytes[t]>>>4)+Nt.charAt(15&this.bytes[t]),3!==t&&5!==t&&7!==t&&9!==t||(e+="-");if(36!==e.length)throw new Error("Invalid UUIDv7 was generated");return e}clone(){return new Lt(this.bytes.slice(0))}equals(e){return 0===this.compareTo(e)}compareTo(e){for(var t=0;t<16;t++){var n=this.bytes[t]-e.bytes[t];if(0!==n)return Math.sign(n)}return 0}}class Dt{constructor(){this.N=0,this.U=0,this.q=new Yt}generate(){var e=this.generateOrAbort();if(P(e)){this.N=0;var t=this.generateOrAbort();if(P(t))throw new Error("Could not generate UUID after timestamp reset");return t}return e}generateOrAbort(){var e=Date.now();if(e>this.N)this.N=e,this.B();else{if(!(e+1e4>this.N))return;this.U++,this.U>4398046511103&&(this.N++,this.B())}return Lt.fromFieldsV7(this.N,Math.trunc(this.U/Math.pow(2,30)),this.U&Math.pow(2,30)-1,this.q.nextUint32())}B(){this.U=1024*this.q.nextUint32()+(1023&this.q.nextUint32())}}var Ut,Ft=e=>{if("undefined"!=typeof UUIDV7_DENY_WEAK_RNG&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");for(var t=0;t<e.length;t++)e[t]=65536*Math.trunc(65536*Math.random())+Math.trunc(65536*Math.random());return e};r&&!P(r.crypto)&&crypto.getRandomValues&&(Ft=e=>crypto.getRandomValues(e));class Yt{constructor(){this.H=new Uint32Array(8),this.W=1/0}nextUint32(){return this.W>=this.H.length&&(Ft(this.H),this.W=0),this.H[this.W++]}}var Gt=()=>Bt().toString(),Bt=()=>(Ut||(Ut=new Dt)).generate(),Ht="",zt=/[a-z0-9][a-z0-9-]+\.[a-z]{2,}$/i;var qt={G:()=>!!l,J:function(e){z.error("cookieStore error: "+e)},V:function(e){if(l){try{for(var t=e+"=",n=l.cookie.split(";").filter(e=>e.length),r=0;r<n.length;r++){for(var s=n[r];" "==s.charAt(0);)s=s.substring(1,s.length);if(0===s.indexOf(t))return decodeURIComponent(s.substring(t.length,s.length))}}catch(e){}return null}},K:function(e){var t;try{t=JSON.parse(qt.V(e))||{}}catch(e){}return t},Y:function(e,t,n,r,s){if(l)try{var i="",a="",o=function(e,t){if(t){var n=function(e,t){if(void 0===t&&(t=l),Ht)return Ht;if(!t)return"";if(["localhost","127.0.0.1"].includes(e))return"";for(var n=e.split("."),r=Math.min(n.length,8),s="dmn_chk_"+Gt();!Ht&&r--;){var i=n.slice(r).join("."),a=s+"=1;domain=."+i+";path=/";t.cookie=a+";max-age=3",t.cookie.includes(s)&&(t.cookie=a+";max-age=0",Ht=i)}return Ht}(e);if(!n){var r=(e=>{var t=e.match(zt);return t?t[0]:""})(e);r!==n&&z.info("Warning: cookie subdomain discovery mismatch",r,n),n=r}return n?"; domain=."+n:""}return""}(l.location.hostname,r);if(n){var c=new Date;c.setTime(c.getTime()+24*n*60*60*1e3),i="; expires="+c.toUTCString()}s&&(a="; secure");var u=e+"="+encodeURIComponent(JSON.stringify(t))+i+"; SameSite=Lax; path=/"+o+a;return u.length>3686.4&&z.warn("cookieStore warning: large cookie, len="+u.length),l.cookie=u,u}catch(e){return}},X:function(e,t){if(null!=l&&l.cookie)try{qt.Y(e,"",-1,t)}catch(e){return}}},Kt=null,Wt={G:function(){if(!$(Kt))return Kt;var e=!0;if(P(r))e=!1;else try{var t="__mplssupport__";Wt.Y(t,"xyz"),'"xyz"'!==Wt.V(t)&&(e=!1),Wt.X(t)}catch(t){e=!1}return e||z.error("localStorage unsupported; falling back to cookie store"),Kt=e,e},J:function(e){z.error("localStorage error: "+e)},V:function(e){try{return null==r?void 0:r.localStorage.getItem(e)}catch(e){Wt.J(e)}return null},K:function(e){try{return JSON.parse(Wt.V(e))||{}}catch(e){}return null},Y:function(e,t){try{null==r||r.localStorage.setItem(e,JSON.stringify(t))}catch(e){Wt.J(e)}},X:function(e){try{null==r||r.localStorage.removeItem(e)}catch(e){Wt.J(e)}}},Vt=["distinct_id",Ie,Oe,ze,He],Jt=y({},Wt,{K:function(e){try{var t={};try{t=qt.K(e)||{}}catch(e){}var n=X(t,JSON.parse(Wt.V(e)||"{}"));return Wt.Y(e,n),n}catch(e){}return null},Y:function(e,t,n,r,s,i){try{Wt.Y(e,t,void 0,void 0,i);var a={};Vt.forEach(e=>{t[e]&&(a[e]=t[e])}),Object.keys(a).length&&qt.Y(e,a,n,r,s,i)}catch(e){Wt.J(e)}},X:function(e,t){try{null==r||r.localStorage.removeItem(e),qt.X(e,t)}catch(e){Wt.J(e)}}}),Zt={},Xt={G:function(){return!0},J:function(e){z.error("memoryStorage error: "+e)},V:function(e){return Zt[e]||null},K:function(e){return Zt[e]||null},Y:function(e,t){Zt[e]=t},X:function(e){delete Zt[e]}},Qt=null,en={G:function(){if(!$(Qt))return Qt;if(Qt=!0,P(r))Qt=!1;else try{var e="__support__";en.Y(e,"xyz"),'"xyz"'!==en.V(e)&&(Qt=!1),en.X(e)}catch(e){Qt=!1}return Qt},J:function(e){z.error("sessionStorage error: ",e)},V:function(e){try{return null==r?void 0:r.sessionStorage.getItem(e)}catch(e){en.J(e)}return null},K:function(e){try{return JSON.parse(en.V(e))||null}catch(e){}return null},Y:function(e,t){try{null==r||r.sessionStorage.setItem(e,JSON.stringify(t))}catch(e){en.J(e)}},X:function(e){try{null==r||r.sessionStorage.removeItem(e)}catch(e){en.J(e)}}},tn=function(e){return e[e.PENDING=-1]="PENDING",e[e.DENIED=0]="DENIED",e[e.GRANTED=1]="GRANTED",e}({});class nn{constructor(e){this._instance=e}get A(){return this._instance.config}get consent(){return this.Z()?tn.DENIED:this.tt}isOptedOut(){return"always"===this.A.cookieless_mode||this.consent===tn.DENIED||this.consent===tn.PENDING&&(this.A.opt_out_capturing_by_default||"on_reject"===this.A.cookieless_mode)}isOptedIn(){return!this.isOptedOut()}isExplicitlyOptedOut(){return this.consent===tn.DENIED}optInOut(e){this.it.Y(this.et,e?1:0,this.A.cookie_expiration,this.A.cross_subdomain_cookie,this.A.secure_cookie)}reset(){this.it.X(this.et,this.A.cross_subdomain_cookie)}get et(){var{token:e,opt_out_capturing_cookie_prefix:t,consent_persistence_name:n}=this._instance.config;return n||(t?t+e:"__ph_opt_in_out_"+e)}get tt(){var e=this.it.V(this.et);return F(e)?tn.GRANTED:w(Y,e)?tn.DENIED:tn.PENDING}get it(){if(!this.rt){var e=this.A.opt_out_capturing_persistence_type;this.rt="localStorage"===e?Wt:qt;var t="localStorage"===e?qt:Wt;t.V(this.et)&&(this.rt.V(this.et)||this.optInOut(F(t.V(this.et))),t.X(this.et,this.A.cross_subdomain_cookie))}return this.rt}Z(){return!!this.A.respect_dnt&&!!ae([null==c?void 0:c.doNotTrack,null==c?void 0:c.msDoNotTrack,g.doNotTrack],e=>F(e))}}var rn=q("[Dead Clicks]"),sn=()=>!0,an=e=>{var t,n=!(null==(t=e.instance.persistence)||!t.get_property(ye)),r=e.instance.config.capture_dead_clicks;return L(r)?r:n};class on{get lazyLoadedDeadClicksAutocapture(){return this.st}constructor(e,t,n){this.instance=e,this.isEnabled=t,this.onCapture=n,this.startIfEnabled()}onRemoteConfig(e){this.instance.persistence&&this.instance.persistence.register({[ye]:null==e?void 0:e.captureDeadClicks}),this.startIfEnabled()}startIfEnabled(){this.isEnabled(this)&&this.nt(()=>{this.ot()})}nt(e){var t,n;null!=(t=g.__PosthogExtensions__)&&t.initDeadClicksAutocapture&&e(),null==(n=g.__PosthogExtensions__)||null==n.loadExternalDependency||n.loadExternalDependency(this.instance,"dead-clicks-autocapture",t=>{t?rn.error("failed to load script",t):e()})}ot(){var e;if(l){if(!this.st&&null!=(e=g.__PosthogExtensions__)&&e.initDeadClicksAutocapture){var t=C(this.instance.config.capture_dead_clicks)?this.instance.config.capture_dead_clicks:{};t.__onCapture=this.onCapture,this.st=g.__PosthogExtensions__.initDeadClicksAutocapture(this.instance,t),this.st.start(l),rn.info("starting...")}}else rn.error("`document` not found. Cannot start.")}stop(){this.st&&(this.st.stop(),this.st=void 0,rn.info("stopping..."))}}var cn=q("[ExceptionAutocapture]");class ln{constructor(e){var t,n,s;this.lt=()=>{var e;if(r&&this.isEnabled&&null!=(e=g.__PosthogExtensions__)&&e.errorWrappingFunctions){var t=g.__PosthogExtensions__.errorWrappingFunctions.wrapOnError,n=g.__PosthogExtensions__.errorWrappingFunctions.wrapUnhandledRejection,s=g.__PosthogExtensions__.errorWrappingFunctions.wrapConsoleError;try{!this.ht&&this.A.capture_unhandled_errors&&(this.ht=t(this.captureException.bind(this))),!this.ut&&this.A.capture_unhandled_rejections&&(this.ut=n(this.captureException.bind(this))),!this.dt&&this.A.capture_console_errors&&(this.dt=s(this.captureException.bind(this)))}catch(e){cn.error("failed to start",e),this.vt()}}},this._instance=e,this.ct=!(null==(t=this._instance.persistence)||!t.props[pe]),this.A=this.ft(),this.gt=new B({refillRate:null!==(n=this._instance.config.error_tracking.__exceptionRateLimiterRefillRate)&&void 0!==n?n:1,bucketSize:null!==(s=this._instance.config.error_tracking.__exceptionRateLimiterBucketSize)&&void 0!==s?s:10,refillInterval:1e4,R:cn}),this.startIfEnabled()}ft(){var e=this._instance.config.capture_exceptions,t={capture_unhandled_errors:!1,capture_unhandled_rejections:!1,capture_console_errors:!1};return C(e)?t=y({},t,e):(P(e)?this.ct:e)&&(t=y({},t,{capture_unhandled_errors:!0,capture_unhandled_rejections:!0})),t}get isEnabled(){return this.A.capture_console_errors||this.A.capture_unhandled_errors||this.A.capture_unhandled_rejections}startIfEnabled(){this.isEnabled&&(cn.info("enabled"),this.nt(this.lt))}nt(e){var t,n;null!=(t=g.__PosthogExtensions__)&&t.errorWrappingFunctions&&e(),null==(n=g.__PosthogExtensions__)||null==n.loadExternalDependency||n.loadExternalDependency(this._instance,"exception-autocapture",t=>{if(t)return cn.error("failed to load script",t);e()})}vt(){var e,t,n;null==(e=this.ht)||e.call(this),this.ht=void 0,null==(t=this.ut)||t.call(this),this.ut=void 0,null==(n=this.dt)||n.call(this),this.dt=void 0}onRemoteConfig(e){var t=e.autocaptureExceptions;this.ct=!!t||!1,this.A=this.ft(),this._instance.persistence&&this._instance.persistence.register({[pe]:this.ct}),this.startIfEnabled()}captureException(e){var t,n=this._instance.requestRouter.endpointFor("ui");e.$exception_personURL=n+"/project/"+this._instance.config.token+"/person/"+this._instance.get_distinct_id();var r=null!==(t=e.$exception_list[0].type)&&void 0!==t?t:"Exception";this.gt.consumeRateLimit(r)?cn.info("Skipping exception capture because of client rate limiting.",{exception:e.$exception_list[0].type}):this._instance.exceptions.sendExceptionEvent(e)}}function un(e){return!P(Event)&&dn(e,Event)}function dn(e,t){try{return e instanceof t}catch(e){return!1}}function hn(e){switch(Object.prototype.toString.call(e)){case"[object Error]":case"[object Exception]":case"[object DOMException]":case"[object DOMError]":return!0;default:return dn(e,Error)}}function pn(e,t){return Object.prototype.toString.call(e)==="[object "+t+"]"}function mn(e){return pn(e,"DOMError")}var gn=/\(error: (.*)\)/,fn="?";function yn(e,t,n,r){var s={platform:"web:javascript",filename:e,function:"<anonymous>"===t?fn:t,in_app:!0};return P(n)||(s.lineno=n),P(r)||(s.colno=r),s}var _n=/^\s*at (\S+?)(?::(\d+))(?::(\d+))\s*$/i,bn=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,wn=/\((\S*)(?::(\d+))(?::(\d+))\)/,vn=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,En=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,Sn=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t.sort((e,t)=>e[0]-t[0]).map(e=>e[1]);return function(e,t){void 0===t&&(t=0);for(var n=[],s=e.split("\n"),i=t;i<s.length;i++){var a=s[i];if(!(a.length>1024)){var o=gn.test(a)?a.replace(gn,"$1"):a;if(!o.match(/\S*Error: /)){for(var c of r){var l=c(o);if(l){n.push(l);break}}if(n.length>=50)break}}}return function(e){if(!e.length)return[];var t=Array.from(e);return t.reverse(),t.slice(0,50).map(e=>y({},e,{filename:e.filename||xn(t).filename,function:e.function||fn}))}(n)}}([30,e=>{var t=_n.exec(e);if(t){var[,n,r,s]=t;return yn(n,fn,+r,+s)}var i=bn.exec(e);if(i){if(i[2]&&0===i[2].indexOf("eval")){var a=wn.exec(i[2]);a&&(i[2]=a[1],i[3]=a[2],i[4]=a[3])}var[o,c]=On(i[1]||fn,i[2]);return yn(c,o,i[3]?+i[3]:void 0,i[4]?+i[4]:void 0)}}],[50,e=>{var t=vn.exec(e);if(t){if(t[3]&&t[3].indexOf(" > eval")>-1){var n=En.exec(t[3]);n&&(t[1]=t[1]||"eval",t[3]=n[1],t[4]=n[2],t[5]="")}var r=t[3],s=t[1]||fn;return[s,r]=On(s,r),yn(r,s,t[4]?+t[4]:void 0,t[5]?+t[5]:void 0)}}]);function xn(e){return e[e.length-1]||{}}var kn,Tn,In,On=(e,t)=>{var n=-1!==e.indexOf("safari-extension"),r=-1!==e.indexOf("safari-web-extension");return n||r?[-1!==e.indexOf("@")?e.split("@")[0]:fn,n?"safari-extension:"+t:"safari-web-extension:"+t]:[e,t]},Cn=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/i;function An(e,t){void 0===t&&(t=0);var n=e.stacktrace||e.stack||"",r=function(e){return e&&Pn.test(e.message)?1:0}(e);try{var s=Sn,i=function(e,t){var n=function(e){var t=globalThis._posthogChunkIds;if(!t)return{};var n=Object.keys(t);return In&&n.length===Tn||(Tn=n.length,In=n.reduce((n,r)=>{kn||(kn={});var s=kn[r];if(s)n[s[0]]=s[1];else for(var i=e(r),a=i.length-1;a>=0;a--){var o=i[a],c=null==o?void 0:o.filename,l=t[r];if(c&&l){n[c]=l,kn[r]=[c,l];break}}return n},{})),In}(t);return e.forEach(e=>{e.filename&&(e.chunk_id=n[e.filename])}),e}(s(n,r),s);return i.slice(0,i.length-t)}catch(e){}return[]}var Pn=/Minified React error #\d+;/i;function Mn(e,t){var n=function(e,t){var n,r,s=An(e),i=null===(n=null==t?void 0:t.handled)||void 0===n||n,a=null!==(r=null==t?void 0:t.synthetic)&&void 0!==r&&r;return{type:null!=t&&t.overrideExceptionType?t.overrideExceptionType:e.name,value:function(e){var t=e.message;return t.error&&"string"==typeof t.error.message?String(t.error.message):String(t)}(e),stacktrace:{frames:s,type:"raw"},mechanism:{handled:i,synthetic:a}}}(e,t);return e.cause&&hn(e.cause)&&e.cause!==e?[n,...Mn(e.cause,{handled:null==t?void 0:t.handled,synthetic:null==t?void 0:t.synthetic})]:[n]}function Rn(e,t){return{$exception_list:Mn(e,t),$exception_level:"error"}}function $n(e,t){var n,r,s,i=null===(n=null==t?void 0:t.handled)||void 0===n||n,a=null===(r=null==t?void 0:t.synthetic)||void 0===r||r,o={type:null!=t&&t.overrideExceptionType?t.overrideExceptionType:null!==(s=null==t?void 0:t.defaultExceptionType)&&void 0!==s?s:"Error",value:e||(null==t?void 0:t.defaultExceptionMessage),mechanism:{handled:i,synthetic:a}};if(null!=t&&t.syntheticException){var c=An(t.syntheticException,1);c.length&&(o.stacktrace={frames:c,type:"raw"})}return{$exception_list:[o],$exception_level:"error"}}function jn(e){return M(e)&&!R(e)&&kt.indexOf(e)>=0}function Nn(e,t){var{error:n,event:r}=e,s={$exception_list:[]},i=n||r;if(mn(i)||function(e){return pn(e,"DOMException")}(i)){var a=i;if(function(e){return"stack"in e}(i))s=Rn(i,t);else{var o=a.name||(mn(a)?"DOMError":"DOMException"),c=a.message?o+": "+a.message:o;s=$n(c,y({},t,{overrideExceptionType:mn(a)?"DOMError":"DOMException",defaultExceptionMessage:c}))}return"code"in a&&(s.$exception_DOMException_code=""+a.code),s}if(function(e){return pn(e,"ErrorEvent")}(i)&&i.error)return Rn(i.error,t);if(hn(i))return Rn(i,t);if(function(e){return pn(e,"Object")}(i)||un(i))return function(e,t){var n,r,s=null===(n=null==t?void 0:t.handled)||void 0===n||n,i=null===(r=null==t?void 0:t.synthetic)||void 0===r||r,a=null!=t&&t.overrideExceptionType?t.overrideExceptionType:un(e)?e.constructor.name:"Error",o="Non-Error 'exception' captured with keys: "+function(e,t){void 0===t&&(t=40);var n=Object.keys(e);if(n.sort(),!n.length)return"[object has no keys]";for(var r=n.length;r>0;r--){var s=n.slice(0,r).join(", ");if(!(s.length>t))return r===n.length||s.length<=t?s:s.slice(0,t)+"..."}return""}(e),c={type:a,value:o,mechanism:{handled:s,synthetic:i}};if(null!=t&&t.syntheticException){var l=An(null==t?void 0:t.syntheticException,1);l.length&&(c.stacktrace={frames:l,type:"raw"})}return{$exception_list:[c],$exception_level:jn(e.level)?e.level:"error"}}(i,t);if(P(n)&&M(r)){var l="Error",u=r,d=r.match(Cn);return d&&(l=d[1],u=d[2]),$n(u,y({},t,{overrideExceptionType:l,defaultExceptionMessage:u}))}return $n(i,t)}function Ln(e,t,n){try{if(!(t in e))return()=>{};var r=e[t],s=n(r);return O(s)&&(s.prototype=s.prototype||{},Object.defineProperties(s,{__posthog_wrapped__:{enumerable:!1,value:!0}})),e[t]=s,()=>{e[t]=r}}catch(e){return()=>{}}}class Dn{constructor(e){var t;this._instance=e,this._t=(null==r||null==(t=r.location)?void 0:t.pathname)||""}get isEnabled(){return"history_change"===this._instance.config.capture_pageview}startIfEnabled(){this.isEnabled&&(z.info("History API monitoring enabled, starting..."),this.monitorHistoryChanges())}stop(){this.bt&&this.bt(),this.bt=void 0,z.info("History API monitoring stopped")}monitorHistoryChanges(){var e,t;if(r&&r.history){var n=this;null!=(e=r.history.pushState)&&e.__posthog_wrapped__||Ln(r.history,"pushState",e=>function(t,r,s){e.call(this,t,r,s),n.yt("pushState")}),null!=(t=r.history.replaceState)&&t.__posthog_wrapped__||Ln(r.history,"replaceState",e=>function(t,r,s){e.call(this,t,r,s),n.yt("replaceState")}),this.wt()}}yt(e){try{var t,n=null==r||null==(t=r.location)?void 0:t.pathname;if(!n)return;n!==this._t&&this.isEnabled&&this._instance.capture("$pageview",{navigation_type:e}),this._t=n}catch(t){z.error("Error capturing "+e+" pageview",t)}}wt(){if(!this.bt){var e=()=>{this.yt("popstate")};oe(r,"popstate",e),this.bt=()=>{r&&r.removeEventListener("popstate",e)}}}}function Un(e){var t,n;return(null==(t=JSON.stringify(e,(n=[],function(e,t){if(C(t)){for(;n.length>0&&n[n.length-1]!==this;)n.pop();return n.includes(t)?"[Circular]":(n.push(t),t)}return t})))?void 0:t.length)||0}function Fn(e,t){if(void 0===t&&(t=6606028.8),e.size>=t&&e.data.length>1){var n=Math.floor(e.data.length/2),r=e.data.slice(0,n),s=e.data.slice(n);return[Fn({size:Un(r),data:r,sessionId:e.sessionId,windowId:e.windowId}),Fn({size:Un(s),data:s,sessionId:e.sessionId,windowId:e.windowId})].flatMap(e=>e)}return[e]}var Yn=(e=>(e[e.DomContentLoaded=0]="DomContentLoaded",e[e.Load=1]="Load",e[e.FullSnapshot=2]="FullSnapshot",e[e.IncrementalSnapshot=3]="IncrementalSnapshot",e[e.Meta=4]="Meta",e[e.Custom=5]="Custom",e[e.Plugin=6]="Plugin",e))(Yn||{}),Gn=(e=>(e[e.Mutation=0]="Mutation",e[e.MouseMove=1]="MouseMove",e[e.MouseInteraction=2]="MouseInteraction",e[e.Scroll=3]="Scroll",e[e.ViewportResize=4]="ViewportResize",e[e.Input=5]="Input",e[e.TouchMove=6]="TouchMove",e[e.MediaInteraction=7]="MediaInteraction",e[e.StyleSheetRule=8]="StyleSheetRule",e[e.CanvasMutation=9]="CanvasMutation",e[e.Font=10]="Font",e[e.Log=11]="Log",e[e.Drag=12]="Drag",e[e.StyleDeclaration=13]="StyleDeclaration",e[e.Selection=14]="Selection",e[e.AdoptedStyleSheet=15]="AdoptedStyleSheet",e[e.CustomElement=16]="CustomElement",e))(Gn||{}),Bn="[SessionRecording]",Hn="redacted",zn={initiatorTypes:["audio","beacon","body","css","early-hint","embed","fetch","frame","iframe","icon","image","img","input","link","navigation","object","ping","script","track","video","xmlhttprequest"],maskRequestFn:e=>e,recordHeaders:!1,recordBody:!1,recordInitialRequests:!1,recordPerformance:!1,performanceEntryTypeToObserve:["first-input","navigation","paint","resource"],payloadSizeLimitBytes:1e6,payloadHostDenyList:[".lr-ingest.io",".ingest.sentry.io",".clarity.ms","analytics.google.com","bam.nr-data.net"]},qn=["authorization","x-forwarded-for","authorization","cookie","set-cookie","x-api-key","x-real-ip","remote-addr","forwarded","proxy-authorization","x-csrf-token","x-csrftoken","x-xsrf-token"],Kn=["password","secret","passwd","api_key","apikey","auth","credentials","mysql_pwd","privatekey","private_key","token"],Wn=["/s/","/e/","/i/"];function Vn(e,t,n,r){if(j(e))return e;var s=(null==t?void 0:t["content-length"])||function(e){return new Blob([e]).size}(e);return M(s)&&(s=parseInt(s)),s>n?Bn+" "+r+" body too large to record ("+s+" bytes)":e}function Jn(e,t){if(j(e))return e;var n=e;return ft(n,!1)||(n=Bn+" "+t+" body "+Hn),Z(Kn,e=>{var r,s;null!=(r=n)&&r.length&&-1!==(null==(s=n)?void 0:s.indexOf(e))&&(n=Bn+" "+t+" body "+Hn+" as might contain: "+e)}),n}class Zn{constructor(e,t){var n,r;void 0===t&&(t={}),this.St={},this.$t=e=>{if(!this.St[e]){var t,n;this.St[e]=!0;var r=this.kt(e);null==(t=(n=this.i).onBlockedNode)||t.call(n,e,r)}},this.xt=e=>{var t=this.kt(e);if("svg"!==(null==t?void 0:t.nodeName)&&t instanceof Element){var n=t.closest("svg");if(n)return[this._rrweb.mirror.getId(n),n]}return[e,t]},this.kt=e=>this._rrweb.mirror.getNode(e),this.Et=e=>{var t,n,r,s,i,a,o,c;return(null!==(t=null==(n=e.removes)?void 0:n.length)&&void 0!==t?t:0)+(null!==(r=null==(s=e.attributes)?void 0:s.length)&&void 0!==r?r:0)+(null!==(i=null==(a=e.texts)?void 0:a.length)&&void 0!==i?i:0)+(null!==(o=null==(c=e.adds)?void 0:c.length)&&void 0!==o?o:0)},this.throttleMutations=e=>{if(3!==e.type||0!==e.data.source)return e;var t=e.data,n=this.Et(t);t.attributes&&(t.attributes=t.attributes.filter(e=>{var[t]=this.xt(e.id);return!this.gt.consumeRateLimit(t)&&e}));var r=this.Et(t);return 0!==r||n===r?e:void 0},this._rrweb=e,this.i=t,this.gt=new B({bucketSize:null!==(n=this.i.bucketSize)&&void 0!==n?n:100,refillRate:null!==(r=this.i.refillRate)&&void 0!==r?r:10,refillInterval:1e3,I:this.$t,R:z})}}var Xn=Uint8Array,Qn=Uint16Array,er=Uint32Array,tr=new Xn([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),nr=new Xn([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),rr=new Xn([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),sr=function(e,t){for(var n=new Qn(31),r=0;r<31;++r)n[r]=t+=1<<e[r-1];var s=new er(n[30]);for(r=1;r<30;++r)for(var i=n[r];i<n[r+1];++i)s[i]=i-n[r]<<5|r;return[n,s]},ir=sr(tr,2),ar=ir[0],or=ir[1];ar[28]=258,or[258]=28;for(var cr=sr(nr,0)[1],lr=new Qn(32768),ur=0;ur<32768;++ur){var dr=(43690&ur)>>>1|(21845&ur)<<1;dr=(61680&(dr=(52428&dr)>>>2|(13107&dr)<<2))>>>4|(3855&dr)<<4,lr[ur]=((65280&dr)>>>8|(255&dr)<<8)>>>1}var hr=function(e,t,n){for(var r=e.length,s=0,i=new Qn(t);s<r;++s)++i[e[s]-1];var a,o=new Qn(t);for(s=0;s<t;++s)o[s]=o[s-1]+i[s-1]<<1;if(n){a=new Qn(1<<t);var c=15-t;for(s=0;s<r;++s)if(e[s])for(var l=s<<4|e[s],u=t-e[s],d=o[e[s]-1]++<<u,h=d|(1<<u)-1;d<=h;++d)a[lr[d]>>>c]=l}else for(a=new Qn(r),s=0;s<r;++s)a[s]=lr[o[e[s]-1]++]>>>15-e[s];return a},pr=new Xn(288);for(ur=0;ur<144;++ur)pr[ur]=8;for(ur=144;ur<256;++ur)pr[ur]=9;for(ur=256;ur<280;++ur)pr[ur]=7;for(ur=280;ur<288;++ur)pr[ur]=8;var mr=new Xn(32);for(ur=0;ur<32;++ur)mr[ur]=5;var gr=hr(pr,9,0),fr=hr(mr,5,0),yr=function(e){return(e/8|0)+(7&e&&1)},_r=function(e,t,n){(null==n||n>e.length)&&(n=e.length);var r=new(e instanceof Qn?Qn:e instanceof er?er:Xn)(n-t);return r.set(e.subarray(t,n)),r},br=function(e,t,n){n<<=7&t;var r=t/8|0;e[r]|=n,e[r+1]|=n>>>8},wr=function(e,t,n){n<<=7&t;var r=t/8|0;e[r]|=n,e[r+1]|=n>>>8,e[r+2]|=n>>>16},vr=function(e,t){for(var n=[],r=0;r<e.length;++r)e[r]&&n.push({s:r,f:e[r]});var s=n.length,i=n.slice();if(!s)return[new Xn(0),0];if(1==s){var a=new Xn(n[0].s+1);return a[n[0].s]=1,[a,1]}n.sort(function(e,t){return e.f-t.f}),n.push({s:-1,f:25001});var o=n[0],c=n[1],l=0,u=1,d=2;for(n[0]={s:-1,f:o.f+c.f,l:o,r:c};u!=s-1;)o=n[n[l].f<n[d].f?l++:d++],c=n[l!=u&&n[l].f<n[d].f?l++:d++],n[u++]={s:-1,f:o.f+c.f,l:o,r:c};var h=i[0].s;for(r=1;r<s;++r)i[r].s>h&&(h=i[r].s);var p=new Qn(h+1),m=Er(n[u-1],p,0);if(m>t){r=0;var g=0,f=m-t,y=1<<f;for(i.sort(function(e,t){return p[t.s]-p[e.s]||e.f-t.f});r<s;++r){var _=i[r].s;if(!(p[_]>t))break;g+=y-(1<<m-p[_]),p[_]=t}for(g>>>=f;g>0;){var b=i[r].s;p[b]<t?g-=1<<t-p[b]++-1:++r}for(;r>=0&&g;--r){var w=i[r].s;p[w]==t&&(--p[w],++g)}m=t}return[new Xn(p),m]},Er=function(e,t,n){return-1==e.s?Math.max(Er(e.l,t,n+1),Er(e.r,t,n+1)):t[e.s]=n},Sr=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new Qn(++t),r=0,s=e[0],i=1,a=function(e){n[r++]=e},o=1;o<=t;++o)if(e[o]==s&&o!=t)++i;else{if(!s&&i>2){for(;i>138;i-=138)a(32754);i>2&&(a(i>10?i-11<<5|28690:i-3<<5|12305),i=0)}else if(i>3){for(a(s),--i;i>6;i-=6)a(8304);i>2&&(a(i-3<<5|8208),i=0)}for(;i--;)a(s);i=1,s=e[o]}return[n.subarray(0,r),t]},xr=function(e,t){for(var n=0,r=0;r<t.length;++r)n+=e[r]*t[r];return n},kr=function(e,t,n){var r=n.length,s=yr(t+2);e[s]=255&r,e[s+1]=r>>>8,e[s+2]=255^e[s],e[s+3]=255^e[s+1];for(var i=0;i<r;++i)e[s+i+4]=n[i];return 8*(s+4+r)},Tr=function(e,t,n,r,s,i,a,o,c,l,u){br(t,u++,n),++s[256];for(var d=vr(s,15),h=d[0],p=d[1],m=vr(i,15),g=m[0],f=m[1],y=Sr(h),_=y[0],b=y[1],w=Sr(g),v=w[0],E=w[1],S=new Qn(19),x=0;x<_.length;++x)S[31&_[x]]++;for(x=0;x<v.length;++x)S[31&v[x]]++;for(var k=vr(S,7),T=k[0],I=k[1],O=19;O>4&&!T[rr[O-1]];--O);var C,A,P,M,R=l+5<<3,$=xr(s,pr)+xr(i,mr)+a,j=xr(s,h)+xr(i,g)+a+14+3*O+xr(S,T)+(2*S[16]+3*S[17]+7*S[18]);if(R<=$&&R<=j)return kr(t,u,e.subarray(c,c+l));if(br(t,u,1+(j<$)),u+=2,j<$){C=hr(h,p,0),A=h,P=hr(g,f,0),M=g;var N=hr(T,I,0);for(br(t,u,b-257),br(t,u+5,E-1),br(t,u+10,O-4),u+=14,x=0;x<O;++x)br(t,u+3*x,T[rr[x]]);u+=3*O;for(var L=[_,v],D=0;D<2;++D){var U=L[D];for(x=0;x<U.length;++x){var F=31&U[x];br(t,u,N[F]),u+=T[F],F>15&&(br(t,u,U[x]>>>5&127),u+=U[x]>>>12)}}}else C=gr,A=pr,P=fr,M=mr;for(x=0;x<o;++x)if(r[x]>255){F=r[x]>>>18&31,wr(t,u,C[F+257]),u+=A[F+257],F>7&&(br(t,u,r[x]>>>23&31),u+=tr[F]);var Y=31&r[x];wr(t,u,P[Y]),u+=M[Y],Y>3&&(wr(t,u,r[x]>>>5&8191),u+=nr[Y])}else wr(t,u,C[r[x]]),u+=A[r[x]];return wr(t,u,C[256]),u+A[256]},Ir=new er([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Or=function(){for(var e=new er(256),t=0;t<256;++t){for(var n=t,r=9;--r;)n=(1&n&&3988292384)^n>>>1;e[t]=n}return e}(),Cr=function(e,t,n){for(;n;++t)e[t]=n,n>>>=8};function Ar(e,t){void 0===t&&(t={});var n=function(){var e=4294967295;return{p:function(t){for(var n=e,r=0;r<t.length;++r)n=Or[255&n^t[r]]^n>>>8;e=n},d:function(){return 4294967295^e}}}(),r=e.length;n.p(e);var s=function(e,t,n,r){return function(e,t,n,r,s,i){var a=e.length,o=new Xn(r+a+5*(1+Math.floor(a/7e3))+s),c=o.subarray(r,o.length-s),l=0;if(!t||a<8)for(var u=0;u<=a;u+=65535){var d=u+65535;d<a?l=kr(c,l,e.subarray(u,d)):(c[u]=i,l=kr(c,l,e.subarray(u,a)))}else{for(var h=Ir[t-1],p=h>>>13,m=8191&h,g=(1<<n)-1,f=new Qn(32768),y=new Qn(g+1),_=Math.ceil(n/3),b=2*_,w=function(t){return(e[t]^e[t+1]<<_^e[t+2]<<b)&g},v=new er(25e3),E=new Qn(288),S=new Qn(32),x=0,k=0,T=(u=0,0),I=0,O=0;u<a;++u){var C=w(u),A=32767&u,P=y[C];if(f[A]=P,y[C]=A,I<=u){var M=a-u;if((x>7e3||T>24576)&&M>423){l=Tr(e,c,0,v,E,S,k,T,O,u-O,l),T=x=k=0,O=u;for(var R=0;R<286;++R)E[R]=0;for(R=0;R<30;++R)S[R]=0}var $=2,j=0,N=m,L=A-P&32767;if(M>2&&C==w(u-L))for(var D=Math.min(p,M)-1,U=Math.min(32767,u),F=Math.min(258,M);L<=U&&--N&&A!=P;){if(e[u+$]==e[u+$-L]){for(var Y=0;Y<F&&e[u+Y]==e[u+Y-L];++Y);if(Y>$){if($=Y,j=L,Y>D)break;var G=Math.min(L,Y-2),B=0;for(R=0;R<G;++R){var H=u-L+R+32768&32767,z=H-f[H]+32768&32767;z>B&&(B=z,P=H)}}}L+=(A=P)-(P=f[A])+32768&32767}if(j){v[T++]=268435456|or[$]<<18|cr[j];var q=31&or[$],K=31&cr[j];k+=tr[q]+nr[K],++E[257+q],++S[K],I=u+$,++x}else v[T++]=e[u],++E[e[u]]}}l=Tr(e,c,i,v,E,S,k,T,O,u-O,l)}return _r(o,0,r+yr(l)+s)}(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,n,r,!0)}(e,t,function(e){return 10+(e.filename&&e.filename.length+1||0)}(t),8),i=s.length;return function(e,t){var n=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&Cr(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),n){e[3]=8;for(var r=0;r<=n.length;++r)e[r+10]=n.charCodeAt(r)}}(s,t),Cr(s,i-8,n.d()),Cr(s,i-4,r),s}function Pr(e,t){var n=e.length;if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e);for(var r=new Xn(e.length+(e.length>>>1)),s=0,i=function(e){r[s++]=e},a=0;a<n;++a){if(s+5>r.length){var o=new Xn(s+8+(n-a<<1));o.set(r),r=o}var c=e.charCodeAt(a);c<128||t?i(c):c<2048?(i(192|c>>>6),i(128|63&c)):c>55295&&c<57344?(i(240|(c=65536+(1047552&c)|1023&e.charCodeAt(++a))>>>18),i(128|c>>>12&63),i(128|c>>>6&63),i(128|63&c)):(i(224|c>>>12),i(128|c>>>6&63),i(128|63&c))}return _r(r,0,s)}var Mr="disabled",Rr="sampled",$r="active",jr="buffering",Nr="paused",Lr="trigger",Dr=Lr+"_activated",Ur=Lr+"_pending",Fr=Lr+"_"+Mr;function Yr(e,t){return t.some(t=>"regex"===t.matching&&new RegExp(t.url).test(e))}class Gr{constructor(e){this.It=e}triggerStatus(e){var t=this.It.map(t=>t.triggerStatus(e));return t.includes(Dr)?Dr:t.includes(Ur)?Ur:Fr}stop(){this.It.forEach(e=>e.stop())}}class Br{constructor(e){this.It=e}triggerStatus(e){var t=new Set;for(var n of this.It)t.add(n.triggerStatus(e));switch(t.delete(Fr),t.size){case 0:return Fr;case 1:return Array.from(t)[0];default:return Ur}}stop(){this.It.forEach(e=>e.stop())}}class Hr{triggerStatus(){return Ur}stop(){}}class zr{constructor(e){this.Rt=[],this.Pt=[],this.urlBlocked=!1,this._instance=e}onRemoteConfig(e){var t,n;this.Rt=(null==(t=e.sessionRecording)?void 0:t.urlTriggers)||[],this.Pt=(null==(n=e.sessionRecording)?void 0:n.urlBlocklist)||[]}Tt(e){var t;return 0===this.Rt.length?Fr:(null==(t=this._instance)?void 0:t.get_property(Ce))===e?Dr:Ur}triggerStatus(e){var t=this.Tt(e),n=t===Dr?Dr:t===Ur?Ur:Fr;return this._instance.register_for_session({$sdk_debug_replay_url_trigger_status:n}),n}checkUrlTriggerConditions(e,t,n){if(void 0!==r&&r.location.href){var s=r.location.href,i=this.urlBlocked,a=Yr(s,this.Pt);i&&a||(a&&!i?e():!a&&i&&t(),Yr(s,this.Rt)&&n("url"))}}stop(){}}class qr{constructor(e){this.linkedFlag=null,this.linkedFlagSeen=!1,this.Ct=()=>{},this._instance=e}triggerStatus(){var e=Ur;return j(this.linkedFlag)&&(e=Fr),this.linkedFlagSeen&&(e=Dr),this._instance.register_for_session({$sdk_debug_replay_linked_flag_trigger_status:e}),e}onRemoteConfig(e,t){var n;if(this.linkedFlag=(null==(n=e.sessionRecording)?void 0:n.linkedFlag)||null,!j(this.linkedFlag)&&!this.linkedFlagSeen){var r=M(this.linkedFlag)?this.linkedFlag:this.linkedFlag.flag,s=M(this.linkedFlag)?null:this.linkedFlag.variant;this.Ct=this._instance.onFeatureFlags((e,n)=>{var i=!1;if(C(n)&&r in n){var a=n[r];i=L(a)?!0===a:s?a===s:!!a}this.linkedFlagSeen=i,i&&t(r,s)})}}stop(){this.Ct()}}class Kr{constructor(e){this.Mt=[],this._instance=e}onRemoteConfig(e){var t;this.Mt=(null==(t=e.sessionRecording)?void 0:t.eventTriggers)||[]}Ot(e){var t;return 0===this.Mt.length?Fr:(null==(t=this._instance)?void 0:t.get_property(Ae))===e?Dr:Ur}triggerStatus(e){var t=this.Ot(e),n=t===Dr?Dr:t===Ur?Ur:Fr;return this._instance.register_for_session({$sdk_debug_replay_event_trigger_status:n}),n}stop(){}}function Wr(e){return e.isRecordingEnabled?jr:Mr}function Vr(e){if(!e.receivedFlags)return jr;if(!e.isRecordingEnabled)return Mr;if(e.urlTriggerMatching.urlBlocked)return Nr;var t=!0===e.isSampled,n=new Gr([e.eventTriggerMatching,e.urlTriggerMatching,e.linkedFlagMatching]).triggerStatus(e.sessionId);return t?Rr:n===Dr?$r:n===Ur?jr:!1===e.isSampled?Mr:$r}function Jr(e){if(!e.receivedFlags)return jr;if(!e.isRecordingEnabled)return Mr;if(e.urlTriggerMatching.urlBlocked)return Nr;var t=new Br([e.eventTriggerMatching,e.urlTriggerMatching,e.linkedFlagMatching]).triggerStatus(e.sessionId),n=t!==Fr,r=L(e.isSampled);return n&&t===Ur?jr:n&&t===Fr||r&&!e.isSampled?Mr:!0===e.isSampled?Rr:$r}var Zr="[SessionRecording]",Xr=q(Zr);function Qr(){var e;return null==g||null==(e=g.__PosthogExtensions__)||null==(e=e.rrweb)?void 0:e.record}var es=[Gn.MouseMove,Gn.MouseInteraction,Gn.Scroll,Gn.ViewportResize,Gn.Input,Gn.TouchMove,Gn.MediaInteraction,Gn.Drag],ts=e=>({rrwebMethod:e,enqueuedAt:Date.now(),attempt:1});function ns(e){return function(e){for(var t="",n=0;n<e.length;){var r=e[n++];t+=String.fromCharCode(r)}return t}(Ar(Pr(JSON.stringify(e))))}function rs(e){return e.type===Yn.Custom&&"sessionIdle"===e.data.tag}class ss{get sessionId(){return this.Ft}get At(){return this._instance.config.session_recording.session_idle_threshold_ms||3e5}get started(){return this.Dt}get jt(){if(!this._instance.sessionManager)throw new Error(Zr+" must be started with a valid sessionManager.");return this._instance.sessionManager}get Lt(){var e,t;return this.Nt.triggerStatus(this.sessionId)===Ur?6e4:null!==(e=null==(t=this._instance.config.session_recording)?void 0:t.full_snapshot_interval_millis)&&void 0!==e?e:3e5}get zt(){var e=this._instance.get_property(Oe);return L(e)?e:null}get Ut(){var e,t,n=null==(e=this.H)?void 0:e.data[(null==(t=this.H)?void 0:t.data.length)-1],{sessionStartTimestamp:r}=this.jt.checkAndGetSessionAndWindowId(!0);return n?n.timestamp-r:null}get qt(){var e=!!this._instance.get_property(be),t=!this._instance.config.disable_session_recording;return r&&e&&t}get Bt(){var e=!!this._instance.get_property(we),t=this._instance.config.enable_recording_console_log;return null!=t?t:e}get Ht(){var e,t,n,r,s,i,a=this._instance.config.session_recording.captureCanvas,o=this._instance.get_property(Se),c=null!==(e=null!==(t=null==a?void 0:a.recordCanvas)&&void 0!==t?t:null==o?void 0:o.enabled)&&void 0!==e&&e,l=null!==(n=null!==(r=null==a?void 0:a.canvasFps)&&void 0!==r?r:null==o?void 0:o.fps)&&void 0!==n?n:4,u=null!==(s=null!==(i=null==a?void 0:a.canvasQuality)&&void 0!==i?i:null==o?void 0:o.quality)&&void 0!==s?s:.4;if("string"==typeof u){var d=parseFloat(u);u=isNaN(d)?.4:d}return{enabled:c,fps:G(l,0,12,Xr.createLogger("canvas recording fps"),4),quality:G(u,0,1,Xr.createLogger("canvas recording quality"),.4)}}get Wt(){var e,t,n=this._instance.get_property(ve),r={recordHeaders:null==(e=this._instance.config.session_recording)?void 0:e.recordHeaders,recordBody:null==(t=this._instance.config.session_recording)?void 0:t.recordBody},s=(null==r?void 0:r.recordHeaders)||(null==n?void 0:n.recordHeaders),i=(null==r?void 0:r.recordBody)||(null==n?void 0:n.recordBody),a=C(this._instance.config.capture_performance)?this._instance.config.capture_performance.network_timing:this._instance.config.capture_performance,o=!!(L(a)?a:null==n?void 0:n.capturePerformance);return s||i||o?{recordHeaders:s,recordBody:i,recordPerformance:o}:void 0}get Gt(){var e,t,n,r,s,i,a=this._instance.get_property(Ee),o={maskAllInputs:null==(e=this._instance.config.session_recording)?void 0:e.maskAllInputs,maskTextSelector:null==(t=this._instance.config.session_recording)?void 0:t.maskTextSelector,blockSelector:null==(n=this._instance.config.session_recording)?void 0:n.blockSelector},c=null!==(r=null==o?void 0:o.maskAllInputs)&&void 0!==r?r:null==a?void 0:a.maskAllInputs,l=null!==(s=null==o?void 0:o.maskTextSelector)&&void 0!==s?s:null==a?void 0:a.maskTextSelector,u=null!==(i=null==o?void 0:o.blockSelector)&&void 0!==i?i:null==a?void 0:a.blockSelector;return P(c)&&P(l)&&P(u)?void 0:{maskAllInputs:null==c||c,maskTextSelector:l,blockSelector:u}}get Jt(){var e=this._instance.get_property(xe);return N(e)?e:null}get Vt(){var e=this._instance.get_property(ke);return N(e)?e:null}get status(){return this.Kt?this.Yt({receivedFlags:this.Kt,isRecordingEnabled:this.qt,isSampled:this.zt,urlTriggerMatching:this.Xt,eventTriggerMatching:this.Qt,linkedFlagMatching:this.Zt,sessionId:this.sessionId}):jr}constructor(e){if(this.Yt=Wr,this.Kt=!1,this.ti=[],this.ii="unknown",this.ei=Date.now(),this.Nt=new Hr,this.ri=void 0,this.si=void 0,this.ni=void 0,this.oi=void 0,this.ai=void 0,this._forceAllowLocalhostNetworkCapture=!1,this.li=()=>{this.hi()},this.ui=()=>{this.di("browser offline",{})},this.vi=()=>{this.di("browser online",{})},this.ci=()=>{if(null!=l&&l.visibilityState){var e="window "+l.visibilityState;this.di(e,{})}},this._instance=e,this.Dt=!1,this.fi="/s/",this.pi=void 0,this.Kt=!1,!this._instance.sessionManager)throw Xr.error("started without valid sessionManager"),new Error(Zr+" started without valid sessionManager. This is a bug.");if("always"===this._instance.config.cookieless_mode)throw new Error(Zr+' cannot be used with cookieless_mode="always"');this.Zt=new qr(this._instance),this.Xt=new zr(this._instance),this.Qt=new Kr(this._instance);var{sessionId:t,windowId:n}=this.jt.checkAndGetSessionAndWindowId();this.Ft=t,this.gi=n,this.H=this.mi(),this.At>=this.jt.sessionTimeoutMs&&Xr.warn("session_idle_threshold_ms ("+this.At+") is greater than the session timeout ("+this.jt.sessionTimeoutMs+"). Session will never be detected as idle")}startIfEnabledOrStop(e){this.qt?(this.bi(e),oe(r,"beforeunload",this.li),oe(r,"offline",this.ui),oe(r,"online",this.vi),oe(r,"visibilitychange",this.ci),this.yi(),this.wi(),j(this.ri)&&(this.ri=this._instance.on("eventCaptured",e=>{try{if("$pageview"===e.event){var t=null!=e&&e.properties.$current_url?this.Si(null==e?void 0:e.properties.$current_url):"";if(!t)return;this.di("$pageview",{href:t})}}catch(e){Xr.error("Could not add $pageview to rrweb session",e)}})),this.si||(this.si=this.jt.onSessionId((e,t,n)=>{var r,s;n&&(this.di("$session_id_change",{sessionId:e,windowId:t,changeReason:n}),null==(r=this._instance)||null==(r=r.persistence)||r.unregister(Ae),null==(s=this._instance)||null==(s=s.persistence)||s.unregister(Ce))}))):this.stopRecording()}stopRecording(){var e,t,n,s;this.Dt&&this.pi&&(this.pi(),this.pi=void 0,this.Dt=!1,null==r||r.removeEventListener("beforeunload",this.li),null==r||r.removeEventListener("offline",this.ui),null==r||r.removeEventListener("online",this.vi),null==r||r.removeEventListener("visibilitychange",this.ci),this.mi(),clearInterval(this.$i),null==(e=this.ri)||e.call(this),this.ri=void 0,null==(t=this.ai)||t.call(this),this.ai=void 0,null==(n=this.si)||n.call(this),this.si=void 0,null==(s=this.oi)||s.call(this),this.oi=void 0,this.Qt.stop(),this.Xt.stop(),this.Zt.stop(),Xr.info("stopped"))}ki(){var e;null==(e=this._instance.persistence)||e.unregister(Oe)}xi(e){var t,n=this.Ft!==e,r=this.Jt;if(N(r)){var s=this.zt,i=n||!L(s),a=i?function(e,t){return function(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t)}(e)%100<G(100*t,0,100,z)}(e,r):s;i&&(a?this.Ei(Rr):Xr.warn("Sample rate ("+r+") has determined that this sessionId ("+e+") will not be sent to the server."),this.di("samplingDecisionMade",{sampleRate:r,isSampled:a})),null==(t=this._instance.persistence)||t.register({[Oe]:a})}else this.ki()}onRemoteConfig(e){var t,n,r,s;this.di("$remote_config_received",e),this.Ii(e),null!=(t=e.sessionRecording)&&t.endpoint&&(this.fi=null==(s=e.sessionRecording)?void 0:s.endpoint),this.yi(),"any"===(null==(n=e.sessionRecording)?void 0:n.triggerMatchType)?(this.Yt=Vr,this.Nt=new Gr([this.Qt,this.Xt])):(this.Yt=Jr,this.Nt=new Br([this.Qt,this.Xt])),this._instance.register_for_session({$sdk_debug_replay_remote_trigger_matching_config:null==(r=e.sessionRecording)?void 0:r.triggerMatchType}),this.Xt.onRemoteConfig(e),this.Qt.onRemoteConfig(e),this.Zt.onRemoteConfig(e,(e,t)=>{this.Ei("linked_flag_matched",{flag:e,variant:t})}),this.Kt=!0,this.startIfEnabledOrStop()}yi(){N(this.Jt)&&j(this.oi)&&(this.oi=this.jt.onSessionId(e=>{this.xi(e)}))}Ii(e){if(this._instance.persistence){var t,n=this._instance.persistence,r=()=>{var t,r,s,i,a,o,c,l,u,d=null==(t=e.sessionRecording)?void 0:t.sampleRate,h=j(d)?null:parseFloat(d);j(h)&&this.ki();var p=null==(r=e.sessionRecording)?void 0:r.minimumDurationMilliseconds;n.register({[be]:!!e.sessionRecording,[we]:null==(s=e.sessionRecording)?void 0:s.consoleLogRecordingEnabled,[ve]:y({capturePerformance:e.capturePerformance},null==(i=e.sessionRecording)?void 0:i.networkPayloadCapture),[Ee]:null==(a=e.sessionRecording)?void 0:a.masking,[Se]:{enabled:null==(o=e.sessionRecording)?void 0:o.recordCanvas,fps:null==(c=e.sessionRecording)?void 0:c.canvasFps,quality:null==(l=e.sessionRecording)?void 0:l.canvasQuality},[xe]:h,[ke]:P(p)?null:p,[Te]:null==(u=e.sessionRecording)?void 0:u.scriptConfig})};r(),null==(t=this.ni)||t.call(this),this.ni=this.jt.onSessionId(r)}}log(e,t){var n;void 0===t&&(t="log"),null==(n=this._instance.sessionRecording)||n.onRRwebEmit({type:6,data:{plugin:"rrweb/console@1",payload:{level:t,trace:[],payload:[JSON.stringify(e)]}},timestamp:Date.now()})}bi(e){var t;P(Object.assign)||P(Array.from)||(this.Dt||this._instance.config.disable_session_recording||this._instance.consent.isOptedOut())||(this.Dt=!0,this.jt.checkAndGetSessionAndWindowId(),Qr()?this.Ri():null==(t=g.__PosthogExtensions__)||null==t.loadExternalDependency||t.loadExternalDependency(this._instance,this.Pi,e=>{if(e)return Xr.error("could not load recorder",e);this.Ri()}),Xr.info("starting"),this.status===$r&&this.Ei(e||"recording_initialized"))}get Pi(){var e;return(null==(e=this._instance)||null==(e=e.persistence)||null==(e=e.get_property(Te))?void 0:e.script)||"recorder"}Ti(e){var t;return 3===e.type&&-1!==es.indexOf(null==(t=e.data)?void 0:t.source)}Ci(e){var t=this.Ti(e);t||this.ii||e.timestamp-this.ei>this.At&&(this.ii=!0,clearInterval(this.$i),this.di("sessionIdle",{eventTimestamp:e.timestamp,lastActivityTimestamp:this.ei,threshold:this.At,bufferLength:this.H.data.length,bufferSize:this.H.size}),this.hi());var n=!1;if(t&&(this.ei=e.timestamp,this.ii)){var r="unknown"===this.ii;this.ii=!1,r||(this.di("sessionNoLongerIdle",{reason:"user activity",type:e.type}),n=!0)}if(!this.ii){var{windowId:s,sessionId:i}=this.jt.checkAndGetSessionAndWindowId(!t,e.timestamp),a=this.Ft!==i,o=this.gi!==s;this.gi=s,this.Ft=i,a||o?(this.stopRecording(),this.startIfEnabledOrStop("session_id_changed")):n&&this.Mi()}}Oi(e){try{return e.rrwebMethod(),!0}catch(t){return this.ti.length<10?this.ti.push({enqueuedAt:e.enqueuedAt||Date.now(),attempt:e.attempt++,rrwebMethod:e.rrwebMethod}):Xr.warn("could not emit queued rrweb event.",t,e),!1}}di(e,t){return this.Oi(ts(()=>Qr().addCustomEvent(e,t)))}Fi(){return this.Oi(ts(()=>Qr().takeFullSnapshot()))}Ri(){var e,t,n,r,s={blockClass:"ph-no-capture",blockSelector:void 0,ignoreClass:"ph-ignore-input",maskTextClass:"ph-mask",maskTextSelector:void 0,maskTextFn:void 0,maskAllInputs:!0,maskInputOptions:{password:!0},maskInputFn:void 0,slimDOMOptions:{},collectFonts:!1,inlineStylesheet:!0,recordCrossOriginIframes:!1},i=this._instance.config.session_recording;for(var[a,o]of Object.entries(i||{}))a in s&&("maskInputOptions"===a?s.maskInputOptions=y({password:!0},o):s[a]=o);this.Ht&&this.Ht.enabled&&(s.recordCanvas=!0,s.sampling={canvas:this.Ht.fps},s.dataURLOptions={type:"image/webp",quality:this.Ht.quality}),this.Gt&&(s.maskAllInputs=null===(t=this.Gt.maskAllInputs)||void 0===t||t,s.maskTextSelector=null!==(n=this.Gt.maskTextSelector)&&void 0!==n?n:void 0,s.blockSelector=null!==(r=this.Gt.blockSelector)&&void 0!==r?r:void 0);var c=Qr();if(c){this.Ai=null!==(e=this.Ai)&&void 0!==e?e:new Zn(c,{refillRate:this._instance.config.session_recording.__mutationThrottlerRefillRate,bucketSize:this._instance.config.session_recording.__mutationThrottlerBucketSize,onBlockedNode:(e,t)=>{var n="Too many mutations on node '"+e+"'. Rate limiting. This could be due to SVG animations or something similar";Xr.info(n,{node:t}),this.log(Zr+" "+n,"warn")}});var l=this.Di();this.pi=c(y({emit:e=>{this.onRRwebEmit(e)},plugins:l},s)),this.ei=Date.now(),this.ii=L(this.ii)?this.ii:"unknown",this.di("$session_options",{sessionRecordingOptions:s,activePlugins:l.map(e=>null==e?void 0:e.name)}),this.di("$posthog_config",{config:this._instance.config})}else Xr.error("onScriptLoaded was called but rrwebRecord is not available. This indicates something has gone wrong.")}Mi(){if(this.$i&&clearInterval(this.$i),!0!==this.ii){var e=this.Lt;e&&(this.$i=setInterval(()=>{this.Fi()},e))}}Di(){var e,t,n=[],r=null==(e=g.__PosthogExtensions__)||null==(e=e.rrwebPlugins)?void 0:e.getRecordConsolePlugin;r&&this.Bt&&n.push(r());var s=null==(t=g.__PosthogExtensions__)||null==(t=t.rrwebPlugins)?void 0:t.getRecordNetworkPlugin;return this.Wt&&O(s)&&(!Tt.includes(location.hostname)||this._forceAllowLocalhostNetworkCapture?n.push(s(((e,t)=>{var n,r,s,i={payloadSizeLimitBytes:zn.payloadSizeLimitBytes,performanceEntryTypeToObserve:[...zn.performanceEntryTypeToObserve],payloadHostDenyList:[...t.payloadHostDenyList||[],...zn.payloadHostDenyList]},a=!1!==e.session_recording.recordHeaders&&t.recordHeaders,o=!1!==e.session_recording.recordBody&&t.recordBody,c=!1!==e.capture_performance&&t.recordPerformance,l=(n=i,s=Math.min(1e6,null!==(r=n.payloadSizeLimitBytes)&&void 0!==r?r:1e6),e=>(null!=e&&e.requestBody&&(e.requestBody=Vn(e.requestBody,e.requestHeaders,s,"Request")),null!=e&&e.responseBody&&(e.responseBody=Vn(e.responseBody,e.responseHeaders,s,"Response")),e)),u=t=>{return l(((e,t)=>{var n,r=It(e.name),s=0===t.indexOf("http")?null==(n=It(t))?void 0:n.pathname:t;"/"===s&&(s="");var i=null==r?void 0:r.pathname.replace(s||"","");if(!(r&&i&&Wn.some(e=>0===i.indexOf(e))))return e})((r=(n=t).requestHeaders,j(r)||Z(Object.keys(null!=r?r:{}),e=>{qn.includes(e.toLowerCase())&&(r[e]=Hn)}),n),e.api_host));var n,r},d=O(e.session_recording.maskNetworkRequestFn);return d&&O(e.session_recording.maskCapturedNetworkRequestFn)&&z.warn("Both `maskNetworkRequestFn` and `maskCapturedNetworkRequestFn` are defined. `maskNetworkRequestFn` will be ignored."),d&&(e.session_recording.maskCapturedNetworkRequestFn=t=>{var n=e.session_recording.maskNetworkRequestFn({url:t.name});return y({},t,{name:null==n?void 0:n.url})}),i.maskRequestFn=O(e.session_recording.maskCapturedNetworkRequestFn)?t=>{var n,r=u(t);return r&&null!==(n=null==e.session_recording.maskCapturedNetworkRequestFn?void 0:e.session_recording.maskCapturedNetworkRequestFn(r))&&void 0!==n?n:void 0}:e=>function(e){if(!P(e))return e.requestBody=Jn(e.requestBody,"Request"),e.responseBody=Jn(e.responseBody,"Response"),e}(u(e)),y({},zn,i,{recordHeaders:a,recordBody:o,recordPerformance:c,recordInitialRequests:c})})(this._instance.config,this.Wt))):Xr.info("NetworkCapture not started because we are on localhost.")),n}onRRwebEmit(e){var t;if(this.ji(),e&&C(e)){if(e.type===Yn.Meta){var n=this.Si(e.data.href);if(this.Li=n,!n)return;e.data.href=n}else this.Ni();if(this.Xt.checkUrlTriggerConditions(()=>this.zi(),()=>this.Ui(),e=>this.qi(e)),!this.Xt.urlBlocked||(r=e).type===Yn.Custom&&"recording paused"===r.data.tag){var r;e.type===Yn.FullSnapshot&&this.Mi(),e.type===Yn.FullSnapshot&&this.Kt&&this.Nt.triggerStatus(this.sessionId)===Ur&&this.mi();var s=this.Ai?this.Ai.throttleMutations(e):e;if(s){var i=function(e){var t=e;if(t&&C(t)&&6===t.type&&C(t.data)&&"rrweb/console@1"===t.data.plugin){t.data.payload.payload.length>10&&(t.data.payload.payload=t.data.payload.payload.slice(0,10),t.data.payload.payload.push("...[truncated]"));for(var n=[],r=0;r<t.data.payload.payload.length;r++)t.data.payload.payload[r]&&t.data.payload.payload[r].length>2e3?n.push(t.data.payload.payload[r].slice(0,2e3)+"...[truncated]"):n.push(t.data.payload.payload[r]);return t.data.payload.payload=n,e}return e}(s);if(this.Ci(i),!0!==this.ii||rs(i)){if(rs(i)){var a=i.data.payload;if(a){var o=a.lastActivityTimestamp,c=a.threshold;i.timestamp=o+c}}var l=null===(t=this._instance.config.session_recording.compress_events)||void 0===t||t?function(e){if(Un(e)<1024)return e;try{if(e.type===Yn.FullSnapshot)return y({},e,{data:ns(e.data),cv:"2024-10"});if(e.type===Yn.IncrementalSnapshot&&e.data.source===Gn.Mutation)return y({},e,{cv:"2024-10",data:y({},e.data,{texts:ns(e.data.texts),attributes:ns(e.data.attributes),removes:ns(e.data.removes),adds:ns(e.data.adds)})});if(e.type===Yn.IncrementalSnapshot&&e.data.source===Gn.StyleSheetRule)return y({},e,{cv:"2024-10",data:y({},e.data,{adds:e.data.adds?ns(e.data.adds):void 0,removes:e.data.removes?ns(e.data.removes):void 0})})}catch(e){Xr.error("could not compress event - will use uncompressed event",e)}return e}(i):i,u={$snapshot_bytes:Un(l),$snapshot_data:l,$session_id:this.Ft,$window_id:this.gi};this.status!==Mr?this.Bi(u):this.mi()}}}}}Ni(){if(!this._instance.config.capture_pageview&&r){var e=this.Si(r.location.href);this.Li!==e&&(this.di("$url_changed",{href:e}),this.Li=e)}}ji(){if(this.ti.length){var e=[...this.ti];this.ti=[],e.forEach(e=>{Date.now()-e.enqueuedAt<=2e3&&this.Oi(e)})}}Si(e){var t=this._instance.config.session_recording;if(t.maskNetworkRequestFn){var n,r={url:e};return null==(n=r=t.maskNetworkRequestFn(r))?void 0:n.url}return e}mi(){return this.H={size:0,data:[],sessionId:this.Ft,windowId:this.gi},this.H}hi(){this.Hi&&(clearTimeout(this.Hi),this.Hi=void 0);var e=this.Vt,t=this.Ut,n=N(t)&&t>=0,r=N(e)&&n&&t<e;return this.status===jr||this.status===Nr||this.status===Mr||r?(this.Hi=setTimeout(()=>{this.hi()},2e3),this.H):(this.H.data.length>0&&Fn(this.H).forEach(e=>{this.Wi({$snapshot_bytes:e.size,$snapshot_data:e.data,$session_id:e.sessionId,$window_id:e.windowId,$lib:"web",$lib_version:f.LIB_VERSION})}),this.mi())}Bi(e){var t,n=2+((null==(t=this.H)?void 0:t.data.length)||0);!this.ii&&(this.H.size+e.$snapshot_bytes+n>943718.4||this.H.sessionId!==this.Ft)&&(this.H=this.hi()),this.H.size+=e.$snapshot_bytes,this.H.data.push(e.$snapshot_data),this.Hi||this.ii||(this.Hi=setTimeout(()=>{this.hi()},2e3))}Wi(e){this._instance.capture("$snapshot",e,{_url:this._instance.requestRouter.endpointFor("api",this.fi),_noTruncate:!0,_batchKey:"recordings",skip_client_rate_limiting:!0})}qi(e){var t;this.Nt.triggerStatus(this.sessionId)===Ur&&(null==(t=this._instance)||null==(t=t.persistence)||t.register({["url"===e?Ce:Ae]:this.Ft}),this.hi(),this.Ei(e+"_trigger_matched"))}zi(){this.Xt.urlBlocked||(this.Xt.urlBlocked=!0,clearInterval(this.$i),Xr.info("recording paused due to URL blocker"),this.di("recording paused",{reason:"url blocker"}))}Ui(){this.Xt.urlBlocked&&(this.Xt.urlBlocked=!1,this.Fi(),this.Mi(),this.di("recording resumed",{reason:"left blocked url"}),Xr.info("recording resumed"))}wi(){0!==this.Qt.Mt.length&&j(this.ai)&&(this.ai=this._instance.on("eventCaptured",e=>{try{this.Qt.Mt.includes(e.event)&&this.qi("event")}catch(e){Xr.error("Could not activate event trigger",e)}}))}overrideLinkedFlag(){this.Zt.linkedFlagSeen=!0,this.Fi(),this.Ei("linked_flag_overridden")}overrideSampling(){var e;null==(e=this._instance.persistence)||e.register({[Oe]:!0}),this.Fi(),this.Ei("sampling_overridden")}overrideTrigger(e){this.qi(e)}Ei(e,t){this._instance.register_for_session({$session_recording_start_reason:e}),Xr.info(e.replace("_"," "),t),w(["recording_initialized","session_id_changed"],e)||this.di(e,t)}get sdkDebugProperties(){var{sessionStartTimestamp:e}=this.jt.checkAndGetSessionAndWindowId(!0);return{$recording_status:this.status,$sdk_debug_replay_internal_buffer_length:this.H.data.length,$sdk_debug_replay_internal_buffer_size:this.H.size,$sdk_debug_current_session_duration:this.Ut,$sdk_debug_session_start:e}}}var is=q("[SegmentIntegration]");var as="posthog-js";function os(e,t){var{organization:n,projectId:r,prefix:s,severityAllowList:i=["error"]}=void 0===t?{}:t;return t=>{var a,o,c,l,u;if("*"!==i&&!i.includes(t.level)||!e.__loaded)return t;t.tags||(t.tags={});var d=e.requestRouter.endpointFor("ui","/project/"+e.config.token+"/person/"+e.get_distinct_id());t.tags["PostHog Person URL"]=d,e.sessionRecordingStarted()&&(t.tags["PostHog Recording URL"]=e.get_session_replay_url({withTimestamp:!0}));var h=(null==(a=t.exception)?void 0:a.values)||[],p=h.map(e=>y({},e,{stacktrace:e.stacktrace?y({},e.stacktrace,{type:"raw",frames:(e.stacktrace.frames||[]).map(e=>y({},e,{platform:"web:javascript"}))}):void 0})),m={$exception_message:(null==(o=h[0])?void 0:o.value)||t.message,$exception_type:null==(c=h[0])?void 0:c.type,$exception_personURL:d,$exception_level:t.level,$exception_list:p,$sentry_event_id:t.event_id,$sentry_exception:t.exception,$sentry_exception_message:(null==(l=h[0])?void 0:l.value)||t.message,$sentry_exception_type:null==(u=h[0])?void 0:u.type,$sentry_tags:t.tags};return n&&r&&(m.$sentry_url=(s||"https://sentry.io/organizations/")+n+"/issues/?project="+r+"&query="+t.event_id),e.exceptions.sendExceptionEvent(m),t}}class cs{constructor(e,t,n,r,s){this.name=as,this.setupOnce=function(i){i(os(e,{organization:t,projectId:n,prefix:r,severityAllowList:s}))}}}var ls=null!=r&&r.location?At(r.location.hash,"__posthog")||At(location.hash,"state"):null,us="_postHogToolbarParams",ds=q("[Toolbar]"),hs=function(e){return e[e.UNINITIALIZED=0]="UNINITIALIZED",e[e.LOADING=1]="LOADING",e[e.LOADED=2]="LOADED",e}(hs||{});class ps{constructor(e){this.instance=e}Gi(e){g.ph_toolbar_state=e}Ji(){var e;return null!==(e=g.ph_toolbar_state)&&void 0!==e?e:hs.UNINITIALIZED}maybeLoadToolbar(e,t,n){if(void 0===e&&(e=void 0),void 0===t&&(t=void 0),void 0===n&&(n=void 0),!r||!l)return!1;e=null!=e?e:r.location,n=null!=n?n:r.history;try{if(!t){try{r.localStorage.setItem("test","test"),r.localStorage.removeItem("test")}catch(e){return!1}t=null==r?void 0:r.localStorage}var s,i=ls||At(e.hash,"__posthog")||At(e.hash,"state"),a=i?te(()=>JSON.parse(atob(decodeURIComponent(i))))||te(()=>JSON.parse(decodeURIComponent(i))):null;return a&&"ph_authorize"===a.action?((s=a).source="url",s&&Object.keys(s).length>0&&(a.desiredHash?e.hash=a.desiredHash:n?n.replaceState(n.state,"",e.pathname+e.search):e.hash="")):((s=JSON.parse(t.getItem(us)||"{}")).source="localstorage",delete s.userIntent),!(!s.token||this.instance.config.token!==s.token||(this.loadToolbar(s),0))}catch(e){return!1}}Vi(e){var t=g.ph_load_toolbar||g.ph_load_editor;!j(t)&&O(t)?t(e,this.instance):ds.warn("No toolbar load function found")}loadToolbar(e){var t=!(null==l||!l.getElementById(qe));if(!r||t)return!1;var n="custom"===this.instance.requestRouter.region&&this.instance.config.advanced_disable_toolbar_metrics,s=y({token:this.instance.config.token},e,{apiURL:this.instance.requestRouter.endpointFor("ui")},n?{instrument:!1}:{});if(r.localStorage.setItem(us,JSON.stringify(y({},s,{source:void 0}))),this.Ji()===hs.LOADED)this.Vi(s);else if(this.Ji()===hs.UNINITIALIZED){var i;this.Gi(hs.LOADING),null==(i=g.__PosthogExtensions__)||null==i.loadExternalDependency||i.loadExternalDependency(this.instance,"toolbar",e=>{if(e)return ds.error("[Toolbar] Failed to load",e),void this.Gi(hs.UNINITIALIZED);this.Gi(hs.LOADED),this.Vi(s)}),oe(r,"turbolinks:load",()=>{this.Gi(hs.UNINITIALIZED),this.loadToolbar(s)})}return!0}Ki(e){return this.loadToolbar(e)}maybeLoadEditor(e,t,n){return void 0===e&&(e=void 0),void 0===t&&(t=void 0),void 0===n&&(n=void 0),this.maybeLoadToolbar(e,t,n)}}var ms=q("[TracingHeaders]");class gs{constructor(e){this.Yi=void 0,this.Xi=void 0,this.lt=()=>{var e,t;P(this.Yi)&&(null==(e=g.__PosthogExtensions__)||null==(e=e.tracingHeadersPatchFns)||e._patchXHR(this._instance.config.__add_tracing_headers||[],this._instance.get_distinct_id(),this._instance.sessionManager)),P(this.Xi)&&(null==(t=g.__PosthogExtensions__)||null==(t=t.tracingHeadersPatchFns)||t._patchFetch(this._instance.config.__add_tracing_headers||[],this._instance.get_distinct_id(),this._instance.sessionManager))},this._instance=e}nt(e){var t,n;null!=(t=g.__PosthogExtensions__)&&t.tracingHeadersPatchFns&&e(),null==(n=g.__PosthogExtensions__)||null==n.loadExternalDependency||n.loadExternalDependency(this._instance,"tracing-headers",t=>{if(t)return ms.error("failed to load script",t);e()})}startIfEnabledOrStop(){var e,t;this._instance.config.__add_tracing_headers?this.nt(this.lt):(null==(e=this.Yi)||e.call(this),null==(t=this.Xi)||t.call(this),this.Yi=void 0,this.Xi=void 0)}}var fs=q("[Web Vitals]"),ys=9e5;class _s{constructor(e){var t;this.Qi=!1,this.C=!1,this.H={url:void 0,metrics:[],firstMetricTimestamp:void 0},this.Zi=()=>{clearTimeout(this.te),0!==this.H.metrics.length&&(this._instance.capture("$web_vitals",this.H.metrics.reduce((e,t)=>y({},e,{["$web_vitals_"+t.name+"_event"]:y({},t),["$web_vitals_"+t.name+"_value"]:t.value}),{})),this.H={url:void 0,metrics:[],firstMetricTimestamp:void 0})},this.ie=e=>{var t,n=null==(t=this._instance.sessionManager)?void 0:t.checkAndGetSessionAndWindowId(!0);if(P(n))fs.error("Could not read session ID. Dropping metrics!");else{this.H=this.H||{url:void 0,metrics:[],firstMetricTimestamp:void 0};var r=this.ee();P(r)||(j(null==e?void 0:e.name)||j(null==e?void 0:e.value)?fs.error("Invalid metric received",e):this.re&&e.value>=this.re?fs.error("Ignoring metric with value >= "+this.re,e):(this.H.url!==r&&(this.Zi(),this.te=setTimeout(this.Zi,this.flushToCaptureTimeoutMs)),P(this.H.url)&&(this.H.url=r),this.H.firstMetricTimestamp=P(this.H.firstMetricTimestamp)?Date.now():this.H.firstMetricTimestamp,e.attribution&&e.attribution.interactionTargetElement&&(e.attribution.interactionTargetElement=void 0),this.H.metrics.push(y({},e,{$current_url:r,$session_id:n.sessionId,$window_id:n.windowId,timestamp:Date.now()})),this.H.metrics.length===this.allowedMetrics.length&&this.Zi()))}},this.lt=()=>{var e,t,n,r,s=g.__PosthogExtensions__;P(s)||P(s.postHogWebVitalsCallbacks)||({onLCP:e,onCLS:t,onFCP:n,onINP:r}=s.postHogWebVitalsCallbacks),e&&t&&n&&r?(this.allowedMetrics.indexOf("LCP")>-1&&e(this.ie.bind(this)),this.allowedMetrics.indexOf("CLS")>-1&&t(this.ie.bind(this)),this.allowedMetrics.indexOf("FCP")>-1&&n(this.ie.bind(this)),this.allowedMetrics.indexOf("INP")>-1&&r(this.ie.bind(this)),this.C=!0):fs.error("web vitals callbacks not loaded - not starting")},this._instance=e,this.Qi=!(null==(t=this._instance.persistence)||!t.props[fe]),this.startIfEnabled()}get allowedMetrics(){var e,t,n=C(this._instance.config.capture_performance)?null==(e=this._instance.config.capture_performance)?void 0:e.web_vitals_allowed_metrics:void 0;return P(n)?(null==(t=this._instance.persistence)?void 0:t.props[_e])||["CLS","FCP","INP","LCP"]:n}get flushToCaptureTimeoutMs(){return(C(this._instance.config.capture_performance)?this._instance.config.capture_performance.web_vitals_delayed_flush_ms:void 0)||5e3}get re(){var e=C(this._instance.config.capture_performance)&&N(this._instance.config.capture_performance.__web_vitals_max_value)?this._instance.config.capture_performance.__web_vitals_max_value:ys;return 0<e&&e<=6e4?ys:e}get isEnabled(){var e=null==u?void 0:u.protocol;if("http:"!==e&&"https:"!==e)return fs.info("Web Vitals are disabled on non-http/https protocols"),!1;var t=C(this._instance.config.capture_performance)?this._instance.config.capture_performance.web_vitals:L(this._instance.config.capture_performance)?this._instance.config.capture_performance:void 0;return L(t)?t:this.Qi}startIfEnabled(){this.isEnabled&&!this.C&&(fs.info("enabled, starting..."),this.nt(this.lt))}onRemoteConfig(e){var t=C(e.capturePerformance)&&!!e.capturePerformance.web_vitals,n=C(e.capturePerformance)?e.capturePerformance.web_vitals_allowed_metrics:void 0;this._instance.persistence&&(this._instance.persistence.register({[fe]:t}),this._instance.persistence.register({[_e]:n})),this.Qi=t,this.startIfEnabled()}nt(e){var t,n;null!=(t=g.__PosthogExtensions__)&&t.postHogWebVitalsCallbacks&&e(),null==(n=g.__PosthogExtensions__)||null==n.loadExternalDependency||n.loadExternalDependency(this._instance,"web-vitals",t=>{t?fs.error("failed to load script",t):e()})}ee(){var e=r?r.location.href:void 0;return e||fs.error("Could not determine current URL"),e}}var bs=q("[Heatmaps]");function ws(e){return C(e)&&"clientX"in e&&"clientY"in e&&N(e.clientX)&&N(e.clientY)}class vs{constructor(e){var t;this.rageclicks=new Et,this.Qi=!1,this.C=!1,this.se=null,this.instance=e,this.Qi=!(null==(t=this.instance.persistence)||!t.props[he])}get flushIntervalMilliseconds(){var e=5e3;return C(this.instance.config.capture_heatmaps)&&this.instance.config.capture_heatmaps.flush_interval_milliseconds&&(e=this.instance.config.capture_heatmaps.flush_interval_milliseconds),e}get isEnabled(){return P(this.instance.config.capture_heatmaps)?P(this.instance.config.enable_heatmaps)?this.Qi:this.instance.config.enable_heatmaps:!1!==this.instance.config.capture_heatmaps}startIfEnabled(){if(this.isEnabled){if(this.C)return;bs.info("starting..."),this.ne(),this.se=setInterval(this.oe.bind(this),this.flushIntervalMilliseconds)}else{var e,t;clearInterval(null!==(e=this.se)&&void 0!==e?e:void 0),null==(t=this.ae)||t.stop(),this.getAndClearBuffer()}}onRemoteConfig(e){var t=!!e.heatmaps;this.instance.persistence&&this.instance.persistence.register({[he]:t}),this.Qi=t,this.startIfEnabled()}getAndClearBuffer(){var e=this.H;return this.H=void 0,e}le(e){this.he(e.originalEvent,"deadclick")}ne(){r&&l&&(oe(r,"beforeunload",this.oe.bind(this)),oe(l,"click",e=>this.he(e||(null==r?void 0:r.event)),{capture:!0}),oe(l,"mousemove",e=>this.ue(e||(null==r?void 0:r.event)),{capture:!0}),this.ae=new on(this.instance,sn,this.le.bind(this)),this.ae.startIfEnabled(),this.C=!0)}de(e,t){var n=this.instance.scrollManager.scrollY(),s=this.instance.scrollManager.scrollX(),i=this.instance.scrollManager.scrollElement(),a=function(e,t,n){for(var s=e;s&&Je(s)&&!Ze(s,"body");){if(s===n)return!1;if(w(t,null==r?void 0:r.getComputedStyle(s).position))return!0;s=ot(s)}return!1}(it(e),["fixed","sticky"],i);return{x:e.clientX+(a?0:s),y:e.clientY+(a?0:n),target_fixed:a,type:t}}he(e,t){var n;if(void 0===t&&(t="click"),!Ve(e.target)&&ws(e)){var r=this.de(e,t);null!=(n=this.rageclicks)&&n.isRageClick(e.clientX,e.clientY,(new Date).getTime())&&this.ve(y({},r,{type:"rageclick"})),this.ve(r)}}ue(e){!Ve(e.target)&&ws(e)&&(clearTimeout(this.ce),this.ce=setTimeout(()=>{this.ve(this.de(e,"mousemove"))},500))}ve(e){if(r){var t=r.location.href;this.H=this.H||{},this.H[t]||(this.H[t]=[]),this.H[t].push(e)}}oe(){this.H&&!A(this.H)&&this.instance.capture("$$heatmap",{$heatmap_data:this.getAndClearBuffer()})}}class Es{constructor(e){this._instance=e}doPageView(e,t){var n,s=this.fe(e,t);return this.pe={pathname:null!==(n=null==r?void 0:r.location.pathname)&&void 0!==n?n:"",pageViewId:t,timestamp:e},this._instance.scrollManager.resetContext(),s}doPageLeave(e){var t;return this.fe(e,null==(t=this.pe)?void 0:t.pageViewId)}doEvent(){var e;return{$pageview_id:null==(e=this.pe)?void 0:e.pageViewId}}fe(e,t){var n=this.pe;if(!n)return{$pageview_id:t};var r={$pageview_id:t,$prev_pageview_id:n.pageViewId},s=this._instance.scrollManager.getContext();if(s&&!this._instance.config.disable_scroll_properties){var{maxScrollHeight:i,lastScrollY:a,maxScrollY:o,maxContentHeight:c,lastContentY:l,maxContentY:u}=s;if(!(P(i)||P(a)||P(o)||P(c)||P(l)||P(u))){i=Math.ceil(i),a=Math.ceil(a),o=Math.ceil(o),c=Math.ceil(c),l=Math.ceil(l),u=Math.ceil(u);var d=i<=1?1:G(a/i,0,1,z),h=i<=1?1:G(o/i,0,1,z),p=c<=1?1:G(l/c,0,1,z),m=c<=1?1:G(u/c,0,1,z);r=X(r,{$prev_pageview_last_scroll:a,$prev_pageview_last_scroll_percentage:d,$prev_pageview_max_scroll:o,$prev_pageview_max_scroll_percentage:h,$prev_pageview_last_content:l,$prev_pageview_last_content_percentage:p,$prev_pageview_max_content:u,$prev_pageview_max_content_percentage:m})}}return n.pathname&&(r.$prev_pageview_pathname=n.pathname),n.timestamp&&(r.$prev_pageview_duration=(e.getTime()-n.timestamp.getTime())/1e3),r}}var Ss=!!h||!!d,xs="text/plain",ks=(e,t)=>{var[n,r]=e.split("?"),s=y({},t);null==r||r.split("&").forEach(e=>{var[t]=e.split("=");delete s[t]});var i=function(e,t){var n,r;void 0===t&&(t="&");var s=[];return Z(e,function(e,t){P(e)||P(t)||"undefined"===t||(n=encodeURIComponent((e=>e instanceof File)(e)?e.name:e.toString()),r=encodeURIComponent(t),s[s.length]=r+"="+n)}),s.join(t)}(s);return n+"?"+(i?(r?r+"&":"")+i:r)},Ts=(e,t)=>JSON.stringify(e,(e,t)=>"bigint"==typeof t?t.toString():t,t),Is=e=>{var{data:t,compression:n}=e;if(t){if(n===xt.GZipJS){var r=Ar(Pr(Ts(t)),{mtime:0}),s=new Blob([r],{type:xs});return{contentType:xs,body:s,estimatedSize:s.size}}if(n===xt.Base64){var i=function(e){var t,n,r,s,i,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o=0,c=0,l="",u=[];if(!e)return e;e=function(e){var t,n,r,s,i="";for(t=n=0,r=(e=(e+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")).length,s=0;s<r;s++){var a=e.charCodeAt(s),o=null;a<128?n++:o=a>127&&a<2048?String.fromCharCode(a>>6|192,63&a|128):String.fromCharCode(a>>12|224,a>>6&63|128,63&a|128),$(o)||(n>t&&(i+=e.substring(t,n)),i+=o,t=n=s+1)}return n>t&&(i+=e.substring(t,e.length)),i}(e);do{t=(i=e.charCodeAt(o++)<<16|e.charCodeAt(o++)<<8|e.charCodeAt(o++))>>18&63,n=i>>12&63,r=i>>6&63,s=63&i,u[c++]=a.charAt(t)+a.charAt(n)+a.charAt(r)+a.charAt(s)}while(o<e.length);switch(l=u.join(""),e.length%3){case 1:l=l.slice(0,-2)+"==";break;case 2:l=l.slice(0,-1)+"="}return l}(Ts(t)),a=(e=>"data="+encodeURIComponent("string"==typeof e?e:Ts(e)))(i);return{contentType:"application/x-www-form-urlencoded",body:a,estimatedSize:new Blob([a]).size}}var o=Ts(t);return{contentType:"application/json",body:o,estimatedSize:new Blob([o]).size}}},Os=[];d&&Os.push({transport:"fetch",method:e=>{var t,n,{contentType:r,body:s,estimatedSize:i}=null!==(t=Is(e))&&void 0!==t?t:{},a=new Headers;Z(e.headers,function(e,t){a.append(t,e)}),r&&a.append("Content-Type",r);var o=e.url,c=null;if(p){var l=new p;c={signal:l.signal,timeout:setTimeout(()=>l.abort(),e.timeout)}}d(o,y({method:(null==e?void 0:e.method)||"GET",headers:a,keepalive:"POST"===e.method&&(i||0)<52428.8,body:s,signal:null==(n=c)?void 0:n.signal},e.fetchOptions)).then(t=>t.text().then(n=>{var r={statusCode:t.status,text:n};if(200===t.status)try{r.json=JSON.parse(n)}catch(e){z.error(e)}null==e.callback||e.callback(r)})).catch(t=>{z.error(t),null==e.callback||e.callback({statusCode:0,text:t})}).finally(()=>c?clearTimeout(c.timeout):null)}}),h&&Os.push({transport:"XHR",method:e=>{var t,n=new h;n.open(e.method||"GET",e.url,!0);var{contentType:r,body:s}=null!==(t=Is(e))&&void 0!==t?t:{};Z(e.headers,function(e,t){n.setRequestHeader(t,e)}),r&&n.setRequestHeader("Content-Type",r),e.timeout&&(n.timeout=e.timeout),n.withCredentials=!0,n.onreadystatechange=()=>{if(4===n.readyState){var t={statusCode:n.status,text:n.responseText};if(200===n.status)try{t.json=JSON.parse(n.responseText)}catch(e){}null==e.callback||e.callback(t)}},n.send(s)}}),null!=c&&c.sendBeacon&&Os.push({transport:"sendBeacon",method:e=>{var t=ks(e.url,{beacon:"1"});try{var n,{contentType:r,body:s}=null!==(n=Is(e))&&void 0!==n?n:{},i="string"==typeof s?new Blob([s],{type:r}):s;c.sendBeacon(t,i)}catch(e){}}});var Cs=function(e,t){if(!function(e){try{new RegExp(e)}catch(e){return!1}return!0}(t))return!1;try{return new RegExp(t).test(e)}catch(e){return!1}};function As(e,t,n){return Ts({distinct_id:e,userPropertiesToSet:t,userPropertiesToSetOnce:n})}var Ps={exact:(e,t)=>t.some(t=>e.some(e=>t===e)),is_not:(e,t)=>t.every(t=>e.every(e=>t!==e)),regex:(e,t)=>t.some(t=>e.some(e=>Cs(t,e))),not_regex:(e,t)=>t.every(t=>e.every(e=>!Cs(t,e))),icontains:(e,t)=>t.map(Ms).some(t=>e.map(Ms).some(e=>t.includes(e))),not_icontains:(e,t)=>t.map(Ms).every(t=>e.map(Ms).every(e=>!t.includes(e)))},Ms=e=>e.toLowerCase(),Rs=q("[Error tracking]");class $s{constructor(e){var t,n;this.ge=[],this._instance=e,this.ge=null!==(t=null==(n=this._instance.persistence)?void 0:n.get_property(me))&&void 0!==t?t:[]}onRemoteConfig(e){var t,n,r,s=null!==(t=null==(n=e.errorTracking)?void 0:n.suppressionRules)&&void 0!==t?t:[],i=null==(r=e.errorTracking)?void 0:r.captureExtensionExceptions;this.ge=s,this._instance.persistence&&this._instance.persistence.register({[me]:this.ge,[ge]:i})}get _e(){var e,t=!!this._instance.get_property(ge),n=this._instance.config.error_tracking.captureExtensionExceptions;return null!==(e=null!=n?n:t)&&void 0!==e&&e}sendExceptionEvent(e){if(this.me(e))Rs.info("Skipping exception capture because a suppression rule matched");else{if(this._e||!this.be(e))return this._instance.capture("$exception",e,{_noTruncate:!0,_batchKey:"exceptionEvent"});Rs.info("Skipping exception capture because it was thrown by an extension")}}me(e){var t=e.$exception_list;if(!t||!I(t)||0===t.length)return!1;var n=t.reduce((e,t)=>{var{type:n,value:r}=t;return M(n)&&n.length>0&&e.$exception_types.push(n),M(r)&&r.length>0&&e.$exception_values.push(r),e},{$exception_types:[],$exception_values:[]});return this.ge.some(e=>{var t=e.values.map(e=>{var t,r=Ps[e.operator],s=I(e.value)?e.value:[e.value],i=null!==(t=n[e.key])&&void 0!==t?t:[];return s.length>0&&r(s,i)});return"OR"===e.type?t.some(Boolean):t.every(Boolean)})}be(e){var t=e.$exception_list;return!(!t||!I(t))&&t.flatMap(e=>{var t,n;return null!==(t=null==(n=e.stacktrace)?void 0:n.frames)&&void 0!==t?t:[]}).some(e=>e.filename&&e.filename.startsWith("chrome-extension://"))}}var js="Mobile",Ns="iOS",Ls="Android",Ds="Tablet",Us=Ls+" "+Ds,Fs="iPad",Ys="Apple",Gs=Ys+" Watch",Bs="Safari",Hs="BlackBerry",zs="Samsung",qs=zs+"Browser",Ks=zs+" Internet",Ws="Chrome",Vs=Ws+" OS",Js=Ws+" "+Ns,Zs="Internet Explorer",Xs=Zs+" "+js,Qs="Opera",ei=Qs+" Mini",ti="Edge",ni="Microsoft "+ti,ri="Firefox",si=ri+" "+Ns,ii="Nintendo",ai="PlayStation",oi="Xbox",ci=Ls+" "+js,li=js+" "+Bs,ui="Windows",di=ui+" Phone",hi="Nokia",pi="Ouya",mi="Generic",gi=mi+" "+js.toLowerCase(),fi=mi+" "+Ds.toLowerCase(),yi="Konqueror",_i="(\\d+(\\.\\d+)?)",bi=new RegExp("Version/"+_i),wi=new RegExp(oi,"i"),vi=new RegExp(ai+" \\w+","i"),Ei=new RegExp(ii+" \\w+","i"),Si=new RegExp(Hs+"|PlayBook|BB10","i"),xi={"NT3.51":"NT 3.11","NT4.0":"NT 4.0","5.0":"2000",5.1:"XP",5.2:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1",6.4:"10","10.0":"10"},ki=function(e,t){return t=t||"",w(e," OPR/")&&w(e,"Mini")?ei:w(e," OPR/")?Qs:Si.test(e)?Hs:w(e,"IE"+js)||w(e,"WPDesktop")?Xs:w(e,qs)?Ks:w(e,ti)||w(e,"Edg/")?ni:w(e,"FBIOS")?"Facebook "+js:w(e,"UCWEB")||w(e,"UCBrowser")?"UC Browser":w(e,"CriOS")?Js:w(e,"CrMo")||w(e,Ws)?Ws:w(e,Ls)&&w(e,Bs)?ci:w(e,"FxiOS")?si:w(e.toLowerCase(),yi.toLowerCase())?yi:((e,t)=>t&&w(t,Ys)||function(e){return w(e,Bs)&&!w(e,Ws)&&!w(e,Ls)}(e))(e,t)?w(e,js)?li:Bs:w(e,ri)?ri:w(e,"MSIE")||w(e,"Trident/")?Zs:w(e,"Gecko")?ri:""},Ti={[Xs]:[new RegExp("rv:"+_i)],[ni]:[new RegExp(ti+"?\\/"+_i)],[Ws]:[new RegExp("("+Ws+"|CrMo)\\/"+_i)],[Js]:[new RegExp("CriOS\\/"+_i)],"UC Browser":[new RegExp("(UCBrowser|UCWEB)\\/"+_i)],[Bs]:[bi],[li]:[bi],[Qs]:[new RegExp("(Opera|OPR)\\/"+_i)],[ri]:[new RegExp(ri+"\\/"+_i)],[si]:[new RegExp("FxiOS\\/"+_i)],[yi]:[new RegExp("Konqueror[:/]?"+_i,"i")],[Hs]:[new RegExp(Hs+" "+_i),bi],[ci]:[new RegExp("android\\s"+_i,"i")],[Ks]:[new RegExp(qs+"\\/"+_i)],[Zs]:[new RegExp("(rv:|MSIE )"+_i)],Mozilla:[new RegExp("rv:"+_i)]},Ii=function(e,t){var n=ki(e,t),r=Ti[n];if(P(r))return null;for(var s=0;s<r.length;s++){var i=r[s],a=e.match(i);if(a)return parseFloat(a[a.length-2])}return null},Oi=[[new RegExp(oi+"; "+oi+" (.*?)[);]","i"),e=>[oi,e&&e[1]||""]],[new RegExp(ii,"i"),[ii,""]],[new RegExp(ai,"i"),[ai,""]],[Si,[Hs,""]],[new RegExp(ui,"i"),(e,t)=>{if(/Phone/.test(t)||/WPDesktop/.test(t))return[di,""];if(new RegExp(js).test(t)&&!/IEMobile\b/.test(t))return[ui+" "+js,""];var n=/Windows NT ([0-9.]+)/i.exec(t);if(n&&n[1]){var r=n[1],s=xi[r]||"";return/arm/i.test(t)&&(s="RT"),[ui,s]}return[ui,""]}],[/((iPhone|iPad|iPod).*?OS (\d+)_(\d+)_?(\d+)?|iPhone)/,e=>{if(e&&e[3]){var t=[e[3],e[4],e[5]||"0"];return[Ns,t.join(".")]}return[Ns,""]}],[/(watch.*\/(\d+\.\d+\.\d+)|watch os,(\d+\.\d+),)/i,e=>{var t="";return e&&e.length>=3&&(t=P(e[2])?e[3]:e[2]),["watchOS",t]}],[new RegExp("("+Ls+" (\\d+)\\.(\\d+)\\.?(\\d+)?|"+Ls+")","i"),e=>{if(e&&e[2]){var t=[e[2],e[3],e[4]||"0"];return[Ls,t.join(".")]}return[Ls,""]}],[/Mac OS X (\d+)[_.](\d+)[_.]?(\d+)?/i,e=>{var t=["Mac OS X",""];if(e&&e[1]){var n=[e[1],e[2],e[3]||"0"];t[1]=n.join(".")}return t}],[/Mac/i,["Mac OS X",""]],[/CrOS/,[Vs,""]],[/Linux|debian/i,["Linux",""]]],Ci=function(e){return Ei.test(e)?ii:vi.test(e)?ai:wi.test(e)?oi:new RegExp(pi,"i").test(e)?pi:new RegExp("("+di+"|WPDesktop)","i").test(e)?di:/iPad/.test(e)?Fs:/iPod/.test(e)?"iPod Touch":/iPhone/.test(e)?"iPhone":/(watch)(?: ?os[,/]|\d,\d\/)[\d.]+/i.test(e)?Gs:Si.test(e)?Hs:/(kobo)\s(ereader|touch)/i.test(e)?"Kobo":new RegExp(hi,"i").test(e)?hi:/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i.test(e)||/(kf[a-z]+)( bui|\)).+silk\//i.test(e)?"Kindle Fire":/(Android|ZTE)/i.test(e)?!new RegExp(js).test(e)||/(9138B|TB782B|Nexus [97]|pixel c|HUAWEISHT|BTV|noble nook|smart ultra 6)/i.test(e)?/pixel[\daxl ]{1,6}/i.test(e)&&!/pixel c/i.test(e)||/(huaweimed-al00|tah-|APA|SM-G92|i980|zte|U304AA)/i.test(e)||/lmy47v/i.test(e)&&!/QTAQZ3/i.test(e)?Ls:Us:Ls:new RegExp("(pda|"+js+")","i").test(e)?gi:new RegExp(Ds,"i").test(e)&&!new RegExp(Ds+" pc","i").test(e)?fi:""},Ai="https?://(.*)",Pi=["gclid","gclsrc","dclid","gbraid","wbraid","fbclid","msclkid","twclid","li_fat_id","igshid","ttclid","rdt_cid","epik","qclid","sccid","irclid","_kx"],Mi=Q(["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gad_source","mc_cid"],Pi),Ri="<masked>",$i=["li_fat_id"];function ji(e,t,n){if(!l)return{};var r,s=t?Q([],Pi,n||[]):[],i=Ni(Ct(l.URL,s,Ri),e),a=(r={},Z($i,function(e){var t=qt.V(e);r[e]=t||null}),r);return X(a,i)}function Ni(e,t){var n=Mi.concat(t||[]),r={};return Z(n,function(t){var n=Ot(e,t);r[t]=n||null}),r}function Li(e){var t=function(e){return e?0===e.search(Ai+"google.([^/?]*)")?"google":0===e.search(Ai+"bing.com")?"bing":0===e.search(Ai+"yahoo.com")?"yahoo":0===e.search(Ai+"duckduckgo.com")?"duckduckgo":null:null}(e),n="yahoo"!=t?"q":"p",r={};if(!$(t)){r.$search_engine=t;var s=l?Ot(l.referrer,n):"";s.length&&(r.ph_keyword=s)}return r}function Di(){return navigator.language||navigator.userLanguage}function Ui(){return(null==l?void 0:l.referrer)||"$direct"}function Fi(e,t){var n=e?Q([],Pi,t||[]):[],r=null==u?void 0:u.href.substring(0,1e3);return{r:Ui().substring(0,1e3),u:r?Ct(r,n,Ri):void 0}}function Yi(e){var t,{r:n,u:r}=e,s={$referrer:n,$referring_domain:null==n?void 0:"$direct"==n?"$direct":null==(t=It(n))?void 0:t.host};if(r){s.$current_url=r;var i=It(r);s.$host=null==i?void 0:i.host,s.$pathname=null==i?void 0:i.pathname;var a=Ni(r);X(s,a)}if(n){var o=Li(n);X(s,o)}return s}function Gi(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){return}}function Bi(){try{return(new Date).getTimezoneOffset()}catch(e){return}}function Hi(e,t){if(!m)return{};var n,s,i,a=e?Q([],Pi,t||[]):[],[o,c]=function(e){for(var t=0;t<Oi.length;t++){var[n,r]=Oi[t],s=n.exec(e),i=s&&(O(r)?r(s,e):r);if(i)return i}return["",""]}(m);return X(re({$os:o,$os_version:c,$browser:ki(m,navigator.vendor),$device:Ci(m),$device_type:(s=m,i=Ci(s),i===Fs||i===Us||"Kobo"===i||"Kindle Fire"===i||i===fi?Ds:i===ii||i===oi||i===ai||i===pi?"Console":i===Gs?"Wearable":i?js:"Desktop"),$timezone:Gi(),$timezone_offset:Bi()}),{$current_url:Ct(null==u?void 0:u.href,a,Ri),$host:null==u?void 0:u.host,$pathname:null==u?void 0:u.pathname,$raw_user_agent:m.length>1e3?m.substring(0,997)+"...":m,$browser_version:Ii(m,navigator.vendor),$browser_language:Di(),$browser_language_prefix:(n=Di(),"string"==typeof n?n.split("-")[0]:void 0),$screen_height:null==r?void 0:r.screen.height,$screen_width:null==r?void 0:r.screen.width,$viewport_height:null==r?void 0:r.innerHeight,$viewport_width:null==r?void 0:r.innerWidth,$lib:"web",$lib_version:f.LIB_VERSION,$insert_id:Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10),$time:Date.now()/1e3})}var zi=q("[FeatureFlags]"),qi="$active_feature_flags",Ki="$override_feature_flags",Wi="$feature_flag_payloads",Vi="$override_feature_flag_payloads",Ji="$feature_flag_request_id",Zi=e=>{var t={};for(var[n,r]of ee(e||{}))r&&(t[n]=r);return t},Xi=function(e){return e.FeatureFlags="feature_flags",e.Recordings="recordings",e}({});class Qi{constructor(e){this.ye=!1,this.we=!1,this.Se=!1,this.$e=!1,this.ke=!1,this.xe=!1,this.Ee=!1,this._instance=e,this.featureFlagEventHandlers=[]}flags(){if(this._instance.config.__preview_remote_config)this.xe=!0;else{var e=!this.Ie&&(this._instance.config.advanced_disable_feature_flags||this._instance.config.advanced_disable_feature_flags_on_first_load);this.Re({disableFlags:e})}}get hasLoadedFlags(){return this.we}getFlags(){return Object.keys(this.getFlagVariants())}getFlagsWithDetails(){var e=this._instance.get_property(Re),t=this._instance.get_property(Ki),n=this._instance.get_property(Vi);if(!n&&!t)return e||{};var r=X({},e||{}),s=[...new Set([...Object.keys(n||{}),...Object.keys(t||{})])];for(var i of s){var a,o,c=r[i],l=null==t?void 0:t[i],u=P(l)?null!==(a=null==c?void 0:c.enabled)&&void 0!==a&&a:!!l,d=P(l)?c.variant:"string"==typeof l?l:void 0,h=null==n?void 0:n[i],p=y({},c,{enabled:u,variant:u?null!=d?d:null==c?void 0:c.variant:void 0});u!==(null==c?void 0:c.enabled)&&(p.original_enabled=null==c?void 0:c.enabled),d!==(null==c?void 0:c.variant)&&(p.original_variant=null==c?void 0:c.variant),h&&(p.metadata=y({},null==c?void 0:c.metadata,{payload:h,original_payload:null==c||null==(o=c.metadata)?void 0:o.payload})),r[i]=p}return this.ye||(zi.warn(" Overriding feature flag details!",{flagDetails:e,overriddenPayloads:n,finalDetails:r}),this.ye=!0),r}getFlagVariants(){var e=this._instance.get_property(Pe),t=this._instance.get_property(Ki);if(!t)return e||{};for(var n=X({},e),r=Object.keys(t),s=0;s<r.length;s++)n[r[s]]=t[r[s]];return this.ye||(zi.warn(" Overriding feature flags!",{enabledFlags:e,overriddenFlags:t,finalFlags:n}),this.ye=!0),n}getFlagPayloads(){var e=this._instance.get_property(Wi),t=this._instance.get_property(Vi);if(!t)return e||{};for(var n=X({},e||{}),r=Object.keys(t),s=0;s<r.length;s++)n[r[s]]=t[r[s]];return this.ye||(zi.warn(" Overriding feature flag payloads!",{flagPayloads:e,overriddenPayloads:t,finalPayloads:n}),this.ye=!0),n}reloadFeatureFlags(){this.$e||this._instance.config.advanced_disable_feature_flags||this.Ie||(this.Ie=setTimeout(()=>{this.Re()},5))}Pe(){clearTimeout(this.Ie),this.Ie=void 0}ensureFlagsLoaded(){this.we||this.Se||this.Ie||this.reloadFeatureFlags()}setAnonymousDistinctId(e){this.$anon_distinct_id=e}setReloadingPaused(e){this.$e=e}Re(e){var t;if(this.Pe(),!this._instance.L())if(this.Se)this.ke=!0;else{var n={token:this._instance.config.token,distinct_id:this._instance.get_distinct_id(),groups:this._instance.getGroups(),$anon_distinct_id:this.$anon_distinct_id,person_properties:y({},(null==(t=this._instance.persistence)?void 0:t.get_initial_props())||{},this._instance.get_property($e)||{}),group_properties:this._instance.get_property(je)};(null!=e&&e.disableFlags||this._instance.config.advanced_disable_feature_flags)&&(n.disable_flags=!0);var r=this._instance.config.__preview_remote_config,s=r?"/flags/?v=2":"/flags/?v=2&config=true",i=this._instance.config.advanced_only_evaluate_survey_feature_flags?"&only_evaluate_survey_feature_flags=true":"",a=this._instance.requestRouter.endpointFor("api",s+i);r&&(n.timezone=Gi()),this.Se=!0,this._instance.Te({method:"POST",url:a,data:n,compression:this._instance.config.disable_compression?void 0:xt.Base64,timeout:this._instance.config.feature_flag_request_timeout_ms,callback:e=>{var t,r,s=!0;if(200===e.statusCode&&(this.ke||(this.$anon_distinct_id=void 0),s=!1),this.Se=!1,this.xe||(this.xe=!0,this._instance.Ce(null!==(r=e.json)&&void 0!==r?r:{})),!n.disable_flags||this.ke)if(this.Ee=!s,e.json&&null!=(t=e.json.quotaLimited)&&t.includes(Xi.FeatureFlags))zi.warn("You have hit your feature flags quota limit, and will not be able to load feature flags until the quota is reset.  Please visit https://posthog.com/docs/billing/limits-alerts to learn more.");else{var i;n.disable_flags||this.receivedFeatureFlags(null!==(i=e.json)&&void 0!==i?i:{},s),this.ke&&(this.ke=!1,this.Re())}}})}}getFeatureFlag(e,t){if(void 0===t&&(t={}),this.we||this.getFlags()&&this.getFlags().length>0){var n=this.getFlagVariants()[e],r=""+n,s=this._instance.get_property(Ji)||void 0,i=this._instance.get_property(De)||{};if((t.send_event||!("send_event"in t))&&(!(e in i)||!i[e].includes(r))){var a,o,c,l,u,d,h,p,m;I(i[e])?i[e].push(r):i[e]=[r],null==(a=this._instance.persistence)||a.register({[De]:i});var g=this.getFeatureFlagDetails(e),f={$feature_flag:e,$feature_flag_response:n,$feature_flag_payload:this.getFeatureFlagPayload(e)||null,$feature_flag_request_id:s,$feature_flag_bootstrapped_response:(null==(o=this._instance.config.bootstrap)||null==(o=o.featureFlags)?void 0:o[e])||null,$feature_flag_bootstrapped_payload:(null==(c=this._instance.config.bootstrap)||null==(c=c.featureFlagPayloads)?void 0:c[e])||null,$used_bootstrap_value:!this.Ee};P(null==g||null==(l=g.metadata)?void 0:l.version)||(f.$feature_flag_version=g.metadata.version);var y,_=null!==(u=null==g||null==(d=g.reason)?void 0:d.description)&&void 0!==u?u:null==g||null==(h=g.reason)?void 0:h.code;_&&(f.$feature_flag_reason=_),null!=g&&null!=(p=g.metadata)&&p.id&&(f.$feature_flag_id=g.metadata.id),P(null==g?void 0:g.original_variant)&&P(null==g?void 0:g.original_enabled)||(f.$feature_flag_original_response=P(g.original_variant)?g.original_enabled:g.original_variant),null!=g&&null!=(m=g.metadata)&&m.original_payload&&(f.$feature_flag_original_payload=null==g||null==(y=g.metadata)?void 0:y.original_payload),this._instance.capture("$feature_flag_called",f)}return n}zi.warn('getFeatureFlag for key "'+e+"\" failed. Feature flags didn't load in time.")}getFeatureFlagDetails(e){return this.getFlagsWithDetails()[e]}getFeatureFlagPayload(e){return this.getFlagPayloads()[e]}getRemoteConfigPayload(e,t){var n=this._instance.config.token;this._instance.Te({method:"POST",url:this._instance.requestRouter.endpointFor("api","/flags/?v=2&config=true"),data:{distinct_id:this._instance.get_distinct_id(),token:n},compression:this._instance.config.disable_compression?void 0:xt.Base64,timeout:this._instance.config.feature_flag_request_timeout_ms,callback:n=>{var r,s=null==(r=n.json)?void 0:r.featureFlagPayloads;t((null==s?void 0:s[e])||void 0)}})}isFeatureEnabled(e,t){if(void 0===t&&(t={}),this.we||this.getFlags()&&this.getFlags().length>0)return!!this.getFeatureFlag(e,t);zi.warn('isFeatureEnabled for key "'+e+"\" failed. Feature flags didn't load in time.")}addFeatureFlagsHandler(e){this.featureFlagEventHandlers.push(e)}removeFeatureFlagsHandler(e){this.featureFlagEventHandlers=this.featureFlagEventHandlers.filter(t=>t!==e)}receivedFeatureFlags(e,t){if(this._instance.persistence){this.we=!0;var n=this.getFlagVariants(),r=this.getFlagPayloads(),s=this.getFlagsWithDetails();!function(e,t,n,r,s){void 0===n&&(n={}),void 0===r&&(r={}),void 0===s&&(s={});var i=(e=>{var t=e.flags;return t?(e.featureFlags=Object.fromEntries(Object.keys(t).map(e=>{var n;return[e,null!==(n=t[e].variant)&&void 0!==n?n:t[e].enabled]})),e.featureFlagPayloads=Object.fromEntries(Object.keys(t).filter(e=>t[e].enabled).filter(e=>{var n;return null==(n=t[e].metadata)?void 0:n.payload}).map(e=>{var n;return[e,null==(n=t[e].metadata)?void 0:n.payload]}))):zi.warn("Using an older version of the feature flags endpoint. Please upgrade your PostHog server to the latest version"),e})(e),a=i.flags,o=i.featureFlags,c=i.featureFlagPayloads;if(o){var l=e.requestId;if(I(o)){zi.warn("v1 of the feature flags endpoint is deprecated. Please use the latest version.");var u={};if(o)for(var d=0;d<o.length;d++)u[o[d]]=!0;t&&t.register({[qi]:o,[Pe]:u})}else{var h=o,p=c,m=a;e.errorsWhileComputingFlags&&(h=y({},n,h),p=y({},r,p),m=y({},s,m)),t&&t.register(y({[qi]:Object.keys(Zi(h)),[Pe]:h||{},[Wi]:p||{},[Re]:m||{}},l?{[Ji]:l}:{}))}}}(e,this._instance.persistence,n,r,s),this.Me(t)}}override(e,t){void 0===t&&(t=!1),zi.warn("override is deprecated. Please use overrideFeatureFlags instead."),this.overrideFeatureFlags({flags:e,suppressWarning:t})}overrideFeatureFlags(e){if(!this._instance.__loaded||!this._instance.persistence)return zi.uninitializedWarning("posthog.featureFlags.overrideFeatureFlags");if(!1===e)return this._instance.persistence.unregister(Ki),this._instance.persistence.unregister(Vi),void this.Me();if(e&&"object"==typeof e&&("flags"in e||"payloads"in e)){var t,n=e;if(this.ye=Boolean(null!==(t=n.suppressWarning)&&void 0!==t&&t),"flags"in n)if(!1===n.flags)this._instance.persistence.unregister(Ki);else if(n.flags)if(I(n.flags)){for(var r={},s=0;s<n.flags.length;s++)r[n.flags[s]]=!0;this._instance.persistence.register({[Ki]:r})}else this._instance.persistence.register({[Ki]:n.flags});return"payloads"in n&&(!1===n.payloads?this._instance.persistence.unregister(Vi):n.payloads&&this._instance.persistence.register({[Vi]:n.payloads})),void this.Me()}this.Me()}onFeatureFlags(e){if(this.addFeatureFlagsHandler(e),this.we){var{flags:t,flagVariants:n}=this.Oe();e(t,n)}return()=>this.removeFeatureFlagsHandler(e)}updateEarlyAccessFeatureEnrollment(e,t,n){var r,s=(this._instance.get_property(Me)||[]).find(t=>t.flagKey===e),i={["$feature_enrollment/"+e]:t},a={$feature_flag:e,$feature_enrollment:t,$set:i};s&&(a.$early_access_feature_name=s.name),n&&(a.$feature_enrollment_stage=n),this._instance.capture("$feature_enrollment_update",a),this.setPersonPropertiesForFlags(i,!1);var o=y({},this.getFlagVariants(),{[e]:t});null==(r=this._instance.persistence)||r.register({[qi]:Object.keys(Zi(o)),[Pe]:o}),this.Me()}getEarlyAccessFeatures(e,t,n){void 0===t&&(t=!1);var r=this._instance.get_property(Me),s=n?"&"+n.map(e=>"stage="+e).join("&"):"";if(r&&!t)return e(r);this._instance.Te({url:this._instance.requestRouter.endpointFor("api","/api/early_access_features/?token="+this._instance.config.token+s),method:"GET",callback:t=>{var n,r;if(t.json){var s=t.json.earlyAccessFeatures;return null==(n=this._instance.persistence)||n.unregister(Me),null==(r=this._instance.persistence)||r.register({[Me]:s}),e(s)}}})}Oe(){var e=this.getFlags(),t=this.getFlagVariants();return{flags:e.filter(e=>t[e]),flagVariants:Object.keys(t).filter(e=>t[e]).reduce((e,n)=>(e[n]=t[n],e),{})}}Me(e){var{flags:t,flagVariants:n}=this.Oe();this.featureFlagEventHandlers.forEach(r=>r(t,n,{errorsLoading:e}))}setPersonPropertiesForFlags(e,t){void 0===t&&(t=!0);var n=this._instance.get_property($e)||{};this._instance.register({[$e]:y({},n,e)}),t&&this._instance.reloadFeatureFlags()}resetPersonPropertiesForFlags(){this._instance.unregister($e)}setGroupPropertiesForFlags(e,t){void 0===t&&(t=!0);var n=this._instance.get_property(je)||{};0!==Object.keys(n).length&&Object.keys(n).forEach(t=>{n[t]=y({},n[t],e[t]),delete e[t]}),this._instance.register({[je]:y({},n,e)}),t&&this._instance.reloadFeatureFlags()}resetGroupPropertiesForFlags(e){if(e){var t=this._instance.get_property(je)||{};this._instance.register({[je]:y({},t,{[e]:{}})})}else this._instance.unregister(je)}reset(){this.we=!1,this.Se=!1,this.$e=!1,this.ke=!1,this.xe=!1,this.Ee=!1,this.$anon_distinct_id=void 0,this.Pe(),this.ye=!1}}var ea=["cookie","localstorage","localstorage+cookie","sessionstorage","memory"];class ta{constructor(e,t){this.A=e,this.props={},this.Fe=!1,this.Ae=(e=>{var t="";return e.token&&(t=e.token.replace(/\+/g,"PL").replace(/\//g,"SL").replace(/=/g,"EQ")),e.persistence_name?"ph_"+e.persistence_name:"ph_"+t+"_posthog"})(e),this.it=this.De(e),this.load(),e.debug&&z.info("Persistence loaded",e.persistence,y({},this.props)),this.update_config(e,e,t),this.save()}isDisabled(){return!!this.je}De(e){-1===ea.indexOf(e.persistence.toLowerCase())&&(z.critical("Unknown persistence type "+e.persistence+"; falling back to localStorage+cookie"),e.persistence="localStorage+cookie");var t=e.persistence.toLowerCase();return"localstorage"===t&&Wt.G()?Wt:"localstorage+cookie"===t&&Jt.G()?Jt:"sessionstorage"===t&&en.G()?en:"memory"===t?Xt:"cookie"===t?qt:Jt.G()?Jt:qt}properties(){var e={};return Z(this.props,function(t,n){if(n===Pe&&C(t))for(var r=Object.keys(t),s=0;s<r.length;s++)e["$feature/"+r[s]]=t[r[s]];else a=n,c=!1,($(i=We)?c:o&&i.indexOf===o?-1!=i.indexOf(a):(Z(i,function(e){if(c||(c=e===a))return V}),c))||(e[n]=t);var i,a,c}),e}load(){if(!this.je){var e=this.it.K(this.Ae);e&&(this.props=X({},e))}}save(){this.je||this.it.Y(this.Ae,this.props,this.Le,this.Ne,this.ze,this.A.debug)}remove(){this.it.X(this.Ae,!1),this.it.X(this.Ae,!0)}clear(){this.remove(),this.props={}}register_once(e,t,n){if(C(e)){P(t)&&(t="None"),this.Le=P(n)?this.Ue:n;var r=!1;if(Z(e,(e,n)=>{this.props.hasOwnProperty(n)&&this.props[n]!==t||(this.props[n]=e,r=!0)}),r)return this.save(),!0}return!1}register(e,t){if(C(e)){this.Le=P(t)?this.Ue:t;var n=!1;if(Z(e,(t,r)=>{e.hasOwnProperty(r)&&this.props[r]!==t&&(this.props[r]=t,n=!0)}),n)return this.save(),!0}return!1}unregister(e){e in this.props&&(delete this.props[e],this.save())}update_campaign_params(){if(!this.Fe){var e=ji(this.A.custom_campaign_params,this.A.mask_personal_data_properties,this.A.custom_personal_data_properties);A(re(e))||this.register(e),this.Fe=!0}}update_search_keyword(){var e;this.register((e=null==l?void 0:l.referrer)?Li(e):{})}update_referrer_info(){var e;this.register_once({$referrer:Ui(),$referring_domain:null!=l&&l.referrer&&(null==(e=It(l.referrer))?void 0:e.host)||"$direct"},void 0)}set_initial_person_info(){this.props[Ge]||this.props[Be]||this.register_once({[He]:Fi(this.A.mask_personal_data_properties,this.A.custom_personal_data_properties)},void 0)}get_initial_props(){var e={};Z([Be,Ge],t=>{var n=this.props[t];n&&Z(n,function(t,n){e["$initial_"+E(n)]=t})});var t,n,r=this.props[He];if(r){var s=(t=Yi(r),n={},Z(t,function(e,t){n["$initial_"+E(t)]=e}),n);X(e,s)}return e}safe_merge(e){return Z(this.props,function(t,n){n in e||(e[n]=t)}),e}update_config(e,t,n){if(this.Ue=this.Le=e.cookie_expiration,this.set_disabled(e.disable_persistence||!!n),this.set_cross_subdomain(e.cross_subdomain_cookie),this.set_secure(e.secure_cookie),e.persistence!==t.persistence){var r=this.De(e),s=this.props;this.clear(),this.it=r,this.props=s,this.save()}}set_disabled(e){this.je=e,this.je?this.remove():this.save()}set_cross_subdomain(e){e!==this.Ne&&(this.Ne=e,this.remove(),this.save())}set_secure(e){e!==this.ze&&(this.ze=e,this.remove(),this.save())}set_event_timer(e,t){var n=this.props[ue]||{};n[e]=t,this.props[ue]=n,this.save()}remove_event_timer(e){var t=(this.props[ue]||{})[e];return P(t)||(delete this.props[ue][e],this.save()),t}get_property(e){return this.props[e]}set_property(e,t){this.props[e]=t,this.save()}}class na{constructor(){this.qe={},this.qe={}}on(e,t){return this.qe[e]||(this.qe[e]=[]),this.qe[e].push(t),()=>{this.qe[e]=this.qe[e].filter(e=>e!==t)}}emit(e,t){for(var n of this.qe[e]||[])n(t);for(var r of this.qe["*"]||[])r(e,t)}}class ra{constructor(e){this.Be=new na,this.He=(e,t)=>this.We(e,t)&&this.Ge(e,t)&&this.Je(e,t),this.We=(e,t)=>null==t||!t.event||(null==e?void 0:e.event)===(null==t?void 0:t.event),this._instance=e,this.Ve=new Set,this.Ke=new Set}init(){var e,t;P(null==(e=this._instance)?void 0:e.Ye)||(null==(t=this._instance)||t.Ye((e,t)=>{this.on(e,t)}))}register(e){var t,n;if(!P(null==(t=this._instance)?void 0:t.Ye)&&(e.forEach(e=>{var t,n;null==(t=this.Ke)||t.add(e),null==(n=e.steps)||n.forEach(e=>{var t;null==(t=this.Ve)||t.add((null==e?void 0:e.event)||"")})}),null!=(n=this._instance)&&n.autocapture)){var r,s=new Set;e.forEach(e=>{var t;null==(t=e.steps)||t.forEach(e=>{null!=e&&e.selector&&s.add(null==e?void 0:e.selector)})}),null==(r=this._instance)||r.autocapture.setElementSelectors(s)}}on(e,t){var n;null!=t&&0!=e.length&&(this.Ve.has(e)||this.Ve.has(null==t?void 0:t.event))&&this.Ke&&(null==(n=this.Ke)?void 0:n.size)>0&&this.Ke.forEach(e=>{this.Xe(t,e)&&this.Be.emit("actionCaptured",e.name)})}Qe(e){this.onAction("actionCaptured",t=>e(t))}Xe(e,t){if(null==(null==t?void 0:t.steps))return!1;for(var n of t.steps)if(this.He(e,n))return!0;return!1}onAction(e,t){return this.Be.on(e,t)}Ge(e,t){if(null!=t&&t.url){var n,r=null==e||null==(n=e.properties)?void 0:n.$current_url;if(!r||"string"!=typeof r)return!1;if(!ra.Ze(r,null==t?void 0:t.url,(null==t?void 0:t.url_matching)||"contains"))return!1}return!0}static Ze(e,t,n){switch(n){case"regex":return!!r&&Cs(e,t);case"exact":return t===e;case"contains":var s=ra.tr(t).replace(/_/g,".").replace(/%/g,".*");return Cs(e,s);default:return!1}}static tr(e){return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}Je(e,t){if((null!=t&&t.href||null!=t&&t.tag_name||null!=t&&t.text)&&!this.ir(e).some(e=>!(null!=t&&t.href&&!ra.Ze(e.href||"",null==t?void 0:t.href,(null==t?void 0:t.href_matching)||"exact")||null!=t&&t.tag_name&&e.tag_name!==(null==t?void 0:t.tag_name)||null!=t&&t.text&&!ra.Ze(e.text||"",null==t?void 0:t.text,(null==t?void 0:t.text_matching)||"exact")&&!ra.Ze(e.$el_text||"",null==t?void 0:t.text,(null==t?void 0:t.text_matching)||"exact"))))return!1;if(null!=t&&t.selector){var n,r=null==e||null==(n=e.properties)?void 0:n.$element_selectors;if(!r)return!1;if(!r.includes(null==t?void 0:t.selector))return!1}return!0}ir(e){return null==(null==e?void 0:e.properties.$elements)?[]:null==e?void 0:e.properties.$elements}}(function(e){e.Button="button",e.Tab="tab",e.Selector="selector"})({}),function(e){e.TopLeft="top_left",e.TopRight="top_right",e.TopCenter="top_center",e.MiddleLeft="middle_left",e.MiddleRight="middle_right",e.MiddleCenter="middle_center",e.Left="left",e.Center="center",e.Right="right",e.NextToTrigger="next_to_trigger"}({});var sa=function(e){return e.Popover="popover",e.API="api",e.Widget="widget",e.ExternalSurvey="external_survey",e}({}),ia=(function(e){e.Open="open",e.MultipleChoice="multiple_choice",e.SingleChoice="single_choice",e.Rating="rating",e.Link="link"}({}),function(e){e.NextQuestion="next_question",e.End="end",e.ResponseBased="response_based",e.SpecificQuestion="specific_question"}({}),function(e){e.Once="once",e.Recurring="recurring",e.Always="always"}({}),function(e){return e.SHOWN="survey shown",e.DISMISSED="survey dismissed",e.SENT="survey sent",e}({})),aa=function(e){return e.SURVEY_ID="$survey_id",e.SURVEY_NAME="$survey_name",e.SURVEY_RESPONSE="$survey_response",e.SURVEY_ITERATION="$survey_iteration",e.SURVEY_ITERATION_START_DATE="$survey_iteration_start_date",e.SURVEY_PARTIALLY_COMPLETED="$survey_partially_completed",e.SURVEY_SUBMISSION_ID="$survey_submission_id",e.SURVEY_QUESTIONS="$survey_questions",e.SURVEY_COMPLETED="$survey_completed",e}({}),oa=q("[Surveys]"),ca="seenSurvey_",la=(e,t)=>{var n="$survey_"+t+"/"+e.id;return e.current_iteration&&e.current_iteration>0&&(n="$survey_"+t+"/"+e.id+"/"+e.current_iteration),n},ua=e=>{var t=""+ca+e.id;return e.current_iteration&&e.current_iteration>0&&(t=""+ca+e.id+"_"+e.current_iteration),t},da=[sa.Popover,sa.Widget,sa.API];class ha{constructor(e){this._instance=e,this.er=new Map,this.rr=new Map}register(e){var t;P(null==(t=this._instance)?void 0:t.Ye)||(this.sr(e),this.nr(e))}nr(e){var t=e.filter(e=>{var t,n;return(null==(t=e.conditions)?void 0:t.actions)&&(null==(n=e.conditions)||null==(n=n.actions)||null==(n=n.values)?void 0:n.length)>0});0!==t.length&&(null==this.ar&&(this.ar=new ra(this._instance),this.ar.init(),this.ar.Qe(e=>{this.onAction(e)})),t.forEach(e=>{var t,n,r,s,i;e.conditions&&null!=(t=e.conditions)&&t.actions&&null!=(n=e.conditions)&&null!=(n=n.actions)&&n.values&&(null==(r=e.conditions)||null==(r=r.actions)||null==(r=r.values)?void 0:r.length)>0&&(null==(s=this.ar)||s.register(e.conditions.actions.values),null==(i=e.conditions)||null==(i=i.actions)||null==(i=i.values)||i.forEach(t=>{if(t&&t.name){var n=this.rr.get(t.name);n&&n.push(e.id),this.rr.set(t.name,n||[e.id])}}))}))}sr(e){var t;0!==e.filter(e=>{var t,n;return(null==(t=e.conditions)?void 0:t.events)&&(null==(n=e.conditions)||null==(n=n.events)||null==(n=n.values)?void 0:n.length)>0}).length&&(null==(t=this._instance)||t.Ye((e,t)=>{this.onEvent(e,t)}),e.forEach(e=>{var t;null==(t=e.conditions)||null==(t=t.events)||null==(t=t.values)||t.forEach(t=>{if(t&&t.name){var n=this.er.get(t.name);n&&n.push(e.id),this.er.set(t.name,n||[e.id])}})}))}onEvent(e,t){var n,r=(null==(n=this._instance)||null==(n=n.persistence)?void 0:n.props[Le])||[];if("survey shown"===e&&t&&r.length>0){var s;oa.info("survey event matched, removing survey from activated surveys",{event:e,eventPayload:t,existingActivatedSurveys:r});var i=null==t||null==(s=t.properties)?void 0:s.$survey_id;if(i){var a=r.indexOf(i);a>=0&&(r.splice(a,1),this.lr(r))}}else this.er.has(e)&&(oa.info("survey event matched, updating activated surveys",{event:e,surveys:this.er.get(e)}),this.lr(r.concat(this.er.get(e)||[])))}onAction(e){var t,n=(null==(t=this._instance)||null==(t=t.persistence)?void 0:t.props[Le])||[];this.rr.has(e)&&this.lr(n.concat(this.rr.get(e)||[]))}lr(e){var t;null==(t=this._instance)||null==(t=t.persistence)||t.register({[Le]:[...new Set(e)]})}getSurveys(){var e;return(null==(e=this._instance)||null==(e=e.persistence)?void 0:e.props[Le])||[]}getEventToSurveys(){return this.er}hr(){return this.ar}}class pa{constructor(e){this.ur=void 0,this._surveyManager=null,this.dr=!1,this.vr=!1,this.cr=[],this._instance=e,this._surveyEventReceiver=null}onRemoteConfig(e){var t=e.surveys;if(j(t))return oa.warn("Flags not loaded yet. Not loading surveys.");var n=I(t);this.ur=n?t.length>0:t,oa.info("flags response received, isSurveysEnabled: "+this.ur),this.loadIfEnabled()}reset(){localStorage.removeItem("lastSeenSurveyDate");for(var e=[],t=0;t<localStorage.length;t++){var n=localStorage.key(t);(null!=n&&n.startsWith(ca)||null!=n&&n.startsWith("inProgressSurvey_"))&&e.push(n)}e.forEach(e=>localStorage.removeItem(e))}loadIfEnabled(){if(!this._surveyManager)if(this.vr)oa.info("Already initializing surveys, skipping...");else if(this._instance.config.disable_surveys)oa.info("Disabled. Not loading surveys.");else if(this._instance.config.cookieless_mode)oa.info("Not loading surveys in cookieless mode.");else{var e=null==g?void 0:g.__PosthogExtensions__;if(e){if(!P(this.ur)||this._instance.config.advanced_enable_surveys){var t=this.ur||this._instance.config.advanced_enable_surveys;this.vr=!0;try{var n=e.generateSurveys;if(n)return void this.pr(n,t);var r=e.loadExternalDependency;if(!r)return void this.gr("PostHog loadExternalDependency extension not found.");r(this._instance,"surveys",n=>{n||!e.generateSurveys?this.gr("Could not load surveys script",n):this.pr(e.generateSurveys,t)})}catch(e){throw this.gr("Error initializing surveys",e),e}finally{this.vr=!1}}}else oa.error("PostHog Extensions not found.")}}pr(e,t){this._surveyManager=e(this._instance,t),this._surveyEventReceiver=new ha(this._instance),oa.info("Surveys loaded successfully"),this._r({isLoaded:!0})}gr(e,t){oa.error(e,t),this._r({isLoaded:!1,error:e})}onSurveysLoaded(e){return this.cr.push(e),this._surveyManager&&this._r({isLoaded:!0}),()=>{this.cr=this.cr.filter(t=>t!==e)}}getSurveys(e,t){if(void 0===t&&(t=!1),this._instance.config.disable_surveys)return oa.info("Disabled. Not loading surveys."),e([]);var n=this._instance.get_property(Ne);if(n&&!t)return e(n,{isLoaded:!0});if(this.dr)return e([],{isLoaded:!1,error:"Surveys are already being loaded"});try{this.dr=!0,this._instance.Te({url:this._instance.requestRouter.endpointFor("api","/api/surveys/?token="+this._instance.config.token),method:"GET",timeout:this._instance.config.surveys_request_timeout_ms,callback:t=>{var n;this.dr=!1;var r=t.statusCode;if(200!==r||!t.json){var s="Surveys API could not be loaded, status: "+r;return oa.error(s),e([],{isLoaded:!1,error:s})}var i,a=t.json.surveys||[],o=a.filter(e=>function(e){return!(!e.start_date||e.end_date)}(e)&&(function(e){var t;return!(null==(t=e.conditions)||null==(t=t.events)||null==(t=t.values)||!t.length)}(e)||function(e){var t;return!(null==(t=e.conditions)||null==(t=t.actions)||null==(t=t.values)||!t.length)}(e)));return o.length>0&&(null==(i=this._surveyEventReceiver)||i.register(o)),null==(n=this._instance.persistence)||n.register({[Ne]:a}),e(a,{isLoaded:!0})}})}catch(e){throw this.dr=!1,e}}_r(e){for(var t of this.cr)try{if(!e.isLoaded)return t([],e);this.getSurveys(t)}catch(e){oa.error("Error in survey callback",e)}}getActiveMatchingSurveys(e,t){if(void 0===t&&(t=!1),!j(this._surveyManager))return this._surveyManager.getActiveMatchingSurveys(e,t);oa.warn("init was not called")}mr(e){var t=null;return this.getSurveys(n=>{var r;t=null!==(r=n.find(t=>t.id===e))&&void 0!==r?r:null}),t}br(e){if(j(this._surveyManager))return{eligible:!1,reason:"SDK is not enabled or survey functionality is not yet loaded"};var t="string"==typeof e?this.mr(e):e;return t?this._surveyManager.checkSurveyEligibility(t):{eligible:!1,reason:"Survey not found"}}canRenderSurvey(e){if(j(this._surveyManager))return oa.warn("init was not called"),{visible:!1,disabledReason:"SDK is not enabled or survey functionality is not yet loaded"};var t=this.br(e);return{visible:t.eligible,disabledReason:t.reason}}canRenderSurveyAsync(e,t){return j(this._surveyManager)?(oa.warn("init was not called"),Promise.resolve({visible:!1,disabledReason:"SDK is not enabled or survey functionality is not yet loaded"})):new Promise(n=>{this.getSurveys(t=>{var r,s=null!==(r=t.find(t=>t.id===e))&&void 0!==r?r:null;if(s){var i=this.br(s);n({visible:i.eligible,disabledReason:i.reason})}else n({visible:!1,disabledReason:"Survey not found"})},t)})}renderSurvey(e,t){if(j(this._surveyManager))oa.warn("init was not called");else{var n=this.mr(e);if(n)if(da.includes(n.type)){var r=null==l?void 0:l.querySelector(t);r?this._surveyManager.renderSurvey(n,r):oa.warn("Survey element not found")}else oa.warn("Surveys of type "+n.type+" cannot be rendered in the app");else oa.warn("Survey not found")}}}var ma=q("[RateLimiter]");class ga{constructor(e){var t,n;this.serverLimits={},this.lastEventRateLimited=!1,this.checkForLimiting=e=>{var t=e.text;if(t&&t.length)try{(JSON.parse(t).quota_limited||[]).forEach(e=>{ma.info((e||"events")+" is quota limited."),this.serverLimits[e]=(new Date).getTime()+6e4})}catch(e){return void ma.warn('could not rate limit - continuing. Error: "'+(null==e?void 0:e.message)+'"',{text:t})}},this.instance=e,this.captureEventsPerSecond=(null==(t=e.config.rate_limiting)?void 0:t.events_per_second)||10,this.captureEventsBurstLimit=Math.max((null==(n=e.config.rate_limiting)?void 0:n.events_burst_limit)||10*this.captureEventsPerSecond,this.captureEventsPerSecond),this.lastEventRateLimited=this.clientRateLimitContext(!0).isRateLimited}clientRateLimitContext(e){var t,n,r;void 0===e&&(e=!1);var s=(new Date).getTime(),i=null!==(t=null==(n=this.instance.persistence)?void 0:n.get_property(Ye))&&void 0!==t?t:{tokens:this.captureEventsBurstLimit,last:s};i.tokens+=(s-i.last)/1e3*this.captureEventsPerSecond,i.last=s,i.tokens>this.captureEventsBurstLimit&&(i.tokens=this.captureEventsBurstLimit);var a=i.tokens<1;return a||e||(i.tokens=Math.max(0,i.tokens-1)),!a||this.lastEventRateLimited||e||this.instance.capture("$$client_ingestion_warning",{$$client_ingestion_warning_message:"posthog-js client rate limited. Config is set to "+this.captureEventsPerSecond+" events per second and "+this.captureEventsBurstLimit+" events burst limit."},{skip_client_rate_limiting:!0}),this.lastEventRateLimited=a,null==(r=this.instance.persistence)||r.set_property(Ye,i),{isRateLimited:a,remainingTokens:i.tokens}}isServerRateLimited(e){var t=this.serverLimits[e||"events"]||!1;return!1!==t&&(new Date).getTime()<t}}var fa=q("[RemoteConfig]");class ya{constructor(e){this._instance=e}get remoteConfig(){var e;return null==(e=g._POSTHOG_REMOTE_CONFIG)||null==(e=e[this._instance.config.token])?void 0:e.config}yr(e){var t,n;null!=(t=g.__PosthogExtensions__)&&t.loadExternalDependency?null==(n=g.__PosthogExtensions__)||null==n.loadExternalDependency||n.loadExternalDependency(this._instance,"remote-config",()=>e(this.remoteConfig)):(fa.error("PostHog Extensions not found. Cannot load remote config."),e())}wr(e){this._instance.Te({method:"GET",url:this._instance.requestRouter.endpointFor("assets","/array/"+this._instance.config.token+"/config"),callback:t=>{e(t.json)}})}load(){try{if(this.remoteConfig)return fa.info("Using preloaded remote config",this.remoteConfig),void this.Ce(this.remoteConfig);if(this._instance.L())return void fa.warn("Remote config is disabled. Falling back to local config.");this.yr(e=>{if(!e)return fa.info("No config found after loading remote JS config. Falling back to JSON."),void this.wr(e=>{this.Ce(e)});this.Ce(e)})}catch(e){fa.error("Error loading remote config",e)}}Ce(e){e?this._instance.config.__preview_remote_config?(this._instance.Ce(e),!1!==e.hasFeatureFlags&&this._instance.featureFlags.ensureFlagsLoaded()):fa.info("__preview_remote_config is disabled. Logging config instead",e):fa.error("Failed to fetch remote config from PostHog.")}}var _a=3e3;class ba{constructor(e,t){this.Sr=!0,this.$r=[],this.kr=G((null==t?void 0:t.flush_interval_ms)||_a,250,5e3,z.createLogger("flush interval"),_a),this.Er=e}enqueue(e){this.$r.push(e),this.Ir||this.Rr()}unload(){this.Pr();var e=this.$r.length>0?this.Tr():{},t=Object.values(e);[...t.filter(e=>0===e.url.indexOf("/e")),...t.filter(e=>0!==e.url.indexOf("/e"))].map(e=>{this.Er(y({},e,{transport:"sendBeacon"}))})}enable(){this.Sr=!1,this.Rr()}Rr(){var e=this;this.Sr||(this.Ir=setTimeout(()=>{if(this.Pr(),this.$r.length>0){var t=this.Tr(),n=function(){var n=t[r],s=(new Date).getTime();n.data&&I(n.data)&&Z(n.data,e=>{e.offset=Math.abs(e.timestamp-s),delete e.timestamp}),e.Er(n)};for(var r in t)n()}},this.kr))}Pr(){clearTimeout(this.Ir),this.Ir=void 0}Tr(){var e={};return Z(this.$r,t=>{var n,r=t,s=(r?r.batchKey:null)||r.url;P(e[s])&&(e[s]=y({},r,{data:[]})),null==(n=e[s].data)||n.push(r.data)}),this.$r=[],e}}var wa=["retriesPerformedSoFar"];class va{constructor(e){this.Cr=!1,this.Mr=3e3,this.$r=[],this._instance=e,this.$r=[],this.Or=!0,!P(r)&&"onLine"in r.navigator&&(this.Or=r.navigator.onLine,oe(r,"online",()=>{this.Or=!0,this.oe()}),oe(r,"offline",()=>{this.Or=!1}))}get length(){return this.$r.length}retriableRequest(e){var{retriesPerformedSoFar:t}=e,n=_(e,wa);N(t)&&t>0&&(n.url=ks(n.url,{retry_count:t})),this._instance.Te(y({},n,{callback:e=>{200!==e.statusCode&&(e.statusCode<400||e.statusCode>=500)&&(null!=t?t:0)<10?this.Fr(y({retriesPerformedSoFar:t},n)):null==n.callback||n.callback(e)}}))}Fr(e){var t=e.retriesPerformedSoFar||0;e.retriesPerformedSoFar=t+1;var n=function(e){var t=3e3*Math.pow(2,e),n=t/2,r=Math.min(18e5,t),s=(Math.random()-.5)*(r-n);return Math.ceil(r+s)}(t),r=Date.now()+n;this.$r.push({retryAt:r,requestOptions:e});var s="Enqueued failed request for retry in "+n;navigator.onLine||(s+=" (Browser is offline)"),z.warn(s),this.Cr||(this.Cr=!0,this.Ar())}Ar(){this.Dr&&clearTimeout(this.Dr),this.Dr=setTimeout(()=>{this.Or&&this.$r.length>0&&this.oe(),this.Ar()},this.Mr)}oe(){var e=Date.now(),t=[],n=this.$r.filter(n=>n.retryAt<e||(t.push(n),!1));if(this.$r=t,n.length>0)for(var{requestOptions:r}of n)this.retriableRequest(r)}unload(){for(var{requestOptions:e}of(this.Dr&&(clearTimeout(this.Dr),this.Dr=void 0),this.$r))try{this._instance.Te(y({},e,{transport:"sendBeacon"}))}catch(e){z.error(e)}this.$r=[]}}class Ea{constructor(e){this.jr=()=>{var e,t,n,r;this.Lr||(this.Lr={});var s=this.scrollElement(),i=this.scrollY(),a=s?Math.max(0,s.scrollHeight-s.clientHeight):0,o=i+((null==s?void 0:s.clientHeight)||0),c=(null==s?void 0:s.scrollHeight)||0;this.Lr.lastScrollY=Math.ceil(i),this.Lr.maxScrollY=Math.max(i,null!==(e=this.Lr.maxScrollY)&&void 0!==e?e:0),this.Lr.maxScrollHeight=Math.max(a,null!==(t=this.Lr.maxScrollHeight)&&void 0!==t?t:0),this.Lr.lastContentY=o,this.Lr.maxContentY=Math.max(o,null!==(n=this.Lr.maxContentY)&&void 0!==n?n:0),this.Lr.maxContentHeight=Math.max(c,null!==(r=this.Lr.maxContentHeight)&&void 0!==r?r:0)},this._instance=e}getContext(){return this.Lr}resetContext(){var e=this.Lr;return setTimeout(this.jr,0),e}startMeasuringScrollPosition(){oe(r,"scroll",this.jr,{capture:!0}),oe(r,"scrollend",this.jr,{capture:!0}),oe(r,"resize",this.jr)}scrollElement(){if(!this._instance.config.scroll_root_selector)return null==r?void 0:r.document.documentElement;var e=I(this._instance.config.scroll_root_selector)?this._instance.config.scroll_root_selector:[this._instance.config.scroll_root_selector];for(var t of e){var n=null==r?void 0:r.document.querySelector(t);if(n)return n}}scrollY(){if(this._instance.config.scroll_root_selector){var e=this.scrollElement();return e&&e.scrollTop||0}return r&&(r.scrollY||r.pageYOffset||r.document.documentElement.scrollTop)||0}scrollX(){if(this._instance.config.scroll_root_selector){var e=this.scrollElement();return e&&e.scrollLeft||0}return r&&(r.scrollX||r.pageXOffset||r.document.documentElement.scrollLeft)||0}}var Sa=e=>Fi(null==e?void 0:e.config.mask_personal_data_properties,null==e?void 0:e.config.custom_personal_data_properties);class xa{constructor(e,t,n,r){this.Nr=e=>{var t=this.zr();if(!t||t.sessionId!==e){var n={sessionId:e,props:this.Ur(this._instance)};this.qr.register({[Fe]:n})}},this._instance=e,this.Br=t,this.qr=n,this.Ur=r||Sa,this.Br.onSessionId(this.Nr)}zr(){return this.qr.props[Fe]}getSetOnceProps(){var e,t=null==(e=this.zr())?void 0:e.props;return t?"r"in t?Yi(t):{$referring_domain:t.referringDomain,$pathname:t.initialPathName,utm_source:t.utm_source,utm_campaign:t.utm_campaign,utm_medium:t.utm_medium,utm_content:t.utm_content,utm_term:t.utm_term}:{}}getSessionProps(){var e={};return Z(re(this.getSetOnceProps()),(t,n)=>{"$current_url"===n&&(n="url"),e["$session_entry_"+E(n)]=t}),e}}var ka=q("[SessionId]");class Ta{constructor(e,t,n){var r;if(this.Hr=[],this.Wr=(e,t)=>Math.abs(e-t)>this.sessionTimeoutMs,!e.persistence)throw new Error("SessionIdManager requires a PostHogPersistence instance");if("always"===e.config.cookieless_mode)throw new Error('SessionIdManager cannot be used with cookieless_mode="always"');this.A=e.config,this.qr=e.persistence,this.gi=void 0,this.Ft=void 0,this._sessionStartTimestamp=null,this._sessionActivityTimestamp=null,this.Gr=t||Gt,this.Jr=n||Gt;var s=this.A.persistence_name||this.A.token,i=this.A.session_idle_timeout_seconds||1800;if(this._sessionTimeoutMs=1e3*G(i,60,36e3,ka.createLogger("session_idle_timeout_seconds"),1800),e.register({$configured_session_timeout_ms:this._sessionTimeoutMs}),this.Vr(),this.Kr="ph_"+s+"_window_id",this.Yr="ph_"+s+"_primary_window_exists",this.Xr()){var a=en.K(this.Kr),o=en.K(this.Yr);a&&!o?this.gi=a:en.X(this.Kr),en.Y(this.Yr,!0)}if(null!=(r=this.A.bootstrap)&&r.sessionID)try{var c=(()=>{var e=this.A.bootstrap.sessionID.replace(/-/g,"");if(32!==e.length)throw new Error("Not a valid UUID");if("7"!==e[12])throw new Error("Not a UUIDv7");return parseInt(e.substring(0,12),16)})();this.Qr(this.A.bootstrap.sessionID,(new Date).getTime(),c)}catch(e){ka.error("Invalid sessionID in bootstrap",e)}this.Zr()}get sessionTimeoutMs(){return this._sessionTimeoutMs}onSessionId(e){return P(this.Hr)&&(this.Hr=[]),this.Hr.push(e),this.Ft&&e(this.Ft,this.gi),()=>{this.Hr=this.Hr.filter(t=>t!==e)}}Xr(){return"memory"!==this.A.persistence&&!this.qr.je&&en.G()}ts(e){e!==this.gi&&(this.gi=e,this.Xr()&&en.Y(this.Kr,e))}es(){return this.gi?this.gi:this.Xr()?en.K(this.Kr):null}Qr(e,t,n){e===this.Ft&&t===this._sessionActivityTimestamp&&n===this._sessionStartTimestamp||(this._sessionStartTimestamp=n,this._sessionActivityTimestamp=t,this.Ft=e,this.qr.register({[Ie]:[t,e,n]}))}rs(){if(this.Ft&&this._sessionActivityTimestamp&&this._sessionStartTimestamp)return[this._sessionActivityTimestamp,this.Ft,this._sessionStartTimestamp];var e=this.qr.props[Ie];return I(e)&&2===e.length&&e.push(e[0]),e||[0,null,0]}resetSessionId(){this.Qr(null,null,null)}Zr(){oe(r,"beforeunload",()=>{this.Xr()&&en.X(this.Yr)},{capture:!1})}checkAndGetSessionAndWindowId(e,t){if(void 0===e&&(e=!1),void 0===t&&(t=null),"always"===this.A.cookieless_mode)throw new Error('checkAndGetSessionAndWindowId should not be called with cookieless_mode="always"');var n=t||(new Date).getTime(),[r,s,i]=this.rs(),a=this.es(),o=N(i)&&i>0&&Math.abs(n-i)>864e5,c=!1,l=!s,u=!e&&this.Wr(n,r);l||u||o?(s=this.Gr(),a=this.Jr(),ka.info("new session ID generated",{sessionId:s,windowId:a,changeReason:{noSessionId:l,activityTimeout:u,sessionPastMaximumLength:o}}),i=n,c=!0):a||(a=this.Jr(),c=!0);var d=0===r||!e||o?n:r,h=0===i?(new Date).getTime():i;return this.ts(a),this.Qr(s,d,h),e||this.Vr(),c&&this.Hr.forEach(e=>e(s,a,c?{noSessionId:l,activityTimeout:u,sessionPastMaximumLength:o}:void 0)),{sessionId:s,windowId:a,sessionStartTimestamp:h,changeReason:c?{noSessionId:l,activityTimeout:u,sessionPastMaximumLength:o}:void 0,lastActivityTimestamp:r}}Vr(){clearTimeout(this.ss),this.ss=setTimeout(()=>{var[e]=this.rs();this.Wr((new Date).getTime(),e)&&this.resetSessionId()},1.1*this.sessionTimeoutMs)}}var Ia=["$set_once","$set"],Oa=q("[SiteApps]");class Ca{constructor(e){this._instance=e,this.ns=[],this.apps={}}get isEnabled(){return!!this._instance.config.opt_in_site_apps}os(e,t){if(t){var n=this.globalsForEvent(t);this.ns.push(n),this.ns.length>1e3&&(this.ns=this.ns.slice(10))}}get siteAppLoaders(){var e;return null==(e=g._POSTHOG_REMOTE_CONFIG)||null==(e=e[this._instance.config.token])?void 0:e.siteApps}init(){if(this.isEnabled){var e=this._instance.Ye(this.os.bind(this));this.ls=()=>{e(),this.ns=[],this.ls=void 0}}}globalsForEvent(e){var t,n,r,s,i,a,o;if(!e)throw new Error("Event payload is required");var c={},l=this._instance.get_property("$groups")||[],u=this._instance.get_property("$stored_group_properties")||{};for(var[d,h]of Object.entries(u))c[d]={id:l[d],type:d,properties:h};var{$set_once:p,$set:m}=e;return{event:y({},_(e,Ia),{properties:y({},e.properties,m?{$set:y({},null!==(t=null==(n=e.properties)?void 0:n.$set)&&void 0!==t?t:{},m)}:{},p?{$set_once:y({},null!==(r=null==(s=e.properties)?void 0:s.$set_once)&&void 0!==r?r:{},p)}:{}),elements_chain:null!==(i=null==(a=e.properties)?void 0:a.$elements_chain)&&void 0!==i?i:"",distinct_id:null==(o=e.properties)?void 0:o.distinct_id}),person:{properties:this._instance.get_property("$stored_person_properties")},groups:c}}setupSiteApp(e){var t=this.apps[e.id],n=()=>{var n;!t.errored&&this.ns.length&&(Oa.info("Processing "+this.ns.length+" events for site app with id "+e.id),this.ns.forEach(e=>null==t.processEvent?void 0:t.processEvent(e)),t.processedBuffer=!0),Object.values(this.apps).every(e=>e.processedBuffer||e.errored)&&(null==(n=this.ls)||n.call(this))},r=!1,s=s=>{t.errored=!s,t.loaded=!0,Oa.info("Site app with id "+e.id+" "+(s?"loaded":"errored")),r&&n()};try{var{processEvent:i}=e.init({posthog:this._instance,callback:e=>{s(e)}});i&&(t.processEvent=i),r=!0}catch(t){Oa.error("Error while initializing PostHog app with config id "+e.id,t),s(!1)}if(r&&t.loaded)try{n()}catch(n){Oa.error("Error while processing buffered events PostHog app with config id "+e.id,n),t.errored=!0}}hs(){var e=this.siteAppLoaders||[];for(var t of e)this.apps[t.id]={id:t.id,loaded:!1,errored:!1,processedBuffer:!1};for(var n of e)this.setupSiteApp(n)}us(e){if(0!==Object.keys(this.apps).length){var t=this.globalsForEvent(e);for(var n of Object.values(this.apps))try{null==n.processEvent||n.processEvent(t)}catch(t){Oa.error("Error while processing event "+e.event+" for site app "+n.id,t)}}}onRemoteConfig(e){var t,n,r,s=this;if(null!=(t=this.siteAppLoaders)&&t.length)return this.isEnabled?(this.hs(),void this._instance.on("eventCaptured",e=>this.us(e))):void Oa.error('PostHog site apps are disabled. Enable the "opt_in_site_apps" config to proceed.');if(null==(n=this.ls)||n.call(this),null!=(r=e.siteApps)&&r.length)if(this.isEnabled){var i=function(e){var t;g["__$$ph_site_app_"+e]=s._instance,null==(t=g.__PosthogExtensions__)||null==t.loadSiteApp||t.loadSiteApp(s._instance,o,t=>{if(t)return Oa.error("Error while initializing PostHog app with config id "+e,t)})};for(var{id:a,url:o}of e.siteApps)i(a)}else Oa.error('PostHog site apps are disabled. Enable the "opt_in_site_apps" config to proceed.')}}var Aa=["amazonbot","amazonproductbot","app.hypefactors.com","applebot","archive.org_bot","awariobot","backlinksextendedbot","baiduspider","bingbot","bingpreview","chrome-lighthouse","dataforseobot","deepscan","duckduckbot","facebookexternal","facebookcatalog","http://yandex.com/bots","hubspot","ia_archiver","leikibot","linkedinbot","meta-externalagent","mj12bot","msnbot","nessus","petalbot","pinterest","prerender","rogerbot","screaming frog","sebot-wa","sitebulb","slackbot","slurp","trendictionbot","turnitin","twitterbot","vercel-screenshot","vercelbot","yahoo! slurp","yandexbot","zoombot","bot.htm","bot.php","(bot;","bot/","crawler","ahrefsbot","ahrefssiteaudit","semrushbot","siteauditbot","splitsignalbot","gptbot","oai-searchbot","chatgpt-user","perplexitybot","better uptime bot","sentryuptimebot","uptimerobot","headlesschrome","cypress","google-hoteladsverifier","adsbot-google","apis-google","duplexweb-google","feedfetcher-google","google favicon","google web preview","google-read-aloud","googlebot","googleother","google-cloudvertexbot","googleweblight","mediapartners-google","storebot-google","google-inspectiontool","bytespider"],Pa=function(e,t){if(!e)return!1;var n=e.toLowerCase();return Aa.concat(t||[]).some(e=>{var t=e.toLowerCase();return-1!==n.indexOf(t)})},Ma=function(e,t){if(!e)return!1;var n=e.userAgent;if(n&&Pa(n,t))return!0;try{var r=null==e?void 0:e.userAgentData;if(null!=r&&r.brands&&r.brands.some(e=>Pa(null==e?void 0:e.brand,t)))return!0}catch(e){}return!!e.webdriver},Ra=function(e){return e.US="us",e.EU="eu",e.CUSTOM="custom",e}({}),$a="i.posthog.com";class ja{constructor(e){this.ds={},this.instance=e}get apiHost(){var e=this.instance.config.api_host.trim().replace(/\/$/,"");return"https://app.posthog.com"===e?"https://us.i.posthog.com":e}get uiHost(){var e,t=null==(e=this.instance.config.ui_host)?void 0:e.replace(/\/$/,"");return t||(t=this.apiHost.replace("."+$a,".posthog.com")),"https://app.posthog.com"===t?"https://us.posthog.com":t}get region(){return this.ds[this.apiHost]||(/https:\/\/(app|us|us-assets)(\.i)?\.posthog\.com/i.test(this.apiHost)?this.ds[this.apiHost]=Ra.US:/https:\/\/(eu|eu-assets)(\.i)?\.posthog\.com/i.test(this.apiHost)?this.ds[this.apiHost]=Ra.EU:this.ds[this.apiHost]=Ra.CUSTOM),this.ds[this.apiHost]}endpointFor(e,t){if(void 0===t&&(t=""),t&&(t="/"===t[0]?t:"/"+t),"ui"===e)return this.uiHost+t;if(this.region===Ra.CUSTOM)return this.apiHost+t;var n=$a+t;switch(e){case"assets":return"https://"+this.region+"-assets."+n;case"api":return"https://"+this.region+"."+n}}}var Na={icontains:(e,t)=>!!r&&t.href.toLowerCase().indexOf(e.toLowerCase())>-1,not_icontains:(e,t)=>!!r&&-1===t.href.toLowerCase().indexOf(e.toLowerCase()),regex:(e,t)=>!!r&&Cs(t.href,e),not_regex:(e,t)=>!!r&&!Cs(t.href,e),exact:(e,t)=>t.href===e,is_not:(e,t)=>t.href!==e};class La{constructor(e){var t=this;this.getWebExperimentsAndEvaluateDisplayLogic=function(e){void 0===e&&(e=!1),t.getWebExperiments(e=>{La.vs("retrieved web experiments from the server"),t.cs=new Map,e.forEach(e=>{if(e.feature_flag_key){var n;t.cs&&(La.vs("setting flag key ",e.feature_flag_key," to web experiment ",e),null==(n=t.cs)||n.set(e.feature_flag_key,e));var r=t._instance.getFeatureFlag(e.feature_flag_key);M(r)&&e.variants[r]&&t.fs(e.name,r,e.variants[r].transforms)}else if(e.variants)for(var s in e.variants){var i=e.variants[s];La.ps(i)&&t.fs(e.name,s,i.transforms)}})},e)},this._instance=e,this._instance.onFeatureFlags(e=>{this.onFeatureFlags(e)})}onFeatureFlags(e){if(this._is_bot())La.vs("Refusing to render web experiment since the viewer is a likely bot");else if(!this._instance.config.disable_web_experiments){if(j(this.cs))return this.cs=new Map,this.loadIfEnabled(),void this.previewWebExperiment();La.vs("applying feature flags",e),e.forEach(e=>{var t;if(this.cs&&null!=(t=this.cs)&&t.has(e)){var n,r=this._instance.getFeatureFlag(e),s=null==(n=this.cs)?void 0:n.get(e);r&&null!=s&&s.variants[r]&&this.fs(s.name,r,s.variants[r].transforms)}})}}previewWebExperiment(){var e=La.getWindowLocation();if(null!=e&&e.search){var t=Ot(null==e?void 0:e.search,"__experiment_id"),n=Ot(null==e?void 0:e.search,"__experiment_variant");t&&n&&(La.vs("previewing web experiments "+t+" && "+n),this.getWebExperiments(e=>{this.gs(parseInt(t),n,e)},!1,!0))}}loadIfEnabled(){this._instance.config.disable_web_experiments||this.getWebExperimentsAndEvaluateDisplayLogic()}getWebExperiments(e,t,n){if(this._instance.config.disable_web_experiments&&!n)return e([]);var r=this._instance.get_property("$web_experiments");if(r&&!t)return e(r);this._instance.Te({url:this._instance.requestRouter.endpointFor("api","/api/web_experiments/?token="+this._instance.config.token),method:"GET",callback:t=>{if(200!==t.statusCode||!t.json)return e([]);var n=t.json.experiments||[];return e(n)}})}gs(e,t,n){var r=n.filter(t=>t.id===e);r&&r.length>0&&(La.vs("Previewing web experiment ["+r[0].name+"] with variant ["+t+"]"),this.fs(r[0].name,t,r[0].variants[t].transforms))}static ps(e){return!j(e.conditions)&&La._s(e)&&La.bs(e)}static _s(e){var t;if(j(e.conditions)||j(null==(t=e.conditions)?void 0:t.url))return!0;var n,r,s,i=La.getWindowLocation();return!!i&&(null==(n=e.conditions)||!n.url||Na[null!==(r=null==(s=e.conditions)?void 0:s.urlMatchType)&&void 0!==r?r:"icontains"](e.conditions.url,i))}static getWindowLocation(){return null==r?void 0:r.location}static bs(e){var t;if(j(e.conditions)||j(null==(t=e.conditions)?void 0:t.utm))return!0;var n=ji();if(n.utm_source){var r,s,i,a,o,c,l,u,d=null==(r=e.conditions)||null==(r=r.utm)||!r.utm_campaign||(null==(s=e.conditions)||null==(s=s.utm)?void 0:s.utm_campaign)==n.utm_campaign,h=null==(i=e.conditions)||null==(i=i.utm)||!i.utm_source||(null==(a=e.conditions)||null==(a=a.utm)?void 0:a.utm_source)==n.utm_source,p=null==(o=e.conditions)||null==(o=o.utm)||!o.utm_medium||(null==(c=e.conditions)||null==(c=c.utm)?void 0:c.utm_medium)==n.utm_medium,m=null==(l=e.conditions)||null==(l=l.utm)||!l.utm_term||(null==(u=e.conditions)||null==(u=u.utm)?void 0:u.utm_term)==n.utm_term;return d&&p&&m&&h}return!1}static vs(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];z.info("[WebExperiments] "+e,n)}fs(e,t,n){this._is_bot()?La.vs("Refusing to render web experiment since the viewer is a likely bot"):"control"!==t?n.forEach(n=>{if(n.selector){var r;La.vs("applying transform of variant "+t+" for experiment "+e+" ",n);var s=null==(r=document)?void 0:r.querySelectorAll(n.selector);null==s||s.forEach(e=>{var t=e;n.html&&(t.innerHTML=n.html),n.css&&t.setAttribute("style",n.css)})}}):La.vs("Control variants leave the page unmodified.")}_is_bot(){return c&&this._instance?Ma(c,this._instance.config.custom_blocked_useragents):void 0}}var Da=q("[PostHog ExternalIntegrations]"),Ua={intercom:"intercom-integration",crispChat:"crisp-chat-integration"};class Fa{constructor(e){this._instance=e}nt(e,t){var n;null==(n=g.__PosthogExtensions__)||null==n.loadExternalDependency||n.loadExternalDependency(this._instance,e,e=>{if(e)return Da.error("failed to load script",e);t()})}startIfEnabledOrStop(){var e=this,t=function(t){var n,s,i;!r||null!=(n=g.__PosthogExtensions__)&&null!=(n=n.integrations)&&n[t]||e.nt(Ua[t],()=>{var n;null==(n=g.__PosthogExtensions__)||null==(n=n.integrations)||null==(n=n[t])||n.start(e._instance)}),!r&&null!=(s=g.__PosthogExtensions__)&&null!=(s=s.integrations)&&s[t]&&(null==(i=g.__PosthogExtensions__)||null==(i=i.integrations)||null==(i=i[t])||i.stop())};for(var[n,r]of Object.entries(null!==(s=this._instance.config.integrations)&&void 0!==s?s:{})){var s;t(n)}}}var Ya="[SessionRecording]",Ga=q(Ya);class Ba{get started(){var e;return!(null==(e=this.ys)||!e.isStarted)}get status(){var e;return this.qt?(null==(e=this.ys)?void 0:e.status)||"lazy_loading":Mr}constructor(e){if(this._forceAllowLocalhostNetworkCapture=!1,this._instance=e,!this._instance.sessionManager)throw Ga.error("started without valid sessionManager"),new Error(Ya+" started without valid sessionManager. This is a bug.");if("always"===this._instance.config.cookieless_mode)throw new Error(Ya+' cannot be used with cookieless_mode="always"')}get qt(){var e=!!this._instance.get_property(be),t=!this._instance.config.disable_session_recording,n=this._instance.config.disable_session_recording||this._instance.consent.isOptedOut();return r&&e&&t&&!n}startIfEnabledOrStop(e){var t;if(!this.qt||null==(t=this.ys)||!t.isStarted){var n=!P(Object.assign)&&!P(Array.from);this.qt&&n?(this.ws(e),Ga.info("starting")):this.stopRecording()}}ws(e){var t,n,r;this.qt&&(null!=g&&null!=(t=g.__PosthogExtensions__)&&null!=(t=t.rrweb)&&t.record&&null!=(n=g.__PosthogExtensions__)&&n.initSessionRecording?this.Ri(e):null==(r=g.__PosthogExtensions__)||null==r.loadExternalDependency||r.loadExternalDependency(this._instance,this.Pi,t=>{if(t)return Ga.error("could not load recorder",t);this.Ri(e)}))}stopRecording(){var e;null==(e=this.ys)||e.stop()}onRemoteConfig(e){this.Ss=e;var t,n=this._instance.persistence;n&&n.register({[be]:!!e.sessionRecording,[Te]:null==(t=e.sessionRecording)?void 0:t.scriptConfig}),this.ys?(this.ys.onRemoteConfig(e),this.Ss=void 0):this.ws(),this.startIfEnabledOrStop()}log(e,t){var n;void 0===t&&(t="log"),null!=(n=this.ys)&&n.log?this.ys.log(e,t):Ga.warn("log called before recorder was ready")}get Pi(){var e;return(null==(e=this._instance)||null==(e=e.persistence)||null==(e=e.get_property(Te))?void 0:e.script)||"lazy-recorder"}Ri(e){var t,n;if(null==(t=g.__PosthogExtensions__)||!t.initSessionRecording)throw Error("Called on script loaded before session recording is available");this.ys||(this.ys=null==(n=g.__PosthogExtensions__)?void 0:n.initSessionRecording(this._instance),this.ys._forceAllowLocalhostNetworkCapture=this._forceAllowLocalhostNetworkCapture,this.Ss&&(this.ys.onRemoteConfig(this.Ss),this.Ss=void 0)),this.ys.start(e)}onRRwebEmit(e){var t;null==(t=this.ys)||null==t.onRRwebEmit||t.onRRwebEmit(e)}overrideLinkedFlag(){var e;null==(e=this.ys)||e.overrideLinkedFlag()}overrideSampling(){var e;null==(e=this.ys)||e.overrideSampling()}overrideTrigger(e){var t;null==(t=this.ys)||t.overrideTrigger(e)}get sdkDebugProperties(){var e;return(null==(e=this.ys)?void 0:e.sdkDebugProperties)||{$recording_status:this.status}}}var Ha={},za=()=>{},qa="posthog",Ka=!Ss&&-1===(null==m?void 0:m.indexOf("MSIE"))&&-1===(null==m?void 0:m.indexOf("Mozilla")),Wa=e=>{var t;return{api_host:"https://us.i.posthog.com",ui_host:null,token:"",autocapture:!0,rageclick:!0,cross_subdomain_cookie:ie(null==l?void 0:l.location),persistence:"localStorage+cookie",persistence_name:"",loaded:za,save_campaign_params:!0,custom_campaign_params:[],custom_blocked_useragents:[],save_referrer:!0,capture_pageview:"2025-05-24"!==e||"history_change",capture_pageleave:"if_capture_pageview",defaults:null!=e?e:"unset",debug:u&&M(null==u?void 0:u.search)&&-1!==u.search.indexOf("__posthog_debug=true")||!1,cookie_expiration:365,upgrade:!1,disable_session_recording:!1,disable_persistence:!1,disable_web_experiments:!0,disable_surveys:!1,disable_surveys_automatic_display:!1,disable_external_dependency_loading:!1,enable_recording_console_log:void 0,secure_cookie:"https:"===(null==r||null==(t=r.location)?void 0:t.protocol),ip:!1,opt_out_capturing_by_default:!1,opt_out_persistence_by_default:!1,opt_out_useragent_filter:!1,opt_out_capturing_persistence_type:"localStorage",consent_persistence_name:null,opt_out_capturing_cookie_prefix:null,opt_in_site_apps:!1,property_denylist:[],respect_dnt:!1,sanitize_properties:null,request_headers:{},request_batching:!0,properties_string_max_length:65535,session_recording:{},mask_all_element_attributes:!1,mask_all_text:!1,mask_personal_data_properties:!1,custom_personal_data_properties:[],advanced_disable_flags:!1,advanced_disable_decide:!1,advanced_disable_feature_flags:!1,advanced_disable_feature_flags_on_first_load:!1,advanced_only_evaluate_survey_feature_flags:!1,advanced_enable_surveys:!1,advanced_disable_toolbar_metrics:!1,feature_flag_request_timeout_ms:3e3,surveys_request_timeout_ms:1e4,on_request_error:e=>{var t="Bad HTTP status: "+e.statusCode+" "+e.text;z.error(t)},get_device_id:e=>e,capture_performance:void 0,name:"posthog",bootstrap:{},disable_compression:!1,session_idle_timeout_seconds:1800,person_profiles:"identified_only",before_send:void 0,request_queue_config:{flush_interval_ms:_a},error_tracking:{},_onCapture:za}},Va=e=>{var t={};P(e.process_person)||(t.person_profiles=e.process_person),P(e.xhr_headers)||(t.request_headers=e.xhr_headers),P(e.cookie_name)||(t.persistence_name=e.cookie_name),P(e.disable_cookie)||(t.disable_persistence=e.disable_cookie),P(e.store_google)||(t.save_campaign_params=e.store_google),P(e.verbose)||(t.debug=e.verbose);var n=X({},t,e);return I(e.property_blacklist)&&(P(e.property_denylist)?n.property_denylist=e.property_blacklist:I(e.property_denylist)?n.property_denylist=[...e.property_blacklist,...e.property_denylist]:z.error("Invalid value for property_denylist config: "+e.property_denylist)),n};class Ja{constructor(){this.__forceAllowLocalhost=!1}get $s(){return this.__forceAllowLocalhost}set $s(e){z.error("WebPerformanceObserver is deprecated and has no impact on network capture. Use `_forceAllowLocalhostNetworkCapture` on `posthog.sessionRecording`"),this.__forceAllowLocalhost=e}}class Za{get decideEndpointWasHit(){var e,t;return null!==(e=null==(t=this.featureFlags)?void 0:t.hasLoadedFlags)&&void 0!==e&&e}get flagsEndpointWasHit(){var e,t;return null!==(e=null==(t=this.featureFlags)?void 0:t.hasLoadedFlags)&&void 0!==e&&e}constructor(){this.webPerformance=new Ja,this.ks=!1,this.version=f.LIB_VERSION,this.xs=new na,this._calculate_event_properties=this.calculateEventProperties.bind(this),this.config=Wa(),this.SentryIntegration=cs,this.sentryIntegration=e=>function(e,t){var n=os(e,t);return{name:as,processEvent:e=>n(e)}}(this,e),this.__request_queue=[],this.__loaded=!1,this.analyticsDefaultEndpoint="/e/",this.Es=!1,this.Is=null,this.Rs=null,this.Ps=null,this.featureFlags=new Qi(this),this.toolbar=new ps(this),this.scrollManager=new Ea(this),this.pageViewManager=new Es(this),this.surveys=new pa(this),this.experiments=new La(this),this.exceptions=new $s(this),this.rateLimiter=new ga(this),this.requestRouter=new ja(this),this.consent=new nn(this),this.externalIntegrations=new Fa(this),this.people={set:(e,t,n)=>{var r=M(e)?{[e]:t}:e;this.setPersonProperties(r),null==n||n({})},set_once:(e,t,n)=>{var r=M(e)?{[e]:t}:e;this.setPersonProperties(void 0,r),null==n||n({})}},this.on("eventCaptured",e=>z.info('send "'+(null==e?void 0:e.event)+'"',e))}init(e,t,n){if(n&&n!==qa){var r,s=null!==(r=Ha[n])&&void 0!==r?r:new Za;return s._init(e,t,n),Ha[n]=s,Ha[qa][n]=s,s}return this._init(e,t,n)}_init(e,t,n){var s,i;if(void 0===t&&(t={}),P(e)||R(e))return z.critical("PostHog was initialized without a token. This likely indicates a misconfiguration. Please check the first argument passed to posthog.init()"),this;if(this.__loaded)return z.warn("You have already initialized PostHog! Re-initializing is a no-op"),this;this.__loaded=!0,this.config={},this.Ts=t,this.Cs=[],t.person_profiles&&(this.Rs=t.person_profiles),this.set_config(X({},Wa(t.defaults),Va(t),{name:n,token:e})),this.config.on_xhr_error&&z.error("on_xhr_error is deprecated. Use on_request_error instead"),this.compression=t.disable_compression?void 0:xt.GZipJS;var a=this.Ms();this.persistence=new ta(this.config,a),this.sessionPersistence="sessionStorage"===this.config.persistence||"memory"===this.config.persistence?this.persistence:new ta(y({},this.config,{persistence:"sessionStorage"}),a);var o=y({},this.persistence.props),c=y({},this.sessionPersistence.props);this.register({$initialization_time:(new Date).toISOString()}),this.Os=new ba(e=>this.Fs(e),this.config.request_queue_config),this.As=new va(this),this.__request_queue=[];var l="always"===this.config.cookieless_mode||"on_reject"===this.config.cookieless_mode&&this.consent.isExplicitlyOptedOut();if(l||(this.sessionManager=new Ta(this),this.sessionPropsManager=new xa(this,this.sessionManager,this.persistence)),new gs(this).startIfEnabledOrStop(),this.siteApps=new Ca(this),null==(s=this.siteApps)||s.init(),l||(this.config.__preview_lazy_load_replay?this.sessionRecording=new Ba(this):this.sessionRecording=new ss(this),this.sessionRecording.startIfEnabledOrStop()),this.config.disable_scroll_properties||this.scrollManager.startMeasuringScrollPosition(),this.autocapture=new jt(this),this.autocapture.startIfEnabled(),this.surveys.loadIfEnabled(),this.heatmaps=new vs(this),this.heatmaps.startIfEnabled(),this.webVitalsAutocapture=new _s(this),this.exceptionObserver=new ln(this),this.exceptionObserver.startIfEnabled(),this.deadClicksAutocapture=new on(this,an),this.deadClicksAutocapture.startIfEnabled(),this.historyAutocapture=new Dn(this),this.historyAutocapture.startIfEnabled(),f.DEBUG=f.DEBUG||this.config.debug,f.DEBUG&&z.info("Starting in debug mode",{this:this,config:t,thisC:y({},this.config),p:o,s:c}),void 0!==(null==(i=t.bootstrap)?void 0:i.distinctID)){var u,d,h=this.config.get_device_id(Gt()),p=null!=(u=t.bootstrap)&&u.isIdentifiedID?h:t.bootstrap.distinctID;this.persistence.set_property(Ue,null!=(d=t.bootstrap)&&d.isIdentifiedID?"identified":"anonymous"),this.register({distinct_id:t.bootstrap.distinctID,$device_id:p})}if(this.Ds()){var m,g,_=Object.keys((null==(m=t.bootstrap)?void 0:m.featureFlags)||{}).filter(e=>{var n;return!(null==(n=t.bootstrap)||null==(n=n.featureFlags)||!n[e])}).reduce((e,n)=>{var r;return e[n]=(null==(r=t.bootstrap)||null==(r=r.featureFlags)?void 0:r[n])||!1,e},{}),b=Object.keys((null==(g=t.bootstrap)?void 0:g.featureFlagPayloads)||{}).filter(e=>_[e]).reduce((e,n)=>{var r,s;return null!=(r=t.bootstrap)&&null!=(r=r.featureFlagPayloads)&&r[n]&&(e[n]=null==(s=t.bootstrap)||null==(s=s.featureFlagPayloads)?void 0:s[n]),e},{});this.featureFlags.receivedFeatureFlags({featureFlags:_,featureFlagPayloads:b})}if(l)this.register_once({distinct_id:Ke,$device_id:null},"");else if(!this.get_distinct_id()){var w=this.config.get_device_id(Gt());this.register_once({distinct_id:w,$device_id:w},""),this.persistence.set_property(Ue,"anonymous")}return oe(r,"onpagehide"in self?"pagehide":"unload",this._handle_unload.bind(this),{passive:!1}),this.toolbar.maybeLoadToolbar(),t.segment?function(e,t){var n=e.config.segment;if(!n)return t();!function(e,t){var n=e.config.segment;if(!n)return t();var r=n=>{var r=()=>n.anonymousId()||Gt();e.config.get_device_id=r,n.id()&&(e.register({distinct_id:n.id(),$device_id:r()}),e.persistence.set_property(Ue,"identified")),t()},s=n.user();"then"in s&&O(s.then)?s.then(e=>r(e)):r(s)}(e,()=>{n.register((e=>{Promise&&Promise.resolve||is.warn("This browser does not have Promise support, and can not use the segment integration");var t=(t,n)=>{if(!n)return t;t.event.userId||t.event.anonymousId===e.get_distinct_id()||(is.info("No userId set, resetting PostHog"),e.reset()),t.event.userId&&t.event.userId!==e.get_distinct_id()&&(is.info("UserId set, identifying with PostHog"),e.identify(t.event.userId));var r=e.calculateEventProperties(n,t.event.properties);return t.event.properties=Object.assign({},r,t.event.properties),t};return{name:"PostHog JS",type:"enrichment",version:"1.0.0",isLoaded:()=>!0,load:()=>Promise.resolve(),track:e=>t(e,e.event.event),page:e=>t(e,"$pageview"),identify:e=>t(e,"$identify"),screen:e=>t(e,"$screen")}})(e)).then(()=>{t()})})}(this,()=>this.js()):this.js(),O(this.config._onCapture)&&this.config._onCapture!==za&&(z.warn("onCapture is deprecated. Please use `before_send` instead"),this.on("eventCaptured",e=>this.config._onCapture(e.event,e))),this.config.ip&&z.warn('The `ip` config option has NO EFFECT AT ALL and has been deprecated. Use a custom transformation or "Discard IP data" project setting instead. See https://posthog.com/tutorials/web-redact-properties#hiding-customer-ip-address for more information.'),this}Ce(e){var t,n,r,s,i,a,o,c;if(!l||!l.body)return z.info("document not ready yet, trying again in 500 milliseconds..."),void setTimeout(()=>{this.Ce(e)},500);this.compression=void 0,e.supportedCompression&&!this.config.disable_compression&&(this.compression=w(e.supportedCompression,xt.GZipJS)?xt.GZipJS:w(e.supportedCompression,xt.Base64)?xt.Base64:void 0),null!=(t=e.analytics)&&t.endpoint&&(this.analyticsDefaultEndpoint=e.analytics.endpoint),this.set_config({person_profiles:this.Rs?this.Rs:"identified_only"}),null==(n=this.siteApps)||n.onRemoteConfig(e),null==(r=this.sessionRecording)||r.onRemoteConfig(e),null==(s=this.autocapture)||s.onRemoteConfig(e),null==(i=this.heatmaps)||i.onRemoteConfig(e),this.surveys.onRemoteConfig(e),null==(a=this.webVitalsAutocapture)||a.onRemoteConfig(e),null==(o=this.exceptionObserver)||o.onRemoteConfig(e),this.exceptions.onRemoteConfig(e),null==(c=this.deadClicksAutocapture)||c.onRemoteConfig(e)}js(){try{this.config.loaded(this)}catch(e){z.critical("`loaded` function failed",e)}this.Ls(),this.config.capture_pageview&&setTimeout(()=>{(this.consent.isOptedIn()||"always"===this.config.cookieless_mode)&&this.Ns()},1),new ya(this).load(),this.featureFlags.flags()}Ls(){var e;this.is_capturing()&&this.config.request_batching&&(null==(e=this.Os)||e.enable())}_dom_loaded(){this.is_capturing()&&J(this.__request_queue,e=>this.Fs(e)),this.__request_queue=[],this.Ls()}_handle_unload(){var e,t;this.config.request_batching?(this.zs()&&this.capture("$pageleave"),null==(e=this.Os)||e.unload(),null==(t=this.As)||t.unload()):this.zs()&&this.capture("$pageleave",null,{transport:"sendBeacon"})}Te(e){this.__loaded&&(Ka?this.__request_queue.push(e):this.rateLimiter.isServerRateLimited(e.batchKey)||(e.transport=e.transport||this.config.api_transport,e.url=ks(e.url,{ip:this.config.ip?1:0}),e.headers=y({},this.config.request_headers),e.compression="best-available"===e.compression?this.compression:e.compression,e.fetchOptions=e.fetchOptions||this.config.fetch_options,(e=>{var t,n,r,s=y({},e);s.timeout=s.timeout||6e4,s.url=ks(s.url,{_:(new Date).getTime().toString(),ver:f.LIB_VERSION,compression:s.compression});var i=null!==(t=s.transport)&&void 0!==t?t:"fetch",a=null!==(n=null==(r=ae(Os,e=>e.transport===i))?void 0:r.method)&&void 0!==n?n:Os[0].method;if(!a)throw new Error("No available transport method");a(s)})(y({},e,{callback:t=>{var n,r;this.rateLimiter.checkForLimiting(t),t.statusCode>=400&&(null==(n=(r=this.config).on_request_error)||n.call(r,t)),null==e.callback||e.callback(t)}}))))}Fs(e){this.As?this.As.retriableRequest(e):this.Te(e)}_execute_array(e){var t,n=[],r=[],s=[];J(e,e=>{e&&(t=e[0],I(t)?s.push(e):O(e)?e.call(this):I(e)&&"alias"===t?n.push(e):I(e)&&-1!==t.indexOf("capture")&&O(this[t])?s.push(e):r.push(e))});var i=function(e,t){J(e,function(e){if(I(e[0])){var n=t;Z(e,function(e){n=n[e[0]].apply(n,e.slice(1))})}else this[e[0]].apply(this,e.slice(1))},t)};i(n,this),i(r,this),i(s,this)}Ds(){var e,t;return(null==(e=this.config.bootstrap)?void 0:e.featureFlags)&&Object.keys(null==(t=this.config.bootstrap)?void 0:t.featureFlags).length>0||!1}push(e){this._execute_array([e])}capture(e,t,n){var r;if(this.__loaded&&this.persistence&&this.sessionPersistence&&this.Os){if(this.is_capturing())if(!P(e)&&M(e)){if(this.config.opt_out_useragent_filter||!this._is_bot()){var s=null!=n&&n.skip_client_rate_limiting?void 0:this.rateLimiter.clientRateLimitContext();if(null==s||!s.isRateLimited){null!=t&&t.$current_url&&!M(null==t?void 0:t.$current_url)&&(z.error("Invalid `$current_url` property provided to `posthog.capture`. Input must be a string. Ignoring provided value."),null==t||delete t.$current_url),this.sessionPersistence.update_search_keyword(),this.config.save_campaign_params&&this.sessionPersistence.update_campaign_params(),this.config.save_referrer&&this.sessionPersistence.update_referrer_info(),(this.config.save_campaign_params||this.config.save_referrer)&&this.persistence.set_initial_person_info();var i=new Date,a=(null==n?void 0:n.timestamp)||i,o=Gt(),c={uuid:o,event:e,properties:this.calculateEventProperties(e,t||{},a,o)};s&&(c.properties.$lib_rate_limit_remaining_tokens=s.remainingTokens),(null==n?void 0:n.$set)&&(c.$set=null==n?void 0:n.$set);var l,u=this.Us(null==n?void 0:n.$set_once);if(u&&(c.$set_once=u),(c=function(e,t){return n=e,r=e=>M(e)&&!$(t)?e.slice(0,t):e,s=new Set,function e(t,n){return t!==Object(t)?r?r(t):t:s.has(t)?void 0:(s.add(t),I(t)?(i=[],J(t,t=>{i.push(e(t))})):(i={},Z(t,(t,n)=>{s.has(t)||(i[n]=e(t,n))})),i);var i}(n);var n,r,s}(c,null!=n&&n._noTruncate?null:this.config.properties_string_max_length)).timestamp=a,P(null==n?void 0:n.timestamp)||(c.properties.$event_time_override_provided=!0,c.properties.$event_time_override_system_time=i),e===ia.DISMISSED||e===ia.SENT){var d=null==t?void 0:t[aa.SURVEY_ID],h=null==t?void 0:t[aa.SURVEY_ITERATION];l={id:d,current_iteration:h},localStorage.getItem(ua(l))||localStorage.setItem(ua(l),"true"),c.$set=y({},c.$set,{[la({id:d,current_iteration:h},e===ia.SENT?"responded":"dismissed")]:!0})}var p=y({},c.properties.$set,c.$set);if(A(p)||this.setPersonPropertiesForFlags(p),!j(this.config.before_send)){var m=this.qs(c);if(!m)return;c=m}this.xs.emit("eventCaptured",c);var g={method:"POST",url:null!==(r=null==n?void 0:n._url)&&void 0!==r?r:this.requestRouter.endpointFor("api",this.analyticsDefaultEndpoint),data:c,compression:"best-available",batchKey:null==n?void 0:n._batchKey};return!this.config.request_batching||n&&(null==n||!n._batchKey)||null!=n&&n.send_instantly?this.Fs(g):this.Os.enqueue(g),c}z.critical("This capture call is ignored due to client rate limiting.")}}else z.error("No event name provided to posthog.capture")}else z.uninitializedWarning("posthog.capture")}Ye(e){return this.on("eventCaptured",t=>e(t.event,t))}calculateEventProperties(e,t,n,r,s){if(n=n||new Date,!this.persistence||!this.sessionPersistence)return t;var i=s?void 0:this.persistence.remove_event_timer(e),a=y({},t);if(a.token=this.config.token,a.$config_defaults=this.config.defaults,("always"==this.config.cookieless_mode||"on_reject"==this.config.cookieless_mode&&this.consent.isExplicitlyOptedOut())&&(a.$cookieless_mode=!0),"$snapshot"===e){var o=y({},this.persistence.properties(),this.sessionPersistence.properties());return a.distinct_id=o.distinct_id,(!M(a.distinct_id)&&!N(a.distinct_id)||R(a.distinct_id))&&z.error("Invalid distinct_id for replay event. This indicates a bug in your implementation"),a}var c,u=Hi(this.config.mask_personal_data_properties,this.config.custom_personal_data_properties);if(this.sessionManager){var{sessionId:d,windowId:h}=this.sessionManager.checkAndGetSessionAndWindowId(s,n.getTime());a.$session_id=d,a.$window_id=h}this.sessionPropsManager&&X(a,this.sessionPropsManager.getSessionProps());try{var p;this.sessionRecording&&X(a,this.sessionRecording.sdkDebugProperties),a.$sdk_debug_retry_queue_size=null==(p=this.As)?void 0:p.length}catch(e){a.$sdk_debug_error_capturing_properties=String(e)}if(this.requestRouter.region===Ra.CUSTOM&&(a.$lib_custom_api_host=this.config.api_host),c="$pageview"!==e||s?"$pageleave"!==e||s?this.pageViewManager.doEvent():this.pageViewManager.doPageLeave(n):this.pageViewManager.doPageView(n,r),a=X(a,c),"$pageview"===e&&l&&(a.title=l.title),!P(i)){var g=n.getTime()-i;a.$duration=parseFloat((g/1e3).toFixed(3))}m&&this.config.opt_out_useragent_filter&&(a.$browser_type=this._is_bot()?"bot":"browser"),(a=X({},u,this.persistence.properties(),this.sessionPersistence.properties(),a)).$is_identified=this._isIdentified(),I(this.config.property_denylist)?Z(this.config.property_denylist,function(e){delete a[e]}):z.error("Invalid value for property_denylist config: "+this.config.property_denylist+" or property_blacklist config: "+this.config.property_blacklist);var f=this.config.sanitize_properties;f&&(z.error("sanitize_properties is deprecated. Use before_send instead"),a=f(a,e));var _=this.Bs();return a.$process_person_profile=_,_&&!s&&this.Hs("_calculate_event_properties"),a}Us(e){var t;if(!this.persistence||!this.Bs())return e;if(this.ks)return e;var n=this.persistence.get_initial_props(),r=null==(t=this.sessionPropsManager)?void 0:t.getSetOnceProps(),s=X({},n,r||{},e||{}),i=this.config.sanitize_properties;return i&&(z.error("sanitize_properties is deprecated. Use before_send instead"),s=i(s,"$set_once")),this.ks=!0,A(s)?void 0:s}register(e,t){var n;null==(n=this.persistence)||n.register(e,t)}register_once(e,t,n){var r;null==(r=this.persistence)||r.register_once(e,t,n)}register_for_session(e){var t;null==(t=this.sessionPersistence)||t.register(e)}unregister(e){var t;null==(t=this.persistence)||t.unregister(e)}unregister_for_session(e){var t;null==(t=this.sessionPersistence)||t.unregister(e)}Ws(e,t){this.register({[e]:t})}getFeatureFlag(e,t){return this.featureFlags.getFeatureFlag(e,t)}getFeatureFlagPayload(e){var t=this.featureFlags.getFeatureFlagPayload(e);try{return JSON.parse(t)}catch(e){return t}}isFeatureEnabled(e,t){return this.featureFlags.isFeatureEnabled(e,t)}reloadFeatureFlags(){this.featureFlags.reloadFeatureFlags()}updateEarlyAccessFeatureEnrollment(e,t,n){this.featureFlags.updateEarlyAccessFeatureEnrollment(e,t,n)}getEarlyAccessFeatures(e,t,n){return void 0===t&&(t=!1),this.featureFlags.getEarlyAccessFeatures(e,t,n)}on(e,t){return this.xs.on(e,t)}onFeatureFlags(e){return this.featureFlags.onFeatureFlags(e)}onSurveysLoaded(e){return this.surveys.onSurveysLoaded(e)}onSessionId(e){var t,n;return null!==(t=null==(n=this.sessionManager)?void 0:n.onSessionId(e))&&void 0!==t?t:()=>{}}getSurveys(e,t){void 0===t&&(t=!1),this.surveys.getSurveys(e,t)}getActiveMatchingSurveys(e,t){void 0===t&&(t=!1),this.surveys.getActiveMatchingSurveys(e,t)}renderSurvey(e,t){this.surveys.renderSurvey(e,t)}canRenderSurvey(e){return this.surveys.canRenderSurvey(e)}canRenderSurveyAsync(e,t){return void 0===t&&(t=!1),this.surveys.canRenderSurveyAsync(e,t)}identify(e,t,n){if(!this.__loaded||!this.persistence)return z.uninitializedWarning("posthog.identify");if(N(e)&&(e=e.toString(),z.warn("The first argument to posthog.identify was a number, but it should be a string. It has been converted to a string.")),e)if(["distinct_id","distinctid"].includes(e.toLowerCase()))z.critical('The string "'+e+'" was set in posthog.identify which indicates an error. This ID should be unique to the user and not a hardcoded string.');else if(e!==Ke){if(this.Hs("posthog.identify")){var r=this.get_distinct_id();if(this.register({$user_id:e}),!this.get_property("$device_id")){var s=r;this.register_once({$had_persisted_distinct_id:!0,$device_id:s},"")}e!==r&&e!==this.get_property(le)&&(this.unregister(le),this.register({distinct_id:e}));var i="anonymous"===(this.persistence.get_property(Ue)||"anonymous");e!==r&&i?(this.persistence.set_property(Ue,"identified"),this.setPersonPropertiesForFlags(y({},n||{},t||{}),!1),this.capture("$identify",{distinct_id:e,$anon_distinct_id:r},{$set:t||{},$set_once:n||{}}),this.Ps=As(e,t,n),this.featureFlags.setAnonymousDistinctId(r)):(t||n)&&this.setPersonProperties(t,n),e!==r&&(this.reloadFeatureFlags(),this.unregister(De))}}else z.critical('The string "'+Ke+'" was set in posthog.identify which indicates an error. This ID is only used as a sentinel value.');else z.error("Unique user id has not been set in posthog.identify")}setPersonProperties(e,t){if((e||t)&&this.Hs("posthog.setPersonProperties")){var n=As(this.get_distinct_id(),e,t);this.Ps!==n?(this.setPersonPropertiesForFlags(y({},t||{},e||{})),this.capture("$set",{$set:e||{},$set_once:t||{}}),this.Ps=n):z.info("A duplicate setPersonProperties call was made with the same properties. It has been ignored.")}}group(e,t,n){if(e&&t){if(this.Hs("posthog.group")){var r=this.getGroups();r[e]!==t&&this.resetGroupPropertiesForFlags(e),this.register({$groups:y({},r,{[e]:t})}),n&&(this.capture("$groupidentify",{$group_type:e,$group_key:t,$group_set:n}),this.setGroupPropertiesForFlags({[e]:n})),r[e]===t||n||this.reloadFeatureFlags()}}else z.error("posthog.group requires a group type and group key")}resetGroups(){this.register({$groups:{}}),this.resetGroupPropertiesForFlags(),this.reloadFeatureFlags()}setPersonPropertiesForFlags(e,t){void 0===t&&(t=!0),this.featureFlags.setPersonPropertiesForFlags(e,t)}resetPersonPropertiesForFlags(){this.featureFlags.resetPersonPropertiesForFlags()}setGroupPropertiesForFlags(e,t){void 0===t&&(t=!0),this.Hs("posthog.setGroupPropertiesForFlags")&&this.featureFlags.setGroupPropertiesForFlags(e,t)}resetGroupPropertiesForFlags(e){this.featureFlags.resetGroupPropertiesForFlags(e)}reset(e){var t,n,r,s;if(z.info("reset"),!this.__loaded)return z.uninitializedWarning("posthog.reset");var i=this.get_property("$device_id");if(this.consent.reset(),null==(t=this.persistence)||t.clear(),null==(n=this.sessionPersistence)||n.clear(),this.surveys.reset(),this.featureFlags.reset(),null==(r=this.persistence)||r.set_property(Ue,"anonymous"),null==(s=this.sessionManager)||s.resetSessionId(),this.Ps=null,"always"===this.config.cookieless_mode)this.register_once({distinct_id:Ke,$device_id:null},"");else{var a=this.config.get_device_id(Gt());this.register_once({distinct_id:a,$device_id:e?a:i},"")}this.register({$last_posthog_reset:(new Date).toISOString()},1)}get_distinct_id(){return this.get_property("distinct_id")}getGroups(){return this.get_property("$groups")||{}}get_session_id(){var e,t;return null!==(e=null==(t=this.sessionManager)?void 0:t.checkAndGetSessionAndWindowId(!0).sessionId)&&void 0!==e?e:""}get_session_replay_url(e){if(!this.sessionManager)return"";var{sessionId:t,sessionStartTimestamp:n}=this.sessionManager.checkAndGetSessionAndWindowId(!0),r=this.requestRouter.endpointFor("ui","/project/"+this.config.token+"/replay/"+t);if(null!=e&&e.withTimestamp&&n){var s,i=null!==(s=e.timestampLookBack)&&void 0!==s?s:10;if(!n)return r;r+="?t="+Math.max(Math.floor(((new Date).getTime()-n)/1e3)-i,0)}return r}alias(e,t){return e===this.get_property(ce)?(z.critical("Attempting to create alias for existing People user - aborting."),-2):this.Hs("posthog.alias")?(P(t)&&(t=this.get_distinct_id()),e!==t?(this.Ws(le,e),this.capture("$create_alias",{alias:e,distinct_id:t})):(z.warn("alias matches current distinct_id - skipping api call."),this.identify(e),-1)):void 0}set_config(e){var t=y({},this.config);if(C(e)){var n,r,s,i,a;X(this.config,Va(e));var o=this.Ms();null==(n=this.persistence)||n.update_config(this.config,t,o),this.sessionPersistence="sessionStorage"===this.config.persistence||"memory"===this.config.persistence?this.persistence:new ta(y({},this.config,{persistence:"sessionStorage"}),o),Wt.G()&&"true"===Wt.V("ph_debug")&&(this.config.debug=!0),this.config.debug&&(f.DEBUG=!0,z.info("set_config",{config:e,oldConfig:t,newConfig:y({},this.config)})),null==(r=this.sessionRecording)||r.startIfEnabledOrStop(),null==(s=this.autocapture)||s.startIfEnabled(),null==(i=this.heatmaps)||i.startIfEnabled(),this.surveys.loadIfEnabled(),this.Gs(),null==(a=this.externalIntegrations)||a.startIfEnabledOrStop()}}startSessionRecording(e){var t,n,r,s,i,a=!0===e,o={sampling:a||!(null==e||!e.sampling),linked_flag:a||!(null==e||!e.linked_flag),url_trigger:a||!(null==e||!e.url_trigger),event_trigger:a||!(null==e||!e.event_trigger)};Object.values(o).some(Boolean)&&(null==(t=this.sessionManager)||t.checkAndGetSessionAndWindowId(),o.sampling&&(null==(n=this.sessionRecording)||n.overrideSampling()),o.linked_flag&&(null==(r=this.sessionRecording)||r.overrideLinkedFlag()),o.url_trigger&&(null==(s=this.sessionRecording)||s.overrideTrigger("url")),o.event_trigger&&(null==(i=this.sessionRecording)||i.overrideTrigger("event")));this.set_config({disable_session_recording:!1})}stopSessionRecording(){this.set_config({disable_session_recording:!0})}sessionRecordingStarted(){var e;return!(null==(e=this.sessionRecording)||!e.started)}captureException(e,t){var n=new Error("PostHog syntheticException");return this.exceptions.sendExceptionEvent(y({},Nn((e=>e instanceof Error)(e)?{error:e,event:e.message}:{event:e},{syntheticException:n}),t))}loadToolbar(e){return this.toolbar.loadToolbar(e)}get_property(e){var t;return null==(t=this.persistence)?void 0:t.props[e]}getSessionProperty(e){var t;return null==(t=this.sessionPersistence)?void 0:t.props[e]}toString(){var e,t=null!==(e=this.config.name)&&void 0!==e?e:qa;return t!==qa&&(t=qa+"."+t),t}_isIdentified(){var e,t;return"identified"===(null==(e=this.persistence)?void 0:e.get_property(Ue))||"identified"===(null==(t=this.sessionPersistence)?void 0:t.get_property(Ue))}Bs(){var e,t;return!("never"===this.config.person_profiles||"identified_only"===this.config.person_profiles&&!this._isIdentified()&&A(this.getGroups())&&(null==(e=this.persistence)||null==(e=e.props)||!e[le])&&(null==(t=this.persistence)||null==(t=t.props)||!t[ze]))}zs(){return!0===this.config.capture_pageleave||"if_capture_pageview"===this.config.capture_pageleave&&(!0===this.config.capture_pageview||"history_change"===this.config.capture_pageview)}createPersonProfile(){this.Bs()||this.Hs("posthog.createPersonProfile")&&this.setPersonProperties({},{})}Hs(e){return"never"===this.config.person_profiles?(z.error(e+' was called, but process_person is set to "never". This call will be ignored.'),!1):(this.Ws(ze,!0),!0)}Ms(){if("always"===this.config.cookieless_mode)return!0;var e=this.consent.isOptedOut(),t=this.config.opt_out_persistence_by_default||"on_reject"===this.config.cookieless_mode;return this.config.disable_persistence||e&&!!t}Gs(){var e,t,n,r,s=this.Ms();return(null==(e=this.persistence)?void 0:e.je)!==s&&(null==(n=this.persistence)||n.set_disabled(s)),(null==(t=this.sessionPersistence)?void 0:t.je)!==s&&(null==(r=this.sessionPersistence)||r.set_disabled(s)),s}opt_in_capturing(e){var t;"always"!==this.config.cookieless_mode?("on_reject"===this.config.cookieless_mode&&this.consent.isExplicitlyOptedOut()&&(this.reset(!0),this.sessionManager=new Ta(this),this.persistence&&(this.sessionPropsManager=new xa(this,this.sessionManager,this.persistence)),this.sessionRecording=new ss(this),this.sessionRecording.startIfEnabledOrStop()),this.consent.optInOut(!0),this.Gs(),(P(null==e?void 0:e.captureEventName)||null!=e&&e.captureEventName)&&this.capture(null!==(t=null==e?void 0:e.captureEventName)&&void 0!==t?t:"$opt_in",null==e?void 0:e.captureProperties,{send_instantly:!0}),this.config.capture_pageview&&this.Ns()):z.warn('Consent opt in/out is not valid with cookieless_mode="always" and will be ignored')}opt_out_capturing(){var e;"always"!==this.config.cookieless_mode?("on_reject"===this.config.cookieless_mode&&this.consent.isOptedIn()&&this.reset(!0),this.consent.optInOut(!1),this.Gs(),"on_reject"===this.config.cookieless_mode&&(this.register({distinct_id:Ke,$device_id:null}),this.sessionManager=void 0,this.sessionPropsManager=void 0,null==(e=this.sessionRecording)||e.stopRecording(),this.sessionRecording=void 0,this.Ns())):z.warn('Consent opt in/out is not valid with cookieless_mode="always" and will be ignored')}has_opted_in_capturing(){return this.consent.isOptedIn()}has_opted_out_capturing(){return this.consent.isOptedOut()}get_explicit_consent_status(){var e=this.consent.consent;return e===tn.GRANTED?"granted":e===tn.DENIED?"denied":"pending"}is_capturing(){return"always"===this.config.cookieless_mode||("on_reject"===this.config.cookieless_mode?this.consent.isExplicitlyOptedOut()||this.consent.isOptedIn():!this.has_opted_out_capturing())}clear_opt_in_out_capturing(){this.consent.reset(),this.Gs()}_is_bot(){return c?Ma(c,this.config.custom_blocked_useragents):void 0}Ns(){l&&("visible"===l.visibilityState?this.Es||(this.Es=!0,this.capture("$pageview",{title:l.title},{send_instantly:!0}),this.Is&&(l.removeEventListener("visibilitychange",this.Is),this.Is=null)):this.Is||(this.Is=this.Ns.bind(this),oe(l,"visibilitychange",this.Is)))}debug(e){!1===e?(null==r||r.console.log("You've disabled debug mode."),localStorage&&localStorage.removeItem("ph_debug"),this.set_config({debug:!1})):(null==r||r.console.log("You're now in debug mode. All calls to PostHog will be logged in your console.\nYou can disable this with `posthog.debug(false)`."),localStorage&&localStorage.setItem("ph_debug","true"),this.set_config({debug:!0}))}L(){var e,t,n,r,s,i,a=this.Ts||{};return"advanced_disable_flags"in a?!!a.advanced_disable_flags:!1!==this.config.advanced_disable_flags?!!this.config.advanced_disable_flags:!0===this.config.advanced_disable_decide?(z.warn("Config field 'advanced_disable_decide' is deprecated. Please use 'advanced_disable_flags' instead. The old field will be removed in a future major version."),!0):(n="advanced_disable_decide",r=z,s=(t="advanced_disable_flags")in(e=a)&&!P(e[t]),i=n in e&&!P(e[n]),s?e[t]:!!i&&(r&&r.warn("Config field '"+n+"' is deprecated. Please use '"+t+"' instead. The old field will be removed in a future major version."),e[n]))}qs(e){if(j(this.config.before_send))return e;var t=I(this.config.before_send)?this.config.before_send:[this.config.before_send],n=e;for(var r of t){if(n=r(n),j(n)){var s="Event '"+e.event+"' was rejected in beforeSend function";return D(e.event)?z.warn(s+". This can cause unexpected behavior."):z.info(s),null}n.properties&&!A(n.properties)||z.warn("Event '"+e.event+"' has no properties after beforeSend function, this is likely an error.")}return n}getPageViewId(){var e;return null==(e=this.pageViewManager.pe)?void 0:e.pageViewId}captureTraceFeedback(e,t){this.capture("$ai_feedback",{$ai_trace_id:String(e),$ai_feedback_text:t})}captureTraceMetric(e,t,n){this.capture("$ai_metric",{$ai_trace_id:String(e),$ai_metric_name:t,$ai_metric_value:String(n)})}}!function(e,t){for(var n=0;n<t.length;n++)e.prototype[t[n]]=ne(e.prototype[t[n]])}(Za,["identify"]);var Xa,Qa=(Xa=Ha[qa]=new Za,function(){function e(){e.done||(e.done=!0,Ka=!1,Z(Ha,function(e){e._dom_loaded()}))}null!=l&&l.addEventListener?"complete"===l.readyState?e():oe(l,"DOMContentLoaded",e,{capture:!1}):r&&z.error("Browser doesn't support `document.addEventListener` so PostHog couldn't be initialized")}(),Xa)},5571:(e,t,n)=>{"use strict";const r=n(7075);e.exports=(e,t,n)=>r(e,t,">",n)},5580:(e,t,n)=>{"use strict";const r=n(560);e.exports=(e,t,n)=>r(e,t,n)>0},5616:(e,t,n)=>{"use strict";n.d(t,{G:()=>i,eq:()=>s});var r=n(9115);const s=r.ZS.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class i extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const s of e.issues)if("invalid_union"===s.code)s.unionErrors.map(r);else if("invalid_return_type"===s.code)r(s.returnTypeError);else if("invalid_arguments"===s.code)r(s.argumentsError);else if(0===s.path.length)n._errors.push(t(s));else{let e=n,r=0;for(;r<s.path.length;){const n=s.path[r];r===s.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(s))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof i))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,r.ZS.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const r of this.issues)if(r.path.length>0){const n=r.path[0];t[n]=t[n]||[],t[n].push(e(r))}else n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}i.create=e=>new i(e)},5617:(e,t,n)=>{e.exports=n(8303)},5721:(e,t,n)=>{"use strict";n.d(t,{T:()=>l,k:()=>c});var r=n(7265),s=n(6792),i=n(3490),a=n(6362),o=n(8028);class c extends s.mJ{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class l extends c{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const s of e){if("string"!=typeof s&&"string"!=typeof s.content)throw new Error("Cannot handle non-string output.");let e;if((0,i.AJ)(s)){if("string"!=typeof s.content)throw new Error("Cannot handle non-string message output.");e=new o.Cf({message:s,text:s.content})}else if((0,i.ny)(s)){if("string"!=typeof s.content)throw new Error("Cannot handle non-string message output.");e=new o.Cf({message:(0,a.ih)(s),text:s.content})}else e=new o.mu({text:s});n=void 0===n?e:n.concat(e);const c=await this.parsePartialResult([n]);null==c||(0,r.rA)(c,t)||(this.diff?yield this._diff(t,c):yield c,t=c)}}getFormatInstructions(){return""}}},5732:(e,t,n)=>{"use strict";n.d(t,{Bz:()=>d,ah:()=>h,co:()=>c,es:()=>l});var r=n(2080);const s=r.k5(["vibebrowser","openai","openai_compatible","anthropic","google_gemini","ollama","openrouter","custom"]),i=r.Ik({supportsImages:r.zM().optional()}),a=r.Ik({contextWindow:r.KC([r.ai(),r.Yj()]).transform(e=>"string"==typeof e?parseInt(e,10):e).optional(),temperature:r.KC([r.ai(),r.Yj()]).transform(e=>"string"==typeof e?parseFloat(e):e).pipe(r.ai().min(0).max(2)).optional()}),o=r.Ik({id:r.Yj(),name:r.Yj(),type:s,isDefault:r.zM(),isBuiltIn:r.zM(),baseUrl:r.Yj().optional(),apiKey:r.Yj().optional(),modelId:r.Yj().optional(),capabilities:i.optional(),modelConfig:a.optional(),createdAt:r.Yj(),updatedAt:r.Yj()}),c=r.Ik({defaultProviderId:r.Yj(),providers:r.YO(o)}),l=(r.Ik({key:r.Yj(),type:r.Yj(),value:r.bz()}),{PROVIDERS:"vibebrowser.providers"}),u="vibebrowser";function d(){const e=(new Date).toISOString();return{id:u,name:"VibeBrowser",type:"vibebrowser",isDefault:!0,isBuiltIn:!0,createdAt:e,updatedAt:e}}function h(){const e=d();return{defaultProviderId:e.id,providers:[e]}}},5784:e=>{"use strict";var t,n=Object.defineProperty,r=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};((e,t)=>{for(var r in t)n(e,r,{get:t[r],enumerable:!0})})(a,{SYMBOL_FOR_REQ_CONTEXT:()=>o,getContext:()=>c}),e.exports=(t=a,((e,t,a,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let c of s(t))i.call(e,c)||c===a||n(e,c,{get:()=>t[c],enumerable:!(o=r(t,c))||o.enumerable});return e})(n({},"__esModule",{value:!0}),t));const o=Symbol.for("@vercel/request-context");function c(){const e=globalThis;return e[o]?.get?.()??{}}},5787:(e,t,n)=>{"use strict";n.d(t,{qG:()=>i});var r=n(3292),s=n(7942);function i(e){return function(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&((0,s.c9)(e.schema)||null!=e.schema&&"object"==typeof e.schema&&"type"in e.schema&&"string"==typeof e.schema.type&&["null","boolean","object","array","number","string"].includes(e.schema.type))}(e)||function(e){return void 0!==e&&r.YN.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}(e)||function(e){return void 0!==e&&Array.isArray(e.lc_namespace)}(e)}},5960:(e,t,n)=>{"use strict";n.d(t,{NK:()=>c,xL:()=>o,zr:()=>l});var r=n(9120),s=n(8999),i=n(9583);class a{}function o(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}class c extends a{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,(0,s.Z)(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"false"===(0,i.Az)("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return s.y.prototype.toJSON.call(this)}toJSONNotImplemented(){return s.y.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends c{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:r.A()}),Object.assign(this,e)}}}}const l=e=>{const t=e;return void 0!==t&&"function"==typeof t.copy&&"string"==typeof t.name&&"boolean"==typeof t.awaitHandlers}},6150:(e,t,n)=>{"use strict";n.d(t,{X6:()=>w,UD:()=>T});var r={};n.r(r),n.d(r,{JsonPatchError:()=>m,_areEquals:()=>x,applyOperation:()=>b,applyPatch:()=>w,applyReducer:()=>v,deepClone:()=>g,getValueByPointer:()=>_,validate:()=>S,validator:()=>E});const s=Object.prototype.hasOwnProperty;function i(e,t){return s.call(e,t)}function a(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)i(e,n)&&t.push(n);return t}function o(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function c(e){let t=0;const n=e.length;let r;for(;t<n;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function l(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function u(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function d(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(d(e[t]))return!0}else if("object"==typeof e){const n=a(e),r=n.length;for(var t=0;t<r;t++)if(d(e[n[t]]))return!0}return!1}function h(e,t){const n=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&n.push(`${e}: ${r}`)}return n.join("\n")}class p extends Error{constructor(e,t,n,r,s){super(h(e,{name:t,index:n,operation:r,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=h(e,{name:t,index:n,operation:r,tree:s})}}const m=p,g=o,f={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=_(n,this.path);r&&(r=o(r));const s=b(n,{op:"remove",path:this.from}).removed;return b(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=_(n,this.from);return b(n,{op:"add",path:this.path,value:o(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:x(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};var y={add:function(e,t,n){return c(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:f.move,copy:f.copy,test:f.test,_get:f._get};function _(e,t){if(""==t)return e;var n={op:"_get",path:t};return b(e,n),n.value}function b(e,t,n=!1,r=!0,s=!0,i=0){if(n&&("function"==typeof n?n(t,0,e,t.path):E(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=_(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=x(e,t.value),!1===r.test)throw new m("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new m("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return r}{r||(e=o(e));const a=(t.path||"").split("/");let l,d,h,p=e,g=1,_=a.length;for(h="function"==typeof n?n:E;;){if(d=a[g],d&&-1!=d.indexOf("~")&&(d=u(d)),s&&("__proto__"==d||"prototype"==d&&g>0&&"constructor"==a[g-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===l&&(void 0===p[d]?l=a.slice(0,g).join("/"):g==_-1&&(l=t.path),void 0!==l&&h(t,0,e,l)),g++,Array.isArray(p)){if("-"===d)d=p.length;else{if(n&&!c(d))throw new m("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);c(d)&&(d=~~d)}if(g>=_){if(n&&"add"===t.op&&d>p.length)throw new m("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const r=y[t.op].call(t,p,d,e);if(!1===r.test)throw new m("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}}else if(g>=_){const n=f[t.op].call(t,p,d,e);if(!1===n.test)throw new m("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return n}if(p=p[d],n&&g<_&&(!p||"object"!=typeof p))throw new m("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function w(e,t,n,r=!0,s=!0){if(n&&!Array.isArray(t))throw new m("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=o(e));const i=new Array(t.length);for(let r=0,a=t.length;r<a;r++)i[r]=b(e,t[r],n,!0,s,r),e=i[r].newDocument;return i.newDocument=e,i}function v(e,t,n){const r=b(e,t);if(!1===r.test)throw new m("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function E(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new m("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!f[e.op])throw new m("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new m("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new m('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new m("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new m("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&d(e.value))throw new m("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var s=e.path.split("/").length,i=r.split("/").length;if(s!==i+1&&s!==i)throw new m("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new m("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var a=S([{op:"_get",path:e.from,value:void 0}],n);if(a&&"OPERATION_PATH_UNRESOLVABLE"===a.name)throw new m("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function S(e,t,n){try{if(!Array.isArray(e))throw new m("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)w(o(t),o(e),n||!0);else{n=n||E;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof m)return e;throw e}}function x(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,r,s,i=Array.isArray(e),a=Array.isArray(t);if(i&&a){if((r=e.length)!=t.length)return!1;for(n=r;0!==n--;)if(!x(e[n],t[n]))return!1;return!0}if(i!=a)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(n=r;0!==n--;)if(!t.hasOwnProperty(o[n]))return!1;for(n=r;0!==n--;)if(!x(e[s=o[n]],t[s]))return!1;return!0}return e!=e&&t!=t}new WeakMap;function k(e,t,n,r,s){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var c=a(t),u=a(e),d=!1,h=u.length-1;h>=0;h--){var p=e[g=u[h]];if(!i(t,g)||void 0===t[g]&&void 0!==p&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(s&&n.push({op:"test",path:r+"/"+l(g),value:o(p)}),n.push({op:"remove",path:r+"/"+l(g)}),d=!0):(s&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}),!0);else{var m=t[g];"object"==typeof p&&null!=p&&"object"==typeof m&&null!=m&&Array.isArray(p)===Array.isArray(m)?k(p,m,n,r+"/"+l(g),s):p!==m&&(s&&n.push({op:"test",path:r+"/"+l(g),value:o(p)}),n.push({op:"replace",path:r+"/"+l(g),value:o(m)}))}}if(d||c.length!=u.length)for(h=0;h<c.length;h++){var g;i(e,g=c[h])||void 0===t[g]||n.push({op:"add",path:r+"/"+l(g),value:o(t[g])})}}}function T(e,t,n=!1){var r=[];return k(e,t,r,"",n),r}},6170:(e,t,n)=>{"use strict";const r=n(3908),s=n(144),{safeRe:i,t:a}=n(9718);e.exports=(e,t)=>{if(e instanceof r)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let n=null;if((t=t||{}).rtl){const r=t.includePrerelease?i[a.COERCERTLFULL]:i[a.COERCERTL];let s;for(;(s=r.exec(e))&&(!n||n.index+n[0].length!==e.length);)n&&s.index+s[0].length===n.index+n[0].length||(n=s),r.lastIndex=s.index+s[1].length+s[2].length;r.lastIndex=-1}else n=e.match(t.includePrerelease?i[a.COERCEFULL]:i[a.COERCE]);if(null===n)return null;const o=n[2],c=n[3]||"0",l=n[4]||"0",u=t.includePrerelease&&n[5]?`-${n[5]}`:"",d=t.includePrerelease&&n[6]?`+${n[6]}`:"";return s(`${o}.${c}.${l}${u}${d}`,t)}},6232:(e,t,n)=>{"use strict";n.d(t,{m:()=>s});const r={};function s(e){r[e]||(r[e]=!0)}},6254:(e,t,n)=>{"use strict";const r=n(3908);e.exports=(e,t)=>new r(e,t).minor},6362:(e,t,n)=>{"use strict";n.d(t,{K0:()=>m,Sw:()=>g,ih:()=>f});var r=n(1368),s=n(199),i=n(7765),a=n(3490),o=n(4301),c=n(8675),l=n(5454),u=n(7974),d=n(8009);function h(e){return(0,s.Ky)(e)?e:"string"==typeof e.id&&"function"===e.type&&"object"==typeof e.function&&null!==e.function&&"arguments"in e.function&&"string"==typeof e.function.arguments&&"name"in e.function&&"string"==typeof e.function.name?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function p(e){let t,n;if("object"==typeof(s=e)&&null!=s&&1===s.lc&&Array.isArray(s.id)&&null!=s.kwargs&&"object"==typeof s.kwargs){const r=e.id.at(-1);t="HumanMessage"===r||"HumanMessageChunk"===r?"user":"AIMessage"===r||"AIMessageChunk"===r?"assistant":"SystemMessage"===r||"SystemMessageChunk"===r?"system":"FunctionMessage"===r||"FunctionMessageChunk"===r?"function":"ToolMessage"===r||"ToolMessageChunk"===r?"tool":"unknown",n=e.kwargs}else{const{type:r,...s}=e;t=r,n=s}var s;if("human"===t||"user"===t)return new l.xc(n);if("ai"===t||"assistant"===t){const{tool_calls:e,...t}=n;if(!Array.isArray(e))return new i.Od(n);const r=e.map(h);return new i.Od({...t,tool_calls:r})}if("system"===t)return new u.tn(n);if("developer"===t)return new u.tn({...n,additional_kwargs:{...n.additional_kwargs,__openai_role__:"developer"}});if("tool"===t&&"tool_call_id"in n)return new d.uf({...n,content:n.content,tool_call_id:n.tool_call_id,name:n.name});throw(0,r.Y)(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.\n\nReceived: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}function m(e){if("string"==typeof e)return new l.xc(e);if((0,a.ny)(e))return e;if(Array.isArray(e)){const[t,n]=e;return p({type:t,content:n})}if((0,a.dp)(e)){const{role:t,...n}=e;return p({...n,type:t})}return p(e)}function g(e,t="Human",n="AI"){const r=[];for(const s of e){let e;if("human"===s._getType())e=t;else if("ai"===s._getType())e=n;else if("system"===s._getType())e="System";else if("function"===s._getType())e="Function";else if("tool"===s._getType())e="Tool";else{if("generic"!==s._getType())throw new Error(`Got unsupported message type: ${s._getType()}`);e=s.role}const i=s.name?`${s.name}, `:"",a="string"==typeof s.content?s.content:JSON.stringify(s.content,null,2);r.push(`${e}: ${i}${a}`)}return r.join("\n")}function f(e){const t=e._getType();if("human"===t)return new l.a7({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)}))}),new i.H({...t})}if("system"===t)return new u.uU({...e});if("function"===t)return new c.FK({...e});if(o.cM.isInstance(e))return new o.XU({...e});throw new Error("Unknown message type.")}},6615:(e,t,n)=>{"use strict";n.d(t,{PF:()=>r.PF});var r=n(7671)},6641:(e,t,n)=>{"use strict";const r=n(4617);class s extends Error{constructor(e){super(e),this.name="TimeoutError"}}const i=(e,t,n)=>new Promise((i,a)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void i(e);const o=setTimeout(()=>{if("function"==typeof n){try{i(n())}catch(e){a(e)}return}const r=n instanceof Error?n:new s("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),a(r)},t);r(e.then(i,a),()=>{clearTimeout(o)})});e.exports=i,e.exports.default=i,e.exports.TimeoutError=s},6739:(e,t,n)=>{"use strict";var r,s,i;n.d(t,{ChatGoogleGenerativeAI:()=>we}),function(e){e.STRING="string",e.NUMBER="number",e.INTEGER="integer",e.BOOLEAN="boolean",e.ARRAY="array",e.OBJECT="object"}(r||(r={})),function(e){e.LANGUAGE_UNSPECIFIED="language_unspecified",e.PYTHON="python"}(s||(s={})),function(e){e.OUTCOME_UNSPECIFIED="outcome_unspecified",e.OUTCOME_OK="outcome_ok",e.OUTCOME_FAILED="outcome_failed",e.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"}(i||(i={}));const a=["user","model","function","system"];var o,c,l,u,d,h,p,m;!function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",e.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"}(o||(o={})),function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"}(c||(c={})),function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"}(l||(l={})),function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"}(u||(u={})),function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.LANGUAGE="LANGUAGE",e.BLOCKLIST="BLOCKLIST",e.PROHIBITED_CONTENT="PROHIBITED_CONTENT",e.SPII="SPII",e.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",e.OTHER="OTHER"}(d||(d={})),function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"}(h||(h={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.AUTO="AUTO",e.ANY="ANY",e.NONE="NONE"}(p||(p={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.MODE_DYNAMIC="MODE_DYNAMIC"}(m||(m={}));class g extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class f extends g{constructor(e,t){super(e),this.response=t}}class y extends g{constructor(e,t,n,r){super(e),this.status=t,this.statusText=n,this.errorDetails=r}}class _ extends g{}class b extends g{}var w;!function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"}(w||(w={}));class v{constructor(e,t,n,r,s){this.model=e,this.task=t,this.apiKey=n,this.stream=r,this.requestOptions=s}toString(){var e,t;const n=(null===(e=this.requestOptions)||void 0===e?void 0:e.apiVersion)||"v1beta";let r=`${(null===(t=this.requestOptions)||void 0===t?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com"}/${n}/${this.model}:${this.task}`;return this.stream&&(r+="?alt=sse"),r}}async function E(e){var t;const n=new Headers;n.append("Content-Type","application/json"),n.append("x-goog-api-client",function(e){const t=[];return(null==e?void 0:e.apiClient)&&t.push(e.apiClient),t.push("genai-js/0.24.1"),t.join(" ")}(e.requestOptions)),n.append("x-goog-api-key",e.apiKey);let r=null===(t=e.requestOptions)||void 0===t?void 0:t.customHeaders;if(r){if(!(r instanceof Headers))try{r=new Headers(r)}catch(e){throw new _(`unable to convert customHeaders value ${JSON.stringify(r)} to Headers: ${e.message}`)}for(const[e,t]of r.entries()){if("x-goog-api-key"===e)throw new _(`Cannot set reserved header name ${e}`);if("x-goog-api-client"===e)throw new _(`Header name ${e} can only be set using the apiClient field`);n.append(e,t)}}return n}async function S(e,t,n,r,s,i={},a=fetch){const{url:o,fetchOptions:c}=await async function(e,t,n,r,s,i){const a=new v(e,t,n,r,i);return{url:a.toString(),fetchOptions:Object.assign(Object.assign({},x(i)),{method:"POST",headers:await E(a),body:s})}}(e,t,n,r,s,i);return async function(e,t,n=fetch){let r;try{r=await n(e,t)}catch(t){!function(e,t){let n=e;"AbortError"===n.name?(n=new b(`Request aborted when fetching ${t.toString()}: ${e.message}`),n.stack=e.stack):e instanceof y||e instanceof _||(n=new g(`Error fetching from ${t.toString()}: ${e.message}`),n.stack=e.stack);throw n}(t,e)}r.ok||await async function(e,t){let n,r="";try{const t=await e.json();r=t.error.message,t.error.details&&(r+=` ${JSON.stringify(t.error.details)}`,n=t.error.details)}catch(e){}throw new y(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${r}`,e.status,e.statusText,n)}(r,e);return r}(o,c,a)}function x(e){const t={};if(void 0!==(null==e?void 0:e.signal)||(null==e?void 0:e.timeout)>=0){const n=new AbortController;(null==e?void 0:e.timeout)>=0&&setTimeout(()=>n.abort(),e.timeout),(null==e?void 0:e.signal)&&e.signal.addEventListener("abort",()=>{n.abort()}),t.signal=n.signal}return t}function k(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length,O(e.candidates[0]))throw new f(`${C(e)}`,e);return function(e){var t,n,r,s;const i=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(s=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===s?void 0:s.parts)t.text&&i.push(t.text),t.executableCode&&i.push("\n```"+t.executableCode.language+"\n"+t.executableCode.code+"\n```\n"),t.codeExecutionResult&&i.push("\n```\n"+t.codeExecutionResult.output+"\n```\n");return i.length>0?i.join(""):""}(e)}if(e.promptFeedback)throw new f(`Text not available. ${C(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length,O(e.candidates[0]))throw new f(`${C(e)}`,e);return T(e)[0]}if(e.promptFeedback)throw new f(`Function call not available. ${C(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length,O(e.candidates[0]))throw new f(`${C(e)}`,e);return T(e)}if(e.promptFeedback)throw new f(`Function call not available. ${C(e)}`,e)},e}function T(e){var t,n,r,s;const i=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(s=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===s?void 0:s.parts)t.functionCall&&i.push(t.functionCall);return i.length>0?i:void 0}const I=[d.RECITATION,d.SAFETY,d.LANGUAGE];function O(e){return!!e.finishReason&&I.includes(e.finishReason)}function C(e){var t,n,r;let s="";if(e.candidates&&0!==e.candidates.length||!e.promptFeedback){if(null===(r=e.candidates)||void 0===r?void 0:r[0]){const t=e.candidates[0];O(t)&&(s+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(s+=`: ${t.finishMessage}`))}}else s+="Response was blocked",(null===(t=e.promptFeedback)||void 0===t?void 0:t.blockReason)&&(s+=` due to ${e.promptFeedback.blockReason}`),(null===(n=e.promptFeedback)||void 0===n?void 0:n.blockReasonMessage)&&(s+=`: ${e.promptFeedback.blockReasonMessage}`);return s}function A(e){return this instanceof A?(this.v=e,this):new A(e)}function P(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(e,t||[]),i=[];return r={},a("next"),a("throw"),a("return"),r[Symbol.asyncIterator]=function(){return this},r;function a(e){s[e]&&(r[e]=function(t){return new Promise(function(n,r){i.push([e,t,n,r])>1||o(e,t)})})}function o(e,t){try{(n=s[e](t)).value instanceof A?Promise.resolve(n.value.v).then(c,l):u(i[0][2],n)}catch(e){u(i[0][3],e)}var n}function c(e){o("next",e)}function l(e){o("throw",e)}function u(e,t){e(t),i.shift(),i.length&&o(i[0][0],i[0][1])}}"function"==typeof SuppressedError&&SuppressedError;const M=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function R(e){const t=function(e){const t=e.getReader();return new ReadableStream({start(e){let n="";return r();function r(){return t.read().then(({value:t,done:s})=>{if(s)return n.trim()?void e.error(new g("Failed to parse stream")):void e.close();n+=t;let i,a=n.match(M);for(;a;){try{i=JSON.parse(a[1])}catch(t){return void e.error(new g(`Error parsing JSON response: "${a[1]}"`))}e.enqueue(i),n=n.substring(a[0].length),a=n.match(M)}return r()}).catch(e=>{let t=e;throw t.stack=e.stack,t="AbortError"===t.name?new b("Request aborted when reading from the stream"):new g("Error reading from the stream"),t})}}})}(e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))),[n,r]=t.tee();return{stream:j(n),response:$(r)}}async function $(e){const t=[],n=e.getReader();for(;;){const{done:e,value:r}=await n.read();if(e)return k(N(t));t.push(r)}}function j(e){return P(this,arguments,function*(){const t=e.getReader();for(;;){const{value:e,done:n}=yield A(t.read());if(n)break;yield yield A(k(e))}})}function N(e){const t=e[e.length-1],n={promptFeedback:null==t?void 0:t.promptFeedback};for(const t of e){if(t.candidates){let e=0;for(const r of t.candidates)if(n.candidates||(n.candidates=[]),n.candidates[e]||(n.candidates[e]={index:e}),n.candidates[e].citationMetadata=r.citationMetadata,n.candidates[e].groundingMetadata=r.groundingMetadata,n.candidates[e].finishReason=r.finishReason,n.candidates[e].finishMessage=r.finishMessage,n.candidates[e].safetyRatings=r.safetyRatings,r.content&&r.content.parts){n.candidates[e].content||(n.candidates[e].content={role:r.content.role||"user",parts:[]});const t={};for(const s of r.content.parts)s.text&&(t.text=s.text),s.functionCall&&(t.functionCall=s.functionCall),s.executableCode&&(t.executableCode=s.executableCode),s.codeExecutionResult&&(t.codeExecutionResult=s.codeExecutionResult),0===Object.keys(t).length&&(t.text=""),n.candidates[e].content.parts.push(t)}e++}t.usageMetadata&&(n.usageMetadata=t.usageMetadata)}return n}async function L(e,t,n,r){return R(await S(t,w.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),r))}async function D(e,t,n,r){const s=await S(t,w.GENERATE_CONTENT,e,!1,JSON.stringify(n),r);return{response:k(await s.json())}}function U(e){if(null!=e)return"string"==typeof e?{role:"system",parts:[{text:e}]}:e.text?{role:"system",parts:[e]}:e.parts?e.role?e:{role:"system",parts:e.parts}:void 0}function F(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(const n of e)"string"==typeof n?t.push({text:n}):t.push(n);return function(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let r=!1,s=!1;for(const i of e)"functionResponse"in i?(n.parts.push(i),s=!0):(t.parts.push(i),r=!0);if(r&&s)throw new g("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!s)throw new g("No content is provided for sending chat message.");if(r)return t;return n}(t)}function Y(e){let t;if(e.contents)t=e;else{t={contents:[F(e)]}}return e.systemInstruction&&(t.systemInstruction=U(e.systemInstruction)),t}const G=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],B={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function H(e){var t;if(void 0===e.candidates||0===e.candidates.length)return!1;const n=null===(t=e.candidates[0])||void 0===t?void 0:t.content;if(void 0===n)return!1;if(void 0===n.parts||0===n.parts.length)return!1;for(const e of n.parts){if(void 0===e||0===Object.keys(e).length)return!1;if(void 0!==e.text&&""===e.text)return!1}return!0}const z="SILENT_ERROR";class q{constructor(e,t,n,r={}){this.model=t,this.params=n,this._requestOptions=r,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==n?void 0:n.history)&&(!function(e){let t=!1;for(const n of e){const{role:e,parts:r}=n;if(!t&&"user"!==e)throw new g(`First content should be with role 'user', got ${e}`);if(!a.includes(e))throw new g(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(a)}`);if(!Array.isArray(r))throw new g("Content should have 'parts' property with an array of Parts");if(0===r.length)throw new g("Each Content should have at least one part");const s={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const e of r)for(const t of G)t in e&&(s[t]+=1);const i=B[e];for(const t of G)if(!i.includes(t)&&s[t]>0)throw new g(`Content with role '${e}' can't contain '${t}' part`);t=!0}}(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var n,r,s,i,a,o;await this._sendPromise;const c=F(e),l={safetySettings:null===(n=this.params)||void 0===n?void 0:n.safetySettings,generationConfig:null===(r=this.params)||void 0===r?void 0:r.generationConfig,tools:null===(s=this.params)||void 0===s?void 0:s.tools,toolConfig:null===(i=this.params)||void 0===i?void 0:i.toolConfig,systemInstruction:null===(a=this.params)||void 0===a?void 0:a.systemInstruction,cachedContent:null===(o=this.params)||void 0===o?void 0:o.cachedContent,contents:[...this._history,c]},u=Object.assign(Object.assign({},this._requestOptions),t);let d;return this._sendPromise=this._sendPromise.then(()=>D(this._apiKey,this.model,l,u)).then(e=>{var t;if(H(e.response)){this._history.push(c);const n=Object.assign({parts:[],role:"model"},null===(t=e.response.candidates)||void 0===t?void 0:t[0].content);this._history.push(n)}else{C(e.response)}d=e}).catch(e=>{throw this._sendPromise=Promise.resolve(),e}),await this._sendPromise,d}async sendMessageStream(e,t={}){var n,r,s,i,a,o;await this._sendPromise;const c=F(e),l={safetySettings:null===(n=this.params)||void 0===n?void 0:n.safetySettings,generationConfig:null===(r=this.params)||void 0===r?void 0:r.generationConfig,tools:null===(s=this.params)||void 0===s?void 0:s.tools,toolConfig:null===(i=this.params)||void 0===i?void 0:i.toolConfig,systemInstruction:null===(a=this.params)||void 0===a?void 0:a.systemInstruction,cachedContent:null===(o=this.params)||void 0===o?void 0:o.cachedContent,contents:[...this._history,c]},u=Object.assign(Object.assign({},this._requestOptions),t),d=L(this._apiKey,this.model,l,u);return this._sendPromise=this._sendPromise.then(()=>d).catch(e=>{throw new Error(z)}).then(e=>e.response).then(e=>{if(H(e)){this._history.push(c);const t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{C(e)}}).catch(e=>{e.message}),d}}class K{constructor(e,t,n={}){this.apiKey=e,this._requestOptions=n,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=U(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var n;const r=Y(e),s=Object.assign(Object.assign({},this._requestOptions),t);return D(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(n=this.cachedContent)||void 0===n?void 0:n.name},r),s)}async generateContentStream(e,t={}){var n;const r=Y(e),s=Object.assign(Object.assign({},this._requestOptions),t);return L(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(n=this.cachedContent)||void 0===n?void 0:n.name},r),s)}startChat(e){var t;return new q(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(t=this.cachedContent)||void 0===t?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){const n=function(e,t){var n;let r={model:null==t?void 0:t.model,generationConfig:null==t?void 0:t.generationConfig,safetySettings:null==t?void 0:t.safetySettings,tools:null==t?void 0:t.tools,toolConfig:null==t?void 0:t.toolConfig,systemInstruction:null==t?void 0:t.systemInstruction,cachedContent:null===(n=null==t?void 0:t.cachedContent)||void 0===n?void 0:n.name,contents:[]};const s=null!=e.generateContentRequest;if(e.contents){if(s)throw new _("CountTokensRequest must have one of contents or generateContentRequest, not both.");r.contents=e.contents}else if(s)r=Object.assign(Object.assign({},r),e.generateContentRequest);else{const t=F(e);r.contents=[t]}return{generateContentRequest:r}}(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),r=Object.assign(Object.assign({},this._requestOptions),t);return async function(e,t,n,r){return(await S(t,w.COUNT_TOKENS,e,!1,JSON.stringify(n),r)).json()}(this.apiKey,this.model,n,r)}async embedContent(e,t={}){const n=function(e){if("string"==typeof e||Array.isArray(e))return{content:F(e)};return e}(e),r=Object.assign(Object.assign({},this._requestOptions),t);return async function(e,t,n,r){return(await S(t,w.EMBED_CONTENT,e,!1,JSON.stringify(n),r)).json()}(this.apiKey,this.model,n,r)}async batchEmbedContents(e,t={}){const n=Object.assign(Object.assign({},this._requestOptions),t);return async function(e,t,n,r){const s=n.requests.map(e=>Object.assign(Object.assign({},e),{model:t}));return(await S(t,w.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:s}),r)).json()}(this.apiKey,this.model,e,n)}}class W{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new g("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new K(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,n){if(!e.name)throw new _("Cached content must contain a `name` field.");if(!e.model)throw new _("Cached content must contain a `model` field.");const r=["model","systemInstruction"];for(const n of r)if((null==t?void 0:t[n])&&e[n]&&(null==t?void 0:t[n])!==e[n]){if("model"===n){if((t.model.startsWith("models/")?t.model.replace("models/",""):t.model)===(e.model.startsWith("models/")?e.model.replace("models/",""):e.model))continue}throw new _(`Different value for "${n}" specified in modelParams (${t[n]}) and cachedContent (${e[n]})`)}const s=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new K(this.apiKey,s,n)}}var V=n(9583),J=n(1830),Z=n(8687),X=n(7942),Q=n(8557),ee=n(6615);function te(e){if("object"==typeof e&&null!==e){const t={...e};"additionalProperties"in t&&delete t.additionalProperties,"$schema"in t&&delete t.$schema,"strict"in t&&delete t.strict;for(const e in t)e in t&&(Array.isArray(t[e])?t[e]=t[e].map(te):"object"==typeof t[e]&&null!==t[e]&&(t[e]=te(t[e])));return t}return e}function ne(e){const t=te((0,X.c9)(e)?(0,ee.PF)(e):e),{$schema:n,...r}=t;return r}function re(e){const t=te(e),{$schema:n,...r}=t;return r}var se=n(9497),ie=n(3279),ae=n(194),oe=n(2778);const ce={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let le;const ue=new Uint8Array(16);const de=[];for(let e=0;e<256;++e)de.push((e+256).toString(16).slice(1));function he(e,t=0){return(de[e[t+0]]+de[e[t+1]]+de[e[t+2]]+de[e[t+3]]+"-"+de[e[t+4]]+de[e[t+5]]+"-"+de[e[t+6]]+de[e[t+7]]+"-"+de[e[t+8]]+de[e[t+9]]+"-"+de[e[t+10]]+de[e[t+11]]+de[e[t+12]]+de[e[t+13]]+de[e[t+14]]+de[e[t+15]]).toLowerCase()}const pe=function(e,t,n){if(ce.randomUUID&&!t&&!e)return ce.randomUUID();const r=(e=e||{}).random??e.rng?.()??function(){if(!le){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");le=crypto.getRandomValues.bind(crypto)}return le(ue)}();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){if((n=n||0)<0||n+16>t.length)throw new RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[n+e]=r[e];return t}return he(r)};function me(e,t){if((0,se.Fz)(e))return(0,se.up)(e,function(e){return{providerName:"Google Gemini",fromStandardTextBlock:e=>({text:e.text}),fromStandardImageBlock(t){if(!e)throw new Error("This model does not support images");if("url"===t.source_type){const e=(0,se.Q7)({dataUrl:t.url});return e?{inlineData:{mimeType:e.mime_type,data:e.data}}:{fileData:{mimeType:t.mime_type??"",fileUri:t.url}}}if("base64"===t.source_type)return{inlineData:{mimeType:t.mime_type??"",data:t.data}};throw new Error(`Unsupported source type: ${t.source_type}`)},fromStandardAudioBlock(t){if(!e)throw new Error("This model does not support audio");if("url"===t.source_type){const e=(0,se.Q7)({dataUrl:t.url});return e?{inlineData:{mimeType:e.mime_type,data:e.data}}:{fileData:{mimeType:t.mime_type??"",fileUri:t.url}}}if("base64"===t.source_type)return{inlineData:{mimeType:t.mime_type??"",data:t.data}};throw new Error(`Unsupported source type: ${t.source_type}`)},fromStandardFileBlock(t){if(!e)throw new Error("This model does not support files");if("text"===t.source_type)return{text:t.text};if("url"===t.source_type){const e=(0,se.Q7)({dataUrl:t.url});return e?{inlineData:{mimeType:e.mime_type,data:e.data}}:{fileData:{mimeType:t.mime_type??"",fileUri:t.url}}}if("base64"===t.source_type)return{inlineData:{mimeType:t.mime_type??"",data:t.data}};throw new Error(`Unsupported source type: ${t.source_type}`)}}}(t));if("text"===e.type)return{text:e.text};if("executableCode"===e.type)return{executableCode:e.executableCode};if("codeExecutionResult"===e.type)return{codeExecutionResult:e.codeExecutionResult};if("image_url"===e.type){if(!t)throw new Error("This model does not support images");let n;if("string"==typeof e.image_url)n=e.image_url;else{if("object"!=typeof e.image_url||!("url"in e.image_url))throw new Error("Please provide image as base64 encoded data URL");n=e.image_url.url}const[r,s]=n.split(",");if(!r.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");const[i,a]=r.replace(/^data:/,"").split(";");if("base64"!==a)throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:s,mimeType:i}}}if("media"===e.type)return function(e){if("mimeType"in e&&"data"in e)return{inlineData:{mimeType:e.mimeType,data:e.data}};if("mimeType"in e&&"fileUri"in e)return{fileData:{mimeType:e.mimeType,fileUri:e.fileUri}};throw new Error("Invalid media content")}(e);if("tool_use"===e.type)return{functionCall:{name:e.name,args:e.input}};if(e.type?.includes("/")&&2===e.type.split("/").length&&"data"in e&&"string"==typeof e.data)return{inlineData:{mimeType:e.type,data:e.data}};if(!("functionCall"in e))throw"type"in e?new Error(`Unknown content type ${e.type}`):new Error(`Unknown content ${JSON.stringify(e)}`)}function ge(e,t,n){if((0,se.wk)(e)){const r=e.name??function(e,t){return t.map(e=>(0,se.KX)(e)?e.tool_calls??[]:[]).flat().find(t=>t.id===e.tool_call_id)?.name}(e,n);if(void 0===r)throw new Error(`Google requires a tool name for each tool call response, and we could not infer a called tool name for ToolMessage "${e.id}" from your passed messages. Please populate a "name" field on that ToolMessage explicitly.`);const s=Array.isArray(e.content)?e.content.map(e=>me(e,t)).filter(e=>void 0!==e):e.content;return"error"===e.status?[{functionResponse:{name:r,response:{error:{details:s}}}}]:[{functionResponse:{name:r,response:{result:s}}}]}let r=[];const s=[];return"string"==typeof e.content&&e.content&&s.push({text:e.content}),Array.isArray(e.content)&&s.push(...e.content.map(e=>me(e,t)).filter(e=>void 0!==e)),(0,se.KX)(e)&&e.tool_calls?.length&&(r=e.tool_calls.map(e=>({functionCall:{name:e.name,args:e.args}}))),[...s,...r]}function fe(e,t,n=!1){return e.reduce((r,s,i)=>{if(!(0,se.ny)(s))throw new Error("Unsupported message input");const a=function(e){const t=e._getType();return se.cM.isInstance(e)?e.role:"tool"===t?t:e.name??t}(s);if("system"===a&&0!==i)throw new Error("System message should be the first one");const o=function(e){switch(e){case"supervisor":case"ai":case"model":return"model";case"system":return"system";case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${e}`)}}(a),c=r.content[r.content.length];if(!r.mergeWithPreviousContent&&c&&c.role===o)throw new Error("Google Generative AI requires alternate messages between authors");const l=ge(s,t,e.slice(0,i));if(r.mergeWithPreviousContent){const e=r.content[r.content.length-1];if(!e)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return e.parts.push(...l),{mergeWithPreviousContent:!1,content:r.content}}let u=o;("function"===u||"system"===u&&!n)&&(u="user");const d={role:u,parts:l};return{mergeWithPreviousContent:"system"===a&&!n,content:[...r.content,d]}},{content:[],mergeWithPreviousContent:!1}).content}function ye(e,t){if(!e.candidates||0===e.candidates.length)return null;const n=e.functionCalls(),[r]=e.candidates,{content:s,...i}=r;let a;a=Array.isArray(s?.parts)&&s.parts.every(e=>"text"in e)?s.parts.map(e=>e.text).join(""):Array.isArray(s?.parts)?s.parts.map(e=>"text"in e?{type:"text",text:e.text}:"executableCode"in e?{type:"executableCode",executableCode:e.executableCode}:"codeExecutionResult"in e?{type:"codeExecutionResult",codeExecutionResult:e.codeExecutionResult}:e):[];let o="";if(a&&"string"==typeof a)o=a;else if(Array.isArray(a)){const e=a.find(e=>"text"in e);o=e?.text??""}const c=[];return n&&c.push(...n.map(e=>({...e,args:JSON.stringify(e.args),index:t.index,type:"tool_call_chunk",id:"id"in e&&"string"==typeof e.id?e.id:pe()}))),new ie.Cf({text:o,message:new se.H({content:a||"",name:s?s.role:void 0,tool_call_chunks:c,additional_kwargs:{},usage_metadata:t.usageMetadata}),generationInfo:i})}class _e extends Q.vd{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await(0,X.K3)(this.zodSchema,e);if(t.success)return t.data;throw new Q.CC(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.issues)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap(e=>{const{message:t}=e;return"tool_calls"in t&&Array.isArray(t.tool_calls)?t.tool_calls:[]});if(void 0===t[0])throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");const[n]=t;return await this._validateResult(n.args)}}function be(e,t){const n=function(e){let t=[];const n=[];e.forEach(e=>{if((0,ae.qG)(e)){const[n]=function(e){return e.every(e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations))?e:[{functionDeclarations:e.map(e=>{if((0,ae.qG)(e)){const t=ne(e.schema);return"object"===t.type&&"properties"in t&&0===Object.keys(t.properties).length?{name:e.name,description:e.description}:{name:e.name,description:e.description,parameters:t}}return(0,oe.VC)(e)?{name:e.function.name,description:e.function.description??"A function available to call.",parameters:re(e.function.parameters)}:e})}]}([e]);n.functionDeclarations&&t.push(...n.functionDeclarations)}else if((0,oe.VC)(e)){const{functionDeclarations:n}=function(e){return{functionDeclarations:[{name:e.function.name,description:e.function.description,parameters:te(e.function.parameters)}]}}(e);if(!n)throw new Error("Failed to convert OpenAI structured tool to GenerativeAI tool");t.push(...n)}else n.push(e)});const r=n.find(e=>"functionDeclarations"in e);if(r)return n.map(e=>{if(t?.length>0&&"functionDeclarations"in e){const n={functionDeclarations:[...e.functionDeclarations||[],...t]};return t=[],n}return e});return[...n,...t.length>0?[{functionDeclarations:t}]:[]]}(e),r=function(e,t){if(!e.length||!t)return;const{toolChoice:n,allowedFunctionNames:r}=t,s={any:p.ANY,auto:p.AUTO,none:p.NONE};if(n&&["any","auto","none"].includes(n))return{functionCallingConfig:{mode:s[n]??"MODE_UNSPECIFIED",allowedFunctionNames:r}};if("string"==typeof n||r)return{functionCallingConfig:{mode:p.ANY,allowedFunctionNames:[...r??[],...n&&"string"==typeof n?[n]:[]]}};return}(n,t);return{tools:n,toolConfig:r}}class we extends J.xV{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get lc_aliases(){return{apiKey:"google_api_key"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")||this.model.startsWith("gemini-2")}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","google_genai"]}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"json",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"convertSystemMessageToHumanContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e.model.replace(/^models\//,""),this.maxOutputTokens=e.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>2))throw new Error("`temperature` must be in the range of [0.0,2.0]");if(this.topP=e.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=e.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=e.stopSequences??this.stopSequences,this.apiKey=e.apiKey??(0,V.Az)("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0){if(new Set(this.safetySettings.map(e=>e.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique")}this.streaming=e.streaming??this.streaming,this.json=e.json,this.client=new W(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK,...this.json?{responseMimeType:"application/json"}:{}}},{apiVersion:e.apiVersion,baseUrl:e.baseUrl}),this.streamUsage=e.streamUsage??this.streamUsage}useCachedContent(e,t,n){this.apiKey&&(this.client=new W(this.apiKey).getGenerativeModelFromCachedContent(e,t,n))}get useSystemInstruction(){return"boolean"==typeof this.convertSystemMessageToHumanContent?!this.convertSystemMessageToHumanContent:this.computeUseSystemInstruction}get computeUseSystemInstruction(){return"gemini-1.0-pro-001"!==this.model&&(!this.model.startsWith("gemini-pro-vision")&&(!this.model.startsWith("gemini-1.0-pro-vision")&&"gemini-pro"!==this.model))}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){return this.withConfig({tools:be(e)?.tools,...t})}invocationParams(e){const t=e?.tools?.length?be(e.tools,{toolChoice:e.tool_choice,allowedFunctionNames:e.allowedFunctionNames}):void 0;return e?.responseSchema?(this.client.generationConfig.responseSchema=e.responseSchema,this.client.generationConfig.responseMimeType="application/json"):(this.client.generationConfig.responseSchema=void 0,this.client.generationConfig.responseMimeType=this.json?"application/json":void 0),{...t?.tools?{tools:t.tools}:{},...t?.toolConfig?{toolConfig:t.toolConfig}:{}}}async _generate(e,t,n){const r=fe(e,this._isMultimodalModel,this.useSystemInstruction);let s=r;if("system"===r[0].role){const[e]=r;this.client.systemInstruction=e,s=r.slice(1)}const i=this.invocationParams(t);if(this.streaming){const r={},s=this._streamResponseChunks(e,t,n),i={};for await(const e of s){const t=e.generationInfo?.completion??0;void 0===i[t]?i[t]=e:i[t]=i[t].concat(e)}return{generations:Object.entries(i).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),llmOutput:{estimatedTokenUsage:r}}}const a=await this.completionWithRetry({...i,contents:s});let o;if("usageMetadata"in a.response){const e=a.response.usageMetadata;o={input_tokens:e.promptTokenCount??0,output_tokens:e.candidatesTokenCount??0,total_tokens:e.totalTokenCount??0}}const c=function(e,t){if(!e.candidates||0===e.candidates.length||!e.candidates[0])return{generations:[],llmOutput:{filters:e.promptFeedback}};const n=e.functionCalls(),[r]=e.candidates,{content:s,...i}=r;let a;a=Array.isArray(s?.parts)&&1===s.parts.length&&s.parts[0].text?s.parts[0].text:Array.isArray(s?.parts)&&s.parts.length>0?s.parts.map(e=>"text"in e?{type:"text",text:e.text}:"executableCode"in e?{type:"executableCode",executableCode:e.executableCode}:"codeExecutionResult"in e?{type:"codeExecutionResult",codeExecutionResult:e.codeExecutionResult}:e):[];let o="";if("string"==typeof a)o=a;else if(Array.isArray(a)&&a.length>0){const e=a.find(e=>"text"in e);o=e?.text??o}return{generations:[{text:o,message:new se.Od({content:a??"",tool_calls:n?.map(e=>({...e,type:"tool_call",id:"id"in e&&"string"==typeof e.id?e.id:pe()})),additional_kwargs:{...i},usage_metadata:t?.usageMetadata}),generationInfo:i}],llmOutput:{tokenUsage:{promptTokens:t?.usageMetadata?.input_tokens,completionTokens:t?.usageMetadata?.output_tokens,totalTokens:t?.usageMetadata?.total_tokens}}}}(a.response,{usageMetadata:o});return c.generations?.length>0&&await(n?.handleLLMNewToken(c.generations[0]?.text??"")),c}async*_streamResponseChunks(e,t,n){const r=fe(e,this._isMultimodalModel,this.useSystemInstruction);let s=r;if("system"===r[0].role){const[e]=r;this.client.systemInstruction=e,s=r.slice(1)}const i={...this.invocationParams(t),contents:s},a=await this.caller.callWithOptions({signal:t?.signal},async()=>{const{stream:e}=await this.client.generateContentStream(i);return e});let o,c=0;for await(const e of a){if("usageMetadata"in e&&!1!==this.streamUsage&&!1!==t.streamUsage){const t=e.usageMetadata;if(o){const e=(t.candidatesTokenCount??0)-o.output_tokens;o={input_tokens:0,output_tokens:e,total_tokens:e}}else o={input_tokens:t.promptTokenCount??0,output_tokens:t.candidatesTokenCount??0,total_tokens:t.totalTokenCount??0}}const r=ye(e,{usageMetadata:o,index:c});c+=1,r&&(yield r,await(n?.handleLLMNewToken(r.text??"")))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t?.signal},async()=>{try{return await this.client.generateContent(e)}catch(e){throw e.message?.includes("400 Bad Request")&&(e.status=400),e}})}withStructuredOutput(e,t){const n=e,r=t?.name,s=t?.method,i=t?.includeRaw;if("jsonMode"===s)throw new Error('ChatGoogleGenerativeAI only supports "jsonSchema" or "functionCalling" as a method.');let a,o;if("functionCalling"===s){let e,t=r??"extract";if((0,X.c9)(n)){const r=ne(n);e=[{functionDeclarations:[{name:t,description:r.description??"A function available to call.",parameters:r}]}],o=new _e({returnSingle:!0,keyName:t,zodSchema:n})}else{let r;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(r=n,r.parameters=te(n.parameters),t=n.name):r={name:t,description:n.description??"",parameters:te(n)},e=[{functionDeclarations:[r]}],o=new _e({returnSingle:!0,keyName:t})}a=this.bindTools(e).withConfig({allowedFunctionNames:[t]})}else{const e=ne(n);a=this.withConfig({responseSchema:e}),o=new Q.hU}if(!i)return a.pipe(o).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});const c=Z.kI.assign({parsed:(e,t)=>o.invoke(e.raw,t)}),l=Z.kI.assign({parsed:()=>null}),u=c.withFallbacks({fallbacks:[l]});return Z.zZ.from([{raw:a},u]).withConfig({runName:"StructuredOutputRunnable"})}}var ve=n(2540);n(1535);ve.J},6780:(e,t,n)=>{"use strict";const r=n(8311);e.exports=(e,t,n)=>(e=new r(e,n),t=new r(t,n),e.intersects(t,n))},6792:(e,t,n)=>{"use strict";n.d(t,{CC:()=>o,mJ:()=>a,vd:()=>i});var r=n(4508),s=n(1368);class i extends r.YN{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig(async(e,t)=>this.parseResult([{text:e}],t?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks),e,{...t,runType:"parser"})}}class a extends i{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class o extends Error{constructor(e,t,n,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=r,r&&(void 0===n||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");(0,s.Y)(this,"OUTPUT_PARSING_FAILURE")}}},6874:e=>{"use strict";const t=Number.MAX_SAFE_INTEGER||9007199254740991;e.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},6928:(e,t,n)=>{"use strict";n.d(t,{Kj:()=>r.Kj,Ls:()=>a,gk:()=>s.gk,q7:()=>i.q});var r=n(9033),s=n(1356),i=(n(747),n(639));const a="0.3.67"},6953:(e,t,n)=>{"use strict";const r=n(144);e.exports=(e,t)=>{const n=r(e,t);return n?n.version:null}},6968:(e,t,n)=>{"use strict";n.d(t,{X0:()=>a,hr:()=>s,pH:()=>i});const r=Symbol.for("ls:tracing_async_local_storage"),s=Symbol.for("lc:context_variables"),i=e=>{globalThis[r]=e},a=()=>globalThis[r]},7048:(e,t,n)=>{"use strict";function r(e){const t=Object.values(e).filter(e=>"number"==typeof e);return Object.entries(e).filter(([e,n])=>-1===t.indexOf(+e)).map(([e,t])=>t)}function s(e,t){return"bigint"==typeof t?t.toString():t}n.d(t,{A2:()=>c,QH:()=>l,gx:()=>i,iR:()=>d,k8:()=>s,o8:()=>o,w5:()=>r});const i=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{};a=()=>{if("undefined"!=typeof navigator&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{return new Function(""),!0}catch(e){return!1}};var a;new Set(["string","number","symbol"]),new Set(["string","number","bigint","boolean","symbol","undefined"]);function o(e,t,n){const r=new e._zod.constr(t??e._zod.def);return t&&!n?.parent||(r._zod.parent=e),r}function c(e){const t=e;if(!t)return{};if("string"==typeof t)return{error:()=>t};if(void 0!==t?.message){if(void 0!==t?.error)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,"string"==typeof t.error?{...t,error:()=>t.error}:t}Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MAX_VALUE,Number.MAX_VALUE;function l(e,t=0){for(let n=t;n<e.issues.length;n++)if(!0!==e.issues[n]?.continue)return!0;return!1}function u(e){return"string"==typeof e?e:e?.message}function d(e,t,n){const r={...e,path:e.path??[]};if(!e.message){const s=u(e.inst?._zod.def?.error?.(e))??u(t?.error?.(e))??u(n.customError?.(e))??u(n.localeError?.(e))??"Invalid input";r.message=s}return delete r.inst,delete r.continue,t?.reportInput||delete r.input,r}},7059:(e,t,n)=>{"use strict";const r=n(560);e.exports=(e,t,n)=>r(e,t,n)<0},7075:(e,t,n)=>{"use strict";const r=n(3908),s=n(3904),{ANY:i}=s,a=n(8311),o=n(7638),c=n(5580),l=n(7059),u=n(5200),d=n(4089);e.exports=(e,t,n,h)=>{let p,m,g,f,y;switch(e=new r(e,h),t=new a(t,h),n){case">":p=c,m=u,g=l,f=">",y=">=";break;case"<":p=l,m=d,g=c,f="<",y="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(o(e,t,h))return!1;for(let n=0;n<t.set.length;++n){const r=t.set[n];let a=null,o=null;if(r.forEach(e=>{e.semver===i&&(e=new s(">=0.0.0")),a=a||e,o=o||e,p(e.semver,a.semver,h)?a=e:g(e.semver,o.semver,h)&&(o=e)}),a.operator===f||a.operator===y)return!1;if((!o.operator||o.operator===f)&&m(e,o.semver))return!1;if(o.operator===y&&g(e,o.semver))return!1}return!0}},7237:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});const r={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var s,i=new Uint8Array(16);function a(){if(!s&&!(s="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return s(i)}var o=n(8568);const c=function(e,t,n){if(r.randomUUID&&!t&&!e)return r.randomUUID();var s=(e=e||{}).random||(e.rng||a)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){n=n||0;for(var i=0;i<16;++i)t[n+i]=s[i];return t}return(0,o.k)(s)}},7265:(e,t,n)=>{"use strict";function r(e,t){const n=typeof e;if(n!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let s=0;s<n;s++)if(!r(e[s],t[s]))return!1;return!0}if("object"===n){if(!e||!t)return e===t;const n=Object.keys(e),s=Object.keys(t);if(n.length!==s.length)return!1;for(const s of n)if(!r(e[s],t[s]))return!1;return!0}return e===t}function s(e){return encodeURI(function(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}(e))}n.d(t,{rA:()=>r,tf:()=>E});const i={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},a={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},o={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let c="undefined"!=typeof self&&self.location&&"null"!==self.location.origin?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function l(e,t=Object.create(null),n=c,r=""){if(e&&"object"==typeof e&&!Array.isArray(e)){const s=e.$id||e.id;if(s){const i=new URL(s,n.href);i.hash.length>1?t[i.href]=e:(i.hash="",""===r?n=i:l(e,t,n))}}else if(!0!==e&&!1!==e)return t;const u=n.href+(r?"#"+r:"");if(void 0!==t[u])throw new Error(`Duplicate schema URI "${u}".`);if(t[u]=e,!0===e||!1===e)return t;if(void 0===e.__absolute_uri__&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:u}),e.$ref&&void 0===e.__absolute_ref__){const t=new URL(e.$ref,n.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:t.href})}if(e.$recursiveRef&&void 0===e.__absolute_recursive_ref__){const t=new URL(e.$recursiveRef,n.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:t.href})}if(e.$anchor){t[new URL("#"+e.$anchor,n.href).href]=e}for(let c in e){if(o[c])continue;const u=`${r}/${s(c)}`,d=e[c];if(Array.isArray(d)){if(i[c]){const e=d.length;for(let r=0;r<e;r++)l(d[r],t,n,`${u}/${r}`)}}else if(a[c])for(let e in d)l(d[e],t,n,`${u}/${s(e)}`);else l(d,t,n,u)}return t}const u=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,d=[0,31,28,31,30,31,30,31,31,30,31,30,31],h=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i;function p(e){return e.test.bind(e)}const m={date:g,time:f.bind(void 0,!1),"date-time":function(e){const t=e.split(y);return 2==t.length&&g(t[0])&&f(!0,t[1])},duration:e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e)),uri:function(e){return _.test(e)&&b.test(e)},"uri-reference":p(/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i),"uri-template":p(/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i),url:p(/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu),email:e=>{if('"'===e[0])return!1;const[t,n,...r]=e.split("@");return!(!t||!n||0!==r.length||t.length>64||n.length>253)&&("."!==t[0]&&!t.endsWith(".")&&!t.includes("..")&&(!(!/^[a-z0-9.-]+$/i.test(n)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t))&&n.split(".").every(e=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(e))))},hostname:p(/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i),ipv4:p(/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/),ipv6:p(/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i),regex:function(e){if(w.test(e))return!1;try{return new RegExp(e,"u"),!0}catch(e){return!1}},uuid:p(/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i),"json-pointer":p(/^(?:\/(?:[^~/]|~0|~1)*)*$/),"json-pointer-uri-fragment":p(/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i),"relative-json-pointer":p(/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/)};function g(e){const t=e.match(u);if(!t)return!1;const n=+t[1],r=+t[2],s=+t[3];return r>=1&&r<=12&&s>=1&&s<=(2==r&&function(e){return e%4==0&&(e%100!=0||e%400==0)}(n)?29:d[r])}function f(e,t){const n=t.match(h);if(!n)return!1;const r=+n[1],s=+n[2],i=+n[3],a=!!n[5];return(r<=23&&s<=59&&i<=59||23==r&&59==s&&60==i)&&(!e||a)}const y=/t|\s/i;const _=/\/|:/,b=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;const w=/[^\\]\\Z/;var v;function E(e,t,n="2019-09",i=l(t),a=!0,o=null,c="#",u="#",d=Object.create(null)){if(!0===t)return{valid:!0,errors:[]};if(!1===t)return{valid:!1,errors:[{instanceLocation:c,keyword:"false",keywordLocation:c,error:"False boolean schema."}]};const h=typeof e;let p;switch(h){case"boolean":case"number":case"string":p=h;break;case"object":p=null===e?"null":Array.isArray(e)?"array":"object";break;default:throw new Error(`Instances of "${h}" type are not supported.`)}const{$ref:g,$recursiveRef:f,$recursiveAnchor:y,type:_,const:b,enum:w,required:v,not:S,anyOf:x,allOf:k,oneOf:T,if:I,then:O,else:C,format:A,properties:P,patternProperties:M,additionalProperties:R,unevaluatedProperties:$,minProperties:j,maxProperties:N,propertyNames:L,dependentRequired:D,dependentSchemas:U,dependencies:F,prefixItems:Y,items:G,additionalItems:B,unevaluatedItems:H,contains:z,minContains:q,maxContains:K,minItems:W,maxItems:V,uniqueItems:J,minimum:Z,maximum:X,exclusiveMinimum:Q,exclusiveMaximum:ee,multipleOf:te,minLength:ne,maxLength:re,pattern:se,__absolute_ref__:ie,__absolute_recursive_ref__:ae}=t,oe=[];if(!0===y&&null===o&&(o=t),"#"===f){const r=null===o?i[ae]:o,s=`${u}/$recursiveRef`,l=E(e,null===o?t:o,n,i,a,r,c,s,d);l.valid||oe.push({instanceLocation:c,keyword:"$recursiveRef",keywordLocation:s,error:"A subschema had errors."},...l.errors)}if(void 0!==g){const t=i[ie||g];if(void 0===t){let e=`Unresolved $ref "${g}".`;throw ie&&ie!==g&&(e+=`  Absolute URI "${ie}".`),e+=`\nKnown schemas:\n- ${Object.keys(i).join("\n- ")}`,new Error(e)}const r=`${u}/$ref`,s=E(e,t,n,i,a,o,c,r,d);if(s.valid||oe.push({instanceLocation:c,keyword:"$ref",keywordLocation:r,error:"A subschema had errors."},...s.errors),"4"===n||"7"===n)return{valid:0===oe.length,errors:oe}}if(Array.isArray(_)){let t=_.length,n=!1;for(let r=0;r<t;r++)if(p===_[r]||"integer"===_[r]&&"number"===p&&e%1==0&&e==e){n=!0;break}n||oe.push({instanceLocation:c,keyword:"type",keywordLocation:`${u}/type`,error:`Instance type "${p}" is invalid. Expected "${_.join('", "')}".`})}else"integer"===_?("number"!==p||e%1||e!=e)&&oe.push({instanceLocation:c,keyword:"type",keywordLocation:`${u}/type`,error:`Instance type "${p}" is invalid. Expected "${_}".`}):void 0!==_&&p!==_&&oe.push({instanceLocation:c,keyword:"type",keywordLocation:`${u}/type`,error:`Instance type "${p}" is invalid. Expected "${_}".`});if(void 0!==b&&("object"===p||"array"===p?r(e,b)||oe.push({instanceLocation:c,keyword:"const",keywordLocation:`${u}/const`,error:`Instance does not match ${JSON.stringify(b)}.`}):e!==b&&oe.push({instanceLocation:c,keyword:"const",keywordLocation:`${u}/const`,error:`Instance does not match ${JSON.stringify(b)}.`})),void 0!==w&&("object"===p||"array"===p?w.some(t=>r(e,t))||oe.push({instanceLocation:c,keyword:"enum",keywordLocation:`${u}/enum`,error:`Instance does not match any of ${JSON.stringify(w)}.`}):w.some(t=>e===t)||oe.push({instanceLocation:c,keyword:"enum",keywordLocation:`${u}/enum`,error:`Instance does not match any of ${JSON.stringify(w)}.`})),void 0!==S){const t=`${u}/not`;E(e,S,n,i,a,o,c,t).valid&&oe.push({instanceLocation:c,keyword:"not",keywordLocation:t,error:'Instance matched "not" schema.'})}let ce=[];if(void 0!==x){const t=`${u}/anyOf`,r=oe.length;let s=!1;for(let r=0;r<x.length;r++){const l=x[r],u=Object.create(d),h=E(e,l,n,i,a,!0===y?o:null,c,`${t}/${r}`,u);oe.push(...h.errors),s=s||h.valid,h.valid&&ce.push(u)}s?oe.length=r:oe.splice(r,0,{instanceLocation:c,keyword:"anyOf",keywordLocation:t,error:"Instance does not match any subschemas."})}if(void 0!==k){const t=`${u}/allOf`,r=oe.length;let s=!0;for(let r=0;r<k.length;r++){const l=k[r],u=Object.create(d),h=E(e,l,n,i,a,!0===y?o:null,c,`${t}/${r}`,u);oe.push(...h.errors),s=s&&h.valid,h.valid&&ce.push(u)}s?oe.length=r:oe.splice(r,0,{instanceLocation:c,keyword:"allOf",keywordLocation:t,error:"Instance does not match every subschema."})}if(void 0!==T){const t=`${u}/oneOf`,r=oe.length,s=T.filter((r,s)=>{const l=Object.create(d),u=E(e,r,n,i,a,!0===y?o:null,c,`${t}/${s}`,l);return oe.push(...u.errors),u.valid&&ce.push(l),u.valid}).length;1===s?oe.length=r:oe.splice(r,0,{instanceLocation:c,keyword:"oneOf",keywordLocation:t,error:`Instance does not match exactly one subschema (${s} matches).`})}if("object"!==p&&"array"!==p||Object.assign(d,...ce),void 0!==I){const t=`${u}/if`;if(E(e,I,n,i,a,o,c,t,d).valid){if(void 0!==O){const r=E(e,O,n,i,a,o,c,`${u}/then`,d);r.valid||oe.push({instanceLocation:c,keyword:"if",keywordLocation:t,error:'Instance does not match "then" schema.'},...r.errors)}}else if(void 0!==C){const r=E(e,C,n,i,a,o,c,`${u}/else`,d);r.valid||oe.push({instanceLocation:c,keyword:"if",keywordLocation:t,error:'Instance does not match "else" schema.'},...r.errors)}}if("object"===p){if(void 0!==v)for(const t of v)t in e||oe.push({instanceLocation:c,keyword:"required",keywordLocation:`${u}/required`,error:`Instance does not have required property "${t}".`});const t=Object.keys(e);if(void 0!==j&&t.length<j&&oe.push({instanceLocation:c,keyword:"minProperties",keywordLocation:`${u}/minProperties`,error:`Instance does not have at least ${j} properties.`}),void 0!==N&&t.length>N&&oe.push({instanceLocation:c,keyword:"maxProperties",keywordLocation:`${u}/maxProperties`,error:`Instance does not have at least ${N} properties.`}),void 0!==L){const t=`${u}/propertyNames`;for(const r in e){const e=`${c}/${s(r)}`,l=E(r,L,n,i,a,o,e,t);l.valid||oe.push({instanceLocation:c,keyword:"propertyNames",keywordLocation:t,error:`Property name "${r}" does not match schema.`},...l.errors)}}if(void 0!==D){const t=`${u}/dependantRequired`;for(const n in D)if(n in e){const r=D[n];for(const s of r)s in e||oe.push({instanceLocation:c,keyword:"dependentRequired",keywordLocation:t,error:`Instance has "${n}" but does not have "${s}".`})}}if(void 0!==U)for(const t in U){const r=`${u}/dependentSchemas`;if(t in e){const l=E(e,U[t],n,i,a,o,c,`${r}/${s(t)}`,d);l.valid||oe.push({instanceLocation:c,keyword:"dependentSchemas",keywordLocation:r,error:`Instance has "${t}" but does not match dependant schema.`},...l.errors)}}if(void 0!==F){const t=`${u}/dependencies`;for(const r in F)if(r in e){const l=F[r];if(Array.isArray(l))for(const n of l)n in e||oe.push({instanceLocation:c,keyword:"dependencies",keywordLocation:t,error:`Instance has "${r}" but does not have "${n}".`});else{const u=E(e,l,n,i,a,o,c,`${t}/${s(r)}`);u.valid||oe.push({instanceLocation:c,keyword:"dependencies",keywordLocation:t,error:`Instance has "${r}" but does not match dependant schema.`},...u.errors)}}}const r=Object.create(null);let l=!1;if(void 0!==P){const t=`${u}/properties`;for(const u in P){if(!(u in e))continue;const h=`${c}/${s(u)}`,p=E(e[u],P[u],n,i,a,o,h,`${t}/${s(u)}`);if(p.valid)d[u]=r[u]=!0;else if(l=a,oe.push({instanceLocation:c,keyword:"properties",keywordLocation:t,error:`Property "${u}" does not match schema.`},...p.errors),l)break}}if(!l&&void 0!==M){const t=`${u}/patternProperties`;for(const u in M){const h=new RegExp(u,"u"),p=M[u];for(const m in e){if(!h.test(m))continue;const g=`${c}/${s(m)}`,f=E(e[m],p,n,i,a,o,g,`${t}/${s(u)}`);f.valid?d[m]=r[m]=!0:(l=a,oe.push({instanceLocation:c,keyword:"patternProperties",keywordLocation:t,error:`Property "${m}" matches pattern "${u}" but does not match associated schema.`},...f.errors))}}}if(l||void 0===R){if(!l&&void 0!==$){const t=`${u}/unevaluatedProperties`;for(const r in e)if(!d[r]){const l=`${c}/${s(r)}`,u=E(e[r],$,n,i,a,o,l,t);u.valid?d[r]=!0:oe.push({instanceLocation:c,keyword:"unevaluatedProperties",keywordLocation:t,error:`Property "${r}" does not match unevaluated properties schema.`},...u.errors)}}}else{const t=`${u}/additionalProperties`;for(const u in e){if(r[u])continue;const h=`${c}/${s(u)}`,p=E(e[u],R,n,i,a,o,h,t);p.valid?d[u]=!0:(l=a,oe.push({instanceLocation:c,keyword:"additionalProperties",keywordLocation:t,error:`Property "${u}" does not match additional properties schema.`},...p.errors))}}}else if("array"===p){void 0!==V&&e.length>V&&oe.push({instanceLocation:c,keyword:"maxItems",keywordLocation:`${u}/maxItems`,error:`Array has too many items (${e.length} > ${V}).`}),void 0!==W&&e.length<W&&oe.push({instanceLocation:c,keyword:"minItems",keywordLocation:`${u}/minItems`,error:`Array has too few items (${e.length} < ${W}).`});const t=e.length;let s=0,l=!1;if(void 0!==Y){const r=`${u}/prefixItems`,h=Math.min(Y.length,t);for(;s<h;s++){const t=E(e[s],Y[s],n,i,a,o,`${c}/${s}`,`${r}/${s}`);if(d[s]=!0,!t.valid&&(l=a,oe.push({instanceLocation:c,keyword:"prefixItems",keywordLocation:r,error:"Items did not match schema."},...t.errors),l))break}}if(void 0!==G){const r=`${u}/items`;if(Array.isArray(G)){const u=Math.min(G.length,t);for(;s<u;s++){const t=E(e[s],G[s],n,i,a,o,`${c}/${s}`,`${r}/${s}`);if(d[s]=!0,!t.valid&&(l=a,oe.push({instanceLocation:c,keyword:"items",keywordLocation:r,error:"Items did not match schema."},...t.errors),l))break}}else for(;s<t;s++){const t=E(e[s],G,n,i,a,o,`${c}/${s}`,r);if(d[s]=!0,!t.valid&&(l=a,oe.push({instanceLocation:c,keyword:"items",keywordLocation:r,error:"Items did not match schema."},...t.errors),l))break}if(!l&&void 0!==B){const r=`${u}/additionalItems`;for(;s<t;s++){const t=E(e[s],B,n,i,a,o,`${c}/${s}`,r);d[s]=!0,t.valid||(l=a,oe.push({instanceLocation:c,keyword:"additionalItems",keywordLocation:r,error:"Items did not match additional items schema."},...t.errors))}}}if(void 0!==z)if(0===t&&void 0===q)oe.push({instanceLocation:c,keyword:"contains",keywordLocation:`${u}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(void 0!==q&&t<q)oe.push({instanceLocation:c,keyword:"minContains",keywordLocation:`${u}/minContains`,error:`Array has less items (${t}) than minContains (${q}).`});else{const r=`${u}/contains`,s=oe.length;let l=0;for(let s=0;s<t;s++){const t=E(e[s],z,n,i,a,o,`${c}/${s}`,r);t.valid?(d[s]=!0,l++):oe.push(...t.errors)}l>=(q||0)&&(oe.length=s),void 0===q&&void 0===K&&0===l?oe.splice(s,0,{instanceLocation:c,keyword:"contains",keywordLocation:r,error:"Array does not contain item matching schema."}):void 0!==q&&l<q?oe.push({instanceLocation:c,keyword:"minContains",keywordLocation:`${u}/minContains`,error:`Array must contain at least ${q} items matching schema. Only ${l} items were found.`}):void 0!==K&&l>K&&oe.push({instanceLocation:c,keyword:"maxContains",keywordLocation:`${u}/maxContains`,error:`Array may contain at most ${K} items matching schema. ${l} items were found.`})}if(!l&&void 0!==H){const r=`${u}/unevaluatedItems`;for(;s<t;s++){if(d[s])continue;const t=E(e[s],H,n,i,a,o,`${c}/${s}`,r);d[s]=!0,t.valid||oe.push({instanceLocation:c,keyword:"unevaluatedItems",keywordLocation:r,error:"Items did not match unevaluated items schema."},...t.errors)}}if(J)for(let n=0;n<t;n++){const s=e[n],i="object"==typeof s&&null!==s;for(let a=0;a<t;a++){if(n===a)continue;const t=e[a];(s===t||i&&("object"==typeof t&&null!==t)&&r(s,t))&&(oe.push({instanceLocation:c,keyword:"uniqueItems",keywordLocation:`${u}/uniqueItems`,error:`Duplicate items at indexes ${n} and ${a}.`}),n=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER)}}}else if("number"===p){if("4"===n?(void 0!==Z&&(!0===Q&&e<=Z||e<Z)&&oe.push({instanceLocation:c,keyword:"minimum",keywordLocation:`${u}/minimum`,error:`${e} is less than ${Q?"or equal to ":""} ${Z}.`}),void 0!==X&&(!0===ee&&e>=X||e>X)&&oe.push({instanceLocation:c,keyword:"maximum",keywordLocation:`${u}/maximum`,error:`${e} is greater than ${ee?"or equal to ":""} ${X}.`})):(void 0!==Z&&e<Z&&oe.push({instanceLocation:c,keyword:"minimum",keywordLocation:`${u}/minimum`,error:`${e} is less than ${Z}.`}),void 0!==X&&e>X&&oe.push({instanceLocation:c,keyword:"maximum",keywordLocation:`${u}/maximum`,error:`${e} is greater than ${X}.`}),void 0!==Q&&e<=Q&&oe.push({instanceLocation:c,keyword:"exclusiveMinimum",keywordLocation:`${u}/exclusiveMinimum`,error:`${e} is less than ${Q}.`}),void 0!==ee&&e>=ee&&oe.push({instanceLocation:c,keyword:"exclusiveMaximum",keywordLocation:`${u}/exclusiveMaximum`,error:`${e} is greater than or equal to ${ee}.`})),void 0!==te){const t=e%te;Math.abs(0-t)>=1.1920929e-7&&Math.abs(te-t)>=1.1920929e-7&&oe.push({instanceLocation:c,keyword:"multipleOf",keywordLocation:`${u}/multipleOf`,error:`${e} is not a multiple of ${te}.`})}}else if("string"===p){const t=void 0===ne&&void 0===re?0:function(e){let t,n=0,r=e.length,s=0;for(;s<r;)n++,t=e.charCodeAt(s++),t>=55296&&t<=56319&&s<r&&(t=e.charCodeAt(s),56320==(64512&t)&&s++);return n}(e);void 0!==ne&&t<ne&&oe.push({instanceLocation:c,keyword:"minLength",keywordLocation:`${u}/minLength`,error:`String is too short (${t} < ${ne}).`}),void 0!==re&&t>re&&oe.push({instanceLocation:c,keyword:"maxLength",keywordLocation:`${u}/maxLength`,error:`String is too long (${t} > ${re}).`}),void 0===se||new RegExp(se,"u").test(e)||oe.push({instanceLocation:c,keyword:"pattern",keywordLocation:`${u}/pattern`,error:"String does not match pattern."}),void 0!==A&&m[A]&&!m[A](e)&&oe.push({instanceLocation:c,keyword:"format",keywordLocation:`${u}/format`,error:`String does not match format "${A}".`})}return{valid:0===oe.length,errors:oe}}!function(e){e[e.Flag=1]="Flag",e[e.Basic=2]="Basic",e[e.Detailed=4]="Detailed"}(v||(v={}))},7272:e=>{"use strict";const t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>{}:()=>{};e.exports=t},7414:(e,t,n)=>{"use strict";const r=n(144);e.exports=(e,t)=>{const n=r(e.trim().replace(/^[=v]+/,""),t);return n?n.version:null}},7439:(e,t,n)=>{"use strict";function r(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n}function s(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}n.d(t,{ChatAnthropic:()=>gn});let i=function(){const{crypto:e}=globalThis;if(e?.randomUUID)return i=e.randomUUID.bind(e),e.randomUUID();const t=new Uint8Array(1),n=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(+e^n()&15>>+e/4).toString(16))};function a(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}const o=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){const t=new Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return new Error(JSON.stringify(e))}catch{}}return new Error(e)};class c extends Error{}class l extends c{constructor(e,t,n,r){super(`${l.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.requestID=r?.get("request-id"),this.error=t}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e||!r)return new d({message:n,cause:o(t)});const s=t;return 400===e?new p(e,s,n,r):401===e?new m(e,s,n,r):403===e?new g(e,s,n,r):404===e?new f(e,s,n,r):409===e?new y(e,s,n,r):422===e?new _(e,s,n,r):429===e?new b(e,s,n,r):e>=500?new w(e,s,n,r):new l(e,s,n,r)}}class u extends l{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class d extends l{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class h extends d{constructor({message:e}={}){super({message:e??"Request timed out."})}}class p extends l{}class m extends l{}class g extends l{}class f extends l{}class y extends l{}class _ extends l{}class b extends l{}class w extends l{}const v=/^[a-z][a-z0-9+.-]*:/i;let E=e=>(E=Array.isArray,E(e)),S=E;function x(e){return"object"!=typeof e?{}:e??{}}const k=e=>{try{return JSON.parse(e)}catch(e){return}},T="0.56.0";const I=()=>{const e="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":T,"X-Stainless-OS":C(Deno.build.os),"X-Stainless-Arch":O(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":T,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":T,"X-Stainless-OS":C(globalThis.process.platform??"unknown"),"X-Stainless-Arch":O(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const t=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":T,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":T,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const O=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",C=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let A;function P(...e){const t=globalThis.ReadableStream;if(void 0===t)throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function M(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return P({start(){},async pull(e){const{done:n,value:r}=await t.next();n?e.close():e.enqueue(r)},async cancel(){await(t.return?.())}})}function R(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const $=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)});let j,N;function L(e){let t;return(j??(t=new globalThis.TextEncoder,j=t.encode.bind(t)))(e)}function D(e){let t;return(N??(t=new globalThis.TextDecoder,N=t.decode.bind(t)))(e)}var U,F;class Y{constructor(){U.set(this,void 0),F.set(this,void 0),r(this,U,new Uint8Array,"f"),r(this,F,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?L(e):e;r(this,U,function(e){let t=0;for(const n of e)t+=n.length;const n=new Uint8Array(t);let r=0;for(const t of e)n.set(t,r),r+=t.length;return n}([s(this,U,"f"),t]),"f");const n=[];let i;for(;null!=(i=G(s(this,U,"f"),s(this,F,"f")));){if(i.carriage&&null==s(this,F,"f")){r(this,F,i.index,"f");continue}if(null!=s(this,F,"f")&&(i.index!==s(this,F,"f")+1||i.carriage)){n.push(D(s(this,U,"f").subarray(0,s(this,F,"f")-1))),r(this,U,s(this,U,"f").subarray(s(this,F,"f")),"f"),r(this,F,null,"f");continue}const e=null!==s(this,F,"f")?i.preceding-1:i.preceding,t=D(s(this,U,"f").subarray(0,e));n.push(t),r(this,U,s(this,U,"f").subarray(i.index),"f"),r(this,F,null,"f")}return n}flush(){return s(this,U,"f").length?this.decode("\n"):[]}}function G(e,t){for(let n=t??0;n<e.length;n++){if(10===e[n])return{preceding:n,index:n+1,carriage:!1};if(13===e[n])return{preceding:n,index:n+1,carriage:!0}}return null}function B(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}U=new WeakMap,F=new WeakMap,Y.NEWLINE_CHARS=new Set(["\n","\r"]),Y.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const H={off:0,error:200,warn:300,info:400,debug:500},z=(e,t,n)=>{var r,s;if(e)return r=H,s=e,Object.prototype.hasOwnProperty.call(r,s)?e:void J(n).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(H))}`)};function q(){}function K(e,t,n){return!t||H[e]>H[n]?q:t[e].bind(t)}const W={error:q,warn:q,info:q,debug:q};let V=new WeakMap;function J(e){const t=e.logger,n=e.logLevel??"off";if(!t)return W;const r=V.get(t);if(r&&r[0]===n)return r[1];const s={error:K("error",t,n),warn:K("warn",t,n),info:K("info",t,n),debug:K("debug",t,n)};return V.set(t,[n,s]),s}const Z=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"x-api-key"===e.toLowerCase()||"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);var X,Q,ee;class te{constructor(e,t,n){this.iterator=e,X.set(this,void 0),this.controller=t,r(this,X,n,"f")}static fromSSEResponse(e,t,n){let r=!1;const s=n?J(n):console;return new te(async function*(){if(r)throw new c("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const n of async function*(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new c("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new c("Attempted to iterate over a response with no body")}const n=new ne,r=new Y,s=R(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?L(n):n;let r,s=new Uint8Array(t.length+e.length);for(s.set(t),s.set(e,t.length),t=s;-1!==(r=B(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(s))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t)){if("completion"===n.event)try{yield JSON.parse(n.data)}catch(e){throw s.error("Could not parse message into JSON:",n.data),s.error("From chunk:",n.raw),e}if("message_start"===n.event||"message_delta"===n.event||"message_stop"===n.event||"content_block_start"===n.event||"content_block_delta"===n.event||"content_block_stop"===n.event)try{yield JSON.parse(n.data)}catch(e){throw s.error("Could not parse message into JSON:",n.data),s.error("From chunk:",n.raw),e}if("ping"!==n.event&&"error"===n.event)throw new l(void 0,k(n.data)??n.data,void 0,e.headers)}n=!0}catch(e){if(a(e))return;throw e}finally{n||t.abort()}},t,n)}static fromReadableStream(e,t,n){let r=!1;return new te(async function*(){if(r)throw new c("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const t of async function*(){const t=new Y,n=R(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())n||t&&(yield JSON.parse(t));n=!0}catch(e){if(a(e))return;throw e}finally{n||t.abort()}},t,n)}[(X=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new te(()=>r(e),this.controller,s(this,X,"f")),new te(()=>r(t),this.controller,s(this,X,"f"))]}toReadableStream(){const e=this;let t;return P({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:n,done:r}=await t.next();if(r)return e.close();const s=L(JSON.stringify(n)+"\n");e.enqueue(s)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class ne{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(t);if(-1!==n)return[e.substring(0,n),t,e.substring(n+t.length)];return[e,"",""]}(e,":");return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}async function re(e,t){const{response:n,requestLogID:r,retryOfRequestLogID:s,startTime:i}=t,a=await(async()=>{if(t.options.stream)return J(e).debug("response",n.status,n.url,n.headers,n.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(n,t.controller,e):te.fromSSEResponse(n,t.controller,e);if(204===n.status)return null;if(t.options.__binaryResponse)return n;const r=n.headers.get("content-type"),s=r?.split(";")[0]?.trim();if(s?.includes("application/json")||s?.endsWith("+json")){return se(await n.json(),n)}return await n.text()})();return J(e).debug(`[${r}] response parsed`,Z({retryOfRequestLogID:s,url:n.url,status:n.status,body:a,durationMs:Date.now()-i})),a}function se(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("request-id"),enumerable:!1})}class ie extends Promise{constructor(e,t,n=re){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=n,Q.set(this,void 0),r(this,Q,e,"f")}_thenUnwrap(e){return new ie(s(this,Q,"f"),this.responsePromise,async(t,n)=>se(e(await this.parseResponse(t,n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(s(this,Q,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}Q=new WeakMap;class ae{constructor(e,t,n,s){ee.set(this,void 0),r(this,ee,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new c("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await s(this,ee,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(ee=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class oe extends ie{constructor(e,t,n){super(e,t,async(e,t)=>new n(e,t.response,await re(e,t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}class ce extends ae{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.has_more=n.has_more||!1,this.first_id=n.first_id||null,this.last_id=n.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){if(this.options.query?.before_id){const e=this.first_id;return e?{...this.options,query:{...x(this.options.query),before_id:e}}:null}const e=this.last_id;return e?{...this.options,query:{...x(this.options.query),after_id:e}}:null}}const le=()=>{if("undefined"==typeof File){const{process:e}=globalThis,t="string"==typeof e?.versions?.node&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function ue(e,t,n){return le(),new File(e,t??"unknown_file",n)}function de(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}const he=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],pe=new WeakMap;const me=async(e,t)=>{if(!await function(e){const t="function"==typeof e?e:e.fetch,n=pe.get(t);if(n)return n;const r=(async()=>{try{const e="Response"in t?t.Response:(await t("data:,")).constructor,n=new FormData;return n.toString()!==await new e(n).text()}catch{return!0}})();return pe.set(t,r),r}(t))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const n=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>fe(n,e,t))),n},ge=e=>e instanceof Blob&&"name"in e,fe=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if(n instanceof Response){let r={};const s=n.headers.get("Content-Type");s&&(r={type:s}),e.append(t,ue([await n.blob()],de(n),r))}else if(he(n))e.append(t,ue([await new Response(M(n)).blob()],de(n)));else if(ge(n))e.append(t,ue([n],de(n),{type:n.type}));else if(Array.isArray(n))await Promise.all(n.map(n=>fe(e,t+"[]",n)));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map(([n,r])=>fe(e,`${t}[${n}]`,r)))}}},ye=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function _e(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(ye(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else{if(!he(e)){const t=e?.constructor?.name;throw new Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function(e){if("object"!=typeof e||null===e)return"";const t=Object.getOwnPropertyNames(e);return`; props: [${t.map(e=>`"${e}"`).join(", ")}]`}(e)}`)}for await(const n of e)t.push(...await _e(n))}return t}class be{constructor(e){this._client=e}}const we=Symbol.for("brand.privateNullableHeaders");function*ve(e){if(!e)return;if(we in e){const{values:t,nulls:n}=e;yield*t.entries();for(const e of n)yield[e,null];return}let t,n=!1;e instanceof Headers?t=e.entries():S(e)?t=e:(n=!0,t=Object.entries(e??{}));for(let e of t){const t=e[0];if("string"!=typeof t)throw new TypeError("expected header name to be a string");const r=S(e[1])?e[1]:[e[1]];let s=!1;for(const e of r)void 0!==e&&(n&&!s&&(s=!0,yield[t,null]),yield[t,e])}}const Ee=e=>{const t=new Headers,n=new Set;for(const r of e){const e=new Set;for(const[s,i]of ve(r)){const r=s.toLowerCase();e.has(r)||(t.delete(s),e.add(r)),null===i?(t.delete(s),n.add(r)):(t.append(s,i),n.delete(r))}}return{[we]:!0,values:t,nulls:n}};function Se(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const xe=Object.freeze(Object.create(null)),ke=(e=Se)=>function(t,...n){if(1===t.length)return t[0];let r=!1;const s=[],i=t.reduce((t,i,a)=>{/[?#]/.test(i)&&(r=!0);const o=n[a];let c=(r?encodeURIComponent:e)(""+o);return a!==n.length&&(null==o||"object"==typeof o&&o.toString===Object.getPrototypeOf(Object.getPrototypeOf(o.hasOwnProperty??xe)??xe)?.toString)&&(c=o+"",s.push({start:t.length+i.length,length:c.length,error:`Value of type ${Object.prototype.toString.call(o).slice(8,-1)} is not a valid path parameter`})),t+i+(a===n.length?"":c)},""),a=i.split(/[?#]/,1)[0],o=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;let l;for(;null!==(l=o.exec(a));)s.push({start:l.index,length:l[0].length,error:`Value "${l[0]}" can't be safely passed as a path parameter`});if(s.sort((e,t)=>e.start-t.start),s.length>0){let e=0;const t=s.reduce((t,n)=>{const r=" ".repeat(n.start-e),s="^".repeat(n.length);return e=n.start+n.length,t+r+s},"");throw new c(`Path parameters result in path with invalid segments:\n${s.map(e=>e.error).join("\n")}\n${i}\n${t}`)}return i},Te=ke(Se);class Ie extends be{list(e={},t){const{betas:n,...r}=e??{};return this._client.getAPIList("/v1/files",ce,{query:r,...t,headers:Ee([{"anthropic-beta":[...n??[],"files-api-2025-04-14"].toString()},t?.headers])})}delete(e,t={},n){const{betas:r}=t??{};return this._client.delete(Te`/v1/files/${e}`,{...n,headers:Ee([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},n?.headers])})}download(e,t={},n){const{betas:r}=t??{};return this._client.get(Te`/v1/files/${e}/content`,{...n,headers:Ee([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},n?.headers]),__binaryResponse:!0})}retrieveMetadata(e,t={},n){const{betas:r}=t??{};return this._client.get(Te`/v1/files/${e}`,{...n,headers:Ee([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},n?.headers])})}upload(e,t){const{betas:n,...r}=e;return this._client.post("/v1/files",(async(e,t)=>({...e,body:await me(e.body,t)}))({body:r,...t,headers:Ee([{"anthropic-beta":[...n??[],"files-api-2025-04-14"].toString()},t?.headers])},this._client))}}class Oe extends be{retrieve(e,t={},n){const{betas:r}=t??{};return this._client.get(Te`/v1/models/${e}?beta=true`,{...n,headers:Ee([{...null!=r?.toString()?{"anthropic-beta":r?.toString()}:void 0},n?.headers])})}list(e={},t){const{betas:n,...r}=e??{};return this._client.getAPIList("/v1/models?beta=true",ce,{query:r,...t,headers:Ee([{...null!=n?.toString()?{"anthropic-beta":n?.toString()}:void 0},t?.headers])})}}class Ce{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){const e=new Y;for await(const t of this.iterator)for(const n of e.decode(t))yield JSON.parse(n);for(const t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new c("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new c("Attempted to iterate over a response with no body")}return new Ce(R(e.body),t)}}class Ae extends be{create(e,t){const{betas:n,...r}=e;return this._client.post("/v1/messages/batches?beta=true",{body:r,...t,headers:Ee([{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString()},t?.headers])})}retrieve(e,t={},n){const{betas:r}=t??{};return this._client.get(Te`/v1/messages/batches/${e}?beta=true`,{...n,headers:Ee([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},n?.headers])})}list(e={},t){const{betas:n,...r}=e??{};return this._client.getAPIList("/v1/messages/batches?beta=true",ce,{query:r,...t,headers:Ee([{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString()},t?.headers])})}delete(e,t={},n){const{betas:r}=t??{};return this._client.delete(Te`/v1/messages/batches/${e}?beta=true`,{...n,headers:Ee([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},n?.headers])})}cancel(e,t={},n){const{betas:r}=t??{};return this._client.post(Te`/v1/messages/batches/${e}/cancel?beta=true`,{...n,headers:Ee([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},n?.headers])})}async results(e,t={},n){const r=await this.retrieve(e);if(!r.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);const{betas:s}=t??{};return this._client.get(r.results_url,{...n,headers:Ee([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},n?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((e,t)=>Ce.fromResponse(t.response,t.controller))}}const Pe=e=>{if(0===e.length)return e;let t=e[e.length-1];switch(t.type){case"separator":return e=e.slice(0,e.length-1),Pe(e);case"number":let n=t.value[t.value.length-1];if("."===n||"-"===n)return e=e.slice(0,e.length-1),Pe(e);case"string":let r=e[e.length-2];if("delimiter"===r?.type)return e=e.slice(0,e.length-1),Pe(e);if("brace"===r?.type&&"{"===r.value)return e=e.slice(0,e.length-1),Pe(e);break;case"delimiter":return e=e.slice(0,e.length-1),Pe(e)}return e},Me=e=>JSON.parse((e=>{let t="";return e.map(e=>{"string"===e.type?t+='"'+e.value+'"':t+=e.value}),t})((e=>{let t=[];return e.map(e=>{"brace"===e.type&&("{"===e.value?t.push("}"):t.splice(t.lastIndexOf("}"),1)),"paren"===e.type&&("["===e.value?t.push("]"):t.splice(t.lastIndexOf("]"),1))}),t.length>0&&t.reverse().map(t=>{"}"===t?e.push({type:"brace",value:"}"}):"]"===t&&e.push({type:"paren",value:"]"})}),e})(Pe((e=>{let t=0,n=[];for(;t<e.length;){let r=e[t];if("\\"===r){t++;continue}if("{"===r){n.push({type:"brace",value:"{"}),t++;continue}if("}"===r){n.push({type:"brace",value:"}"}),t++;continue}if("["===r){n.push({type:"paren",value:"["}),t++;continue}if("]"===r){n.push({type:"paren",value:"]"}),t++;continue}if(":"===r){n.push({type:"separator",value:":"}),t++;continue}if(","===r){n.push({type:"delimiter",value:","}),t++;continue}if('"'===r){let s="",i=!1;for(r=e[++t];'"'!==r;){if(t===e.length){i=!0;break}if("\\"===r){if(t++,t===e.length){i=!0;break}s+=r+e[t],r=e[++t]}else s+=r,r=e[++t]}r=e[++t],i||n.push({type:"string",value:s});continue}if(r&&/\s/.test(r)){t++;continue}let s=/[0-9]/;if(r&&s.test(r)||"-"===r||"."===r){let i="";for("-"===r&&(i+=r,r=e[++t]);r&&s.test(r)||"."===r;)i+=r,r=e[++t];n.push({type:"number",value:i});continue}let i=/[a-z]/i;if(r&&i.test(r)){let s="";for(;r&&i.test(r)&&t!==e.length;)s+=r,r=e[++t];if("true"!=s&&"false"!=s&&"null"!==s){t++;continue}n.push({type:"name",value:s});continue}t++}return n})(e)))));var Re,$e,je,Ne,Le,De,Ue,Fe,Ye,Ge,Be,He,ze,qe,Ke,We,Ve,Je,Ze,Xe,Qe,et;const tt="__json_buf";function nt(e){return"tool_use"===e.type||"server_tool_use"===e.type||"mcp_tool_use"===e.type}class rt{constructor(){Re.add(this),this.messages=[],this.receivedMessages=[],$e.set(this,void 0),this.controller=new AbortController,je.set(this,void 0),Ne.set(this,()=>{}),Le.set(this,()=>{}),De.set(this,void 0),Ue.set(this,()=>{}),Fe.set(this,()=>{}),Ye.set(this,{}),Ge.set(this,!1),Be.set(this,!1),He.set(this,!1),ze.set(this,!1),qe.set(this,void 0),Ke.set(this,void 0),Je.set(this,e=>{if(r(this,Be,!0,"f"),a(e)&&(e=new u),e instanceof u)return r(this,He,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){const t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),r(this,je,new Promise((e,t)=>{r(this,Ne,e,"f"),r(this,Le,t,"f")}),"f"),r(this,De,new Promise((e,t)=>{r(this,Ue,e,"f"),r(this,Fe,t,"f")}),"f"),s(this,je,"f").catch(()=>{}),s(this,De,"f").catch(()=>{})}get response(){return s(this,qe,"f")}get request_id(){return s(this,Ke,"f")}async withResponse(){const e=await s(this,je,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){const t=new rt;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,n){const r=new rt;for(const e of t.messages)r._addMessageParam(e);return r._run(()=>r._createMessage(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},s(this,Je,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){const r=n?.signal;let i;r&&(r.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),r.addEventListener("abort",i));try{s(this,Re,"m",Ze).call(this);const{response:r,data:i}=await e.create({...t,stream:!0},{...n,signal:this.controller.signal}).withResponse();this._connected(r);for await(const e of i)s(this,Re,"m",Xe).call(this,e);if(i.controller.signal?.aborted)throw new u;s(this,Re,"m",Qe).call(this)}finally{r&&i&&r.removeEventListener("abort",i)}}_connected(e){this.ended||(r(this,qe,e,"f"),r(this,Ke,e?.headers.get("request-id"),"f"),s(this,Ne,"f").call(this,e),this._emit("connect"))}get ended(){return s(this,Ge,"f")}get errored(){return s(this,Be,"f")}get aborted(){return s(this,He,"f")}abort(){this.controller.abort()}on(e,t){return(s(this,Ye,"f")[e]||(s(this,Ye,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=s(this,Ye,"f")[e];if(!n)return this;const r=n.findIndex(e=>e.listener===t);return r>=0&&n.splice(r,1),this}once(e,t){return(s(this,Ye,"f")[e]||(s(this,Ye,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{r(this,ze,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)})}async done(){r(this,ze,!0,"f"),await s(this,De,"f")}get currentMessage(){return s(this,$e,"f")}async finalMessage(){return await this.done(),s(this,Re,"m",We).call(this)}async finalText(){return await this.done(),s(this,Re,"m",Ve).call(this)}_emit(e,...t){if(s(this,Ge,"f"))return;"end"===e&&(r(this,Ge,!0,"f"),s(this,Ue,"f").call(this));const n=s(this,Ye,"f")[e];if(n&&(s(this,Ye,"f")[e]=n.filter(e=>!e.once),n.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return s(this,ze,"f")||n?.length||Promise.reject(e),s(this,Le,"f").call(this,e),s(this,Fe,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];s(this,ze,"f")||n?.length||Promise.reject(e),s(this,Le,"f").call(this,e),s(this,Fe,"f").call(this,e),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",s(this,Re,"m",We).call(this))}async _fromReadableStream(e,t){const n=t?.signal;let r;n&&(n.aborted&&this.controller.abort(),r=this.controller.abort.bind(this.controller),n.addEventListener("abort",r));try{s(this,Re,"m",Ze).call(this),this._connected(null);const t=te.fromReadableStream(e,this.controller);for await(const e of t)s(this,Re,"m",Xe).call(this,e);if(t.controller.signal?.aborted)throw new u;s(this,Re,"m",Qe).call(this)}finally{n&&r&&n.removeEventListener("abort",r)}}[($e=new WeakMap,je=new WeakMap,Ne=new WeakMap,Le=new WeakMap,De=new WeakMap,Ue=new WeakMap,Fe=new WeakMap,Ye=new WeakMap,Ge=new WeakMap,Be=new WeakMap,He=new WeakMap,ze=new WeakMap,qe=new WeakMap,Ke=new WeakMap,Je=new WeakMap,Re=new WeakSet,We=function(){if(0===this.receivedMessages.length)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Ve=function(){if(0===this.receivedMessages.length)throw new c("stream ended without producing a Message with role=assistant");const e=this.receivedMessages.at(-1).content.filter(e=>"text"===e.type).map(e=>e.text);if(0===e.length)throw new c("stream ended without producing a content block with type=text");return e.join(" ")},Ze=function(){this.ended||r(this,$e,void 0,"f")},Xe=function(e){if(this.ended)return;const t=s(this,Re,"m",et).call(this,e);switch(this._emit("streamEvent",e,t),e.type){case"content_block_delta":{const n=t.content.at(-1);switch(e.delta.type){case"text_delta":"text"===n.type&&this._emit("text",e.delta.text,n.text||"");break;case"citations_delta":"text"===n.type&&this._emit("citation",e.delta.citation,n.citations??[]);break;case"input_json_delta":nt(n)&&n.input&&this._emit("inputJson",e.delta.partial_json,n.input);break;case"thinking_delta":"thinking"===n.type&&this._emit("thinking",e.delta.thinking,n.thinking);break;case"signature_delta":"thinking"===n.type&&this._emit("signature",n.signature);break;default:e.delta}break}case"message_stop":this._addMessageParam(t),this._addMessage(t,!0);break;case"content_block_stop":this._emit("contentBlock",t.content.at(-1));break;case"message_start":r(this,$e,t,"f")}},Qe=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");const e=s(this,$e,"f");if(!e)throw new c("request ended without sending any chunks");return r(this,$e,void 0,"f"),e},et=function(e){let t=s(this,$e,"f");if("message_start"===e.type){if(t)throw new c(`Unexpected event order, got ${e.type} before receiving "message_stop"`);return e.message}if(!t)throw new c(`Unexpected event order, got ${e.type} before "message_start"`);switch(e.type){case"message_stop":case"content_block_stop":return t;case"message_delta":return t.container=e.delta.container,t.stop_reason=e.delta.stop_reason,t.stop_sequence=e.delta.stop_sequence,t.usage.output_tokens=e.usage.output_tokens,null!=e.usage.input_tokens&&(t.usage.input_tokens=e.usage.input_tokens),null!=e.usage.cache_creation_input_tokens&&(t.usage.cache_creation_input_tokens=e.usage.cache_creation_input_tokens),null!=e.usage.cache_read_input_tokens&&(t.usage.cache_read_input_tokens=e.usage.cache_read_input_tokens),null!=e.usage.server_tool_use&&(t.usage.server_tool_use=e.usage.server_tool_use),t;case"content_block_start":return t.content.push(e.content_block),t;case"content_block_delta":{const n=t.content.at(e.index);switch(e.delta.type){case"text_delta":"text"===n?.type&&(t.content[e.index]={...n,text:(n.text||"")+e.delta.text});break;case"citations_delta":"text"===n?.type&&(t.content[e.index]={...n,citations:[...n.citations??[],e.delta.citation]});break;case"input_json_delta":if(n&&nt(n)){let r=n[tt]||"";r+=e.delta.partial_json;const i={...n};if(Object.defineProperty(i,tt,{value:r,enumerable:!1,writable:!0}),r)try{i.input=Me(r)}catch(e){const t=new c(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${e}. JSON: ${r}`);s(this,Je,"f").call(this,t)}t.content[e.index]=i}break;case"thinking_delta":"thinking"===n?.type&&(t.content[e.index]={...n,thinking:n.thinking+e.delta.thinking});break;case"signature_delta":"thinking"===n?.type&&(t.content[e.index]={...n,signature:e.delta.signature});break;default:e.delta}return t}}},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("streamEvent",n=>{const r=t.shift();r?r.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new te(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}const st={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192};class it extends be{constructor(){super(...arguments),this.batches=new Ae(this._client)}create(e,t){const{betas:n,...r}=e;r.model;let s=this._client._options.timeout;if(!r.stream&&null==s){const e=st[r.model]??void 0;s=this._client.calculateNonstreamingTimeout(r.max_tokens,e)}return this._client.post("/v1/messages?beta=true",{body:r,timeout:s??6e5,...t,headers:Ee([{...null!=n?.toString()?{"anthropic-beta":n?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}stream(e,t){return rt.createMessage(this,e,t)}countTokens(e,t){const{betas:n,...r}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:r,...t,headers:Ee([{"anthropic-beta":[...n??[],"token-counting-2024-11-01"].toString()},t?.headers])})}}it.Batches=Ae;class at extends be{constructor(){super(...arguments),this.models=new Oe(this._client),this.messages=new it(this._client),this.files=new Ie(this._client)}}at.Models=Oe,at.Messages=it,at.Files=Ie;class ot extends be{create(e,t){const{betas:n,...r}=e;return this._client.post("/v1/complete",{body:r,timeout:this._client._options.timeout??6e5,...t,headers:Ee([{...null!=n?.toString()?{"anthropic-beta":n?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}}var ct,lt,ut,dt,ht,pt,mt,gt,ft,yt,_t,bt,wt,vt,Et,St,xt,kt,Tt,It,Ot,Ct;const At="__json_buf";function Pt(e){return"tool_use"===e.type||"server_tool_use"===e.type}class Mt{constructor(){ct.add(this),this.messages=[],this.receivedMessages=[],lt.set(this,void 0),this.controller=new AbortController,ut.set(this,void 0),dt.set(this,()=>{}),ht.set(this,()=>{}),pt.set(this,void 0),mt.set(this,()=>{}),gt.set(this,()=>{}),ft.set(this,{}),yt.set(this,!1),_t.set(this,!1),bt.set(this,!1),wt.set(this,!1),vt.set(this,void 0),Et.set(this,void 0),kt.set(this,e=>{if(r(this,_t,!0,"f"),a(e)&&(e=new u),e instanceof u)return r(this,bt,!0,"f"),this._emit("abort",e);if(e instanceof c)return this._emit("error",e);if(e instanceof Error){const t=new c(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new c(String(e)))}),r(this,ut,new Promise((e,t)=>{r(this,dt,e,"f"),r(this,ht,t,"f")}),"f"),r(this,pt,new Promise((e,t)=>{r(this,mt,e,"f"),r(this,gt,t,"f")}),"f"),s(this,ut,"f").catch(()=>{}),s(this,pt,"f").catch(()=>{})}get response(){return s(this,vt,"f")}get request_id(){return s(this,Et,"f")}async withResponse(){const e=await s(this,ut,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){const t=new Mt;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,n){const r=new Mt;for(const e of t.messages)r._addMessageParam(e);return r._run(()=>r._createMessage(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},s(this,kt,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){const r=n?.signal;let i;r&&(r.aborted&&this.controller.abort(),i=this.controller.abort.bind(this.controller),r.addEventListener("abort",i));try{s(this,ct,"m",Tt).call(this);const{response:r,data:i}=await e.create({...t,stream:!0},{...n,signal:this.controller.signal}).withResponse();this._connected(r);for await(const e of i)s(this,ct,"m",It).call(this,e);if(i.controller.signal?.aborted)throw new u;s(this,ct,"m",Ot).call(this)}finally{r&&i&&r.removeEventListener("abort",i)}}_connected(e){this.ended||(r(this,vt,e,"f"),r(this,Et,e?.headers.get("request-id"),"f"),s(this,dt,"f").call(this,e),this._emit("connect"))}get ended(){return s(this,yt,"f")}get errored(){return s(this,_t,"f")}get aborted(){return s(this,bt,"f")}abort(){this.controller.abort()}on(e,t){return(s(this,ft,"f")[e]||(s(this,ft,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=s(this,ft,"f")[e];if(!n)return this;const r=n.findIndex(e=>e.listener===t);return r>=0&&n.splice(r,1),this}once(e,t){return(s(this,ft,"f")[e]||(s(this,ft,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{r(this,wt,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)})}async done(){r(this,wt,!0,"f"),await s(this,pt,"f")}get currentMessage(){return s(this,lt,"f")}async finalMessage(){return await this.done(),s(this,ct,"m",St).call(this)}async finalText(){return await this.done(),s(this,ct,"m",xt).call(this)}_emit(e,...t){if(s(this,yt,"f"))return;"end"===e&&(r(this,yt,!0,"f"),s(this,mt,"f").call(this));const n=s(this,ft,"f")[e];if(n&&(s(this,ft,"f")[e]=n.filter(e=>!e.once),n.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return s(this,wt,"f")||n?.length||Promise.reject(e),s(this,ht,"f").call(this,e),s(this,gt,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];s(this,wt,"f")||n?.length||Promise.reject(e),s(this,ht,"f").call(this,e),s(this,gt,"f").call(this,e),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",s(this,ct,"m",St).call(this))}async _fromReadableStream(e,t){const n=t?.signal;let r;n&&(n.aborted&&this.controller.abort(),r=this.controller.abort.bind(this.controller),n.addEventListener("abort",r));try{s(this,ct,"m",Tt).call(this),this._connected(null);const t=te.fromReadableStream(e,this.controller);for await(const e of t)s(this,ct,"m",It).call(this,e);if(t.controller.signal?.aborted)throw new u;s(this,ct,"m",Ot).call(this)}finally{n&&r&&n.removeEventListener("abort",r)}}[(lt=new WeakMap,ut=new WeakMap,dt=new WeakMap,ht=new WeakMap,pt=new WeakMap,mt=new WeakMap,gt=new WeakMap,ft=new WeakMap,yt=new WeakMap,_t=new WeakMap,bt=new WeakMap,wt=new WeakMap,vt=new WeakMap,Et=new WeakMap,kt=new WeakMap,ct=new WeakSet,St=function(){if(0===this.receivedMessages.length)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},xt=function(){if(0===this.receivedMessages.length)throw new c("stream ended without producing a Message with role=assistant");const e=this.receivedMessages.at(-1).content.filter(e=>"text"===e.type).map(e=>e.text);if(0===e.length)throw new c("stream ended without producing a content block with type=text");return e.join(" ")},Tt=function(){this.ended||r(this,lt,void 0,"f")},It=function(e){if(this.ended)return;const t=s(this,ct,"m",Ct).call(this,e);switch(this._emit("streamEvent",e,t),e.type){case"content_block_delta":{const n=t.content.at(-1);switch(e.delta.type){case"text_delta":"text"===n.type&&this._emit("text",e.delta.text,n.text||"");break;case"citations_delta":"text"===n.type&&this._emit("citation",e.delta.citation,n.citations??[]);break;case"input_json_delta":Pt(n)&&n.input&&this._emit("inputJson",e.delta.partial_json,n.input);break;case"thinking_delta":"thinking"===n.type&&this._emit("thinking",e.delta.thinking,n.thinking);break;case"signature_delta":"thinking"===n.type&&this._emit("signature",n.signature);break;default:e.delta}break}case"message_stop":this._addMessageParam(t),this._addMessage(t,!0);break;case"content_block_stop":this._emit("contentBlock",t.content.at(-1));break;case"message_start":r(this,lt,t,"f")}},Ot=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");const e=s(this,lt,"f");if(!e)throw new c("request ended without sending any chunks");return r(this,lt,void 0,"f"),e},Ct=function(e){let t=s(this,lt,"f");if("message_start"===e.type){if(t)throw new c(`Unexpected event order, got ${e.type} before receiving "message_stop"`);return e.message}if(!t)throw new c(`Unexpected event order, got ${e.type} before "message_start"`);switch(e.type){case"message_stop":case"content_block_stop":return t;case"message_delta":return t.stop_reason=e.delta.stop_reason,t.stop_sequence=e.delta.stop_sequence,t.usage.output_tokens=e.usage.output_tokens,null!=e.usage.input_tokens&&(t.usage.input_tokens=e.usage.input_tokens),null!=e.usage.cache_creation_input_tokens&&(t.usage.cache_creation_input_tokens=e.usage.cache_creation_input_tokens),null!=e.usage.cache_read_input_tokens&&(t.usage.cache_read_input_tokens=e.usage.cache_read_input_tokens),null!=e.usage.server_tool_use&&(t.usage.server_tool_use=e.usage.server_tool_use),t;case"content_block_start":return t.content.push({...e.content_block}),t;case"content_block_delta":{const n=t.content.at(e.index);switch(e.delta.type){case"text_delta":"text"===n?.type&&(t.content[e.index]={...n,text:(n.text||"")+e.delta.text});break;case"citations_delta":"text"===n?.type&&(t.content[e.index]={...n,citations:[...n.citations??[],e.delta.citation]});break;case"input_json_delta":if(n&&Pt(n)){let r=n[At]||"";r+=e.delta.partial_json;const s={...n};Object.defineProperty(s,At,{value:r,enumerable:!1,writable:!0}),r&&(s.input=Me(r)),t.content[e.index]=s}break;case"thinking_delta":"thinking"===n?.type&&(t.content[e.index]={...n,thinking:n.thinking+e.delta.thinking});break;case"signature_delta":"thinking"===n?.type&&(t.content[e.index]={...n,signature:e.delta.signature});break;default:e.delta}return t}}},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("streamEvent",n=>{const r=t.shift();r?r.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new te(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}class Rt extends be{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(Te`/v1/messages/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/v1/messages/batches",ce,{query:e,...t})}delete(e,t){return this._client.delete(Te`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(Te`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){const n=await this.retrieve(e);if(!n.results_url)throw new c(`No batch \`results_url\`; Has it finished processing? ${n.processing_status} - ${n.id}`);return this._client.get(n.results_url,{...t,headers:Ee([{Accept:"application/binary"},t?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((e,t)=>Ce.fromResponse(t.response,t.controller))}}class $t extends be{constructor(){super(...arguments),this.batches=new Rt(this._client)}create(e,t){e.model;let n=this._client._options.timeout;if(!e.stream&&null==n){const t=st[e.model]??void 0;n=this._client.calculateNonstreamingTimeout(e.max_tokens,t)}return this._client.post("/v1/messages",{body:e,timeout:n??6e5,...t,stream:e.stream??!1})}stream(e,t){return Mt.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}}$t.Batches=Rt;class jt extends be{retrieve(e,t={},n){const{betas:r}=t??{};return this._client.get(Te`/v1/models/${e}`,{...n,headers:Ee([{...null!=r?.toString()?{"anthropic-beta":r?.toString()}:void 0},n?.headers])})}list(e={},t){const{betas:n,...r}=e??{};return this._client.getAPIList("/v1/models",ce,{query:r,...t,headers:Ee([{...null!=n?.toString()?{"anthropic-beta":n?.toString()}:void 0},t?.headers])})}}const Nt=e=>void 0!==globalThis.process?globalThis.process.env?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;var Lt,Dt,Ut,Ft;class Yt{constructor({baseURL:e=Nt("ANTHROPIC_BASE_URL"),apiKey:t=Nt("ANTHROPIC_API_KEY")??null,authToken:n=Nt("ANTHROPIC_AUTH_TOKEN")??null,...s}={}){Lt.add(this),Ut.set(this,void 0);const i={apiKey:t,authToken:n,...s,baseURL:e||"https://api.anthropic.com"};if(!i.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new c("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew Anthropic({ apiKey, dangerouslyAllowBrowser: true });\n");this.baseURL=i.baseURL,this.timeout=i.timeout??Dt.DEFAULT_TIMEOUT,this.logger=i.logger??console;const a="warn";this.logLevel=a,this.logLevel=z(i.logLevel,"ClientOptions.logLevel",this)??z(Nt("ANTHROPIC_LOG"),"process.env['ANTHROPIC_LOG']",this)??a,this.fetchOptions=i.fetchOptions,this.maxRetries=i.maxRetries??2,this.fetch=i.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new Anthropic({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),r(this,Ut,$,"f"),this._options=i,this.apiKey=t,this.authToken=n}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,authToken:this.authToken,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(this.apiKey&&e.get("x-api-key")||t.has("x-api-key")||this.authToken&&e.get("authorization")||t.has("authorization")))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){return Ee([this.apiKeyAuth(e),this.bearerAuth(e)])}apiKeyAuth(e){if(null!=this.apiKey)return Ee([{"X-Api-Key":this.apiKey}])}bearerAuth(e){if(null!=this.authToken)return Ee([{Authorization:`Bearer ${this.authToken}`}])}stringifyQuery(e){return Object.entries(e).filter(([e,t])=>void 0!==t).map(([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new c(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${T}`}defaultIdempotencyKey(){return`stainless-node-retry-${i()}`}makeStatusError(e,t,n,r){return l.generate(e,t,n,r)}buildURL(e,t,n){const r=!s(this,Lt,"m",Ft).call(this)&&n||this.baseURL,i=(e=>v.test(e))(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return function(e){if(!e)return!0;for(const t in e)return!1;return!0}(a)||(t={...a,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new c("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#streaming-responses for more details");return 6e5}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(n=>({method:e,path:t,...n})))}request(e,t=null){return new ie(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,n){const r=await e,s=r.maxRetries??this.maxRetries;null==t&&(t=s),await this.prepareOptions(r);const{req:i,url:c,timeout:l}=this.buildRequest(r,{retryCount:s-t});await this.prepareRequest(i,{url:c,options:r});const p="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),m=void 0===n?"":`, retryOf: ${n}`,g=Date.now();if(J(this).debug(`[${p}] sending request`,Z({retryOfRequestLogID:n,method:r.method,url:c,options:r,headers:i.headers})),r.signal?.aborted)throw new u;const f=new AbortController,y=await this.fetchWithTimeout(c,i,l,f).catch(o),_=Date.now();if(y instanceof Error){const e=`retrying, ${t} attempts remaining`;if(r.signal?.aborted)throw new u;const s=a(y)||/timed? ?out/i.test(String(y)+("cause"in y?String(y.cause):""));if(t)return J(this).info(`[${p}] connection ${s?"timed out":"failed"} - ${e}`),J(this).debug(`[${p}] connection ${s?"timed out":"failed"} (${e})`,Z({retryOfRequestLogID:n,url:c,durationMs:_-g,message:y.message})),this.retryRequest(r,t,n??p);if(J(this).info(`[${p}] connection ${s?"timed out":"failed"} - error; no more retries left`),J(this).debug(`[${p}] connection ${s?"timed out":"failed"} (error; no more retries left)`,Z({retryOfRequestLogID:n,url:c,durationMs:_-g,message:y.message})),s)throw new h;throw new d({cause:y})}const b=`[${p}${m}${[...y.headers.entries()].filter(([e])=>"request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join("")}] ${i.method} ${c} ${y.ok?"succeeded":"failed"} with status ${y.status} in ${_-g}ms`;if(!y.ok){const e=this.shouldRetry(y);if(t&&e){const e=`retrying, ${t} attempts remaining`;return await async function(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void await(e[Symbol.asyncIterator]().return?.());const t=e.getReader(),n=t.cancel();t.releaseLock(),await n}(y.body),J(this).info(`${b} - ${e}`),J(this).debug(`[${p}] response error (${e})`,Z({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,durationMs:_-g})),this.retryRequest(r,t,n??p,y.headers)}const s=e?"error; no more retries left":"error; not retryable";J(this).info(`${b} - ${s}`);const i=await y.text().catch(e=>o(e).message),a=k(i),c=a?void 0:i;J(this).debug(`[${p}] response error (${s})`,Z({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,message:c,durationMs:Date.now()-g}));throw this.makeStatusError(y.status,a,c,y.headers)}return J(this).info(b),J(this).debug(`[${p}] response start`,Z({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,durationMs:_-g})),{response:y,options:r,controller:f,requestLogID:p,retryOfRequestLogID:n,startTime:g}}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}requestAPIList(e,t){const n=this.makeRequest(t,null,void 0);return new oe(this,n,e)}async fetchWithTimeout(e,t,n,r){const{signal:s,method:i,...a}=t||{};s&&s.addEventListener("abort",()=>r.abort());const o=setTimeout(()=>r.abort(),n),c=globalThis.ReadableStream&&a.body instanceof globalThis.ReadableStream||"object"==typeof a.body&&null!==a.body&&Symbol.asyncIterator in a.body,l={signal:r.signal,...c?{duplex:"half"}:{},method:"GET",...a};i&&(l.method=i.toUpperCase());try{return await this.fetch.call(void 0,e,l)}finally{clearTimeout(o)}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,n,r){let s;const i=r?.get("retry-after-ms");if(i){const e=parseFloat(i);Number.isNaN(e)||(s=e)}const a=r?.get("retry-after");if(a&&!s){const e=parseFloat(a);s=Number.isNaN(e)?Date.parse(a)-Date.now():1e3*e}if(!(s&&0<=s&&s<6e4)){const n=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,n)}var o;return await(o=s,new Promise(e=>setTimeout(e,o))),this.makeRequest(e,t-1,n)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}calculateNonstreamingTimeout(e,t){const n=6e5;if(36e5*e/128e3>n||null!=t&&e>t)throw new c("Streaming is strongly recommended for operations that may token longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#long-requests for more details");return n}buildRequest(e,{retryCount:t=0}={}){const n={...e},{method:r,path:s,query:i,defaultBaseURL:a}=n,o=this.buildURL(s,i,a);"timeout"in n&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new c(`${e} must be an integer`);if(t<0)throw new c(`${e} must be a positive integer`)})("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const{bodyHeaders:l,body:u}=this.buildBody({options:n});return{req:{method:r,headers:this.buildHeaders({options:e,method:r,bodyHeaders:l,retryCount:t}),...n.signal&&{signal:n.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...this.fetchOptions??{},...n.fetchOptions??{}},url:o,timeout:n.timeout}}buildHeaders({options:e,method:t,bodyHeaders:n,retryCount:r}){let s={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);const i=Ee([s,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...A??(A=I()),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01"},this.authHeaders(e),this._options.defaultHeaders,n,e.headers]);return this.validateHeaders(i),i.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const n=Ee([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&n.values.has("content-type")||e instanceof Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:M(e)}:s(this,Ut,"f").call(this,{body:e,headers:n})}}Dt=Yt,Ut=new WeakMap,Lt=new WeakSet,Ft=function(){return"https://api.anthropic.com"!==this.baseURL},Yt.Anthropic=Dt,Yt.HUMAN_PROMPT="\n\nHuman:",Yt.AI_PROMPT="\n\nAssistant:",Yt.DEFAULT_TIMEOUT=6e5,Yt.AnthropicError=c,Yt.APIError=l,Yt.APIConnectionError=d,Yt.APIConnectionTimeoutError=h,Yt.APIUserAbortError=u,Yt.NotFoundError=f,Yt.ConflictError=y,Yt.RateLimitError=b,Yt.BadRequestError=p,Yt.AuthenticationError=m,Yt.InternalServerError=w,Yt.PermissionDeniedError=g,Yt.UnprocessableEntityError=_,Yt.toFile=async function(e,t,n){if(le(),e=await e,t||(t=de(e)),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&ye(e))(e))return e instanceof File&&null==t&&null==n?e:ue([await e.arrayBuffer()],t??e.name,{type:e.type,lastModified:e.lastModified,...n});if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const r=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),ue(await _e(r),t,n)}const r=await _e(e);if(!n?.type){const e=r.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(n={...n,type:e})}return ue(r,t,n)};class Gt extends Yt{constructor(){super(...arguments),this.completions=new ot(this),this.messages=new $t(this),this.models=new jt(this),this.beta=new at(this)}}Gt.Completions=ot,Gt.Messages=$t,Gt.Models=jt,Gt.Beta=at;const{HUMAN_PROMPT:Bt,AI_PROMPT:Ht}=Gt;var zt=n(9497),qt=n(3279),Kt=n(9583),Wt=n(1830),Vt=n(2778),Jt=n(6615),Zt=n(8687),Xt=n(7942),Qt=n(194),en=n(8557);class tn extends en.vd{static lc_name(){return"AnthropicToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","anthropic","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){let t=e;if("string"==typeof e)try{t=JSON.parse(e)}catch(t){throw new en.CC(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.message)}`,e)}else t=e;if(void 0===this.zodSchema)return t;const n=await(0,Xt.K3)(this.zodSchema,t);if(n.success)return n.data;throw new en.CC(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(n.error.issues)}`,JSON.stringify(t,null,2))}async parseResult(e){const t=e.flatMap(e=>{const{message:t}=e;if(!Array.isArray(t.content))return[];return nn(t.content)[0]});if(void 0===t[0])throw new Error("No parseable tool calls provided to AnthropicToolsOutputParser.");const[n]=t;return await this._validateResult(n.args)}}function nn(e){const t=[];for(const n of e)"tool_use"===n.type&&t.push({name:n.name,args:n.input,id:n.id,type:"tool_call"});return t}function rn(e){const t=(0,zt.Q7)({dataUrl:e});if(t)return{type:"base64",media_type:t.mime_type,data:t.data};let n;try{n=new URL(e)}catch{throw new Error([`Malformed image URL: ${JSON.stringify(e)}. Content blocks of type 'image_url' must be a valid http, https, or base64-encoded data URL.`,"Example: data:image/png;base64,/9j/4AAQSk...","Example: https://example.com/image.jpg"].join("\n\n"))}if("http:"===n.protocol||"https:"===n.protocol)return{type:"url",url:e};throw new Error([`Invalid image URL protocol: ${JSON.stringify(n.protocol)}. Anthropic only supports images as http, https, or base64-encoded data URLs on 'image_url' content blocks.`,"Example: data:image/png;base64,/9j/4AAQSk...","Example: https://example.com/image.jpg"].join("\n\n"))}function sn(e){if(void 0===e.id)throw new Error('Anthropic requires all tool calls to have an "id".');return{type:"tool_use",id:e.id,name:e.name,input:e.args}}const an={providerName:"anthropic",fromStandardTextBlock:e=>({type:"text",text:e.text,..."citations"in(e.metadata??{})?{citations:e.metadata.citations}:{},..."cache_control"in(e.metadata??{})?{cache_control:e.metadata.cache_control}:{}}),fromStandardImageBlock(e){if("url"===e.source_type){const t=(0,zt.Q7)({dataUrl:e.url,asTypedArray:!1});return t?{type:"image",source:{type:"base64",data:t.data,media_type:t.mime_type},..."cache_control"in(e.metadata??{})?{cache_control:e.metadata.cache_control}:{}}:{type:"image",source:{type:"url",url:e.url,media_type:e.mime_type??""},..."cache_control"in(e.metadata??{})?{cache_control:e.metadata.cache_control}:{}}}if("base64"===e.source_type)return{type:"image",source:{type:"base64",data:e.data,media_type:e.mime_type??""},..."cache_control"in(e.metadata??{})?{cache_control:e.metadata.cache_control}:{}};throw new Error(`Unsupported image source type: ${e.source_type}`)},fromStandardFileBlock(e){const t=(e.mime_type??"").split(";")[0];if("url"===e.source_type){if("application/pdf"===t||""===t)return{type:"document",source:{type:"url",url:e.url,media_type:e.mime_type??""},..."cache_control"in(e.metadata??{})?{cache_control:e.metadata.cache_control}:{},..."citations"in(e.metadata??{})?{citations:e.metadata.citations}:{},..."context"in(e.metadata??{})?{context:e.metadata.context}:{},..."title"in(e.metadata??{})?{title:e.metadata.title}:{}};throw new Error(`Unsupported file mime type for file url source: ${e.mime_type}`)}if("text"===e.source_type){if("text/plain"===t||""===t)return{type:"document",source:{type:"text",data:e.text,media_type:e.mime_type??""},..."cache_control"in(e.metadata??{})?{cache_control:e.metadata.cache_control}:{},..."citations"in(e.metadata??{})?{citations:e.metadata.citations}:{},..."context"in(e.metadata??{})?{context:e.metadata.context}:{},..."title"in(e.metadata??{})?{title:e.metadata.title}:{}};throw new Error(`Unsupported file mime type for file text source: ${e.mime_type}`)}if("base64"===e.source_type){if("application/pdf"===t||""===t)return{type:"document",source:{type:"base64",data:e.data,media_type:"application/pdf"},..."cache_control"in(e.metadata??{})?{cache_control:e.metadata.cache_control}:{},..."citations"in(e.metadata??{})?{citations:e.metadata.citations}:{},..."context"in(e.metadata??{})?{context:e.metadata.context}:{},..."title"in(e.metadata??{})?{title:e.metadata.title}:{}};if(["image/jpeg","image/png","image/gif","image/webp"].includes(t))return{type:"document",source:{type:"content",content:[{type:"image",source:{type:"base64",data:e.data,media_type:t}}]},..."cache_control"in(e.metadata??{})?{cache_control:e.metadata.cache_control}:{},..."citations"in(e.metadata??{})?{citations:e.metadata.citations}:{},..."context"in(e.metadata??{})?{context:e.metadata.context}:{},..."title"in(e.metadata??{})?{title:e.metadata.title}:{}};throw new Error(`Unsupported file mime type for file base64 source: ${e.mime_type}`)}throw new Error(`Unsupported file source type: ${e.source_type}`)}};function on(e){const t=["tool_use","tool_result","input_json_delta","server_tool_use","web_search_tool_result","web_search_result"],n=["text","text_delta"],{content:r}=e;if("string"==typeof r)return r;return r.map(r=>{if((0,zt.Fz)(r))return(0,zt.up)(r,an);const s="cache_control"in r?r.cache_control:void 0;if("image_url"===r.type){let e;return e="string"==typeof r.image_url?rn(r.image_url):rn(r.image_url.url),{type:"image",source:e,...s?{cache_control:s}:{}}}if(null!=(i=r)&&"object"==typeof i&&"type"in i&&"image"===i.type&&"source"in i&&"object"==typeof i.source&&null!=i.source&&"type"in i.source&&("base64"===i.source.type?"media_type"in i.source&&"string"==typeof i.source.media_type&&"data"in i.source&&"string"==typeof i.source.data:"url"===i.source.type&&"url"in i.source&&"string"==typeof i.source.url))return r;if("document"===r.type)return{...r,...s?{cache_control:s}:{}};if("thinking"===r.type){return{type:"thinking",thinking:r.thinking,signature:r.signature,...s?{cache_control:s}:{}}}if("redacted_thinking"===r.type){return{type:"redacted_thinking",data:r.data,...s?{cache_control:s}:{}}}if("search_result"===r.type){return{type:"search_result",title:r.title,source:r.source,..."cache_control"in r&&r.cache_control?{cache_control:r.cache_control}:{},..."citations"in r&&r.citations?{citations:r.citations}:{},content:r.content}}if(n.find(e=>e===r.type)&&"text"in r)return{type:"text",text:r.text,...s?{cache_control:s}:{},..."citations"in r&&r.citations?{citations:r.citations}:{}};if(t.find(e=>e===r.type)){const e={...r};if("index"in e&&delete e.index,"input_json_delta"===e.type&&(e.type="tool_use"),"input"in e&&"string"==typeof e.input)try{e.input=JSON.parse(e.input)}catch{e.input={}}return{...e,...s?{cache_control:s}:{}}}if("functionCall"in r&&r.functionCall&&"object"==typeof r.functionCall&&(0,zt.KX)(e)){const t=e.tool_calls?.find(e=>e.name===r.functionCall.name);if(!t)throw new Error(`Could not find tool call for function call ${r.functionCall.name}`);return{id:t.id,type:"tool_use",name:t.name,input:r.functionCall.args}}throw new Error("Unsupported message content format");var i})}function cn(e){const t=function(e){const t=[];for(const n of e)if("tool"===n._getType())if("string"==typeof n.content){const e=t[t.length-1];"human"===e?._getType()&&Array.isArray(e.content)&&"type"in e.content[0]&&"tool_result"===e.content[0].type?e.content.push({type:"tool_result",content:n.content,tool_use_id:n.tool_call_id}):t.push(new zt.HumanMessage({content:[{type:"tool_result",content:n.content,tool_use_id:n.tool_call_id}]}))}else t.push(new zt.HumanMessage({content:[{type:"tool_result",...null!=n.content?{content:on(n)}:{},tool_use_id:n.tool_call_id}]}));else t.push(n);return t}(e);let n;t.length>0&&"system"===t[0]._getType()&&(n=e[0].content);return{messages:ln((void 0!==n?t.slice(1):t).map(e=>{let t;if("human"===e._getType())t="user";else if("ai"===e._getType())t="assistant";else{if("tool"!==e._getType())throw"system"===e._getType()?new Error("System messages are only permitted as the first passed message."):new Error(`Message type "${e._getType()}" is not supported.`);t="user"}if((0,zt.KX)(e)&&e.tool_calls?.length){if("string"==typeof e.content)return""===e.content?{role:t,content:e.tool_calls.map(sn)}:{role:t,content:[{type:"text",text:e.content},...e.tool_calls.map(sn)]};{const{content:n}=e;e.tool_calls.every(e=>n.find(t=>("tool_use"===t.type||"input_json_delta"===t.type||"server_tool_use"===t.type)&&t.id===e.id));return{role:t,content:on(e)}}}return{role:t,content:on(e)}})),system:n}}function ln(e){if(!e||e.length<=1)return e;const t=[];let n=e[0];const r=e=>"string"==typeof e?[{type:"text",text:e}]:e,s=e=>"user"===e.role&&("string"!=typeof e.content&&(Array.isArray(e.content)&&e.content.every(e=>"tool_result"===e.type)));for(let i=1;i<e.length;i+=1){const a=e[i];s(n)&&s(a)?n={...n,content:[...r(n.content),...r(a.content)]}:(t.push(n),n=a)}return t.push(n),t}function un(e,t){if("message_start"===e.type){const{content:n,usage:r,...s}=e.message,i={};for(const[e,t]of Object.entries(s))null!=t&&(i[e]=t);const{input_tokens:a,output_tokens:o,...c}=r??{},l={input_tokens:a,output_tokens:o,total_tokens:a+o,input_token_details:{cache_creation:c.cache_creation_input_tokens,cache_read:c.cache_read_input_tokens}};return{chunk:new zt.H({content:t.coerceContentToString?"":[],additional_kwargs:i,usage_metadata:t.streamUsage?l:void 0,response_metadata:{usage:{...c}},id:e.message.id})}}if("message_delta"===e.type){const n={input_tokens:0,output_tokens:e.usage.output_tokens,total_tokens:e.usage.output_tokens,input_token_details:{cache_creation:e.usage.cache_creation_input_tokens,cache_read:e.usage.cache_read_input_tokens}};return{chunk:new zt.H({content:t.coerceContentToString?"":[],additional_kwargs:{...e.delta},usage_metadata:t.streamUsage?n:void 0})}}if("content_block_start"===e.type&&["tool_use","document","server_tool_use","web_search_tool_result"].includes(e.content_block.type)){const n=e.content_block;let r;return r="tool_use"===n.type?[{id:n.id,index:e.index,name:n.name,args:""}]:[],{chunk:new zt.H({content:t.coerceContentToString?"":[{index:e.index,...e.content_block,input:"server_tool_use"===n.type||"tool_use"===n.type?"":void 0}],additional_kwargs:{},tool_call_chunks:r})}}if("content_block_delta"===e.type&&["text_delta","citations_delta","thinking_delta","signature_delta"].includes(e.delta.type)){if(t.coerceContentToString&&"text"in e.delta)return{chunk:new zt.H({content:e.delta.text})};{const t=e.delta;return"citation"in t&&(t.citations=[t.citation],delete t.citation),"thinking_delta"===t.type||"signature_delta"===t.type?{chunk:new zt.H({content:[{index:e.index,...t,type:"thinking"}]})}:{chunk:new zt.H({content:[{index:e.index,...t,type:"text"}]})}}}if("content_block_delta"===e.type&&"input_json_delta"===e.delta.type)return{chunk:new zt.H({content:t.coerceContentToString?"":[{index:e.index,input:e.delta.partial_json,type:e.delta.type}],additional_kwargs:{},tool_call_chunks:[{index:e.index,args:e.delta.partial_json}]})};if("content_block_start"===e.type&&"text"===e.content_block.type){const n=e.content_block?.text;if(void 0!==n)return{chunk:new zt.H({content:t.coerceContentToString?n:[{index:e.index,...e.content_block}],additional_kwargs:{}})}}else{if("content_block_start"===e.type&&"redacted_thinking"===e.content_block.type)return{chunk:new zt.H({content:t.coerceContentToString?"":[{index:e.index,...e.content_block}]})};if("content_block_start"===e.type&&"thinking"===e.content_block.type){const n=e.content_block.thinking;return{chunk:new zt.H({content:t.coerceContentToString?n:[{index:e.index,...e.content_block}]})}}}return null}function dn(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}function hn(e){let t;return t=400===e.status&&e.message.includes("tool")?dn(e,"INVALID_TOOL_RESULTS"):401===e.status?dn(e,"MODEL_AUTHENTICATION"):404===e.status?dn(e,"MODEL_NOT_FOUND"):429===e.status?dn(e,"MODEL_RATE_LIMIT"):e,t}function pn(e){return"string"==typeof e.content?e.content:Array.isArray(e.content)&&e.content.length>=1&&"input"in e.content[0]?"string"==typeof e.content[0].input?e.content[0].input:JSON.stringify(e.content[0].input):Array.isArray(e.content)&&e.content.length>=1&&"text"in e.content[0]?e.content[0].text:void 0}class mn extends Wt.xV{static lc_name(){return"ChatAnthropic"}get lc_secrets(){return{anthropicApiKey:"ANTHROPIC_API_KEY",apiKey:"ANTHROPIC_API_KEY"}}get lc_aliases(){return{modelName:"model"}}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"anthropicApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"invocationKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clientOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thinking",{enumerable:!0,configurable:!0,writable:!0,value:{type:"disabled"}}),Object.defineProperty(this,"batchClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamingClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"createClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.anthropicApiKey=e?.apiKey??e?.anthropicApiKey??(0,Kt.Az)("ANTHROPIC_API_KEY"),!this.anthropicApiKey&&!e?.createClient)throw new Error("Anthropic API key not found");this.clientOptions=e?.clientOptions??{},this.apiKey=this.anthropicApiKey,this.apiUrl=e?.anthropicApiUrl,this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.invocationKwargs=e?.invocationKwargs??{},this.model.includes("opus-4-1")?this.topP=null===e?.topP?void 0:e?.topP:this.topP=e?.topP??this.topP,this.temperature=null===e?.temperature?void 0:e?.temperature??this.temperature,this.topK=e?.topK??this.topK,this.maxTokens=e?.maxTokensToSample??e?.maxTokens??this.maxTokens,this.stopSequences=e?.stopSequences??this.stopSequences,this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.thinking=e?.thinking??this.thinking,this.createClient=e?.createClient??(e=>new Gt(e))}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"anthropic",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}formatStructuredToolToAnthropic(e){if(e&&e.length)return e.map(e=>{if(function(e){return"object"==typeof e&&null!==e&&"type"in e&&"name"in e&&"string"==typeof e.type&&"string"==typeof e.name&&["web_search","bash","code_execution","computer","str_replace_editor","str_replace_based_edit_tool"].includes(e.name)}(e))return e;if(function(e){return"input_schema"in e}(e))return e;if((0,Vt.VC)(e))return{name:e.function.name,description:e.function.description,input_schema:e.function.parameters};if((0,Qt.qG)(e))return{name:e.name,description:e.description,input_schema:(0,Xt.c9)(e.schema)?(0,Jt.PF)(e.schema):e.schema};throw new Error(`Unknown tool type passed to ChatAnthropic: ${JSON.stringify(e,null,2)}`)})}bindTools(e,t){return this.withConfig({tools:this.formatStructuredToolToAnthropic(e),...t})}invocationParams(e){const t=(n=e?.tool_choice,n?"any"===n?{type:"any"}:"auto"===n?{type:"auto"}:"string"==typeof n?{type:"tool",name:n}:n:void 0);var n;if("enabled"===this.thinking.type){if(-1!==this.topK)throw new Error("topK is not supported when thinking is enabled");if(-1!==this.topP)throw new Error("topP is not supported when thinking is enabled");if(1!==this.temperature)throw new Error("temperature is not supported when thinking is enabled");return{model:this.model,stop_sequences:e?.stop??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e?.tools),tool_choice:t,thinking:this.thinking,...this.invocationKwargs}}return{model:this.model,temperature:this.temperature,top_k:this.topK,top_p:this.topP,stop_sequences:e?.stop??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e?.tools),tool_choice:t,thinking:this.thinking,...this.invocationKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams()}}identifyingParams(){return{model_name:this.model,...this.invocationParams()}}async*_streamResponseChunks(e,t,n){const r={...this.invocationParams(t),...cn(e),stream:!0},s=!function(e){return!!(e.tools&&e.tools.length>0)}(r)&&!function(e){for(const t of e.messages??[])if("string"!=typeof t.content)for(const e of t.content??[])if("object"==typeof e&&null!=e&&"document"===e.type&&"object"==typeof e.citations&&e.citations.enabled)return!0;return!1}(r)&&!function(e){return!(!e.thinking||"enabled"!==e.thinking.type)}(r),i=await this.createStreamWithRetry(r,{headers:t.headers});for await(const e of i){if(t.signal?.aborted)throw i.controller.abort(),new Error("AbortError: User aborted the request.");const r=this.streamUsage??t.streamUsage,a=un(e,{streamUsage:r,coerceContentToString:s});if(!a)continue;const{chunk:o}=a,c=pn(o),l=new qt.Cf({message:new zt.H({content:o.content,additional_kwargs:o.additional_kwargs,tool_call_chunks:o.tool_call_chunks,usage_metadata:r?o.usage_metadata:void 0,response_metadata:o.response_metadata,id:o.id}),text:c??""});yield l,await(n?.handleLLMNewToken(c??"",void 0,void 0,void 0,void 0,{chunk:l}))}}async _generateNonStreaming(e,t,n){const r=await this.completionWithRetry({...t,stream:!1,...cn(e)},n),{content:s,...i}=r,a=function(e,t){const n=t.usage,r=null!=n?{input_tokens:n.input_tokens??0,output_tokens:n.output_tokens??0,total_tokens:(n.input_tokens??0)+(n.output_tokens??0),input_token_details:{cache_creation:n.cache_creation_input_tokens,cache_read:n.cache_read_input_tokens}}:void 0;if(1===e.length&&"text"===e[0].type)return[{text:e[0].text,message:new zt.Od({content:e[0].text,additional_kwargs:t,usage_metadata:r,response_metadata:t,id:t.id})}];{const n=nn(e);return[{text:"",message:new zt.Od({content:e,additional_kwargs:t,tool_calls:n,usage_metadata:r,response_metadata:t,id:t.id})}]}}(s,i),{role:o,type:c,...l}=i;return{generations:a,llmOutput:l}}async _generate(e,t,n){if(this.stopSequences&&t.stop)throw new Error('"stopSequence" parameter found in input and default params');const r=this.invocationParams(t);if(r.stream){let r;const s=this._streamResponseChunks(e,t,n);for await(const e of s)r=void 0===r?e:r.concat(e);if(void 0===r)throw new Error("No chunks returned from Anthropic API.");return{generations:[{text:r.text,message:r.message}]}}return this._generateNonStreaming(e,r,{signal:t.signal,headers:t.headers})}async createStreamWithRetry(e,t){if(!this.streamingClient){const e=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.streamingClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...e,apiKey:this.apiKey,maxRetries:0})}return this.caller.call(async()=>{try{return await this.streamingClient.messages.create({...e,...this.invocationKwargs,stream:!0},t)}catch(e){throw hn(e)}})}async completionWithRetry(e,t){if(!this.batchClient){const e=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.batchClient=this.createClient({dangerouslyAllowBrowser:!0,...this.clientOptions,...e,apiKey:this.apiKey,maxRetries:0})}return this.caller.callWithOptions({signal:t.signal??void 0},async()=>{try{return await this.batchClient.messages.create({...e,...this.invocationKwargs},t)}catch(e){throw hn(e)}})}_llmType(){return"anthropic"}withStructuredOutput(e,t){const n=e,r=t?.name,s=t?.method,i=t?.includeRaw;if("jsonMode"===s)throw new Error('Anthropic only supports "functionCalling" as a method.');let a,o,c,l=r??"extract";if((0,Xt.c9)(n)){const e=(0,Jt.PF)(n);o=[{name:l,description:e.description??"A function available to call.",input_schema:e}],a=new tn({returnSingle:!0,keyName:l,zodSchema:n})}else{let e;"string"==typeof n.name&&"string"==typeof n.description&&"object"==typeof n.input_schema&&null!=n.input_schema?(e=n,l=n.name):e={name:l,description:n.description??"",input_schema:n},o=[e],a=new tn({returnSingle:!0,keyName:l})}if("enabled"===this.thinking?.type){const e="Anthropic structured output relies on forced tool calling, which is not supported when `thinking` is enabled. This method will raise OutputParserException if tool calls are not generated. Consider disabling `thinking` or adjust your prompt to ensure the tool is called.";c=this.withConfig({tools:o,ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:(0,Jt.PF)(n)}});const t=t=>{if(!t.tool_calls||0===t.tool_calls.length)throw new Error(e);return t};c=c.pipe(t)}else c=this.withConfig({tools:o,tool_choice:{type:"tool",name:l},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:(0,Jt.PF)(n)}});if(!i)return c.pipe(a).withConfig({runName:"ChatAnthropicStructuredOutput"});const u=Zt.kI.assign({parsed:(e,t)=>a.invoke(e.raw,t)}),d=Zt.kI.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[d]});return Zt.zZ.from([{raw:c},h]).withConfig({runName:"StructuredOutputRunnable"})}}class gn extends mn{}},7526:(e,t)=>{"use strict";t.byteLength=function(e){var t=o(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,i=o(e),a=i[0],c=i[1],l=new s(function(e,t,n){return 3*(t+n)/4-n}(0,a,c)),u=0,d=c>0?a-4:a;for(n=0;n<d;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;2===c&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,l[u++]=255&t);1===c&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t);return l},t.fromByteArray=function(e){for(var t,r=e.length,s=r%3,i=[],a=16383,o=0,c=r-s;o<c;o+=a)i.push(l(e,o,o+a>c?c:o+a));1===s?(t=e[r-1],i.push(n[t>>2]+n[t<<4&63]+"==")):2===s&&(t=(e[r-2]<<8)+e[r-1],i.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"="));return i.join("")};for(var n=[],r=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0;a<64;++a)n[a]=i[a],r[i.charCodeAt(a)]=a;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function c(e){return n[e>>18&63]+n[e>>12&63]+n[e>>6&63]+n[63&e]}function l(e,t,n){for(var r,s=[],i=t;i<n;i+=3)r=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),s.push(c(r));return s.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},7631:(e,t,n)=>{"use strict";const r=n(8311);e.exports=(e,t)=>new r(e,t).set.map(e=>e.map(e=>e.value).join(" ").trim().split(" "))},7638:(e,t,n)=>{"use strict";const r=n(8311);e.exports=(e,t,n)=>{try{t=new r(t,n)}catch(e){return!1}return t.test(e)}},7671:(e,t,n)=>{"use strict";n.d(t,{PF:()=>H});var r=n(9958);const s=Symbol("Let zodToJsonSchema decide on which parser to use"),i={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},a=e=>{const t=(e=>"string"==typeof e?{...i,name:e}:{...i,...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}};var o=n(2080);const c=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")};function l(e){if("openAi"!==e.target)return{};const t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?c(t,e.currentPath):t.join("/")}}function u(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function d(e,t,n,r,s){e[t]=n,u(e,t,r,s)}function h(e,t){return U(e.type._def,t)}function p(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((n,r)=>p(e,t,n))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return m(e,t)}}const m=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":d(n,"minimum",r.value,r.message,t);break;case"max":d(n,"maximum",r.value,r.message,t)}return n};let g;const f=/^[cC][^\s-]{8,}$/,y=/^[0-9a-z]+$/,_=/^[0-9A-HJKMNP-TV-Z]{26}$/,b=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,w=()=>(void 0===g&&(g=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),g),v=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,E=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,S=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,x=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,k=/^[a-zA-Z0-9_-]{21}$/,T=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function I(e,t){const n={type:"string"};if(e.checks)for(const r of e.checks)switch(r.kind){case"min":d(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t);break;case"max":d(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":A(n,"email",r.message,t);break;case"format:idn-email":A(n,"idn-email",r.message,t);break;case"pattern:zod":P(n,b,r.message,t)}break;case"url":A(n,"uri",r.message,t);break;case"uuid":A(n,"uuid",r.message,t);break;case"regex":P(n,r.regex,r.message,t);break;case"cuid":P(n,f,r.message,t);break;case"cuid2":P(n,y,r.message,t);break;case"startsWith":P(n,RegExp(`^${O(r.value,t)}`),r.message,t);break;case"endsWith":P(n,RegExp(`${O(r.value,t)}$`),r.message,t);break;case"datetime":A(n,"date-time",r.message,t);break;case"date":A(n,"date",r.message,t);break;case"time":A(n,"time",r.message,t);break;case"duration":A(n,"duration",r.message,t);break;case"length":d(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t),d(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"includes":P(n,RegExp(O(r.value,t)),r.message,t);break;case"ip":"v6"!==r.version&&A(n,"ipv4",r.message,t),"v4"!==r.version&&A(n,"ipv6",r.message,t);break;case"base64url":P(n,x,r.message,t);break;case"jwt":P(n,T,r.message,t);break;case"cidr":"v6"!==r.version&&P(n,v,r.message,t),"v4"!==r.version&&P(n,E,r.message,t);break;case"emoji":P(n,w(),r.message,t);break;case"ulid":P(n,_,r.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":A(n,"binary",r.message,t);break;case"contentEncoding:base64":d(n,"contentEncoding","base64",r.message,t);break;case"pattern:zod":P(n,S,r.message,t)}break;case"nanoid":P(n,k,r.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:(()=>{})()}return n}function O(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let n=0;n<e.length;n++)C.has(e[n])||(t+="\\"),t+=e[n];return t}(e):e}const C=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function A(e,t,n,r){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):d(e,"format",t,n,r)}function P(e,t,n,r){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:M(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):d(e,"pattern",M(t,r),n,r)}function M(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const n=e.flags.includes("i"),r=e.flags.includes("m"),s=e.flags.includes("s"),i=n?e.source.toLowerCase():e.source;let a="",o=!1,c=!1,l=!1;for(let e=0;e<i.length;e++)if(o)a+=i[e],o=!1;else{if(n)if(c){if(i[e].match(/[a-z]/)){l?(a+=i[e],a+=`${i[e-2]}-${i[e]}`.toUpperCase(),l=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(a+=i[e],l=!0):a+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){a+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(r){if("^"===i[e]){a+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){a+="($|(?=[\r\n]))";continue}}s&&"."===i[e]?a+=c?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(a+=i[e],"\\"===i[e]?o=!0:c&&"]"===i[e]?c=!1:c||"["!==i[e]||(c=!0))}try{new RegExp(a)}catch{return e.source}return a}function R(e,t){if(t.target,"openApi3"===t.target&&e.keyType?._def.typeName===o.kY.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,r)=>({...n,[r]:U(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??l(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};const n={type:"object",additionalProperties:U(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===o.kY.ZodString&&e.keyType._def.checks?.length){const{type:r,...s}=I(e.keyType._def,t);return{...n,propertyNames:s}}if(e.keyType?._def.typeName===o.kY.ZodEnum)return{...n,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===o.kY.ZodBranded&&e.keyType._def.type._def.typeName===o.kY.ZodString&&e.keyType._def.type._def.checks?.length){const{type:r,...s}=h(e.keyType._def,t);return{...n,propertyNames:s}}return n}const $={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};const j=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,n)=>U(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return n.length?{anyOf:n}:void 0};function N(e,t){const n="openAi"===t.target,r={type:"object",properties:{}},s=[],i=e.shape();for(const e in i){let a=i[e];if(void 0===a||void 0===a._def)continue;let o=L(a);o&&n&&("ZodOptional"===a._def.typeName&&(a=a._def.innerType),a.isNullable()||(a=a.nullable()),o=!1);const c=U(a._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==c&&(r.properties[e]=c,o||s.push(e))}s.length&&(r.required=s);const a=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return U(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==a&&(r.additionalProperties=a),r}function L(e){try{return e.isOptional()}catch{return!0}}const D=(e,t,n)=>{switch(t){case o.kY.ZodString:return I(e,n);case o.kY.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",u(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?d(n,"minimum",r.value,r.message,t):d(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),d(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?d(n,"maximum",r.value,r.message,t):d(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),d(n,"maximum",r.value,r.message,t));break;case"multipleOf":d(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case o.kY.ZodObject:return N(e,n);case o.kY.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?d(n,"minimum",r.value,r.message,t):d(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),d(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?d(n,"maximum",r.value,r.message,t):d(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),d(n,"maximum",r.value,r.message,t));break;case"multipleOf":d(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case o.kY.ZodBoolean:return{type:"boolean"};case o.kY.ZodDate:return p(e,n);case o.kY.ZodUndefined:return function(e){return{not:l(e)}}(n);case o.kY.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case o.kY.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def&&e.type?._def?.typeName!==o.kY.ZodAny&&(n.items=U(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&d(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&d(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(d(n,"minItems",e.exactLength.value,e.exactLength.message,t),d(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case o.kY.ZodUnion:case o.kY.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return j(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every(e=>e._def.typeName in $&&(!e._def.checks||!e._def.checks.length))){const e=n.reduce((e,t)=>{const n=$[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e},[]);return{type:e.length>1?e:e[0]}}if(n.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=n.reduce((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===n.length){const t=e.filter((e,t,n)=>n.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:n.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(n.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:n.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return j(e,t)}(e,n);case o.kY.ZodIntersection:return function(e,t){const n=[U(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),U(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;s.push(t)}else s.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t}),s.length?{allOf:s,...r}:void 0}(e,n);case o.kY.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,n)=>U(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:U(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,n)=>U(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,n);case o.kY.ZodRecord:return R(e,n);case o.kY.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case o.kY.ZodEnum:return function(e){return{type:"string",enum:Array.from(e.values)}}(e);case o.kY.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),r=Array.from(new Set(n.map(e=>typeof e)));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case o.kY.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:$[e.innerType._def.typeName],nullable:!0}:{type:[$[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=U(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=U(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case o.kY.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return U(e.innerType._def,t);const n=U(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:l(t)},n]}:l(t)})(e,n);case o.kY.ZodMap:return function(e,t){return"record"===t.mapStrategy?R(e,t):{type:"array",maxItems:125,items:{type:"array",items:[U(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||l(t),U(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||l(t)],minItems:2,maxItems:2}}}(e,n);case o.kY.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:U(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&d(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&d(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case o.kY.ZodLazy:return()=>e.getter()._def;case o.kY.ZodPromise:return function(e,t){return U(e.type._def,t)}(e,n);case o.kY.ZodNaN:case o.kY.ZodNever:return function(e){return"openAi"===e.target?void 0:{not:l({...e,currentPath:[...e.currentPath,"not"]})}}(n);case o.kY.ZodEffects:return function(e,t){return"input"===t.effectStrategy?U(e.schema._def,t):l(t)}(e,n);case o.kY.ZodAny:return l(n);case o.kY.ZodUnknown:return function(e){return l(e)}(n);case o.kY.ZodDefault:return function(e,t){return{...U(e.innerType._def,t),default:e.defaultValue()}}(e,n);case o.kY.ZodBranded:return h(e,n);case o.kY.ZodReadonly:case o.kY.ZodCatch:return((e,t)=>U(e.innerType._def,t))(e,n);case o.kY.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return U(e.in._def,t);if("output"===t.pipeStrategy)return U(e.out._def,t);const n=U(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,U(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter(e=>void 0!==e)}})(e,n);case o.kY.ZodFunction:case o.kY.ZodVoid:case o.kY.ZodSymbol:default:return}};function U(e,t,n=!1){const r=t.seen.get(e);if(t.override){const i=t.override?.(e,t,r,n);if(i!==s)return i}if(r&&!n){const e=F(r,t);if(void 0!==e)return e}const i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);const a=D(e,e.typeName,t),o="function"==typeof a?U(a(),t):a;if(o&&Y(e,t,o),t.postProcess){const n=t.postProcess(o,e,t);return i.jsonSchema=o,n}return i.jsonSchema=o,o}const F=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:c(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,n)=>t.currentPath[n]===e)||"seen"===t.$refStrategy?l(t):void 0}},Y=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),G=(e,t)=>{const n=a(t);let r="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,r])=>({...e,[t]:U(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0)??l(n)}),{}):void 0;const s="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,i=U(e._def,void 0===s?n:{...n,currentPath:[...n.basePath,n.definitionPath,s]},!1)??l(n),o="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==o&&(i.title=o),n.flags.hasReferencedOpenAiAnyType&&(r||(r={}),r[n.openAiAnyTypeName]||(r[n.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===n.$refStrategy?"1":[...n.basePath,n.definitionPath,n.openAiAnyTypeName].join("/")}}));const c=void 0===s?r?{...i,[n.definitionPath]:r}:i:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...r,[s]:i}};return"jsonSchema7"===n.target?c.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"!==n.target&&"openAi"!==n.target||(c.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===n.target&&("anyOf"in c||"oneOf"in c||"allOf"in c||"type"in c&&Array.isArray(c.type)),c};n(7265);var B=n(7942);function H(e){if((0,B.Pq)(e)){const t=(0,B.EN)(e,!0);if((0,B.gY)(t)){const e=(0,B.pE)(t,!0);return(0,r.b)(e)}return(0,r.b)(e)}return(0,B.IU)(e)?G(e):e}},7765:(e,t,n)=>{"use strict";n.d(t,{H:()=>l,KX:()=>o,Od:()=>a,jm:()=>c});var r=n(780),s=n(3490),i=n(8009);class a extends s.XQ{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if("string"==typeof e)n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;const t=n.additional_kwargs?.tool_calls,r=n.tool_calls;null!=t&&t.length>0&&(void 0===r||r.length);try{if(null!=t&&void 0===r){const[e,r]=(0,i.p1)(t);n.tool_calls=e??[],n.invalid_tool_calls=r??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch(e){n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof n&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function o(e){return"ai"===e._getType()}function c(e){return"ai"===e._getType()}class l extends s.gj{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0};else{const n=e.tool_call_chunks.reduce((e,t)=>{const n=t.id||`fallback-${t.index||0}`;return e[n]=e[n]??[],e[n].push(t),e},{}),s=[],i=[];for(const[e,t]of Object.entries(n)){let n={};const a=t[0]?.name??"",o=t.map(e=>e.args||"").join(""),c=o.length?o:"{}",l=t[0]?.id||e;try{if(n=(0,r.d)(c),null===n||"object"!=typeof n||Array.isArray(n))throw new Error("Malformed tool call chunk args.");s.push({name:a,args:n,id:l,type:"tool_call"})}catch(e){i.push({name:a,args:c,id:l,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:s,invalid_tool_calls:i,usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:(0,s._I)(this.content,e.content),additional_kwargs:(0,s.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,s.ns)(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const n=(0,s.Vt)(this.tool_call_chunks,e.tool_call_chunks);void 0!==n&&n.length>0&&(t.tool_call_chunks=n)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const n={...(void 0!==this.usage_metadata?.input_token_details?.audio||void 0!==e.usage_metadata?.input_token_details?.audio)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_read||void 0!==e.usage_metadata?.input_token_details?.cache_read)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_creation||void 0!==e.usage_metadata?.input_token_details?.cache_creation)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},r={...(void 0!==this.usage_metadata?.output_token_details?.audio||void 0!==e.usage_metadata?.output_token_details?.audio)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(void 0!==this.usage_metadata?.output_token_details?.reasoning||void 0!==e.usage_metadata?.output_token_details?.reasoning)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},s=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a={input_tokens:s.input_tokens+i.input_tokens,output_tokens:s.output_tokens+i.output_tokens,total_tokens:s.total_tokens+i.total_tokens,...Object.keys(n).length>0&&{input_token_details:n},...Object.keys(r).length>0&&{output_token_details:r}};t.usage_metadata=a}return new l(t)}}},7820:e=>{"use strict";var t,n=Object.defineProperty,r=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,a={};((e,t)=>{for(var r in t)n(e,r,{get:t[r],enumerable:!0})})(a,{getEnv:()=>o}),e.exports=(t=a,((e,t,a,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let c of s(t))i.call(e,c)||c===a||n(e,c,{get:()=>t[c],enumerable:!(o=r(t,c))||o.enumerable});return e})(n({},"__esModule",{value:!0}),t));const o=(e=process.env)=>({VERCEL:c(e,"VERCEL"),CI:c(e,"CI"),VERCEL_ENV:c(e,"VERCEL_ENV"),VERCEL_URL:c(e,"VERCEL_URL"),VERCEL_BRANCH_URL:c(e,"VERCEL_BRANCH_URL"),VERCEL_PROJECT_PRODUCTION_URL:c(e,"VERCEL_PROJECT_PRODUCTION_URL"),VERCEL_REGION:c(e,"VERCEL_REGION"),VERCEL_DEPLOYMENT_ID:c(e,"VERCEL_DEPLOYMENT_ID"),VERCEL_SKEW_PROTECTION_ENABLED:c(e,"VERCEL_SKEW_PROTECTION_ENABLED"),VERCEL_AUTOMATION_BYPASS_SECRET:c(e,"VERCEL_AUTOMATION_BYPASS_SECRET"),VERCEL_GIT_PROVIDER:c(e,"VERCEL_GIT_PROVIDER"),VERCEL_GIT_REPO_SLUG:c(e,"VERCEL_GIT_REPO_SLUG"),VERCEL_GIT_REPO_OWNER:c(e,"VERCEL_GIT_REPO_OWNER"),VERCEL_GIT_REPO_ID:c(e,"VERCEL_GIT_REPO_ID"),VERCEL_GIT_COMMIT_REF:c(e,"VERCEL_GIT_COMMIT_REF"),VERCEL_GIT_COMMIT_SHA:c(e,"VERCEL_GIT_COMMIT_SHA"),VERCEL_GIT_COMMIT_MESSAGE:c(e,"VERCEL_GIT_COMMIT_MESSAGE"),VERCEL_GIT_COMMIT_AUTHOR_LOGIN:c(e,"VERCEL_GIT_COMMIT_AUTHOR_LOGIN"),VERCEL_GIT_COMMIT_AUTHOR_NAME:c(e,"VERCEL_GIT_COMMIT_AUTHOR_NAME"),VERCEL_GIT_PREVIOUS_SHA:c(e,"VERCEL_GIT_PREVIOUS_SHA"),VERCEL_GIT_PULL_REQUEST_ID:c(e,"VERCEL_GIT_PULL_REQUEST_ID")}),c=(e,t)=>{const n=e[t];return""===n?void 0:n}},7889:(e,t,n)=>{"use strict";n.d(t,{XW:()=>p,NL:()=>h});var r=n(2080),s=n(7265),i=n(9149),a=n(528),o=n(765),c=n(8009),l=(n(4350),n(199)),u=n(7942);n(7671),n(5787);class d extends a.ZE{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),Object.defineProperty(this,"defaultConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat,this.defaultConfig=e?.defaultConfig??this.defaultConfig,this.metadata=e?.metadata??this.metadata}async invoke(e,t){let n,r=(0,o.ZI)((0,o.SV)(this.defaultConfig,t));return(0,l.Ky)(e)?(n=e.args,r={...r,toolCall:e}):n=e,this.call(n,r)}async call(e,t,n){const r=(0,l.Ky)(e)?e.args:e;let a;if((0,u.c9)(this.schema))try{a=await(0,u.hZ)(this.schema,r)}catch(t){let n="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(n=`${n}\nDetails: ${t.message}`),new l.qe(n,JSON.stringify(e))}else{const t=(0,s.tf)(r,this.schema);if(!t.valid){let n="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(n=`${n}\nDetails: ${t.errors.map(e=>`${e.keywordLocation}: ${e.error}`).join("\n")}`),new l.qe(n,JSON.stringify(e))}a=r}const o=(0,i.H_)(t),d=i.Td.configure(o.callbacks,this.callbacks,o.tags||n,this.tags,o.metadata,this.metadata,{verbose:this.verbose}),h=await(d?.handleToolStart(this.toJSON(),"string"==typeof e?e:JSON.stringify(e),o.runId,void 0,void 0,void 0,o.runName));let p,g,f,y;delete o.runId;try{p=await this._call(a,h,o)}catch(e){throw await(h?.handleToolError(e)),e}if("content_and_artifact"===this.responseFormat){if(!Array.isArray(p)||2!==p.length)throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.\nResult: ${JSON.stringify(p)}`);[g,f]=p}else g=p;(0,l.Ky)(e)&&(y=e.id),!y&&(0,l.hR)(o)&&(y=o.toolCall.id);const _=function(e){const{content:t,artifact:n,toolCallId:r,metadata:s}=e;return r&&!(0,c.fK)(t)?"string"==typeof t||Array.isArray(t)&&t.every(e=>"object"==typeof e)?new c.uf({status:"success",content:t,artifact:n,tool_call_id:r,name:e.name,metadata:s}):new c.uf({status:"success",content:m(t),artifact:n,tool_call_id:r,name:e.name,metadata:s}):t}({content:g,artifact:f,toolCallId:y,name:this.name,metadata:this.metadata});return await(h?.handleToolEnd(_)),_}}class h extends d{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:r.Ik({input:r.Yj().optional()}).transform(e=>e.input)})}call(e,t){const n="string"==typeof e||null==e?{input:e}:e;return super.call(n,t)}}class p extends d{static lc_name(){return"DynamicStructuredTool"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}async call(e,t,n){const r=(0,i.H_)(t);return void 0===r.runName&&(r.runName=this.name),super.call(e,r,n)}_call(e,t,n){return this.func(e,t,n)}}function m(e){try{return JSON.stringify(e,null,2)??""}catch(t){return`${e}`}}},7942:(e,t,n)=>{"use strict";n.d(t,{cg:()=>g,hZ:()=>m,K3:()=>p,pE:()=>b,EN:()=>w,c9:()=>h,yQ:()=>f,gY:()=>y,IU:()=>d,Pq:()=>u});var r=n(3025),s=n(3795),i=n(7048);var a=n(5435);const o={major:4,minor:0,patch:0},c=a.xI("$ZodType",(e,t)=>{var n;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=o;const s=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&s.unshift(e);for(const t of s)for(const n of t._zod.onattach)n(e);if(0===s.length)(n=e._zod).deferred??(n.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const t=(e,t,n)=>{let r,s=i.QH(e);for(const o of t){if(o._zod.def.when){if(!o._zod.def.when(e))continue}else if(s)continue;const t=e.issues.length,c=o._zod.check(e);if(c instanceof Promise&&!1===n?.async)throw new a.GT;if(r||c instanceof Promise)r=(r??Promise.resolve()).then(async()=>{await c;e.issues.length!==t&&(s||(s=i.QH(e,t)))});else{if(e.issues.length===t)continue;s||(s=i.QH(e,t))}}return r?r.then(()=>e):e};e._zod.run=(n,r)=>{const i=e._zod.parse(n,r);if(i instanceof Promise){if(!1===r.async)throw new a.GT;return i.then(e=>t(e,s,r))}return t(i,s,r)}}e["~standard"]={validate:t=>{try{const n=(0,r.xL)(e,t);return n.success?{value:n.data}:{issues:n.error?.issues}}catch(n){return(0,r.bp)(e,t).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}});const l=a.xI("$ZodNever",(e,t)=>{c.init(e,t),e._zod.parse=(t,n)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)});function u(e){if("object"!=typeof e||null===e)return!1;if(!("_zod"in e))return!1;const t=e._zod;return"object"==typeof t&&null!==t&&"def"in t}function d(e){if("object"!=typeof e||null===e)return!1;if(!("_def"in e)||"_zod"in e)return!1;const t=e._def;return"object"==typeof t&&null!=t&&"typeName"in t}function h(e){return!!e&&("object"==typeof e&&(!Array.isArray(e)&&!(!u(e)&&!d(e))))}async function p(e,t){if(u(e))try{return{success:!0,data:await(0,r.EJ)(e,t)}}catch(e){return{success:!1,error:e}}if(d(e))return e.safeParse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function m(e,t){if(u(e))return(0,r.qg)(e,t);if(d(e))return e.parse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function g(e){return u(e)?s.fd.get(e)?.description:d(e)||"description"in e&&"string"==typeof e.description?e.description:void 0}function f(e){if(!h(e))return!1;if(d(e)){return"ZodString"===e._def.typeName}if(u(e)){return"string"===e._zod.def.type}return!1}function y(e){return!!u(e)&&("object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"object"===e._zod.def.type)}function _(e){return!!u(e)&&("object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"array"===e._zod.def.type)}function b(e,t=!1){if(d(e))return e.strict();if(y(e)){const a=e._zod.def.shape;if(t)for(const[n,r]of Object.entries(e._zod.def.shape)){if(y(r)){const e=b(r,t);a[n]=e}else if(_(r)){let e=r._zod.def.element;y(e)&&(e=b(e,t)),a[n]=(0,i.o8)(r,{...r._zod.def,element:e})}else a[n]=r;const e=s.fd.get(r);e&&s.fd.add(a[n],e)}const o=(0,i.o8)(e,{...e._zod.def,shape:a,catchall:(n=l,new n({type:"never",...i.A2(r)}))}),c=s.fd.get(e);return c&&s.fd.add(o,c),o}var n,r;throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function w(e,t=!1){if(d(e))return function(e){return d(e)&&"typeName"in e._def&&"ZodEffects"===e._def.typeName}(e)?w(e._def.schema,t):e;if(u(e)){let n=e;if(function(e){return u(e)&&"pipe"===e._zod.def.type}(e)&&(n=w(e._zod.def.in,t)),t)if(y(n)){const e=n._zod.def.shape;for(const[r,s]of Object.entries(n._zod.def.shape))e[r]=w(s,t);n=(0,i.o8)(n,{...n._zod.def,shape:e})}else if(_(n)){const e=w(n._zod.def.element,t);n=(0,i.o8)(n,{...n._zod.def,element:e})}const r=s.fd.get(e);return r&&s.fd.add(n,r),n}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}},7958:(e,t,n)=>{"use strict";n.d(t,{$W:()=>s});let r=n(342).A;function s(){return r}},7966:(e,t,n)=>{"use strict";n.d(t,{Q:()=>a});var r=n(454),s=n(823),i=n(5732);class a{static parseProvidersConfig(e){try{const t="string"==typeof e?JSON.parse(e):e;if(!t)return null;const n=i.co.parse(t);return this.normalizeConfig(n)}catch(e){return r.y7.log("LLMSettingsReader",`Failed to parse providers config: ${e}`,"error"),null}}static normalizeConfig(e){let t=e.defaultProviderId;e.providers.some(e=>e.id===t)||(t=e.providers[0]?.id||"vibebrowser");const n=e.providers.map(e=>({...e,isDefault:e.id===t,isBuiltIn:e.isBuiltIn??!1,createdAt:e.createdAt??(new Date).toISOString(),updatedAt:e.updatedAt??(new Date).toISOString()}));return 0===n.length?(0,i.ah)():{defaultProviderId:t,providers:n}}static setMockProvider(e){(0,s.Zd)()?this.mockProvider={...this.getDefaultVibeBrowserProvider(),...e}:r.y7.log("LLMSettingsReader","setMockProvider is only available in development mode","warning")}static async read(){try{const e=await this.readAllProviders();return e.providers.find(t=>t.id===e.defaultProviderId)||e.providers[0]||this.getDefaultVibeBrowserProvider()}catch(e){const t=e instanceof Error?e.message:String(e);return r.y7.log("LLMSettingsReader",`Failed to read settings: ${t}`,"error"),this.getDefaultVibeBrowserProvider()}}static async readAllProviders(){try{const e=await this.readProvidersConfig();if(e)return e}catch(e){const t=e instanceof Error?e.message:String(e);r.y7.log("LLMSettingsReader",`Failed to read providers: ${t}`,"error")}return(0,i.ah)()}static mergeProviderConfigs(e,t){if(!e&&!t)return null;if(!e)return t;if(!t)return e;const n=new Map;for(const t of e.providers)n.set(t.id,t);for(const e of t.providers){const t=n.get(e.id);if(t){const r=new Date(t.updatedAt||0).getTime();new Date(e.updatedAt||0).getTime()>r&&n.set(e.id,e)}else n.set(e.id,e)}const r=Array.from(n.values()),s=new Set(e.providers.map(e=>e.id)),i=new Set(t.providers.map(e=>e.id)),a=[],o=e=>{e&&(a.includes(e)||a.push(e))},c=s.has(e.defaultProviderId)&&i.has(e.defaultProviderId),l=i.has(t.defaultProviderId)&&s.has(t.defaultProviderId);c&&o(e.defaultProviderId),l&&o(t.defaultProviderId),o(e.defaultProviderId),o(t.defaultProviderId);return{defaultProviderId:a.find(e=>r.some(t=>t.id===e))||r[0]?.id||"vibebrowser",providers:r}}static async readProvidersConfig(){try{const e=i.es.PROVIDERS;let t=null,n=null;if(chrome?.browserOS?.getPref)try{const n=await new Promise((t,n)=>{chrome.browserOS.getPref(e,e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(e)})});if(n?.value){const e="string"==typeof n.value?JSON.parse(n.value):n.value;e.providers&&(e.providers=e.providers.map(e=>({...e,isDefault:void 0!==e.isDefault?e.isDefault:"vibebrowser"===e.id}))),t=i.co.parse(e)}}catch(e){}if(chrome.storage?.local){const t=await new Promise(t=>{chrome.storage.local.get(e,e=>t(e))}),r=t?.[e];if(r){const e="string"==typeof r?JSON.parse(r):r;e.providers&&(e.providers=e.providers.map(e=>({...e,isDefault:void 0!==e.isDefault?e.isDefault:"vibebrowser"===e.id}))),n=i.co.parse(e)}}const r=this.mergeProviderConfigs(t,n);if(!r)return null;const s=t?.providers.length||0,a=n?.providers.length||0,o=r.providers.length;return(o>s||o>a)&&await this.saveProvidersConfig(r),r}catch(e){const t=e instanceof Error?e.message:JSON.stringify(e);return r.y7.log("LLMSettingsReader",`Error reading providers: ${t}`,"error"),e instanceof Error&&e.stack&&r.y7.log("LLMSettingsReader",`Stack trace: ${e.stack}`,"error"),null}}static async saveProvidersConfig(e){const t=this.normalizeConfig(e),n=i.es.PROVIDERS,s=JSON.stringify(t);let a=!1,o=!1;chrome?.browserOS?.setPref&&(a=await new Promise(e=>{chrome.browserOS.setPref(n,s,void 0,t=>{const n=chrome.runtime?.lastError;n?(r.y7.log("LLMSettingsReader",`VibeBrowser setPref error: ${n.message}`,"warning"),e(!1)):!1!==t?e(!0):(r.y7.log("LLMSettingsReader","VibeBrowser setPref returned false","warning"),e(!1))})})),chrome.storage?.local&&(o=await new Promise(e=>{chrome.storage.local.set({[n]:s},()=>{chrome.runtime.lastError?(r.y7.log("LLMSettingsReader",`chrome.storage.local save error: ${chrome.runtime.lastError.message}`,"error"),e(!1)):e(!0)})}));const c=a||o;return c||r.y7.log("LLMSettingsReader","Failed to save to any storage mechanism","error"),c}static getDefaultVibeBrowserProvider(){return(0,i.Bz)()}static getMockProvider(){if(this.mockProvider)return this.mockProvider;const e=process.env.MOCK_PROVIDER_TYPE||"vibebrowser";return{vibebrowser:this.getDefaultVibeBrowserProvider(),openai:{id:"mock_openai",name:"Mock OpenAI",type:"openai",isDefault:!0,isBuiltIn:!1,baseUrl:"https://api.openai.com/v1",apiKey:"mock-key",modelId:"gpt-4o",capabilities:{supportsImages:!0},modelConfig:{contextWindow:128e3,temperature:.7},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},anthropic:{id:"mock_anthropic",name:"Mock Anthropic",type:"anthropic",isDefault:!0,isBuiltIn:!1,baseUrl:"https://api.anthropic.com",apiKey:process.env.ANTHROPIC_API_KEY||"mock-key",modelId:"claude-3-5-sonnet-latest",capabilities:{supportsImages:!0},modelConfig:{contextWindow:2e5,temperature:.7},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},gemini:{id:"mock_gemini",name:"Mock Gemini",type:"google_gemini",isDefault:!0,isBuiltIn:!1,apiKey:process.env.GOOGLE_API_KEY||"mock-key",modelId:"gemini-2.0-flash",capabilities:{supportsImages:!0},modelConfig:{contextWindow:1e6,temperature:.7},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},ollama:{id:"mock_ollama",name:"Mock Ollama",type:"ollama",isDefault:!0,isBuiltIn:!1,baseUrl:"http://localhost:11434",modelId:"qwen3:4b",capabilities:{supportsImages:!1},modelConfig:{contextWindow:4096,temperature:.7},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}}[e]||this.getDefaultVibeBrowserProvider()}}a.mockProvider=null},7974:(e,t,n)=>{"use strict";n.d(t,{tn:()=>s,uU:()=>i});var r=n(3490);class s extends r.XQ{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}}class i extends r.gj{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}constructor(e,t){super(e,t)}concat(e){return new i({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),id:this.id??e.id})}}},8009:(e,t,n)=>{"use strict";n.d(t,{dr:()=>a,fK:()=>s,p1:()=>o,uf:()=>i,wk:()=>c});var r=n(3490);function s(e){return null!=e&&"object"==typeof e&&"lc_direct_tool_output"in e&&!0===e.lc_direct_tool_output}class i extends r.XQ{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,n){"string"==typeof e&&(e={content:e,name:n,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status,this.metadata=e.metadata}_getType(){return"tool"}static isInstance(e){return"tool"===e._getType()}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class a extends r.gj{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new a({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),artifact:(0,r.F7)(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:(0,r.Iv)(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function o(e){const t=[],n=[];for(const r of e)if(r.function){const e=r.function.name;try{const n={name:e||"",args:JSON.parse(r.function.arguments)||{},id:r.id};t.push(n)}catch(t){n.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,n]}function c(e){return"tool"===e._getType()}},8028:(e,t,n)=>{"use strict";n.d(t,{Cf:()=>i,SP:()=>r,mu:()=>s});const r="__run";class s{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new s({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class i extends s{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new i({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}},8152:(e,t,n)=>{"use strict";n.d(t,{J_:()=>o,gJ:()=>s,tE:()=>a});class r extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function s(e,t,n){let s;if(e.ok)return void(n&&(s=await e.text()));if(403===e.status)try{const t=await e.json(),n=t?.error;if("org_scoped_key_requires_workspace"===n)throw new Error("This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch(t){throw new Error(`${e.status} ${e.statusText}`)}s=await e.text();const i=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${s}`;if(409===e.status)throw new r(i);const a=new Error(i);throw a.status=e.status,a}const i="ERR_CONFLICTING_ENDPOINTS";class a extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:i}),this.name="ConflictingEndpointsError"}}function o(e){return"object"==typeof e&&null!==e&&e.code===i}},8303:(e,t,n)=>{var r=n(3961);t.operation=function(e){var n=t.timeouts(e);return new r(n,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],s=0;s<t.retries;s++)r.push(this.createTimeout(s,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(s,t)),r.sort(function(e,t){return e-t}),r},t.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout)},t.wrap=function(e,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var s in r=[],e)"function"==typeof e[s]&&r.push(s);for(var i=0;i<r.length;i++){var a=r[i],o=e[a];e[a]=function(r){var s=t.operation(n),i=Array.prototype.slice.call(arguments,1),a=i.pop();i.push(function(e){s.retry(e)||(e&&(arguments[0]=s.mainError()),a.apply(this,arguments))}),s.attempt(function(){r.apply(e,i)})}.bind(e,o),e[a].options=n}}},8311:(e,t,n)=>{"use strict";const r=/\s+/g;class s{constructor(e,t){if(t=a(t),e instanceof s)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new s(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(r," "),this.set=this.raw.split("||").map(e=>this.parseRange(e.trim())).filter(e=>e.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter(e=>!y(e[0])),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&_(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&g)|(this.options.loose&&f))+":"+e,n=i.get(t);if(n)return n;const r=this.options.loose,s=r?u[d.HYPHENRANGELOOSE]:u[d.HYPHENRANGE];e=e.replace(s,A(this.options.includePrerelease)),c("hyphen replace",e),e=e.replace(u[d.COMPARATORTRIM],h),c("comparator trim",e),e=e.replace(u[d.TILDETRIM],p),c("tilde trim",e),e=e.replace(u[d.CARETTRIM],m),c("caret trim",e);let a=e.split(" ").map(e=>w(e,this.options)).join(" ").split(/\s+/).map(e=>C(e,this.options));r&&(a=a.filter(e=>(c("loose invalid filter",e,this.options),!!e.match(u[d.COMPARATORLOOSE])))),c("range list",a);const l=new Map,_=a.map(e=>new o(e,this.options));for(const e of _){if(y(e))return[e];l.set(e.value,e)}l.size>1&&l.has("")&&l.delete("");const b=[...l.values()];return i.set(t,b),b}intersects(e,t){if(!(e instanceof s))throw new TypeError("a Range is required");return this.set.some(n=>b(n,t)&&e.set.some(e=>b(e,t)&&n.every(n=>e.every(e=>n.intersects(e,t)))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new l(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(P(this.set[t],e,this.options))return!0;return!1}}e.exports=s;const i=new(n(8794)),a=n(8587),o=n(3904),c=n(7272),l=n(3908),{safeRe:u,t:d,comparatorTrimReplace:h,tildeTrimReplace:p,caretTrimReplace:m}=n(9718),{FLAG_INCLUDE_PRERELEASE:g,FLAG_LOOSE:f}=n(6874),y=e=>"<0.0.0-0"===e.value,_=e=>""===e.value,b=(e,t)=>{let n=!0;const r=e.slice();let s=r.pop();for(;n&&r.length;)n=r.every(e=>s.intersects(e,t)),s=r.pop();return n},w=(e,t)=>(c("comp",e,t),e=x(e,t),c("caret",e),e=E(e,t),c("tildes",e),e=T(e,t),c("xrange",e),e=O(e,t),c("stars",e),e),v=e=>!e||"x"===e.toLowerCase()||"*"===e,E=(e,t)=>e.trim().split(/\s+/).map(e=>S(e,t)).join(" "),S=(e,t)=>{const n=t.loose?u[d.TILDELOOSE]:u[d.TILDE];return e.replace(n,(t,n,r,s,i)=>{let a;return c("tilde",e,t,n,r,s,i),v(n)?a="":v(r)?a=`>=${n}.0.0 <${+n+1}.0.0-0`:v(s)?a=`>=${n}.${r}.0 <${n}.${+r+1}.0-0`:i?(c("replaceTilde pr",i),a=`>=${n}.${r}.${s}-${i} <${n}.${+r+1}.0-0`):a=`>=${n}.${r}.${s} <${n}.${+r+1}.0-0`,c("tilde return",a),a})},x=(e,t)=>e.trim().split(/\s+/).map(e=>k(e,t)).join(" "),k=(e,t)=>{c("caret",e,t);const n=t.loose?u[d.CARETLOOSE]:u[d.CARET],r=t.includePrerelease?"-0":"";return e.replace(n,(t,n,s,i,a)=>{let o;return c("caret",e,t,n,s,i,a),v(n)?o="":v(s)?o=`>=${n}.0.0${r} <${+n+1}.0.0-0`:v(i)?o="0"===n?`>=${n}.${s}.0${r} <${n}.${+s+1}.0-0`:`>=${n}.${s}.0${r} <${+n+1}.0.0-0`:a?(c("replaceCaret pr",a),o="0"===n?"0"===s?`>=${n}.${s}.${i}-${a} <${n}.${s}.${+i+1}-0`:`>=${n}.${s}.${i}-${a} <${n}.${+s+1}.0-0`:`>=${n}.${s}.${i}-${a} <${+n+1}.0.0-0`):(c("no pr"),o="0"===n?"0"===s?`>=${n}.${s}.${i}${r} <${n}.${s}.${+i+1}-0`:`>=${n}.${s}.${i}${r} <${n}.${+s+1}.0-0`:`>=${n}.${s}.${i} <${+n+1}.0.0-0`),c("caret return",o),o})},T=(e,t)=>(c("replaceXRanges",e,t),e.split(/\s+/).map(e=>I(e,t)).join(" ")),I=(e,t)=>{e=e.trim();const n=t.loose?u[d.XRANGELOOSE]:u[d.XRANGE];return e.replace(n,(n,r,s,i,a,o)=>{c("xRange",e,n,r,s,i,a,o);const l=v(s),u=l||v(i),d=u||v(a),h=d;return"="===r&&h&&(r=""),o=t.includePrerelease?"-0":"",l?n=">"===r||"<"===r?"<0.0.0-0":"*":r&&h?(u&&(i=0),a=0,">"===r?(r=">=",u?(s=+s+1,i=0,a=0):(i=+i+1,a=0)):"<="===r&&(r="<",u?s=+s+1:i=+i+1),"<"===r&&(o="-0"),n=`${r+s}.${i}.${a}${o}`):u?n=`>=${s}.0.0${o} <${+s+1}.0.0-0`:d&&(n=`>=${s}.${i}.0${o} <${s}.${+i+1}.0-0`),c("xRange return",n),n})},O=(e,t)=>(c("replaceStars",e,t),e.trim().replace(u[d.STAR],"")),C=(e,t)=>(c("replaceGTE0",e,t),e.trim().replace(u[t.includePrerelease?d.GTE0PRE:d.GTE0],"")),A=e=>(t,n,r,s,i,a,o,c,l,u,d,h)=>`${n=v(r)?"":v(s)?`>=${r}.0.0${e?"-0":""}`:v(i)?`>=${r}.${s}.0${e?"-0":""}`:a?`>=${n}`:`>=${n}${e?"-0":""}`} ${c=v(l)?"":v(u)?`<${+l+1}.0.0-0`:v(d)?`<${l}.${+u+1}.0-0`:h?`<=${l}.${u}.${d}-${h}`:e?`<${l}.${u}.${+d+1}-0`:`<=${c}`}`.trim(),P=(e,t,n)=>{for(let n=0;n<e.length;n++)if(!e[n].test(t))return!1;if(t.prerelease.length&&!n.includePrerelease){for(let n=0;n<e.length;n++)if(c(e[n].semver),e[n].semver!==o.ANY&&e[n].semver.prerelease.length>0){const r=e[n].semver;if(r.major===t.major&&r.minor===t.minor&&r.patch===t.patch)return!0}return!1}return!0}},8322:(e,t,n)=>{"use strict";var r,s=Object.defineProperty,i=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyNames,o=Object.prototype.hasOwnProperty,c={};((e,t)=>{for(var n in t)s(e,n,{get:t[n],enumerable:!0})})(c,{geolocation:()=>l.geolocation,getEnv:()=>u.getEnv,ipAddress:()=>l.ipAddress,next:()=>h.next,rewrite:()=>h.rewrite,waitUntil:()=>d.waitUntil}),e.exports=(r=c,((e,t,n,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let c of a(t))o.call(e,c)||c===n||s(e,c,{get:()=>t[c],enumerable:!(r=i(t,c))||r.enumerable});return e})(s({},"__esModule",{value:!0}),r));var l=n(1400),u=n(7820),d=n(2788),h=n(4640)},8557:(e,t,n)=>{"use strict";n.d(t,{vd:()=>r.vd,hU:()=>l.hU,CC:()=>r.CC,_6:()=>c});var r=n(6792),s=n(5721);s.k;s.k;s.k;var i=n(2080),a=n(7942),o=n(7671);class c extends r.mJ{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(i.Ik(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,i.Yj().describe(t)]))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify((0,o.PF)(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(e,t)=>`"${t.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await(0,a.hZ)(this.schema,JSON.parse(t))}catch(t){throw new r.CC(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}r.mJ;var l=n(3263);n(9641);s.T},8568:(e,t,n)=>{"use strict";n.d(t,{k:()=>i});for(var r=[],s=0;s<256;++s)r.push((s+256).toString(16).slice(1));function i(e,t=0){return(r[e[t+0]]+r[e[t+1]]+r[e[t+2]]+r[e[t+3]]+"-"+r[e[t+4]]+r[e[t+5]]+"-"+r[e[t+6]]+r[e[t+7]]+"-"+r[e[t+8]]+r[e[t+9]]+"-"+r[e[t+10]]+r[e[t+11]]+r[e[t+12]]+r[e[t+13]]+r[e[t+14]]+r[e[t+15]]).toLowerCase()}},8587:e=>{"use strict";const t=Object.freeze({loose:!0}),n=Object.freeze({});e.exports=e=>e?"object"!=typeof e?t:e:n},8675:(e,t,n)=>{"use strict";n.d(t,{FK:()=>i,mg:()=>s});var r=n(3490);class s extends r.XQ{static lc_name(){return"FunctionMessage"}constructor(e,t){"string"==typeof e&&(e={content:e,name:t}),super(e)}_getType(){return"function"}}class i extends r.gj{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new i({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}},8687:(e,t,n)=>{"use strict";n.d(t,{jY:()=>r.jY,kI:()=>r.kI,zZ:()=>r.zZ});var r=n(4508)},8794:e=>{"use strict";e.exports=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}},8851:(e,t,n)=>{"use strict";n.d(t,{Gd:()=>p});var r=n(2080);const s=r.Ik({msgId:r.Yj(),content:r.Yj(),role:r.k5(["thinking","user","assistant","error","plan_editor"]),ts:r.ai()}),i=r.Ik({requestId:r.Yj(),prompt:r.Yj()}),a=r.Ik({requestId:r.Yj(),action:r.k5(["done","abort"])}),o=r.Ik({id:r.Yj(),action:r.Yj(),reasoning:r.Yj().optional(),order:r.ai(),isEditable:r.zM().default(!0)}),c=r.Ik({planId:r.Yj(),steps:r.YO(o),task:r.Yj(),isPreview:r.zM().default(!0)}),l=r.Ik({planId:r.Yj(),action:r.k5(["execute","cancel"]),steps:r.YO(o).optional()}),u=r.Ik({eventType:r.k5(["recording_started","recording_stopped","event_captured","state_captured","transcript_update","tab_switched","viewport_updated","preprocessing_started","preprocessing_progress","preprocessing_completed","preprocessing_failed","execution_started","execution_thinking","execution_completed","execution_failed"]),sessionId:r.Yj(),data:r.bz()});r.gM("type",[r.Ik({type:r.eu("message"),payload:s}),r.Ik({type:r.eu("human-input-request"),payload:i}),r.Ik({type:r.eu("human-input-response"),payload:a}),r.Ik({type:r.eu("plan-edit-request"),payload:c}),r.Ik({type:r.eu("plan-edit-response"),payload:l}),r.Ik({type:r.eu("teach-mode-event"),payload:u})]);var d=n(2783),h=n(454);class p{static getChannel(e){let t=p.channels.get(e);return t?(p.clearCleanupTimer(e),t):(t=new d.D(e),p.channels.set(e,t),h.y7.log("PubSub",`Created channel for execution ${e} (total: ${p.channels.size})`),t)}static deleteChannel(e,t=!1){t?p.performChannelCleanup(e):p.scheduleCleanup(e)}static performChannelCleanup(e){const t=p.channels.get(e);t&&(t.destroy(),p.channels.delete(e),p.clearCleanupTimer(e),h.y7.log("PubSub",`Deleted channel for execution ${e} (remaining: ${p.channels.size})`))}static scheduleCleanup(e){p.clearCleanupTimer(e);const t=setTimeout(()=>{h.y7.log("PubSub",`Auto-cleanup triggered for channel ${e}`),p.performChannelCleanup(e)},p.CHANNEL_CLEANUP_TIMEOUT);p.cleanupTimers.set(e,t)}static clearCleanupTimer(e){const t=p.cleanupTimers.get(e);t&&(clearTimeout(t),p.cleanupTimers.delete(e))}static hasChannel(e){return p.channels.has(e)}static getActiveChannelIds(){return Array.from(p.channels.keys())}static getStats(){return{totalChannels:p.channels.size,channelIds:Array.from(p.channels.keys()),pendingCleanups:p.cleanupTimers.size}}static deleteAllChannels(){for(const e of p.cleanupTimers.values())clearTimeout(e);p.cleanupTimers.clear();for(const[e,t]of p.channels)t.destroy();p.channels.clear(),h.y7.log("PubSub","Deleted all channels")}static generateId(e="msg"){return`${e}_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}static createMessage(e,t="thinking"){return{msgId:p.generateId(`msg_${t}`),content:e,role:t,ts:Date.now()}}static createMessageWithId(e,t,n="thinking"){return{msgId:e,content:t,role:n,ts:Date.now()}}}p.channels=new Map,p.cleanupTimers=new Map,p.CHANNEL_CLEANUP_TIMEOUT=6e5},8999:(e,t,n)=>{"use strict";n.d(t,{y:()=>l,Z:()=>c});var r=n(9478);n(2729);function s(e,t){return t?.[e]||r(e)}function i(e,t,n){const r={};for(const s in e)Object.hasOwn(e,s)&&(r[t(s,n)]=e[s]);return r}function a(e){return Array.isArray(e)?[...e]:{...e}}function o(e,t){const n=a(e);for(const[e,r]of Object.entries(t)){const[t,...s]=e.split(".").reverse();let i=n;for(const e of s.reverse()){if(void 0===i[e])break;i[e]=a(i[e]),i=i[e]}void 0!==i[t]&&(i[t]={lc:1,type:"secret",id:[r]})}return n}function c(e){const t=Object.getPrototypeOf(e);return"function"==typeof e.lc_name&&("function"!=typeof t.lc_name||e.lc_name()!==t.lc_name())?e.lc_name():e.name}class l{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,c(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),void 0!==this.lc_serializable_keys?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([e])=>this.lc_serializable_keys?.includes(e))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof l||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(t,Reflect.get(r,"lc_secrets",this)),Object.assign(n,Reflect.get(r,"lc_attributes",this));return Object.keys(t).forEach(e=>{let t=this,r=n;const[s,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;e in r&&void 0!==r[e]||("object"==typeof t[e]&&null!=t[e]?r[e]={}:Array.isArray(t[e])&&(r[e]=[])),t=t[e],r=r[e]}s in t&&void 0!==t[s]&&(r[s]=r[s]||t[s])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:i(Object.keys(t).length?o(n,t):n,s,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}},9033:(e,t,n)=>{"use strict";n.d(t,{Kj:()=>Z});var r=n(7237);const s="gen_ai.request.model",i="gen_ai.usage.input_tokens",a="gen_ai.usage.output_tokens",o="gen_ai.usage.total_tokens",c="langsmith.span.tags";var l=n(4785);class u{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){let n;if(!this.hasWarned&&(0,l.QK)()&&(this.hasWarned=!0),1===t.length&&"function"==typeof t[0]?n=t[0]:2===t.length&&"function"==typeof t[1]?n=t[1]:3===t.length&&"function"==typeof t[2]&&(n=t[2]),"function"==typeof n)return n()}}const d=Symbol.for("ls:otel_trace"),h=Symbol.for("ls:otel_context"),p=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),m=new class{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new u})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}},g=new class{active(){return{}}with(e,t){return t()}};const f=new class{getTraceInstance(){return globalThis[d]??m}getContextInstance(){return globalThis[h]??g}initializeGlobalInstances(e){void 0===globalThis[d]&&(globalThis[d]=e.trace),void 0===globalThis[h]&&(globalThis[h]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[p]=e}getDefaultOTLPTracerComponents(){return globalThis[p]??void 0}};function y(){return f.getTraceInstance()}const _={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};class b{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(const n of e)try{if(!n.run)continue;if("post"===n.operation){const e=this.createSpanForRun(n,n.run,t.get(n.id));e&&!n.run.end_time&&this.spans.set(n.id,e)}else this.updateSpanForRun(n,n.run)}catch(e){}}createSpanForRun(e,t,n){const r=n&&y().getSpan(n);if(r)try{return this.finishSpanSetup(r,t,e)}catch(e){return}}finishSpanSetup(e,t,n){return this.setSpanAttributes(e,t,n),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{const n=this.spans.get(e.id);if(!n)return;this.setSpanAttributes(n,t,e),t.error?(n.setStatus({code:2}),n.recordException(new Error(t.error))):n.setStatus({code:1});const r=t.end_time;r&&(n.end(new Date(r)),this.spans.delete(e.id))}catch(e){}}extractModelName(e){if(e.extra?.metadata){const t=e.extra.metadata;if(t.ls_model_name)return t.ls_model_name;if(t.invocation_params){const e=t.invocation_params;if(e.model)return e.model;if(e.model_name)return e.model_name}}}setSpanAttributes(e,t,n){if("run_type"in t&&t.run_type){e.setAttribute("langsmith.span.kind",t.run_type);const n=(r=t.run_type||"chain",_[r]||r);e.setAttribute("gen_ai.operation.name",n)}var r;"name"in t&&t.name&&e.setAttribute("langsmith.trace.name",t.name),"session_id"in t&&t.session_id&&e.setAttribute("langsmith.trace.session_id",t.session_id),"session_name"in t&&t.session_name&&e.setAttribute("langsmith.trace.session_name",t.session_name),this.setGenAiSystem(e,t);const l=this.extractModelName(t);l&&e.setAttribute(s,l),"prompt_tokens"in t&&"number"==typeof t.prompt_tokens&&e.setAttribute(i,t.prompt_tokens),"completion_tokens"in t&&"number"==typeof t.completion_tokens&&e.setAttribute(a,t.completion_tokens),"total_tokens"in t&&"number"==typeof t.total_tokens&&e.setAttribute(o,t.total_tokens),this.setInvocationParameters(e,t);const u=t.extra?.metadata||{};for(const[t,n]of Object.entries(u))null!=n&&e.setAttribute(`langsmith.metadata.${t}`,String(n));const d=t.tags;if(d&&Array.isArray(d)?e.setAttribute(c,d.join(", ")):d&&e.setAttribute(c,String(d)),"serialized"in t&&"object"==typeof t.serialized){const n=t.serialized;n.name&&e.setAttribute("gen_ai.serialized.name",String(n.name)),n.signature&&e.setAttribute("gen_ai.serialized.signature",String(n.signature)),n.doc&&e.setAttribute("gen_ai.serialized.doc",String(n.doc))}this.setIOAttributes(e,n)}setGenAiSystem(e,t){let n="langchain";const r=this.extractModelName(t);if(r){const e=r.toLowerCase();e.includes("anthropic")||e.startsWith("claude")?n="anthropic":e.includes("bedrock")?n="aws.bedrock":e.includes("azure")&&e.includes("openai")?n="az.ai.openai":e.includes("azure")&&e.includes("inference")?n="az.ai.inference":e.includes("cohere")?n="cohere":e.includes("deepseek")?n="deepseek":e.includes("gemini")?n="gemini":e.includes("groq")?n="groq":e.includes("watson")||e.includes("ibm")?n="ibm.watsonx.ai":e.includes("mistral")?n="mistral_ai":e.includes("gpt")||e.includes("openai")?n="openai":e.includes("perplexity")||e.includes("sonar")?n="perplexity":e.includes("vertex")?n="vertex_ai":(e.includes("xai")||e.includes("grok"))&&(n="xai")}e.setAttribute("gen_ai.system",n)}setInvocationParameters(e,t){if(!t.extra?.metadata?.invocation_params)return;const n=t.extra.metadata.invocation_params;void 0!==n.max_tokens&&e.setAttribute("gen_ai.request.max_tokens",n.max_tokens),void 0!==n.temperature&&e.setAttribute("gen_ai.request.temperature",n.temperature),void 0!==n.top_p&&e.setAttribute("gen_ai.request.top_p",n.top_p),void 0!==n.frequency_penalty&&e.setAttribute("gen_ai.request.frequency_penalty",n.frequency_penalty),void 0!==n.presence_penalty&&e.setAttribute("gen_ai.request.presence_penalty",n.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{const n=t.run.inputs;"object"==typeof n&&null!==n&&(n.model&&Array.isArray(n.messages)&&e.setAttribute(s,n.model),void 0!==n.stream&&e.setAttribute("langsmith.request.streaming",n.stream),n.extra_headers&&e.setAttribute("langsmith.request.headers",JSON.stringify(n.extra_headers)),n.extra_query&&e.setAttribute("gen_ai.request.extra_query",JSON.stringify(n.extra_query)),n.extra_body&&e.setAttribute("gen_ai.request.extra_body",JSON.stringify(n.extra_body))),e.setAttribute("gen_ai.prompt",JSON.stringify(n))}catch(e){}if(t.run.outputs)try{const n=t.run.outputs,r=this.getUnifiedRunTokens(n);if(r&&(e.setAttribute(i,r[0]),e.setAttribute(a,r[1]),e.setAttribute(o,r[0]+r[1])),n&&"object"==typeof n){if(n.model&&e.setAttribute("gen_ai.response.model",String(n.model)),n.id&&e.setAttribute("gen_ai.response.id",n.id),n.choices&&Array.isArray(n.choices)){const t=n.choices.map(e=>e.finish_reason).filter(e=>e).map(String);t.length>0&&e.setAttribute("gen_ai.response.finish_reasons",t.join(", "))}if(n.service_tier&&e.setAttribute("gen_ai.response.service_tier",n.service_tier),n.system_fingerprint&&e.setAttribute("gen_ai.response.system_fingerprint",n.system_fingerprint),n.usage_metadata&&"object"==typeof n.usage_metadata){const t=n.usage_metadata;t.input_token_details&&e.setAttribute("gen_ai.usage.input_token_details",JSON.stringify(t.input_token_details)),t.output_token_details&&e.setAttribute("gen_ai.usage.output_token_details",JSON.stringify(t.output_token_details))}}e.setAttribute("gen_ai.completion",JSON.stringify(n))}catch(e){}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;const n=Object.keys(e);for(const r of n){const n=e[r];if(n&&"object"==typeof n){if(t=this.extractUnifiedRunTokens(n.usage_metadata),t)return t;if(1===n.lc&&n.kwargs&&"object"==typeof n.kwargs&&(t=this.extractUnifiedRunTokens(n.kwargs.usage_metadata),t))return t}}const r=e.generations||[];if(!Array.isArray(r))return null;const s=Array.isArray(r[0])?r.flat():r;for(const e of s)if("object"==typeof e&&e.message&&"object"==typeof e.message&&e.message.kwargs&&"object"==typeof e.message.kwargs&&(t=this.extractUnifiedRunTokens(e.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return e&&"object"==typeof e?"number"!=typeof e.input_tokens||"number"!=typeof e.output_tokens?null:[e.input_tokens,e.output_tokens]:null}}var w=n(4116),v=n(3290);const E=[429,500,502,503,504];class S{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue=new v.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const n=this.onFailedResponseHook;return this.queue.add(()=>w(()=>e(...t).catch(e=>{throw e instanceof Error?e:new Error(e)}),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||"TimeoutError"===e.name||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response;if(n){if(await n(t))return}const r=t?.status??e?.status;if(r&&!E.includes(+r))throw e},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise((t,n)=>{e.signal?.addEventListener("abort",()=>{n(new Error("AbortError"))})})]):this.call(t,...n)}}function x(e){return"function"==typeof e?._getType}function k(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}var T=n(6928);const I=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function O(e,t){if(!I.test(e)){throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`)}return e}var C=n(6232);n(9589);function A(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,n]=e.split(":"),r=n||"latest";if(t.includes("/")){const[n,s]=t.split("/",2);if(!n||!s)throw new Error(`Invalid identifier format: ${e}`);return[n,s,r]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,r]}var P=n(8152),M=n(747),R="[...]",$={result:"[Circular]"},j=[],N=[];const L=new TextEncoder;function D(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function U(e){return L.encode(e)}function F(e){if(e&&"object"==typeof e&&null!==e){if(e instanceof Map)return Object.fromEntries(e);if(e instanceof Set)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof RegExp)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message}}else if("bigint"==typeof e)return e.toString();return e}function Y(e,t,n,r,s){try{return U(JSON.stringify(e,(i=n,function(e,t){if(i){const n=i.call(this,e,t);if(void 0!==n)return n}return F(t)}),r))}catch(t){if(!t.message?.includes("Converting circular structure to JSON"))return U("[Unserializable]");let i;(0,l.Jz)("SUPPRESS_CIRCULAR_JSON_WARNINGS"),void 0===s&&(s=D()),B(e,"",0,[],void 0,0,s);try{i=0===N.length?JSON.stringify(e,n,r):JSON.stringify(e,H(n),r)}catch(e){return U("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==j.length;){const e=j.pop();4===e.length?Object.defineProperty(e[0],e[1],e[3]):e[0][e[1]]=e[2]}}return U(i)}var i}function G(e,t,n,r){var s=Object.getOwnPropertyDescriptor(r,n);void 0!==s.get?s.configurable?(Object.defineProperty(r,n,{value:e}),j.push([r,n,t,s])):N.push([t,n,e]):(r[n]=e,j.push([r,n,t]))}function B(e,t,n,r,s,i,a){var o;if(i+=1,"object"==typeof e&&null!==e){for(o=0;o<r.length;o++)if(r[o]===e)return void G($,e,t,s);if(void 0!==a.depthLimit&&i>a.depthLimit)return void G(R,e,t,s);if(void 0!==a.edgesLimit&&n+1>a.edgesLimit)return void G(R,e,t,s);if(r.push(e),Array.isArray(e))for(o=0;o<e.length;o++)B(e[o],o,o,r,e,i,a);else{e=F(e);var c=Object.keys(e);for(o=0;o<c.length;o++){var l=c[o];B(e[l],l,o,r,e,i,a)}}r.pop()}}function H(e){return e=void 0!==e?e:function(e,t){return t},function(t,n){if(N.length>0)for(var r=0;r<N.length;r++){var s=N[r];if(s[1]===t&&s[0]===n){n=s[2],N.splice(r,1);break}}return e.call(this,t,n)}}function z(e){const t=(0,l.Ec)(),n=(0,l.yk)(),r=e.extra??{},s=r.metadata;return e.extra={...r,runtime:{...t,...r?.runtime},metadata:{...n,...n.revision_id||"revision_id"in e&&e.revision_id?{revision_id:("revision_id"in e?e.revision_id:void 0)??n.revision_id}:{},...s}},e}function q(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const K=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"10",10);if(t>0)return await new Promise(e=>setTimeout(e,t)),!0}return!1};function W(e){return"number"==typeof e?Number(e.toFixed(4)):e}class V{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const n=new Promise(e=>{t=e}),r=Y(e.item,e.item.id).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:n,size:r}),this.sizeBytes+=r,n}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let n=0;for(;n+(this.peek()?.size??0)<e&&this.items.length>0;){const e=this.items.shift();e&&(t.push(e),n+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){const e=this.items.shift();t.push(e),n+=e.size,this.sizeBytes-=e.size}return[t.map(e=>({action:e.action,item:e.payload,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl})),()=>t.forEach(e=>e.itemPromiseResolve())]}}const J="https://api.smith.langchain.com";class Z{get _fetch(){return this.fetchImplementation||(0,M.Yx)(this.debug)}constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new V}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===(0,l.Az)("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:"true"===(0,l.Az)("LANGSMITH_DEBUG")});const t=Z.getDefaultClientConfig();if(this.tracingSampleRate=(e=>{const t=e?.toString()??(0,l.Jz)("TRACING_SAMPLING_RATE");if(void 0===t)return;const n=parseFloat(t);if(n<0||n>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${n}`);return n})(e.tracingSamplingRate),this.apiUrl=q(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=q(e.apiKey??t.apiKey),this.webUrl=q(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=q(e.workspaceId??(0,l.Jz)("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new S({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation,this.batchIngestCaller=new S({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:K,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,(0,l.QK)()&&(this.langSmithToOTELTranslator=new b)}static getDefaultClientConfig(){const e=(0,l.Jz)("API_KEY");return{apiUrl:(0,l.Jz)("ENDPOINT")??J,apiKey:e,webUrl:void 0,hideInputs:"true"===(0,l.Jz)("HIDE_INPUTS"),hideOutputs:"true"===(0,l.Jz)("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(e=>{const t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${T.Ls}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return"/v1"!==this.apiUrl.slice(-3)&&"/v1/"!==this.apiUrl.slice(-4)?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}async processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=await this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",r=`${this.apiUrl}${e}?${n}`;return await this.caller.call(async()=>{const t=await this._fetch(r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,`Failed to fetch ${e}`),t})}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let r=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(s));const i=`${this.apiUrl}${e}?${t}`,a=await this.caller.call(async()=>{const t=await this._fetch(i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,`Failed to fetch ${e}`),t}),o=n?n(await a.json()):await a.json();if(0===o.length)break;if(yield o,o.length<s)break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,n="POST",r="runs"){const s=t?{...t}:{};for(;;){const t=JSON.stringify(s),i=await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:t});return await(0,P.gJ)(r,`Failed to fetch ${e}`),r}),a=await i.json();if(!a)break;if(!a[r])break;yield a[r];const o=a.cursors;if(!o)break;if(!o.next)break;s.cursor=o.next}}_shouldSample(){return void 0===this.tracingSampleRate||Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const n of e)this.filteredPostUuids.has(n.trace_id)?n.id===n.trace_id&&this.filteredPostUuids.delete(n.trace_id):t.push(n);return t}{const t=[];for(const n of e){const e=n.trace_id??n.id;this.filteredPostUuids.has(e)||(n.id===e?this._shouldSample()?t.push(n):this.filteredPostUuids.add(e):t.push(n))}return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??25165824}async _getDatasetExamplesMultiPartSupport(){const e=await this._ensureServerInfo();return e.instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue(e){const t=[];for(;this.autoBatchQueue.items.length>0;){const[n,r]=this.autoBatchQueue.pop(e);if(!n.length){r();break}const s=n.reduce((e,t)=>{const n=t.apiUrl??this.apiUrl,r=t.apiKey??this.apiKey,s=t.apiKey===this.apiKey&&t.apiUrl===this.apiUrl?"default":`${n}|${r}`;return e[s]||(e[s]=[]),e[s].push(t),e},{}),i=[];for(const[e,t]of Object.entries(s)){const n=this._processBatch(t,{apiUrl:"default"===e?void 0:e.split("|")[0],apiKey:"default"===e?void 0:e.split("|")[1]});i.push(n)}const a=Promise.all(i).finally(r);t.push(a)}return Promise.all(t)}async _processBatch(e,t){if(e.length)try{if(void 0!==this.langSmithToOTELTranslator)this._sendBatchToOTELTranslator(e);else{const n={runCreates:e.filter(e=>"create"===e.action).map(e=>e.item),runUpdates:e.filter(e=>"update"===e.action).map(e=>e.item)},r=await this._ensureServerInfo();if(r?.batch_ingest_config?.use_multipart_endpoint){const e=r?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(n,{...t,useGzip:e})}else await this.batchIngestRuns(n,t)}}catch(e){}}_sendBatchToOTELTranslator(e){if(void 0!==this.langSmithToOTELTranslator){const t=new Map,n=[];for(const r of e)r.item.id&&r.otelContext&&(t.set(r.item.id,r.otelContext),"create"===r.action?n.push({operation:"post",id:r.item.id,trace_id:r.item.trace_id??r.item.id,run:r.item}):n.push({operation:"patch",id:r.item.id,trace_id:r.item.trace_id??r.item.id,run:r.item}));this.langSmithToOTELTranslator.exportBatch(n,t)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=z(e.item);const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const n=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>n&&this.drainAutoBatchQueue(n),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(n)},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(1e4),...this.fetchOptions});return await(0,P.gJ)(e,"get server info"),e}),t=await e.json();return this.debug,t}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}_cloneCurrentOTELContext(){const e=y(),t=f.getContextInstance();if(void 0!==this.langSmithToOTELTranslator){const n=e.getActiveSpan();if(n)return e.setSpan(t.active(),n)}}async createRun(e,t){if(!this._filterForSampling([e]).length)return;const n={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const s=await this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==s.trace_id&&void 0!==s.dotted_order){const e=this._cloneCurrentOTELContext();return void this.processRunOperation({action:"create",item:s,otelContext:e,apiKey:t?.apiKey,apiUrl:t?.apiUrl}).catch(console.error)}const i=z(s);void 0!==t?.apiKey&&(n["x-api-key"]=t.apiKey),void 0!==t?.workspaceId&&(n["x-tenant-id"]=t.workspaceId);const a=Y(i,i.id);await this.caller.call(async()=>{const e=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await(0,P.gJ)(e,"create run",!0),e})}async batchIngestRuns({runCreates:e,runUpdates:t},n){if(void 0===e&&void 0===t)return;let r=await Promise.all(e?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]),s=await Promise.all(t?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]);if(r.length>0&&s.length>0){const e=r.reduce((e,t)=>t.id?(e[t.id]=t,e):e,{}),t=[];for(const n of s)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);r=Object.values(e),s=t}const i={post:r,patch:s};if(!i.post.length&&!i.patch.length)return;const a={post:[],patch:[]};for(const e of["post","patch"]){const t=e,n=i[t].reverse();let r=n.pop();for(;void 0!==r;)a[t].push(r),r=n.pop()}if(a.post.length>0||a.patch.length>0){a.post.map(e=>e.id).concat(a.patch.map(e=>e.id)).join(",");await this._postBatchIngestRuns(Y(a),n)}}async _postBatchIngestRuns(e,t){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};void 0!==t?.apiKey&&(n["x-api-key"]=t.apiKey),await this.batchIngestCaller.call(async()=>{const r=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await(0,P.gJ)(r,"batch create run",!0),r})}async multipartIngestRuns({runCreates:e,runUpdates:t},n){if(void 0===e&&void 0===t)return;const r={};let s=[];for(const t of e??[]){const e=await this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(r[e.id]=e.attachments),delete e.attachments,s.push(e)}let i=[];for(const e of t??[])i.push(await this.prepareRunCreateOrUpdateInputs(e));if(void 0!==s.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==i.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(s.length>0&&i.length>0){const e=s.reduce((e,t)=>t.id?(e[t.id]=t,e):e,{}),t=[];for(const n of i)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);s=Object.values(e),i=t}if(0===s.length&&0===i.length)return;const a=[],o=[];for(const[e,t]of[["post",s],["patch",i]])for(const n of t){const{inputs:t,outputs:s,events:i,extra:c,error:l,serialized:u,attachments:d,...h}=n,p={inputs:t,outputs:s,events:i,extra:c,error:l,serialized:u},m=Y(h,h.id);o.push({name:`${e}.${h.id}`,payload:new Blob([m],{type:`application/json; length=${m.length}`})});for(const[t,n]of Object.entries(p)){if(void 0===n)continue;const r=Y(n,h.id);o.push({name:`${e}.${h.id}.${t}`,payload:new Blob([r],{type:`application/json; length=${r.length}`})})}if(void 0!==h.id){const e=r[h.id];if(e){delete r[h.id];for(const[t,n]of Object.entries(e)){let e,r;Array.isArray(n)?[e,r]=n:(e=n.mimeType,r=n.data),t.includes(".")||o.push({name:`attachment.${h.id}.${t}`,payload:new Blob([r],{type:`${e}; length=${r.byteLength}`})})}}}a.push(`trace=${h.trace_id},id=${h.id}`)}await this._sendMultipartRequest(o,a.join("; "),n)}async _createNodeFetchBody(e,t){const n=[];for(const r of e)n.push(new Blob([`--${t}\r\n`])),n.push(new Blob([`Content-Disposition: form-data; name="${r.name}"\r\n`,`Content-Type: ${r.payload.type}\r\n\r\n`])),n.push(r.payload),n.push(new Blob(["\r\n"]));n.push(new Blob([`--${t}--\r\n`]));const r=new Blob(n);return await r.arrayBuffer()}async _createMultipartStream(e,t){const n=new TextEncoder;return new ReadableStream({async start(r){const s=async e=>{"string"==typeof e?r.enqueue(n.encode(e)):r.enqueue(e)};for(const n of e){await s(`--${t}\r\n`),await s(`Content-Disposition: form-data; name="${n.name}"\r\n`),await s(`Content-Type: ${n.payload.type}\r\n\r\n`);const e=n.payload.stream().getReader();try{let t;for(;!(t=await e.read()).done;)r.enqueue(t.value)}finally{e.releaseLock()}await s("\r\n")}await s(`--${t}--\r\n`),r.close()}})}async _sendMultipartRequest(e,t,n){const r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),s=(0,M.rO)(),i=()=>this._createNodeFetchBody(e,r),a=()=>this._createMultipartStream(e,r),o=async e=>this.batchIngestCaller.call(async()=>{const t=await e(),s={...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`};void 0!==n?.apiKey&&(s["x-api-key"]=n.apiKey);let i=t;n?.useGzip&&"object"==typeof t&&"pipeThrough"in t&&(i=t.pipeThrough(new CompressionStream("gzip")),s["Content-Encoding"]="gzip");const a=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:s,body:i,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(a,"Failed to send multipart request",!0),a});try{let e,t=!1;s||this.multipartStreamingDisabled||"bun"===(0,l._$)()?e=await o(i):(t=!0,e=await o(a)),this.multipartStreamingDisabled&&!t||422!==e.status||(n?.apiUrl??this.apiUrl)===J||(this.multipartStreamingDisabled=!0,e=await o(i))}catch(e){}}async updateRun(e,t,n){O(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order){const e=this._cloneCurrentOTELContext();return void 0!==t.end_time&&void 0===r.parent_run_id&&this.blockOnRootRunFinalization&&!this.manualFlushMode?void await this.processRunOperation({action:"update",item:r,otelContext:e,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error):void this.processRunOperation({action:"update",item:r,otelContext:e,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error)}const s={...this.headers,"Content-Type":"application/json"};void 0!==n?.apiKey&&(s["x-api-key"]=n.apiKey),void 0!==n?.workspaceId&&(s["x-tenant-id"]=n.workspaceId);const i=Y(t);await this.caller.call(async()=>{const t=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:s,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await(0,P.gJ)(t,"update run",!0),t})}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){O(e);let n=await this._get(`/runs/${e}`);return t&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(void 0!==t){let e;if(t.session_id)e=t.session_id;else if(n?.projectName)e=(await this.readProject({projectName:n?.projectName})).id;else if(n?.projectId)e=n?.projectId;else{e=(await this.readProject({projectName:(0,l.Jz)("PROJECT")||"default"})).id}const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),n={},r={};t.sort((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??""));for(const s of t){if(null===s.parent_run_id||void 0===s.parent_run_id)throw new Error(`Child run ${s.id} has no parent`);s.dotted_order?.startsWith(e.dotted_order??"")&&s.id!==e.id&&(s.parent_run_id in n||(n[s.parent_run_id]=[]),n[s.parent_run_id].push(s),r[s.id]=s)}e.child_runs=n[e.id]||[];for(const t in n)t!==e.id&&(r[t].child_runs=n[t]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:r,traceId:s,referenceExampleId:i,startTime:a,executionOrder:o,isRoot:c,runType:l,error:u,id:d,query:h,filter:p,traceFilter:m,treeFilter:g,limit:f,select:y,order:_}=e;let b=[];if(t&&(b=Array.isArray(t)?t:[t]),n){const e=Array.isArray(n)?n:[n],t=await Promise.all(e.map(e=>this.readProject({projectName:e}).then(e=>e.id)));b.push(...t)}const w={session:b.length?b:null,run_type:l,reference_example:i,query:h,filter:p,trace_filter:m,tree_filter:g,execution_order:o,parent_run:r,start_time:a?a.toISOString():null,error:u,id:d,limit:f,trace:s,select:y||["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c,order:_};let v=0;for await(const e of this._getCursorPaginatedList("/runs/query",w))if(f){if(v>=f)break;if(e.length+v>f){const t=e.slice(0,f-v);yield*t;break}v+=e.length,yield*e}else yield*e}async*listGroupRuns(e){const{projectId:t,projectName:n,groupBy:r,filter:s,startTime:i,endTime:a,limit:o,offset:c}=e,l={session_id:t||(await this.readProject({projectName:n})).id,group_by:r,filter:s,start_time:i?i.toISOString():null,end_time:a?a.toISOString():null,limit:Number(o)||100};let u=Number(c)||0;const d="/runs/group",h=`${this.apiUrl}${d}`;for(;;){const e={...l,offset:u},t=Object.fromEntries(Object.entries(e).filter(([e,t])=>void 0!==t)),n=JSON.stringify(t),r=await this.caller.call(async()=>{const e=await this._fetch(h,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await(0,P.gJ)(e,`Failed to fetch ${d}`),e}),s=await r.json(),{groups:i,total:a}=s;if(0===i.length)break;for(const e of i)yield e;if(u+=i.length,u>=a)break}}async getRunStats({id:e,trace:t,parentRun:n,runType:r,projectNames:s,projectIds:i,referenceExampleIds:a,startTime:o,endTime:c,error:l,query:u,filter:d,traceFilter:h,treeFilter:p,isRoot:m,dataSourceType:g}){let f=i||[];s&&(f=[...i||[],...await Promise.all(s.map(e=>this.readProject({projectName:e}).then(e=>e.id)))]);const y={id:e,trace:t,parent_run:n,run_type:r,session:f,reference_example:a,start_time:o,end_time:c,error:l,query:u,filter:d,trace_filter:h,tree_filter:p,is_root:m,data_source_type:g},_=Object.fromEntries(Object.entries(y).filter(([e,t])=>void 0!==t)),b=JSON.stringify(_),w=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:b});return await(0,P.gJ)(e,"get run stats"),e});return await w.json()}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||r.A()};O(e);const s=JSON.stringify(n),i=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await(0,P.gJ)(t,"share run"),t}),a=await i.json();if(null===a||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){O(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"unshare run",!0),t})}async readRunSharedLink(e){O(e);const t=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"read run shared link"),t}),n=await t.json();if(null!==n&&"share_token"in n)return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)n.append("id",e);O(e);const r=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"list shared runs"),t});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){const n=await this.readDataset({datasetName:t});e=n.id}O(e);const n=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"read dataset shared schema"),t}),r=await n.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){const n=await this.readDataset({datasetName:t});e=n.id}const n={dataset_id:e};O(e);const r=JSON.stringify(n),s=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await(0,P.gJ)(t,"share dataset"),t}),i=await s.json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){O(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"unshare dataset",!0),t})}async readSharedDataset(e){O(e);const t=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"read shared dataset"),t});return await t.json()}async listSharedExamples(e,t){const n={};t?.exampleIds&&(n.id=t.exampleIds);const r=new URLSearchParams;Object.entries(n).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>r.append(e,t)):r.append(e,t)});const s=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/examples?${r.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"list shared examples"),t}),i=await s.json();if(!s.ok){if("detail"in i)throw new Error(`Failed to list shared examples.\nStatus: ${s.status}\nMessage: ${Array.isArray(i.detail)?i.detail.join("\n"):"Unspecified error"}`);throw new Error(`Failed to list shared examples: ${s.status} ${s.statusText}`)}return i.map(e=>({...e,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:r=!1,projectExtra:s=null,referenceDatasetId:i=null}){const a=r?"?upsert=true":"",o=`${this.apiUrl}/sessions${a}`,c=s||{};n&&(c.metadata=n);const l={name:e,extra:c,description:t};null!==i&&(l.reference_dataset_id=i);const u=JSON.stringify(l),d=await this.caller.call(async()=>{const e=await this._fetch(o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await(0,P.gJ)(e,"create project"),e});return await d.json()}async updateProject(e,{name:t=null,description:n=null,metadata:r=null,projectExtra:s=null,endTime:i=null}){const a=`${this.apiUrl}/sessions/${e}`;let o=s;r&&(o={...o||{},metadata:r});const c=JSON.stringify({name:t,extra:o,description:n,end_time:i?new Date(i).toISOString():null}),l=await this.caller.call(async()=>{const e=await this._fetch(a,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await(0,P.gJ)(e,"update project"),e});return await l.json()}async hasProject({projectId:e,projectName:t}){let n="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)O(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const s=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(e,"has project"),e});try{const e=await s.json();return!!s.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let r="/sessions";const s=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)O(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");s.append("name",t)}void 0!==n&&s.append("include_stats",n.toString());const i=await this._get(r,s);let a;if(Array.isArray(i)){if(0===i.length)throw new Error(`Project[id=${e}, name=${t}] not found`);a=i[0]}else a=i;return a}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/datasets/${n.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:r,referenceDatasetName:s,includeStats:i,datasetVersion:a,referenceFree:o,metadata:c}={}){const l=new URLSearchParams;if(void 0!==e)for(const t of e)l.append("id",t);if(void 0!==t&&l.append("name",t),void 0!==n&&l.append("name_contains",n),void 0!==r)l.append("reference_dataset",r);else if(void 0!==s){const e=await this.readDataset({datasetName:s});l.append("reference_dataset",e.id)}void 0!==i&&l.append("include_stats",i.toString()),void 0!==a&&l.append("dataset_version",a),void 0!==o&&l.append("reference_free",o.toString()),void 0!==c&&l.append("metadata",JSON.stringify(c));for await(const e of this._getPaginated("/sessions",l))yield*e}async deleteProject({projectId:e,projectName:t}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");n=void 0===e?(await this.readProject({projectName:t})).id:e,O(n),await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(e,`delete session ${n} (${t})`,!0),e})}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:r,description:s,dataType:i,name:a}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),n.forEach(e=>{c.append("input_keys",e)}),r.forEach(e=>{c.append("output_keys",e)}),s&&c.append("description",s),i&&c.append("data_type",i),a&&c.append("name",a);const l=await this.caller.call(async()=>{const e=await this._fetch(o,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await(0,P.gJ)(e,"upload CSV"),e});return await l.json()}async createDataset(e,{description:t,dataType:n,inputsSchema:r,outputsSchema:s,metadata:i}={}){const a={name:e,description:t,extra:i?{metadata:i}:void 0};n&&(a.data_type=n),r&&(a.inputs_schema_definition=r),s&&(a.outputs_schema_definition=s);const o=JSON.stringify(a),c=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await(0,P.gJ)(e,"create dataset"),e});return await c.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(e&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(e)O(e),n+=`/${e}`;else{if(!t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const s=await this._get(n,r);let i;if(Array.isArray(s)){if(0===s.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:r}){let s=e;if(void 0===s&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==s&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===s){s=(await this.readDataset({datasetName:t})).id}const i=new URLSearchParams({from_version:"string"==typeof n?n:n.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide either datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const n=await this._getResponse(`/datasets/${e}/openai_ft`);return(await n.text()).trim().split("\n").map(e=>JSON.parse(e))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:r,datasetNameContains:s,metadata:i}={}){const a=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==n)for(const e of n)a.append("id",e);void 0!==r&&a.append("name",r),void 0!==s&&a.append("name_contains",s),void 0!==i&&a.append("metadata",JSON.stringify(i));for await(const e of this._getPaginated("/datasets",a))yield*e}async updateDataset(e){const{datasetId:t,datasetName:n,...r}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:n})).id;O(s);const i=JSON.stringify(r),a=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await(0,P.gJ)(e,"update dataset"),e});return await a.json()}async updateDatasetTag(e){const{datasetId:t,datasetName:n,asOf:r,tag:s}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const i=t??(await this.readDataset({datasetName:n})).id;O(i);const a=JSON.stringify({as_of:"string"==typeof r?r:r.toISOString(),tag:s});await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${i}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await(0,P.gJ)(e,"update dataset tags",!0),e})}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t){r=(await this.readDataset({datasetName:t})).id}if(void 0===r)throw new Error("Must provide datasetName or datasetId");O(r),n+=`/${r}`,await this.caller.call(async()=>{const e=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(e,`delete ${n}`,!0),e})}async indexDataset({datasetId:e,datasetName:t,tag:n}){let r=e;if(!r&&!t)throw new Error("Must provide either datasetName or datasetId");if(r&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(!r){const e=await this.readDataset({datasetName:t});r=e.id}O(r);const s={tag:n},i=JSON.stringify(s),a=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${r}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await(0,P.gJ)(e,"index dataset"),e});await a.json()}async similarExamples(e,t,n,{filter:r}={}){const s={limit:n,inputs:e};void 0!==r&&(s.filter=r),O(t);const i=JSON.stringify(s),a=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${t}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:i});return await(0,P.gJ)(e,"fetch similar examples"),e});return(await a.json()).examples}async createExample(e,t,n){if(X(e)&&(void 0!==t||void 0!==n))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=t?n?.datasetId:e.dataset_id;const i=t?n?.datasetName:e.dataset_name;if(void 0===s&&void 0===i)throw new Error("Must provide either datasetName or datasetId");if(void 0!==s&&void 0!==i)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===s){s=(await this.readDataset({datasetName:i})).id}const a=(t?n?.createdAt:e.created_at)||new Date;let o;o=X(e)?e:{inputs:e,outputs:t,created_at:a?.toISOString(),id:n?.exampleId,metadata:n?.metadata,split:n?.split,source_run_id:n?.sourceRunId,use_source_run_io:n?.useSourceRunIO,use_source_run_attachments:n?.useSourceRunAttachments,attachments:n?.attachments};const c=await this._uploadExamplesMultipart(s,[o]);return await this.readExample(c.example_ids?.[0]??r.A())}async createExamples(e){if(Array.isArray(e)){if(0===e.length)return[];const t=e;let n=t[0].dataset_id;const r=t[0].dataset_name;if(void 0===n&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==n&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===n){n=(await this.readDataset({datasetName:r})).id}const s=await this._uploadExamplesMultipart(n,t);return await Promise.all(s.example_ids.map(e=>this.readExample(e)))}const{inputs:t,outputs:n,metadata:r,splits:s,sourceRunIds:i,useSourceRunIOs:a,useSourceRunAttachments:o,attachments:c,exampleIds:l,datasetId:u,datasetName:d}=e;if(void 0===t)throw new Error("Must provide inputs when using legacy parameters");let h=u;const p=d;if(void 0===h&&void 0===p)throw new Error("Must provide either datasetName or datasetId");if(void 0!==h&&void 0!==p)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===h){const e=await this.readDataset({datasetName:p});h=e.id}const m=t.map((e,t)=>({dataset_id:h,inputs:e,outputs:n?.[t],metadata:r?.[t],split:s?.[t],id:l?.[t],attachments:c?.[t],source_run_id:i?.[t],use_source_run_io:a?.[t],use_source_run_attachments:o?.[t]})),g=await this._uploadExamplesMultipart(h,m);return await Promise.all(g.example_ids.map(e=>this.readExample(e)))}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const r=e.map(e=>x(e)?k(e):e),s=x(t)?k(t):t;return this.createExample({input:r},{output:s},n)}async readExample(e){O(e);const t=`/examples/${e}`,n=await this._get(t),{attachment_urls:r,...s}=n,i=s;return r&&(i.attachments=Object.entries(r).reduce((e,[t,n])=>(e[t.slice(11)]={presigned_url:n.presigned_url,mime_type:n.mime_type},e),{})),i}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:r,splits:s,inlineS3Urls:i,metadata:a,limit:o,offset:c,filter:l,includeAttachments:u}={}){let d;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)d=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");d=(await this.readDataset({datasetName:t})).id}const h=new URLSearchParams({dataset:d}),p=r?"string"==typeof r?r:r?.toISOString():void 0;p&&h.append("as_of",p);const m=i??!0;if(h.append("inline_s3_urls",m.toString()),void 0!==n)for(const e of n)h.append("id",e);if(void 0!==s)for(const e of s)h.append("splits",e);if(void 0!==a){const e=JSON.stringify(a);h.append("metadata",e)}void 0!==o&&h.append("limit",o.toString()),void 0!==c&&h.append("offset",c.toString()),void 0!==l&&h.append("filter",l),!0===u&&["attachment_urls","outputs","metadata"].forEach(e=>h.append("select",e));let g=0;for await(const e of this._getPaginated("/examples",h)){for(const t of e){const{attachment_urls:e,...n}=t,r=n;e&&(r.attachments=Object.entries(e).reduce((e,[t,n])=>(e[t.slice(11)]={presigned_url:n.presigned_url,mime_type:n.mime_type||void 0},e),{})),yield r,g++}if(void 0!==o&&g>=o)break}}async deleteExample(e){O(e);const t=`/examples/${e}`;await this.caller.call(async()=>{const e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(e,`delete ${t}`,!0),e})}async updateExample(e,t){let n,r,s;if(n=t?e:e.id,O(n),r=t?{id:n,...t}:e,void 0!==r.dataset_id)s=r.dataset_id;else{s=(await this.readExample(n)).dataset_id}return this._updateExamplesMultipart(s,[r])}async updateExamples(e){let t;if(void 0===e[0].dataset_id){t=(await this.readExample(e[0].id)).dataset_id}else t=e[0].dataset_id;return this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:n,tag:r}){let s;if(e)s=e;else{const e=await this.readDataset({datasetName:t});s=e.id}if(O(s),n&&r||!n&&!r)throw new Error("Exactly one of asOf and tag must be specified.");const i=new URLSearchParams;void 0!==n&&i.append("as_of","string"==typeof n?n:n.toISOString()),void 0!==r&&i.append("tag",r);const a=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${s}/version?${i.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(e,"read dataset version"),e});return await a.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){r=(await this.readDataset({datasetName:t})).id}else r=e;O(r);const s=new URLSearchParams,i=n?"string"==typeof n?n:n?.toISOString():void 0;i&&s.append("as_of",i);return await this._get(`/datasets/${r}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:r,remove:s=!1}){let i;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){const e=await this.readDataset({datasetName:t});i=e.id}else i=e;O(i);const a={split_name:n,examples:r.map(e=>(O(e),e)),remove:s},o=JSON.stringify(a);await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await(0,P.gJ)(e,"update dataset splits",!0),e})}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:r,referenceExample:s}={loadChildRuns:!1}){let i;if((0,C.m)("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)i=await this.readRun(e,{loadChildRuns:r});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);i=e}null!==i.reference_example_id&&void 0!==i.reference_example_id&&(s=await this.readExample(i.reference_example_id));const a=await t.evaluateRun(i,s),[o,c]=await this._logEvaluationFeedback(a,i,n);return c[0]}async createFeedback(e,t,{score:n,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:l,feedbackId:u,feedbackConfig:d,projectId:h,comparativeExperimentId:p}){if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const m={type:c??"api",metadata:o??{}};void 0===l||void 0===m?.metadata||m.metadata.__run||(m.metadata.__run={run_id:l}),void 0!==m?.metadata&&void 0!==m.metadata.__run?.run_id&&O(m.metadata.__run.run_id);const g={id:u??r.A(),run_id:e,key:t,score:W(n),value:s,correction:i,comment:a,feedback_source:m,comparative_experiment_id:p,feedbackConfig:d,session_id:h},f=JSON.stringify(g),y=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const e=await this._fetch(y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:f});return await(0,P.gJ)(e,"create feedback",!0),e}),g}async updateFeedback(e,{score:t,value:n,correction:r,comment:s}){const i={};null!=t&&(i.score=W(t)),null!=n&&(i.value=n),null!=r&&(i.correction=r),null!=s&&(i.comment=s),O(e);const a=JSON.stringify(i);await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await(0,P.gJ)(t,"update feedback",!0),t})}async readFeedback(e){O(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){O(e);const t=`/feedback/${e}`;await this.caller.call(async()=>{const e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(e,`delete ${t}`,!0),e})}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e)for(const t of e)O(t),r.append("run",t);if(t)for(const e of t)r.append("key",e);if(n)for(const e of n)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:r}={}){const s={run_id:e,feedback_key:t,feedback_config:r};n?"string"==typeof n?s.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(s.expires_in=n):s.expires_in={hours:3};const i=JSON.stringify(s),a=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await(0,P.gJ)(e,"create presigned feedback token"),e});return await a.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:r,description:s,metadata:i,id:a}){if(0===t.length)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!n)throw new Error("A reference dataset is required");const o={id:a,name:e,experiment_ids:t,reference_dataset_id:n,description:s,created_at:(r??new Date)?.toISOString(),extra:{}};i&&(o.extra.metadata=i);const c=JSON.stringify(o);return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await(0,P.gJ)(e,"create comparative experiment"),e})).json()}async*listPresignedFeedbackTokens(e){O(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:Array.isArray(e)?e:[e],t}async _logEvaluationFeedback(e,t,n){const r=this._selectEvalResults(e),s=[];for(const e of r){let r=n||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let i=null;e.targetRunId?i=e.targetRunId:t&&(i=t.id),s.push(await this.createFeedback(i,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[r,s]}async logEvaluationFeedback(e,t,n){const[r]=await this._logEvaluationFeedback(e,t,n);return r}async*listAnnotationQueues(e={}){const{queueIds:t,name:n,nameContains:r,limit:s}=e,i=new URLSearchParams;t&&t.forEach((e,t)=>{O(e,`queueIds[${t}]`),i.append("ids",e)}),n&&i.append("name",n),r&&i.append("name_contains",r),i.append("limit",(void 0!==s?Math.min(s,100):100).toString());let a=0;for await(const e of this._getPaginated("/annotation-queues",i))if(yield*e,a++,void 0!==s&&a>=s)break}async createAnnotationQueue(e){const{name:t,description:n,queueId:s,rubricInstructions:i}=e,a={name:t,description:n,id:s||r.A(),rubric_instructions:i},o=JSON.stringify(Object.fromEntries(Object.entries(a).filter(([e,t])=>void 0!==t)));return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await(0,P.gJ)(e,"create annotation queue"),e})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${O(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"read annotation queue"),t})).json()}async updateAnnotationQueue(e,t){const{name:n,description:r,rubricInstructions:s}=t,i=JSON.stringify({name:n,description:r,rubric_instructions:s});await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${O(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await(0,P.gJ)(t,"update annotation queue",!0),t})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${O(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"delete annotation queue",!0),t})}async addRunsToAnnotationQueue(e,t){const n=JSON.stringify(t.map((e,t)=>O(e,`runIds[${t}]`).toString()));await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${O(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await(0,P.gJ)(t,"add runs to annotation queue",!0),t})}async getRunFromAnnotationQueue(e,t){const n=`/annotation-queues/${O(e,"queueId")}/run`;return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(e,"get run from annotation queue"),e})).json()}async deleteRunFromAnnotationQueue(e,t){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${O(e,"queueId")}/runs/${O(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${O(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"get size from annotation queue"),t})).json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${n.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(t,"get latest commit hash"),t}),n=await t.json();if(0!==n.commits.length)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[n,r,s]=A(e),i=JSON.stringify({like:t});return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/likes/${n}/${r}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await(0,P.gJ)(e,(t?"like":"unlike")+" prompt"),e})).json()}async _getPromptUrl(e){const[t,n,r]=A(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==r?`${this.getHostUrl()}/prompts/${n}/${r.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${e.id}`}return"latest"!==r?`${this.getHostUrl()}/hub/${t}/${n}/${r.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,e=>e.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,e=>e.repos))yield*e}async getPrompt(e){const[t,n,r]=A(e),s=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return 404===e?.status?null:(await(0,P.gJ)(e,"get prompt"),e)}),i=await(s?.json());return i?.repo?i.repo:null}async createPrompt(e,t){const n=await this._getSettings();if(t?.isPublic&&!n.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle.\n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[r,s,i]=A(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("create a prompt",r);const a={repo_handle:s,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},o=JSON.stringify(a),c=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await(0,P.gJ)(e,"create prompt"),e}),{repo:l}=await c.json();return l}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s,i]=A(e),a="latest"!==n?.parentCommitHash&&n?.parentCommitHash?n?.parentCommitHash:await this._getLatestCommitHash(`${r}/${s}`),o={manifest:JSON.parse(JSON.stringify(t)),parent_commit:a},c=JSON.stringify(o),l=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/commits/${r}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await(0,P.gJ)(e,"create commit"),e}),u=await l.json();return this._getPromptUrl(`${r}/${s}${u.commit_hash?`:${u.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const e of t){const t=e.id,r=Y({...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}}),s=new Blob([r],{type:"application/json"});if(n.append(t,s),e.inputs){const r=Y(e.inputs),s=new Blob([r],{type:"application/json"});n.append(`${t}.inputs`,s)}if(e.outputs){const r=Y(e.outputs),s=new Blob([r],{type:"application/json"});n.append(`${t}.outputs`,s)}if(e.attachments)for(const[r,s]of Object.entries(e.attachments)){let e,i;Array.isArray(s)?[e,i]=s:(e=s.mimeType,i=s.data);const a=new Blob([i],{type:`${e}; length=${i.byteLength}`});n.append(`${t}.attachment.${r}`,a)}if(e.attachments_operations){const r=Y(e.attachments_operations),s=new Blob([r],{type:"application/json"});n.append(`${t}.attachments_operations`,s)}}const r=e??t[0]?.dataset_id;return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${r}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await(0,P.gJ)(e,"update examples"),e})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const e of t){const t=(e.id??r.A()).toString(),s=Y({created_at:e.created_at,...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split},...e.source_run_id&&{source_run_id:e.source_run_id},...e.use_source_run_io&&{use_source_run_io:e.use_source_run_io},...e.use_source_run_attachments&&{use_source_run_attachments:e.use_source_run_attachments}}),i=new Blob([s],{type:"application/json"});if(n.append(t,i),e.inputs){const r=Y(e.inputs),s=new Blob([r],{type:"application/json"});n.append(`${t}.inputs`,s)}if(e.outputs){const r=Y(e.outputs),s=new Blob([r],{type:"application/json"});n.append(`${t}.outputs`,s)}if(e.attachments)for(const[r,s]of Object.entries(e.attachments)){let e,i;Array.isArray(s)?[e,i]=s:(e=s.mimeType,i=s.data);const a=new Blob([i],{type:`${e}; length=${i.byteLength}`});n.append(`${t}.attachment.${r}`,a)}}return(await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await(0,P.gJ)(t,"upload examples"),t})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r]=A(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const s={};if(void 0!==t?.description&&(s.description=t.description),void 0!==t?.readme&&(s.readme=t.readme),void 0!==t?.tags&&(s.tags=t.tags),void 0!==t?.isPublic&&(s.is_public=t.isPublic),void 0!==t?.isArchived&&(s.is_archived=t.isArchived),0===Object.keys(s).length)throw new Error("No valid update options provided");const i=JSON.stringify(s);return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${n}/${r}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await(0,P.gJ)(e,"update prompt"),e})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,n,r]=A(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(e,"delete prompt"),e})).json()}async pullPromptCommit(e,t){const[n,r,s]=A(e),i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/commits/${n}/${r}/${s}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await(0,P.gJ)(e,"pull prompt commit"),e}),a=await i.json();return{owner:n,repo:r,commit_hash:a.commit_hash,manifest:a.manifest,examples:a.examples}}async _pullPrompt(e,t){const n=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){if(await this.promptExists(e)?t&&Object.keys(t).some(e=>"object"!==e)&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),!t?.object)return await this._getPromptUrl(e);return await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash})}async clonePublicDataset(e,t={}){const{sourceApiUrl:n=this.apiUrl,datasetName:r}=t,[s,i]=this.parseTokenOrUrl(e,n),a=new Z({apiUrl:s,apiKey:"placeholder"}),o=await a.readSharedDataset(i),c=r||o.name;try{if(await this.hasDataset({datasetId:c}))return}catch(e){}const l=await a.listSharedExamples(i),u=await this.createDataset(c,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(e=>e.inputs),outputs:l.flatMap(e=>e.outputs?[e.outputs]:[]),datasetId:u.id})}catch(e){throw e}}parseTokenOrUrl(e,t,n=2,r="dataset"){try{return O(e),[t,e]}catch(e){}try{const s=new URL(e).pathname.split("/").filter(e=>""!==e);if(s.length>=n){return[t,s[s.length-n]]}throw new Error(`Invalid public ${r} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${r} URL or token: ${e}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()]),void 0!==this.langSmithToOTELTranslator&&await(f.getDefaultOTLPTracerComponents()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush())}}function X(e){return"dataset_id"in e||"dataset_name"in e}},9115:(e,t,n)=>{"use strict";var r,s;n.d(t,{CR:()=>a,ZS:()=>r,Zp:()=>i}),function(e){e.assertEqual=e=>{},e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter(e=>"number"!=typeof t[t[e]]),r={};for(const e of n)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(r||(r={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(s||(s={}));const i=r.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),a=e=>{switch(typeof e){case"undefined":return i.undefined;case"string":return i.string;case"number":return Number.isNaN(e)?i.nan:i.number;case"boolean":return i.boolean;case"function":return i.function;case"bigint":return i.bigint;case"symbol":return i.symbol;case"object":return Array.isArray(e)?i.array:null===e?i.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?i.promise:"undefined"!=typeof Map&&e instanceof Map?i.map:"undefined"!=typeof Set&&e instanceof Set?i.set:"undefined"!=typeof Date&&e instanceof Date?i.date:i.object;default:return i.unknown}}},9120:(e,t,n)=>{"use strict";n.d(t,{A:()=>u});const r={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var s,i=new Uint8Array(16);function a(){if(!s&&!(s="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return s(i)}for(var o=[],c=0;c<256;++c)o.push((c+256).toString(16).slice(1));function l(e,t=0){return(o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]).toLowerCase()}const u=function(e,t,n){if(r.randomUUID&&!t&&!e)return r.randomUUID();var s=(e=e||{}).random||(e.rng||a)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){n=n||0;for(var i=0;i<16;++i)t[n+i]=s[i];return t}return l(s)}},9149:(e,t,n)=>{"use strict";n.d(t,{Td:()=>R,tW:()=>$,H_:()=>T});var r=n(9120),s=n(5960),i=n(9418),a=n(1590);function o(e,t){return`${e.open}${t}${e.close}`}const{color:c}=i;class l extends a.J{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const e=this.runMap.get(n.parent_run_id);if(!e)break;t.push(e),n=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map((e,t,n)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===n.length-1?o(i.bold,r):r}).join(" > ");return o(c.grey,t)}onChainStart(e){this.getBreadcrumbs(e)}onChainEnd(e){this.getBreadcrumbs(e)}onChainError(e){this.getBreadcrumbs(e)}onLLMStart(e){this.getBreadcrumbs(e),"prompts"in e.inputs?e.inputs.prompts.map(e=>e.trim()):e.inputs}onLLMEnd(e){this.getBreadcrumbs(e)}onLLMError(e){this.getBreadcrumbs(e)}onToolStart(e){this.getBreadcrumbs(e)}onToolEnd(e){this.getBreadcrumbs(e)}onToolError(e){this.getBreadcrumbs(e)}onRetrieverStart(e){this.getBreadcrumbs(e)}onRetrieverEnd(e){this.getBreadcrumbs(e)}onRetrieverError(e){this.getBreadcrumbs(e)}onAgentAction(e){this.getBreadcrumbs(e)}}var u=n(6362),d=n(9583),h=n(1259),p=n(1688),m=n(3389);let g;const f=()=>{if(void 0===g){const e="false"===(0,d.Az)("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{};g=new h.Kj(e)}return g};class y extends a.J{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!0});const{exampleId:t,projectName:n,client:r,replicas:s}=e;this.projectName=n??(0,h.q7)(),this.replicas=s,this.exampleId=t,this.client=r??f();const i=y.getTraceableRunTree();i&&this.updateFromRunTree(i)}async persistRun(e){}async onRunCreate(e){const t=this.getRunTreeWithTracingConfig(e.id);await(t?.postRun())}async onRunUpdate(e){const t=this.getRunTreeWithTracingConfig(e.id);await(t?.patchRun())}getRun(e){return this.runTreeMap.get(e)}updateFromRunTree(e){this.runTreeMap.set(e.id,e);let t=e;const n=new Set;for(;t.parent_run&&!n.has(t.id)&&(n.add(t.id),t.parent_run);)t=t.parent_run;n.clear();const r=[t];for(;r.length>0;){const e=r.shift();e&&!n.has(e.id)&&(n.add(e.id),this.runTreeMap.set(e.id,e),e.child_runs&&r.push(...e.child_runs))}this.client=e.client??this.client,this.replicas=e.replicas??this.replicas,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(e){const t=this.runTreeMap.get(e);if(t)return new p.gk({...t,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return(0,m.vR)(!0)}catch{return}}}var _=n(3290),b=n(6968);let w;function v(){return void 0===w&&(w=new(0,_.default)({autoStart:!0,concurrency:1})),w}async function E(e,t){if(!0===t){const t=(0,b.X0)();void 0!==t?await t.run(void 0,async()=>e()):await e()}else w=v(),w.add(async()=>{const t=(0,b.X0)();void 0!==t?await t.run(void 0,async()=>e()):await e()})}function S(e){const t=(0,b.X0)();if(void 0===t)return;const n=t.getStore();return n?.[b.hr]?.[e]}const x=Symbol("lc:configure_hooks"),k=()=>S(x)||[];function T(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}class I{setHandler(e){return this.setHandlers([e])}}class O{constructor(e,t,n,r,s,i,a,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>E(async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleCustomEvent(e,t,n,r,s){await Promise.all(this.handlers.map(n=>E(async()=>{try{await(n.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleCustomEvent: ${e}`),n.raiseError)throw e}},n.awaitHandlers)))}}class C extends O{getChild(e){const t=new R(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${n}`),t.raiseError)throw e}},t.awaitHandlers)))}}class A extends O{async handleLLMNewToken(e,t,n,r,s,i){await Promise.all(this.handlers.map(n=>E(async()=>{if(!n.ignoreLLM)try{await(n.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMNewToken: ${e}`),n.raiseError)throw e}},n.awaitHandlers)))}async handleLLMError(e,t,n,r,s){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleLLMEnd(e,t,n,r,s){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class P extends O{getChild(e){const t=new R(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,r,s){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleChainEnd(e,t,n,r,s){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class M extends O{getChild(e){const t=new R(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>E(async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class R extends I{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,s=void 0,i=void 0,o=void 0,c=void 0,l=void 0){return Promise.all(t.map(async(t,s)=>{const o=0===s&&n?n:(0,r.A)();return await Promise.all(this.handlers.map(n=>{if(!n.ignoreLLM)return(0,a.j)(n)&&n._createRunForLLMStart(e,[t],o,this._parentRunId,i,this.tags,this.metadata,l),E(async()=>{try{await(n.handleLLMStart?.(e,[t],o,this._parentRunId,i,this.tags,this.metadata,l))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`),n.raiseError)throw e}},n.awaitHandlers)})),new A(o,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,n=void 0,s=void 0,i=void 0,o=void 0,c=void 0,l=void 0){return Promise.all(t.map(async(t,s)=>{const o=0===s&&n?n:(0,r.A)();return await Promise.all(this.handlers.map(n=>{if(!n.ignoreLLM)return(0,a.j)(n)&&n._createRunForChatModelStart(e,[t],o,this._parentRunId,i,this.tags,this.metadata,l),E(async()=>{try{if(n.handleChatModelStart)await(n.handleChatModelStart?.(e,[t],o,this._parentRunId,i,this.tags,this.metadata,l));else if(n.handleLLMStart){const r=(0,u.Sw)(t);await(n.handleLLMStart?.(e,[r],o,this._parentRunId,i,this.tags,this.metadata,l))}}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`),n.raiseError)throw e}},n.awaitHandlers)})),new A(o,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,n=(0,r.A)(),s=void 0,i=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(r=>{if(!r.ignoreChain)return(0,a.j)(r)&&r._createRunForChainStart(e,t,n,this._parentRunId,this.tags,this.metadata,s,c),E(async()=>{try{await(r.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,s,c))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleChainStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new P(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=(0,r.A)(),s=void 0,i=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(r=>{if(!r.ignoreAgent)return(0,a.j)(r)&&r._createRunForToolStart(e,t,n,this._parentRunId,this.tags,this.metadata,c),E(async()=>{try{await(r.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,c))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleToolStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new M(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=(0,r.A)(),s=void 0,i=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(r=>{if(!r.ignoreRetriever)return(0,a.j)(r)&&r._createRunForRetrieverStart(e,t,n,this._parentRunId,this.tags,this.metadata,c),E(async()=>{try{await(r.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,c))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleRetrieverStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new C(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,n,r,s){await Promise.all(this.handlers.map(r=>E(async()=>{if(!r.ignoreCustomEvent)try{await(r.handleCustomEvent?.(e,t,n,this.tags,this.metadata))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new R(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);n.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);n.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);n.addMetadata({[e]:this.metadata[e]},t)}for(const r of e)n.handlers.filter(e=>"console_callback_handler"===e.name).some(e=>e.name===r.name)||n.addHandler(r,t);return n}static fromHandlers(e){class t extends s.NK{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:(0,r.A)()}),Object.assign(this,e)}}const n=new this;return n.addHandler(new t),n}static configure(e,t,n,r,s,i,a){return this._configureSync(e,t,n,r,s,i,a)}static _configureSync(e,t,n,r,i,a,o){let c;(e||t)&&(Array.isArray(e)||!e?(c=new R,c.setHandlers(e?.map($)??[],!0)):c=e,c=c.copy(Array.isArray(t)?t.map($):t?.handlers,!1));const u="true"===(0,d.Az)("LANGCHAIN_VERBOSE")||o?.verbose,h=y.getTraceableRunTree()?.tracingEnabled||(e=>void 0!==e?e:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(e=>"true"===(0,d.Az)(e)))(),p=h||((0,d.Az)("LANGCHAIN_TRACING")??!1);if(u||p){if(c||(c=new R),u&&!c.handlers.some(e=>e.name===l.prototype.name)){const e=new l;c.addHandler(e,!0)}if(p&&!c.handlers.some(e=>"langchain_tracer"===e.name)&&h){const e=new y;c.addHandler(e,!0),c._parentRunId=y.getTraceableRunTree()?.id??c._parentRunId}}for(const{contextVar:e,inheritable:t=!0,handlerClass:n,envVar:r}of k()){const i=r&&"true"===(0,d.Az)(r)&&n;let a;const o=void 0!==e?S(e):void 0;o&&(0,s.zr)(o)?a=o:i&&(a=new n({})),void 0!==a&&(c||(c=new R),c.handlers.some(e=>e.name===a.name)||c.addHandler(a,t))}return(n||r)&&c&&(c.addTags(n??[]),c.addTags(r??[],!1)),(i||a)&&c&&(c.addMetadata(i??{}),c.addMetadata(a??{},!1)),c}}function $(e){return"name"in e?e:s.NK.fromMethods(e)}},9418:(e,t,n)=>{"use strict";e=n.nmd(e);const r=(e=0)=>t=>`[${38+e};5;${t}m`,s=(e=0)=>(t,n,r)=>`[${38+e};2;${t};${n};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[n,r]of Object.entries(t)){for(const[n,s]of Object.entries(r))t[n]={open:`[${s[0]}m`,close:`[${s[1]}m`},r[n]=t[n],e.set(s[0],s[1]);Object.defineProperty(t,n,{value:r,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=r(),t.color.ansi16m=s(),t.bgColor.ansi256=r(10),t.bgColor.ansi16m=s(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:n}=t.groups;3===n.length&&(n=n.split("").map(e=>e+e).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},9478:e=>{"use strict";e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},9497:(e,t,n)=>{"use strict";n.d(t,{Ej:()=>r.Ej,FK:()=>r.FK,Fz:()=>r.Fz,H:()=>r.H,HumanMessage:()=>r.xc,KX:()=>r.KX,Od:()=>r.Od,Q7:()=>r.Q7,XU:()=>r.XU,a7:()=>r.a7,cM:()=>r.cM,dr:()=>r.dr,ny:()=>r.ny,tn:()=>r.tn,uU:()=>r.uU,uf:()=>r.uf,up:()=>r.up,wk:()=>r.wk});var r=n(1673)},9531:(e,t,n)=>{"use strict";n.d(t,{ChatOllama:()=>oe});var r=n(9497),s=n(1830),i="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof self&&self||void 0!==n.g&&n.g||{},a="URLSearchParams"in i,o="Symbol"in i&&"iterator"in Symbol,c="FileReader"in i&&"Blob"in i&&function(){try{return new Blob,!0}catch(e){return!1}}(),l="FormData"in i,u="ArrayBuffer"in i;if(u)var d=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],h=ArrayBuffer.isView||function(e){return e&&d.indexOf(Object.prototype.toString.call(e))>-1};function p(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(e)||""===e)throw new TypeError('Invalid character in header field name: "'+e+'"');return e.toLowerCase()}function m(e){return"string"!=typeof e&&(e=String(e)),e}function g(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return o&&(t[Symbol.iterator]=function(){return t}),t}function f(e){this.map={},e instanceof f?e.forEach(function(e,t){this.append(t,e)},this):Array.isArray(e)?e.forEach(function(e){if(2!=e.length)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+e.length);this.append(e[0],e[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function y(e){if(!e._noBody)return e.bodyUsed?Promise.reject(new TypeError("Already read")):void(e.bodyUsed=!0)}function _(e){return new Promise(function(t,n){e.onload=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function b(e){var t=new FileReader,n=_(t);return t.readAsArrayBuffer(e),n}function w(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function v(){return this.bodyUsed=!1,this._initBody=function(e){var t;this.bodyUsed=this.bodyUsed,this._bodyInit=e,e?"string"==typeof e?this._bodyText=e:c&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:l&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:a&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():u&&c&&((t=e)&&DataView.prototype.isPrototypeOf(t))?(this._bodyArrayBuffer=w(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):u&&(ArrayBuffer.prototype.isPrototypeOf(e)||h(e))?this._bodyArrayBuffer=w(e):this._bodyText=e=Object.prototype.toString.call(e):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):a&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},c&&(this.blob=function(){var e=y(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var e=y(this);return e||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}if(c)return this.blob().then(b);throw new Error("could not read as ArrayBuffer")},this.text=function(){var e,t,n,r,s,i=y(this);if(i)return i;if(this._bodyBlob)return e=this._bodyBlob,t=new FileReader,n=_(t),r=/charset=([A-Za-z0-9_-]+)/.exec(e.type),s=r?r[1]:"utf-8",t.readAsText(e,s),n;if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),n=new Array(t.length),r=0;r<t.length;r++)n[r]=String.fromCharCode(t[r]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},l&&(this.formData=function(){return this.text().then(x)}),this.json=function(){return this.text().then(JSON.parse)},this}f.prototype.append=function(e,t){e=p(e),t=m(t);var n=this.map[e];this.map[e]=n?n+", "+t:t},f.prototype.delete=function(e){delete this.map[p(e)]},f.prototype.get=function(e){return e=p(e),this.has(e)?this.map[e]:null},f.prototype.has=function(e){return this.map.hasOwnProperty(p(e))},f.prototype.set=function(e,t){this.map[p(e)]=m(t)},f.prototype.forEach=function(e,t){for(var n in this.map)this.map.hasOwnProperty(n)&&e.call(t,this.map[n],n,this)},f.prototype.keys=function(){var e=[];return this.forEach(function(t,n){e.push(n)}),g(e)},f.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),g(e)},f.prototype.entries=function(){var e=[];return this.forEach(function(t,n){e.push([n,t])}),g(e)},o&&(f.prototype[Symbol.iterator]=f.prototype.entries);var E=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function S(e,t){if(!(this instanceof S))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var n,r,s=(t=t||{}).body;if(e instanceof S){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new f(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,s||null==e._bodyInit||(s=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new f(t.headers)),this.method=(n=t.method||this.method||"GET",r=n.toUpperCase(),E.indexOf(r)>-1?r:n),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal||function(){if("AbortController"in i)return(new AbortController).signal}(),this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&s)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(s),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==t.cache&&"no-cache"!==t.cache)){var a=/([?&])_=[^&]*/;if(a.test(this.url))this.url=this.url.replace(a,"$1_="+(new Date).getTime());else{this.url+=(/\?/.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}}function x(e){var t=new FormData;return e.trim().split("&").forEach(function(e){if(e){var n=e.split("="),r=n.shift().replace(/\+/g," "),s=n.join("=").replace(/\+/g," ");t.append(decodeURIComponent(r),decodeURIComponent(s))}}),t}function k(e,t){if(!(this instanceof k))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=void 0===t.statusText?"":""+t.statusText,this.headers=new f(t.headers),this.url=t.url||"",this._initBody(e)}S.prototype.clone=function(){return new S(this,{body:this._bodyInit})},v.call(S.prototype),v.call(k.prototype),k.prototype.clone=function(){return new k(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new f(this.headers),url:this.url})},k.error=function(){var e=new k(null,{status:200,statusText:""});return e.ok=!1,e.status=0,e.type="error",e};var T=[301,302,303,307,308];k.redirect=function(e,t){if(-1===T.indexOf(t))throw new RangeError("Invalid status code");return new k(null,{status:t,headers:{location:e}})};var I=i.DOMException;try{new I}catch(e){(I=function(e,t){this.message=e,this.name=t;var n=Error(e);this.stack=n.stack}).prototype=Object.create(Error.prototype),I.prototype.constructor=I}function O(e,t){return new Promise(function(n,r){var s=new S(e,t);if(s.signal&&s.signal.aborted)return r(new I("Aborted","AbortError"));var a=new XMLHttpRequest;function o(){a.abort()}if(a.onload=function(){var e,t,r={statusText:a.statusText,headers:(e=a.getAllResponseHeaders()||"",t=new f,e.replace(/\r?\n[\t ]+/g," ").split("\r").map(function(e){return 0===e.indexOf("\n")?e.substr(1,e.length):e}).forEach(function(e){var n=e.split(":"),r=n.shift().trim();if(r){var s=n.join(":").trim();try{t.append(r,s)}catch(e){}}}),t)};0===s.url.indexOf("file://")&&(a.status<200||a.status>599)?r.status=200:r.status=a.status,r.url="responseURL"in a?a.responseURL:r.headers.get("X-Request-URL");var i="response"in a?a.response:a.responseText;setTimeout(function(){n(new k(i,r))},0)},a.onerror=function(){setTimeout(function(){r(new TypeError("Network request failed"))},0)},a.ontimeout=function(){setTimeout(function(){r(new TypeError("Network request timed out"))},0)},a.onabort=function(){setTimeout(function(){r(new I("Aborted","AbortError"))},0)},a.open(s.method,function(e){try{return""===e&&i.location.href?i.location.href:e}catch(t){return e}}(s.url),!0),"include"===s.credentials?a.withCredentials=!0:"omit"===s.credentials&&(a.withCredentials=!1),"responseType"in a&&(c?a.responseType="blob":u&&(a.responseType="arraybuffer")),t&&"object"==typeof t.headers&&!(t.headers instanceof f||i.Headers&&t.headers instanceof i.Headers)){var l=[];Object.getOwnPropertyNames(t.headers).forEach(function(e){l.push(p(e)),a.setRequestHeader(e,m(t.headers[e]))}),s.headers.forEach(function(e,t){-1===l.indexOf(t)&&a.setRequestHeader(t,e)})}else s.headers.forEach(function(e,t){a.setRequestHeader(t,e)});s.signal&&(s.signal.addEventListener("abort",o),a.onreadystatechange=function(){4===a.readyState&&s.signal.removeEventListener("abort",o)}),a.send(void 0===s._bodyInit?null:s._bodyInit)})}O.polyfill=!0,i.fetch||(i.fetch=O,i.Headers=f,i.Request=S,i.Response=k);const C="11434",A=`http://127.0.0.1:${C}`;var P=Object.defineProperty,M=(e,t,n)=>(((e,t,n)=>{t in e?P(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);class R extends Error{constructor(e,t){super(e),this.error=e,this.status_code=t,this.name="ResponseError",Error.captureStackTrace&&Error.captureStackTrace(this,R)}}class ${constructor(e,t,n){M(this,"abortController"),M(this,"itr"),M(this,"doneCallback"),this.abortController=e,this.itr=t,this.doneCallback=n}abort(){this.abortController.abort()}async*[Symbol.asyncIterator](){for await(const e of this.itr){if("error"in e)throw new Error(e.error);if(yield e,e.done||"success"===e.status)return void this.doneCallback()}throw new Error("Did not receive done or success response in stream.")}}const j=async e=>{if(e.ok)return;let t=`Error ${e.status}: ${e.statusText}`,n=null;if(e.headers.get("content-type")?.includes("application/json"))try{n=await e.json(),t=n.error||t}catch(e){}else try{t=await e.text()||t}catch(e){}throw new R(t,e.status)};function N(){if("undefined"!=typeof window&&window.navigator){const e=navigator;return"userAgentData"in e&&e.userAgentData?.platform?`${e.userAgentData.platform.toLowerCase()} Browser/${navigator.userAgent};`:navigator.platform?`${navigator.platform.toLowerCase()} Browser/${navigator.userAgent};`:`unknown Browser/${navigator.userAgent};`}return"undefined"!=typeof process?`${process.arch} ${process.platform} Node.js/${process.version}`:""}const L=async(e,t,n={})=>{const r={"Content-Type":"application/json",Accept:"application/json","User-Agent":`ollama-js/0.5.16 (${N()})`};n.headers=function(e){if(e instanceof Headers){const t={};return e.forEach((e,n)=>{t[n]=e}),t}return Array.isArray(e)?Object.fromEntries(e):e||{}}(n.headers);const s=Object.fromEntries(Object.entries(n.headers).filter(([e])=>!Object.keys(r).some(t=>t.toLowerCase()===e.toLowerCase())));return n.headers={...r,...s},e(t,n)},D=async(e,t,n)=>{const r=await L(e,t,{headers:n?.headers});return await j(r),r},U=async(e,t,n,r)=>{const s=null===(i=n)||"object"!=typeof i||Array.isArray(i)?n:JSON.stringify(n);var i;const a=await L(e,t,{method:"POST",body:s,signal:r?.signal,headers:r?.headers});return await j(a),a};var F=Object.defineProperty,Y=(e,t,n)=>(((e,t,n)=>{t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(e,"symbol"!=typeof t?t+"":t,n),n);let G=class{constructor(e){Y(this,"config"),Y(this,"fetch"),Y(this,"ongoingStreamedRequests",[]),this.config={host:"",headers:e?.headers},e?.proxy||(this.config.host=(e=>{if(!e)return A;let t=e.includes("://");e.startsWith(":")&&(e=`http://127.0.0.1${e}`,t=!0),t||(e=`http://${e}`);const n=new URL(e);let r=n.port;r||(r=t?"https:"===n.protocol?"443":"80":C);let s="";n.username&&(s=n.username,n.password&&(s+=`:${n.password}`),s+="@");let i=`${n.protocol}//${s}${n.hostname}:${r}${n.pathname}`;return i.endsWith("/")&&(i=i.slice(0,-1)),i})(e?.host??A)),this.fetch=e?.fetch??fetch}abort(){for(const e of this.ongoingStreamedRequests)e.abort();this.ongoingStreamedRequests.length=0}async processStreamableRequest(e,t){t.stream=t.stream??!1;const n=`${this.config.host}/api/${e}`;if(t.stream){const e=new AbortController,r=await U(this.fetch,n,t,{signal:e.signal,headers:this.config.headers});if(!r.body)throw new Error("Missing body");const s=async function*(e){const t=new TextDecoder("utf-8");let n="";const r=e.getReader();for(;;){const{done:e,value:s}=await r.read();if(e)break;n+=t.decode(s);const i=n.split("\n");n=i.pop()??"";for(const e of i)try{yield JSON.parse(e)}catch(e){}}for(const e of n.split("\n").filter(e=>""!==e))try{yield JSON.parse(e)}catch(e){}}(r.body),i=new $(e,s,()=>{const e=this.ongoingStreamedRequests.indexOf(i);e>-1&&this.ongoingStreamedRequests.splice(e,1)});return this.ongoingStreamedRequests.push(i),i}const r=await U(this.fetch,n,t,{headers:this.config.headers});return await r.json()}async encodeImage(e){if("string"!=typeof e){const t=new Uint8Array(e);let n="";const r=t.byteLength;for(let e=0;e<r;e++)n+=String.fromCharCode(t[e]);return btoa(n)}return e}async generate(e){return e.images&&(e.images=await Promise.all(e.images.map(this.encodeImage.bind(this)))),this.processStreamableRequest("generate",e)}async chat(e){if(e.messages)for(const t of e.messages)t.images&&(t.images=await Promise.all(t.images.map(this.encodeImage.bind(this))));return this.processStreamableRequest("chat",e)}async create(e){return this.processStreamableRequest("create",{...e})}async pull(e){return this.processStreamableRequest("pull",{name:e.model,stream:e.stream,insecure:e.insecure})}async push(e){return this.processStreamableRequest("push",{name:e.model,stream:e.stream,insecure:e.insecure})}async delete(e){return await(async(e,t,n,r)=>{const s=await L(e,t,{method:"DELETE",body:JSON.stringify(n),headers:r?.headers});return await j(s),s})(this.fetch,`${this.config.host}/api/delete`,{name:e.model},{headers:this.config.headers}),{status:"success"}}async copy(e){return await U(this.fetch,`${this.config.host}/api/copy`,{...e},{headers:this.config.headers}),{status:"success"}}async list(){const e=await D(this.fetch,`${this.config.host}/api/tags`,{headers:this.config.headers});return await e.json()}async show(e){const t=await U(this.fetch,`${this.config.host}/api/show`,{...e},{headers:this.config.headers});return await t.json()}async embed(e){const t=await U(this.fetch,`${this.config.host}/api/embed`,{...e},{headers:this.config.headers});return await t.json()}async embeddings(e){const t=await U(this.fetch,`${this.config.host}/api/embeddings`,{...e},{headers:this.config.headers});return await t.json()}async ps(){const e=await D(this.fetch,`${this.config.host}/api/ps`,{headers:this.config.headers});return await e.json()}};new G;var B=n(3279),H=n(8687),z=n(194),q=n(58),K=n(8557),W=n(7942),V=n(6615);const J={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var Z,X=new Uint8Array(16);function Q(){if(!Z&&!(Z="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Z(X)}for(var ee=[],te=0;te<256;++te)ee.push((te+256).toString(16).slice(1));function ne(e,t=0){return(ee[e[t+0]]+ee[e[t+1]]+ee[e[t+2]]+ee[e[t+3]]+"-"+ee[e[t+4]]+ee[e[t+5]]+"-"+ee[e[t+6]]+ee[e[t+7]]+"-"+ee[e[t+8]]+ee[e[t+9]]+"-"+ee[e[t+10]]+ee[e[t+11]]+ee[e[t+12]]+ee[e[t+13]]+ee[e[t+14]]+ee[e[t+15]]).toLowerCase()}const re=function(e,t,n){if(J.randomUUID&&!t&&!e)return J.randomUUID();var r=(e=e||{}).random||(e.rng||Q)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(var s=0;s<16;++s)t[n+s]=r[s];return t}return ne(r)};function se(e,t){return new r.H({content:e.content??"",tool_call_chunks:e.tool_calls?.map(e=>({name:e.function.name,args:JSON.stringify(e.function.arguments),type:"tool_call_chunk",index:0,id:re()})),response_metadata:t?.responseMetadata,usage_metadata:t?.usageMetadata})}function ie(e){const t=e.match(/^data:.*?;base64,(.*)$/);return t?t[1]:""}function ae(e){return e.flatMap(e=>{if(["human","generic"].includes(e._getType()))return"string"==typeof(t=e).content?[{role:"user",content:t.content}]:t.content.map(e=>{if("text"===e.type)return{role:"user",content:e.text};if("image_url"===e.type){if("string"==typeof e.image_url)return{role:"user",content:"",images:[ie(e.image_url)]};if(e.image_url.url&&"string"==typeof e.image_url.url)return{role:"user",content:"",images:[ie(e.image_url.url)]}}throw new Error(`Unsupported content type: ${e.type}`)});if("ai"===e._getType())return function(e){if("string"==typeof e.content)return[{role:"assistant",content:e.content}];const t=e.content.filter(e=>"text"===e.type&&"string"==typeof e.text).map(e=>({role:"assistant",content:e.text}));let n;if(e.content.find(e=>"tool_use"===e.type)&&e.tool_calls?.length){const t=e.tool_calls?.map(e=>({id:e.id,type:"function",function:{name:e.name,arguments:e.args}}));t&&(n={role:"assistant",tool_calls:t,content:""})}else if(e.content.find(e=>"tool_use"===e.type)&&!e.tool_calls?.length)throw new Error("'tool_use' content type is not supported without tool calls.");return[...t,...n?[n]:[]]}(e);if("system"===e._getType())return function(e){if("string"==typeof e.content)return[{role:"system",content:e.content}];if(e.content.every(e=>"text"===e.type&&"string"==typeof e.text))return e.content.map(e=>({role:"system",content:e.text}));throw new Error(`Unsupported content type(s): ${e.content.map(e=>e.type).join(", ")}`)}(e);if("tool"===e._getType())return function(e){if("string"!=typeof e.content)throw new Error("Non string tool message content is not supported");return[{role:"tool",content:e.content}]}(e);throw new Error(`Unsupported message type: ${e._getType()}`);var t})}class oe extends s.xV{static lc_name(){return"ChatOllama"}constructor(e){super(e??{}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama3"}),Object.defineProperty(this,"numa",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numCtx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numBatch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mainGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowVram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"f16Kv",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitsAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vocabOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMmap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMlock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"embeddingOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numThread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numPredict",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tfsZ",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typicalP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatLastN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatTau",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatEta",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"penalizeNewline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkOrPullModel",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://127.0.0.1:11434"}),this.client=new G({fetch:e?.fetch,host:e?.baseUrl,headers:e?.headers}),this.baseUrl=e?.baseUrl??this.baseUrl,this.model=e?.model??this.model,this.numa=e?.numa,this.numCtx=e?.numCtx,this.numBatch=e?.numBatch,this.numGpu=e?.numGpu,this.mainGpu=e?.mainGpu,this.lowVram=e?.lowVram,this.f16Kv=e?.f16Kv,this.logitsAll=e?.logitsAll,this.vocabOnly=e?.vocabOnly,this.useMmap=e?.useMmap,this.useMlock=e?.useMlock,this.embeddingOnly=e?.embeddingOnly,this.numThread=e?.numThread,this.numKeep=e?.numKeep,this.seed=e?.seed,this.numPredict=e?.numPredict,this.topK=e?.topK,this.topP=e?.topP,this.tfsZ=e?.tfsZ,this.typicalP=e?.typicalP,this.repeatLastN=e?.repeatLastN,this.temperature=e?.temperature,this.repeatPenalty=e?.repeatPenalty,this.presencePenalty=e?.presencePenalty,this.frequencyPenalty=e?.frequencyPenalty,this.mirostat=e?.mirostat,this.mirostatTau=e?.mirostatTau,this.mirostatEta=e?.mirostatEta,this.penalizeNewline=e?.penalizeNewline,this.streaming=e?.streaming,this.format=e?.format,this.keepAlive=e?.keepAlive,this.checkOrPullModel=e?.checkOrPullModel??this.checkOrPullModel}_llmType(){return"ollama"}async pull(e,t){const{stream:n,insecure:r,logProgress:s}={stream:!0,...t};if(n)for await(const t of await this.client.pull({model:e,insecure:r,stream:n}));else{await this.client.pull({model:e,insecure:r})}}bindTools(e,t){return this.withConfig({tools:e.map(e=>(0,z.fL)(e)),...t})}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"ollama",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.options?.temperature??void 0,ls_max_tokens:t.options?.num_predict??void 0,ls_stop:e.stop}}invocationParams(e){if(e?.tool_choice)throw new Error("Tool choice is not supported for ChatOllama.");return{model:this.model,format:e?.format??this.format,keep_alive:this.keepAlive,options:{numa:this.numa,num_ctx:this.numCtx,num_batch:this.numBatch,num_gpu:this.numGpu,main_gpu:this.mainGpu,low_vram:this.lowVram,f16_kv:this.f16Kv,logits_all:this.logitsAll,vocab_only:this.vocabOnly,use_mmap:this.useMmap,use_mlock:this.useMlock,embedding_only:this.embeddingOnly,num_thread:this.numThread,num_keep:this.numKeep,seed:this.seed,num_predict:this.numPredict,top_k:this.topK,top_p:this.topP,tfs_z:this.tfsZ,typical_p:this.typicalP,repeat_last_n:this.repeatLastN,temperature:this.temperature,repeat_penalty:this.repeatPenalty,presence_penalty:this.presencePenalty,frequency_penalty:this.frequencyPenalty,mirostat:this.mirostat,mirostat_tau:this.mirostatTau,mirostat_eta:this.mirostatEta,penalize_newline:this.penalizeNewline,stop:e?.stop},tools:e?.tools?.length?e.tools.map(e=>(0,z.fL)(e)):void 0}}async checkModelExistsOnMachine(e){const{models:t}=await this.client.list();return!!t.find(t=>t.name===e||t.name===`${e}:latest`)}async _generate(e,t,n){let s;this.checkOrPullModel&&(await this.checkModelExistsOnMachine(this.model)||await this.pull(this.model,{logProgress:!0}));for await(const r of this._streamResponseChunks(e,t,n))s=s?(0,q.xW)(s,r.message):r.message;const i=new r.Od({id:s?.id,content:s?.content??"",tool_calls:s?.tool_calls,response_metadata:s?.response_metadata,usage_metadata:s?.usage_metadata});return{generations:[{text:"string"==typeof i.content?i.content:"",message:i}]}}async*_streamResponseChunks(e,t,n){this.checkOrPullModel&&(await this.checkModelExistsOnMachine(this.model)||await this.pull(this.model,{logProgress:!0}));const s=this.invocationParams(t),i=ae(e),a={input_tokens:0,output_tokens:0,total_tokens:0},o=await this.client.chat({...s,messages:i,stream:!0});let c;for await(const e of o){t.signal?.aborted&&this.client.abort();const{message:r,...s}=e;a.input_tokens+=s.prompt_eval_count??0,a.output_tokens+=s.eval_count??0,a.total_tokens=a.input_tokens+a.output_tokens,c=s,yield new B.Cf({text:r.content??"",message:se(r)}),await(n?.handleLLMNewToken(r.content??""))}yield new B.Cf({text:"",message:new r.H({content:"",response_metadata:c,usage_metadata:a})})}withStructuredOutput(e,t){if(void 0===t?.method||"jsonSchema"===t?.method){const n=(0,W.c9)(e),r=n?(0,V.PF)(e):e,s=this.bindTools([{type:"function",function:{name:"extract",description:r.description,parameters:r}}]).withConfig({format:"json",ls_structured_output_format:{kwargs:{method:"jsonSchema"},schema:(0,V.PF)(e)}}),i=n?K._6.fromZodSchema(e):new K.hU;if(!t?.includeRaw)return s.pipe(i);const a=H.kI.assign({parsed:(e,t)=>i.invoke(e.raw,t)}),o=H.kI.assign({parsed:()=>null}),c=a.withFallbacks({fallbacks:[o]});return H.zZ.from([{raw:s},c])}return super.withStructuredOutput(e,t)}}var ce=n(2540);ce.J;var le=n(9614);le.I},9583:(e,t,n)=>{"use strict";n.d(t,{Az:()=>o,VS:()=>a,_$:()=>s});const r=()=>"undefined"!=typeof Deno,s=()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||r()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom")?"jsdom":r()?"deno":"other":"node",e};let i;function a(){if(void 0===i){const e=s();i={library:"langchain-js",runtime:e}}return i}function o(e){try{return"undefined"!=typeof process?process.env?.[e]:r()?Deno?.env.get(e):void 0}catch(e){return}}},9589:(e,t,n)=>{"use strict";const r=n(9718),s=n(6874),i=n(3908),a=n(1123),o=n(144),c=n(6953),l=n(7414),u=n(3007),d=n(1832),h=n(2938),p=n(6254),m=n(4493),g=n(1729),f=n(560),y=n(9970),_=n(1763),b=n(909),w=n(3927),v=n(4277),E=n(5580),S=n(7059),x=n(4641),k=n(3999),T=n(4089),I=n(5200),O=n(2111),C=n(6170),A=n(3904),P=n(8311),M=n(7638),R=n(7631),$=n(9628),j=n(270),N=n(1261),L=n(3874),D=n(7075),U=n(5571),F=n(5342),Y=n(6780),G=n(2525),B=n(5032);e.exports={parse:o,valid:c,clean:l,inc:u,diff:d,major:h,minor:p,patch:m,prerelease:g,compare:f,rcompare:y,compareLoose:_,compareBuild:b,sort:w,rsort:v,gt:E,lt:S,eq:x,neq:k,gte:T,lte:I,cmp:O,coerce:C,Comparator:A,Range:P,satisfies:M,toComparators:R,maxSatisfying:$,minSatisfying:j,minVersion:N,validRange:L,outside:D,gtr:U,ltr:F,intersects:Y,simplifyRange:G,subset:B,SemVer:i,re:r.re,src:r.src,tokens:r.t,SEMVER_SPEC_VERSION:s.SEMVER_SPEC_VERSION,RELEASE_TYPES:s.RELEASE_TYPES,compareIdentifiers:a.compareIdentifiers,rcompareIdentifiers:a.rcompareIdentifiers}},9614:(e,t,n)=>{"use strict";n.d(t,{P:()=>l,I:()=>u});var r=n(1673),s=n(8028),i=n(9149),a=n(528),o=n(58),c=n(5960);class l extends a.j_{constructor({concurrency:e,...t}){super(e?{maxConcurrency:e,...t}:t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","llms",this._llmType()]})}async invoke(e,t){const n=l._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].text}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async*_streamIterator(e,t){if(this._streamResponseChunks===l.prototype._streamResponseChunks)yield this.invoke(e,t);else{const n=l._convertInputToPromptValue(e),[r,a]=this._separateRunnableConfigFromCallOptionsCompat(t),o=await i.Td.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this?.invocationParams(a),batch_size:1},u=await(o?.handleLLMStart(this.toJSON(),[n.toString()],r.runId,void 0,c,void 0,void 0,r.runName));let d=new s.mu({text:""});try{for await(const e of this._streamResponseChunks(n.toString(),a,u?.[0]))d=d?d.concat(e):e,"string"==typeof e.text&&(yield e.text)}catch(e){throw await Promise.all((u??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((u??[]).map(e=>e?.handleLLMEnd({generations:[[d]]})))}}async generatePrompt(e,t,n){const r=e.map(e=>e.toString());return this.generate(r,t,n)}invocationParams(e){return{}}_flattenLLMResult(e){const t=[];for(let n=0;n<e.generations.length;n+=1){const r=e.generations[n];if(0===n)t.push({generations:[r],llmOutput:e.llmOutput});else{const n=e.llmOutput?{...e.llmOutput,tokenUsage:{}}:void 0;t.push({generations:[r],llmOutput:n})}}return t}async _generateUncached(e,t,n,r){let a;if(void 0!==r&&r.length===e.length)a=r;else{const r=await i.Td.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this?.invocationParams(t),batch_size:e.length};a=await(r?.handleLLMStart(this.toJSON(),e,n.runId,void 0,s,void 0,void 0,n?.runName))}let u;if(!!a?.[0].handlers.find(c.xL)&&1===e.length&&this._streamResponseChunks!==l.prototype._streamResponseChunks)try{const n=await this._streamResponseChunks(e[0],t,a?.[0]);let r;for await(const e of n)r=void 0===r?e:(0,o.xW)(r,e);if(void 0===r)throw new Error("Received empty response from chat model call.");u={generations:[[r]],llmOutput:{}},await(a?.[0].handleLLMEnd(u))}catch(e){throw await(a?.[0].handleLLMError(e)),e}else{try{u=await this._generate(e,t,a?.[0])}catch(e){throw await Promise.all((a??[]).map(t=>t?.handleLLMError(e))),e}const n=this._flattenLLMResult(u);await Promise.all((a??[]).map((e,t)=>e?.handleLLMEnd(n[t])))}const d=a?.map(e=>e.runId)||void 0;return Object.defineProperty(u,s.SP,{value:d?{runIds:d}:void 0,configurable:!0}),u}async _generateCached({prompts:e,cache:t,llmStringKey:n,parsedOptions:r,handledOptions:a,runId:o}){const c=await i.Td.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),l={options:r,invocation_params:this?.invocationParams(r),batch_size:e.length},u=await(c?.handleLLMStart(this.toJSON(),e,o,void 0,l,void 0,void 0,a?.runName)),d=[],h=(await Promise.allSettled(e.map(async(e,r)=>{const s=await t.lookup(e,n);return null==s&&d.push(r),s}))).map((e,t)=>({result:e,runManager:u?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),p=[];await Promise.all(h.map(async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return p[n]=r.map(e=>(e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]},void 0,void 0,void 0,{cached:!0})}return await(t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(e.reason)}));const m={generations:p,missingPromptIndices:d,startedRunManagers:u};return Object.defineProperty(m,s.SP,{value:u?{runIds:u?.map(e=>e.runId)}:void 0,configurable:!0}),m}async generate(e,t,n){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");let r;r=Array.isArray(t)?{stop:t}:t;const[s,i]=this._separateRunnableConfigFromCallOptionsCompat(r);if(s.callbacks=s.callbacks??n,!this.cache)return this._generateUncached(e,i,s);const{cache:a}=this,o=this._getSerializedCacheKeyParametersForCall(i),{generations:c,missingPromptIndices:l,startedRunManagers:u}=await this._generateCached({prompts:e,cache:a,llmStringKey:o,parsedOptions:i,handledOptions:s,runId:s.runId});let d={};if(l.length>0){const t=await this._generateUncached(l.map(t=>e[t]),i,s,void 0!==u?l.map(e=>u?.[e]):void 0);await Promise.all(t.generations.map(async(t,n)=>{const r=l[n];return c[r]=t,a.update(e[r],o,t)})),d=t.llmOutput??{}}return{generations:c,llmOutput:d}}async call(e,t,n){const{generations:r}=await this.generate([e],t,n);return r[0][0].text}async predict(e,t,n){return this.call(e,t,n)}async predictMessages(e,t,n){const s=(0,r.Sw)(e),i=await this.call(s,t,n);return new r.Od(i)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}}class u extends l{async _generate(e,t,n){return{generations:await Promise.all(e.map((e,r)=>this._call(e,{...t,promptIndex:r},n).then(e=>[{text:e}])))}}}},9624:(e,t,n)=>{"use strict";n.d(t,{g:()=>o});var r=n(4116),s=n(3290);const i=[400,401,402,403,404,405,406,407,409],a=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&i.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class o{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??a;const t=s.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>r(()=>e(...t).catch(e=>{throw e instanceof Error?e:new Error(e)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise((t,n)=>{e.signal?.addEventListener("abort",()=>{n(new Error("AbortError"))})})]):this.call(t,...n)}fetch(...e){return this.call(()=>fetch(...e).then(e=>e.ok?e:Promise.reject(e)))}}},9628:(e,t,n)=>{"use strict";const r=n(3908),s=n(8311);e.exports=(e,t,n)=>{let i=null,a=null,o=null;try{o=new s(t,n)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(i&&-1!==a.compare(e)||(i=e,a=new r(i,n)))}),i}},9641:(e,t,n)=>{"use strict";n.d(t,{U:()=>r.UD});var r=n(6150)},9718:(e,t,n)=>{"use strict";const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:s,MAX_LENGTH:i}=n(6874),a=n(7272),o=(t=e.exports={}).re=[],c=t.safeRe=[],l=t.src=[],u=t.safeSrc=[],d=t.t={};let h=0;const p="[a-zA-Z0-9-]",m=[["\\s",1],["\\d",i],[p,s]],g=(e,t,n)=>{const r=(e=>{for(const[t,n]of m)e=e.split(`${t}*`).join(`${t}{0,${n}}`).split(`${t}+`).join(`${t}{1,${n}}`);return e})(t),s=h++;a(e,s,t),d[e]=s,l[s]=t,u[s]=r,o[s]=new RegExp(t,n?"g":void 0),c[s]=new RegExp(r,n?"g":void 0)};g("NUMERICIDENTIFIER","0|[1-9]\\d*"),g("NUMERICIDENTIFIERLOOSE","\\d+"),g("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${p}*`),g("MAINVERSION",`(${l[d.NUMERICIDENTIFIER]})\\.(${l[d.NUMERICIDENTIFIER]})\\.(${l[d.NUMERICIDENTIFIER]})`),g("MAINVERSIONLOOSE",`(${l[d.NUMERICIDENTIFIERLOOSE]})\\.(${l[d.NUMERICIDENTIFIERLOOSE]})\\.(${l[d.NUMERICIDENTIFIERLOOSE]})`),g("PRERELEASEIDENTIFIER",`(?:${l[d.NONNUMERICIDENTIFIER]}|${l[d.NUMERICIDENTIFIER]})`),g("PRERELEASEIDENTIFIERLOOSE",`(?:${l[d.NONNUMERICIDENTIFIER]}|${l[d.NUMERICIDENTIFIERLOOSE]})`),g("PRERELEASE",`(?:-(${l[d.PRERELEASEIDENTIFIER]}(?:\\.${l[d.PRERELEASEIDENTIFIER]})*))`),g("PRERELEASELOOSE",`(?:-?(${l[d.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[d.PRERELEASEIDENTIFIERLOOSE]})*))`),g("BUILDIDENTIFIER",`${p}+`),g("BUILD",`(?:\\+(${l[d.BUILDIDENTIFIER]}(?:\\.${l[d.BUILDIDENTIFIER]})*))`),g("FULLPLAIN",`v?${l[d.MAINVERSION]}${l[d.PRERELEASE]}?${l[d.BUILD]}?`),g("FULL",`^${l[d.FULLPLAIN]}$`),g("LOOSEPLAIN",`[v=\\s]*${l[d.MAINVERSIONLOOSE]}${l[d.PRERELEASELOOSE]}?${l[d.BUILD]}?`),g("LOOSE",`^${l[d.LOOSEPLAIN]}$`),g("GTLT","((?:<|>)?=?)"),g("XRANGEIDENTIFIERLOOSE",`${l[d.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),g("XRANGEIDENTIFIER",`${l[d.NUMERICIDENTIFIER]}|x|X|\\*`),g("XRANGEPLAIN",`[v=\\s]*(${l[d.XRANGEIDENTIFIER]})(?:\\.(${l[d.XRANGEIDENTIFIER]})(?:\\.(${l[d.XRANGEIDENTIFIER]})(?:${l[d.PRERELEASE]})?${l[d.BUILD]}?)?)?`),g("XRANGEPLAINLOOSE",`[v=\\s]*(${l[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[d.XRANGEIDENTIFIERLOOSE]})(?:${l[d.PRERELEASELOOSE]})?${l[d.BUILD]}?)?)?`),g("XRANGE",`^${l[d.GTLT]}\\s*${l[d.XRANGEPLAIN]}$`),g("XRANGELOOSE",`^${l[d.GTLT]}\\s*${l[d.XRANGEPLAINLOOSE]}$`),g("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),g("COERCE",`${l[d.COERCEPLAIN]}(?:$|[^\\d])`),g("COERCEFULL",l[d.COERCEPLAIN]+`(?:${l[d.PRERELEASE]})?`+`(?:${l[d.BUILD]})?(?:$|[^\\d])`),g("COERCERTL",l[d.COERCE],!0),g("COERCERTLFULL",l[d.COERCEFULL],!0),g("LONETILDE","(?:~>?)"),g("TILDETRIM",`(\\s*)${l[d.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",g("TILDE",`^${l[d.LONETILDE]}${l[d.XRANGEPLAIN]}$`),g("TILDELOOSE",`^${l[d.LONETILDE]}${l[d.XRANGEPLAINLOOSE]}$`),g("LONECARET","(?:\\^)"),g("CARETTRIM",`(\\s*)${l[d.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",g("CARET",`^${l[d.LONECARET]}${l[d.XRANGEPLAIN]}$`),g("CARETLOOSE",`^${l[d.LONECARET]}${l[d.XRANGEPLAINLOOSE]}$`),g("COMPARATORLOOSE",`^${l[d.GTLT]}\\s*(${l[d.LOOSEPLAIN]})$|^$`),g("COMPARATOR",`^${l[d.GTLT]}\\s*(${l[d.FULLPLAIN]})$|^$`),g("COMPARATORTRIM",`(\\s*)${l[d.GTLT]}\\s*(${l[d.LOOSEPLAIN]}|${l[d.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",g("HYPHENRANGE",`^\\s*(${l[d.XRANGEPLAIN]})\\s+-\\s+(${l[d.XRANGEPLAIN]})\\s*$`),g("HYPHENRANGELOOSE",`^\\s*(${l[d.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[d.XRANGEPLAINLOOSE]})\\s*$`),g("STAR","(<|>)?=?\\s*\\*"),g("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),g("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},9830:(e,t,n)=>{"use strict";async function r(e,t){if(void 0===t)return e;let n;return Promise.race([e.catch(e=>{if(!t?.aborted)throw e}),new Promise((e,r)=>{n=()=>{r(new Error("Aborted"))},t.addEventListener("abort",n),t.aborted&&r(new Error("Aborted"))})]).finally(()=>t.removeEventListener("abort",n))}n.d(t,{o:()=>r})},9958:(e,t,n)=>{"use strict";n.d(t,{b:()=>a});var r=n(3795),s=n(7048);class i{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??r.fd,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var n;const r=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},a=this.seen.get(e);if(a){a.count++;return t.schemaPath.includes(e)&&(a.cycle=t.path),a.schema}const c={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,c);const l=e._zod.toJSONSchema?.();if(l)c.schema=l;else{const n={...t,schemaPath:[...t.schemaPath,e],path:t.path},a=e._zod.parent;if(a)c.ref=a,this.process(a,n),this.seen.get(a).isParent=!0;else{const t=c.schema;switch(r.type){case"string":{const n=t;n.type="string";const{minimum:r,maximum:s,format:a,patterns:o,contentEncoding:l}=e._zod.bag;if("number"==typeof r&&(n.minLength=r),"number"==typeof s&&(n.maxLength=s),a&&(n.format=i[a]??a,""===n.format&&delete n.format),l&&(n.contentEncoding=l),o&&o.size>0){const e=[...o];1===e.length?n.pattern=e[0].source:e.length>1&&(c.schema.allOf=[...e.map(e=>({..."draft-7"===this.target?{type:"string"}:{},pattern:e.source}))])}break}case"number":{const n=t,{minimum:r,maximum:s,format:i,multipleOf:a,exclusiveMaximum:o,exclusiveMinimum:c}=e._zod.bag;"string"==typeof i&&i.includes("int")?n.type="integer":n.type="number","number"==typeof c&&(n.exclusiveMinimum=c),"number"==typeof r&&(n.minimum=r,"number"==typeof c&&(c>=r?delete n.minimum:delete n.exclusiveMinimum)),"number"==typeof o&&(n.exclusiveMaximum=o),"number"==typeof s&&(n.maximum=s,"number"==typeof o&&(o<=s?delete n.maximum:delete n.exclusiveMaximum)),"number"==typeof a&&(n.multipleOf=a);break}case"boolean":t.type="boolean";break;case"bigint":if("throw"===this.unrepresentable)throw new Error("BigInt cannot be represented in JSON Schema");break;case"symbol":if("throw"===this.unrepresentable)throw new Error("Symbols cannot be represented in JSON Schema");break;case"null":t.type="null";break;case"any":case"unknown":break;case"undefined":if("throw"===this.unrepresentable)throw new Error("Undefined cannot be represented in JSON Schema");break;case"void":if("throw"===this.unrepresentable)throw new Error("Void cannot be represented in JSON Schema");break;case"never":t.not={};break;case"date":if("throw"===this.unrepresentable)throw new Error("Date cannot be represented in JSON Schema");break;case"array":{const s=t,{minimum:i,maximum:a}=e._zod.bag;"number"==typeof i&&(s.minItems=i),"number"==typeof a&&(s.maxItems=a),s.type="array",s.items=this.process(r.element,{...n,path:[...n.path,"items"]});break}case"object":{const e=t;e.type="object",e.properties={};const s=r.shape;for(const t in s)e.properties[t]=this.process(s[t],{...n,path:[...n.path,"properties",t]});const i=new Set(Object.keys(s)),a=new Set([...i].filter(e=>{const t=r.shape[e]._zod;return"input"===this.io?void 0===t.optin:void 0===t.optout}));a.size>0&&(e.required=Array.from(a)),"never"===r.catchall?._zod.def.type?e.additionalProperties=!1:r.catchall?r.catchall&&(e.additionalProperties=this.process(r.catchall,{...n,path:[...n.path,"additionalProperties"]})):"output"===this.io&&(e.additionalProperties=!1);break}case"union":t.anyOf=r.options.map((e,t)=>this.process(e,{...n,path:[...n.path,"anyOf",t]}));break;case"intersection":{const e=t,s=this.process(r.left,{...n,path:[...n.path,"allOf",0]}),i=this.process(r.right,{...n,path:[...n.path,"allOf",1]}),a=e=>"allOf"in e&&1===Object.keys(e).length,o=[...a(s)?s.allOf:[s],...a(i)?i.allOf:[i]];e.allOf=o;break}case"tuple":{const s=t;s.type="array";const i=r.items.map((e,t)=>this.process(e,{...n,path:[...n.path,"prefixItems",t]}));if("draft-2020-12"===this.target?s.prefixItems=i:s.items=i,r.rest){const e=this.process(r.rest,{...n,path:[...n.path,"items"]});"draft-2020-12"===this.target?s.items=e:s.additionalItems=e}r.rest&&(s.items=this.process(r.rest,{...n,path:[...n.path,"items"]}));const{minimum:a,maximum:o}=e._zod.bag;"number"==typeof a&&(s.minItems=a),"number"==typeof o&&(s.maxItems=o);break}case"record":{const e=t;e.type="object",e.propertyNames=this.process(r.keyType,{...n,path:[...n.path,"propertyNames"]}),e.additionalProperties=this.process(r.valueType,{...n,path:[...n.path,"additionalProperties"]});break}case"map":if("throw"===this.unrepresentable)throw new Error("Map cannot be represented in JSON Schema");break;case"set":if("throw"===this.unrepresentable)throw new Error("Set cannot be represented in JSON Schema");break;case"enum":{const e=t,n=(0,s.w5)(r.entries);n.every(e=>"number"==typeof e)&&(e.type="number"),n.every(e=>"string"==typeof e)&&(e.type="string"),e.enum=n;break}case"literal":{const e=t,n=[];for(const e of r.values)if(void 0===e){if("throw"===this.unrepresentable)throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if("bigint"==typeof e){if("throw"===this.unrepresentable)throw new Error("BigInt literals cannot be represented in JSON Schema");n.push(Number(e))}else n.push(e);if(0===n.length);else if(1===n.length){const t=n[0];e.type=null===t?"null":typeof t,e.const=t}else n.every(e=>"number"==typeof e)&&(e.type="number"),n.every(e=>"string"==typeof e)&&(e.type="string"),n.every(e=>"boolean"==typeof e)&&(e.type="string"),n.every(e=>null===e)&&(e.type="null"),e.enum=n;break}case"file":{const n=t,r={type:"string",format:"binary",contentEncoding:"binary"},{minimum:s,maximum:i,mime:a}=e._zod.bag;void 0!==s&&(r.minLength=s),void 0!==i&&(r.maxLength=i),a?1===a.length?(r.contentMediaType=a[0],Object.assign(n,r)):n.anyOf=a.map(e=>({...r,contentMediaType:e})):Object.assign(n,r);break}case"transform":if("throw"===this.unrepresentable)throw new Error("Transforms cannot be represented in JSON Schema");break;case"nullable":{const e=this.process(r.innerType,n);t.anyOf=[e,{type:"null"}];break}case"nonoptional":case"promise":case"optional":this.process(r.innerType,n),c.ref=r.innerType;break;case"success":t.type="boolean";break;case"default":this.process(r.innerType,n),c.ref=r.innerType,t.default=JSON.parse(JSON.stringify(r.defaultValue));break;case"prefault":this.process(r.innerType,n),c.ref=r.innerType,"input"===this.io&&(t._prefault=JSON.parse(JSON.stringify(r.defaultValue)));break;case"catch":{let e;this.process(r.innerType,n),c.ref=r.innerType;try{e=r.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}t.default=e;break}case"nan":if("throw"===this.unrepresentable)throw new Error("NaN cannot be represented in JSON Schema");break;case"template_literal":{const n=t,r=e._zod.pattern;if(!r)throw new Error("Pattern not found in template literal");n.type="string",n.pattern=r.source;break}case"pipe":{const e="input"===this.io?"transform"===r.in._zod.def.type?r.out:r.in:r.out;this.process(e,n),c.ref=e;break}case"readonly":this.process(r.innerType,n),c.ref=r.innerType,t.readOnly=!0;break;case"lazy":{const t=e._zod.innerType;this.process(t,n),c.ref=t;break}case"custom":if("throw"===this.unrepresentable)throw new Error("Custom types cannot be represented in JSON Schema")}}}const u=this.metadataRegistry.get(e);u&&Object.assign(c.schema,u),"input"===this.io&&o(e)&&(delete c.schema.examples,delete c.schema.default),"input"===this.io&&c.schema._prefault&&((n=c.schema).default??(n.default=c.schema._prefault)),delete c.schema._prefault;return this.seen.get(e).schema}emit(e,t){const n={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},r=this.seen.get(e);if(!r)throw new Error("Unprocessed schema. This is a bug in Zod.");const s=e=>{const t="draft-2020-12"===this.target?"$defs":"definitions";if(n.external){const r=n.external.registry.get(e[0])?.id,s=n.external.uri??(e=>e);if(r)return{ref:s(r)};const i=e[1].defId??e[1].schema.id??"schema"+this.counter++;return e[1].defId=i,{defId:i,ref:`${s("__shared")}#/${t}/${i}`}}if(e[1]===r)return{ref:"#"};const s=`#/${t}/`,i=e[1].schema.id??"__schema"+this.counter++;return{defId:i,ref:s+i}},i=e=>{if(e[1].schema.$ref)return;const t=e[1],{ref:n,defId:r}=s(e);t.def={...t.schema},r&&(t.defId=r);const i=t.schema;for(const e in i)delete i[e];i.$ref=n};if("throw"===n.cycles)for(const e of this.seen.entries()){const t=e[1];if(t.cycle)throw new Error(`Cycle detected: #/${t.cycle?.join("/")}/<root>\n\nSet the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const t of this.seen.entries()){const r=t[1];if(e===t[0]){i(t);continue}if(n.external){const r=n.external.registry.get(t[0])?.id;if(e!==t[0]&&r){i(t);continue}}const s=this.metadataRegistry.get(t[0])?.id;s?i(t):(r.cycle||r.count>1&&"ref"===n.reused)&&i(t)}const a=(e,t)=>{const n=this.seen.get(e),r=n.def??n.schema,s={...r};if(null===n.ref)return;const i=n.ref;if(n.ref=null,i){a(i,t);const e=this.seen.get(i).schema;e.$ref&&"draft-7"===t.target?(r.allOf=r.allOf??[],r.allOf.push(e)):(Object.assign(r,e),Object.assign(r,s))}n.isParent||this.override({zodSchema:e,jsonSchema:r,path:n.path??[]})};for(const e of[...this.seen.entries()].reverse())a(e[0],{target:this.target});const o={};if("draft-2020-12"===this.target?o.$schema="https://json-schema.org/draft/2020-12/schema":"draft-7"===this.target&&(o.$schema="http://json-schema.org/draft-07/schema#"),n.external?.uri){const t=n.external.registry.get(e)?.id;if(!t)throw new Error("Schema is missing an `id` property");o.$id=n.external.uri(t)}Object.assign(o,r.def);const c=n.external?.defs??{};for(const e of this.seen.entries()){const t=e[1];t.def&&t.defId&&(c[t.defId]=t.def)}n.external||Object.keys(c).length>0&&("draft-2020-12"===this.target?o.$defs=c:o.definitions=c);try{return JSON.parse(JSON.stringify(o))}catch(e){throw new Error("Error converting schema to JSON.")}}}function a(e,t){if(e instanceof r.rs){const n=new i(t),r={};for(const t of e._idmap.entries()){const[e,r]=t;n.process(r)}const s={},a={registry:e,uri:t?.uri,defs:r};for(const r of e._idmap.entries()){const[e,i]=r;s[e]=n.emit(i,{...t,external:a})}if(Object.keys(r).length>0){const e="draft-2020-12"===n.target?"$defs":"definitions";s.__shared={[e]:r}}return{schemas:s}}const n=new i(t);return n.process(e),n.emit(e,t)}function o(e,t){const n=t??{seen:new Set};if(n.seen.has(e))return!1;n.seen.add(e);const r=e._zod.def;switch(r.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":case"custom":case"success":case"catch":return!1;case"array":return o(r.element,n);case"object":for(const e in r.shape)if(o(r.shape[e],n))return!0;return!1;case"union":for(const e of r.options)if(o(e,n))return!0;return!1;case"intersection":return o(r.left,n)||o(r.right,n);case"tuple":for(const e of r.items)if(o(e,n))return!0;return!(!r.rest||!o(r.rest,n));case"record":case"map":return o(r.keyType,n)||o(r.valueType,n);case"set":return o(r.valueType,n);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":case"default":case"prefault":return o(r.innerType,n);case"lazy":return o(r.getter(),n);case"transform":return!0;case"pipe":return o(r.in,n)||o(r.out,n)}throw new Error(`Unknown schema type: ${r.type}`)}},9970:(e,t,n)=>{"use strict";const r=n(560);e.exports=(e,t,n)=>r(t,e,n)},9998:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){let r=0,s=e.length;for(;s>0;){const i=s/2|0;let a=r+i;n(e[a],t)<=0?(r=++a,s-=i+1):s=i}return r}}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var i=t[r]={id:r,loaded:!1,exports:{}};return e[r](i,i.exports,n),i.loaded=!0,i.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{"use strict";var e=n(1611),t=n(454),r=n(823);const s="hasSeenOnboarding";class i{static async markAsSeen(){try{await chrome.storage.local.set({[s]:!0})}catch(e){}}static async reset(){try{await chrome.storage.local.remove(s)}catch(e){}}}var a=n(8851);var o=n(2080),c=n(1566),l=n(9497);class u{static countString(e){return e?Math.ceil(e.length/u.CHARS_PER_TOKEN):0}static countMessage(e){if(e instanceof l.Od&&e.usage_metadata?.total_tokens)return e.usage_metadata.total_tokens;let t="";"string"==typeof e.content?t=e.content:e.content&&(t=JSON.stringify(e.content));let n=u.countString(t)+u.TOKENS_PER_MESSAGE;if(e instanceof l.Od&&e.tool_calls){const t=JSON.stringify(e.tool_calls);n+=u.countString(t)}return e instanceof l.uf&&e.tool_call_id&&(n+=u.countString(e.tool_call_id)),n}static countMessages(e){return e.reduce((e,t)=>e+u.countMessage(t),0)}static format(e,t){const n=t?`${t}: `:"";return e>1e6?`${n}~${(e/1e6).toFixed(1)}M tokens`:e>1e3?`${n}~${(e/1e3).toFixed(1)}K tokens`:`${n}~${e} tokens`}static count(e){return"string"==typeof e?u.countString(e):Array.isArray(e)?u.countMessages(e):u.countMessage(e)}}u.CHARS_PER_TOKEN=4,u.TOKENS_PER_MESSAGE=3;var d;!function(e){e.SYSTEM="system",e.AI="ai",e.HUMAN="human",e.TOOL="tool",e.BROWSER_STATE="browser_state",e.TODO_LIST="todo_list",e.SCREENSHOT="screenshot"}(d||(d={}));const h=d;class p extends l.Od{constructor(e){super(`<browser-state>${e}</browser-state>`),this.additional_kwargs={messageType:d.BROWSER_STATE}}}class m extends l.Od{constructor(e){super(`<TodoList>${e}</TodoList>`),this.additional_kwargs={messageType:d.TODO_LIST}}}l.Od;class g{constructor(e){this.messageManager=e}getAll(){return this.messageManager.getMessages()}getFiltered(e=[]){return 0===e.length?this.getAll():this.getAll().filter(t=>{const n=this.messageManager._getMessageType(t);return!e.includes(n)})}getFilteredAsString(e=[],t="\n"){return this.getFiltered(e).map(e=>`${e._getType()}: ${"string"==typeof e.content?e.content:JSON.stringify(e.content)}`).join(t)}getRecentBrowserState(){const e=this.messageManager.getMessages();for(let t=e.length-1;t>=0;t--)if(e[t]instanceof p){const n=e[t].content;return"string"==typeof n&&n.includes("<browser-state>")&&n.match(/<browser-state>(.*?)<\/browser-state>/s)?.[1]||n}return null}}class f{constructor(e=8192){this.entries=[],this.totalTokens=0,this.messageQueue=[],this.maxTokens=e}add(e,n){switch(this._getMessageType(e)){case d.SYSTEM:this.removeSystemMessages();break;case d.BROWSER_STATE:this.removeMessagesByType(d.BROWSER_STATE);break;case d.TODO_LIST:this.removeMessagesByType(d.TODO_LIST);break;case d.SCREENSHOT:this.removeMessagesByType(d.SCREENSHOT)}const r=u.countMessage(e),s={message:e,tokens:r};void 0!==n?this.entries.splice(n,0,s):this.entries.push(s),this.totalTokens+=r,t.y7.log("MessageManager",`Total tokens in message manager: ${u.format(this.totalTokens)}`,"info")}addHuman(e){this.add(new l.HumanMessage(e))}addAI(e){this.add(new l.Od(e))}addSystem(e,t=0){this.add(new l.tn(e),t)}addBrowserState(e){this.add(new p(e))}addTodoList(e){this.add(new m(e))}addScreenshot(e,t="Screenshot of current page state"){const n=new l.HumanMessage({content:[{type:"image_url",image_url:{url:e}},{type:"text",text:t}]});n.additional_kwargs={messageType:d.SCREENSHOT},this.add(n)}addTool(e,t){this.add(new l.uf(e,t))}addSystemReminder(e){this.add(new l.Od(`<system-reminder>${e}</system-reminder>`))}getMessages(){return this.entries.map(e=>e.message)}getTokenCount(){return this.totalTokens}remaining(){return Math.max(0,this.maxTokens-this.getTokenCount())}getMaxTokens(){return this.maxTokens}setMaxTokens(e){const t=this.maxTokens;if(this.maxTokens=e,e<t)for(;this.totalTokens>this.maxTokens&&this.entries.length>0;){if(!this._removeLowestPriority())break}}fork(e=!0){const t=new f(this.maxTokens);return e&&(t.entries=this.entries.map(e=>({message:e.message,tokens:e.tokens})),t.totalTokens=this.totalTokens),t}removeMessagesByType(e){const t=[];let n=0;for(const r of this.entries)this._getMessageType(r.message)!==e?t.push(r):n+=r.tokens;this.entries=t,this.totalTokens-=n}removeSystemMessages(){this.removeMessagesByType(d.SYSTEM)}removeLast(){const e=this.entries.pop();return!!e&&(this.totalTokens-=e.tokens,!0)}clear(){this.entries=[],this.totalTokens=0}queueMessage(e){this.messageQueue.push(e)}flushQueue(){for(const e of this.messageQueue)this.add(e);this.messageQueue=[]}clearQueue(){this.messageQueue=[]}getQueueSize(){return this.messageQueue.length}queueHuman(e){this.queueMessage(new l.HumanMessage(e))}queueScreenshot(e,t="Screenshot of current page state"){const n=new l.HumanMessage({content:[{type:"image_url",image_url:{url:e}},{type:"text",text:t}]});n.additional_kwargs={messageType:d.SCREENSHOT},this.queueMessage(n)}queueBrowserState(e){this.queueMessage(new p(e))}queueSystemReminder(e){this.queueMessage(new l.Od(`<system-reminder>${e}</system-reminder>`))}_getMessageType(e){if(e.additional_kwargs?.messageType===d.BROWSER_STATE)return d.BROWSER_STATE;if(e.additional_kwargs?.messageType===d.TODO_LIST)return d.TODO_LIST;if(e.additional_kwargs?.messageType===d.SCREENSHOT)return d.SCREENSHOT;if(Array.isArray(e.content)){if(e.content.some(e=>"image_url"===e.type&&e.image_url?.url))return d.SCREENSHOT}return e instanceof l.HumanMessage?d.HUMAN:e instanceof l.Od?d.AI:e instanceof l.tn?d.SYSTEM:e instanceof l.uf?d.TOOL:d.AI}_getTokensForMessage(e){return u.countMessage(e)}_ensureSpace(e){const t=.9*this.maxTokens;for(;this.totalTokens+e>t&&this.entries.length>0;){if(!this._removeLowestPriority())break}}_removeLowestPriority(){const e={[d.AI]:0,[d.TOOL]:1,[d.HUMAN]:2,[d.BROWSER_STATE]:3,[d.SCREENSHOT]:4,[d.TODO_LIST]:5,[d.SYSTEM]:6},t=Math.max(0,this.entries.length-3);if(0===t)return!1;let n=-1,r=1/0;for(let s=0;s<t;s++){const t=e[this._getMessageType(this.entries[s].message)]??1;t<r&&(r=t,n=s)}if(-1===n)return!1;const s=this.entries.splice(n,1)[0];return this.totalTokens-=s.tokens,!0}}var y=n(269);o.Ik({id:o.ai().int().positive(),content:o.Yj(),status:o.k5(["todo","doing","done","skipped"])});class _{constructor(){this.todos=[]}getAll(){return[...this.todos]}addMultiple(e){const t=this.todos.length+1,n=e.map((e,n)=>({id:t+n,content:e,status:"todo"}));this.todos.push(...n),this.todos.length>_.MAX_TODOS&&(this.todos=this.todos.slice(0,_.MAX_TODOS))}completeMultiple(e){e.forEach(e=>{const t=this.todos.find(t=>t.id===e);t&&(t.status="done")})}complete(e){const t=this.todos.find(t=>t.id===e);t&&(t.status="done")}goBack(e){const t=this.todos.findIndex(t=>t.id===e);if(-1===t)throw new Error(`TODO with id ${e} not found`);for(let e=t;e<this.todos.length;e++)this.todos[e].status="todo"}skip(e){this.todos=this.todos.filter(t=>t.id!==e),this._reindex()}replaceAll(e){this.todos=[],this.addMultiple(e)}markDoing(e){const t=this.todos.find(e=>"doing"===e.status);if(t&&t.id!==e)throw new Error(`Cannot mark TODO ${e} as doing - TODO ${t.id} is already in progress`);const n=this.todos.find(t=>t.id===e);n&&(n.status="doing")}getNextTodo(){const e=this.getCurrentDoing();if(e)return e;const t=this.getPending();if(0===t.length)return null;const n=t[0];return this.markDoing(n.id),n}getCurrentDoing(){return this.todos.find(e=>"doing"===e.status)||null}getPending(){return this.todos.filter(e=>"todo"===e.status)}isAllDoneOrSkipped(){return this.todos.every(e=>"done"===e.status||"skipped"===e.status)}isCompleted(e){const t=this.todos.find(t=>t.id===e);return!!t&&("done"===t.status||"skipped"===t.status)}getXml(){if(0===this.todos.length)return"<todos></todos>";return`<todos>\n${this.todos.map(e=>`<todo id="${e.id}" status="${e.status}">${this._escapeXml(e.content)}</todo>`).join("\n")}\n</todos>`}getJson(){return[...this.todos]}reset(){this.todos=[]}_reindex(){this.todos.forEach((e,t)=>{e.id=t+1})}_escapeXml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}}_.MAX_TODOS=30;class b{constructor(e){this.apiKey=e,this.baseUrl="https://api.klavis.ai"}async request(e,t,n,r){if(!this.apiKey)throw new Error("Klavis API key not configured. Please add KLAVIS_API_KEY to your .env file.");let s=`${this.baseUrl}${t}`;if(r){s+="?"+new URLSearchParams(r).toString()}const i=await fetch(s,{method:e,headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:n?JSON.stringify(n):void 0});if(!i.ok){const e=await i.text();throw new Error(`Klavis API error: ${i.status} ${i.statusText} - ${e}`)}return i.json()}async getUserInstances(e,t){return(await this.request("GET","/user/instances",void 0,{user_id:e,platform_name:t})).instances||[]}async createServerInstance(e){return this.request("POST","/mcp-server/instance/create",{serverName:e.serverName,userId:e.userId,platformName:e.platformName,connectionType:"StreamableHttp"})}async listTools(e,t){const n=`https://${t}-mcp-server.klavis.ai/mcp/?instance_id=${e}`,r=await this.request("POST","/mcp-server/list-tools",{serverUrl:n,format:"openai",connectionType:"StreamableHttp"});if(!r.success)throw new Error(`Failed to list tools: ${r.error||"Unknown error"}`);return r.tools||[]}async callTool(e,t,n,r){const s=`https://${t}-mcp-server.klavis.ai/mcp/?instance_id=${e}`;try{return await this.request("POST","/mcp-server/call-tool",{serverUrl:s,toolName:n,toolArgs:r||{},format:"openai",connectionType:"StreamableHttp"})}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async deleteServerInstance(e){return this.request("DELETE",`/mcp-server/instance/delete/${e}`,void 0)}async getAllServers(){return(await this.request("GET","/mcp-server/servers",void 0)).servers||[]}async getAuthMetadata(e){try{return await this.request("GET",`/mcp-server/instance/get-auth/${e}`,void 0)}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to get auth metadata"}}}async getInstanceStatus(e){return this.request("GET",`/mcp-server/instance/${e}`,void 0)}}const w="nxtscape_user_id",v="Nxtscape";class E{constructor(){this.userId=null;this.client=new b("")}static getInstance(){return E.instance||(E.instance=new E),E.instance}async getUserId(){if(this.userId)return this.userId;try{const e=await chrome.storage.local.get([w]);if(e[w])return this.userId=e[w],this.userId}catch(e){}const e=Date.now(),t=Math.random().toString(36).substr(2,9);this.userId=`nxtscape_${e}_${t}`;try{await chrome.storage.local.set({[w]:this.userId})}catch(e){}return this.userId}async installServer(e){const t=await this.getUserId(),n=await this.client.createServerInstance({serverName:e,userId:t,platformName:v});let r=!0;return n.oauthUrl&&(r=await this._handleOAuth(n.oauthUrl,n.instanceId)),{...n,authSuccess:r}}async getInstalledServers(){const e=await this.getUserId();return this.client.getUserInstances(e,v)}async deleteServer(e){return(await this.client.deleteServerInstance(e)).success}async getAvailableServers(){return this.client.getAllServers()}async _handleOAuth(e,t){return new Promise(n=>{let r;!function(e){e.PENDING="pending",e.SUCCESS="success",e.CANCELLED="cancelled",e.TIMEOUT="timeout"}(r||(r={}));let s=r.PENDING,i=!1;const a=e=>{i||(i=!0,n(e))};chrome.tabs.create({url:e,active:!0},e=>{if(!e.id)return void a(!1);const n=e.id;let i,o;const c=()=>{clearInterval(i),clearTimeout(o),chrome.tabs.onRemoved.removeListener(l)},l=e=>{e===n&&s===r.PENDING&&(chrome.tabs.onRemoved.removeListener(l),setTimeout(()=>{s===r.PENDING&&(s=r.CANCELLED,c(),a(!1))},2e4))};chrome.tabs.onRemoved.addListener(l),setTimeout(()=>{i=setInterval(async()=>{if(s===r.PENDING)try{(await this.client.getInstanceStatus(t)).isAuthenticated&&(s=r.SUCCESS,c(),await chrome.tabs.remove(n).catch(()=>{}),a(!0))}catch(e){}},2e3),o=setTimeout(()=>{s===r.PENDING&&(s=r.TIMEOUT,c(),chrome.tabs.remove(n).catch(()=>{}),a(!1))},3e5)},3e3)})})}async isServerReady(e){const t=(await this.getInstalledServers()).find(t=>t.name.toLowerCase()===e.toLowerCase());return t?{installed:!0,authenticated:t.isAuthenticated,instanceId:t.id}:{installed:!1,authenticated:!1}}}E.instance=null;var S=n(211);const x=1e4,k=(o.Ik({url:o.Yj().url(),eventGapTimeout:o.ai().int().positive(),enableScreenshots:o.zM(),enableFallback:o.zM()}),"ws://localhost:9200"),T=18e4,I=o.Ik({executionId:o.Yj().optional(),browserContext:o.Nl(c.Ay),messageManager:o.Nl(f),abortSignal:o.Nl(AbortSignal).optional(),debugMode:o.zM().default(!1),todoStore:o.Nl(_).optional(),pubsub:o.bz().optional(),supportsVision:o.zM().default(!0),limitedContextMode:o.zM().default(!1),maxTokens:o.ai().default(128e3)});class O{constructor(e){this.selectedTabIds=null,this.parentSpanId=null,this.userInitiatedCancel=!1,this._isExecuting=!1,this._lockedTabId=null,this._currentTask=null,this._todoList="",this._chatMode=!1,this._taskNumber=0,this._scopedPubSub=null,this._supportsVision=!0,this._limitedContextMode=!1,this._maxTokens=128e3,this._reasoningHistory=[],this._executionMetrics={toolCalls:0,observations:0,errors:0,startTime:Date.now(),endTime:0,toolFrequency:new Map};const t=I.parse(e);this.executionId=t.executionId||"default",this.abortSignal=t.abortSignal||(new AbortController).signal,this.browserContext=t.browserContext,this.messageManager=t.messageManager,this.debugMode=t.debugMode||!1,this.todoStore=t.todoStore||new _,this.userInitiatedCancel=!1,this._scopedPubSub=t.pubsub,this._supportsVision=t.supportsVision,this._limitedContextMode=t.limitedContextMode,this._maxTokens=t.maxTokens}supportsVision(){return this._supportsVision}isLimitedContextMode(){return this._limitedContextMode}getMaxTokens(){return this._maxTokens}setChatMode(e){this._chatMode=e}isChatMode(){return this._chatMode}setSelectedTabIds(e){this.selectedTabIds=e}getSelectedTabIds(){return this.selectedTabIds}getPubSub(){if(!this._scopedPubSub)throw new Error(`No PubSub channel provided for execution ${this.executionId}`);return this._scopedPubSub}cancelExecution(e=!1){this.userInitiatedCancel=e}isUserCancellation(){return this.userInitiatedCancel&&this.abortSignal.aborted}resetAbortController(){this.userInitiatedCancel=!1}startExecution(e){this._isExecuting=!0,this._lockedTabId=e}endExecution(){this._isExecuting=!1}isExecuting(){return this._isExecuting}getLockedTabId(){return this._lockedTabId}reset(){this._isExecuting=!1,this._lockedTabId=null,this.userInitiatedCancel=!1,this._currentTask=null,this._todoList="",this._reasoningHistory=[],this.todoStore.reset(),this.toolMetrics?.clear(),this.toolMetrics=void 0,this._executionMetrics={toolCalls:0,observations:0,errors:0,startTime:Date.now(),endTime:0,toolFrequency:new Map}}async getLLM(e){return(0,y.O7)(e)}async getAgentServerUrl(){const e=(0,S.uo)();try{const n=await e.getPref("vibebrowser.server.agent_port");if(n&&"number"==typeof n.value){const e=`ws://localhost:${n.value}`;return t.y7.log("ExecutionContext",`Using agent port from VibeBrowser preferences: ${n.value}`,"info"),e}return t.y7.log("ExecutionContext",`Agent port preference not found, using default URL: ${k}`,"warning"),k}catch(e){return t.y7.log("ExecutionContext",`Failed to get agent port from VibeBrowser preferences: ${e}, using default URL: ${k}`,"error"),k}}setCurrentTask(e){this._currentTask=e,this._taskNumber++}getCurrentTask(){return this._currentTask}getCurrentTaskNumber(){return this._taskNumber}setTodoList(e){this._todoList=e}getTodoList(){return this._todoList}getKlavisAPIManager(){return E.getInstance()}setHumanInputRequestId(e){this._humanInputRequestId=e,this._humanInputResponse=void 0}getHumanInputRequestId(){return this._humanInputRequestId}setHumanInputResponse(e){e.requestId===this._humanInputRequestId&&(this._humanInputResponse=e)}getHumanInputResponse(){return this._humanInputResponse}clearHumanInputState(){this._humanInputRequestId=void 0,this._humanInputResponse=void 0}shouldAbort(){return this.abortSignal.aborted}getExecutionMetrics(){return this._executionMetrics}setExecutionMetrics(e){this._executionMetrics=e}incrementMetric(e){this._executionMetrics[e]++}incrementToolUsageMetrics(e){const t=this._executionMetrics.toolFrequency.get(e)||0;this._executionMetrics.toolFrequency.set(e,t+1)}addReasoning(e){this._reasoningHistory.push(e),this._reasoningHistory.length>10&&this._reasoningHistory.shift()}getReasoningHistory(e=5){return this._reasoningHistory.slice(-e)}getSimplifiedMessageHistory(e=5){return this.messageManager.getMessages().slice(-e).map(e=>{const t=e._getType();let n="";if("human"===t){const t=e;if(Array.isArray(t.content)){const e=t.content.filter(e=>"text"===e.type).map(e=>e.text);n=`${t.content.some(e=>"image_url"===e.type)?"Human [with screenshot]":"Human"}: ${e.join(" ")||"Visual content only"}`}else n=`Human: ${t.content}`;return n}if("ai"===t){const t=e;if(t.tool_calls&&t.tool_calls.length>0){n=`AI called: ${t.tool_calls.map(e=>(e.args?JSON.stringify(e.args).substring(0,50):"").length>45?`${e.name}(...)`:`${e.name}()`).join(", ")}`}else n="string"==typeof t.content&&t.content.includes("<system-reminder>")?`System reminder: ${t.content.replace(/<\/?system-reminder>/g,"")}`:`AI: ${t.content||"Thinking..."}`;return n}if("tool"===t){const t=e;try{const e=JSON.parse(t.content);if(e.ok&&e.output){const t="string"==typeof e.output?e.output:JSON.stringify(e.output);n=`Tool success: ${t.length>100?t.substring(0,100)+"...":t}`}else n=e.ok?"Tool success":`Tool error: ${e.error||"Unknown error"}`}catch{const e=String(t.content);n=`Tool: ${e.substring(0,100)}${e.length>100?"...":""}`}return n}if("system"===t){return n=`System: ${String(e.content).substring(0,100)}...`,n}return n}).filter(Boolean)}}class C{constructor(e){this.tools=new Map,this.executionContext=e}register(e){this.tools.set(e.name,e)}get(e){return this.tools.get(e)}getAll(){return Array.from(this.tools.values())}getDescriptions(){const e=this.getAll();if(0===e.length)return"No tools available.";return`Available tools:\n${e.map(e=>`- ${e.name}: ${e.description}`).join("\n")}`}}class A extends Error{constructor(e="Task cancelled by user"){super(e),this.name="AbortError"}}function P(e){if(e instanceof A)return!0;if(e instanceof Error){const t=e.message.toLowerCase();return"request was aborted"===t||"the operation was aborted"===t||t.includes("request was aborted")}return!1}function M(e){const t=JSON.parse(e);if(t.output&&"string"==typeof t.output)try{t.output=JSON.parse(t.output)}catch{}return t}var R=n(4853);o.Ik({ok:o.zM(),output:o.Yj()});function $(e){return{ok:!0,output:e}}function j(e){return{ok:!1,output:e}}var N=n(7889);const L=o.Ik({nodeId:o.ai().int().min(1).describe("The nodeId number from [brackets] in element list")});function D(e){return new N.XW({name:"click",description:"Click an element by its nodeId (number in brackets)",schema:L,func:async t=>{try{e.incrementMetric("toolCalls");const n=await e.browserContext.getCurrentPage(),{element:r,scrollMessage:s}=await n.ensureElementInViewport(t.nodeId);return r?(await n.clickElement(t.nodeId),await n.waitForStability(),JSON.stringify({ok:!0,output:`Successfully clicked element ${t.nodeId} ${s}`})):JSON.stringify({ok:!1,error:"Element not found"})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Failed to click : ${t instanceof Error?t.message:String(t)}`})}}})}var U=n(2783);const F=o.Ik({nodeId:o.ai().int().min(1).describe("The nodeId number from [brackets] in element list"),text:o.Yj().describe("Text to type into the element")});function Y(e){return new N.XW({name:"type",description:"Type text into an input element",schema:F,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage(`Typing "${t.text}"...`,"thinking"));const n=await e.browserContext.getCurrentPage(),{element:r,scrollMessage:s}=await n.ensureElementInViewport(t.nodeId);return r?(await n.inputText(t.nodeId,t.text),await n.waitForStability(),JSON.stringify({ok:!0,output:`Successfully typed "${t.text}" into element ${t.nodeId} ${s}`})):JSON.stringify({ok:!1,error:"Element not found"})}catch(n){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Failed to type into element ${t.nodeId}: ${n instanceof Error?n.message:String(n)}`})}}})}const G=o.Ik({nodeId:o.ai().int().min(1).describe("The nodeId number from [brackets] in element list")});function B(e){return new N.XW({name:"clear",description:"Clear text from an input element",schema:G,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage("Clearing text...","thinking"));const n=await e.browserContext.getCurrentPage(),{element:r,scrollMessage:s}=await n.ensureElementInViewport(t.nodeId);return r?(await n.clearElement(t.nodeId),await n.waitForStability(),JSON.stringify({ok:!0,output:`Successfully cleared element ${t.nodeId} ${s}`})):JSON.stringify({ok:!1,error:"Element not found"})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Failed to clear : ${t instanceof Error?t.message:String(t)}`})}}})}const H=o.Ik({nodeId:o.ai().int().min(1).optional().describe("NodeId to scroll to (optional)"),direction:o.k5(["up","down"]).optional().describe("Direction to scroll page if no nodeId provided"),amount:o.ai().int().min(1).optional().default(1).describe("Number of viewport heights to scroll (default: 1)")});function z(e){return new N.XW({name:"scroll",description:"Scroll to a specific element or scroll the page",schema:H,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage("Scrolling...","thinking"));const n=await e.browserContext.getCurrentPage(),r=t.amount||1;if(t.nodeId){const e=await n.scrollToElement(t.nodeId);return JSON.stringify({ok:!0,output:`Scrolled to element : ${t.nodeId} ${e?"success":"already visible"}`})}if(t.direction){let e;e="down"===t.direction?await n.scrollDown(r):await n.scrollUp(r);const s=e.didScroll?`Scrolled ${t.direction} ${r} viewport(s)`:`Already at ${"down"===t.direction?"bottom":"top"} of page - no space to scroll ${t.direction}`;return JSON.stringify({ok:!0,output:s})}return JSON.stringify({ok:!1,error:"Must provide either nodeId or direction"})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Scroll failed: ${t instanceof Error?t.message:String(t)}`})}}})}const q=o.Ik({url:o.Yj().url().describe("Full URL to navigate to (must include https://)")});function K(e){return new N.XW({name:"navigate",description:"Navigate to a URL",schema:q,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage("Navigating...","thinking"));const n=await e.browserContext.getCurrentPage();return await n.navigateTo(t.url),await n.waitForStability(),JSON.stringify({ok:!0,output:`Successfully navigated to ${t.url}`})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Navigation failed: ${t instanceof Error?t.message:String(t)}`})}}})}const W=o.Ik({key:o.k5(["Enter","Tab","Escape","Backspace","Delete","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown"]).describe("Keyboard key to press")});function V(e){return new N.XW({name:"key",description:"Send a keyboard key press",schema:W,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage("Pressing key...","thinking"));const n=await e.browserContext.getCurrentPage();return await n.sendKeys(t.key),JSON.stringify({ok:!0,output:`Pressed ${t.key} key`})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Key press failed: ${t instanceof Error?t.message:String(t)}`})}}})}const J=o.Ik({seconds:o.ai().min(0).optional().default(2).describe("Additional seconds to wait (default: 2)")});function Z(e){return new N.XW({name:"wait",description:"Wait for page to stabilize after actions",schema:J,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage(`Waiting for ${t.seconds}...`,"thinking"));const n=await e.browserContext.getCurrentPage();await n.waitForStability();const r=t.seconds||2;return r>0&&await new Promise(e=>setTimeout(e,1e3*r)),JSON.stringify({ok:!0,output:`Waited ${r} seconds for stability`})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Wait failed: ${t instanceof Error?t.message:String(t)}`})}}})}o.Ik({todos:o.Yj().describe("Markdown formatted todo list")});o.Ik({});const X=o.Ik({});function Q(e){return new N.XW({name:"tabs",description:"List all tabs in the current browser window",schema:X,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage("Listing browser tabs...","thinking"));const t=await chrome.windows.getCurrent(),n=(await chrome.tabs.query({windowId:t.id})).filter(e=>void 0!==e.id).map(e=>({id:e.id,title:e.title||"Untitled",url:e.url||"",active:e.active||!1}));return JSON.stringify({ok:!0,output:n})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Failed to list tabs: ${t instanceof Error?t.message:String(t)}`})}}})}const ee=o.Ik({url:o.Yj().url().optional().describe("URL to open (optional, defaults to new tab page)")});function te(e){return new N.XW({name:"tab_open",description:"Open a new browser tab with optional URL",schema:ee,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage("Opening tab...","thinking"));const n=t.url||"chrome://newtab/",r=await e.browserContext.openTab(n);return JSON.stringify({ok:!0,output:{tabId:r.tabId,url:n}})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Failed to open tab: ${t instanceof Error?t.message:String(t)}`})}}})}const ne=o.Ik({tabId:o.ai().int().min(1).describe("Tab ID to focus")});function re(e){return new N.XW({name:"tab_focus",description:"Switch focus to a specific tab by ID",schema:ne,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage("Switching tab...","thinking")),await e.browserContext.switchTab(t.tabId);const n=await chrome.tabs.get(t.tabId);return JSON.stringify({ok:!0,output:`Focused tab: ${n.title||"Untitled"} (ID: ${t.tabId})`})}catch(n){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Failed to focus tab ${t.tabId}: ${n instanceof Error?n.message:String(n)}`})}}})}const se=o.Ik({tabId:o.ai().int().min(1).describe("Tab ID to close")});function ie(e){return new N.XW({name:"tab_close",description:"Close a specific tab by ID",schema:se,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage("Closing tab...","thinking"));const n=(await chrome.tabs.get(t.tabId)).title||"Untitled";return await e.browserContext.closeTab(t.tabId),JSON.stringify({ok:!0,output:`Closed tab: ${n} (ID: ${t.tabId})`})}catch(n){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Failed to close tab ${t.tabId}: ${n instanceof Error?n.message:String(n)}`})}}})}var ae=n(1346);function oe(e){return new N.XW({name:"extract",description:"Extract structured data from current page using AI. Provide a JSON format object and description of what to extract.",schema:o.Ik({format:o.bz().describe("JSON object showing desired output structure (e.g., {title: '', price: 0, items: []})"),task:o.Yj().describe("Description of what data to extract from the page"),extractionMode:o.k5(["text","text-with-links"]).optional().default("text").describe("Extraction mode: 'text' for content only, 'text-with-links' to include links section")}),func:async({format:n,task:r,extractionMode:s="text"})=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage("Extracting data from page...","thinking"));const a=await e.browserContext.getCurrentPage(),o=await a.getPageDetails(),{mainContent:c,linksContent:u}=await async function(e,t){const n=(0,ae.k)();if(n.isEnabled("NEW_SNAPSHOT_FORMAT")){if("text-with-links"===t){return{mainContent:await e.getTextWithLinksString(),linksContent:null}}return{mainContent:await e.getTextSnapshotString(),linksContent:null}}return{mainContent:await e.getHierarchicalText(),linksContent:"text-with-links"===t?await e.getLinksSnapshotString():null}}(a,s),d=(i=e.messageManager.getMaxTokens())>=1e6?Number.MAX_SAFE_INTEGER:i>=2e5?1e5:16e3,h=function(e,t,n,r,s,i){const a=(0,ae.k)().isEnabled("NEW_SNAPSHOT_FORMAT"),o=a?"Content (markdown format with headings and links):":"Content (hierarchical structure with tab indentation):";let c=`Task: ${e}\n\nDesired output format:\n${JSON.stringify(t,null,2)}\n\nPage content:\nURL: ${n.url}\nTitle: ${n.title}\n\n${o}\n${r}`;!a&&"text-with-links"===i&&s&&(c+=`\n\nLinks found:\n${s.substring(0,2e3)}${s.length>2e3?"\n...[more links]":""}`);return c+="\n\nExtract the requested data and return it matching the exact structure of the format provided.",c}(r,n,o,function(e,t){if(t===Number.MAX_SAFE_INTEGER||e.length<=t)return e;return e.substring(0,t)+"\n...[truncated]"}(c,d),u,s);t.y7.log("ExtractTool",`Extracting data (mode: ${s})`,"info");const p=await e.getLLM({temperature:.1,maxTokens:8e3});return function(e){try{const t=e.replace(/```json\s*/gi,"").replace(/```\s*/g,"").trim(),n=JSON.parse(t);return JSON.stringify({ok:!0,output:n})}catch(t){return JSON.stringify({ok:!1,error:`Failed to parse extraction result as JSON. Raw output: ${e}`})}}((await p.invoke([new l.tn("You are a data extraction specialist. Extract the requested information from the page content and return it in the exact JSON structure provided.\n\nIMPORTANT: Return ONLY valid JSON, no explanations or markdown."),new l.HumanMessage(h)])).content)}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Extraction failed: ${t instanceof Error?t.message:String(t)}`})}var i}})}const ce=o.Ik({prompt:o.Yj().describe("The situation requiring human intervention")});function le(e){return new N.XW({name:"human_input",description:'Request human intervention when stuck or need manual action.\n\nUse this when:\n- You need the human to manually complete a step (enter credentials, solve CAPTCHA, etc.)\n- You\'re blocked and need the human to take over temporarily\n- You encounter an error that requires human judgment\n- You need confirmation before proceeding with a risky action\n\nThe human will either click "Done" (after taking action) or "Abort task" (to cancel).',schema:ce,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage(" Requesting human input...","thinking"));const n=U.D.generateId("human_input");e.setHumanInputRequestId(n);const r=U.D.generateId("human_input_msg");return e.getPubSub().publishMessage(U.D.createMessageWithId(r,` **Waiting for human input:** ${t.prompt}`,"thinking")),e.getPubSub().publishHumanInputRequest({requestId:n,prompt:t.prompt}),JSON.stringify({ok:!0,output:`Waiting for human input: ${t.prompt}`,requiresHumanInput:!0,requestId:n})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:t instanceof Error?t.message:String(t)})}}})}const ue=o.Ik({success:o.zM().describe("Whether the actions have been completed successfully"),message:o.Yj().optional().describe("Completion message or reason for failure")});function de(e){return new N.XW({name:"done",description:"Mark the actions as complete",schema:ue,func:async t=>(e.incrementMetric("toolCalls"),JSON.stringify({ok:!0,output:{success:t.success,message:t.message}}))})}function he(e){return new N.XW({name:"celebration",description:"Shows a confetti celebration animation on the current page. Use this to celebrate successful actions like upvoting or starring.",schema:o.Ik({}),func:async()=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage(" Celebrating...","thinking"));const t=await e.browserContext.getCurrentPage();return t?(await t.executeJavaScript("\n(() => {\n  // Color palette for confetti\n  const colors = ['#f44336','#e91e63','#9c27b0','#3f51b5','#2196f3','#00bcd4','#4caf50','#ffeb3b','#ff9800'];\n  const confettiCount = 400;\n\n  // Create container for all confetti\n  const container = document.createElement('div');\n  container.id = 'vibebrowser-confetti-container';\n  container.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:999999;overflow:hidden';\n\n  // Create individual confetti pieces\n  for(let i = 0; i < confettiCount; i++) {\n    const confetto = document.createElement('div');\n    const color = colors[Math.floor(Math.random() * colors.length)];\n    const left = Math.random() * 100;\n    const animationDelay = Math.random() * 2;\n    const animationDuration = 3 + Math.random() * 2;\n    const size = 10 + Math.random() * 40;\n\n    confetto.style.cssText = `\n      position:absolute;\n      width:${size}px;\n      height:${size}px;\n      background:${color};\n      left:${left}%;\n      top:-20px;\n      opacity:1;\n      transform:rotate(${Math.random() * 360}deg);\n      animation:confetti-fall ${animationDuration}s linear ${animationDelay}s forwards;\n      border-radius:${Math.random() > 0.5 ? '50%' : '0'};\n    `;\n    container.appendChild(confetto);\n  }\n\n  // Add animation keyframes\n  const style = document.createElement('style');\n  style.id = 'vibebrowser-confetti-styles';\n  style.textContent = `\n    @keyframes confetti-fall {\n      0% {\n        transform: translateY(0) rotate(0deg) scale(1);\n        opacity: 1;\n      }\n      100% {\n        transform: translateY(calc(100vh + 20px)) rotate(720deg) scale(0);\n        opacity: 0;\n      }\n    }\n  `;\n  document.head.appendChild(style);\n  document.body.appendChild(container);\n\n  // Cleanup after animation completes\n  setTimeout(() => {\n    const containerEl = document.getElementById('vibebrowser-confetti-container');\n    const styleEl = document.getElementById('vibebrowser-confetti-styles');\n    if (containerEl) containerEl.remove();\n    if (styleEl) styleEl.remove();\n  }, 7000);\n\n  // Return success\n  return true;\n})();\n"),JSON.stringify({ok:!0,output:"Confetti celebration shown!"})):JSON.stringify({ok:!1,error:"No active page to show celebration"})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Failed to show celebration: ${t instanceof Error?t.message:String(t)}`})}}})}const pe=o.Ik({instruction:o.Yj().describe("Describe what to click on (e.g., 'button', 'blue submit button', 'search icon')")});function me(e){return new N.XW({name:"visual_click",description:"Click on any element by describing what it looks like. Pass a clear description like 'blue submit button', 'search icon', 'first checkbox', 'close button in modal', etc.",schema:pe,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage(" Clicking...","thinking"));const n="";if(!n)return JSON.stringify({ok:!1,error:"Vision API key not provided."});const r=await e.browserContext.getCurrentPage(),s=await r.executeJavaScript("\n          ({ width: window.innerWidth, height: window.innerHeight })\n        "),i=await r.takeScreenshotWithDimensions(s.width,s.height,!1);if(!i)return JSON.stringify({ok:!1,error:"Failed to capture screenshot for Moondream visual click"});const a=await fetch("https://api.moondream.ai/v1/point",{method:"POST",headers:{"X-Moondream-Auth":n,"Content-Type":"application/json"},body:JSON.stringify({image_url:i,object:t.instruction})});if(!a.ok){const e=await a.json(),t=e.error?.message||`API error: ${a.status}`;return JSON.stringify({ok:!1,error:`Moondream API error: ${t}`})}const o=await a.json();if(!o.points||0===o.points.length)return JSON.stringify({ok:!1,error:`No "${t.instruction}" found on the page`});const c=o.points[0],l=Math.round(c.x*s.width),u=Math.round(c.y*s.height);return await r.clickAtCoordinates(l,u),JSON.stringify({ok:!0,output:{coordinates:{x:l,y:u},description:`Clicked "${t.instruction}" at (${l}, ${u})`,pointsFound:o.points.length}})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Moondream click failed: ${t instanceof Error?t.message:String(t)}`})}}})}const ge=o.Ik({instruction:o.Yj().describe("Describe the input field to type in (e.g., 'search box', 'email field', 'password input')"),text:o.Yj().describe("Text to type into the identified field")});function fe(e){return new N.XW({name:"visual_type",description:"Type text into any input field by describing what it looks like. Pass a clear description like 'search box', 'email field', 'username input', 'comment textarea', etc.",schema:ge,func:async t=>{try{e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage(` Typing "${t.text}"...`,"thinking"));const n="";if(!n)return JSON.stringify({ok:!1,error:"Vision API key not provided."});const r=await e.browserContext.getCurrentPage(),s=await r.executeJavaScript("\n          ({ width: window.innerWidth, height: window.innerHeight })\n        "),i=await r.takeScreenshotWithDimensions(s.width,s.height,!1);if(!i)return JSON.stringify({ok:!1,error:"Failed to capture screenshot for Moondream visual type"});const a=await fetch("https://api.moondream.ai/v1/point",{method:"POST",headers:{"X-Moondream-Auth":n,"Content-Type":"application/json"},body:JSON.stringify({image_url:i,object:t.instruction})});if(!a.ok){const e=await a.json(),t=e.error?.message||`API error: ${a.status}`;return JSON.stringify({ok:!1,error:`Moondream API error: ${t}`})}const o=await a.json();if(!o.points||0===o.points.length)return JSON.stringify({ok:!1,error:`No "${t.instruction}" found on the page`});const c=o.points[0],l=Math.round(c.x*s.width),u=Math.round(c.y*s.height);return await r.typeAtCoordinates(l,u,t.text),JSON.stringify({ok:!0,output:{coordinates:{x:l,y:u},description:`Typed "${t.text}" into "${t.instruction}" at (${l}, ${u})`,pointsFound:o.points.length}})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Moondream type failed: ${t instanceof Error?t.message:String(t)}`})}}})}o.Ik({x:o.ai().int().nonnegative().describe("X coordinate in viewport pixels"),y:o.ai().int().nonnegative().describe("Y coordinate in viewport pixels")});o.Ik({x:o.ai().int().nonnegative().describe("X coordinate in viewport pixels"),y:o.ai().int().nonnegative().describe("Y coordinate in viewport pixels"),text:o.Yj().describe("Text to type at the specified coordinates")});const ye=o.Ik({pattern:o.Yj().describe("Regex pattern to search for (e.g., 'button.*login', 'input.*(email|user)')"),limit:o.ai().int().min(1).optional().default(15).describe("Maximum number of results to return (default: 15)")});function _e(e){return new N.XW({name:"grep_elements",description:'Search page elements using regex patterns. Browser state format: [nodeId] <C/T> <tag> "text" attributes\n\nCOMMON PATTERNS:\n- Text search: "login|sign.?in" (flexible login text)\n- Buttons: "button.*submit|input.*submit" (submit buttons)\n- Inputs: "input.*(email|user|name)" (form fields)\n- Links: "a.*href.*shop" (links containing \'shop\')\n- IDs: "\\\\[\\\\d+\\\\].*login" (any element with \'login\')\n- Attributes: \'type="email"|placeholder.*email\' (email fields)\n\nEXAMPLE: [42] <C> <button> "Submit" class="btn-primary"\nReturns max 15 matches, shows total count if more exist.',schema:ye,func:async t=>{try{let n;e.incrementMetric("toolCalls"),e.getPubSub().publishMessage(U.D.createMessage(`Searching with pattern "${t.pattern}"...`,"thinking"));try{n=new RegExp(t.pattern,"i")}catch(e){return JSON.stringify({ok:!1,error:`Invalid regex pattern: ${e instanceof Error?e.message:String(e)}`})}const r=(await e.browserContext.getBrowserStateString()).split("\n"),s=[];for(const e of r)""!==e.trim()&&n.test(e)&&s.push(e.trim());const i=s.length,a=s.slice(0,t.limit);if(0===a.length)return JSON.stringify({ok:!1,error:`No elements found matching pattern "${t.pattern}". Try broader patterns like 'button', 'input', or check browser state format.`});const o=i>15?`\n\nShowing first 15 of ${i} matches.`:"";return JSON.stringify({ok:!0,output:`${a.join("\n")}${o}`})}catch(t){return e.incrementMetric("errors"),JSON.stringify({ok:!1,error:`Grep elements failed: ${t instanceof Error?t.message:String(t)}`})}}})}const be=o.Ik({size:o.k5(["small","medium","large"]).optional()});const we=5;const ve=5,Ee=o.Ik({task:o.Yj(),max_steps:o.ai().default(ve)}),Se=o.Ik({steps:o.YO(o.Ik({action:o.Yj(),reasoning:o.Yj()}))});function xe(e){return new N.XW({name:"planner_tool",description:`Generate up to ${ve} steps for the task`,schema:Ee,func:async n=>{try{e.getPubSub().publishMessage(a.Gd.createMessage("Creating plan for task...","thinking"));const r=await e.getLLM(),s=new g(e.messageManager).getFilteredAsString([h.SYSTEM,h.BROWSER_STATE]),i=await e.browserContext.getBrowserStateString(),o=u.countString(i),c=o>e.messageManager.getMaxTokens()?"[Browser state too large to include - exceeds token limit]":i,d=function(e){const t=e??we;return`You are a helpful assistant that excels at analyzing tasks and breaking them down into actionable steps.\n\n# RESPONSIBILITIES:\n1. Analyze the current state and conversation history to understand what has been accomplished\n2. Evaluate progress towards the ultimate goal\n3. Identify potential challenges or roadblocks\n4. Generate specific, actionable next steps (maximum ${t} steps)\n5. Provide clear reasoning for your suggested approach\n\n# PLANNING GUIDELINES:\n- Keep plans SHORT and FOCUSED: Maximum of ${t} steps at a time.\n- You need NOT generate ${t} steps if the task is simple, even 1 or 2 step plan is fine.\n- Focus on WHAT to achieve, not HOW to do it\n- Each step should be a logical business action or goal\n- Order steps logically with dependencies in mind\n- Think in terms of user objectives, not technical implementations\n- If you know specific sites/URLs, mention them (e.g., "Navigate to Amazon")\n- Let the browser agent handle the technical details of each step\n\n# MCP SERVER INTEGRATION:\nFor tasks involving external services (email, calendar, GitHub, Slack, YouTube, Drive, Notion, Linear):\n\nYour plan MUST follow this EXACT pattern for MCP-related tasks:\n- Step 1: "Check if [Service] MCP server is installed and get server URL"\n- Step 2: "Get available tools from [Service] MCP server"\n- Step 3: "Use [Service] MCP to [perform action]"\n\nExample for "Check my unread emails":\n- Step 1: "Check if Gmail MCP server is installed and get server URL"\n- Step 2: "Get available tools from Gmail MCP server"\n- Step 3: "Use Gmail MCP to search for unread emails"\n\nExample for "Send an email":\n- Step 1: "Check if Gmail MCP server is installed and get server URL"\n- Step 2: "Get available tools from Gmail MCP server"\n- Step 3: "Use Gmail MCP to compose and send email"\n\nIMPORTANT: Do NOT skip the "Get available tools" step - tool names vary between servers\n\n# STEP FORMAT:\nEach step should describe WHAT to achieve, not HOW:\n- "Navigate to Amazon" (not "Click on address bar and type amazon.com")\n- "Search for toothpaste" (not "Click search box, type toothpaste, press enter")\n- "Select a suitable product" (not "Click on the first result with 4+ stars")\n- "Add product to cart" (not "Find and click the Add to Cart button")\n- "Proceed to checkout" (not "Click on cart icon then checkout button")\n\n# OUTPUT FORMAT:\nYou must return a JSON object with the following structure:\n{\n  "steps": [\n    {\n      "action": "High-level description of what to do",\n      "reasoning": "Why this step is necessary"\n    }\n  ]\n}\n\n# REMEMBER:\n- Maximum ${t} steps focusing on business objectives. You can generate 1 or 2 step plan as well, if the objective is simple.\n- Keep steps high-level and goal-oriented\n- Consider what has already been accomplished\n- The user can see the page - they often refer to visible elements`}(n.max_steps||ve),p=function(e,t,n,r){return`PLANNING REQUEST:\n\nTASK: ${e}\nMAXIMUM STEPS: ${t}\n\nCONVERSATION HISTORY:\n${n||"(no conversation history yet)"}\n\nCURRENT BROWSER STATE:\n${r||"(no browser state available)"}\n\nBased on the task, conversation history, and current browser state, generate a plan of up to ${t} actionable steps.\nReturn your response as a JSON object matching the format specified in the system prompt.`}(n.task,n.max_steps,s,c),m=[new l.tn(d),new l.HumanMessage(p)],f=u.countMessages(m);t.y7.log("PlannerTool",`Invoking LLM with ${u.format(f)}`,"info");const y=r.withStructuredOutput(Se),_=await(0,R.D)(y,m,3,{signal:e.abortSignal});return e.getPubSub().publishMessage(a.Gd.createMessage(`Created plan with ${_.steps.length} steps`,"thinking")),JSON.stringify({ok:!0,output:_})}catch(t){const n=t instanceof Error?t.message:String(t);return e.getPubSub().publishMessage(a.Gd.createMessageWithId(a.Gd.generateId("ToolError"),`Planning failed: ${n}`,"error")),JSON.stringify(j(n))}}})}o.Ik({id:o.Yj(),name:o.Yj(),subdomain:o.Yj(),iconPath:o.Yj()});const ke=[{id:"google-calendar",name:"Google Calendar",subdomain:"gcalendar",iconPath:"assets/mcp_servers/google-calendar.svg"},{id:"gmail",name:"Gmail",subdomain:"gmail",iconPath:"assets/mcp_servers/gmail.svg"},{id:"google-sheets",name:"Google Sheets",subdomain:"gsheets",iconPath:"assets/mcp_servers/google-sheets.svg"},{id:"google-docs",name:"Google Docs",subdomain:"gdocs",iconPath:"assets/mcp_servers/google-docs.svg"},{id:"notion",name:"Notion",subdomain:"notion",iconPath:"assets/mcp_servers/notion.svg"}],Te=o.Ik({action:o.k5(["getUserInstances","listTools","callTool"]).describe("The action to perform"),instanceId:o.Yj().optional().describe("Instance ID for listTools and callTool"),toolName:o.Yj().optional().describe("Tool name for callTool"),toolArgs:o.bz().optional().describe("Arguments for callTool")});class Ie{constructor(e){this.executionContext=e,this.instancesCache=new Map,this.manager=this.executionContext.getKlavisAPIManager()}_getSubdomainFromName(e){const t=ke.find(t=>t.name===e);return t?.subdomain?t.subdomain:e.toLowerCase().replace(/\s+/g,"")}async execute(e){try{switch(e.action){case"getUserInstances":return await this._getUserInstances();case"listTools":return await this._listTools(e.instanceId);case"callTool":return await this._callTool(e.instanceId,e.toolName,e.toolArgs);default:return j(`Unknown action: ${e.action}`)}}catch(e){return j(`MCP operation failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async _getUserInstances(){try{const e=await this.manager.getInstalledServers();if(0===e.length)return $(JSON.stringify({instances:[],message:"No MCP servers installed. Please install servers in Settings > Integrations."}));e.forEach(e=>{this.instancesCache.set(e.id,{id:e.id,name:e.name})});const t=e.map(e=>({id:e.id,name:e.name,authenticated:e.isAuthenticated,authNeeded:e.authNeeded,toolCount:e.tools?.length||0}));return $(JSON.stringify({instances:t,count:t.length}))}catch(e){return j(`Failed to get user instances: ${e instanceof Error?e.message:"Unknown error"}`)}}async _listTools(e){if(!e)return j("instanceId is required for listTools action");const t=this.instancesCache.get(e);if(!t)return j(`Instance ${e} not found. Please run getUserInstances first.`);try{const n=this._getSubdomainFromName(t.name),r=await this.manager.client.listTools(e,n);return r&&0!==r.length?$(JSON.stringify({tools:r,count:r.length,instanceId:e})):$(JSON.stringify({tools:[],message:"No tools available for this server"}))}catch(e){return j(`Failed to list tools: ${e instanceof Error?e.message:"Unknown error"}`)}}async _callTool(e,n,r){if(!e)return j("instanceId is required for callTool action");if(!n)return j("toolName is required for callTool action");const s=this.instancesCache.get(e);if(!s)return j(`Instance ${e} not found. Please run getUserInstances first.`);try{const i=this._getSubdomainFromName(s.name);let a=r;if("string"==typeof r)try{a=JSON.parse(r)}catch(e){a=r}t.y7.logMetric("mcp_tool_called",{server_name:s.name,tool_name:n,instance_id:e});const o=await this.manager.client.callTool(e,i,n,a||{});if(!o.success)return t.y7.logMetric("mcp_tool_failed",{server_name:s.name,tool_name:n,error:o.error||"Tool execution failed",instance_id:e}),j(o.error||"Tool execution failed");t.y7.logMetric("mcp_tool_success",{server_name:s.name,tool_name:n,instance_id:e},.1);const c={success:!0,toolName:n,result:o.result?.content||o.result,instanceId:e};return $(JSON.stringify(c))}catch(r){return t.y7.logMetric("mcp_tool_failed",{server_name:s.name,tool_name:n,error:r instanceof Error?r.message:"Unknown error",instance_id:e}),j(`Tool execution failed: ${r instanceof Error?r.message:"Unknown error"}`)}}}function Oe(e){const t=new Ie(e);return new N.XW({name:"mcp_tool",description:"Interact with installed MCP servers (Gmail, GitHub, Slack, etc.). \n    Actions:\n    - getUserInstances: Get all installed MCP servers with their instance IDs\n    - listTools: List available tools for a server (requires instanceId)\n    - callTool: Execute a tool on a server (requires instanceId, toolName, toolArgs)",schema:Te,func:async e=>{const n=await t.execute(e);return JSON.stringify(n)}})}const Ce=o.Ik({});o.Ik({id:o.ai(),url:o.Yj(),title:o.Yj()});class Ae{constructor(e){this.executionContext=e}async execute(e){try{this.executionContext.getPubSub().publishMessage(a.Gd.createMessage("Getting selected tabs","thinking"));const e=this.executionContext.getSelectedTabIds(),t=Boolean(e&&e.length>0),n=await this.executionContext.browserContext.getPages(t&&e?e:void 0);if(0===n.length)return $(JSON.stringify([]));const r=await Promise.all(n.map(async e=>({id:e.tabId,url:e.url(),title:await e.title()})));return $(JSON.stringify(r))}catch(e){return j(`Failed to get tab information: ${e instanceof Error?e.message:String(e)}`)}}}function Pe(e){const t=new Ae(e);return new N.XW({name:"get_selected_tabs_tool",description:"Get information about currently selected tabs. Returns an array of tab objects with id, url, and title. If no tabs are selected, returns the current tab.",schema:Ce,func:async e=>{const n=await t.execute(e);return JSON.stringify(n)}})}const Me=o.Ik({tabIds:o.YO(o.ai()).min(1),groupName:o.Yj().optional(),color:o.k5(["grey","blue","red","yellow","green","pink","purple","cyan","orange"]).optional()});class Re{constructor(e){this.executionContext=e}async execute(e){try{this.executionContext.getPubSub().publishMessage(a.Gd.createMessage(`Grouping tabs ${e.tabIds.join(", ")} with name: ${e.groupName}`,"thinking"));const t=await chrome.tabs.getCurrent(),n=t?.windowId,r=await chrome.tabs.query({windowId:n}),s=e.tabIds.filter(e=>r.some(t=>t.id===e));if(0===s.length)return j(`No valid tabs found with IDs: ${e.tabIds.join(", ")}`);const i=await chrome.tabs.group({tabIds:s});if(chrome.tabGroups?.update){const t={color:e.color||"blue"};e.groupName&&(t.title=e.groupName),await chrome.tabGroups.update(i,t)}const o=1===s.length?"tab":"tabs";return e.groupName?$(`Grouped ${s.length} ${o} as "${e.groupName}"`):$(`Grouped ${s.length} ${o}`)}catch(e){return j(`Failed to group tabs: ${e instanceof Error?e.message:String(e)}`)}}}function $e(e){const t=new Re(e);return new N.XW({name:"group_tabs_tool",description:"Group browser tabs together. Pass tabIds array and optionally groupName and color (grey, blue, red, yellow, green, pink, purple, cyan, orange).",schema:Me,func:async e=>{const n=await t.execute(e);return JSON.stringify(n)}})}const je=o.Ik({topic:o.k5(["overview","installation","configuration","automation","api","troubleshooting","examples","features"]).describe("Information topic to retrieve about VibeBrowser"),section:o.Yj().optional().describe("Specific section within the topic (optional)")});class Ne{constructor(e){this.executionContext=e}async execute(e){try{const{topic:t,section:n}=e,r=this._getTopicInfo(t,n);return r?$(JSON.stringify({topic:t,section:n||"all",content:r})):j(`No information found for topic: ${t}${n?`, section: ${n}`:""}`)}catch(e){return j(`Failed to retrieve VibeBrowser info: ${e instanceof Error?e.message:String(e)}`)}}_getTopicInfo(e,t){const n={overview:"# VibeBrowser Overview\n\nVibeBrowser is an AI-powered browser automation platform that enables intelligent web interaction through natural language commands.\n\n## Key Features\n- **AI-Driven Automation**: Uses LLM providers (Claude, OpenAI, Ollama) to understand and execute browser tasks\n- **Multi-Tab Support**: Seamlessly work across multiple browser tabs\n- **Visual Element Recognition**: Can identify and interact with page elements using visual descriptions\n- **Real-Time Streaming**: See AI thinking and actions in real-time\n- **Extensible Tool System**: Modular architecture with specialized tools for different tasks\n\n## Architecture\n- **BrowserAgent**: Main unified agent handling task execution\n- **Tool System**: Modular tools for navigation, interaction, planning, and validation\n- **Browser Integration**: Direct Chrome extension APIs for tab management\n- **LLM Integration**: Multi-provider support with streaming capabilities\n\n## Use Cases\n- Web scraping and data extraction\n- Form automation and testing\n- Cross-platform web workflows\n- Browser-based task automation\n- AI-assisted web navigation",installation:'# VibeBrowser Installation Guide\n\n## Prerequisites\n- Chrome browser (latest version recommended)\n- Node.js 18+ for development\n- NPM or Yarn package manager\n\n## Installation Steps\n\n### 1. Chrome Extension Installation\n```bash\n# Clone the repository\ngit clone https://github.com/vibebrowser-ai/VibeBrowser-agent\ncd VibeBrowser-agent\n\n# Install dependencies\nnpm install\n\n# Build the extension\nnpm run build\n```\n\n### 2. Load Extension in Chrome\n1. Open Chrome and navigate to `chrome://extensions/`\n2. Enable "Developer mode" in the top right\n3. Click "Load unpacked" and select the `dist` folder\n4. The VibeBrowser extension should now appear in your extensions\n\n### 3. Configuration\n1. Click the VibeBrowser extension icon\n2. Configure your LLM provider (Claude, OpenAI, or Ollama)\n3. Set up API keys in the settings panel\n4. Test the connection with a simple task\n\n### 4. Development Setup\n```bash\n# Development build with watch mode\nnpm run build:watch\n\n# Run tests\nnpm test\n\n# Lint code\nnpm run lint\n```',configuration:'# VibeBrowser Configuration\n\n## LLM Provider Setup\n\n### Claude (Anthropic)\n```javascript\n{\n  "provider": "anthropic",\n  "apiKey": "your-claude-api-key",\n  "model": "claude-3-sonnet-20240229"\n}\n```\n\n### OpenAI\n```javascript\n{\n  "provider": "openai",\n  "apiKey": "your-openai-api-key",\n  "model": "gpt-4"\n}\n```\n\n### Ollama (Local)\n```javascript\n{\n  "provider": "ollama",\n  "baseUrl": "http://localhost:11434",\n  "model": "llama2"\n}\n```\n\n## Extension Settings\n- **Auto-submit**: Automatically submit tasks when Enter is pressed\n- **Glow Animation**: Visual feedback during browser interactions\n- **Streaming**: Real-time display of AI thinking process\n- **Tab Management**: Multi-tab operation preferences\n\n## Environment Variables\n```bash\n# For development\nLITELLM_API_KEY=your-api-key\nMOONDREAM_API_KEY=your-vision-api-key\n```',automation:"# VibeBrowser Automation Capabilities\n\n## Core Automation Features\n\n### Navigation\n- Navigate to URLs\n- Handle page loading and redirects\n- Manage browser history\n- Multi-tab operations\n\n### Element Interaction\n- Click elements by description or coordinates\n- Type text into input fields\n- Clear form fields\n- Scroll pages and elements\n- Handle dropdowns and selections\n\n### Data Extraction\n- Extract structured data from pages\n- Capture screenshots\n- Get page text content\n- Extract links and metadata\n- Parse tables and lists\n\n### Visual Recognition\n- Click elements by visual description\n- Type into fields using visual cues\n- Screenshot analysis for element detection\n- Computer vision integration\n\n## Task Planning\n- Automatic task classification (simple vs complex)\n- Multi-step plan generation\n- Iterative re-planning on failures\n- Human-in-the-loop interventions\n\n## Error Handling\n- Automatic retry mechanisms\n- Graceful failure recovery\n- Loop detection and prevention\n- User cancellation support",api:'# VibeBrowser API Reference\n\n## Tool System\n\n### Navigation Tools\n- `navigation_tool`: Navigate to URLs\n- `interact_tool`: Click and interact with elements\n- `scroll_tool`: Scroll pages and elements\n- `search_tool`: Search for text on pages\n- `refresh_browser_state_tool`: Refresh page state\n\n### Planning Tools\n- `classification_tool`: Classify task complexity\n- `planner_tool`: Generate multi-step plans\n- `todo_manager_tool`: Manage task lists\n- `validator_tool`: Validate task completion\n\n### Utility Tools\n- `screenshot_tool`: Capture page screenshots\n- `extract_tool`: Extract structured data\n- `storage_tool`: Browser storage operations\n- `date_tool`: Date calculations\n- `human_input_tool`: Request human intervention\n\n### Tab Management\n- `tab_operations_tool`: Create, close, switch tabs\n- `group_tabs_tool`: Organize tabs into groups\n- `get_selected_tabs_tool`: Get user-selected tabs\n\n## JavaScript API\n```javascript\n// Execute a task\nawait browserOS.execute("Navigate to Google and search for cats")\n\n// Get browser state\nconst state = await browserOS.getBrowserState()\n\n// Take screenshot\nconst screenshot = await browserOS.takeScreenshot()\n```',troubleshooting:"# VibeBrowser Troubleshooting\n\n## Common Issues\n\n### Extension Not Loading\n- Ensure Chrome Developer Mode is enabled\n- Check that the `dist` folder is properly built\n- Reload the extension in chrome://extensions/\n- Check browser console for errors\n\n### API Connection Issues\n- Verify API keys are correctly configured\n- Check network connectivity\n- Ensure provider endpoints are accessible\n- Test with curl or Postman first\n\n### Task Execution Failures\n- Check if the page has loaded completely\n- Verify element selectors are correct\n- Look for JavaScript errors in console\n- Try refreshing the page state\n\n### Performance Issues\n- Limit concurrent tab operations\n- Use simplified browser state when possible\n- Clear browser cache and cookies\n- Restart Chrome if memory usage is high\n\n## Debug Mode\nEnable debug logging:\n```javascript\nlocalStorage.setItem('browserOS.debug', 'true')\n```\n\n## Getting Help\n- Check browser console for error messages\n- Use the screenshot tool to verify page state\n- Enable verbose logging in settings\n- Report issues with detailed reproduction steps",examples:'# VibeBrowser Usage Examples\n\n## Basic Navigation\n```\nNavigate to https://example.com and click the login button\n```\n\n## Form Automation\n```\nFill out the contact form with:\n- Name: John Doe\n- Email: john@example.com\n- Message: Hello from VibeBrowser\nThen submit the form\n```\n\n## Data Extraction\n```\nExtract all product names and prices from this e-commerce page into a structured format\n```\n\n## Multi-Tab Workflow\n```\nOpen 3 tabs:\n1. Google.com - search for "weather"\n2. YouTube.com - search for "tutorials"\n3. GitHub.com - find trending repositories\nThen take screenshots of all tabs\n```\n\n## Complex Automation\n```\n1. Login to the admin panel\n2. Navigate to user management\n3. Export all user data to CSV\n4. Download the file\n5. Verify the download completed\n```\n\n## Visual Element Interaction\n```\nClick the blue "Subscribe" button in the top right corner\nType "test@example.com" into the email signup field\n```\n\n## Error Recovery\n```\nIf you encounter a CAPTCHA or need human verification,\npause and wait for me to complete it manually\n```',features:"# VibeBrowser Features\n\n## AI-Powered Automation\n- **Natural Language Processing**: Understands complex instructions in plain English\n- **Intelligent Planning**: Breaks down complex tasks into manageable steps\n- **Context Awareness**: Maintains conversation history and task context\n- **Adaptive Execution**: Adjusts strategy based on page content and errors\n\n## Browser Integration\n- **Multi-Tab Support**: Seamlessly work across multiple browser tabs\n- **Real-Time State**: Live browser state monitoring and updates\n- **Tab Management**: Create, organize, and manage browser tabs\n- **Session Persistence**: Maintain state across browser sessions\n\n## Visual Recognition\n- **Element Detection**: Find elements using visual descriptions\n- **Screenshot Analysis**: Computer vision for element identification\n- **Coordinate-Based Actions**: Precise clicking and typing by coordinates\n- **Visual Feedback**: Glow animations and crosshairs for user feedback\n\n## Extensibility\n- **Modular Tool System**: Easily add new tools and capabilities\n- **Provider Flexibility**: Support for multiple LLM providers\n- **Custom Agents**: Create specialized agents for specific workflows\n- **API Integration**: Connect with external services and APIs\n\n## User Experience\n- **Streaming Interface**: Real-time display of AI thinking process\n- **Human-in-the-Loop**: Request human intervention when needed\n- **Error Recovery**: Graceful handling of failures and edge cases\n- **Debug Support**: Comprehensive logging and troubleshooting tools\n\n## Performance & Reliability\n- **Loop Detection**: Prevents infinite loops and repetitive actions\n- **Resource Management**: Efficient memory and CPU usage\n- **Abort Controls**: Cancel long-running tasks at any time\n- **State Validation**: Verify task completion and success"}[e];if(!n)return null;if(t){const r=new RegExp(`## ${t}[\\s\\S]*?(?=## |$)`,"i"),s=n.match(r);return s?s[0]:`${n}\n\n*Note: Specific section "${t}" not found. Showing full ${e} information.*`}return n}}function Le(e){const t=new Ne(e);return new N.XW({name:"vibebrowser_info_tool",description:"Get comprehensive information about VibeBrowser features, configuration, and usage.\n\n    Available topics:\n    - overview: General overview and key features\n    - installation: Installation and setup guide\n    - configuration: LLM provider and extension settings\n    - automation: Automation capabilities and features\n    - api: Tool system and JavaScript API reference\n    - troubleshooting: Common issues and solutions\n    - examples: Usage examples and workflows\n    - features: Detailed feature descriptions\n\n    Optionally specify a section within a topic for more focused information.",schema:je,func:async e=>{const n=await t.execute(e);return JSON.stringify(n)}})}const De=o.Ik({date_range:o.k5(["today","yesterday","lastWeek","lastMonth","last30Days","custom"]).describe("Date range to calculate"),dayStart:o.ai().min(0).max(365).optional().describe("For custom range: days back from today for START (e.g., 300 = 300 days ago)"),dayEnd:o.ai().min(0).max(365).optional().describe("For custom range: days back from today for END (e.g., 5 = 5 days ago)"),format:o.k5(["iso","date","us","eu","unix"]).default("date").describe("Output format: iso (ISO-8601), date (YYYY-MM-DD), us (MM/DD/YYYY), eu (DD/MM/YYYY), unix (timestamp)")});class Ue{constructor(e){this.executionContext=e}async execute(e){try{const{date_range:t,dayStart:n,dayEnd:r,format:s="date"}=e,i=new Date;let a,o,c=!1;switch(t){case"today":a=new Date(i),o=new Date(i),c=!0;break;case"yesterday":a=new Date(i),a.setDate(a.getDate()-1),o=new Date(a),c=!0;break;case"lastWeek":a=new Date(i),a.setDate(a.getDate()-7),o=new Date(i);break;case"lastMonth":case"last30Days":a=new Date(i),a.setDate(a.getDate()-30),o=new Date(i);break;case"custom":if(void 0===n||void 0===r)return j("dayStart and dayEnd are required for custom date range");if(n<r)return j("dayStart must be >= dayEnd (dayStart is further back in time)");a=new Date(i),a.setDate(a.getDate()-n),o=new Date(i),o.setDate(o.getDate()-r);break;default:return j(`Unknown date range: ${t}`)}"iso"!==s&&(a.setHours(0,0,0,0),o.setHours(0,0,0,0));const l=this.formatDate(a,s),u=this.formatDate(o,s);return $(c?JSON.stringify({date:l}):JSON.stringify({startDate:l,endDate:u}))}catch(e){return j(`Date calculation failed: ${e instanceof Error?e.message:String(e)}`)}}formatDate(e,t){switch(t){case"iso":return e.toISOString();case"date":return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;case"us":return`${String(e.getMonth()+1).padStart(2,"0")}/${String(e.getDate()).padStart(2,"0")}/${e.getFullYear()}`;case"eu":return`${String(e.getDate()).padStart(2,"0")}/${String(e.getMonth()+1).padStart(2,"0")}/${e.getFullYear()}`;case"unix":return e.getTime();default:return this.formatDate(e,"date")}}}function Fe(e){const t=new Ue(e);return new N.XW({name:"date_tool",description:"Get current date or calculate date ranges for browser automation.\n    Supports ranges: today, yesterday, lastWeek, lastMonth, last30Days, custom.\n    Formats: iso (ISO-8601 with time), date (YYYY-MM-DD), us (MM/DD/YYYY), eu (DD/MM/YYYY), unix (milliseconds).\n    For custom ranges, dayStart is days back for start date, dayEnd is days back for end date.\n    Example: dayStart=7, dayEnd=0 gives last 7 days from a week ago to today.",schema:De,func:async e=>{const n=await t.execute(e);return JSON.stringify(n)}})}class Ye{constructor(){this.activeGlows=new Set,this.navigationListener=null,this._setupNavigationListener()}static getInstance(){return Ye.instance||(Ye.instance=new Ye),Ye.instance}async startGlow(e){try{if(this.activeGlows.has(e))return void t.y7.log("GlowAnimationService",`Glow already active on tab ${e}`);try{await chrome.tabs.get(e)}catch(n){return void t.y7.log("GlowAnimationService",`Tab ${e} not found`,"warning")}await chrome.scripting.executeScript({target:{tabId:e},files:["glow-animation.js"]}),await chrome.tabs.sendMessage(e,{action:"startGlow",source:"GlowAnimationService"}),this.activeGlows.add(e),t.y7.log("GlowAnimationService",`Started glow on tab ${e}`)}catch(n){t.y7.log("GlowAnimationService",`Failed to start glow on tab ${e}: ${n}`,"error")}}async stopGlow(e){try{if(!this.activeGlows.has(e))return;try{await chrome.tabs.sendMessage(e,{action:"stopGlow",source:"GlowAnimationService"})}catch(n){t.y7.log("GlowAnimationService",`Failed to send stop message to tab ${e}: ${n}`,"warning")}this.activeGlows.delete(e),t.y7.log("GlowAnimationService",`Stopped glow on tab ${e}`)}catch(n){t.y7.log("GlowAnimationService",`Failed to stop glow on tab ${e}: ${n}`,"error")}}async stopAllGlows(){const e=Array.from(this.activeGlows);await Promise.all(e.map(e=>this.stopGlow(e)))}isGlowActive(e){return this.activeGlows.has(e)}getAllActiveGlows(){return new Set(this.activeGlows)}handleTabClosed(e){this.activeGlows.has(e)&&(this.activeGlows.delete(e),t.y7.log("GlowAnimationService",`Cleaned up glow for closed tab ${e}`))}_setupNavigationListener(){this.navigationListener=e=>{0===e.frameId&&this.activeGlows.has(e.tabId)&&(t.y7.log("GlowAnimationService",`Navigation detected for tab ${e.tabId} with active glow, re-injecting...`),setTimeout(()=>{this._reinjectGlow(e.tabId)},100))},chrome.webNavigation.onCommitted.addListener(this.navigationListener)}async _reinjectGlow(e){try{if(!this.activeGlows.has(e))return;try{await chrome.tabs.get(e)}catch(t){return void this.activeGlows.delete(e)}await chrome.scripting.executeScript({target:{tabId:e},files:["glow-animation.js"]}),await chrome.tabs.sendMessage(e,{action:"startGlow",source:"GlowAnimationService"}),t.y7.log("GlowAnimationService",`Re-injected glow on tab ${e} after navigation`)}catch(n){t.y7.log("GlowAnimationService",`Failed to re-inject glow on tab ${e}: ${n}`,"warning")}}cleanup(){this.navigationListener&&(chrome.webNavigation.onCommitted.removeListener(this.navigationListener),this.navigationListener=null),this.activeGlows.clear()}}function Ge(e,t,n){return new N.XW({name:e.name,description:e.description,schema:e.schema,func:async r=>{const s=Date.now();try{const i=await e.func(r),a=Date.now()-s;let o=!0;try{o=!1!==JSON.parse(i).ok}catch{}return t.toolMetrics||(t.toolMetrics=new Map),t.toolMetrics.set(n,{toolName:e.name,duration:a,success:o,timestamp:s}),i}catch(r){const i=Date.now()-s;throw t.toolMetrics||(t.toolMetrics=new Map),t.toolMetrics.set(n,{toolName:e.name,duration:i,success:!1,timestamp:s,error:r.message}),r}}})}const Be=o.Ik({userTask:o.Yj().describe("Restate the user's request in your own words for clarity"),executionHistory:o.Yj().describe("Briefly outline what actions have already been attempted, including any failures or notable outcomes"),currentState:o.Yj().describe("Summarize the current browser state, visible elements, and any relevant context from the screenshot"),challengesIdentified:o.Yj().describe("List any obstacles, errors, or uncertainties that may impact progress (e.g., high error rate, missing elements, repeated failures)"),stepByStepReasoning:o.Yj().describe("Think step by step through the problem, considering the user's goal, the current state, what has and hasn't worked, and which tools or strategies are most likely to succeed next. Justify your approach"),proposedActions:o.YO(o.Yj()).max(5).describe("List 1-5 specific, high-level actions for the executor agent to perform next (must be an empty array if `taskComplete=true`. Each action should be clear, actionable, and grounded in your reasoning"),taskComplete:o.zM().describe("Set to true only if the user's request is fully satisfied and no further actions are needed"),finalAnswer:o.Yj().describe("If `taskComplete=true`, provide a complete, direct answer to the user's request (include any relevant data or results). Leave empty otherwise")}),He=o.Ik({userTask:o.Yj().describe("Restate the user's request in your own words for clarity"),executionHistory:o.Yj().describe("Briefly outline what actions have already been attempted, including any failures or notable outcomes"),currentState:o.Yj().describe("Summarize the current browser state, visible elements, and any relevant context from the screenshot"),challengesIdentified:o.Yj().describe("List any obstacles, errors, or uncertainties that may impact progress (e.g., high error rate, missing elements, repeated failures)"),stepByStepReasoning:o.Yj().describe("Think step by step through the problem, considering the user's goal, the current state, what has and hasn't worked, and which tools or strategies are most likely to succeed next. Justify your approach"),todoMarkdown:o.Yj().describe("Updated TODO list with completed items marked [x]"),proposedActions:o.YO(o.Yj()).max(5).describe("List 1-5 specific, high-level actions for the executor agent to perform next (must be an empty array if `allTodosComplete=true`. Each action should be clear, actionable, and grounded in your reasoning"),allTodosComplete:o.zM().describe("Boolean - are all TODOs done?"),finalAnswer:o.Yj().describe("Summary when all TODOs complete (MUST BE EMPTY if not done)")}),ze=o.Ik({summary:o.Yj().describe("Summary of the execution history")});class qe{constructor(e){this.executorLlmWithTools=null,this.iterations=0,this.plannerExecutionHistory=[],this.toolDescriptions="",this.executionContext=e,this.toolManager=new C(e),this.glowService=Ye.getInstance(),t.y7.log("BrowserAgent","Agent instance created","info")}get executorMessageManager(){return this.executionContext.messageManager}get pubsub(){return this.executionContext.getPubSub()}checkIfAborted(){if(this.executionContext.abortSignal.aborted)throw new A}async _initialize(){await this._registerTools();const e=await(0,y.O7)({temperature:.2,maxTokens:4096,intelligence:"low"});if(!e.bindTools||"function"!=typeof e.bindTools)throw new Error("This LLM does not support tool binding");this.executorLlmWithTools=e.bindTools(this.toolManager.getAll()),this.iterations=0,t.y7.log("BrowserAgent",`Initialization complete with ${this.toolManager.getAll().length} tools bound`,"info")}async _registerTools(){this.toolManager.register(D(this.executionContext)),this.toolManager.register(Y(this.executionContext)),this.toolManager.register(B(this.executionContext)),this.toolManager.register(me(this.executionContext)),this.toolManager.register(fe(this.executionContext)),this.toolManager.register(z(this.executionContext)),this.toolManager.register(K(this.executionContext)),this.toolManager.register(V(this.executionContext)),this.toolManager.register(Z(this.executionContext)),this.toolManager.register(Q(this.executionContext)),this.toolManager.register(te(this.executionContext)),this.toolManager.register(re(this.executionContext)),this.toolManager.register(ie(this.executionContext)),this.toolManager.register($e(this.executionContext)),this.toolManager.register(Pe(this.executionContext)),this.toolManager.register(oe(this.executionContext)),this.toolManager.register(le(this.executionContext)),this.toolManager.register(he(this.executionContext)),this.toolManager.register(Fe(this.executionContext)),this.toolManager.register(Le(this.executionContext)),this.toolManager.register(Oe(this.executionContext)),this.executionContext.isLimitedContextMode()&&this.toolManager.register(_e(this.executionContext)),this.toolManager.register(de(this.executionContext)),this.toolDescriptions=function(e=!1){return"Available tools:\n- click: Click on elements on the page\n- type: Type text into input fields\n- clear: Clear text from input fields\n- scroll: Scroll page or to specific elements\n- navigate: Navigate to web pages\n- key: Send keyboard inputs\n- wait: Wait for page loading and stability\n- todo_set: Manage TODO lists\n- todo_get: Retrieve current TODO list\n- tabs: List browser tabs\n- tab_open: Open new browser tabs\n- tab_focus: Switch between tabs\n- tab_close: Close browser tabs\n- extract: Extract data from web pages\n- celebration: Show confetti animation\n- human_input: Request human assistance\n- done: Mark tasks as complete\n- visual_click: Click elements using visual descriptions\n- visual_type: Type into fields using visual descriptions\n- click_at_coordinates: Click at specific locations\n- type_at_coordinates: Type at specific locations\n- date: Get current date and time\n- vibebrowser_info: Get information about the VibeBrowser agent\n- mcp: Access external services (Gmail, GitHub, etc.)"+(e?'\n- grep_elements: Search page elements in browser state with regex patterns (Example ELEMENT FORMAT: [NODE_ID] <C/T> <button> "Submit" class="btn-primary")':"")}(this.executionContext.isLimitedContextMode()),t.y7.log("BrowserAgent",`Registered ${this.toolManager.getAll().length} tools`,"info")}_getSpecialTaskMetadata(e){const t=e.toLowerCase();return"read about our vision and upvote "===t?{task:"Read about our vision and upvote",metadata:{executionMode:"predefined",predefinedPlan:{agentId:"vibebrowser-launch-upvoter",name:"VibeBrowser Launch Upvoter",goal:"Navigate to VibeBrowser launch page and upvote it",steps:["Navigate to https://dub.sh/vibebrowser-launch","Find and click the upvote button on the page using visual_click","Use celebration tool to show confetti animation"]}}}:"support vibebrowser on github "===t?{task:"Support VibeBrowser on GitHub",metadata:{executionMode:"predefined",predefinedPlan:{agentId:"github-star-vibebrowser",name:"GitHub Repository Star",goal:"Navigate to VibeBrowser GitHub repo and star it",steps:["Navigate to https://git.new/browserOS","Check if the star button indicates already starred (filled star icon)","If not starred (outline star icon), click the star button to star the repository","Use celebration_tool to show confetti animation"]}}}:null}async execute(e,n){const r=this._getSpecialTaskMetadata(e);let s=e,i=n;r&&(s=r.task,i={...n,...r.metadata},t.y7.log("BrowserAgent",`Special task detected: ${r.metadata.predefinedPlan?.name}`,"info"));try{this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),startTime:Date.now()}),t.y7.log("BrowserAgent","Starting execution","info"),await this._initialize(),"predefined"===i?.executionMode&&i.predefinedPlan?await this._executePredefined(s,i.predefinedPlan):await this._executeDynamic(s)}catch(e){throw this._handleExecutionError(e),e}finally{this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),endTime:Date.now()}),this._logMetrics(),this._cleanup();try{const e=await this.glowService.getAllActiveGlows();for(const t of e)await this.glowService.stopGlow(t)}catch(e){}}}async _executePredefined(e,n){this.executionContext.setCurrentTask(e);const r=n.steps.map(e=>`- [ ] ${e}`).join("\n");if(this.executionContext.setTodoList(r),!this.executorLlmWithTools)throw new Error("LLM with tools not initialized");this._publishMessage(`Executing agent: ${n.name||"Custom Agent"}`,"thinking");n.goal;let s=!1,i=0;for(;!s&&this.iterations<30;){this.checkIfAborted(),this.iterations++,t.y7.log("BrowserAgent",`Predefined plan iteration ${this.iterations}/30`,"info");const n=await this._runPredefinedPlanner(e,this.executionContext.getTodoList());if(!n.ok){if(t.y7.log("BrowserAgent",`Predefined planning failed: ${n.error}`,"error"),i++,i>=3)throw new Error(`Predefined planning failed: ${n.error}`);continue}const r=n.output;if(r.allTodosComplete){s=!0;const e=r.finalAnswer||"All steps completed successfully";this._publishMessage(e,"assistant");break}if(!r.proposedActions||0===r.proposedActions.length){if(t.y7.log("BrowserAgent","Predefined planner provided no actions but TODOs not complete","warning"),i++,i>=3)throw new Error("Predefined planner provided no actions but TODOs not complete");continue}t.y7.log("BrowserAgent",`Executing ${r.proposedActions.length} actions for current TODO`,"info");if((await this._runExecutor(r.proposedActions,r)).requiresHumanInput){if("abort"===await this._waitForHumanInput())throw this._publishMessage(" Task aborted by human","assistant"),new A("Task aborted by human");this._publishMessage(" Human completed manual action. Continuing...","thinking"),this.executionContext.clearHumanInputState()}}if(!s&&this.iterations>=30)throw this._publishMessage("Predefined plan did not complete within 30 iterations","error"),new Error("Maximum predefined plan iterations (30) reached or planning failed");t.y7.log("BrowserAgent","Predefined plan execution complete","info")}async _executeDynamic(e){if(this.executionContext.setCurrentTask(e),!this.executorLlmWithTools)throw new Error("LLM with tools not initialized");let n=!1,r=0;for(this._publishMessage("Starting task execution...","thinking");!n&&this.iterations<50;){this.checkIfAborted(),this.iterations++,t.y7.log("BrowserAgent",`Planning iteration ${this.iterations}/50`,"info");const s=await this._runDynamicPlanner(e);if(!s.ok){if(t.y7.log("BrowserAgent",`Planning failed: ${s.error}`,"error"),r++,r>=3)throw new Error(`Planning failed: ${s.error}`);continue}const i=s.output;if(this.pubsub.publishMessage(a.Gd.createMessage(i.stepByStepReasoning,"thinking")),i.taskComplete){n=!0;const e=i.finalAnswer||"Task completed successfully";this.pubsub.publishMessage(a.Gd.createMessage(e,"assistant"));break}if(!i.proposedActions||0===i.proposedActions.length){if(t.y7.log("BrowserAgent","Planner provided no actions but task not complete","warning"),r++,r>=3)throw new Error("Planning failed: Planner provided no actions but task not complete");continue}t.y7.log("BrowserAgent",`Executing ${i.proposedActions.length} actions from plan`,"info");if((await this._runExecutor(i.proposedActions,i)).requiresHumanInput){if("abort"===await this._waitForHumanInput())throw this._publishMessage(" Task aborted by human","assistant"),new A("Task aborted by human");this._publishMessage(" Human completed manual action. Re-planning...","thinking"),this.executionContext.clearHumanInputState()}}if(!n&&this.iterations>=50)throw this._publishMessage("Task did not complete within 50 planning iterations","error"),new Error("Maximum planning iterations (50) reached")}async _getBrowserStateMessage(e,t=!0,n="large",r=!0,s=5e4){let i=null;if(r){i=await this.executionContext.browserContext.getBrowserStateString(t);if(u.countMessage(new l.HumanMessage(i))>s){i=await this.executionContext.browserContext.getBrowserStateString(t,!0);const e=u.countMessage(new l.HumanMessage(i));if(e>s){const t=s/e,n=Math.floor(i.length*t);i=i.substring(0,n),i+="\n\n-- IMPORTANT: TRUNCATED DUE TO TOKEN LIMIT, USE GREP ELEMENTS TOOL TO SEARCH FOR ELEMENTS IF NEEDED --\n"}}}if(e&&this.executionContext.supportsVision()){const e=await this.executionContext.browserContext.getCurrentPage(),t=await e.takeScreenshot(n,r);if(t){const e=[];r&&null!==i&&e.push({type:"text",text:`<browser-state>${i}</browser-state>`}),e.push({type:"image_url",image_url:{url:t}});const n=new l.HumanMessage({content:e});return n.additional_kwargs={messageType:h.BROWSER_STATE},n}}if(r&&null!==i){const e=new l.HumanMessage(`<browser-state>${i}</browser-state>`);return e.additional_kwargs={messageType:h.BROWSER_STATE},e}const a=new l.HumanMessage("");return a.additional_kwargs={messageType:h.BROWSER_STATE},a}async _runDynamicPlanner(e){try{this.executionContext.incrementMetric("observations");const n=this.executionContext.getExecutionMetrics(),r=n.toolCalls>0?(n.errors/n.toolCalls*100).toFixed(1):"0",s=Date.now()-n.startTime;let i=this._buildPlannerExecutionHistory();const a=function(e=""){return`# Context\nYour are VibeBrowser Agent which helps the user to automate their tasks in the browser. Your primary responsibility is to analyze the user's query, the full execution history (all previous actions, attempts, and failures), and the current browser state (including screenshot), and then suggest immediate actionable next steps to achieve the user's objective *based on the current browser state and screenshot*.\n\nYou do NOT perform actions yourself. Your role is to propose clear, actionable next steps for the EXECUTOR AGENT, who will execute these actions in the browser, report back with results, errors, and updated observations, including the latest browser state and screenshot. Use this feedback to continually refine your strategy and guide the executor agent toward successful completion of the user's task.\n\n# YOUR ROLE\n\n- Analyze the user's query, past execution history (what has been attempted and what failed) and current browser state (including screenshot) in depth.\n- Based on this analysis, generate a precise, actionable and adaptive plan (1-5 high-level actions) for the executor agent to perform next.\n- After each round of execution, review the history and updated state, and refine your plan and suggest next steps as needed.\n- When the task is fully complete, provide a final answer and set \`taskComplete=true\`. Answer must be grounded based on latest browser state and screenshot.\n\n# STEP BY STEP REASONING\n\n1. **Analysis of User Query, Execution History and Current/Updated Browser State:**\n  1.1 Analyze the focus of the user's query what they want to achieve.\n  1.2 Followed by analysis of user query, analyze the past execution history (what has been attempted and what failed).\n  1.3 Then reflect on the latest browser state and screenshot whether it matches the expected outcome from the execution history. If it does not, update your plan accordingly. Source of truth is the latest browser state and screenshot.\n\n2. **Generation of Plan:**\n  2.1 **Ground plans in reality:** Only propose actions that are possible given the current/updated browser state and screenshot. Do not assume the presence of elements unless they are visible or confirmed. For example, if the user asks to "Add Farmhouse Pepperoni Pizza to the cart" and the add to cart button is visible, propose "Click the add to cart button" rather than "Navigate to the website and then add to cart". If you suggest an action that is not possible given the current/updated browser state and screenshot, you will be penalized. So, suggest only those actions (1-5) that are possible given the current/updated browser state and screenshot.\n  2.2 **Be specific, actionable, and tool-based:** Clearly state what the executor agent should do, using direct and unambiguous instructions grounded in the current/updated browser state (e.g., "Navigate to dominos.com" instead of "Go to a pizza website"). Frame actions in terms of available tools, such as "Click the add to cart button", "Type 'Farmhouse Pepperoni Pizza' into the search bar", or "Use MCP to search Gmail for unread emails". \n  2.3 **High level actions:** Propose high-level actions that are directly executable by the executor agent. For example, "Navigate to dominos.com" instead of "Go to a pizza website". Do not suggest low-level actions like "Click element [123]" or "Type into nodeId 456" [NODE IDS are better determined by the executor agent as its the one who will perform the action]\n  2.4 **Conclude when done:** Mark \`taskComplete=true\` and provide a final answer only when the user's request is fully satisfied and no further actions are needed.\n\n3. **Adaptive Learning:**\n  3.1 Continuously review which actions the executor agent has already tried, and how successful they were. If previous actions did not achieve the desired result, revise your plan and propose new, alternative steps. If you notice repeated failures or a high error rate, switch strategies to increase the chance of success. For example, if a form submission fails, suggest a different way to accomplish the task.\n  3.2 Always base your next plan on the most recent browser state and screenshot. If the current browser state or screenshot does not match the expected outcome from the execution history, update your plan accordingly. Treat the current browser state and screenshot as the definitive source of truth, and ensure all proposed actions are grounded in what is actually visible and available now.\n\n# AVAILABLE BROWSER AUTOMATION TOOLS FOR THE EXECUTOR AGENT\n\n${e}\n\n# MCP SERVICES (PREFERRED FOR GOOGLE/NOTION TASKS) AVAILABLE TO THE EXECUTOR AGENT\n\n- Google Calendar: event management and scheduling\n- Gmail: email search, reading, and sending\n- Google Sheets: spreadsheet reading, writing, and formulas\n- Google Docs: document reading, writing, and formatting\n- Notion: note and database management\n\n**Always prefer MCP for these services over browser automation when possible.**  \nExample: Use "Use MCP to search Gmail for unread emails" instead of "Navigate to gmail.com".\n\n# EXAMPLES OF EFFECTIVE (GOOD) ACTIONS\n\n- Use VibeBrowser info tool to retrieve agent details\n- Use MCP to search Gmail for unread emails\n- Use MCP to get today's Google Calendar events\n- Use MCP to read data from a specific Google Sheet\n- Navigate to "https://example.com/login"\n- Fill the email field with "user@example.com"\n- Click the submit button\n- Use visual click on the blue submit button (if standard click has failed previously)\n- Click the Close icon in the popup modal\n- Type "Farmhouse Pepperoni Pizza" into the search bar (if the search bar is visible in screenshot)\n- Use MCP to create a new event in Google Calendar\n\n# EXAMPLES OF INEFFECTIVE (BAD) ACTIONS\n\n- Click element [123] (do not reference node IDs directly; executor agent determines this)\n- Type into nodeId 456 (do not reference node IDs directly; executor agent determines this)\n- Add Farmhouse Pepperoni Pizza to the cart when the button is hidden in the screenshot (instead, scroll down, check updated screenshot and then propose the action)\n- Navigate to a generic site (e.g., "Go to a pizza website") without specifying the actual URL\n\n# OUTPUT FORMAT\nYour output must follow this structured, step-by-step format to demonstrate clear chain-of-thought (CoT) reasoning before proposing actions:\n\n1. **userTask:** Restate the user's request in your own words for clarity.\n2. **executionHistory:** Briefly outline what steps have already been tried, including any failures or notable outcomes.\n3. **latestBrowserState:** Summarize the latest browser state, visible elements, and any relevant context from the screenshot.\n5. **stepByStepReasoning:** Think step by step through the problem, considering the user's goal, past execution steps (what has been attempted) and reflect on the latest browser state and screenshot whether it is successful or not. What should be done next. Justify your approach. Actions must be grounded in the latest browser state and screenshot.\n6. **proposedActions:** List 1-5 specific, high-level actions for the executor agent to perform next (must be an empty array if \`taskComplete=true\`. Each action should be clear, actionable, and grounded in your reasoning based on the latest browser state and screenshot.\n7. **taskComplete:** true/false  Set to true only if the user's request is fully satisfied and no further actions are needed.\n8. **finalAnswer:** If \`taskComplete=true\`, provide a complete, direct answer to the user's request (include any relevant data or results). Leave empty otherwise. Answer must be grounded in latest browser state and screenshot.\n\nRemember: You are the planner agent for VibeBrowser Agent. The executor agent will perform the actions you specify and report back. Use their feedback to adapt your plan until the task is complete.\n`}(this.toolDescriptions||""),o=u.countMessage(new l.tn(a)),c=u.countMessage(new l.HumanMessage(i));if(t.y7.log("BrowserAgent",`Full execution history tokens: ${c}`,"info"),c+o>.7*this.executionContext.getMaxTokens()){const e=await this.summarizeExecutionHistory(i);i=e.summary,this.plannerExecutionHistory=[],this.plannerExecutionHistory.push({plannerOutput:e,toolMessages:[],plannerIterations:this.iterations-1})}t.y7.log("BrowserAgent",`Full execution history: ${i}`,"info");const d=(await(0,y.O7)({temperature:.2,maxTokens:4096,intelligence:"high"})).withStructuredOutput(Be),h=`EXECUTION CONTEXT\n ${this.executionContext.isLimitedContextMode()?this._buildExecutionContext():""}`,p=`TASK: ${e}\n\nEXECUTION METRICS:\n- Tool calls: ${n.toolCalls} (${n.errors} errors, ${r}% failure rate)\n- Observations taken: ${n.observations}\n- Time elapsed: ${(s/1e3).toFixed(1)} seconds\n${parseInt(r)>30&&n.errors>3?" HIGH ERROR RATE - Current approach may be failing. Learn from the past execution history and adapt your approach":""}\n\n${h}\n\nYOUR PREVIOUS STEPS DONE SO FAR (what you thought would work):\n${i}\n`,m=u.countMessage(new l.HumanMessage(p)),g=await this._getBrowserStateMessage(this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),!0,"large",!0,.8*(this.executionContext.getMaxTokens()-o-m)),f=[new l.tn(a),new l.HumanMessage(p),g],_=await(0,R.D)(d,f,3,{signal:this.executionContext.abortSignal}),b={userTask:_.userTask,currentState:_.currentState,executionHistory:_.executionHistory,challengesIdentified:_.challengesIdentified,stepByStepReasoning:_.stepByStepReasoning,proposedActions:_.proposedActions,taskComplete:_.taskComplete,finalAnswer:_.finalAnswer};return this.executionContext.addReasoning(JSON.stringify(b)),t.y7.log("BrowserAgent",_.taskComplete?"Planner: Task complete with final answer":`Planner: ${_.proposedActions.length} actions planned`,"info"),{ok:!0,output:_}}catch(e){return this.executionContext.incrementMetric("errors"),{ok:!1,error:`Planning failed: ${e instanceof Error?e.message:String(e)}`}}}async _runExecutor(e,n){const r=new f,s=`You are an autonomous Browser Automation EXECUTOR AGENT for VibeBrowser Agent which helps the user to automate their tasks in the browser.\n<executor-mode>\nYou are now operating in EXECUTION MODE. You will be provided with:\n- A brief summary of what has been done so far, including the analysis of the user task, current state, execution history, challenges, and reasoning.\n- A list of actions to perform to complete the user task.\n- The current browser state, including a screenshot for visual reference.\n\nYour primary responsibility is to interpret each action and translate it into the correct tool calls, executing them within the browser environment.\n\n# STEP BY STEP EXECUTION PROCESS\n\n1. **Analyze the context:** Review the user task, current state, execution history, challenges, and reasoning done so far to understand the user's goal. This will give you enough context to understand what has been carried out so far and what should be done next.\n2. **Use the browser state and screenshot:** Always check the browser state (including screenshot) before selecting elements or nodeIds for tool calls. Example: To click a button, look for its nodeId in the browser state before using click(nodeId).\n3. **Map actions to tools:** For each action, select the most appropriate tool(s) to accomplish it. Example: "Fill email field"  type(nodeId, "user@example.com")  \n4. **Follow action order:** Execute all actions in the EXACT order provided, unless actions are clearly independent. Example: Do not click "submit" until all form fields are filled.\n5. **Batch independent actions:** If actions are independent (e.g., filling multiple fields), batch tool calls in a single response to improve efficiency. Example: Fill "email" and "password" fields together before clicking "submit" in next response.\n6. **Sequence dependent actions:** If an action requires multiple steps or tools, use them in the correct sequence. Example: Scroll to element, then click it.\n7. **Adapt on failure:** If an action fails, immediately try alternative strategies or fallback tools (such as visual_click, visual_type, etc.). Example: If click(nodeId) fails, retry with visual_click("blue submit button at bottom of form") in next response.\n8. **Complete all actions:** Do not stop until every action in the list is completed.\n\n*Example:* For example, you got actions such as ["Fill email field with user@example.com", "Fill password field with Secret123", "Click login button"]. You should do the following:\n- Understand the browser state and screenshot to identify the nodeIds of the elements.\n- Fill "email" and "password" fields (can be done in a single response if possible)\n- Click "login" button.\n- If click fails, try with alternative tool calls such as visual_click("blue submit button at bottom of form") in next response.\n- Complete all actions in the list.\n\n# ACTION MAPPING GUIDE:\n- "Navigate to [url]"  use navigate(url) tool\n- "Click [element description]"  LOOK at screenshot, find element's nodeId label, use click(nodeId)\n   If click fails or nodeId unclear  use visual_click("element description")\n- "Fill [field] with [value]"  LOOK at screenshot, find field's nodeId label, use type(nodeId, text)\n   If type fails or field not found  use visual_type("field description", text)\n- "Clear [field]"  LOOK at screenshot, find field's nodeId label, use clear(nodeId)\n- "Wait for [condition]"  use wait(seconds)\n- "Scroll to [element]"  LOOK at screenshot, find element's nodeId label, use scroll(nodeId)\n- "Press [key]"  use key(key)\n- "Extract [data]"  use extract(format, task)\n- "Submit form"  LOOK at screenshot, find submit button's nodeId label, click(nodeId)\n   If click fails  use visual_click("submit button description")\n\nCRITICAL OUTPUT RULES - NEVER VIOLATE THESE:\n1. **NEVER** output or echo content from <browser-state> tags - this is for YOUR reference only\n2. **NEVER** output or echo <system-reminder> tags or their contents\nBrowser state and system reminders are INTERNAL ONLY - treat them as invisible to the user. These should not be visible to the user.\n\nThe browser state appears in <browser-state> tags for your internal reference to understand the page.\nSystem reminders appear in <system-reminder> tags for your internal guidance.\n</executor-mode>\n\n${this._buildExecutionContext()}\n\n<element-identification>\nText-based element format (supplementary to screenshot):\n[nodeId] <C/T> <tag> "text" (visible/hidden)\n- <C> = Clickable, <T> = Typeable\n- (visible) = in viewport, (hidden) = requires scrolling\n- This text helps confirm what you see in the screenshot\nREMEMBER: The nodeId numbers in [brackets] here match the visual labels on the screenshot\n</element-identification>\n\n<fallback-strategies>\nCLICK ESCALATION STRATEGY:\n1. First attempt: Use click(nodeId) with element from screenshot\n2. If "Element not found" or "Click failed": Use visual_click with descriptive text\n3. Visual descriptions should include:\n   - Color/appearance: "blue button", "red link"\n   - Position: "top right corner", "below the header"\n   - Text content: "containing 'Submit'", "labeled 'Search'"\n   - Context: "in the login form", "next to the logo"\n   This will help to understand the element and its context. So, use this information to describe the element.\n\nWHEN TO USE VISUAL FALLBACK:\n- Error: "Element [nodeId] not found"  Immediate visual_click\n- Error: "Failed to click"  Retry with visual_click\n- Situation: NodeId unclear in screenshot  Use visual_click directly\n- Situation: Dynamic/popup elements  Prefer visual_click\n- After 2 failed regular clicks  Switch to visual approach\nFirst try to use click(nodeId) with element from screenshot. If it fails, use visual_click with descriptive text. Same for type(nodeId, text), If it fails, use visual_type with descriptive text.\n\nVISUAL DESCRIPTION BEST PRACTICES:\n "blue submit button at bottom of form" \n "search icon in top navigation bar"\n "first checkbox in the list"\n "X close button in modal corner"\n "element-123" (too technical)\n "button" (too vague)\n</fallback-strategies>\n\n<tools>\nExecution Tools:\n- click(nodeId): Click element by nodeId\n- type(nodeId, text): Type text into element\n- clear(nodeId): Clear text from element\n- scroll(nodeId?): Scroll to element OR scroll(direction, amount) for page scrolling\n- navigate(url): Navigate to URL (include https://)\n- key(key): Press keyboard key (Enter, Tab, Escape, etc.)\n- wait(seconds?): Wait for page to stabilize\n\nVisual Fallback Tools (use when DOM-based tools fail):\n- visual_click(instruction): Click element by visual description\n  Example: visual_click("blue submit button")\n- visual_type(instruction, text): Type into field by visual description\n  Example: visual_type("email input field", "user@example.com")\n\nTab Control:\n- tabs: List all browser tabs\n- tab_open(url?): Open new tab\n- tab_focus(tabId): Switch to specific tab\n- tab_close(tabId): Close tab\n\nData Operations:\n- extract(format, task): Extract structured data matching JSON schema\n\nMCP Integration:\n- mcp(action, instanceId?, toolName?, toolArgs?): Access external services (Gmail, GitHub, etc.)\n   ALWAYS follow 3-step process: getUserInstances  listTools  callTool\n   Use exact IDs and tool names from responses\n\nCompletion:\n- done(success, message): Call when ALL actions are executed successfully\n</tools>\n\n<mcp-instructions>\nMCP TOOL USAGE (for Gmail, GitHub, Slack, etc.):\nCRITICAL: Never skip steps or guess tool names. Always execute in exact order:\n\nStep 1: Get installed servers\nmcp(action: 'getUserInstances')\n Returns: {instances: [{id: 'a146...', name: 'Gmail', authenticated: true}]}\n SAVE the exact instance ID\n\nStep 2: List available tools (MANDATORY - NEVER SKIP)\nmcp(action: 'listTools', instanceId: 'exact-id-from-step-1')\n Returns: {tools: [{name: 'gmail_search_emails', description: '...'}]}\n USE exact tool names from this response\n\nStep 3: Call the tool\nmcp(action: 'callTool', instanceId: 'exact-id', toolName: 'exact-name', toolArgs: {key: value})\n toolArgs must be JSON object, not string\n\nCommon Mistakes to Avoid:\n Guessing tool names like 'gmail_list_messages'\n Skipping listTools step\n Using partial instance IDs\n Always use exact values from previous responses\n\nAvailable MCP Servers:\n- Google Calendar: Calendar operations (events, scheduling)\n- Gmail: Email operations (search, read, send)\n- Google Sheets: Spreadsheet operations (read, write, formulas)\n- Google Docs: Document operations (read, write, format)\n- Notion: Note management (pages, databases)\n\nUse MCP when task involves these services instead of browser automation.\n</mcp-instructions>`;const i=u.countMessage(new l.tn(s));r.addSystem(s);const a=[];let o=0,c=!0;for(;o<5;){if(this.checkIfAborted(),o++,c){const e=this._formatPlannerOutputForExecutor(n),t=this._buildExecutionContext(),s=u.countMessage(new l.HumanMessage(t+"\n"+e)),a=await this._getBrowserStateMessage(this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),!0,"medium",!0,.8*(this.executionContext.getMaxTokens()-i-s));r.add(a),r.addSystemReminder(t+'\n I will never output <browser-state> or <system-reminder> tags or their contents. These are for my internal reference only. I will provide what tools to be executed based on provided actions in sequence until I call "done" tool.'),r.addHuman(`${e}\nPlease execute the actions specified above.`),c=!1}else r.addHuman("Please verify if all actions are completed and call 'done' tool if all actions are completed.");const e=await this._invokeLLMWithStreaming(r);if(!(e.tool_calls&&e.tool_calls.length>0))break;{r.add(e);const t=await this._processToolCalls(e.tool_calls,r,a);for(const t of e.tool_calls)this.executionContext.incrementMetric("toolCalls"),this.executionContext.incrementToolUsageMetrics(t.name);if(t.doneToolCalled){this.plannerExecutionHistory.push({plannerOutput:n,toolMessages:a,plannerIterations:this.iterations});for(const e of r.getMessages())this.executorMessageManager.add(e);return{completed:!0,doneToolCalled:!0}}if(t.requiresHumanInput){this.plannerExecutionHistory.push({plannerOutput:n,toolMessages:a,plannerIterations:this.iterations});for(const e of r.getMessages())this.executorMessageManager.add(e);return{completed:!1,requiresHumanInput:!0}}}}for(const e of r.getMessages())this.executorMessageManager.add(e);return t.y7.log("BrowserAgent","Executor hit max iterations (5)","warning"),this.plannerExecutionHistory.push({plannerOutput:n,toolMessages:a,plannerIterations:this.iterations}),{completed:!1}}async _invokeLLMWithStreaming(e){const n=e||this.executorMessageManager;if(!this.executorLlmWithTools)throw new Error("LLM not initialized - ensure _initialize() was called");const r=["<browser-state>","<system-reminder>","</browser-state>","</system-reminder>"],s=n.getMessages(),i=await this.executorLlmWithTools.stream(s,{signal:this.executionContext.abortSignal});let o,c="",u=!1,d=null,h=!1;for await(const e of i){if(this.checkIfAborted(),e.content&&"string"==typeof e.content){if(c+=e.content,!h){r.find(e=>c.includes(e))&&(h=!0,d&&this.pubsub.publishMessage(a.Gd.createMessageWithId(d,"Processing...","thinking")),n.queueSystemReminder("I will never output <browser-state> or <system-reminder> tags or their contents. These are for my internal reference only. If I have completed all actions, I will complete the task and call 'done' tool."),t.y7.log("BrowserAgent","LLM output contained prohibited tags, streaming stopped","warning"),this.executionContext.incrementMetric("errors"))}h||(u||(u=!0,d=a.Gd.generateId("msg_assistant")),d&&this.pubsub.publishMessage(a.Gd.createMessageWithId(d,c,"thinking")))}o=o?o.concat(e):e}return u&&!h&&c.trim()&&d&&this.pubsub.publishMessage(a.Gd.createMessageWithId(d,c,"thinking")),o?new l.Od({content:o.content,tool_calls:o.tool_calls}):new l.Od({content:""})}async _processToolCalls(e,n,s){const i={doneToolCalled:!1,requirePlanningCalled:!1,requiresHumanInput:!1};for(const a of e){this.checkIfAborted();const{name:e,args:o,id:c}=a;this._emitDevModeDebug(`Calling tool ${e} with args`,JSON.stringify(o)),await this._maybeStartGlowAnimation(e);const l=this.toolManager.get(e);let u;if(l)try{let e=l.func;if(r.kF){e=Ge(l,this.executionContext,c).func}u=await e(o)}catch(n){const r=`Tool execution failed: ${n instanceof Error?n.message:String(n)}`;u=JSON.stringify({ok:!1,error:r}),this.executionContext.incrementMetric("errors"),t.y7.log("BrowserAgent",`Tool ${e} execution failed: ${n}`,"error"),this._emitDevModeDebug(`Error executing ${e}`,r)}else{t.y7.log("BrowserAgent",`Unknown tool: ${e}`,"warning");const n=`Unknown tool: ${e}`;u=JSON.stringify({ok:!1,error:n}),this._emitDevModeDebug("Error",n)}const d=M(u);n.addTool(u,c),s.push(`Tool: ${e} - Result: ${u}`),"done"===e&&d.ok&&(i.doneToolCalled=!0),"human_input"===e&&d.ok&&d.requiresHumanInput&&(i.requiresHumanInput=!0)}return n.flushQueue(),i}_publishMessage(e,t){this.pubsub.publishMessage(a.Gd.createMessage(e,t))}_emitDevModeDebug(e,t,n=60){if((0,r.D5)()){let r=e;if(t){r=`${e}: ${t.length>n?t.substring(0,n)+"...":t}`}this.pubsub.publishMessage(a.Gd.createMessage(`[DEV MODE] ${r}`,"thinking"))}}_handleExecutionError(e){if(e instanceof A)return void t.y7.log("BrowserAgent","Execution aborted by user","info");const n=e instanceof Error?e.message:String(e);t.y7.log("BrowserAgent",`Execution error: ${n}`,"error"),this._publishMessage(`Error: ${n}`,"error")}_logMetrics(){const e=this.executionContext.getExecutionMetrics(),n=e.endTime-e.startTime,r=e.toolCalls>0?((e.toolCalls-e.errors)/e.toolCalls*100).toFixed(1):"0",s={};e.toolFrequency.forEach((e,t)=>{s[t]=e}),t.y7.log("BrowserAgent",`Execution complete: ${this.iterations} iterations, ${e.toolCalls} tool calls, ${e.observations} observations, ${e.errors} errors, ${r}% success rate, ${n}ms duration`,"info"),e.toolCalls>0&&t.y7.log("BrowserAgent",`Tool frequency: ${JSON.stringify(s)}`,"info"),t.y7.logMetric("newagent.execution",{iterations:this.iterations,toolCalls:e.toolCalls,observations:e.observations,errors:e.errors,duration:n,successRate:parseFloat(r),toolFrequency:s})}_cleanup(){this.iterations=0,this.plannerExecutionHistory=[],t.y7.log("BrowserAgent","Cleanup complete","info")}async _maybeStartGlowAnimation(e){if(!qe.GLOW_ENABLED_TOOLS.has(e))return!1;try{const e=(await this.executionContext.browserContext.getCurrentPage()).tabId;return!(!e||this.glowService.isGlowActive(e))&&(await this.glowService.startGlow(e),!0)}catch(e){return!1}}async _waitForHumanInput(){const e=Date.now(),t=this.executionContext.getHumanInputRequestId();if(!t)return"abort";const n=this.pubsub.subscribe(e=>{if("human-input-response"===e.type){const n=e.payload;n.requestId===t&&this.executionContext.setHumanInputResponse(n)}});try{for(;!this.executionContext.shouldAbort();){const t=this.executionContext.getHumanInputResponse();if(t)return t.action;if(Date.now()-e>6e5)return this._publishMessage(" Human input timed out after 10 minutes","error"),"timeout";await new Promise(e=>setTimeout(e,500))}return"abort"}finally{n.unsubscribe()}}async _runPredefinedPlanner(e,n){try{this.executionContext.incrementMetric("observations");const e=this.executionContext.getExecutionMetrics(),r=e.toolCalls>0?(e.errors/e.toolCalls*100).toFixed(1):"0",s=Date.now()-e.startTime;let i=this._buildPlannerExecutionHistory();const o=function(e=""){return`# Context\nYour are VibeBrowser Agent which helps the user to automate their tasks in the browser. Your primary responsibility is to work through a predefined TODO list systematically, analyze the user's query, the full execution history (all previous actions, attempts, and failures), and the current browser state (including screenshot), and then suggest immediate actionable next steps to complete the current TODO item *based on the current browser state and screenshot*.\n\nYou do NOT perform actions yourself. Your role is to manage the TODO list, analyze execution history, learn from failures, and propose clear, actionable next steps for the EXECUTOR AGENT, who will execute these actions in the browser, report back with results, errors, and updated observations, including the latest browser state and screenshot. Use this feedback to continually refine your strategy and guide the executor agent toward successful completion of each TODO item.\n\n# YOUR ROLE\n\n- Analyze the user's query, past execution history (what has been attempted and what failed), current TODO list status, and current browser state (including screenshot) in depth.\n- Based on this analysis, generate a precise, actionable and adaptive plan (1-5 high-level actions) for the executor agent to perform next to complete the current TODO item.\n- After each round of execution, review the history and updated state, update the TODO list progress, and refine your plan and suggest next steps as needed.\n- When all TODO items are complete, provide a final answer and set \`allTodosComplete=true\`. Answer must be grounded based on latest browser state and screenshot.\n\n# STEP BY STEP REASONING\n\n1. **Analysis of User Query, Execution History, TODO Progress and Current/Updated Browser State:**\n  1.1 Analyze the focus of the user's query and the current TODO list to understand what they want to achieve.\n  1.2 Followed by analysis of user query, analyze the past execution history (what has been attempted and what failed) and current TODO progress.\n  1.3 Then reflect on the latest browser state and screenshot whether it matches the expected outcome from the execution history. If it does not, update your plan accordingly. Source of truth is the latest browser state and screenshot.\n\n2. **TODO Management and Plan Generation:**\n  2.1 **Update TODO progress:** Mark completed items with [x], failed items with [!], and focus on the NEXT uncompleted TODO item. Only mark as complete when browser state confirms success.\n  2.2 **Ground plans in reality:** Only propose actions that are possible given the current/updated browser state and screenshot. Do not assume the presence of elements unless they are visible or confirmed. For example, if the current TODO is "Click login button" and the login button is visible, propose "Click the login button" rather than "Navigate to login page first". If you suggest an action that is not possible given the current/updated browser state and screenshot, you will be penalized.\n  2.3 **Be specific, actionable, and tool-based:** Clearly state what the executor agent should do, using direct and unambiguous instructions grounded in the current/updated browser state (e.g., "Navigate to dominos.com" instead of "Go to a pizza website"). Frame actions in terms of available tools, such as "Click the add to cart button", "Type 'Farmhouse Pepperoni Pizza' into the search bar", or "Use MCP to search Gmail for unread emails".\n  2.4 **High level actions:** Propose high-level actions that are directly executable by the executor agent. For example, "Navigate to dominos.com" instead of "Go to a pizza website". Do not suggest low-level actions like "Click element [123]" or "Type into nodeId 456" [NODE IDS are better determined by the executor agent as its the one who will perform the action]\n  2.5 **Conclude when done:** Mark \`allTodosComplete=true\` and provide a final answer only when all TODO items are completed and no further actions are needed.\n\n3. **Adaptive Learning and Execution Analysis:**\n  3.1 **FORENSICALLY ANALYZE** execution metrics and full message history. Check error rate - if > 30%, current approach is failing.\n  3.2 Continuously review which actions the executor agent has already tried, and how successful they were. If previous actions did not achieve the desired result, revise your plan and propose new, alternative steps. If you notice repeated failures or a high error rate, switch strategies to increase the chance of success.\n  3.3 Always base your next plan on the most recent browser state and screenshot. If the current browser state or screenshot does not match the expected outcome from the execution history, update your plan accordingly. Treat the current browser state and screenshot as the definitive source of truth, and ensure all proposed actions are grounded in what is actually visible and available now.\n\n# EXECUTION ANALYSIS PATTERNS\n\n**METRIC PATTERNS TO DETECT:**\n- Error rate > 30%: Current approach failing, need different strategy\n- toolCalls > 10 with high errors: Stuck in loop, break the pattern\n- Same tool failing repeatedly: Element likely doesn't exist\n   Pattern: click failures > 2  Suggest "Use visual click to find [element description]"\n- Click/Type errors with "not found": DOM identification failing  switch to visual approach\n\n**VISUAL FALLBACK TRIGGERS:**\n- After 2 failed clicks on same element  "Use visual click on [describe element visually]"\n- DOM elements not visible in screenshot  "Try visual click to find [description]"\n- Dynamic/popup elements  Direct to visual: "Click the modal close button using visual identification"\n- Unclear nodeIds  "Click the [visual description] button"\n\n# AVAILABLE BROWSER AUTOMATION TOOLS FOR THE EXECUTOR AGENT\n\n${e}\n\n# MCP SERVICES (PREFERRED FOR GOOGLE/NOTION TASKS) AVAILABLE TO THE EXECUTOR AGENT\n\n- Google Calendar: event management and scheduling\n- Gmail: email search, reading, and sending\n- Google Sheets: spreadsheet reading, writing, and formulas\n- Google Docs: document reading, writing, and formatting\n- Notion: note and database management\n\n**Always prefer MCP for these services over browser automation when possible.**\nExample: Use "Use MCP to search Gmail for unread emails" instead of "Navigate to gmail.com".\n\n# EXAMPLES OF EFFECTIVE (GOOD) ACTIONS\n\n- Use VibeBrowser info tool to retrieve agent details\n- Use MCP to search Gmail for unread emails\n- Use MCP to get today's Google Calendar events\n- Use MCP to read data from a specific Google Sheet\n- Navigate to "https://example.com/login"\n- Fill the email field with "user@example.com"\n- Click the submit button\n- Use visual click on the blue submit button (if standard click has failed previously)\n- Click the Close icon in the popup modal\n- Type "Farmhouse Pepperoni Pizza" into the search bar (if the search bar is visible in screenshot)\n- Use MCP to create a new event in Google Calendar\n\n# EXAMPLES OF INEFFECTIVE (BAD) ACTIONS\n\n- Click element [123] (do not reference node IDs directly; executor agent determines this)\n- Type into nodeId 456 (do not reference node IDs directly; executor agent determines this)\n- Add Farmhouse Pepperoni Pizza to the cart when the button is hidden in the screenshot (instead, scroll down, check updated screenshot and then propose the action)\n- Navigate to a generic site (e.g., "Go to a pizza website") without specifying the actual URL\n\n# TODO MANAGEMENT RULES\n\n- Work on ONE TODO at a time (the first uncompleted one)\n- Mark a TODO complete ONLY when browser state confirms it's done\n- A TODO may require multiple actions or multiple attempts\n- If a TODO fails after 3 attempts, mark it with [!] and move on\n- Update format: "- [ ] Pending", "- [x] Complete", "- [!] Failed"\n\n# OUTPUT FORMAT\nYour output must follow this structured, step-by-step format to demonstrate clear chain-of-thought (CoT) reasoning before proposing actions:\n\n1. **userTask:** Restate the user's request in your own words for clarity.\n2. **executionHistory:** Briefly outline what steps have already been tried, including any failures or notable outcomes.\n3. **latestBrowserState:** Summarize the latest browser state, visible elements, and any relevant context from the screenshot.\n4. **challengesIdentified:** List any obstacles, errors, or uncertainties that may impact progress (e.g., high error rate, missing elements, repeated failures).\n5. **stepByStepReasoning:** Think step by step through the problem, considering the user's goal, past execution steps (what has been attempted), current TODO progress, and reflect on the latest browser state and screenshot whether it is successful or not. What should be done next. Justify your approach. Actions must be grounded in the latest browser state and screenshot.\n6. **todoMarkdown:** Updated TODO list with completed items marked [x], failed items marked [!], and current focus clearly identified.\n7. **proposedActions:** List 1-5 specific, high-level actions for the executor agent to perform next to complete the current TODO item (must be an empty array if \`allTodosComplete=true\`. Each action should be clear, actionable, and grounded in your reasoning based on the latest browser state and screenshot.\n8. **allTodosComplete:** true/false  Set to true only if all TODO items are completed ([x] or [!]) and no further actions are needed.\n9. **finalAnswer:** If \`allTodosComplete=true\`, provide a complete, direct answer to the user's request (include any relevant data or results and summary of TODO completion status). Leave empty otherwise. Answer must be grounded in latest browser state and screenshot.\n\nRemember: You are the predefined plan executor for VibeBrowser Agent. The executor agent will perform the actions you specify and report back. Use their feedback to adapt your plan and update TODO progress until all items are complete.`}(this.toolDescriptions||""),c=u.countMessage(new l.tn(o)),d=u.countMessage(new l.HumanMessage(i));if(t.y7.log("BrowserAgent",`Full execution history tokens: ${d}`,"info"),d+c>.7*this.executionContext.getMaxTokens()){const e=await this.summarizeExecutionHistory(i);this.plannerExecutionHistory=[],this.plannerExecutionHistory.push({plannerOutput:e,toolMessages:[],plannerIterations:this.iterations-1}),i=e.summary}const h=(await(0,y.O7)({temperature:.2,maxTokens:4096,intelligence:"high"})).withStructuredOutput(He),p=`EXECUTION CONTEXT\n ${this.executionContext.isLimitedContextMode()?this._buildExecutionContext():""}`,m=`Current TODO List:\n${n}\n\nEXECUTION METRICS:\n- Tool calls: ${e.toolCalls} (${e.errors} errors, ${r}% failure rate)\n- Observations taken: ${e.observations}\n- Time elapsed: ${(s/1e3).toFixed(1)} seconds\n${parseInt(r)>30&&e.errors>3?" HIGH ERROR RATE - Current approach may be failing. Learn from the past execution history and adapt your approach":""}\n\n${p}\n\nYOUR PREVIOUS STEPS DONE SO FAR (what you thought would work):\n${i}\n`,g=u.countMessage(new l.HumanMessage(m)),f=await this._getBrowserStateMessage(this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),!0,"large",!0,.8*(this.executionContext.getMaxTokens()-c-g)),_=[new l.tn(o),new l.HumanMessage(m),f],b=await(0,R.D)(h,_,3,{signal:this.executionContext.abortSignal}),w={userTask:b.userTask,executionHistory:b.executionHistory,currentState:b.currentState,challengesIdentified:b.challengesIdentified,stepByStepReasoning:b.stepByStepReasoning,todoMarkdown:b.todoMarkdown,proposedActions:b.proposedActions,allTodosComplete:b.allTodosComplete,finalAnswer:b.finalAnswer};return this.executionContext.addReasoning(JSON.stringify(w)),this._publishMessage(b.todoMarkdown,"thinking"),this.executionContext.setTodoList(b.todoMarkdown),this.pubsub.publishMessage(a.Gd.createMessage(b.stepByStepReasoning,"thinking")),t.y7.log("BrowserAgent",b.allTodosComplete?"Predefined Planner: All TODOs complete with final answer":`Predefined Planner: ${b.proposedActions.length} actions planned for current TODO`,"info"),{ok:!0,output:b}}catch(e){return this.executionContext.incrementMetric("errors"),{ok:!1,error:`Predefined planning failed: ${e instanceof Error?e.message:String(e)}`}}}_buildPlannerExecutionHistory(){return 0===this.plannerExecutionHistory.length?"No execution history yet":this.plannerExecutionHistory.map((e,t)=>{let n="";if("summary"in e.plannerOutput){const t=e.plannerOutput;return`=== ITERATIONS 1-${e.plannerIterations} SUMMARY ===\n${t.summary}`}if("todoMarkdown"in e.plannerOutput){const t=e.plannerOutput;n=`PLANNER OUTPUT:\n- User Task: ${t.userTask}\n- Execution History: ${t.executionHistory}\n- Current State: ${t.currentState}\n- Challenges Identified: ${t.challengesIdentified}\n- Reasoning: ${t.stepByStepReasoning}\n- TODO Markdown: ${t.todoMarkdown}\n- Proposed Actions: ${t.proposedActions.join(", ")}`}else{const t=e.plannerOutput;n=`PLANNER OUTPUT:\n- Task: ${t.userTask}\n- Current State: ${t.currentState}\n- Execution History: ${t.executionHistory}\n- Challenges Identified: ${t.challengesIdentified}\n- Reasoning: ${t.stepByStepReasoning}\n- Proposed Actions: ${t.proposedActions.join(", ")}`}const r=e.toolMessages.length>0?`TOOL EXECUTIONS:\n${e.toolMessages.join("\n")}`:"No tool executions";return`=== ITERATION ${e.plannerIterations} ===\n${n}\n\n${r}`}).join("\n\n")}async summarizeExecutionHistory(e){const t=e.split("\n").filter(e=>!/^[-*]\s*Reasoning[:]?/i.test(e.trim())&&!/^[-*]\s*TODO Markdown[:]?/i.test(e.trim())&&!/^[-*]\s*Proposed Actions[:]?/i.test(e.trim())).join("\n"),n=(await(0,y.O7)({temperature:.2,maxTokens:4096,intelligence:"high"})).withStructuredOutput(ze),r=`Execution History: ${t}`,s=[new l.tn("You are an expert summarizer. Your job is to review the execution history of a task and concisely summarize what actions have been attempted, what succeeded, and what failed.\n\nYou will be given:\n- The full execution history of a task, including multiple iterations.\n\n# Example Input:\n\nIteration 1:\n- User Task: <>\n- Execution History: <>\n- Current Browser State: <>\n- Reasoning: <>\n- Tool Calls: <>\n\nIteration 2:\n<>\nIteration 3:\n<>\nIteration 4:\n<>\nIteration 5:\n<>\n\n# Example Output:\nSummary of Iterations 1-5:\n- User Task: <>\n- Key actions attempted: <>\n- Successes: <>\n- Failures: <>\n- Notable patterns or repeated issues: <>\n- Tool Calls: <>\n\nYour summary should condense the entire execution history, clearly outlining:\n- What the user wanted to accomplish\n- What steps were taken in each iteration\n- Which actions succeeded and which failed (with reasons if available)\n- Any patterns, repeated errors, or important observations\n\nOutput only the summary of the execution history."),new l.HumanMessage(r)];return await(0,R.D)(n,s,3,{signal:this.executionContext.abortSignal})}_buildExecutionContext(e=null,t=null){return e&&"todoMarkdown"in e?this._buildPredefinedExecutionContext(e,t):this._buildDynamicExecutionContext(e,t)}_buildPredefinedExecutionContext(e=null,t=null){const n=this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),r=n?"<screenshot-analysis>\n  The screenshot shows the webpage with nodeId numbers overlaid as visual labels on elements.\n  These appear as numbers in boxes/labels (e.g., [21], [42], [156]) directly on the webpage elements.\n  YOU MUST LOOK AT THE SCREENSHOT FIRST to identify which nodeId belongs to which element.\n</screenshot-analysis>":"<text-only-analysis>\n  You are operating in TEXT-ONLY mode without screenshots.\n  Use the browser state text to identify elements by their nodeId, text content, and attributes.\n  Focus on element descriptions and hierarchical structure in the browser state.\n</text-only-analysis>",s=n?"<visual-execution-process>\n  1. EXAMINE the screenshot - See the webpage with nodeId labels overlaid on elements\n  2. LOCATE the element you need to interact with visually\n  3. IDENTIFY its nodeId from the label shown on that element in the screenshot\n  4. EXECUTE using that nodeId in your tool call\n</visual-execution-process>":"<text-execution-process>\n  1. SEARCH with grep_elements tool using regex patterns to find elements\n  2. IDENTIFY the [nodeId] from the grep results\n  3. EXECUTE NODE_ID in your tool call\n  NEVER guess nodeIds - ALWAYS search first with grep_elements so as to have precise nodeIds for tool calls\n</text-execution-process>",i=n?"<execution-guidelines>\n  - The nodeIds are VISUALLY LABELED on the screenshot - you must look at it\n  - The text-based browser state is supplementary - the screenshot is your primary reference\n  - Batch multiple tool calls in one response when possible (reduces latency)\n  - Call 'done' when the current actions are completed\n</execution-guidelines>":"<execution-guidelines>\n  - Use the text-based browser state as your primary reference\n  - Match elements by their text content and attributes\n  - Batch multiple tool calls in one response when possible (reduces latency)\n  - Call 'done' when the current actions are completed\n</execution-guidelines>";let a="";e&&(a=`<predefined-plan-context>\n  <userTask>${e.userTask}</userTask>\n  <executionHistory>${e.executionHistory}</executionHistory>\n  <currentState>${e.currentState}</currentState>\n  <challengesIdentified>${e.challengesIdentified}</challengesIdentified>\n  <reasoning>${e.stepByStepReasoning}</reasoning>\n</predefined-plan-context> `);let o="";return t&&(o=`<actions-to-execute>\n${t.map((e,t)=>`    ${t+1}. ${e}`).join("\n")}\n  </actions-to-execute>\n`),`${a}<execution-instructions>\n${r}\n${s}\n<element-format>\nElements appear as: [nodeId] <indicator> <tag> "text" context\n\nLegend:\n- [nodeId]: Use this number in click/type calls\n- <C>/<T>: Clickable or Typeable\n</element-format>\n${i}\n${o}\n</execution-instructions>`}_formatPlannerOutputForExecutor(e){return`VibeBrowser Agent Output:\n- Task: ${e.userTask}\n- Current State: ${e.currentState}\n- Execution History: ${e.executionHistory}\n- Challenges Identified: ${e.challengesIdentified}\n- Reasoning: ${e.stepByStepReasoning}\n\n# Actions (to be performed by you)\n${e.proposedActions.map((e,t)=>`    ${t+1}. ${e}`).join("\n")}\n`}_buildDynamicExecutionContext(e=null,t=null){const n=this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),r=n?"<screenshot-analysis>\n  The screenshot shows the webpage with nodeId numbers overlaid as visual labels on elements.\n  These appear as numbers in boxes/labels (e.g., [21], [42], [156]) directly on the webpage elements.\n  YOU MUST LOOK AT THE SCREENSHOT FIRST to identify which nodeId belongs to which element.\n</screenshot-analysis>":"<text-only-analysis>\n  You are operating in TEXT-ONLY mode without screenshots.\n  Browser state may be truncated. Use grep_elements tool to find elements before any click/type action.\n  Focus on element descriptions and hierarchical structure in the browser state.\n</text-only-analysis>",s=n?"<visual-execution-process>\n  1. EXAMINE the screenshot - See the webpage with nodeId labels overlaid on elements\n  2. LOCATE the element you need to interact with visually\n  3. IDENTIFY its nodeId from the label shown on that element in the screenshot\n  4. EXECUTE using that nodeId in your tool call\n</visual-execution-process>":"<text-execution-process>\n  1. SEARCH with grep_elements tool using regex patterns to find elements\n  2. IDENTIFY the [nodeId] from the grep results\n  3. EXECUTE using click(nodeId) or type(nodeId, text)\n  NEVER guess nodeIds - ALWAYS search first with grep_elements so as to have precise nodeIds for tool calls\n</text-execution-process>",i=n?"<execution-guidelines>\n  - The nodeIds are VISUALLY LABELED on the screenshot - you must look at it\n  - The text-based browser state is supplementary - the screenshot is your primary reference\n  - Batch multiple tool calls in one response when possible (reduces latency)\n  - Call 'done' when all actions are completed\n</execution-guidelines>":'<execution-guidelines>\n  - MANDATORY: Use grep_elements before every click/type action\n    Common patterns: grep_elements("button.*(login|submit)") for buttons\n    Common patterns: grep_elements("input.*(email|password)") for inputs\n  - If grep finds nothing, try broader patterns like "button" or "input"\n  - Extract [nodeId] from results: [42] <C> <button> "Login"\n  - Call \'done\' when all actions are completed\n</execution-guidelines>';let a="";e&&(a=`<planning-context>\n  <userTask>${e.userTask}</userTask>\n  <currentState>${e.currentState}</currentState>\n  <executionHistory>${e.executionHistory}</executionHistory>\n  <challengesIdentified>${e.challengesIdentified}</challengesIdentified>\n  <reasoning>${e.stepByStepReasoning}</reasoning>\n</planning-context>\n`);let o="";return t&&(o=`<actions-to-execute>\n${t.map((e,t)=>`    ${t+1}. ${e}`).join("\n")}\n</actions-to-execute>\n`),`${a}<execution-instructions>\n${r}\n${s}\n<element-format>\nElements appear as: [nodeId] <indicator> <tag> "text" context\n\nLegend:\n- [nodeId]: Use this number in click/type calls\n- <C>/<T>: Clickable or Typeable\n</element-format>\n${i}\n${o}\n</execution-instructions>`}}function Ke(e){const t=e.toLowerCase(),n=t.match(/.*?action.*?reasoning.*?/i);if(!n)return"";const r=n.index+n[0].length,s=[/\n.*?proposed.*?actions?.*?/i,/\n.*?todo.*?markdown.*?/i,/\n.*?task.*?complete.*?/i,/\n.*?final.*?answer.*?/i];let i=e.length;for(const e of s){const n=t.slice(r).match(e);if(n&&void 0!==n.index){const e=r+n.index;e<i&&(i=e)}}return e.slice(r,i).trim()}function We(e){const t=e.toLowerCase(),n=t.match(/\n.*?proposed.*?actions?.*?/i);if(!n)return"";const r=n.index+n[0].length,s=[/\n.*?todo.*?markdown.*?/i,/\n.*?task.*?complete.*?/i,/\n.*?final.*?answer.*?/i];let i=e.length;for(const e of s){const n=t.slice(r).match(e);if(n&&void 0!==n.index){const e=r+n.index;e<i&&(i=e)}}return e.slice(r,i).trim()}function Ve(e){const t=e.toLowerCase(),n=t.match(/\n.*?task.*?complete.*?/i);if(!n)return!1;const r=n.index+n[0].length,s=[/\n.*?final.*?answer.*?/i];let i=e.length;for(const e of s){const n=t.slice(r).match(e);if(n&&void 0!==n.index){const e=r+n.index;e<i&&(i=e)}}const a=e.slice(r,i).trim().toLowerCase();return a.includes("true")||a.includes("yes")||a.includes("complete")}function Je(e){const t=e.toLowerCase().match(/\n.*?final.*?answer.*?/i);if(!t)return"";const n=t.index+t[0].length;return e.slice(n).trim()}qe.GLOW_ENABLED_TOOLS=new Set(["click","type","clear","moondream_visual_click","moondream_visual_type","scroll","navigate","key","tab_open","tab_focus","tab_close","extract"]);class Ze{constructor(e){this.executorLlmWithTools=null,this.iterations=0,this.plannerExecutionHistory=[],this.toolDescriptions="",this.executionContext=e,this.toolManager=new C(e),this.glowService=Ye.getInstance(),t.y7.log("LocalAgent","Agent instance created","info")}get executorMessageManager(){return this.executionContext.messageManager}get pubsub(){return this.executionContext.getPubSub()}checkIfAborted(){if(this.executionContext.abortSignal.aborted)throw new A}async _initialize(){await this._registerTools();const e=await(0,y.O7)({temperature:.2,maxTokens:4096});if(!e.bindTools||"function"!=typeof e.bindTools)throw new Error("This LLM does not support tool binding");this.executorLlmWithTools=e.bindTools(this.toolManager.getAll()),this.iterations=0,t.y7.log("LocalAgent",`Initialization complete with ${this.toolManager.getAll().length} tools bound`,"info")}async _registerTools(){this.toolManager.register(D(this.executionContext)),this.toolManager.register(Y(this.executionContext)),this.toolManager.register(B(this.executionContext)),this.toolManager.register(me(this.executionContext)),this.toolManager.register(fe(this.executionContext)),this.toolManager.register(z(this.executionContext)),this.toolManager.register(K(this.executionContext)),this.toolManager.register(V(this.executionContext)),this.toolManager.register(Z(this.executionContext)),this.toolManager.register(Q(this.executionContext)),this.toolManager.register(te(this.executionContext)),this.toolManager.register(re(this.executionContext)),this.toolManager.register(ie(this.executionContext)),this.toolManager.register($e(this.executionContext)),this.toolManager.register(Pe(this.executionContext)),this.toolManager.register(oe(this.executionContext)),this.toolManager.register(le(this.executionContext)),this.toolManager.register(he(this.executionContext)),this.toolManager.register(Fe(this.executionContext)),this.toolManager.register(Le(this.executionContext)),this.toolManager.register(Oe(this.executionContext)),this.toolManager.register(_e(this.executionContext)),this.toolManager.register(de(this.executionContext)),this.toolDescriptions='Available tools for browser automation:\n\n**Element Discovery & Interaction:**\n- click(nodeId): Click element using nodeId from browser state/grep results\n- type(nodeId, text): Type text into input field using nodeId\n- clear(nodeId): Clear text from input field\n- grep_elements(pattern, start?, limit?): Search DOM elements with regex patterns\n  * Returns: [nodeId] <C/T> <tag> "text" attributes format\n  * Examples: "button.*(submit|login)", "input.*(email|password)"\n  * USE when element not visible in current browser state because of truncation or hidden elements\n\n**Navigation & Page Control:**\n- navigate(url): Navigate to web page (include https://)\n- scroll(nodeId): Scroll to element OR scroll(direction, amount) for page scrolling\n- key(key): Press keyboard key (Enter, Tab, Escape, etc.)\n- wait(seconds): Wait for page loading and stability\n\n**Visual Fallback Tools:**\n- visual_click(description): Click element using visual description (when grep fails)\n- visual_type(description, text): Type into field using visual description\n\n**Tab Management:**\n- tabs: List all open browser tabs\n- tab_open(url): Open new browser tab\n- tab_focus(tabId): Switch to specific tab\n- tab_close(tabId): Close specific tab\n\n**External Services (MCP):**\n- mcp(action, instanceId?, toolName?, toolArgs?): Access Gmail, Calendar, Sheets, etc.\n  * Follow pattern: getUserInstances  listTools  callTool\n  * Prefer MCP for Google/Notion tasks over browser automation when task involves these services\n\n**Additional Tools:**\n- human_input(message): Request human assistance when stuck\n- done(success, message): Mark task completion (true=success, false=failure)\n- date: Get current date and time\n- vibebrowser_info: Get VibeBrowser agent information\n- celebration_tool: Show task completion celebration',t.y7.log("LocalAgent",`Registered ${this.toolManager.getAll().length} tools`,"info")}_getSpecialTaskMetadata(e){const t=e.toLowerCase();return"read about our vision and upvote "===t?{task:"Read about our vision and upvote",metadata:{executionMode:"predefined",predefinedPlan:{agentId:"vibebrowser-launch-upvoter",name:"VibeBrowser Launch Upvoter",goal:"Navigate to VibeBrowser launch page and upvote it",steps:["Navigate to https://dub.sh/vibebrowser-launch","Find and click the upvote button on the page using visual_click","Use celebration tool to show confetti animation"]}}}:"support vibebrowser on github "===t?{task:"Support VibeBrowser on GitHub",metadata:{executionMode:"predefined",predefinedPlan:{agentId:"github-star-vibebrowser",name:"GitHub Repository Star",goal:"Navigate to VibeBrowser GitHub repo and star it",steps:["Navigate to https://git.new/browserOS","Check if the star button indicates already starred (filled star icon)","If not starred (outline star icon), click the star button to star the repository","Use celebration_tool to show confetti animation"]}}}:null}async execute(e,n){const r=this._getSpecialTaskMetadata(e);let s=e,i=n;r&&(s=r.task,i={...n,...r.metadata},t.y7.log("LocalAgent",`Special task detected: ${r.metadata.predefinedPlan?.name}`,"info"));try{this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),startTime:Date.now()}),t.y7.log("LocalAgent","Starting execution","info"),await this._initialize(),"predefined"===i?.executionMode&&i.predefinedPlan?await this._executePredefined(s,i.predefinedPlan):await this._executeDynamic(s)}catch(e){throw this._handleExecutionError(e),e}finally{this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),endTime:Date.now()}),this._logMetrics(),this._cleanup();try{const e=await this.glowService.getAllActiveGlows();for(const t of e)await this.glowService.stopGlow(t)}catch(e){}}}async _executePredefined(e,n){this.executionContext.setCurrentTask(e);const r=n.steps.map(e=>`- [ ] ${e}`).join("\n");if(this.executionContext.setTodoList(r),!this.executorLlmWithTools)throw new Error("LLM with tools not initialized");this._publishMessage(`Executing agent: ${n.name||"Custom Agent"}`,"thinking");n.goal;let s=!1,i=0;for(;!s&&this.iterations<30;){this.checkIfAborted(),this.iterations++,t.y7.log("LocalAgent",`Predefined plan iteration ${this.iterations}/30`,"info");const n=await this._runPredefinedPlanner(e,this.executionContext.getTodoList());if(!n.ok){if(t.y7.log("LocalAgent",`Predefined planning failed: ${n.error}`,"error"),i++,i>=3)throw new Error(`Predefined planning failed: ${n.error}`);continue}const r=n.output;if(r.taskComplete){s=!0;const e=r.finalAnswer||"All steps completed successfully";this._publishMessage(e,"assistant");break}if(!r.proposedActions||0===r.proposedActions.trim().length){if(t.y7.log("LocalAgent","Predefined planner provided no actions but task not complete","warning"),i++,i>=3)throw new Error("Predefined planner provided no actions but TODOs not complete");continue}t.y7.log("LocalAgent","Executing actions for current TODO","info");if((await this._runExecutor(r.proposedActions,r)).requiresHumanInput){if("abort"===await this._waitForHumanInput())throw this._publishMessage(" Task aborted by human","assistant"),new A("Task aborted by human");this._publishMessage(" Human completed manual action. Continuing...","thinking"),this.executionContext.clearHumanInputState()}}if(!s&&this.iterations>=30)throw this._publishMessage("Predefined plan did not complete within 30 iterations","error"),new Error("Maximum predefined plan iterations (30) reached or planning failed");t.y7.log("LocalAgent","Predefined plan execution complete","info")}async _executeDynamic(e){if(this.executionContext.setCurrentTask(e),!this.executorLlmWithTools)throw new Error("LLM with tools not initialized");let n=!1,r=0;for(this._publishMessage("Starting task execution...","thinking");!n&&this.iterations<50;){this.checkIfAborted(),this.iterations++,t.y7.log("LocalAgent",`Planning iteration ${this.iterations}/50`,"info");const s=await this._runDynamicPlanner(e);if(!s.ok){if(t.y7.log("LocalAgent",`Planning failed: ${s.error}`,"error"),r++,r>=3)throw new Error(`Planning failed: ${s.error}`);continue}const i=s.output;if(this.pubsub.publishMessage(a.Gd.createMessage(i.reasoning,"thinking")),i.taskComplete){n=!0;const e=i.finalAnswer||"Task completed successfully";this.pubsub.publishMessage(a.Gd.createMessage(e,"assistant"));break}if(!i.proposedActions||0===i.proposedActions.trim().length){if(t.y7.log("LocalAgent","Planner provided no actions but task not complete","warning"),r++,r>=3)throw new Error("Planning failed: Planner provided no actions but task not complete");continue}t.y7.log("LocalAgent","Executing actions from plan","info");if((await this._runExecutor(i.proposedActions,i)).requiresHumanInput){if("abort"===await this._waitForHumanInput())throw this._publishMessage(" Task aborted by human","assistant"),new A("Task aborted by human");this._publishMessage(" Human completed manual action. Re-planning...","thinking"),this.executionContext.clearHumanInputState()}}if(!n&&this.iterations>=50)throw this._publishMessage("Task did not complete within 50 planning iterations","error"),new Error("Maximum planning iterations (50) reached")}async _getBrowserStateMessage(e,t=!0,n="large",r=!0,s=5e4){let i=null;if(r){i=await this.executionContext.browserContext.getBrowserStateString(t);if(u.countMessage(new l.HumanMessage(i))>s){i=await this.executionContext.browserContext.getBrowserStateString(t,!0);const e=u.countMessage(new l.HumanMessage(i));if(e>s){const t=s/e,n=Math.floor(i.length*t);i=i.substring(0,n),i+="\n\n-- IMPORTANT: TRUNCATED DUE TO TOKEN LIMIT, USE GREP ELEMENTS TOOL TO SEARCH FOR ELEMENTS IF NEEDED --\n"}}}if(e&&this.executionContext.supportsVision()){const e=await this.executionContext.browserContext.getCurrentPage(),t=await e.takeScreenshot(n,r);if(t){const e=[];r&&null!==i&&e.push({type:"text",text:`<browser-state>${i}</browser-state>`}),e.push({type:"image_url",image_url:{url:t}});const n=new l.HumanMessage({content:e});return n.additional_kwargs={messageType:h.BROWSER_STATE},n}}if(r&&null!==i){const e=new l.HumanMessage(`<browser-state>${i}</browser-state>`);return e.additional_kwargs={messageType:h.BROWSER_STATE},e}const a=new l.HumanMessage("");return a.additional_kwargs={messageType:h.BROWSER_STATE},a}async _runDynamicPlanner(e){try{this.executionContext.incrementMetric("observations");const n=this.executionContext.getExecutionMetrics(),r=n.toolCalls>0?(n.errors/n.toolCalls*100).toFixed(1):"0",s=Date.now()-n.startTime;let i=this._buildPlannerExecutionHistory();const a=function(e=""){return`# Context\nYour are VibeBrowser Agent which helps the user to automate their tasks in the browser. Your primary responsibility is to analyze the user's query, the full execution history (all previous actions, attempts, and failures), and the current browser state (including screenshot when available), and then suggest immediate actionable next steps to achieve the user's objective *based on the current browser state and screenshot*.\n\nYou do NOT perform actions yourself. Your role is to propose clear, actionable next steps for the EXECUTOR AGENT, who will execute these actions in the browser, report back with results, errors, and updated observations, including the latest browser state and screenshot. Use this feedback to continually refine your strategy and guide the executor agent toward successful completion of the user's task.\n\n# YOUR ROLE\n\n- Analyze the user's query, past execution history (what has been attempted and what failed) and current browser state (including screenshot) in depth.\n- Based on this analysis, generate a precise, actionable and adaptive plan (1-5 high-level actions) for the executor agent to perform next.\n- After each round of execution, review the history and updated state, and refine your plan and suggest next steps as needed.\n- When the task is fully complete, provide a final answer and set \`taskComplete=true\`. Answer must be grounded based on latest browser state and screenshot.\n\n# STEP BY STEP REASONING\n\n1. **Analysis of User Query, Execution History and Current/Updated Browser State:**\n  1.1 Analyze the focus of the user's query what they want to achieve.\n  1.2 Followed by analysis of user query, analyze the past execution history (what has been attempted and what failed).\n  1.3 Then reflect on the latest browser state and screenshot whether it matches the expected outcome from the execution history. If it does not, update your plan accordingly. Source of truth is the latest browser state and screenshot.\n\n2. **Generation of Plan:**\n  2.1 **Ground plans in reality:** Only propose actions that are possible given the current/updated browser state and screenshot. Do not assume the presence of elements unless they are visible or confirmed. For example, if the user asks to "Add Farmhouse Pepperoni Pizza to the cart" and the add to cart button is visible, propose "Click the add to cart button" rather than "Navigate to the website and then add to cart". If you suggest an action that is not possible given the current/updated browser state and screenshot, you will be penalized. So, suggest only those actions (1-5) that are possible given the current/updated browser state and screenshot.\n  2.2 **Be specific, actionable, and tool-based:** Clearly state what the executor agent should do, using direct and unambiguous instructions grounded in the current/updated browser state (e.g., "Navigate to dominos.com" instead of "Go to a pizza website"). Frame actions in terms of available tools, such as "Click the add to cart button", "Type 'Farmhouse Pepperoni Pizza' into the search bar", or "Use MCP to search Gmail for unread emails".\n  2.3 **High level actions:** Propose high-level actions that are directly executable by the executor agent. For example, "Navigate to dominos.com" instead of "Go to a pizza website". Do not suggest low-level actions like "Click element [123]" or "Type into nodeId 456" [NODE IDS are better determined by the executor agent as its the one who will perform the action]\n  2.4 **Conclude when done:** Mark \`taskComplete=true\` and provide a final answer only when the user's request is fully satisfied and no further actions are needed.\n\n3. **Adaptive Learning:**\n  3.1 Continuously review which actions the executor agent has already tried, and how successful they were. If previous actions did not achieve the desired result, revise your plan and propose new, alternative steps. If you notice repeated failures or a high error rate, switch strategies to increase the chance of success. For example, if a form submission fails, suggest a different way to accomplish the task.\n  3.2 Always base your next plan on the most recent browser state and screenshot. If the current browser state or screenshot does not match the expected outcome from the execution history, update your plan accordingly. Treat the current browser state and screenshot as the definitive source of truth, and ensure all proposed actions are grounded in what is actually visible and available now.\n\n# AVAILABLE BROWSER AUTOMATION TOOLS FOR THE EXECUTOR AGENT\n\n${e}\n\n# ELEMENT DISCOVERY STRATEGY FOR EXECUTOR AGENT\n\nWhen browser state doesn't show target elements or shows "..." (truncated content), the executor agent can use:\n\n**grep_elements Tool for Element Discovery:**\n- \`grep_elements("button.*(submit|login|sign|next)")\` - Find buttons\n- \`grep_elements("input.*(email|password|text)")\` - Find input fields\n- \`grep_elements("a.*(login|signin|register)")\` - Find links\n- \`grep_elements("form")\` - Find forms\n\n**Element Format:** \`[nodeId] <C/T> <tag> "text" attributes\`\n- \`<C>\` = Clickable element, \`<T>\` = Typeable element\n- Executor agent extracts [nodeId] for click(nodeId) and type(nodeId, text) calls\n\n**Progressive Discovery Strategy:**\n1. Check browser state for visible elements first\n2. Use grep_elements with specific patterns when elements not visible\n3. Try broader patterns if specific ones fail\n4. Fall back to visual_click/visual_type with descriptions\n\n**IMPORTANT:** Do not reference specific nodeIds in your proposed actions. Let the executor agent discover and use the appropriate nodeIds through browser state or grep_elements.\n\n# MCP SERVICES (PREFERRED FOR GOOGLE/NOTION TASKS) AVAILABLE TO THE EXECUTOR AGENT\n\n- Google Calendar: event management and scheduling\n- Gmail: email search, reading, and sending\n- Google Sheets: spreadsheet reading, writing, and formulas\n- Google Docs: document reading, writing, and formatting\n- Notion: note and database management\n\n**Always prefer MCP for these services over browser automation when possible.**\nExample: Use "Use MCP to search Gmail for unread emails" instead of "Navigate to gmail.com".\n\n# EXAMPLES OF EFFECTIVE (GOOD) ACTIONS\n\n- Use VibeBrowser info tool to retrieve agent details\n- Use MCP to search Gmail for unread emails\n- Use MCP to get today's Google Calendar events\n- Use MCP to read data from a specific Google Sheet\n- Navigate to "https://example.com/login"\n- Fill the email field with "user@example.com"\n- Click the submit button\n- Use visual click on the blue submit button (if standard click has failed previously)\n- Click the Close icon in the popup modal\n- Type "Farmhouse Pepperoni Pizza" into the search bar (if the search bar is visible in browser state)\n- Use MCP to create a new event in Google Calendar\n\n# EXAMPLES OF INEFFECTIVE (BAD) ACTIONS\n\n- Click element [123] (do not reference node IDs directly; executor agent determines this)\n- Type into nodeId 456 (do not reference node IDs directly; executor agent determines this)\n- Add Farmhouse Pepperoni Pizza to the cart when the button is not visible in browser state (instead, scroll down, check updated state and then propose the action)\n- Navigate to a generic site (e.g., "Go to a pizza website") without specifying the actual URL\n\n# OUTPUT FORMAT\nYour output must be in string format with these sections:\n\n- Action Reasoning: Step-by-step reasoning through the problem, considering the user's goal, what has already been attempted, and reflecting on the latest browser state and screenshot. Justify your next steps. All actions must be grounded in the latest browser state and screenshot.\n- Proposed Actions: List 1-5 specific, high-level actions for the executor agent to perform next. This must be empty if \`task complete=true\`. Each action should be clear, actionable, and based on your reasoning and the latest browser state and screenshot.\n- Task Complete: true/false  Set to true only if the user's request is fully satisfied and no further actions are needed.\n- Final Answer: If \`task complete=true\`, provide a complete, direct answer to the user's request (include any relevant data or results). Leave empty otherwise. The answer must be grounded in the latest browser state and screenshot.\n\nRemember: You are the planner agent for VibeBrowser Agent. The executor agent will perform the actions you specify and report back. Use their feedback to adapt your plan until the task is complete.`}(this.toolDescriptions||""),o=u.countMessage(new l.tn(a)),c=u.countMessage(new l.HumanMessage(i));if(t.y7.log("LocalAgent",`Full execution history tokens: ${c}`,"info"),c+o>.7*this.executionContext.getMaxTokens()){const e=await this.summarizeExecutionHistory(i);i=e.summary,this.plannerExecutionHistory=[],this.plannerExecutionHistory.push({plannerOutput:e,toolMessages:[],plannerIterations:this.iterations-1})}t.y7.log("LocalAgent",`Full execution history: ${i}`,"info");const d=await(0,y.O7)({temperature:.2,maxTokens:4096}),h=this._buildExecutionContext(),p=`TASK: ${e}\n\nEXECUTION METRICS:\n- Tool calls: ${n.toolCalls} (${n.errors} errors, ${r}% failure rate)\n- Observations taken: ${n.observations}\n- Time elapsed: ${(s/1e3).toFixed(1)} seconds\n${parseInt(r)>30&&n.errors>3?" HIGH ERROR RATE - Current approach may be failing. Learn from the past execution history and adapt your approach":""}\n\n${h}\n\nYOUR PREVIOUS STEPS DONE SO FAR (what you thought would work):\n${i}\n\nContinue upon the previous steps what has been done so far and suggest next steps to complete the task.\n`,m=u.countMessage(new l.HumanMessage(p)),g=await this._getBrowserStateMessage(this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),!0,"large",!0,.8*(this.executionContext.getMaxTokens()-o-m)),f=[new l.tn(a),new l.HumanMessage(p),g],_=await(0,R.D)(d,f,3,{signal:this.executionContext.abortSignal}),b=_?.content||"",w=Ke(b),v=We(b),E=Ve(b),S={reasoning:w,proposedActions:v,taskComplete:E,finalAnswer:Je(b)},x={reasoning:S.reasoning,proposedActions:S.proposedActions,taskComplete:S.taskComplete,finalAnswer:S.finalAnswer};return this.executionContext.addReasoning(JSON.stringify(x)),t.y7.log("LocalAgent",S.taskComplete?"Planner: Task complete with final answer":"Planner: actions planned","info"),{ok:!0,output:S}}catch(e){return this.executionContext.incrementMetric("errors"),{ok:!1,error:`Planning failed: ${e instanceof Error?e.message:String(e)}`}}}async _runExecutor(e,n){const r=new f,s=`You are an autonomous Browser Automation EXECUTOR AGENT for VibeBrowser Agent which helps the user to automate their tasks in the browser.\n<executor-mode>\nYou are now operating in EXECUTION MODE. You will be provided with:\n- A brief summary of what has been done so far, including the analysis of the user task, current state, execution history, challenges, and reasoning.\n- A list of actions to perform to complete the user task.\n- The current browser state, including a screenshot for visual reference (when available).\n\nYour primary responsibility is to interpret each action and translate it into the correct tool calls, executing them within the browser environment.\n\n${this._buildExecutionContext()}\n\n# STEP BY STEP EXECUTION PROCESS\n\n1. **Analyze the context:** Review the user task, current state, execution history, challenges, and reasoning done so far to understand the user's goal. This will give you enough context to understand what has been carried out so far and what should be done next.\n2. **Use the browser state and screenshot:** Always check the browser state (including screenshot when available) before selecting elements or nodeIds for tool calls. Example: To click a button, look for its nodeId in the browser state before using click(nodeId).\n3. **Map actions to tools:** For each action, select the most appropriate tool(s) to accomplish it. Example: "Fill email field"  type(nodeId, "user@example.com")\n4. **Follow action order:** Execute all actions in the EXACT order provided, unless actions are clearly independent. Example: Do not click "submit" until all form fields are filled.\n5. **Batch independent actions:** If actions are independent (e.g., filling multiple fields), batch tool calls in a single response to improve efficiency. Example: Fill "email" and "password" fields together before clicking "submit" in next response.\n6. **Sequence dependent actions:** If an action requires multiple steps or tools, use them in the correct sequence. Example: Scroll to element, then click it.\n7. **Adapt on failure:** If an action fails, immediately try alternative strategies or fallback tools (such as visual_click, visual_type, etc.). Example: If click(nodeId) fails, retry with visual_click("blue submit button at bottom of form") in next response.\n8. **Complete all actions:** Do not stop until every action in the list is completed.\n\n*Example:* For example, you got actions such as ["Fill email field with user@example.com", "Fill password field with Secret123", "Click login button"]. You should do the following:\n- Understand the browser state and screenshot to identify the nodeIds of the elements.\n- Fill "email" and "password" fields (can be done in a single response if possible)\n- Click "login" button.\n- If click fails, try with alternative tool calls such as visual_click("blue submit button at bottom of form") in next response.\n- Complete all actions in the list.\n\n# ACTION MAPPING GUIDE:\n- "Navigate to [url]"  use navigate(url) tool\n- "Click [element description]"  LOOK at browser state, find element's nodeId, use click(nodeId)\n   If click fails or nodeId unclear  use visual_click("element description")\n- "Fill [field] with [value]"  LOOK at browser state, find field's nodeId, use type(nodeId, text)\n   If type fails or field not found  use visual_type("field description", text)\n- "Clear [field]"  LOOK at browser state, find field's nodeId, use clear(nodeId)\n- "Wait for [condition]"  use wait(seconds)\n- "Scroll to [element]"  LOOK at browser state, find element's nodeId, use scroll(nodeId)\n- "Press [key]"  use key(key)\n- "Extract [data]"  use extract(format, task)\n- "Submit form"  LOOK at browser state, find submit button's nodeId, click(nodeId)\n   If click fails  use visual_click("submit button description")\n\nCRITICAL OUTPUT RULES - NEVER VIOLATE THESE:\n1. **NEVER** output or echo content from <browser-state> tags - this is for YOUR reference only\n2. **NEVER** output or echo <system-reminder> tags or their contents\nBrowser state and system reminders are INTERNAL ONLY - treat them as invisible to the user. These should not be visible to the user.\n\nThe browser state appears in <browser-state> tags for your internal reference to understand the page.\nSystem reminders appear in <system-reminder> tags for your internal guidance.\n</executor-mode>\n\n<element-identification>\nText-based element format (supplementary to screenshot):\n[nodeId] <C/T> <tag> "text" (visible/hidden)\n- <C> = Clickable, <T> = Typeable\n- (visible) = in viewport, (hidden) = requires scrolling\n- This text helps confirm what you see in the screenshot\nREMEMBER: The nodeId numbers in [brackets] here match the visual labels on the screenshot (when available)\n</element-identification>\n\n<fallback-strategies>\nELEMENT DISCOVERY STRATEGY:\n1. **Primary:** Check browser state for visible elements with [nodeId]\n2. **Secondary:** If element not visible or state shows "...", use grep_elements\n3. **Fallback:** If grep finds nothing, use visual_click/visual_type\n\n**grep_elements Usage (when browser state incomplete):**\n- Buttons: \`grep_elements("button.*(submit|login|sign|next)")\`\n- Input fields: \`grep_elements("input.*(email|password|text)")\`\n- Links: \`grep_elements("a.*(login|signin|register)")\`\n- Forms: \`grep_elements("form")\`\n\n**Element Format:** \`[nodeId] <C/T> <tag> "text" attributes\`\n- Extract [nodeId] for tool calls: click(123), type(456, "text")\n- <C> = Clickable, <T> = Typeable\n\nCLICK ESCALATION STRATEGY:\n1. First attempt: Use click(nodeId) with element from browser state\n2. If browser state incomplete: Use grep_elements to find element\n3. If "Element not found" or "Click failed": Use visual_click with descriptive text\n4. Visual descriptions should include:\n   - Color/appearance: "blue button", "red link"\n   - Position: "top right corner", "below the header"\n   - Text content: "containing 'Submit'", "labeled 'Search'"\n   - Context: "in the login form", "next to the logo"\n\nWHEN TO USE VISUAL FALLBACK:\n- Error: "Element [nodeId] not found"  Immediate visual_click\n- Error: "Failed to click"  Retry with visual_click\n- Situation: NodeId unclear in browser state  Use grep_elements first, then visual_click\n- Situation: Dynamic/popup elements  Prefer visual_click\n- After 2 failed regular clicks  Switch to visual approach\n\nVISUAL DESCRIPTION BEST PRACTICES:\n "blue submit button at bottom of form"\n "search icon in top navigation bar"\n "first checkbox in the list"\n "X close button in modal corner"\n "element-123" (too technical)\n "button" (too vague)\n</fallback-strategies>\n\n<tools>\nExecution Tools:\n- click(nodeId): Click element by nodeId\n- type(nodeId, text): Type text into element\n- clear(nodeId): Clear text from element\n- scroll(nodeId?): Scroll to element OR scroll(direction, amount) for page scrolling\n- navigate(url): Navigate to URL (include https://)\n- key(key): Press keyboard key (Enter, Tab, Escape, etc.)\n- wait(seconds?): Wait for page to stabilize\n\nVisual Fallback Tools (use when DOM-based tools fail):\n- visual_click(instruction): Click element by visual description\n  Example: visual_click("blue submit button")\n- visual_type(instruction, text): Type into field by visual description\n  Example: visual_type("email input field", "user@example.com")\n\nTab Control:\n- tabs: List all browser tabs\n- tab_open(url?): Open new tab\n- tab_focus(tabId): Switch to specific tab\n- tab_close(tabId): Close tab\n\nData Operations:\n- extract(format, task): Extract structured data matching JSON schema\n\nElement Discovery:\n- grep_elements(pattern, start?, limit?): Search page elements with regex patterns\n  Returns: [nodeId] <C/T> <tag> "text" attributes format\n  USE when element not visible in browser state or need filtering\n\nMCP Integration:\n- mcp(action, instanceId?, toolName?, toolArgs?): Access external services (Gmail, GitHub, etc.)\n   ALWAYS follow 3-step process: getUserInstances  listTools  callTool\n   Use exact IDs and tool names from responses\n\nCompletion:\n- done(success, message): Call when ALL actions are executed successfully\n</tools>\n\n<mcp-instructions>\nMCP TOOL USAGE (for Gmail, GitHub, Slack, etc.):\nCRITICAL: Never skip steps or guess tool names. Always execute in exact order:\n\nStep 1: Get installed servers\nmcp(action: 'getUserInstances')\n Returns: {instances: [{id: 'a146...', name: 'Gmail', authenticated: true}]}\n SAVE the exact instance ID\n\nStep 2: List available tools (MANDATORY - NEVER SKIP)\nmcp(action: 'listTools', instanceId: 'exact-id-from-step-1')\n Returns: {tools: [{name: 'gmail_search_emails', description: '...'}]}\n USE exact tool names from this response\n\nStep 3: Call the tool\nmcp(action: 'callTool', instanceId: 'exact-id', toolName: 'exact-name', toolArgs: {key: value})\n toolArgs must be JSON object, not string\n\nCommon Mistakes to Avoid:\n Guessing tool names like 'gmail_list_messages'\n Skipping listTools step\n Using partial instance IDs\n Always use exact values from previous responses\n\nAvailable MCP Servers:\n- Google Calendar: Calendar operations (events, scheduling)\n- Gmail: Email operations (search, read, send)\n- Google Sheets: Spreadsheet operations (read, write, formulas)\n- Google Docs: Document operations (read, write, format)\n- Notion: Note management (pages, databases)\n\nUse MCP when task involves these services instead of browser automation.\n</mcp-instructions>`;const i=u.countMessage(new l.tn(s));r.addSystem(s);const a=[];let o=0,c=!0;for(;o<3;){if(this.checkIfAborted(),o++,c){const e=this._formatPlannerOutputForExecutor(n),t=this._buildExecutionContext(),s=u.countMessage(new l.HumanMessage(t+"\n"+e)),a=await this._getBrowserStateMessage(this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),!0,"medium",!0,.8*(this.executionContext.getMaxTokens()-i-s));r.add(a),r.addSystemReminder(t+'\n I will never output <browser-state> or <system-reminder> tags or their contents. These are for my internal reference only. I will provide what tools to be executed based on provided actions in sequence until I call "done" tool.'),r.addHuman(`${e}\nPlease execute the actions specified above.`),c=!1}else r.addHuman("Please verify if all actions are completed and call 'done' tool if all actions are completed.");const e=await this._invokeLLMWithStreaming(r);if(!(e.tool_calls&&e.tool_calls.length>0))break;{r.add(e);const t=await this._processToolCalls(e.tool_calls,r,a);for(const t of e.tool_calls)this.executionContext.incrementMetric("toolCalls"),this.executionContext.incrementToolUsageMetrics(t.name);if(t.doneToolCalled){this.plannerExecutionHistory.push({plannerOutput:n,toolMessages:a,plannerIterations:this.iterations});for(const e of r.getMessages())this.executorMessageManager.add(e);return{completed:!0,doneToolCalled:!0}}if(t.requiresHumanInput){this.plannerExecutionHistory.push({plannerOutput:n,toolMessages:a,plannerIterations:this.iterations});for(const e of r.getMessages())this.executorMessageManager.add(e);return{completed:!1,requiresHumanInput:!0}}}}for(const e of r.getMessages())this.executorMessageManager.add(e);return t.y7.log("LocalAgent","Executor hit max iterations (3)","warning"),this.plannerExecutionHistory.push({plannerOutput:n,toolMessages:a,plannerIterations:this.iterations}),{completed:!1}}async _invokeLLMWithStreaming(e){const n=e||this.executorMessageManager;if(!this.executorLlmWithTools)throw new Error("LLM not initialized - ensure _initialize() was called");const r=["<browser-state>","<system-reminder>","</browser-state>","</system-reminder>"],s=n.getMessages(),i=await this.executorLlmWithTools.stream(s,{signal:this.executionContext.abortSignal});let o,c="",u=!1,d=null,h=!1;for await(const e of i){if(this.checkIfAborted(),e.content&&"string"==typeof e.content){if(c+=e.content,!h){r.find(e=>c.includes(e))&&(h=!0,d&&this.pubsub.publishMessage(a.Gd.createMessageWithId(d,"Processing...","thinking")),n.queueSystemReminder("I will never output <browser-state> or <system-reminder> tags or their contents. These are for my internal reference only. If I have completed all actions, I will complete the task and call 'done' tool."),t.y7.log("LocalAgent","LLM output contained prohibited tags, streaming stopped","warning"),this.executionContext.incrementMetric("errors"))}h||(u||(u=!0,d=a.Gd.generateId("msg_assistant")),d&&this.pubsub.publishMessage(a.Gd.createMessageWithId(d,c,"thinking")))}o=o?o.concat(e):e}return u&&!h&&c.trim()&&d&&this.pubsub.publishMessage(a.Gd.createMessageWithId(d,c,"thinking")),o?new l.Od({content:o.content,tool_calls:o.tool_calls}):new l.Od({content:""})}async _processToolCalls(e,n,s){const i={doneToolCalled:!1,requirePlanningCalled:!1,requiresHumanInput:!1};for(const a of e){this.checkIfAborted();const{name:e,args:o,id:c}=a;this._emitDevModeDebug(`Calling tool ${e} with args`,JSON.stringify(o)),await this._maybeStartGlowAnimation(e);const l=this.toolManager.get(e);let u;if(l)try{let e=l.func;if(r.kF){e=Ge(l,this.executionContext,c).func}u=await e(o)}catch(n){const r=`Tool execution failed: ${n instanceof Error?n.message:String(n)}`;u=JSON.stringify({ok:!1,error:r}),this.executionContext.incrementMetric("errors"),t.y7.log("LocalAgent",`Tool ${e} execution failed: ${n}`,"error"),this._emitDevModeDebug(`Error executing ${e}`,r)}else{t.y7.log("LocalAgent",`Unknown tool: ${e}`,"warning");const n=`Unknown tool: ${e}`;u=JSON.stringify({ok:!1,error:n}),this._emitDevModeDebug("Error",n)}const d=M(u);n.addTool(u,c),s.push(`Tool: ${e} - Result: ${u}`),"done"===e&&d.ok&&(i.doneToolCalled=!0),"human_input"===e&&d.ok&&d.requiresHumanInput&&(i.requiresHumanInput=!0)}return n.flushQueue(),i}_publishMessage(e,t){this.pubsub.publishMessage(a.Gd.createMessage(e,t))}_emitDevModeDebug(e,t,n=60){if((0,r.D5)()){let r=e;if(t){r=`${e}: ${t.length>n?t.substring(0,n)+"...":t}`}this.pubsub.publishMessage(a.Gd.createMessage(`[DEV MODE] ${r}`,"thinking"))}}_handleExecutionError(e){if(e instanceof A)return void t.y7.log("LocalAgent","Execution aborted by user","info");const n=e instanceof Error?e.message:String(e);t.y7.log("LocalAgent",`Execution error: ${n}`,"error"),this._publishMessage(`Error: ${n}`,"error")}_logMetrics(){const e=this.executionContext.getExecutionMetrics(),n=e.endTime-e.startTime,r=e.toolCalls>0?((e.toolCalls-e.errors)/e.toolCalls*100).toFixed(1):"0",s={};e.toolFrequency.forEach((e,t)=>{s[t]=e}),t.y7.log("LocalAgent",`Execution complete: ${this.iterations} iterations, ${e.toolCalls} tool calls, ${e.observations} observations, ${e.errors} errors, ${r}% success rate, ${n}ms duration`,"info"),e.toolCalls>0&&t.y7.log("LocalAgent",`Tool frequency: ${JSON.stringify(s)}`,"info"),t.y7.logMetric("newagent.execution",{iterations:this.iterations,toolCalls:e.toolCalls,observations:e.observations,errors:e.errors,duration:n,successRate:parseFloat(r),toolFrequency:s})}_cleanup(){this.iterations=0,this.plannerExecutionHistory=[],t.y7.log("LocalAgent","Cleanup complete","info")}async _maybeStartGlowAnimation(e){if(!Ze.GLOW_ENABLED_TOOLS.has(e))return!1;try{const e=(await this.executionContext.browserContext.getCurrentPage()).tabId;return!(!e||this.glowService.isGlowActive(e))&&(await this.glowService.startGlow(e),!0)}catch(e){return!1}}async _waitForHumanInput(){const e=Date.now(),t=this.executionContext.getHumanInputRequestId();if(!t)return"abort";const n=this.pubsub.subscribe(e=>{if("human-input-response"===e.type){const n=e.payload;n.requestId===t&&this.executionContext.setHumanInputResponse(n)}});try{for(;!this.executionContext.shouldAbort();){const t=this.executionContext.getHumanInputResponse();if(t)return t.action;if(Date.now()-e>6e5)return this._publishMessage(" Human input timed out after 10 minutes","error"),"timeout";await new Promise(e=>setTimeout(e,500))}return"abort"}finally{n.unsubscribe()}}async _runPredefinedPlanner(e,n){try{this.executionContext.incrementMetric("observations");const e=this.executionContext.getExecutionMetrics(),r=e.toolCalls>0?(e.errors/e.toolCalls*100).toFixed(1):"0",s=Date.now()-e.startTime;let i=this._buildPlannerExecutionHistory();const o=function(e=""){return`# Context\nYour are VibeBrowser Agent which helps the user to automate their tasks in the browser. Your primary responsibility is to work through a predefined TODO list systematically, analyze the user's query, the full execution history (all previous actions, attempts, and failures), and the current browser state (including screenshot), and then suggest immediate actionable next steps to complete the current TODO item *based on the current browser state and screenshot*.\n\nYou do NOT perform actions yourself. Your role is to manage the TODO list, analyze execution history, learn from failures, and propose clear, actionable next steps for the EXECUTOR AGENT, who will execute these actions in the browser, report back with results, errors, and updated observations, including the latest browser state and screenshot. Use this feedback to continually refine your strategy and guide the executor agent toward successful completion of each TODO item.\n\n# YOUR ROLE\n\n- Analyze the user's query, past execution history (what has been attempted and what failed), current TODO list status, and current browser state (including screenshot) in depth.\n- Based on this analysis, generate a precise, actionable and adaptive plan (1-5 high-level actions) for the executor agent to perform next to complete the current TODO item.\n- After each round of execution, review the history and updated state, update the TODO list progress, and refine your plan and suggest next steps as needed.\n- When all TODO items are complete, provide a final answer and set \`allTodosComplete=true\`. Answer must be grounded based on latest browser state and screenshot.\n\n# STEP BY STEP REASONING\n\n1. **Analysis of User Query, Execution History, TODO Progress and Current/Updated Browser State:**\n  1.1 Analyze the focus of the user's query and the current TODO list to understand what they want to achieve.\n  1.2 Followed by analysis of user query, analyze the past execution history (what has been attempted and what failed) and current TODO progress.\n  1.3 Then reflect on the latest browser state and screenshot whether it matches the expected outcome from the execution history. If it does not, update your plan accordingly. Source of truth is the latest browser state and screenshot.\n\n2. **TODO Management and Plan Generation:**\n  2.1 **Update TODO progress:** Mark completed items with [x], failed items with [!], and focus on the NEXT uncompleted TODO item. Only mark as complete when browser state confirms success.\n  2.2 **Ground plans in reality:** Only propose actions that are possible given the current/updated browser state and screenshot. Do not assume the presence of elements unless they are visible or confirmed. For example, if the current TODO is "Click login button" and the login button is visible, propose "Click the login button" rather than "Navigate to login page first". If you suggest an action that is not possible given the current/updated browser state and screenshot, you will be penalized.\n  2.3 **Be specific, actionable, and tool-based:** Clearly state what the executor agent should do, using direct and unambiguous instructions grounded in the current/updated browser state (e.g., "Navigate to dominos.com" instead of "Go to a pizza website"). Frame actions in terms of available tools, such as "Click the add to cart button", "Type 'Farmhouse Pepperoni Pizza' into the search bar", or "Use MCP to search Gmail for unread emails".\n  2.4 **High level actions:** Propose high-level actions that are directly executable by the executor agent. For example, "Navigate to dominos.com" instead of "Go to a pizza website". Do not suggest low-level actions like "Click element [123]" or "Type into nodeId 456" [NODE IDS are better determined by the executor agent as its the one who will perform the action]\n  2.5 **Conclude when done:** Mark \`allTodosComplete=true\` and provide a final answer only when all TODO items are completed and no further actions are needed.\n\n3. **Adaptive Learning and Execution Analysis:**\n  3.1 **FORENSICALLY ANALYZE** execution metrics and full message history. Check error rate - if > 30%, current approach is failing.\n  3.2 Continuously review which actions the executor agent has already tried, and how successful they were. If previous actions did not achieve the desired result, revise your plan and propose new, alternative steps. If you notice repeated failures or a high error rate, switch strategies to increase the chance of success.\n  3.3 Always base your next plan on the most recent browser state and screenshot. If the current browser state or screenshot does not match the expected outcome from the execution history, update your plan accordingly. Treat the current browser state and screenshot as the definitive source of truth, and ensure all proposed actions are grounded in what is actually visible and available now.\n\n# EXECUTION ANALYSIS PATTERNS\n\n**METRIC PATTERNS TO DETECT:**\n- Error rate > 30%: Current approach failing, need different strategy\n- toolCalls > 10 with high errors: Stuck in loop, break the pattern\n- Same tool failing repeatedly: Element likely doesn't exist\n   Pattern: click failures > 2  Suggest "Use visual click to find [element description]"\n- Click/Type errors with "not found": DOM identification failing  switch to visual approach\n\n**VISUAL FALLBACK TRIGGERS:**\n- After 2 failed clicks on same element  "Use visual click on [describe element visually]"\n- DOM elements not visible in screenshot  "Try visual click to find [description]"\n- Dynamic/popup elements  Direct to visual: "Click the modal close button using visual identification"\n- Unclear nodeIds  "Click the [visual description] button"\n\n# AVAILABLE BROWSER AUTOMATION TOOLS FOR THE EXECUTOR AGENT\n\n${e}\n\n# ELEMENT DISCOVERY STRATEGY FOR EXECUTOR AGENT\n\nWhen browser state doesn't show target elements or shows "..." (truncated content), the executor agent can use:\n\n**grep_elements Tool for Element Discovery:**\n- \`grep_elements("button.*(submit|login|sign|next)")\` - Find buttons\n- \`grep_elements("input.*(email|password|text)")\` - Find input fields\n- \`grep_elements("a.*(login|signin|register)")\` - Find links\n- \`grep_elements("form")\` - Find forms\n\n**Element Format:** \`[nodeId] <C/T> <tag> "text" attributes\`\n- \`<C>\` = Clickable element, \`<T>\` = Typeable element\n- Executor agent extracts [nodeId] for click(nodeId) and type(nodeId, text) calls\n\n**Progressive Discovery Strategy:**\n1. Check browser state for visible elements first\n2. Use grep_elements with specific patterns when elements not visible\n3. Try broader patterns if specific ones fail\n4. Fall back to visual_click/visual_type with descriptions\n\n**IMPORTANT:** Do not reference specific nodeIds in your proposed actions. Let the executor agent discover and use the appropriate nodeIds through browser state or grep_elements.\n\n# MCP SERVICES (PREFERRED FOR GOOGLE/NOTION TASKS) AVAILABLE TO THE EXECUTOR AGENT\n\n- Google Calendar: event management and scheduling\n- Gmail: email search, reading, and sending\n- Google Sheets: spreadsheet reading, writing, and formulas\n- Google Docs: document reading, writing, and formatting\n- Notion: note and database management\n\n**Always prefer MCP for these services over browser automation when possible.**\nExample: Use "Use MCP to search Gmail for unread emails" instead of "Navigate to gmail.com".\n\n# EXAMPLES OF EFFECTIVE (GOOD) ACTIONS\n\n- Use VibeBrowser info tool to retrieve agent details\n- Use MCP to search Gmail for unread emails\n- Use MCP to get today's Google Calendar events\n- Use MCP to read data from a specific Google Sheet\n- Navigate to "https://example.com/login"\n- Fill the email field with "user@example.com"\n- Click the submit button\n- Use visual click on the blue submit button (if standard click has failed previously)\n- Click the Close icon in the popup modal\n- Type "Farmhouse Pepperoni Pizza" into the search bar (if the search bar is visible in browser state)\n- Use MCP to create a new event in Google Calendar\n\n# EXAMPLES OF INEFFECTIVE (BAD) ACTIONS\n\n- Click element [123] (do not reference node IDs directly; executor agent determines this)\n- Type into nodeId 456 (do not reference node IDs directly; executor agent determines this)\n- Add Farmhouse Pepperoni Pizza to the cart when the button is not visible in browser state (instead, scroll down, check updated state and then propose the action)\n- Navigate to a generic site (e.g., "Go to a pizza website") without specifying the actual URL\n\n# TODO MANAGEMENT RULES\n\n- Work on ONE TODO at a time (the first uncompleted one)\n- Mark a TODO complete ONLY when browser state confirms it's done\n- A TODO may require multiple actions or multiple attempts\n- If a TODO fails after 3 attempts, mark it with [!] and move on\n- Update format: "- [ ] Pending", "- [x] Complete", "- [!] Failed"\n\n# OUTPUT FORMAT\nYour output must be in string format with these sections:\n\n- Action Reasoning: Step-by-step reasoning through the current TODO item, considering what has been attempted, the latest browser state and screenshot, and what needs to be done next to complete this TODO item.\n- TODO Markdown: Updated TODO list with completed items marked [x], failed items marked [!], and current focus clearly identified.\n- Proposed Actions: List 1-5 specific, high-level actions for the executor agent to perform next to complete the current TODO item (must be an empty array if \`allTodosComplete=true\`. Each action should be clear, actionable, and grounded in your reasoning based on the latest browser state and screenshot.\n- Task Complete: true/false  Set to true only if all TODO items are completed ([x] or [!]) and no further actions are needed.\n- Final Answer: If \`allTodosComplete=true\`, provide a complete, direct answer to the user's request (include any relevant data or results and summary of TODO completion status). Leave empty otherwise. Answer must be grounded in latest browser state and screenshot.\n\nRemember: You are the predefined plan executor for VibeBrowser Agent. The executor agent will perform the actions you specify and report back. Use their feedback to adapt your plan and update TODO progress until all items are complete.`}(this.toolDescriptions||""),c=u.countMessage(new l.tn(o)),d=u.countMessage(new l.HumanMessage(i));if(t.y7.log("LocalAgent",`Full execution history tokens: ${d}`,"info"),d+c>.7*this.executionContext.getMaxTokens()){const e=await this.summarizeExecutionHistory(i);this.plannerExecutionHistory=[],this.plannerExecutionHistory.push({plannerOutput:e,toolMessages:[],plannerIterations:this.iterations-1}),i=e.summary}const h=await(0,y.O7)({temperature:.2,maxTokens:4096}),p=this._buildExecutionContext(),m=`Current TODO List:\n${n}\n\nEXECUTION METRICS:\n- Tool calls: ${e.toolCalls} (${e.errors} errors, ${r}% failure rate)\n- Observations taken: ${e.observations}\n- Time elapsed: ${(s/1e3).toFixed(1)} seconds\n${parseInt(r)>30&&e.errors>3?" HIGH ERROR RATE - Current approach may be failing. Learn from the past execution history and adapt your approach":""}\n\n${p}\n\nYOUR PREVIOUS STEPS DONE SO FAR (what you thought would work):\n${i}\n\nContinue upon your previous steps what has been done so far and suggest next steps to complete the current TODO item.\n`,g=u.countMessage(new l.HumanMessage(m)),f=await this._getBrowserStateMessage(this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),!0,"large",!0,.8*(this.executionContext.getMaxTokens()-c-g)),_=[new l.tn(o),new l.HumanMessage(m),f],b=await(0,R.D)(h,_,3,{signal:this.executionContext.abortSignal}),w=b?.content||"",v=Ke(w),E=function(e){const t=e.toLowerCase(),n=t.match(/\n.*?todo.*?markdown.*?/i);if(!n)return"";const r=n.index+n[0].length,s=[/\n.*?proposed.*?actions?.*?/i,/\n.*?task.*?complete.*?/i,/\n.*?final.*?answer.*?/i];let i=e.length;for(const e of s){const n=t.slice(r).match(e);if(n&&void 0!==n.index){const e=r+n.index;e<i&&(i=e)}}return e.slice(r,i).trim()}(w),S=We(w),x=Ve(w),k={reasoning:v,todoMarkdown:E,proposedActions:S,taskComplete:x,finalAnswer:Je(w)},T={reasoning:k.reasoning,todoMarkdown:k.todoMarkdown,proposedActions:k.proposedActions,taskComplete:k.taskComplete,finalAnswer:k.finalAnswer};return this.executionContext.addReasoning(JSON.stringify(T)),this._publishMessage(k.todoMarkdown,"thinking"),this.executionContext.setTodoList(k.todoMarkdown),this.pubsub.publishMessage(a.Gd.createMessage(k.reasoning,"thinking")),t.y7.log("LocalAgent",k.taskComplete?"Predefined Planner: All TODOs complete with final answer":"Predefined Planner: actions planned for current TODO","info"),{ok:!0,output:k}}catch(e){return this.executionContext.incrementMetric("errors"),{ok:!1,error:`Predefined planning failed: ${e instanceof Error?e.message:String(e)}`}}}_buildPlannerExecutionHistory(){return 0===this.plannerExecutionHistory.length?"No execution history yet":this.plannerExecutionHistory.map((e,t)=>{let n="";if("summary"in e.plannerOutput){const t=e.plannerOutput;return`=== ITERATIONS 1-${e.plannerIterations} SUMMARY ===\n${t.summary}`}if("todoMarkdown"in e.plannerOutput){const t=e.plannerOutput;n=`PLANNER OUTPUT:\n- Reasoning: ${t.reasoning}\n- TODO Markdown: ${t.todoMarkdown}\n- Proposed Actions: ${t.proposedActions}`}else{const t=e.plannerOutput;n=`PLANNER OUTPUT:\n- Reasoning: ${t.reasoning}\n- Proposed Actions: ${t.proposedActions}`}const r=e.toolMessages.length>0?`TOOL EXECUTIONS:\n${e.toolMessages.join("\n")}`:"No tool executions";return`=== ITERATION ${e.plannerIterations} ===\n${n}\n\n${r}`}).join("\n\n")}async summarizeExecutionHistory(e){const t=e.split("\n").filter(e=>!/^[-*]\s*Reasoning[:]?/i.test(e.trim())&&!/^[-*]\s*TODO Markdown[:]?/i.test(e.trim())&&!/^[-*]\s*Proposed Actions[:]?/i.test(e.trim())).join("\n"),n=await(0,y.O7)({temperature:.2,maxTokens:4096}),r=`Execution History: ${t}`,s=[new l.tn("You are an execution history summarizer. Your job is to create concise summaries of browser automation task execution history.\n\n## Your Task:\nReview the full execution history and summarize:\n- What the user wanted to accomplish\n- Key actions that were attempted\n- What succeeded and what failed\n- Important patterns or repeated issues\n- Current status and next steps needed\n\n## Input Format:\nYou'll receive execution history showing multiple iterations with:\n- Planner outputs and reasoning\n- Tool executions and results\n- Browser state changes\n- Error patterns and successes\n\n## Output:\nProvide a clear, concise summary focusing on:\n- Overall progress toward user's goal\n- Effective vs ineffective approaches tried\n- Patterns in failures or success\n- Current browser state and position\n- What should be tried next\n\nKeep the summary focused and actionable for planning next steps."),new l.HumanMessage(r)],i=await(0,R.D)(n,s,3,{signal:this.executionContext.abortSignal});return{summary:(i?.content||"").trim()}}_buildExecutionContext(e=null,t=null){return e&&"todoMarkdown"in e?this._buildPredefinedExecutionContext(e,t):this._buildDynamicExecutionContext(e,t)}_buildPredefinedExecutionContext(e=null,t=null){const n=this.executionContext.supportsVision(),r=n?"<screenshot-analysis>\n  The screenshot shows the webpage with nodeId numbers overlaid as visual labels on elements.\n  These appear as numbers in boxes/labels (e.g., [21], [42], [156]) directly on the webpage elements.\n  YOU MUST LOOK AT THE SCREENSHOT FIRST to identify which nodeId belongs to which element.\n</screenshot-analysis>":"<text-only-analysis>\n  You are operating in TEXT-ONLY mode without screenshots.\n  Use the browser state text to identify elements by their nodeId, text content, and attributes.\n  If the element is not visible in the browser state (truncated or hidden elements), use grep_elements tool to find element followed by relevant click/type/select actions.\n  Focus on element descriptions and hierarchical structure in the browser state.\n</text-only-analysis>",s=n?"<visual-execution-process>\n  1. EXAMINE the screenshot - See the webpage with nodeId labels overlaid on elements\n  2. LOCATE the element you need to interact with visually\n  3. IDENTIFY its nodeId from the label shown on that element in the screenshot\n  4. EXECUTE using that nodeId in your tool call\n</visual-execution-process>":"<text-execution-process>\n  1. ANALYZE the text-based browser state to identify the element you need to interact with\n  2. Search with grep_elements tool using regex patterns to find elements if the element is not visible in the browser state (truncated or hidden elements)\n  3. Identify the [nodeId] from the grep results or the browser state\n  4. EXECUTE NODE_ID in your tool call\n  NEVER guess nodeIds - USE BROWSER STATE OR GREP RESULTS TO IDENTIFY THE NODE_ID\n</text-execution-process>",i=n?"<execution-guidelines>\n  - The nodeIds are VISUALLY LABELED on the screenshot - you must look at it\n  - The text-based browser state is supplementary - the screenshot is your primary reference\n  - Batch multiple tool calls in one response when possible (reduces latency)\n  - Call 'done' when the current actions are completed\n</execution-guidelines>":"<execution-guidelines>\n  - Use the text-based browser state or grep results (if applicable) as your primary reference\n  - Match elements by their text content and attributes\n  - Batch multiple tool calls in one response when possible (reduces latency)\n  - Call 'done' when the current actions are completed\n</execution-guidelines>";let a="";e&&(a=`<predefined-plan-context>\n  <reasoning>${e.reasoning}</reasoning>\n</predefined-plan-context> `);let o="";return t&&(o=`<actions-to-execute>\n${t.map((e,t)=>`    ${t+1}. ${e}`).join("\n")}\n  </actions-to-execute>\n`),`${a}<execution-instructions>\n${r}\n${s}\n<element-format>\nElements appear as: [nodeId] <indicator> <tag> "text" context\n\nLegend:\n- [nodeId]: Use this number in click/type calls\n- <C>/<T>: Clickable or Typeable\n</element-format>\n${i}\n${o}\n</execution-instructions>`}_formatPlannerOutputForExecutor(e){return`VibeBrowser Agent Output:\n- Reasoning: ${e.reasoning}\n\n# Actions (to be performed by you)\n${e.proposedActions}\n`}_buildDynamicExecutionContext(e=null,t=null){const n=this.executionContext.supportsVision()&&this.executionContext.isLimitedContextMode(),r=n?"<screenshot-analysis>\n  You are provided with a screenshot of the webpage. Each interactive element is visually labeled with a nodeId (e.g., [21], [42], [156]) directly on the element.\n  - The screenshot is your PRIMARY reference for identifying elements.\n  - The browser state text is available as a supplementary resource, but you must always use the screenshot to determine the correct nodeId.\n  - NodeIds are visually overlaid as numbers in boxes/labels on the elements themselves.\n  - Pay attention to the visual context, layout, and grouping of elements to accurately identify the target.\n  - If multiple elements have similar text, use their position and visual grouping to distinguish them.\n</screenshot-analysis>":"<text-only-analysis>\n  You are operating in TEXT-ONLY mode (no screenshots available).\n  - Use the browser state text to understand the current state of the webpage and to identify the relevant element for interaction.\n  - The browser state may be truncated or have hidden elements; always check for missing or incomplete information.\n  - If the element you need is not visible in the browser state, use the grep_elements tool to search for it by text, tag, or attribute.\n  - Focus on element descriptions, their hierarchical structure, and any unique attributes or text to identify the correct element.\n  - Be methodical: always confirm the nodeId before taking any action.\n</text-only-analysis>",s=n?"<visual-execution-process>\n  1. EXAMINE the screenshot carefully to see all elements with their nodeId labels.\n  2. LOCATE the element you need to interact with by visually matching its appearance, text, and position.\n  3. IDENTIFY the nodeId from the label shown directly on the element in the screenshot.\n  4. EXECUTE your tool call using the identified nodeId (never guess).\n  5. Batch multiple tool calls in one response when possible to reduce latency.\n  6. Call 'done' when all actions are completed.\n  - If you are unsure about an element, cross-reference with the browser state text for additional context.\n</visual-execution-process>":'<text-execution-process>\n  1. ANALYZE the text-based browser state to find the element you need to interact with.\n  2. If the element is not visible or the browser state is incomplete, use the grep_elements tool with appropriate regex patterns to search for the element.\n      - Example patterns: grep_elements("button.*(login|submit)"), grep_elements("input.*(email|password)")\n      - If no results, try broader patterns like "button" or "input"\n  3. From the grep_elements results or browser state, extract the [nodeId] (e.g., [42] <C> <button> "Login").\n  4. EXECUTE your tool call using the precise nodeId you have found.\n  5. NEVER guess nodeIds  always confirm using browser state or grep_elements results.\n  6. Batch multiple tool calls in one response when possible to reduce latency.\n  7. Call \'done\' when all actions are completed.\n</text-execution-process>';let i="";e&&(i=`<planning-context>\n  <reasoning>${e.reasoning}</reasoning>\n</planning-context>\n`);let a="";return t&&(a=`<actions-to-execute>\n${t.map((e,t)=>`    ${t+1}. ${e}`).join("\n")}\n</actions-to-execute>\n`),`${i}<execution-instructions>\n${r}\n${s}\n<element-format>\nElements appear as: [nodeId] <indicator> <tag> "text" context\n\nLegend:\n- [nodeId]: Use this number in click/type calls\n- <C>/<T>: Clickable or Typeable\n</element-format>\n${a}\n</execution-instructions>`}}Ze.GLOW_ENABLED_TOOLS=new Set(["click","type","clear","moondream_visual_click","moondream_visual_type","scroll","navigate","key","tab_open","tab_focus","tab_close","extract"]);const Xe=o.Ik({userTask:o.Yj().describe("Restate the user's request in your own words for clarity"),executionHistory:o.Yj().describe("Briefly outline what actions have already been attempted, including any failures or notable outcomes"),currentState:o.Yj().describe("Summarize the current browser state, visible elements, and any relevant context from the screenshot"),challengesIdentified:o.Yj().describe("List any obstacles, errors, or uncertainties that may impact progress (e.g., high error rate, missing elements, repeated failures)"),stepByStepReasoning:o.Yj().describe("Think step by step through the problem, considering the user's goal, the current state, what has and hasn't worked, and which tools or strategies are most likely to succeed next. Justify your approach"),proposedActions:o.YO(o.Yj()).max(5).describe("List 1-5 specific, high-level actions for the executor agent to perform next (must be an empty array if `taskComplete=true`. Each action should be clear, actionable, and grounded in your reasoning"),taskComplete:o.zM().describe("Set to true only if the user's request is fully satisfied and no further actions are needed"),finalAnswer:o.Yj().describe("If `taskComplete=true`, provide a complete, direct answer to the user's request (include any relevant data or results). Leave empty otherwise")}),Qe=o.Ik({summary:o.Yj().describe("Summary of the execution history")});class et{constructor(e){this.executorLlmWithTools=null,this.iterations=0,this.plannerExecutionHistory=[],this.toolDescriptions="Available tools:\n- click: Click on elements on the page\n- type: Type text into input fields\n- clear: Clear text from input fields\n- scroll: Scroll page or to specific elements\n- navigate: Navigate to web pages\n- key: Send keyboard inputs\n- wait: Wait for page loading and stability\n- todo_set: Manage TODO lists\n- todo_get: Retrieve current TODO list\n- tabs: List browser tabs\n- tab_open: Open new browser tabs\n- tab_focus: Switch between tabs\n- tab_close: Close browser tabs\n- extract: Extract data from web pages\n- celebration: Show confetti animation\n- human_input: Request human assistance\n- done: Mark tasks as complete\n- visual_click: Click elements using visual descriptions\n- visual_type: Type into fields using visual descriptions\n- click_at_coordinates: Click at specific locations\n- type_at_coordinates: Type at specific locations\n- date: Get current date and time\n- vibebrowser_info: Get information about the VibeBrowser agent\n- mcp: Access external services (Gmail, GitHub, etc.)",this.executionContext=e,this.toolManager=new C(e),this.glowService=Ye.getInstance(),this.mainPubsub=a.Gd.getChannel("main"),t.y7.log("TeachAgent","TeachAgent instance created","info")}get executorMessageManager(){return this.executionContext.messageManager}get pubsub(){return this.executionContext.getPubSub()}checkIfAborted(){if(this.executionContext.abortSignal.aborted)throw new A}_emitTeachModeEvent(e,t){this.mainPubsub.publishTeachModeEvent({eventType:e,sessionId:this.executionContext.executionId,data:t})}_emitThinking(e,t){this._emitTeachModeEvent("execution_thinking",{msgId:e,content:t,timestamp:Date.now()})}async _initialize(){await this._registerTools();const e=await(0,y.O7)({temperature:.2,maxTokens:4096});if(!e.bindTools||"function"!=typeof e.bindTools)throw new Error("This LLM does not support tool binding");this.executorLlmWithTools=e.bindTools(this.toolManager.getAll()),this.iterations=0,t.y7.log("TeachAgent",`Initialization complete with ${this.toolManager.getAll().length} tools bound`,"info")}async _registerTools(){this.toolManager.register(D(this.executionContext)),this.toolManager.register(Y(this.executionContext)),this.toolManager.register(B(this.executionContext)),this.toolManager.register(me(this.executionContext)),this.toolManager.register(fe(this.executionContext)),this.toolManager.register(z(this.executionContext)),this.toolManager.register(K(this.executionContext)),this.toolManager.register(V(this.executionContext)),this.toolManager.register(Z(this.executionContext)),this.toolManager.register(Q(this.executionContext)),this.toolManager.register(te(this.executionContext)),this.toolManager.register(re(this.executionContext)),this.toolManager.register(ie(this.executionContext)),this.toolManager.register($e(this.executionContext)),this.toolManager.register(Pe(this.executionContext)),this.toolManager.register(oe(this.executionContext)),this.toolManager.register(le(this.executionContext)),this.toolManager.register(Fe(this.executionContext)),this.toolManager.register(Le(this.executionContext)),this.toolManager.register(Oe(this.executionContext)),this.toolManager.register(de(this.executionContext)),t.y7.log("TeachAgent",`Registered ${this.toolManager.getAll().length} tools`,"info")}async execute(e){try{this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),startTime:Date.now()});const n=e;t.y7.log("TeachAgent",`Starting execution with workflow: ${n.metadata.goal}`,"info"),await this._initialize(),await this._executeDynamic(n)}catch(e){throw this._handleExecutionError(e),e}finally{this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),endTime:Date.now()}),this._logMetrics(),this._cleanup();try{const e=await this.glowService.getAllActiveGlows();for(const t of e)await this.glowService.stopGlow(t)}catch(e){}}}async _executeDynamic(e){if(this.executionContext.setCurrentTask(e.metadata.goal),!this.executorLlmWithTools)throw new Error("LLM with tools not initialized");let n=!1;for(this._emitTeachModeEvent("execution_started",{workflowId:e.metadata.recordingId||"",goal:e.metadata.goal,totalSteps:e.steps.length});!n&&this.iterations<50;){this.checkIfAborted(),this.iterations++,t.y7.log("TeachAgent",`Planning iteration ${this.iterations}/50`,"info");const r=await this._runDynamicPlanner(e);if(!r.ok){t.y7.log("TeachAgent",`Planning failed: ${r.error}`,"error");continue}const s=r.output,i=a.Gd.generateId("teach_thinking");if(this._emitThinking(i,s.stepByStepReasoning),s.taskComplete){n=!0;const t=s.finalAnswer||"Task completed successfully";this.mainPubsub.publishTeachModeEvent({eventType:"execution_completed",sessionId:this.executionContext.executionId,data:{workflowId:e.metadata.recordingId||"",success:!0,message:t}});break}if(!s.proposedActions||0===s.proposedActions.length){t.y7.log("NewAgent","Planner provided no actions but task not complete","warning");continue}t.y7.log("NewAgent",`Executing ${s.proposedActions.length} actions from plan`,"info");if((await this._runExecutor(s.proposedActions,s)).requiresHumanInput){if("abort"===await this._waitForHumanInput())throw this.pubsub.publishMessage(a.Gd.createMessage("Task aborted by human","assistant")),new A("Task aborted by human");const e=a.Gd.generateId("teach_thinking");this._emitThinking(e,"Human completed manual action. Re-planning..."),this.executionContext.clearHumanInputState()}}if(!n&&this.iterations>=50)throw this._emitTeachModeEvent("execution_failed",{error:"Maximum planning iterations (50) reached",reason:"iteration_limit"}),new Error("Maximum planning iterations (50) reached")}async _getBrowserStateMessage(e,t=!0,n="large",r=!0){let s=null;if(r&&(s=await this.executionContext.browserContext.getBrowserStateString(t)),e&&this.executionContext.supportsVision()){const e=await this.executionContext.browserContext.getCurrentPage(),t=await e.takeScreenshot(n,r);if(t){const e=[];r&&null!==s&&e.push({type:"text",text:`<browser-state>${s}</browser-state>`}),e.push({type:"image_url",image_url:{url:t}});const n=new l.HumanMessage({content:e});return n.additional_kwargs={messageType:h.BROWSER_STATE},n}}if(r&&null!==s){const e=new l.HumanMessage(`<browser-state>${s}</browser-state>`);return e.additional_kwargs={messageType:h.BROWSER_STATE},e}const i=new l.HumanMessage("");return i.additional_kwargs={messageType:h.BROWSER_STATE},i}async _runDynamicPlanner(e){try{this.executionContext.incrementMetric("observations");const n=await this._getBrowserStateMessage(this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),!0,"large",!0),r=this.executionContext.getExecutionMetrics(),s=r.toolCalls>0?(r.errors/r.toolCalls*100).toFixed(1):"0",i=Date.now()-r.startTime;let a=this._buildPlannerExecutionHistory();const o=function(e=""){return`# Context\nYou are VibeBrowser Agent which helps the user to automate their tasks in the browser. Your primary responsibility is to analyze the user's query, the USER-DEMONSTRATED WORKFLOW (semantic trajectory), the full execution history (all previous actions, attempts, and failures), and the current browser state (including screenshot), and then suggest immediate actionable next steps to achieve the user's objective *based on the current browser state and screenshot*.\n\nYou do NOT perform actions yourself. Your role is to propose clear, actionable next steps for the EXECUTOR AGENT, who will execute these actions in the browser, report back with results, errors, and updated observations, including the latest browser state and screenshot. Use this feedback to continually refine your strategy and guide the executor agent toward successful completion of the user's task.\n\n## USER-DEMONSTRATED WORKFLOW (SEMANTIC TRAJECTORY)\n\nYou will receive a **SEMANTIC WORKFLOW** - a rich, preprocessed representation of what the user demonstrated in their browser. This is NOT a script to follow literally, but **INTELLIGENT REFERENCE CONTEXT** that shows:\n\n### What You'll Receive:\n\`\`\`typescript\n{\n  metadata: {\n    name: "Gmail Unsubscribe",  // Concise workflow name\n    goal: "Open Gmail, identify all newsletter emails, and unsubscribe from all remaining newsletters",  // What user wants YOU to accomplish\n    description: "User demonstrated navigating to Gmail, accessing promotions tab, identifying newsletter emails, and unsubscribing",  // What user showed\n    transcript: "I went to Gmail, found newsletter emails, and unsubscribed from one..."  // Optional voice narration\n  },\n  steps: [\n    {\n      id: "step-1",\n      intent: "Navigate to Gmail inbox",  // CORE GOAL of this step\n      action: {\n        type: "navigate",  // Action type (navigate, click, type, etc.)\n        description: "Navigate to gmail.com to access email inbox",  // Human-readable what-to-do\n        nodeIdentificationStrategy: null,  // How to find element (null for non-interactive actions)\n        validationStrategy: "Check URL contains gmail.com and inbox is visible",  // How to verify success\n        timeoutMs: 5000\n      }\n    },\n    {\n      id: "step-2",\n      intent: "Access promotions tab to filter newsletter emails",\n      action: {\n        type: "click",\n        description: "Click on the promotions tab to show newsletter emails",\n        nodeIdentificationStrategy: "Tab labeled 'Promotions' in the left sidebar below the compose button",  // CONTEXT for finding element\n        validationStrategy: "Promotions tab is active/highlighted and newsletter emails are visible in the list",\n        timeoutMs: 5000\n      }\n    },\n    {\n      id: "step-3",\n      intent: "Select a newsletter email to unsubscribe",\n      action: {\n        type: "click",\n        description: "Click on a newsletter email from the list to open it",\n        nodeIdentificationStrategy: "Email item in the promotions list with sender name indicating newsletter/marketing",\n        validationStrategy: "Email opens showing full content with unsubscribe option visible",\n        timeoutMs: 5000\n      }\n    }\n  ]\n}\n\`\`\`\n\n### How to Use This Semantic Workflow:\n\n1. **metadata.goal** - The ULTIMATE OBJECTIVE you must achieve (may differ from what was demonstrated)\n2. **metadata.description** - What the user showed you (the demonstration)\n3. **steps[].intent** - WHY each step exists (the purpose/goal of that action)\n4. **steps[].action.description** - WHAT to do in human terms\n5. **steps[].action.nodeIdentificationStrategy** - CONTEXT for finding elements (NOT exact selectors)\n6. **steps[].action.validationStrategy** - How to VERIFY success\n\n**CRITICAL DISTINCTIONS:**\n- **metadata.description** = What user DEMONSTRATED (sample workflow)\n- **metadata.goal** = What user wants YOU to DO (actual task)\n- These may be SAME (repeat exact workflow) or DIFFERENT (apply pattern with modifications)\n\n**Example:**\n- Description: "User demonstrated searching for ONE YC startup"\n- Goal: "Search for ALL YC W24 companies and add to spreadsheet"\n You must SCALE the demonstrated pattern, not just repeat it once\n\n# YOUR ROLE\n\n- Analyze the user's query, demonstrated semantic workflow (to understand intent), past execution history (what has been attempted and what failed), and current browser state (including screenshot) in depth.\n- Use the semantic workflow as **SMART GUIDANCE** - understand the intent, approach, and patterns, then ADAPT them to current reality.\n- Based on this analysis, generate a precise, actionable and adaptive plan (1-5 high-level actions) for the executor agent to perform next.\n- After each round of execution, review the history and updated state, and refine your plan and suggest next steps as needed.\n- When the task is fully complete, provide a final answer and set \`taskComplete=true\`. Answer must be grounded based on latest browser state and screenshot.\n\n# STEP BY STEP REASONING\n\n1. **Analysis of User Query, Demonstrated Workflow, Execution History and Current/Updated Browser State:**\n  1.1 **Understand the demonstrated workflow:** Review the semantic workflow to understand the user's approach, intent behind each step, and the overall pattern they showed.\n  1.2 **Identify the actual goal:** Check metadata.goal to understand what the user wants YOU to accomplish (may differ from the demonstration).\n  1.3 **Analyze execution history:** Review past execution history (what has been attempted and what failed) in context of the demonstrated workflow.\n  1.4 **Assess current state:** Reflect on the latest browser state and screenshot whether it matches the expected outcome from the execution history and demonstrated workflow. Source of truth is the latest browser state and screenshot.\n\n2. **Generation of Plan:**\n  2.1 **Ground plans in reality:** Only propose actions that are possible given the current/updated browser state and screenshot. Use the semantic workflow's intent and nodeIdentificationStrategy as CONTEXT, not literal instructions. For example, if workflow shows "Click promotions tab" but you're already in promotions tab, SKIP to the next intent. If you suggest an action that is not possible given the current/updated browser state and screenshot, you will be penalized.\n  2.2 **Adapt demonstrated patterns intelligently:** Use the workflow's action.description and action.nodeIdentificationStrategy to understand WHAT to do and HOW to find elements, but adapt to current page structure. For example: Workflow shows "Tab labeled 'Promotions' in left sidebar"  Adapt to actual Gmail interface visible in screenshot.\n  2.3 **Be specific, actionable, and tool-based:** Clearly state what the executor agent should do, using direct and unambiguous instructions grounded in the current/updated browser state (e.g., "Navigate to gmail.com" instead of "Go to email"). Frame actions in terms of available tools, such as "Click the promotions tab", "Type 'machine learning' into the search bar", or "Use MCP to search Gmail for unread emails".\n  2.4 **High level actions:** Propose high-level actions that are directly executable by the executor agent. For example, "Navigate to gmail.com" instead of "Go to email site". Do not suggest low-level actions like "Click element [123]" or "Type into nodeId 456" [NODE IDS are better determined by the executor agent as its the one who will perform the action]\n  2.5 **Leverage validation strategies:** Use the action.validationStrategy from semantic workflow to understand success criteria, but verify against actual browser state.\n  2.6 **Scale when needed:** If metadata.goal indicates repetition or scaling (e.g., "do this for ALL items" vs demonstration of "one item"), adapt your plan accordingly.\n  2.7 **Conclude when done:** Mark \`taskComplete=true\` and provide a final answer only when the user's request is fully satisfied and no further actions are needed.\n\n3. **Adaptive Learning:**\n  3.1 Continuously review which actions the executor agent has already tried, and how successful they were. If previous actions did not achieve the desired result, revise your plan and propose new, alternative steps. Use the semantic workflow as inspiration, but don't rigidly follow it if it's not working.\n  3.2 Always base your next plan on the most recent browser state and screenshot. If the current browser state or screenshot does not match the expected outcome from the execution history, update your plan accordingly. Treat the current browser state and screenshot as the definitive source of truth, and ensure all proposed actions are grounded in what is actually visible and available now.\n\n# SEMANTIC WORKFLOW INTERPRETATION EXAMPLES\n\n## Example 1: Navigation Pattern - Direct Optimization\n**Semantic Workflow Received:**\n\`\`\`json\n{\n  "metadata": {\n    "goal": "Navigate to Hacker News and view top 3 articles",\n    "description": "User searched for 'Hacker News' on Google and clicked the first result"\n  },\n  "steps": [\n    {"intent": "Search for Hacker News website", "action": {"type": "type", "description": "Type 'Hacker News' into Google search"}},\n    {"intent": "Navigate to search results", "action": {"type": "click", "description": "Click Google search button"}},\n    {"intent": "Access Hacker News website", "action": {"type": "click", "description": "Click first search result link"}}\n  ]\n}\n\`\`\`\n\n**Your Smart Interpretation:**\n- **Core Intent:** User wants to reach news.ycombinator.com\n- **Optimization:** Skip the Google search steps entirely\n- **Your Plan:** ["Navigate directly to https://news.ycombinator.com"]\n\n## Example 2: Scaled Pattern - Repetition Required\n**Semantic Workflow Received:**\n\`\`\`json\n{\n  "metadata": {\n    "goal": "Unsubscribe from ALL newsletter emails in Gmail promotions",\n    "description": "User demonstrated unsubscribing from ONE newsletter"\n  },\n  "steps": [\n    {"intent": "Open promotions tab", "action": {"type": "click", "nodeIdentificationStrategy": "Promotions tab in left sidebar"}},\n    {"intent": "Select newsletter email", "action": {"type": "click", "nodeIdentificationStrategy": "Email from sender with newsletter/marketing indicator"}},\n    {"intent": "Unsubscribe from newsletter", "action": {"type": "click", "nodeIdentificationStrategy": "Unsubscribe link at bottom of email"}}\n  ]\n}\n\`\`\`\n\n**Your Smart Interpretation:**\n- **Core Intent:** Apply unsubscribe pattern to ALL newsletters (not just one)\n- **Scaling Needed:** metadata.goal says "ALL" but demonstration shows "ONE"\n- **Your Plan:** Repeat the pattern for each newsletter until none remain\n\n## Example 3: Contextual Adaptation - Current State Check\n**Semantic Workflow Received:**\n\`\`\`json\n{\n  "steps": [\n    {"intent": "Navigate to product page", "action": {"type": "navigate", "description": "Go to amazon.com/product"}},\n    {"intent": "Add product to cart", "action": {"type": "click", "nodeIdentificationStrategy": "Orange 'Add to Cart' button on right side"}}\n  ]\n}\n\`\`\`\n\n**Current Browser State:** Already on amazon.com/product page, "Add to Cart" button visible\n\n**Your Smart Interpretation:**\n- **Skip navigation:** Already on target page\n- **Your Plan:** ["Click the 'Add to Cart' button"] (skip step 1, execute step 2)\n\n# AVAILABLE BROWSER AUTOMATION TOOLS FOR THE EXECUTOR AGENT\n\n${e}\n\n# MCP SERVICES (PREFERRED FOR GOOGLE/NOTION TASKS) AVAILABLE TO THE EXECUTOR AGENT\n\n- Google Calendar: event management and scheduling\n- Gmail: email search, reading, and sending\n- Google Sheets: spreadsheet reading, writing, and formulas\n- Google Docs: document reading, writing, and formatting\n- Notion: note and database management\n\n**Always prefer MCP for these services over browser automation when possible.**\nExample: Use "Use MCP to search Gmail for unread emails" instead of "Navigate to gmail.com".\n\n# EXAMPLES OF EFFECTIVE (GOOD) ACTIONS\n\n- Use VibeBrowser info tool to retrieve agent details\n- Use MCP to search Gmail for unread emails\n- Use MCP to get today's Google Calendar events\n- Use MCP to read data from a specific Google Sheet\n- Navigate to "https://example.com/login"\n- Fill the email field with "user@example.com"\n- Click the submit button\n- Use visual click on the blue submit button (if standard click has failed previously)\n- Click the Close icon in the popup modal\n- Type "Farmhouse Pepperoni Pizza" into the search bar (if the search bar is visible in screenshot)\n- Use MCP to create a new event in Google Calendar\n\n# EXAMPLES OF INEFFECTIVE (BAD) ACTIONS\n\n- Click element [123] (do not reference node IDs directly; executor agent determines this)\n- Type into nodeId 456 (do not reference node IDs directly; executor agent determines this)\n- Add Farmhouse Pepperoni Pizza to the cart when the button is hidden in the screenshot (instead, scroll down, check updated screenshot and then propose the action)\n- Navigate to a generic site (e.g., "Go to a pizza website") without specifying the actual URL\n\n# OUTPUT FORMAT\nYour output must follow this structured, step-by-step format to demonstrate clear chain-of-thought (CoT) reasoning before proposing actions:\n\n1. **userTask:** Restate the user's request in your own words for clarity.\n2. **executionHistory:** Briefly outline what steps have already been tried, including any failures or notable outcomes.\n3. **latestBrowserState:** Summarize the latest browser state, visible elements, and any relevant context from the screenshot.\n4. **stepByStepReasoning:** Think step by step through the problem, considering the user's goal, the demonstrated workflow intent, past execution steps (what has been attempted) and reflect on the latest browser state and screenshot whether it is successful or not. What should be done next. Justify your approach by referencing relevant workflow intents when applicable. Actions must be grounded in the latest browser state and screenshot.\n5. **proposedActions:** List 1-5 specific, high-level actions for the executor agent to perform next (must be an empty array if \`taskComplete=true\`. Each action should be clear, actionable, and grounded in your reasoning based on the latest browser state and screenshot.\n6. **taskComplete:** true/false  Set to true only if the user's request is fully satisfied and no further actions are needed.\n7. **finalAnswer:** If \`taskComplete=true\`, provide a complete, direct answer to the user's request (include any relevant data or results). Leave empty otherwise. Answer must be grounded in latest browser state and screenshot.\n\nRemember: You are the planner agent for VibeBrowser Agent. The semantic workflow shows you the user's intent and approach. Use it as intelligent guidance to understand WHAT they want and HOW they think about it, then achieve the goal using the smartest approach based on current browser reality. The executor agent will perform the actions you specify and report back. Use their feedback to adapt your plan until the task is complete.`}(this.toolDescriptions||""),c=u.countMessage(new l.tn(o)),d=u.countMessage(new l.HumanMessage(a));if(t.y7.log("TeachAgent",`Full execution history tokens: ${d}`,"info"),d+c>.7*this.executionContext.getMaxTokens()){const e=await this.summarizeExecutionHistory(a);a=e.summary,this.plannerExecutionHistory=[],this.plannerExecutionHistory.push({plannerOutput:e,toolMessages:[],plannerIterations:this.iterations-1})}t.y7.log("TeachAgent",`Full execution history: ${a}`,"info");const h=(await(0,y.O7)({temperature:.2,maxTokens:4096})).withStructuredOutput(Xe),p=`TASK: ${e.metadata.goal}\n\nEXECUTION METRICS:\n- Tool calls: ${r.toolCalls} (${r.errors} errors, ${s}% failure rate)\n- Observations taken: ${r.observations}\n- Time elapsed: ${(i/1e3).toFixed(1)} seconds\n${parseInt(s)>30?" HIGH ERROR RATE - Current approach may be failing":""}\n${r.toolCalls>10&&r.errors>5?" MANY ATTEMPTS - May be stuck in a loop":""}\n\nYOUR PREVIOUS STEPS DONE SO FAR (what you thought would work):\n${a}\n`,m=e.steps.map(e=>({intent:e.intent,action:e.action})),g=`Contextual User Trajectory mentioned by user for reference: ${e.metadata.description} ${JSON.stringify(m)}`,f=[new l.tn(o),new l.HumanMessage(g),new l.HumanMessage(p),n],_=await(0,R.D)(h,f,3,{signal:this.executionContext.abortSignal}),b={userTask:_.userTask,currentState:_.currentState,executionHistory:_.executionHistory,challengesIdentified:_.challengesIdentified,stepByStepReasoning:_.stepByStepReasoning,proposedActions:_.proposedActions,taskComplete:_.taskComplete,finalAnswer:_.finalAnswer};return this.executionContext.addReasoning(JSON.stringify(b)),t.y7.log("TeachAgent",_.taskComplete?"Planner: Task complete with final answer":`Planner: ${_.proposedActions.length} actions planned`,"info"),{ok:!0,output:_}}catch(e){return this.executionContext.incrementMetric("errors"),{ok:!1,error:`Planning failed: ${e instanceof Error?e.message:String(e)}`}}}async _runExecutor(e,n){const r=new f;r.addSystem(`You are an autonomous Browser Automation EXECUTOR AGENT for VibeBrowser Agent which helps the user to automate their tasks in the browser.\n<executor-mode>\nYou are now operating in EXECUTION MODE. You will be provided with:\n- A brief summary of what has been done so far, including the analysis of the user task, current state, execution history, challenges, and reasoning.\n- A list of actions to perform to complete the user task.\n- The current browser state, including a screenshot for visual reference.\n\nYour primary responsibility is to interpret each action and translate it into the correct tool calls, executing them within the browser environment.\n\n# STEP BY STEP EXECUTION PROCESS\n\n1. **Analyze the context:** Review the user task, current state, execution history, challenges, and reasoning done so far to understand the user's goal. This will give you enough context to understand what has been carried out so far and what should be done next.\n2. **Use the browser state and screenshot:** Always check the browser state (including screenshot) before selecting elements or nodeIds for tool calls. Example: To click a button, look for its nodeId in the browser state before using click(nodeId).\n3. **Map actions to tools:** For each action, select the most appropriate tool(s) to accomplish it. Example: "Fill email field"  type(nodeId, "user@example.com")\n4. **Follow action order:** Execute all actions in the EXACT order provided, unless actions are clearly independent. Example: Do not click "submit" until all form fields are filled.\n5. **Batch independent actions:** If actions are independent (e.g., filling multiple fields), batch tool calls in a single response to improve efficiency. Example: Fill "email" and "password" fields together before clicking "submit" in next response.\n6. **Sequence dependent actions:** If an action requires multiple steps or tools, use them in the correct sequence. Example: Scroll to element, then click it.\n7. **Adapt on failure:** If an action fails, immediately try alternative strategies or fallback tools (such as visual_click, visual_type, etc.). Example: If click(nodeId) fails, retry with visual_click("blue submit button at bottom of form") in next response.\n8. **Complete all actions:** Do not stop until every action in the list is completed.\n\n*Example:* For example, you got actions such as ["Fill email field with user@example.com", "Fill password field with Secret123", "Click login button"]. You should do the following:\n- Understand the browser state and screenshot to identify the nodeIds of the elements.\n- Fill "email" and "password" fields (can be done in a single response if possible)\n- Click "login" button.\n- If click fails, try with alternative tool calls such as visual_click("blue submit button at bottom of form") in next response.\n- Complete all actions in the list.\n\n# ACTION MAPPING GUIDE:\n- "Navigate to [url]"  use navigate(url) tool\n- "Click [element description]"  LOOK at screenshot, find element's nodeId label, use click(nodeId)\n   If click fails or nodeId unclear  use visual_click("element description")\n- "Fill [field] with [value]"  LOOK at screenshot, find field's nodeId label, use type(nodeId, text)\n   If type fails or field not found  use visual_type("field description", text)\n- "Clear [field]"  LOOK at screenshot, find field's nodeId label, use clear(nodeId)\n- "Wait for [condition]"  use wait(seconds)\n- "Scroll to [element]"  LOOK at screenshot, find element's nodeId label, use scroll(nodeId)\n- "Press [key]"  use key(key)\n- "Extract [data]"  use extract(format, task)\n- "Submit form"  LOOK at screenshot, find submit button's nodeId label, click(nodeId)\n   If click fails  use visual_click("submit button description")\n\nCRITICAL OUTPUT RULES - NEVER VIOLATE THESE:\n1. **NEVER** output or echo content from <browser-state> tags - this is for YOUR reference only\n2. **NEVER** output or echo <system-reminder> tags or their contents\nBrowser state and system reminders are INTERNAL ONLY - treat them as invisible to the user. These should not be visible to the user.\n\nThe browser state appears in <browser-state> tags for your internal reference to understand the page.\nSystem reminders appear in <system-reminder> tags for your internal guidance.\n</executor-mode>\n\n${this._buildExecutionContext()}\n\n<element-identification>\nText-based element format (supplementary to screenshot):\n[nodeId] <C/T> <tag> "text" (visible/hidden)\n- <C> = Clickable, <T> = Typeable\n- (visible) = in viewport, (hidden) = requires scrolling\n- This text helps confirm what you see in the screenshot\nREMEMBER: The nodeId numbers in [brackets] here match the visual labels on the screenshot\n</element-identification>\n\n<fallback-strategies>\nCLICK ESCALATION STRATEGY:\n1. First attempt: Use click(nodeId) with element from screenshot\n2. If "Element not found" or "Click failed": Use visual_click with descriptive text\n3. Visual descriptions should include:\n   - Color/appearance: "blue button", "red link"\n   - Position: "top right corner", "below the header"\n   - Text content: "containing 'Submit'", "labeled 'Search'"\n   - Context: "in the login form", "next to the logo"\n   This will help to understand the element and its context. So, use this information to describe the element.\n\nWHEN TO USE VISUAL FALLBACK:\n- Error: "Element [nodeId] not found"  Immediate visual_click\n- Error: "Failed to click"  Retry with visual_click\n- Situation: NodeId unclear in screenshot  Use visual_click directly\n- Situation: Dynamic/popup elements  Prefer visual_click\n- After 2 failed regular clicks  Switch to visual approach\nFirst try to use click(nodeId) with element from screenshot. If it fails, use visual_click with descriptive text. Same for type(nodeId, text), If it fails, use visual_type with descriptive text.\n\nVISUAL DESCRIPTION BEST PRACTICES:\n "blue submit button at bottom of form"\n "search icon in top navigation bar"\n "first checkbox in the list"\n "X close button in modal corner"\n "element-123" (too technical)\n "button" (too vague)\n</fallback-strategies>\n\n<tools>\nExecution Tools:\n- click(nodeId): Click element by nodeId\n- type(nodeId, text): Type text into element\n- clear(nodeId): Clear text from element\n- scroll(nodeId?): Scroll to element OR scroll(direction, amount) for page scrolling\n- navigate(url): Navigate to URL (include https://)\n- key(key): Press keyboard key (Enter, Tab, Escape, etc.)\n- wait(seconds?): Wait for page to stabilize\n\nVisual Fallback Tools (use when DOM-based tools fail):\n- visual_click(instruction): Click element by visual description\n  Example: visual_click("blue submit button")\n- visual_type(instruction, text): Type into field by visual description\n  Example: visual_type("email input field", "user@example.com")\n\nTab Control:\n- tabs: List all browser tabs\n- tab_open(url?): Open new tab\n- tab_focus(tabId): Switch to specific tab\n- tab_close(tabId): Close tab\n\nData Operations:\n- extract(format, task): Extract structured data matching JSON schema\n\nMCP Integration:\n- mcp(action, instanceId?, toolName?, toolArgs?): Access external services (Gmail, GitHub, etc.)\n   ALWAYS follow 3-step process: getUserInstances  listTools  callTool\n   Use exact IDs and tool names from responses\n\nCompletion:\n- done(success, message): Call when ALL actions are executed successfully\n</tools>\n\n<mcp-instructions>\nMCP TOOL USAGE (for Gmail, GitHub, Slack, etc.):\nCRITICAL: Never skip steps or guess tool names. Always execute in exact order:\n\nStep 1: Get installed servers\nmcp(action: 'getUserInstances')\n Returns: {instances: [{id: 'a146...', name: 'Gmail', authenticated: true}]}\n SAVE the exact instance ID\n\nStep 2: List available tools (MANDATORY - NEVER SKIP)\nmcp(action: 'listTools', instanceId: 'exact-id-from-step-1')\n Returns: {tools: [{name: 'gmail_search_emails', description: '...'}]}\n USE exact tool names from this response\n\nStep 3: Call the tool\nmcp(action: 'callTool', instanceId: 'exact-id', toolName: 'exact-name', toolArgs: {key: value})\n toolArgs must be JSON object, not string\n\nCommon Mistakes to Avoid:\n Guessing tool names like 'gmail_list_messages'\n Skipping listTools step\n Using partial instance IDs\n Always use exact values from previous responses\n\nAvailable MCP Servers:\n- Google Calendar: Calendar operations (events, scheduling)\n- Gmail: Email operations (search, read, send)\n- Google Sheets: Spreadsheet operations (read, write, formulas)\n- Google Docs: Document operations (read, write, format)\n- Notion: Note management (pages, databases)\n\nUse MCP when task involves these services instead of browser automation.\n</mcp-instructions>`);const s=[];let i=0,a=!0;for(;i<3;){if(this.checkIfAborted(),i++,a){const e=await this._getBrowserStateMessage(this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),!0,"medium");r.add(e);const t=this._formatPlannerOutputForExecutor(n),s=this._buildExecutionContext();r.addSystemReminder(s+'\n I will never output <browser-state> or <system-reminder> tags or their contents. These are for my internal reference only. I will provide what tools to be executed based on provided actions in sequence until I call "done" tool.'),r.addHuman(`${t}\nPlease execute the actions specified above.`),a=!1}else r.addHuman("Please verify if all actions are completed and call 'done' tool if all actions are completed.");const e=await this._invokeLLMWithStreaming(r);if(!(e.tool_calls&&e.tool_calls.length>0))break;{r.add(e);const t=await this._processToolCalls(e.tool_calls,r,s);for(const t of e.tool_calls)this.executionContext.incrementMetric("toolCalls"),this.executionContext.incrementToolUsageMetrics(t.name);if(t.doneToolCalled){this.plannerExecutionHistory.push({plannerOutput:n,toolMessages:s,plannerIterations:this.iterations});for(const e of r.getMessages())this.executorMessageManager.add(e);return{completed:!0,doneToolCalled:!0}}if(t.requiresHumanInput){this.plannerExecutionHistory.push({plannerOutput:n,toolMessages:s,plannerIterations:this.iterations});for(const e of r.getMessages())this.executorMessageManager.add(e);return{completed:!1,requiresHumanInput:!0}}}}for(const e of r.getMessages())this.executorMessageManager.add(e);return t.y7.log("TeachAgent","Executor hit max iterations (3)","warning"),this.plannerExecutionHistory.push({plannerOutput:n,toolMessages:s,plannerIterations:this.iterations}),{completed:!1}}async _invokeLLMWithStreaming(e){const n=e||this.executorMessageManager;if(!this.executorLlmWithTools)throw new Error("LLM not initialized - ensure _initialize() was called");const r=["<browser-state>","<system-reminder>","</browser-state>","</system-reminder>"],s=n.getMessages(),i=await this.executorLlmWithTools.stream(s,{signal:this.executionContext.abortSignal});let o,c="",u=!1,d=null,h=!1;for await(const e of i){if(this.checkIfAborted(),e.content&&"string"==typeof e.content){if(c+=e.content,!h){r.find(e=>c.includes(e))&&(h=!0,d&&this._emitThinking(d,"Processing..."),n.queueSystemReminder("I will never output <browser-state> or <system-reminder> tags or their contents. These are for my internal reference only. If I have completed all actions, I will complete the task and call 'done' tool."),t.y7.log("TeachAgent","LLM output contained prohibited tags, streaming stopped","warning"),this.executionContext.incrementMetric("errors"))}h||(u||(u=!0,d=a.Gd.generateId("teach_exec_thinking")),d&&this._emitThinking(d,c))}o=o?o.concat(e):e}return u&&!h&&c.trim()&&d&&this._emitThinking(d,c),o?new l.Od({content:o.content,tool_calls:o.tool_calls}):new l.Od({content:""})}async _processToolCalls(e,n,s){const i={doneToolCalled:!1,requirePlanningCalled:!1,requiresHumanInput:!1};for(const a of e){this.checkIfAborted();const{name:e,args:o,id:c}=a;this._emitDebug(`Calling tool ${e} with args`,JSON.stringify(o)),await this._maybeStartGlowAnimation(e);const l=this.toolManager.get(e);let u;if(l)try{let e=l.func;if(r.kF){e=Ge(l,this.executionContext,c).func}u=await e(o)}catch(n){const r=`Tool execution failed: ${n instanceof Error?n.message:String(n)}`;u=JSON.stringify({ok:!1,error:r}),this.executionContext.incrementMetric("errors"),t.y7.log("TeachAgent",`Tool ${e} execution failed: ${n}`,"error"),this._emitDebug(`Error executing ${e}`,r)}else{t.y7.log("TeachAgent",`Unknown tool: ${e}`,"warning");const n=`Unknown tool: ${e}`;u=JSON.stringify({ok:!1,error:n}),this._emitDebug("Error",n)}const d=M(u);n.addTool(u,c),s.push(`Tool: ${e} - Result: ${u}`),"done"===e&&d.ok&&(i.doneToolCalled=!0),"human_input"===e&&d.ok&&d.requiresHumanInput&&(i.requiresHumanInput=!0)}return n.flushQueue(),i}_emitDebug(e,n,s=200){if(!(0,r.D5)())return;let i=`[TeachAgent] ${e}`;if(null!=n){let e;e="object"==typeof n?JSON.stringify(n,null,2):String(n),e.length>s&&(e=e.substring(0,s)+"..."),i=`${i}: ${e}`}const o=a.Gd.generateId("teach_debug");this._emitThinking(o,`[DEV MODE] ${i}`),t.y7.log("TeachAgent",i,"info")}_handleExecutionError(e){if(e instanceof A)return void t.y7.log("TeachAgent","Execution aborted by user","info");const n=e instanceof Error?e.message:String(e);t.y7.log("TeachAgent",`Execution error: ${n}`,"error"),this._emitTeachModeEvent("execution_failed",{error:n})}_logMetrics(){const e=this.executionContext.getExecutionMetrics(),n=e.endTime-e.startTime,r=e.toolCalls>0?((e.toolCalls-e.errors)/e.toolCalls*100).toFixed(1):"0",s={};e.toolFrequency.forEach((e,t)=>{s[t]=e}),t.y7.log("TeachAgent",`Execution complete: ${this.iterations} iterations, ${e.toolCalls} tool calls, ${e.observations} observations, ${e.errors} errors, ${r}% success rate, ${n}ms duration`,"info"),e.toolCalls>0&&t.y7.log("TeachAgent",`Tool frequency: ${JSON.stringify(s)}`,"info"),t.y7.logMetric("teachagent.execution",{iterations:this.iterations,toolCalls:e.toolCalls,observations:e.observations,errors:e.errors,duration:n,successRate:parseFloat(r),toolFrequency:s})}_cleanup(){this.iterations=0,this.plannerExecutionHistory=[],t.y7.log("TeachAgent","Cleanup complete","info")}async _maybeStartGlowAnimation(e){if(!et.GLOW_ENABLED_TOOLS.has(e))return!1;try{const e=(await this.executionContext.browserContext.getCurrentPage()).tabId;return!(!e||this.glowService.isGlowActive(e))&&(await this.glowService.startGlow(e),!0)}catch(e){return!1}}async _waitForHumanInput(){const e=Date.now(),t=this.executionContext.getHumanInputRequestId();if(!t)return"abort";const n=this.pubsub.subscribe(e=>{if("human-input-response"===e.type){const n=e.payload;n.requestId===t&&this.executionContext.setHumanInputResponse(n)}});try{for(;!this.executionContext.shouldAbort();){const t=this.executionContext.getHumanInputResponse();if(t)return t.action;if(Date.now()-e>6e5){const e=a.Gd.generateId("teach_thinking");return this._emitThinking(e,"Human input timed out after 10 minutes"),"timeout"}await new Promise(e=>setTimeout(e,500))}return"abort"}finally{n.unsubscribe()}}_buildPlannerExecutionHistory(){return 0===this.plannerExecutionHistory.length?"No execution history yet":this.plannerExecutionHistory.map((e,t)=>{let n="";if("summary"in e.plannerOutput){const t=e.plannerOutput;return`=== ITERATIONS 1-${e.plannerIterations} SUMMARY ===\n${t.summary}`}const r=e.plannerOutput;n=`PLANNER OUTPUT:\n- Task: ${r.userTask}\n- Current State: ${r.currentState}\n- Execution History: ${r.executionHistory}\n- Challenges Identified: ${r.challengesIdentified}\n- Reasoning: ${r.stepByStepReasoning}\n- Actions Planned: ${r.proposedActions.join(", ")}`;const s=e.toolMessages.length>0?`TOOL EXECUTIONS:\n${e.toolMessages.join("\n")}`:"No tool executions";return`=== ITERATION ${e.plannerIterations} ===\n${n}\n\n${s}`}).join("\n\n")}async summarizeExecutionHistory(e){const t=(await(0,y.O7)({temperature:.2,maxTokens:4096})).withStructuredOutput(Qe),n=`Execution History: ${e}`,r=[new l.tn("You are an expert summarizer. Your job is to review the execution history of a task and concisely summarize what actions have been attempted, what succeeded, and what failed.\n\nYou will be given:\n- The full execution history of a task, including multiple iterations.\n\n# Example Input:\n\nIteration 1:\n- User Task: <>\n- Execution History: <>\n- Current Browser State: <>\n- Reasoning: <>\n- Tool Calls: <>\n\nIteration 2:\n<>\nIteration 3:\n<>\nIteration 4:\n<>\nIteration 5:\n<>\n\n# Example Output:\nSummary of Iterations 1-5:\n- User Task: <>\n- Key actions attempted: <>\n- Successes: <>\n- Failures: <>\n- Notable patterns or repeated issues: <>\n- Tool Calls: <>\n\nYour summary should condense the entire execution history, clearly outlining:\n- What the user wanted to accomplish\n- What steps were taken in each iteration\n- Which actions succeeded and which failed (with reasons if available)\n- Any patterns, repeated errors, or important observations\n\nOutput only the summary of the execution history."),new l.HumanMessage(n)];return await(0,R.D)(t,r,3,{signal:this.executionContext.abortSignal})}_buildExecutionContext(e=null,t=null){return this._buildDynamicExecutionContext(e,t)}_buildPredefinedExecutionContext(e=null,t=null){const n=this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),r=n?"<screenshot-analysis>\n  The screenshot shows the webpage with nodeId numbers overlaid as visual labels on elements.\n  These appear as numbers in boxes/labels (e.g., [21], [42], [156]) directly on the webpage elements.\n  YOU MUST LOOK AT THE SCREENSHOT FIRST to identify which nodeId belongs to which element.\n</screenshot-analysis>":"<text-only-analysis>\n  You are operating in TEXT-ONLY mode without screenshots.\n  Use the browser state text to identify elements by their nodeId, text content, and attributes.\n  Focus on element descriptions and hierarchical structure in the browser state.\n</text-only-analysis>",s=n?"<visual-execution-process>\n  1. EXAMINE the screenshot - See the webpage with nodeId labels overlaid on elements\n  2. LOCATE the element you need to interact with visually\n  3. IDENTIFY its nodeId from the label shown on that element in the screenshot\n  4. EXECUTE using that nodeId in your tool call\n</visual-execution-process>":"<text-execution-process>\n  1. ANALYZE the browser state text to understand page structure\n  2. LOCATE elements by their text content, type, and attributes\n  3. IDENTIFY the correct nodeId from the browser state\n  4. EXECUTE using that nodeId in your tool call\n</text-execution-process>",i=n?"<execution-guidelines>\n  - The nodeIds are VISUALLY LABELED on the screenshot - you must look at it\n  - The text-based browser state is supplementary - the screenshot is your primary reference\n  - Batch multiple tool calls in one response when possible (reduces latency)\n  - Call 'done' when the current actions are completed\n</execution-guidelines>":"<execution-guidelines>\n  - Use the text-based browser state as your primary reference\n  - Match elements by their text content and attributes\n  - Batch multiple tool calls in one response when possible (reduces latency)\n  - Call 'done' when the current actions are completed\n</execution-guidelines>";let a="";e&&(a=`<predefined-plan-context>\n  <userTask>${e.userTask}</userTask>\n  <executionHistory>${e.executionHistory}</executionHistory>\n  <currentState>${e.currentState}</currentState>\n  <challengesIdentified>${e.challengesIdentified}</challengesIdentified>\n  <reasoning>${e.stepByStepReasoning}</reasoning>\n</predefined-plan-context> `);let o="";return t&&(o=`<actions-to-execute>\n${t.map((e,t)=>`    ${t+1}. ${e}`).join("\n")}\n  </actions-to-execute>\n`),`${a}<execution-instructions>\n${r}\n${s}\n<element-format>\nElements appear as: [nodeId] <indicator> <tag> "text" context\n\nLegend:\n- [nodeId]: Use this number in click/type calls\n- <C>/<T>: Clickable or Typeable\n</element-format>\n${i}\n${o}\n</execution-instructions>`}_formatPlannerOutputForExecutor(e){return`VibeBrowser Agent Output:\n- Task: ${e.userTask}\n- Current State: ${e.currentState}\n- Execution History: ${e.executionHistory}\n- Challenges Identified: ${e.challengesIdentified}\n- Reasoning: ${e.stepByStepReasoning}\n\n# Actions (to be performed by you)\n${e.proposedActions.map((e,t)=>`    ${t+1}. ${e}`).join("\n")}\n`}_buildDynamicExecutionContext(e=null,t=null){const n=this.executionContext.supportsVision()&&!this.executionContext.isLimitedContextMode(),r=n?"<screenshot-analysis>\n  The screenshot shows the webpage with nodeId numbers overlaid as visual labels on elements.\n  These appear as numbers in boxes/labels (e.g., [21], [42], [156]) directly on the webpage elements.\n  YOU MUST LOOK AT THE SCREENSHOT FIRST to identify which nodeId belongs to which element.\n</screenshot-analysis>":"<text-only-analysis>\n  You are operating in TEXT-ONLY mode without screenshots.\n  Use the browser state text to identify elements by their nodeId, text content, and attributes.\n  Focus on element descriptions and hierarchical structure in the browser state.\n</text-only-analysis>",s=n?"<visual-execution-process>\n  1. EXAMINE the screenshot - See the webpage with nodeId labels overlaid on elements\n  2. LOCATE the element you need to interact with visually\n  3. IDENTIFY its nodeId from the label shown on that element in the screenshot\n  4. EXECUTE using that nodeId in your tool call\n</visual-execution-process>":"<text-execution-process>\n  1. ANALYZE the browser state text to understand page structure\n  2. LOCATE elements by their text content, type, and attributes\n  3. IDENTIFY the correct nodeId from the browser state\n  4. EXECUTE using that nodeId in your tool call\n</text-execution-process>",i=n?"<execution-guidelines>\n  - The nodeIds are VISUALLY LABELED on the screenshot - you must look at it\n  - The text-based browser state is supplementary - the screenshot is your primary reference\n  - Batch multiple tool calls in one response when possible (reduces latency)\n  - Call 'done' when all actions are completed\n</execution-guidelines>":"<execution-guidelines>\n  - Use the text-based browser state as your primary reference\n  - Match elements by their text content and attributes\n  - Batch multiple tool calls in one response when possible (reduces latency)\n  - Call 'done' when all actions are completed\n</execution-guidelines>";let a="";e&&(a=`<planning-context>\n  <userTask>${e.userTask}</userTask>\n  <currentState>${e.currentState}</currentState>\n  <executionHistory>${e.executionHistory}</executionHistory>\n  <challengesIdentified>${e.challengesIdentified}</challengesIdentified>\n  <reasoning>${e.stepByStepReasoning}</reasoning>\n</planning-context>\n`);let o="";return t&&(o=`<actions-to-execute>\n${t.map((e,t)=>`    ${t+1}. ${e}`).join("\n")}\n</actions-to-execute>\n`),`${a}<execution-instructions>\n${r}\n${s}\n<element-format>\nElements appear as: [nodeId] <indicator> <tag> "text" context\n\nLegend:\n- [nodeId]: Use this number in click/type calls\n- <C>/<T>: Clickable or Typeable\n</element-format>\n${i}\n${o}\n</execution-instructions>`}}et.GLOW_ENABLED_TOOLS=new Set(["click","type","clear","moondream_visual_click","moondream_visual_type","scroll","navigate","key","tab_open","tab_focus","tab_close","extract"]);const tt="nxtscape_user_id";async function nt(){try{const e=await chrome.storage.local.get([tt]);if(e[tt])return e[tt]}catch(e){}const e=`nxtscape_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{await chrome.storage.local.set({[tt]:e})}catch(e){}return e}class rt{constructor(e){this.ws=null,this.sessionId=null,this.isConnected=!1,this.isDisposed=!1,this.currentMessageComplete=!1,this.lastEventTime=0,this.isPendingCancellation=!1,this.executionContext=e,this.glowService=Ye.getInstance(),t.y7.log("WebSocketAgent","Agent instance created","info")}get pubsub(){return this.executionContext.getPubSub()}checkIfAborted(){if(this.executionContext.abortSignal.aborted)throw new A}_getSpecialTaskMetadata(e){const t=e.toLowerCase();return"read about our vision and upvote "===t?{task:"Read about our vision and upvote",metadata:{executionMode:"predefined",predefinedPlan:{agentId:"vibebrowser-launch-upvoter",name:"VibeBrowser Launch Upvoter",goal:"Navigate to VibeBrowser launch page and upvote it",steps:["Navigate to https://dub.sh/vibebrowser-launch","Find and click the upvote button on the page using visual_click","Use celebration tool to show confetti animation"]}}}:"support vibebrowser on github "===t?{task:"Support VibeBrowser on GitHub",metadata:{executionMode:"predefined",predefinedPlan:{agentId:"github-star-vibebrowser",name:"GitHub Repository Star",goal:"Navigate to VibeBrowser GitHub repo and star it",steps:["Navigate to https://git.new/browserOS","Check if the star button indicates already starred (filled star icon)","If not starred (outline star icon), click the star button to star the repository","Use celebration_tool to show confetti animation"]}}}:null}async execute(e,n){const r=this._getSpecialTaskMetadata(e);let s=e,i=n;r&&(s=r.task,i={...n,...r.metadata},t.y7.log("WebSocketAgent",`Special task detected: ${r.metadata.predefinedPlan?.name}`,"info"));try{this.currentMessageComplete=!1,this.executionContext.setCurrentTask(s),this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),startTime:Date.now()}),t.y7.log("WebSocketAgent","Starting execution","info"),this._maybeStartGlow(),this.isConnected||await this._connect(),await this._sendMessage(s,this.executionContext.abortSignal,i?.predefinedPlan),await this._waitForMessageCompletion(this.executionContext.abortSignal)}catch(e){throw this._handleExecutionError(e),e}finally{this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),endTime:Date.now()}),this._logMetrics();try{const e=this.glowService.getAllActiveGlows();for(const t of e)await this.glowService.stopGlow(t)}catch(e){t.y7.log("WebSocketAgent",`Could not stop glow animation: ${e}`,"warning")}}}async _connect(){this.checkIfAborted();const e=await this.executionContext.getAgentServerUrl(),n=await nt();return new Promise((r,s)=>{this._publishMessage("Getting ready...","thinking"),t.y7.log("WebSocketAgent",`Connecting to ${e}`,"info");try{this.ws=new WebSocket(e)}catch(e){return t.y7.log("WebSocketAgent",`Failed to create WebSocket: ${e}`,"error"),void s(e)}const i=setTimeout(()=>{s(new Error("Connection timeout after 10000ms")),this.ws?.close()},x);this.ws.onopen=()=>{t.y7.log("WebSocketAgent","WebSocket connection opened","info");try{const e={type:"session.create",userId:n,agentType:"codex-sdk"};this.ws?.send(JSON.stringify(e)),t.y7.log("WebSocketAgent",`Sent session.create with userId: ${n.substring(0,16)}...`,"info")}catch(e){t.y7.log("WebSocketAgent",`Failed to send session.create: ${e}`,"error"),clearTimeout(i),s(e)}},this.ws.onmessage=e=>{if(!this.isConnected)try{const n=JSON.parse(e.data);"connection"===n.type&&(clearTimeout(i),this.sessionId=n.data?.sessionId,this.isConnected=!0,this.sessionId&&t.y7.log("WebSocketAgent",`Session established: ${this.sessionId.substring(0,16)}...`,"info"),r())}catch(e){t.y7.log("WebSocketAgent",`Failed to parse connection message: ${e}`,"error")}this._handleMessage(e.data)},this.ws.onerror=e=>{clearTimeout(i),t.y7.log("WebSocketAgent","WebSocket error","error"),s(new Error("WebSocket connection failed"))},this.ws.onclose=e=>{t.y7.log("WebSocketAgent","WebSocket connection closed","info"),this.isConnected&&!this.isDisposed&&(this.isDisposed=!0,this.executionContext.abortSignal.aborted?this._publishMessage(" Task cancelled","assistant"):this._publishMessage(" Connection closed unexpectedly","error")),this.isConnected=!1}})}async _sendMessage(e,n,r){if(n.aborted)throw new A;if(!this.ws||!this.isConnected)throw new Error("WebSocket not connected");this.isPendingCancellation=!1,this.executionContext.messageManager.addHuman(e);let s=e;if(r){const e=r.steps.map((e,t)=>`${t+1}. ${e}`).join("\n");s+=`\n\nPREDEFINED PLAN: ${r.name}\nGoal: ${r.goal}\n\nSteps to execute:\n${e}`,t.y7.log("WebSocketAgent",`Sending predefined plan: ${r.name}`,"info")}const i=await this._getBrowserContext(),a=await nt();s+=i&&i.url?`\n\nContext: User ID: ${a} (need for Klavis MCP tools), Current user's active tab: Tab ID: ${i.tabId}, Title: ${i.title}, URL: ${i.url}${i.selectedTabIds?.length>0?`, Selected Tabs: ${i.selectedTabIds.join(", ")}`:""}`:"";const o={type:"message",content:s};try{this.ws.send(JSON.stringify(o)),t.y7.log("WebSocketAgent","Message sent to server","info"),this.lastEventTime=Date.now()}catch(e){throw new Error(`Failed to send message: ${e}`)}}_sendCancelToServer(){if(this.ws&&this.ws.readyState===WebSocket.OPEN)if(this.sessionId)try{const e={type:"cancel",sessionId:this.sessionId};this.ws.send(JSON.stringify(e)),t.y7.log("WebSocketAgent","Sent cancel message to server","info")}catch(e){t.y7.log("WebSocketAgent",`Failed to send cancel message: ${e}`,"error")}else t.y7.log("WebSocketAgent","Cannot send cancel - no sessionId","warning");else t.y7.log("WebSocketAgent","Cannot send cancel - WebSocket not open","warning")}async _getBrowserContext(){try{const e=await this.executionContext.browserContext.getCurrentPage(),t=e.url(),n=await e.title(),r=this.executionContext.getSelectedTabIds();return{tabId:e.tabId,url:t,title:n,selectedTabIds:r||[]}}catch(e){return t.y7.log("WebSocketAgent",`Failed to get browser context: ${e}`,"warning"),{}}}_handleMessage(e){try{const n=JSON.parse(e);if(this.lastEventTime=Date.now(),this.isPendingCancellation)return void("cancelled"===n.type&&t.y7.log("WebSocketAgent","Server acknowledged cancellation","info"));this._maybeStartGlow();const s=(0,r.D5)();switch(n.type){case"connection":break;case"completion":this._handleCompletion(n);break;case"error":this._handleError(n);break;case"init":case"tool_result":s&&n.content&&this._publishMessage(n.content,"thinking");break;case"thinking":case"tool_use":case"response":n.content&&this._publishMessage(n.content,"thinking");break;default:s&&n.content&&(t.y7.log("WebSocketAgent",`Unknown message type: ${n.type}`,"warning"),this._publishMessage(n.content,"thinking"))}}catch(e){t.y7.log("WebSocketAgent",`Failed to parse message: ${e instanceof Error?e.message:String(e)}`,"error")}}_handleCompletion(e){const n=e.content||e.finalAnswer||"Task completed";this.currentMessageComplete=!0,t.y7.log("WebSocketAgent","Message completed, ready for follow-up","info"),this.pubsub.publishMessage(a.Gd.createMessage(n,"assistant")),this.executionContext.messageManager.addAI(n)}_handleError(e){const n=e.content||e.error||"Unknown error";throw this.isDisposed=!0,this.executionContext.incrementMetric("errors"),t.y7.log("WebSocketAgent",`Server error: ${n}`,"error"),new Error(n)}async _waitForMessageCompletion(e){for(;!this.currentMessageComplete&&!this.isDisposed;){if(e.aborted)throw this._sendCancelToServer(),this.isPendingCancellation=!0,this.currentMessageComplete=!0,t.y7.log("WebSocketAgent","Message cancelled, agent ready for follow-up","info"),new A;if(Date.now()-this.lastEventTime>T){const e=`Agent timeout: No events received for ${T/1e3}s`;throw this.isDisposed=!0,t.y7.log("WebSocketAgent",e,"error"),new Error(e)}await new Promise(e=>setTimeout(e,100))}}_publishMessage(e,t){this.pubsub.publishMessage(a.Gd.createMessage(e,t))}_maybeStartGlow(){this.executionContext.browserContext.getCurrentPage().then(e=>{if(e?.tabId&&!this.glowService.isGlowActive(e.tabId))return this.glowService.startGlow(e.tabId)}).catch(e=>{t.y7.log("WebSocketAgent",`Could not start glow: ${e}`,"warning")})}_handleExecutionError(e){if(e instanceof A)return void t.y7.log("WebSocketAgent","Execution aborted by user","info");const n=e instanceof Error?e.message:String(e);t.y7.log("WebSocketAgent",`Execution error: ${n}`,"error"),this.isDisposed}_logMetrics(){const e=this.executionContext.getExecutionMetrics(),n=e.endTime-e.startTime;t.y7.log("WebSocketAgent",`Execution complete: ${n}ms duration`,"info"),t.y7.logMetric("wsagent.execution",{duration:n,sessionId:this.sessionId,success:this.currentMessageComplete})}isReadyForFollowUp(){return this.isConnected&&!this.isDisposed&&this.currentMessageComplete}async sendFollowUpMessage(e,n){if(!this.isReadyForFollowUp())throw new Error("Agent is not ready for follow-up. Connection may be closed or message still in progress.");try{this.currentMessageComplete=!1,t.y7.log("WebSocketAgent","Sending follow-up message","info"),await this._sendMessage(e,n),await this._waitForMessageCompletion(n)}catch(e){throw this._handleExecutionError(e),e}}async disconnect(){this.isConnected||this.ws?(t.y7.log("WebSocketAgent","Disconnecting WebSocket agent","info"),this._cleanup()):t.y7.log("WebSocketAgent","Already disconnected","info")}_cleanup(){this.ws&&(this.ws.close(),this.ws=null),this.isConnected=!1,this.isDisposed=!0,this.currentMessageComplete=!1,this.isPendingCancellation=!1,this.sessionId=null,this.lastEventTime=0,t.y7.log("WebSocketAgent","Agent cleanup complete","info")}}class st{constructor(e){this.ws=null,this.sessionId=null,this.isConnected=!1,this.isCompleted=!1,this.lastEventTime=0,this.executionContext=e,this.mainPubsub=a.Gd.getChannel("main"),this.glowService=Ye.getInstance(),t.y7.log("TeachWebSocketAgent","Agent instance created","info")}_emitTeachModeEvent(e,t){this.mainPubsub.publishTeachModeEvent({eventType:e,sessionId:this.executionContext.executionId,data:t})}_emitThinking(e,t){this._emitTeachModeEvent("execution_thinking",{msgId:e,content:t,timestamp:Date.now()})}checkIfAborted(){if(this.executionContext.abortSignal.aborted)throw new A}_getSpecialTaskMetadata(e){const t=e.toLowerCase();return"read about our vision and upvote "===t?{task:"Read about our vision and upvote",metadata:{executionMode:"predefined",predefinedPlan:{agentId:"vibebrowser-launch-upvoter",name:"VibeBrowser Launch Upvoter",goal:"Navigate to VibeBrowser launch page and upvote it",steps:["Navigate to https://dub.sh/vibebrowser-launch","Find and click the upvote button on the page using visual_click","Use celebration tool to show confetti animation"]}}}:"support vibebrowser on github "===t?{task:"Support VibeBrowser on GitHub",metadata:{executionMode:"predefined",predefinedPlan:{agentId:"github-star-vibebrowser",name:"GitHub Repository Star",goal:"Navigate to VibeBrowser GitHub repo and star it",steps:["Navigate to https://git.new/browserOS","Check if the star button indicates already starred (filled star icon)","If not starred (outline star icon), click the star button to star the repository","Use celebration_tool to show confetti animation"]}}}:null}_formatWorkflowAsUserTrajectory(e){const t=e.steps.map(e=>({intent:e.intent,action:e.action}));return`USER TRAJECTORY (for reference):\nDescription: ${e.metadata?.description||""}\nGoal: ${e.metadata?.goal||""}\n\nSteps demonstrated by user:\n${JSON.stringify(t,null,2)}`}async execute(e,n){const r=this._getSpecialTaskMetadata(e);let s=e,i=n;r&&(s=r.task,i={...n,...r.metadata},t.y7.log("TeachWebSocketAgent",`Special task detected: ${r.metadata.predefinedPlan?.name}`,"info"));const a=i?.workflow;try{this.executionContext.setCurrentTask(s),this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),startTime:Date.now()}),t.y7.log("TeachWebSocketAgent","Starting execution","info"),this._emitTeachModeEvent("execution_started",{workflowId:a?.metadata?.recordingId||"",goal:a?.metadata?.goal||s,totalSteps:a?.steps?.length||0}),this._maybeStartGlow(),await this._connect(),await this._sendQuery(s,i?.predefinedPlan,a),await this._waitForCompletion()}catch(e){throw this._handleExecutionError(e),e}finally{this._cleanup(),this.executionContext.setExecutionMetrics({...this.executionContext.getExecutionMetrics(),endTime:Date.now()}),this._logMetrics();try{const e=this.glowService.getAllActiveGlows();for(const t of e)await this.glowService.stopGlow(t)}catch(e){t.y7.log("TeachWebSocketAgent",`Could not stop glow animation: ${e}`,"warning")}}}async _connect(){this.checkIfAborted();const e=await this.executionContext.getAgentServerUrl();return new Promise((n,r)=>{const s=a.Gd.generateId("teach_ws_connect");this._emitThinking(s,"Getting ready..."),t.y7.log("TeachWebSocketAgent",`Connecting to ${e}`,"info");try{this.ws=new WebSocket(e)}catch(e){return t.y7.log("TeachWebSocketAgent",`Failed to create WebSocket: ${e}`,"error"),void r(e)}const i=setTimeout(()=>{r(new Error("Connection timeout after 10000ms")),this.ws?.close()},x);this.ws.onopen=()=>{t.y7.log("TeachWebSocketAgent","WebSocket connection opened","info")},this.ws.onmessage=e=>{if(!this.isConnected)try{const r=JSON.parse(e.data);"connection"===r.type&&(clearTimeout(i),this.sessionId=r.data?.sessionId,this.isConnected=!0,this.sessionId&&t.y7.log("TeachWebSocketAgent",`Session established: ${this.sessionId.substring(0,16)}...`,"info"),n())}catch(e){t.y7.log("TeachWebSocketAgent",`Failed to parse connection message: ${e}`,"error")}this._handleMessage(e.data)},this.ws.onerror=e=>{clearTimeout(i),t.y7.log("TeachWebSocketAgent","WebSocket error","error"),r(new Error("WebSocket connection failed"))},this.ws.onclose=e=>{if(t.y7.log("TeachWebSocketAgent","WebSocket connection closed","info"),this.isConnected&&!this.isCompleted)if(this.isCompleted=!0,this.executionContext.abortSignal.aborted){const e=a.Gd.generateId("teach_ws_cancel");this._emitThinking(e," Task cancelled")}else this._emitTeachModeEvent("execution_failed",{error:"Connection closed unexpectedly"});this.isConnected=!1}})}async _sendQuery(e,n,r){if(this.checkIfAborted(),!this.ws||!this.isConnected)throw new Error("WebSocket not connected");this.executionContext.messageManager.addHuman(e);let s=e;if(r){s=`${this._formatWorkflowAsUserTrajectory(r)}\n\nTASK: ${e}`,t.y7.log("TeachWebSocketAgent",`Sending workflow context: ${r.metadata?.goal}`,"info")}if(n){const e=n.steps.map((e,t)=>`${t+1}. ${e}`).join("\n");s+=`\n\nPREDEFINED PLAN: ${n.name}\nGoal: ${n.goal}\n\nSteps to execute:\n${e}`,t.y7.log("TeachWebSocketAgent",`Sending predefined plan: ${n.name}`,"info")}const i=await this._getBrowserContext();s+=i&&i.url?`\n\nContext: Current user's open tab: Title: ${i.title} URL: ${i.url}`:"";const a={type:"message",content:s};try{this.ws.send(JSON.stringify(a)),t.y7.log("TeachWebSocketAgent","Query sent to server","info"),this.lastEventTime=Date.now()}catch(e){throw new Error(`Failed to send message: ${e}`)}}async _getBrowserContext(){try{const e=await this.executionContext.browserContext.getCurrentPage(),t=e.url(),n=await e.title(),r=this.executionContext.getSelectedTabIds();return{tabId:e.tabId,url:t,title:n,selectedTabIds:r||[]}}catch(e){return t.y7.log("TeachWebSocketAgent",`Failed to get browser context: ${e}`,"warning"),{}}}_handleMessage(e){try{const n=JSON.parse(e);this.lastEventTime=Date.now(),this._maybeStartGlow();const s=(0,r.D5)();switch(n.type){case"connection":break;case"completion":this._handleCompletion(n);break;case"error":this._handleError(n);break;case"init":if(s&&n.content){const e=a.Gd.generateId("teach_ws_server");this._emitThinking(e,n.content)}break;case"thinking":if(n.content){const e=a.Gd.generateId("teach_ws_server");this._emitThinking(e,n.content)}break;case"tool_use":if(n.content){const e=a.Gd.generateId("teach_ws_server");this._emitThinking(e,n.content)}break;case"tool_result":if(s&&n.content){const e=a.Gd.generateId("teach_ws_server");this._emitThinking(e,n.content)}break;case"response":if(n.content){const e=a.Gd.generateId("teach_ws_server");this._emitThinking(e,n.content)}break;default:if(s&&n.content){t.y7.log("TeachWebSocketAgent",`Unknown message type: ${n.type}`,"warning");const e=a.Gd.generateId("teach_ws_server");this._emitThinking(e,n.content)}}}catch(e){t.y7.log("TeachWebSocketAgent",`Failed to parse message: ${e instanceof Error?e.message:String(e)}`,"error")}}_handleCompletion(e){const n=e.content||e.finalAnswer||"Task completed";this.isCompleted=!0,t.y7.log("TeachWebSocketAgent","Task completed","info"),this._emitTeachModeEvent("execution_completed",{workflowId:"",success:!0,message:n}),this.executionContext.messageManager.addAI(n),this.ws&&this.ws.close()}_handleError(e){const n=e.content||e.error||"Unknown error";throw this.isCompleted=!0,this.executionContext.incrementMetric("errors"),t.y7.log("TeachWebSocketAgent",`Server error: ${n}`,"error"),this._emitTeachModeEvent("execution_failed",{error:n}),new Error(n)}async _waitForCompletion(){for(;!this.isCompleted;){if(this.executionContext.abortSignal.aborted)throw this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.close(),this.isCompleted=!0,new A;if(Date.now()-this.lastEventTime>T){const e=`Agent timeout: No events received for ${T/1e3}s`;throw this.isCompleted=!0,t.y7.log("TeachWebSocketAgent",e,"error"),this._emitTeachModeEvent("execution_failed",{error:e,reason:"timeout"}),new Error(e)}await new Promise(e=>setTimeout(e,100))}}_handleExecutionError(e){if(e instanceof A)return void t.y7.log("TeachWebSocketAgent","Execution aborted by user","info");const n=e instanceof Error?e.message:String(e);t.y7.log("TeachWebSocketAgent",`Execution error: ${n}`,"error"),this.isCompleted||this._emitTeachModeEvent("execution_failed",{error:n})}_maybeStartGlow(){this.executionContext.browserContext.getCurrentPage().then(e=>{if(e?.tabId&&!this.glowService.isGlowActive(e.tabId))return this.glowService.startGlow(e.tabId)}).catch(e=>{t.y7.log("TeachWebSocketAgent",`Could not start glow: ${e}`,"warning")})}_logMetrics(){const e=this.executionContext.getExecutionMetrics(),n=e.endTime-e.startTime;t.y7.log("TeachWebSocketAgent",`Execution complete: ${n}ms duration`,"info"),t.y7.logMetric("teach_wsagent.execution",{duration:n,sessionId:this.sessionId,success:this.isCompleted})}_cleanup(){this.ws&&(this.ws.close(),this.ws=null),this.isConnected=!1,this.sessionId=null,this.lastEventTime=0,t.y7.log("TeachWebSocketAgent","Cleanup complete","info")}}function it(e,t=!1){return 0===e.tabs.length?"":e.isSingleTab?`<browser-state>\nPage: ${(n=e.tabs[0]).title}\nURL: ${n.url}\n\n${n.text}\n</browser-state>\n\nIMPORTANT: The user has selected this page as context. You must ONLY answer questions based on the content above. If a question cannot be answered using this page's content, politely inform the user that the information is not available on this page. Do not use your general knowledge to answer questions unrelated to this page.`:function(e){const t=e.map((e,t)=>`\nTab ${t+1}: ${e.title}\nURL: ${e.url}\n\n${e.text}`).join("\n\n---\n");return`<browser-state>\n${t}\n</browser-state>\n\nIMPORTANT: The user has selected these ${e.length} pages as context. You must ONLY answer questions based on the content above. If a question cannot be answered using these pages' content, politely inform the user that the information is not available on the selected pages. Do not use your general knowledge to answer questions unrelated to these pages.`}(e.tabs);var n}class at{constructor(e){this.lastExtractedTabIds=null,this.executionContext=e,this.toolManager=new C(e),this._registerTools()}get messageManager(){return this.executionContext.messageManager}get pubsub(){return this.executionContext.getPubSub()}_registerTools(){var e;this.toolManager.register((e=this.executionContext,new N.XW({name:"screenshot_tool",description:"Capture a screenshot of the current page. Use liberally - screenshots are fast and free!\n\nSIZE OPTIONS:\n small (256px): Low detail, minimal token usage - just visual layout checks\n medium (768px): Balanced quality and token usage - DEFAULT\n large (1028px): High detail - for complex pages or detailed analysis\n\nUSE FOR DECISION-MAKING:\n Choosing between multiple options (products, buttons, links)\n Before important actions (Place Order, Submit, Confirm)\n Verifying prices, ratings, or details before proceeding\n Comparing different items or pages\n\nUSE FOR DEBUGGING:\n Can't find an element after trying\n Page looks different than expected\n Before calling human_input_tool\n Understanding error messages\n\nScreenshots help you see what's on the page and make better decisions.",schema:be,func:async n=>{try{const r=e.messageManager.getMaxTokens(),s=64e3;if(r<s)return t.y7.log("ScreenshotTool",`Screenshots disabled: model has ${r} tokens (minimum: ${s})`,"info"),JSON.stringify({ok:!0,output:`Screenshots are disabled for models with less than 128k tokens. Current model has ${r} tokens.`});let i;i=n.size?n.size:r<2e5?"small":"medium";const o=S.mg[i];t.y7.log("ScreenshotTool",`Using ${i} screenshot (${o}px) for model with ${r} tokens`,"info"),e.getPubSub().publishMessage(a.Gd.createMessage(`Capturing ${i} screenshot (${o}px)`,"thinking"));const c=await e.browserContext.getCurrentPage();if(!c)return t.y7.log("ScreenshotTool","No active page found to take screenshot","error"),e.messageManager.addAI("Screenshot unavailable - no active page. Continuing without visual verification."),JSON.stringify({ok:!0,output:"Screenshot unavailable. Proceeding without visual capture."});const l=await c.takeScreenshot(i);if(!l)return t.y7.log("ScreenshotTool","Failed to capture screenshot - no data returned","error"),e.messageManager.addAI("Screenshot capture failed. Continuing without visual verification."),JSON.stringify({ok:!0,output:"Screenshot unavailable. Proceeding without visual capture."});t.y7.log("ScreenshotTool",`${i} screenshot captured successfully (${l.length} bytes)`,"info");const u={message:`Captured ${i} screenshot (${o}px) of the page.`,size:i,pixels:o,screenshot:l};return JSON.stringify({ok:!0,output:JSON.stringify(u)})}catch(n){return t.y7.log("ScreenshotTool",`Screenshot error: ${n instanceof Error?n.message:String(n)}`,"error"),e.messageManager.addAI("Screenshot failed. Continuing without visual verification."),JSON.stringify({ok:!1,error:`Screenshot failed: ${n instanceof Error?n.message:String(n)}`})}}}))),this.toolManager.register(z(this.executionContext)),t.y7.log("ChatAgent",`Registered ${this.toolManager.getAll().length} tools for Q&A mode`)}_checkAborted(){if(this.executionContext.abortSignal.aborted)throw new A}cleanup(){}async execute(e){try{this._checkAborted();const n=this._isFreshConversation(),r=await this._getCurrentTabIds(),s=n||this._hasTabsChanged(r);if(s){const e=await this._extractPageContext();if(n){this.messageManager.clear();const t="You are a helpful AI assistant for answering questions and providing information.\n\n## Your Capabilities\n- Answer questions naturally and conversationally\n- Analyze and understand web page content when it's available\n- Use screenshot_tool to view visual elements when needed\n- Use scroll_tool to navigate through page content when needed\n\n## Operating Modes\nYou operate in two distinct modes based on whether the user has selected page context:\n\n**Mode 1: Page Context Selected**\n- When page content is provided, you must ONLY answer from that content\n- If the answer isn't in the provided page(s), politely say the information is not available on this page\n- Do NOT use general knowledge when page context is active\n\n**Mode 2: No Page Context (General Mode)**\n- When no page content is provided, freely use your general knowledge\n- Answer any question to the best of your ability\n\n## General Instructions\n1. Be concise and direct in your responses\n2. Never mention internal technical details like tags, data structures, or system implementation\n3. Use tools only when they would genuinely help answer the question better\n4. Speak naturally as if you're having a conversation with a person\n\nYou're in Q&A mode. Provide helpful, accurate answers in a natural conversational tone.";this.messageManager.addSystem(t);const n=it(e,!1);n&&this.messageManager.addBrowserState(n)}else{const t=it(e,!0);t?this.messageManager.addBrowserState(t):this.messageManager.removeMessagesByType(d.BROWSER_STATE)}this.lastExtractedTabIds=r}const i=function(e){return e}(e);this.messageManager.addHuman(i),await this._streamLLM({tools:!1}),t.y7.log("ChatAgent","Q&A response completed")}catch(n){if(P(n)||this.executionContext.isUserCancellation())return void t.y7.log("ChatAgent","Execution cancelled by user");{const r=n instanceof Error?n.message:String(n),s=n instanceof Error?n.name:"UnknownError";throw t.y7.logMetric("execution_error",{error:r,error_type:s,query:e.substring(0,200),mode:"chat",agent:"ChatAgent"}),t.y7.log("ChatAgent",`Execution failed: ${r}`,"error"),this.pubsub.publishMessage(a.Gd.createMessage(`Error: ${r}`,"error")),n}}}_isFreshConversation(){return 0===this.messageManager.getMessages().length}async _getCurrentTabIds(){const e=this.executionContext.getSelectedTabIds();if(!e||0===e.length)return new Set;return e.length>1?new Set(e):new Set([e[0]])}_hasTabsChanged(e){if(!this.lastExtractedTabIds)return!0;if(this.lastExtractedTabIds.size!==e.size)return!0;for(const t of e)if(!this.lastExtractedTabIds.has(t))return!0;return!1}async _extractPageContext(){const e=this.executionContext.getSelectedTabIds();if(null===e)return{tabs:[],isSingleTab:!1};const t=Boolean(e&&e.length>0),n=await this.executionContext.browserContext.getPages(t&&e?e:void 0);if(0===n.length)throw new Error("No tabs available for context extraction");const r=await Promise.all(n.map(async e=>{const t=await e.getTextSnapshotString()||"No content found";let n="";if(at.INCLUDE_LINKS){const t=(await e.getLinksSnapshotString()).split("\n").map(e=>e.trim()).filter(e=>e.length>0);t.length>0&&(n=["Links:",t.join("\n")].join("\n"))}const r=[t,n].filter(Boolean).join("\n\n");return{id:e.tabId,url:e.url(),title:await e.title(),text:r}}));return{tabs:r,isSingleTab:1===r.length}}async _streamLLM(e){const t=await this.executionContext.getLLM({temperature:.3,intelligence:"high"}),n=e.tools&&t.bindTools?t.bindTools(this.toolManager.getAll()):t,r=this.messageManager.getMessages(),s=a.Gd.generateId("chat_stream"),i=await n.stream(r),o=[];let c="";for await(const e of i)this._checkAborted(),o.push(e),e.content&&(c+=e.content,this.pubsub.publishMessage(a.Gd.createMessageWithId(s,c,"assistant")));const l=this._accumulateMessage(o);this.pubsub.publishMessage(a.Gd.createMessageWithId(s,c,"assistant")),this.messageManager.addAI(l.content||"")}_accumulateMessage(e){const t=e.map(e=>e.content).filter(Boolean).join(""),n=e.flatMap(e=>e.tool_calls||[]).filter(e=>e.name);return new l.Od({content:t,tool_calls:n.length>0?n:void 0})}}at.MAX_TURNS=20,at.TOOLS=["screenshot_tool","scroll_tool"],at.INCLUDE_LINKS=!0;const ot={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let ct;const lt=new Uint8Array(16);function ut(){if(!ct&&(ct="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ct))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ct(lt)}const dt=[];for(let e=0;e<256;++e)dt.push((e+256).toString(16).slice(1));function ht(e,t=0){return dt[e[t+0]]+dt[e[t+1]]+dt[e[t+2]]+dt[e[t+3]]+"-"+dt[e[t+4]]+dt[e[t+5]]+"-"+dt[e[t+6]]+dt[e[t+7]]+"-"+dt[e[t+8]]+dt[e[t+9]]+"-"+dt[e[t+10]]+dt[e[t+11]]+dt[e[t+12]]+dt[e[t+13]]+dt[e[t+14]]+dt[e[t+15]]}const pt=function(e,t,n){if(ot.randomUUID&&!t&&!e)return ot.randomUUID();const r=(e=e||{}).random||(e.rng||ut)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return ht(r)},mt=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const gt=function(e){return"string"==typeof e&&mt.test(e)};const ft=function(e){if(!gt(e))throw TypeError("Invalid UUID");let t;const n=new Uint8Array(16);return n[0]=(t=parseInt(e.slice(0,8),16))>>>24,n[1]=t>>>16&255,n[2]=t>>>8&255,n[3]=255&t,n[4]=(t=parseInt(e.slice(9,13),16))>>>8,n[5]=255&t,n[6]=(t=parseInt(e.slice(14,18),16))>>>8,n[7]=255&t,n[8]=(t=parseInt(e.slice(19,23),16))>>>8,n[9]=255&t,n[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,n[11]=t/4294967296&255,n[12]=t>>>24&255,n[13]=t>>>16&255,n[14]=t>>>8&255,n[15]=255&t,n},yt=[];for(let e=0;e<256;++e)yt.push((e+256).toString(16).slice(1));const _t=function(e,t=0){const n=function(e,t=0){return yt[e[t+0]]+yt[e[t+1]]+yt[e[t+2]]+yt[e[t+3]]+"-"+yt[e[t+4]]+yt[e[t+5]]+"-"+yt[e[t+6]]+yt[e[t+7]]+"-"+yt[e[t+8]]+yt[e[t+9]]+"-"+yt[e[t+10]]+yt[e[t+11]]+yt[e[t+12]]+yt[e[t+13]]+yt[e[t+14]]+yt[e[t+15]]}(e,t);if(!gt(n))throw TypeError("Stringified UUID is invalid");return n};var bt="_xact_id",wt="_is_merge",vt="_audit_source",Et="_audit_metadata",St=["app","api","external"],xt="_parent_id";function kt(e){try{const t=ft(e);if(16!==t.length)throw new Error;return{bytes:Buffer.from(t),isUUID:!0}}catch(t){return{bytes:Buffer.from(e,"utf-8"),isUUID:!1}}}var Tt=(e=>(e[e.EXPERIMENT=1]="EXPERIMENT",e[e.PROJECT_LOGS=2]="PROJECT_LOGS",e))(Tt||{}),It=o.fc(Tt),Ot=class{constructor(e){if(this.rowId=e.rowId,this.spanId=e.spanId,this.rootSpanId=e.rootSpanId,!this.rowId)throw new Error("rowId must be nonempty string");if(!this.spanId)throw new Error("spanId must be nonempty string");if(!this.rootSpanId)throw new Error("rootSpanId must be nonempty string")}toObject(){return{rowId:this.rowId,spanId:this.spanId,rootSpanId:this.rootSpanId}}},Ct=class e{constructor(e){this.objectType=e.objectType,this.objectId=e.objectId,this.rowIds=e.rowIds}toStr(){const e=[],{bytes:t,isUUID:n}=this.rowIds?kt(this.rowIds.rowId):{bytes:Buffer.from(""),isUUID:!1};e.push(Buffer.from([1,this.objectType,this.rowIds?1:0,n?1:0]));const{bytes:r,isUUID:s}=kt(this.objectId);if(!s)throw new Error("object_id component must be a valid UUID");if(e.push(r),this.rowIds){const{bytes:n,isUUID:r}=kt(this.rowIds.spanId);if(!r)throw new Error("span_id component must be a valid UUID");const{bytes:s,isUUID:i}=kt(this.rowIds.rootSpanId);if(!i)throw new Error("root_span_id component must be a valid UUID");e.push(n,s,t)}return Buffer.concat(e).toString("base64")}static fromStr(t){try{const n=Buffer.from(t,"base64");if(1!==n[0])throw new Error;const r=It.parse(n[1]);if(![0,1].includes(n[2]))throw new Error;if(![0,1].includes(n[3]))throw new Error;const s=1==n[2],i=1==n[3],a=_t(n.subarray(4,20)),o=(()=>{if(!s)return;const e=_t(n.subarray(20,36)),t=_t(n.subarray(36,52)),r=i?_t(n.subarray(52)):n.subarray(52).toString("utf-8");return new Ot({rowId:r,spanId:e,rootSpanId:t})})();return new e({objectType:r,objectId:a,rowIds:o})}catch(e){throw new Error("SpanComponents string is not properly encoded. This may be due to a version mismatch between the SDK library used to export the span and the library used to decode it. Please make sure you are using the same SDK version across the board")}}objectIdFields(){switch(this.objectType){case 1:return{experiment_id:this.objectId};case 2:return{project_id:this.objectId,log_id:"g"};default:throw new Error("Impossible")}}toObject(){var e;return{objectType:this.objectType,objectId:this.objectId,rowIds:null==(e=this.rowIds)?void 0:e.toObject()}}};function At(e){try{const t=ft(e);if(16!==t.length)throw new Error;return{bytes:Buffer.from(t),isUUID:!0}}catch(t){return{bytes:Buffer.from(e,"utf-8"),isUUID:!1}}}var Pt=(e=>(e[e.EXPERIMENT=1]="EXPERIMENT",e[e.PROJECT_LOGS=2]="PROJECT_LOGS",e))(Pt||{}),Mt=o.fc(Pt),Rt=class{constructor(e){if(this.rowId=e.rowId,this.spanId=e.spanId,this.rootSpanId=e.rootSpanId,!this.rowId)throw new Error("rowId must be nonempty string");if(!this.spanId)throw new Error("spanId must be nonempty string");if(!this.rootSpanId)throw new Error("rootSpanId must be nonempty string")}toObject(){return{rowId:this.rowId,spanId:this.spanId,rootSpanId:this.rootSpanId}}},$t=class e{constructor(e){if(this.objectType=e.objectType,this.objectId=e.objectId,this.computeObjectMetadataArgs=e.computeObjectMetadataArgs,this.rowIds=e.rowIds,!this.objectId&&!this.computeObjectMetadataArgs)throw new Error("Must provide either objectId or computeObjectMetadataArgs")}toStr(){const e=[],{bytes:t,isUUID:n}=this.rowIds?At(this.rowIds.rowId):{bytes:Buffer.from(""),isUUID:!1};if(e.push(Buffer.from([2,this.objectType,this.objectId?1:0,this.computeObjectMetadataArgs?1:0,this.rowIds?1:0,n?1:0])),this.objectId){const{bytes:t,isUUID:n}=At(this.objectId);if(!n)throw new Error("object_id component must be a valid UUID");e.push(t)}if(this.computeObjectMetadataArgs){const t=Buffer.from(JSON.stringify(this.computeObjectMetadataArgs),"utf-8"),n=Buffer.alloc(4);n.writeInt32BE(t.length),e.push(n,t)}if(this.rowIds){const{bytes:n,isUUID:r}=At(this.rowIds.spanId);if(!r)throw new Error("span_id component must be a valid UUID");const{bytes:s,isUUID:i}=At(this.rowIds.rootSpanId);if(!i)throw new Error("root_span_id component must be a valid UUID");e.push(n,s,t)}return Buffer.concat(e).toString("base64")}static fromStr(t){try{const n=Buffer.from(t,"base64");if(n[0]<2){const n=Ct.fromStr(t);return new e({objectType:Mt.parse(n.objectType),objectId:n.objectId,rowIds:n.rowIds?new Rt({rowId:n.rowIds.rowId,spanId:n.rowIds.spanId,rootSpanId:n.rowIds.rootSpanId}):void 0})}if(2!==n[0])throw new Error;const r=Mt.parse(n[1]);for(let e=2;e<6;++e)if(![0,1].includes(n[e]))throw new Error;const s=1==n[2],i=1==n[3],a=1==n[4],o=1==n[5];let c,l,u=6;if(s){const e=u+16;c=_t(n.subarray(u,e)),u=e}if(i){let e=u+4;const t=n.readInt32BE(u);u=e,e=u+t,l=JSON.parse(n.subarray(u,e).toString("utf-8")),u=e}const d=(()=>{if(!a)return;let e=u+16;const t=_t(n.subarray(u,e));u=e,e=u+16;const r=_t(n.subarray(u,e));u=e;const s=o?_t(n.subarray(u)):n.subarray(u).toString("utf-8");return new Rt({rowId:s,spanId:t,rootSpanId:r})})();return new e({objectType:r,objectId:c,computeObjectMetadataArgs:l,rowIds:d})}catch(e){throw new Error("SpanComponents string is not properly encoded. This library only supports encoding versions up to 2. Please make sure the SDK library used to decode the SpanComponents is at least as new as any library used to encode it.")}}objectIdFields(){if(!this.objectId)throw new Error("Impossible: cannot invoke `object_id_fields` unless SpanComponentsV2 is initialized with an `object_id`");switch(this.objectType){case 1:return{experiment_id:this.objectId};case 2:return{project_id:this.objectId,log_id:"g"};default:throw new Error("Impossible")}}toObject(){var e;return{objectType:this.objectType,objectId:this.objectId,computeObjectMetadataArgs:this.computeObjectMetadataArgs,rowIds:null==(e=this.rowIds)?void 0:e.toObject()}}};function jt(...e){const t=e.reduce((e,t)=>e+t.length,0),n=new Uint8Array(t);let r=0;for(const t of e)n.set(t,r),r+=t.length;return n}var Nt=(e=>(e[e.EXPERIMENT=1]="EXPERIMENT",e[e.PROJECT_LOGS=2]="PROJECT_LOGS",e[e.PLAYGROUND_LOGS=3]="PLAYGROUND_LOGS",e))(Nt||{}),Lt=o.fc(Nt);var Dt=(e=>(e[e.OBJECT_ID=1]="OBJECT_ID",e[e.ROW_ID=2]="ROW_ID",e[e.SPAN_ID=3]="SPAN_ID",e[e.ROOT_SPAN_ID=4]="ROOT_SPAN_ID",e))(Dt||{}),Ut=o.fc(Dt),Ft={1:"object_id",2:"row_id",3:"span_id",4:"root_span_id"},Yt=o.Ik({object_type:Lt,propagated_event:o.g1(o.L5()).nullish()}).and(o.KC([o.Ik({object_id:o.Yj().nullish(),compute_object_metadata_args:o.lq(o.ch())}),o.Ik({object_id:o.lq(o.ch()),compute_object_metadata_args:o.g1(o.L5())})])).and(o.KC([o.Ik({row_id:o.Yj(),span_id:o.Yj(),root_span_id:o.Yj()}),o.Ik({row_id:o.lq(o.ch()),span_id:o.lq(o.ch()),root_span_id:o.lq(o.ch())})])),Gt=class e{constructor(e){this.data=e}toStr(){const e={compute_object_metadata_args:this.data.compute_object_metadata_args||void 0,propagated_event:this.data.propagated_event||void 0},t=[];t.push(new Uint8Array([3,this.data.object_type]));const n=[];function r(t,r){const s=function(e){try{const t=ft(e);if(16!==t.length)throw new Error;return{bytes:new Uint8Array(t),isUUID:!0}}catch(e){return{bytes:void 0,isUUID:!1}}}(t);s.isUUID?n.push(jt(new Uint8Array([r]),s.bytes)):e[Ft[r]]=t}if(this.data.object_id&&r(this.data.object_id,1),this.data.row_id&&r(this.data.row_id,2),this.data.span_id&&r(this.data.span_id,3),this.data.root_span_id&&r(this.data.root_span_id,4),n.length>255)throw new Error("Impossible: too many UUID entries to encode");var s;return t.push(new Uint8Array([n.length])),t.push(...n),Object.keys(e).length>0&&t.push((s=JSON.stringify(e),(new TextEncoder).encode(s))),function(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return btoa(t)}(jt(...t))}static fromStr(t){try{const r=function(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}(t),s={};if(r[0]<3){const e=$t.fromStr(t);s.object_type=e.objectType,s.object_id=e.objectId,s.compute_object_metadata_args=e.computeObjectMetadataArgs,e.rowIds&&(s.row_id=e.rowIds.rowId,s.span_id=e.rowIds.spanId,s.root_span_id=e.rowIds.rootSpanId)}else{s.object_type=r[1];const e=r[2];let t=3;for(let n=0;n<e;++n){const e=Ut.parse(r[t]),n=r.subarray(t+1,t+17);t+=17,s[Ft[e]]=_t(n)}if(t<r.length){const e=JSON.parse((n=r.subarray(t),new TextDecoder("utf-8").decode(n)));Object.assign(s,e)}}return e.fromJsonObj(s)}catch(e){throw new Error("SpanComponents string is not properly encoded. This library only supports encoding versions up to 3. Please make sure the SDK library used to decode the SpanComponents is at least as new as any library used to encode it.")}var n}objectIdFields(){if(!this.data.object_id)throw new Error("Impossible: cannot invoke `objectIdFields` unless SpanComponentsV3 is initialized with an `object_id`");switch(this.data.object_type){case 1:return{experiment_id:this.data.object_id};case 2:return{project_id:this.data.object_id,log_id:"g"};case 3:return{prompt_session_id:this.data.object_id,log_id:"x"};default:this.data.object_type;throw new Error("Impossible")}}static fromJsonObj(t){return new e(Yt.parse(t))}};function Bt(e){return e instanceof Object&&!(e instanceof Array)}function Ht(e){return e instanceof Object}function zt({mergeInto:e,mergeFrom:t,mergePaths:n}){return qt({mergeInto:e,mergeFrom:t,path:[],mergePaths:new Set(n.map(e=>JSON.stringify(e)))})}function qt({mergeInto:e,mergeFrom:t,path:n,mergePaths:r}){return Object.entries(t).forEach(([t,s])=>{const i=n.concat([t]),a=JSON.stringify(i),o=Vt(e,t);Bt(o)&&Bt(s)&&!r.has(a)?qt({mergeInto:o,mergeFrom:s,path:i,mergePaths:r}):e[t]=s}),e}function Kt(e,t){return zt({mergeInto:e,mergeFrom:t,mergePaths:[]})}function Wt(e,t){const n=e.get(t);if(void 0===n)throw new Error(`Map does not contain key ${t}`);return n}function Vt(e,t){return e[t]}function Jt(e,t){let n=e;for(const e of t){if(!Ht(n))return null;n=n[e]}return n}function Zt(e){var t;const{graph:n,firstVisitF:r,lastVisitF:s}=e;for(const e of n.values())for(const t of e.values())if(!n.has(t))throw new Error(`Outgoing vertex ${t} must be a key in the graph`);const i=new Set,a=(null!=(t=e.visitationOrder)?t:[...n.keys()]).map(e=>({eventType:"first",vertex:e,extras:{}})).reverse();for(;a.length;){const{eventType:e,vertex:t,extras:o}=a.pop();"last"!==e?i.has(t)||(i.add(t),null==r||r(t,{parentVertex:o.parentVertex}),a.push({eventType:"last",vertex:t,extras:{}}),Wt(n,t).forEach(e=>{a.push({eventType:"first",vertex:e,extras:{parentVertex:t}})})):null==s||s(t)}}function Xt(e,t){return JSON.stringify(["org_id","project_id","experiment_id","dataset_id","prompt_session_id","log_id",null!=t&&t?xt:"id"].map(t=>e[t]))}var Qt=["created","span_id","root_span_id","span_parents","_parent_id"];function en(e){const t={};for(const n of Qt)n in e&&(t[n]=e[n],delete e[n]);return t}function tn(e,t){for(const n of Qt)delete e[n],n in t&&(e[n]=t[n])}function nn(e){for(const t of e)if(void 0===t.id)throw new Error("Logged row is missing an id. This is an internal braintrust error. Please contact us at info@braintrust.dev for help");const t=new Map;for(const n of e){const e=Xt(n),r=t.get(e);if(void 0!==r&&n[wt]){const e=en(r),t=!r[wt];Kt(r,n),tn(r,e),t&&delete r[wt]}else t.set(e,n)}const n=[...t.values()],r=new Map(n.map((e,t)=>[Xt(e),t])),s=new Map(Array.from({length:n.length}).map((e,t)=>[t,new Set]));n.forEach((e,t)=>{if(!e[xt])return;const n=Xt(e,!0),i=r.get(n);void 0!==i&&Wt(s,i).add(t)});return function(e){const t=new Map([...e.vertices].map(e=>[e,new Set]));for(const[n,r]of e.edges)Wt(t,n).add(r),Wt(t,r).add(n);let n=0;const r=new Map;Zt({graph:t,firstVisitF:(e,t)=>{const s=void 0!==(null==t?void 0:t.parentVertex)?Wt(r,null==t?void 0:t.parentVertex):n++;r.set(e,s)}});const s=Array.from({length:n}).map(()=>[]);for(const[e,t]of r.entries())s[t].push(e);return s}({vertices:new Set(s.keys()),edges:new Set([...s.entries()].flatMap(([e,t])=>[...t].map(t=>[e,t])))}).map(e=>function(e,t){const n=[];return Zt({graph:e,lastVisitF:e=>{n.push(e)},visitationOrder:t}),n.reverse()}(s,e)).map(e=>e.map(e=>n[e]))}function rn(...e){return e.map((t,n)=>t.replace(/^\//,"").replace(n<e.length-1?/\/$/:"","")).filter(e=>""!==e.trim()).join("/")}var sn=(e=>(e.LLM="llm",e.SCORE="score",e.FUNCTION="function",e.EVAL="eval",e.TASK="task",e.TOOL="tool",e))(sn||{});BigInt("0x0DE1"),BigInt(48);var an=BigInt(1)<<BigInt(64),on=BigInt("205891132094649");BigInt("1522336535492693385");function cn(e,t){return e*t%an}Error;var ln=n(8322),un=Object.prototype.toString,dn=Array.isArray||function(e){return"[object Array]"===un.call(e)};function hn(e){return"function"==typeof e}function pn(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function mn(e,t){return null!=e&&"object"==typeof e&&t in e}function gn(e,t){return null!=e&&"object"!=typeof e&&e.hasOwnProperty&&e.hasOwnProperty(t)}var fn=RegExp.prototype.test;var yn=/\S/;function _n(e){return!function(e,t){return fn.call(e,t)}(yn,e)}var bn={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};var wn=/\s*/,vn=/\s+/,En=/\s*=/,Sn=/\s*\}/,xn=/#|\^|\/|>|\{|&|=|!/;function kn(e){this.string=e,this.tail=e,this.pos=0}function Tn(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function In(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}kn.prototype.eos=function(){return""===this.tail},kn.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n},kn.prototype.scanUntil=function(e){var t,n=this.tail.search(e);switch(n){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=t.length,t},Tn.prototype.push=function(e){return new Tn(e,this)},Tn.prototype.lookup=function(e){var t,n=this.cache;if(n.hasOwnProperty(e))t=n[e];else{for(var r,s,i,a=this,o=!1;a;){if(e.indexOf(".")>0)for(r=a.view,s=e.split("."),i=0;null!=r&&i<s.length;)i===s.length-1&&(o=mn(r,s[i])||gn(r,s[i])),r=r[s[i++]];else r=a.view[e],o=mn(a.view,e);if(o){t=r;break}a=a.parent}n[e]=t}return hn(t)&&(t=t.call(this.view)),t},In.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},In.prototype.parse=function(e,t){var n=this.templateCache,r=e+":"+(t||On.tags).join(":"),s=void 0!==n,i=s?n.get(r):void 0;return null==i&&(i=function(e,t){if(!e)return[];var n,r,s,i=!1,a=[],o=[],c=[],l=!1,u=!1,d="",h=0;function p(){if(l&&!u)for(;c.length;)delete o[c.pop()];else c=[];l=!1,u=!1}function m(e){if("string"==typeof e&&(e=e.split(vn,2)),!dn(e)||2!==e.length)throw new Error("Invalid tags: "+e);n=new RegExp(pn(e[0])+"\\s*"),r=new RegExp("\\s*"+pn(e[1])),s=new RegExp("\\s*"+pn("}"+e[1]))}m(t||On.tags);for(var g,f,y,_,b,w,v=new kn(e);!v.eos();){if(g=v.pos,y=v.scanUntil(n))for(var E=0,S=y.length;E<S;++E)_n(_=y.charAt(E))?(c.push(o.length),d+=_):(u=!0,i=!0,d+=" "),o.push(["text",_,g,g+1]),g+=1,"\n"===_&&(p(),d="",h=0,i=!1);if(!v.scan(n))break;if(l=!0,f=v.scan(xn)||"name",v.scan(wn),"="===f?(y=v.scanUntil(En),v.scan(En),v.scanUntil(r)):"{"===f?(y=v.scanUntil(s),v.scan(Sn),v.scanUntil(r),f="&"):y=v.scanUntil(r),!v.scan(r))throw new Error("Unclosed tag at "+v.pos);if(b=">"==f?[f,y,g,v.pos,d,h,i]:[f,y,g,v.pos],h++,o.push(b),"#"===f||"^"===f)a.push(b);else if("/"===f){if(!(w=a.pop()))throw new Error('Unopened section "'+y+'" at '+g);if(w[1]!==y)throw new Error('Unclosed section "'+w[1]+'" at '+g)}else"name"===f||"{"===f||"&"===f?u=!0:"="===f&&m(y)}if(p(),w=a.pop())throw new Error('Unclosed section "'+w[1]+'" at '+v.pos);return function(e){for(var t,n=[],r=n,s=[],i=0,a=e.length;i<a;++i)switch((t=e[i])[0]){case"#":case"^":r.push(t),s.push(t),r=t[4]=[];break;case"/":s.pop()[5]=t[2],r=s.length>0?s[s.length-1][4]:n;break;default:r.push(t)}return n}(function(e){for(var t,n,r=[],s=0,i=e.length;s<i;++s)(t=e[s])&&("text"===t[0]&&n&&"text"===n[0]?(n[1]+=t[1],n[3]=t[3]):(r.push(t),n=t));return r}(o))}(e,t),s&&n.set(r,i)),i},In.prototype.render=function(e,t,n,r){var s=this.getConfigTags(r),i=this.parse(e,s),a=t instanceof Tn?t:new Tn(t,void 0);return this.renderTokens(i,a,n,e,r)},In.prototype.renderTokens=function(e,t,n,r,s){for(var i,a,o,c="",l=0,u=e.length;l<u;++l)o=void 0,"#"===(a=(i=e[l])[0])?o=this.renderSection(i,t,n,r,s):"^"===a?o=this.renderInverted(i,t,n,r,s):">"===a?o=this.renderPartial(i,t,n,s):"&"===a?o=this.unescapedValue(i,t):"name"===a?o=this.escapedValue(i,t,s):"text"===a&&(o=this.rawValue(i)),void 0!==o&&(c+=o);return c},In.prototype.renderSection=function(e,t,n,r,s){var i=this,a="",o=t.lookup(e[1]);if(o){if(dn(o))for(var c=0,l=o.length;c<l;++c)a+=this.renderTokens(e[4],t.push(o[c]),n,r,s);else if("object"==typeof o||"string"==typeof o||"number"==typeof o)a+=this.renderTokens(e[4],t.push(o),n,r,s);else if(hn(o)){if("string"!=typeof r)throw new Error("Cannot use higher-order sections without the original template");null!=(o=o.call(t.view,r.slice(e[3],e[5]),function(e){return i.render(e,t,n,s)}))&&(a+=o)}else a+=this.renderTokens(e[4],t,n,r,s);return a}},In.prototype.renderInverted=function(e,t,n,r,s){var i=t.lookup(e[1]);if(!i||dn(i)&&0===i.length)return this.renderTokens(e[4],t,n,r,s)},In.prototype.indentPartial=function(e,t,n){for(var r=t.replace(/[^ \t]/g,""),s=e.split("\n"),i=0;i<s.length;i++)s[i].length&&(i>0||!n)&&(s[i]=r+s[i]);return s.join("\n")},In.prototype.renderPartial=function(e,t,n,r){if(n){var s=this.getConfigTags(r),i=hn(n)?n(e[1]):n[e[1]];if(null!=i){var a=e[6],o=e[5],c=e[4],l=i;0==o&&c&&(l=this.indentPartial(i,c,a));var u=this.parse(l,s);return this.renderTokens(u,t,n,l,r)}}},In.prototype.unescapedValue=function(e,t){var n=t.lookup(e[1]);if(null!=n)return n},In.prototype.escapedValue=function(e,t,n){var r=this.getConfigEscape(n)||On.escape,s=t.lookup(e[1]);if(null!=s)return"number"==typeof s&&r===On.escape?String(s):r(s)},In.prototype.rawValue=function(e){return e[1]},In.prototype.getConfigTags=function(e){return dn(e)?e:e&&"object"==typeof e?e.tags:void 0},In.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!dn(e)?e.escape:void 0};var On={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){Cn.templateCache=e},get templateCache(){return Cn.templateCache}},Cn=new In;On.clearCache=function(){return Cn.clearCache()},On.parse=function(e,t){return Cn.parse(e,t)},On.render=function(e,t,n,r){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+((dn(s=e)?"array":typeof s)+'" was given as the first argument for mustache#render(template, view, partials)'));var s;return Cn.render(e,t,n,r)},On.escape=function(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return bn[e]})},On.Scanner=kn,On.Context=Tn,On.Writer=In;const An=On;var Pn=n(5616);const Mn=[239,187,191];var Rn=Object.defineProperty,$n=class{constructor(){}enterWith(e){}run(e,t){return t()}getStore(){}},jn={getRepoInfo:async e=>{},getPastNAncestors:async()=>[],getEnv:e=>{},getCallerLocation:()=>{},newAsyncLocalStorage:()=>new $n,processOn:(e,t)=>{}},Nn=class{items=[];maxSize;enforceSizeLimit=!1;constructor(e){e<1&&(e=15e3),this.maxSize=e}enforceQueueSizeLimit(e){this.enforceSizeLimit=e}push(...e){const t=[];for(const n of e)this.enforceSizeLimit&&this.items.length>=this.maxSize?t.push(n):this.items.push(n);return t}peek(){return this.items[0]}drain(){const e=[...this.items];return this.items=[],e}clear(){this.items=[]}length(){return this.items.length}get capacity(){return this.maxSize}},Ln=o.KC([o.k5(["organization","project","experiment","dataset","prompt","prompt_session","group","role","org_member","project_log","org_project"]),o.ch()]),Dn=o.k5(["create","read","update","delete","create_acls","read_acls","update_acls","delete_acls"]),Un=(o.Ik({id:o.Yj().uuid(),object_type:Ln.and(o.Yj()),object_id:o.Yj().uuid(),user_id:o.KC([o.Yj(),o.ch()]).optional(),group_id:o.KC([o.Yj(),o.ch()]).optional(),permission:Dn.and(o.KC([o.Yj(),o.ch()])).optional(),restrict_object_type:Ln.and(o.L5()).optional(),role_id:o.KC([o.Yj(),o.ch()]).optional(),_object_org_id:o.Yj().uuid(),created:o.KC([o.Yj(),o.ch()]).optional()}),o.Ik({id:o.Yj().uuid(),created:o.KC([o.Yj(),o.ch()]).optional(),updated_at:o.KC([o.Yj(),o.ch()]).optional(),org_id:o.Yj().uuid(),name:o.Yj(),type:o.KC([o.Yj(),o.ch()]).optional(),metadata:o.KC([o.Ik({}).partial().passthrough(),o.ch()]).optional(),preview_secret:o.KC([o.Yj(),o.ch()]).optional()}),o.Ik({name:o.Yj(),description:o.Yj().optional(),schema:o.KC([o.Ik({}).partial().passthrough(),o.Yj()]).optional(),strict:o.KC([o.zM(),o.ch()]).optional()})),Fn=o.KC([o.Ik({type:o.eu("json_object")}),o.Ik({type:o.eu("json_schema"),json_schema:Un}),o.Ik({type:o.eu("text")}),o.ch()]),Yn=(o.Ik({temperature:o.ai().optional(),top_p:o.ai().optional(),max_tokens:o.ai(),max_completion_tokens:o.ai().optional(),frequency_penalty:o.ai().optional(),presence_penalty:o.ai().optional(),response_format:Fn.optional(),tool_choice:o.KC([o.eu("auto"),o.eu("none"),o.eu("required"),o.Ik({type:o.eu("function"),function:o.Ik({name:o.Yj()})})]).optional(),function_call:o.KC([o.eu("auto"),o.eu("none"),o.Ik({name:o.Yj()})]).optional(),n:o.ai().optional(),stop:o.YO(o.Yj()).optional(),reasoning_effort:o.k5(["minimal","low","medium","high"]).optional(),verbosity:o.k5(["low","medium","high"]).optional(),top_k:o.ai().optional(),stop_sequences:o.YO(o.Yj()).optional(),max_tokens_to_sample:o.ai().optional(),maxOutputTokens:o.ai().optional(),topP:o.ai().optional(),topK:o.ai().optional(),use_cache:o.zM().optional()}),o.Ik({id:o.Yj().uuid(),created:o.KC([o.Yj(),o.ch()]).optional(),name:o.Yj(),preview_name:o.Yj(),user_id:o.KC([o.Yj(),o.ch()]).optional(),user_email:o.KC([o.Yj(),o.ch()]).optional(),user_given_name:o.KC([o.Yj(),o.ch()]).optional(),user_family_name:o.KC([o.Yj(),o.ch()]).optional(),org_id:o.KC([o.Yj(),o.ch()]).optional()}),o.KC([o.Ik({status:o.eu("enabled"),token:o.Yj(),function_ids:o.YO(o.L5()).min(1),skip_logging:o.KC([o.zM(),o.ch()]).optional()}),o.Ik({status:o.eu("disabled")}),o.ch(),o.ch()])),Gn=(o.KC([o.Ik({kind:o.eu("score_update"),token:o.Yj()}),o.Ik({kind:o.eu("state_override"),state:Yn}),o.Ik({kind:o.eu("state_force_reselect")}),o.Ik({kind:o.eu("state_enabled_force_rescore")})]),o.Ik({type:o.eu("braintrust_attachment"),filename:o.Yj().min(1),content_type:o.Yj().min(1),key:o.Yj().min(1)})),Bn=o.Ik({type:o.eu("external_attachment"),filename:o.Yj().min(1),content_type:o.Yj().min(1),url:o.Yj().min(1)}),Hn=o.gM("type",[Gn,Bn]),zn=o.k5(["uploading","done","error"]),qn=o.Ik({upload_status:zn,error_message:o.Yj().optional()}),Kn=o.Ik({use_cache:o.zM()}).partial(),Wn=o.KC([o.Ik({id:o.Yj().optional(),data:o.Yj(),event:o.eu("text_delta")}),o.Ik({id:o.Yj().optional(),data:o.Yj(),event:o.eu("reasoning_delta")}),o.Ik({id:o.Yj().optional(),data:o.Yj(),event:o.eu("json_delta")}),o.Ik({id:o.Yj().optional(),data:o.Yj(),event:o.eu("progress")}),o.Ik({id:o.Yj().optional(),data:o.Yj(),event:o.eu("error")}),o.Ik({id:o.Yj().optional(),data:o.Yj(),event:o.eu("console")}),o.Ik({id:o.Yj().optional(),event:o.eu("start"),data:o.eu("")}),o.Ik({id:o.Yj().optional(),event:o.eu("done"),data:o.eu("")})]),Vn=o.Ik({text:o.Yj().default(""),type:o.eu("text"),cache_control:o.Ik({type:o.eu("ephemeral")}).optional()}),Jn=o.Ik({image_url:o.Ik({url:o.Yj(),detail:o.KC([o.eu("auto"),o.eu("low"),o.eu("high")]).optional()}),type:o.eu("image_url")}),Zn=o.KC([Vn,Jn]),Xn=o.Ik({text:o.Yj().default(""),type:o.eu("text"),cache_control:o.Ik({type:o.eu("ephemeral")}).optional()}),Qn=o.Ik({id:o.Yj(),function:o.Ik({arguments:o.Yj(),name:o.Yj()}),type:o.eu("function")}),er=o.Ik({id:o.Yj(),content:o.Yj()}).partial(),tr=o.KC([o.Ik({content:o.KC([o.Yj(),o.YO(Xn)]),role:o.eu("system"),name:o.Yj().optional()}),o.Ik({content:o.KC([o.Yj(),o.YO(Zn)]),role:o.eu("user"),name:o.Yj().optional()}),o.Ik({role:o.eu("assistant"),content:o.KC([o.Yj(),o.YO(Xn),o.ch()]).optional(),function_call:o.Ik({arguments:o.Yj(),name:o.Yj()}).optional(),name:o.Yj().optional(),tool_calls:o.YO(Qn).optional(),reasoning:o.YO(er).optional()}),o.Ik({content:o.KC([o.Yj(),o.YO(Xn)]),role:o.eu("tool"),tool_call_id:o.Yj().default("")}),o.Ik({content:o.KC([o.Yj(),o.ch()]),name:o.Yj(),role:o.eu("function")}),o.Ik({content:o.KC([o.Yj(),o.YO(Xn)]),role:o.eu("developer"),name:o.Yj().optional()}),o.Ik({role:o.eu("model"),content:o.KC([o.Yj(),o.ch()]).optional()})]),nr=(o.KC([o.Ik({content:o.KC([o.Yj(),o.YO(Xn)]),role:o.eu("system"),name:o.Yj().optional()}),o.Ik({content:o.KC([o.Yj(),o.YO(Zn)]),role:o.eu("user"),name:o.Yj().optional()}),o.Ik({role:o.eu("assistant"),content:o.KC([o.Yj(),o.YO(Xn),o.ch()]).optional(),function_call:o.Ik({arguments:o.Yj(),name:o.Yj()}).optional(),name:o.Yj().optional(),tool_calls:o.YO(Qn).optional(),reasoning:o.YO(er).optional()}),o.Ik({content:o.KC([o.Yj(),o.YO(Xn)]),role:o.eu("tool"),tool_call_id:o.Yj().default("")}),o.Ik({content:o.KC([o.Yj(),o.ch()]),name:o.Yj(),role:o.eu("function")}),o.Ik({content:o.KC([o.Yj(),o.YO(Xn)]),role:o.eu("developer"),name:o.Yj().optional()})]),o.Ik({function:o.Ik({name:o.Yj(),description:o.Yj().optional(),parameters:o.Ik({}).partial().passthrough().optional()}),type:o.eu("function")})),rr=o.Ik({runtime_context:o.Ik({runtime:o.k5(["node","python"]),version:o.Yj()}),location:o.KC([o.Ik({type:o.eu("experiment"),eval_name:o.Yj(),position:o.KC([o.Ik({type:o.eu("task")}),o.Ik({type:o.eu("scorer"),index:o.ai().int().gte(0)})])}),o.Ik({type:o.eu("function"),index:o.ai().int().gte(0)})]),bundle_id:o.Yj(),preview:o.KC([o.Yj(),o.ch()]).optional()}),sr=(o.Ik({id:o.Yj().uuid(),project_id:o.Yj().uuid(),name:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional(),deleted_at:o.KC([o.Yj(),o.ch()]).optional(),user_id:o.KC([o.Yj(),o.ch()]).optional(),metadata:o.KC([o.Ik({}).partial().passthrough(),o.ch()]).optional()}),o.KC([o.Ik({object_type:o.k5(["project_logs","experiment","dataset","prompt","function","prompt_session"]),object_id:o.Yj().uuid(),id:o.Yj(),_xact_id:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional()}),o.ch()])),ir=(o.Ik({id:o.Yj(),_xact_id:o.Yj(),created:o.Yj().datetime({offset:!0}),_pagination_key:o.KC([o.Yj(),o.ch()]).optional(),project_id:o.Yj().uuid(),dataset_id:o.Yj().uuid(),input:o.L5().optional(),expected:o.L5().optional(),metadata:o.KC([o.Ik({model:o.KC([o.Yj(),o.ch()])}).partial().passthrough(),o.ch()]).optional(),tags:o.KC([o.YO(o.Yj()),o.ch()]).optional(),span_id:o.Yj(),root_span_id:o.Yj(),is_root:o.KC([o.zM(),o.ch()]).optional(),origin:sr.optional()}),o.Ik({id:o.Yj().uuid(),object_type:o.k5(["organization","project","function"]),object_id:o.Yj().uuid(),name:o.Yj(),created:o.KC([o.Yj(),o.ch()]).optional(),used:o.KC([o.Yj(),o.ch()]).optional()}),o.KC([o.Ik({commit:o.KC([o.Yj(),o.ch()]),branch:o.KC([o.Yj(),o.ch()]),tag:o.KC([o.Yj(),o.ch()]),dirty:o.KC([o.zM(),o.ch()]),author_name:o.KC([o.Yj(),o.ch()]),author_email:o.KC([o.Yj(),o.ch()]),commit_message:o.KC([o.Yj(),o.ch()]),commit_time:o.KC([o.Yj(),o.ch()]),git_diff:o.KC([o.Yj(),o.ch()])}).partial(),o.ch()])),ar=(o.Ik({id:o.Yj().uuid(),project_id:o.Yj().uuid(),name:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional(),repo_info:ir.optional(),commit:o.KC([o.Yj(),o.ch()]).optional(),base_exp_id:o.KC([o.Yj(),o.ch()]).optional(),deleted_at:o.KC([o.Yj(),o.ch()]).optional(),dataset_id:o.KC([o.Yj(),o.ch()]).optional(),dataset_version:o.KC([o.Yj(),o.ch()]).optional(),public:o.zM(),user_id:o.KC([o.Yj(),o.ch()]).optional(),metadata:o.KC([o.Ik({}).partial().passthrough(),o.ch()]).optional(),tags:o.KC([o.YO(o.Yj()),o.ch()]).optional()}),o.KC([o.k5(["llm","score","function","eval","task","tool"]),o.ch()])),or=o.KC([o.Ik({name:o.KC([o.Yj(),o.ch()]),type:ar}).partial().passthrough(),o.ch()]),cr=(o.Ik({id:o.Yj(),_xact_id:o.Yj(),created:o.Yj().datetime({offset:!0}),_pagination_key:o.KC([o.Yj(),o.ch()]).optional(),project_id:o.Yj().uuid(),experiment_id:o.Yj().uuid(),input:o.L5().optional(),output:o.L5().optional(),expected:o.L5().optional(),error:o.L5().optional(),scores:o.KC([o.g1(o.KC([o.ai(),o.ch()])),o.ch()]).optional(),metadata:o.KC([o.Ik({model:o.KC([o.Yj(),o.ch()])}).partial().passthrough(),o.ch()]).optional(),tags:o.KC([o.YO(o.Yj()),o.ch()]).optional(),metrics:o.KC([o.g1(o.ai()),o.ch()]).optional(),context:o.KC([o.Ik({caller_functionname:o.KC([o.Yj(),o.ch()]),caller_filename:o.KC([o.Yj(),o.ch()]),caller_lineno:o.KC([o.ai(),o.ch()])}).partial().passthrough(),o.ch()]).optional(),span_id:o.Yj(),span_parents:o.KC([o.YO(o.Yj()),o.ch()]).optional(),root_span_id:o.Yj(),span_attributes:or.optional(),is_root:o.KC([o.zM(),o.ch()]).optional(),origin:sr.optional()}),o.KC([o.Ik({type:o.eu("function"),id:o.Yj()}),o.Ik({type:o.eu("global"),name:o.Yj()}),o.Ik({type:o.eu("slug"),project_id:o.Yj(),slug:o.Yj()})]),o.KC([o.Ik({type:o.eu("completion"),content:o.Yj()}),o.Ik({type:o.eu("chat"),messages:o.YO(tr),tools:o.Yj().optional()}),o.ch()])),lr=o.KC([o.Ik({use_cache:o.zM(),temperature:o.ai(),top_p:o.ai(),max_tokens:o.ai(),max_completion_tokens:o.ai(),frequency_penalty:o.ai(),presence_penalty:o.ai(),response_format:Fn,tool_choice:o.KC([o.eu("auto"),o.eu("none"),o.eu("required"),o.Ik({type:o.eu("function"),function:o.Ik({name:o.Yj()})})]),function_call:o.KC([o.eu("auto"),o.eu("none"),o.Ik({name:o.Yj()})]),n:o.ai(),stop:o.YO(o.Yj()),reasoning_effort:o.k5(["minimal","low","medium","high"]),verbosity:o.k5(["low","medium","high"])}).partial().passthrough(),o.Ik({use_cache:o.zM().optional(),max_tokens:o.ai(),temperature:o.ai(),top_p:o.ai().optional(),top_k:o.ai().optional(),stop_sequences:o.YO(o.Yj()).optional(),max_tokens_to_sample:o.ai().optional()}).passthrough(),o.Ik({use_cache:o.zM(),temperature:o.ai(),maxOutputTokens:o.ai(),topP:o.ai(),topK:o.ai()}).partial().passthrough(),o.Ik({use_cache:o.zM(),temperature:o.ai(),topK:o.ai()}).partial().passthrough(),o.Ik({use_cache:o.zM()}).partial().passthrough()]),ur=o.KC([o.Ik({model:o.Yj(),params:lr,position:o.Yj()}).partial(),o.ch()]),dr=o.KC([o.Ik({type:o.eu("llm_classifier"),use_cot:o.zM(),choice_scores:o.g1(o.ai().gte(0).lte(1))}),o.ch()]),hr=o.KC([o.Ik({type:o.eu("function"),id:o.Yj()}),o.Ik({type:o.eu("global"),name:o.Yj()})]),pr=o.KC([o.Ik({prompt:cr,options:ur,parser:dr,tool_functions:o.KC([o.YO(hr),o.ch()]),origin:o.KC([o.Ik({prompt_id:o.Yj(),project_id:o.Yj(),prompt_version:o.Yj()}).partial(),o.ch()])}).partial(),o.ch()]),mr=o.KC([o.k5(["llm","scorer","task","tool"]),o.ch()]),gr=o.Ik({}).partial().passthrough(),fr=o.KC([o.Ik({type:o.eu("completion"),content:o.Yj()}),o.Ik({type:o.eu("chat"),messages:o.YO(tr),tools:o.Yj().optional()})]),yr=o.KC([o.Ik({description:o.KC([o.Yj(),o.ch()]).optional(),position:o.KC([o.Ik({x:o.ai(),y:o.ai()}),o.ch()]).optional(),type:o.eu("function"),function:gr}),o.Ik({description:o.KC([o.Yj(),o.ch()]).optional(),position:o.KC([o.Ik({x:o.ai(),y:o.ai()}),o.ch()]).optional(),type:o.eu("input")}),o.Ik({description:o.KC([o.Yj(),o.ch()]).optional(),position:o.KC([o.Ik({x:o.ai(),y:o.ai()}),o.ch()]).optional(),type:o.eu("output")}),o.Ik({description:o.KC([o.Yj(),o.ch()]).optional(),position:o.KC([o.Ik({x:o.ai(),y:o.ai()}),o.ch()]).optional(),type:o.eu("literal"),value:o.L5().optional()}),o.Ik({description:o.KC([o.Yj(),o.ch()]).optional(),position:o.KC([o.Ik({x:o.ai(),y:o.ai()}),o.ch()]).optional(),type:o.eu("btql"),expr:o.Yj()}),o.Ik({description:o.KC([o.Yj(),o.ch()]).optional(),position:o.KC([o.Ik({x:o.ai(),y:o.ai()}),o.ch()]).optional(),type:o.eu("gate"),condition:o.KC([o.Yj(),o.ch()]).optional()}),o.Ik({description:o.KC([o.Yj(),o.ch()]).optional(),position:o.KC([o.Ik({x:o.ai(),y:o.ai()}),o.ch()]).optional(),type:o.eu("aggregator")}),o.Ik({description:o.KC([o.Yj(),o.ch()]).optional(),position:o.KC([o.Ik({x:o.ai(),y:o.ai()}),o.ch()]).optional(),type:o.eu("prompt_template"),prompt:fr})]),_r=o.Ik({source:o.Ik({node:o.Yj().max(1024),variable:o.Yj()}),target:o.Ik({node:o.Yj().max(1024),variable:o.Yj()}),purpose:o.k5(["control","data","messages"])}),br=o.Ik({type:o.eu("graph"),nodes:o.g1(yr),edges:o.g1(_r)}),wr=o.KC([o.Ik({type:o.eu("prompt")}),o.Ik({type:o.eu("code"),data:o.KC([o.Ik({type:o.eu("bundle")}).and(rr),o.Ik({type:o.eu("inline"),runtime_context:o.Ik({runtime:o.k5(["node","python"]),version:o.Yj()}),code:o.Yj()})])}),br,o.Ik({type:o.eu("remote_eval"),endpoint:o.Yj(),eval_name:o.Yj(),parameters:o.Ik({}).partial().passthrough()}),o.Ik({type:o.eu("global"),name:o.Yj()})]),vr=(o.Ik({id:o.Yj().uuid(),_xact_id:o.Yj(),project_id:o.Yj().uuid(),log_id:o.eu("p"),org_id:o.Yj().uuid(),name:o.Yj(),slug:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional(),prompt_data:pr.optional(),tags:o.KC([o.YO(o.Yj()),o.ch()]).optional(),metadata:o.KC([o.Ik({}).partial().passthrough(),o.ch()]).optional(),function_type:mr.optional(),function_data:wr,origin:o.KC([o.Ik({object_type:Ln.and(o.Yj()),object_id:o.Yj().uuid(),internal:o.KC([o.zM(),o.ch()]).optional()}),o.ch()]).optional(),function_schema:o.KC([o.Ik({parameters:o.L5(),returns:o.L5()}).partial(),o.ch()]).optional()}),o.k5(["llm","code","global","graph"])),Er=o.Ik({prompt:cr,options:ur,parser:dr,tool_functions:o.KC([o.YO(hr),o.ch()]),origin:o.KC([o.Ik({prompt_id:o.Yj(),project_id:o.Yj(),prompt_version:o.Yj()}).partial(),o.ch()])}).partial(),Sr=o.k5(["llm","scorer","task","tool"]),xr=o.KC([o.Ik({function_id:o.Yj(),version:o.Yj().optional()}),o.Ik({project_name:o.Yj(),slug:o.Yj(),version:o.Yj().optional()}),o.Ik({global_function:o.Yj()}),o.Ik({prompt_session_id:o.Yj(),prompt_session_function_id:o.Yj(),version:o.Yj().optional()}),o.Ik({inline_context:o.Ik({runtime:o.k5(["node","python"]),version:o.Yj()}),code:o.Yj(),name:o.KC([o.Yj(),o.ch()]).optional()}),o.Ik({inline_prompt:Er.optional(),inline_function:o.Ik({}).partial().passthrough(),function_type:Sr.optional(),name:o.KC([o.Yj(),o.ch()]).optional()}),o.Ik({inline_prompt:Er,function_type:Sr.optional(),name:o.KC([o.Yj(),o.ch()]).optional()})]),kr=o.k5(["prompt","tool","scorer","task","agent"]),Tr=o.k5(["completion","score","any"]),Ir=o.Ik({collect:o.k5(["all","none","some"]),fields:o.YO(o.k5(["commit","branch","tag","dirty","author_name","author_email","commit_message","commit_time","git_diff"])).optional()}),Or=(o.Ik({id:o.Yj().uuid(),org_id:o.Yj().uuid(),user_id:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional(),name:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),deleted_at:o.KC([o.Yj(),o.ch()]).optional(),member_users:o.KC([o.YO(o.Yj().uuid()),o.ch()]).optional(),member_groups:o.KC([o.YO(o.Yj().uuid()),o.ch()]).optional()}),o.k5(["error","ignore","replace"]),o.KC([o.Ik({object_type:o.k5(["project_logs","experiment","playground_logs"]),object_id:o.Yj(),row_ids:o.KC([o.Ik({id:o.Yj(),span_id:o.Yj(),root_span_id:o.Yj()}),o.ch()]).optional(),propagated_event:o.KC([o.Ik({}).partial().passthrough(),o.ch()]).optional()}),o.Yj()])),Cr=o.KC([o.k5(["auto","parallel"]),o.ch()]),Ar=(xr.and(o.Ik({input:o.L5(),expected:o.L5(),metadata:o.KC([o.Ik({}).partial().passthrough(),o.ch()]),tags:o.KC([o.YO(o.Yj()),o.ch()]),messages:o.YO(tr),parent:Or,stream:o.KC([o.zM(),o.ch()]),mode:Cr,strict:o.KC([o.zM(),o.ch()])}).partial()),o.k5(["system","user","assistant","function","tool","model","developer"]),o.Ik({object_type:o.k5(["project_logs","experiment","dataset","prompt","function","prompt_session"]),object_id:o.Yj().uuid(),id:o.Yj(),_xact_id:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional()}),o.KC([o.Ik({sampling_rate:o.ai().gte(0).lte(1),scorers:o.YO(hr),btql_filter:o.KC([o.Yj(),o.ch()]).optional(),apply_to_root_span:o.KC([o.zM(),o.ch()]).optional(),apply_to_span_names:o.KC([o.YO(o.Yj()),o.ch()]).optional(),skip_logging:o.KC([o.zM(),o.ch()]).optional()}),o.ch()])),Pr=(o.Ik({id:o.Yj().uuid(),name:o.Yj(),api_url:o.KC([o.Yj(),o.ch()]).optional(),is_universal_api:o.KC([o.zM(),o.ch()]).optional(),proxy_url:o.KC([o.Yj(),o.ch()]).optional(),realtime_url:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional()}),o.KC([o.Ik({comparison_key:o.KC([o.Yj(),o.ch()]),baseline_experiment_id:o.KC([o.Yj(),o.ch()]),spanFieldOrder:o.KC([o.YO(o.Ik({object_type:o.Yj(),column_id:o.Yj(),position:o.Yj(),layout:o.KC([o.eu("full"),o.eu("two_column"),o.ch()]).optional()})),o.ch()]),remote_eval_sources:o.KC([o.YO(o.Ik({url:o.Yj(),name:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional()})),o.ch()])}).partial(),o.ch()])),Mr=(o.Ik({id:o.Yj().uuid(),org_id:o.Yj().uuid(),name:o.Yj(),created:o.KC([o.Yj(),o.ch()]).optional(),deleted_at:o.KC([o.Yj(),o.ch()]).optional(),user_id:o.KC([o.Yj(),o.ch()]).optional(),settings:Pr.optional()}),o.k5(["project_logs","experiment","dataset"])),Rr=(o.Ik({id:o.Yj().uuid(),project_id:o.Yj().uuid(),user_id:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional(),name:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),config:o.KC([o.Ik({event_type:o.eu("logs"),btql_filter:o.Yj(),interval_seconds:o.ai().gte(1).lte(2592e3),action:o.Ik({type:o.eu("webhook"),url:o.Yj()})}),o.Ik({event_type:o.eu("btql_export"),export_definition:o.KC([o.Ik({type:o.eu("log_traces")}),o.Ik({type:o.eu("log_spans")}),o.Ik({type:o.eu("btql_query"),btql_query:o.Yj()})]),export_path:o.Yj(),format:o.k5(["jsonl","parquet"]),interval_seconds:o.ai().gte(1).lte(2592e3),credentials:o.Ik({type:o.eu("aws_iam"),role_arn:o.Yj(),external_id:o.Yj()}),batch_size:o.KC([o.ai(),o.ch()]).optional()}),o.Ik({event_type:o.eu("retention"),object_type:Mr,retention_days:o.ai().gte(0)})])}),o.Ik({id:o.Yj(),_xact_id:o.Yj(),_pagination_key:o.KC([o.Yj(),o.ch()]).optional(),created:o.Yj().datetime({offset:!0}),org_id:o.Yj().uuid(),project_id:o.Yj().uuid(),log_id:o.eu("g"),input:o.L5().optional(),output:o.L5().optional(),expected:o.L5().optional(),error:o.L5().optional(),scores:o.KC([o.g1(o.KC([o.ai(),o.ch()])),o.ch()]).optional(),metadata:o.KC([o.Ik({model:o.KC([o.Yj(),o.ch()])}).partial().passthrough(),o.ch()]).optional(),tags:o.KC([o.YO(o.Yj()),o.ch()]).optional(),metrics:o.KC([o.g1(o.ai()),o.ch()]).optional(),context:o.KC([o.Ik({caller_functionname:o.KC([o.Yj(),o.ch()]),caller_filename:o.KC([o.Yj(),o.ch()]),caller_lineno:o.KC([o.ai(),o.ch()])}).partial().passthrough(),o.ch()]).optional(),span_id:o.Yj(),span_parents:o.KC([o.YO(o.Yj()),o.ch()]).optional(),root_span_id:o.Yj(),is_root:o.KC([o.zM(),o.ch()]).optional(),span_attributes:or.optional(),origin:sr.optional()}),o.k5(["slider","categorical","weighted","minimum","maximum","online","free-form"])),$r=o.Ik({name:o.Yj(),value:o.ai()}),jr=o.KC([o.YO($r),o.g1(o.ai()),o.YO(o.Yj()),o.ch()]),Nr=o.KC([o.Ik({multi_select:o.KC([o.zM(),o.ch()]),destination:o.KC([o.Yj(),o.ch()]),online:Ar}).partial(),o.ch()]),Lr=(o.Ik({id:o.Yj().uuid(),project_id:o.Yj().uuid(),user_id:o.Yj().uuid(),created:o.KC([o.Yj(),o.ch()]).optional(),name:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),score_type:Rr,categories:jr.optional(),config:Nr.optional(),position:o.KC([o.Yj(),o.ch()]).optional()}),o.Ik({id:o.Yj().uuid(),project_id:o.Yj().uuid(),user_id:o.Yj().uuid(),created:o.KC([o.Yj(),o.ch()]).optional(),name:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),color:o.KC([o.Yj(),o.ch()]).optional(),position:o.KC([o.Yj(),o.ch()]).optional()}),o.Ik({id:o.Yj().uuid(),_xact_id:o.Yj(),project_id:o.Yj().uuid(),log_id:o.eu("p"),org_id:o.Yj().uuid(),name:o.Yj(),slug:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional(),prompt_data:pr.optional(),tags:o.KC([o.YO(o.Yj()),o.ch()]).optional(),metadata:o.KC([o.Ik({}).partial().passthrough(),o.ch()]).optional(),function_type:mr.optional()})),Dr=(o.Ik({model:o.Yj(),params:lr,position:o.Yj()}).partial(),o.Ik({id:o.Yj(),_xact_id:o.Yj(),created:o.Yj().datetime({offset:!0}),_pagination_key:o.KC([o.Yj(),o.ch()]).optional(),project_id:o.Yj().uuid(),prompt_session_id:o.Yj().uuid(),prompt_session_data:o.L5().optional(),prompt_data:o.L5().optional(),function_data:o.L5().optional(),function_type:mr.optional(),object_data:o.L5().optional(),completion:o.L5().optional(),tags:o.KC([o.YO(o.Yj()),o.ch()]).optional()}),o.KC([o.Ik({type:o.eu("json_object")}),o.Ik({type:o.eu("json_schema"),json_schema:Un}),o.Ik({type:o.eu("text")})]),o.Ik({id:o.Yj().uuid(),org_id:o.KC([o.Yj(),o.ch()]).optional(),user_id:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional(),name:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),deleted_at:o.KC([o.Yj(),o.ch()]).optional(),member_permissions:o.KC([o.YO(o.Ik({permission:Dn,restrict_object_type:Ln.optional()})),o.ch()]).optional(),member_roles:o.KC([o.YO(o.Yj().uuid()),o.ch()]).optional()}),o.Ik({project_id:o.Yj(),data:o.KC([o.Ik({dataset_id:o.Yj(),_internal_btql:o.KC([o.Ik({}).partial().passthrough(),o.ch()]).optional()}),o.Ik({project_name:o.Yj(),dataset_name:o.Yj(),_internal_btql:o.KC([o.Ik({}).partial().passthrough(),o.ch()]).optional()}),o.Ik({data:o.YO(o.L5())})]),task:xr.and(o.L5()),scores:o.YO(xr),experiment_name:o.Yj().optional(),metadata:o.Ik({}).partial().passthrough().optional(),parent:Or.and(o.L5()).optional(),stream:o.zM().optional(),trial_count:o.KC([o.ai(),o.ch()]).optional(),is_public:o.KC([o.zM(),o.ch()]).optional(),timeout:o.KC([o.ai(),o.ch()]).optional(),max_concurrency:o.KC([o.ai(),o.ch()]).optional().default(10),base_experiment_name:o.KC([o.Yj(),o.ch()]).optional(),base_experiment_id:o.KC([o.Yj(),o.ch()]).optional(),git_metadata_settings:Ir.and(o.KC([o.Ik({}).partial(),o.ch()])).optional(),repo_info:ir.and(o.L5()).optional(),strict:o.KC([o.zM(),o.ch()]).optional(),stop_token:o.KC([o.Yj(),o.ch()]).optional(),extra_messages:o.Yj().optional(),tags:o.YO(o.Yj()).optional()})),Ur=(o.Ik({id:o.Yj().uuid(),created:o.KC([o.Yj(),o.ch()]).optional(),name:o.Yj(),preview_name:o.Yj(),service_account_id:o.KC([o.Yj(),o.ch()]).optional(),service_account_email:o.KC([o.Yj(),o.ch()]).optional(),service_account_name:o.KC([o.Yj(),o.ch()]).optional(),org_id:o.KC([o.Yj(),o.ch()]).optional()}),o.Ik({id:o.Yj().uuid(),project_id:o.Yj().uuid(),user_id:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional(),deleted_at:o.KC([o.Yj(),o.ch()]).optional(),name:o.Yj(),description:o.KC([o.Yj(),o.ch()]).optional(),url:o.Yj(),post_message:o.KC([o.zM(),o.ch()]).optional()}),o.Ik({stream:o.k5(["stderr","stdout"]),message:o.Yj()})),Fr=o.Ik({id:o.Yj(),object_type:kr,origin:sr.and(o.L5()).optional(),format:vr,output_type:Tr,name:o.Yj(),event:o.k5(["reasoning_delta","text_delta","json_delta","error","console","start","done","progress"]),data:o.Yj()}),Yr=(o.Ik({type:o.eu("function"),function:o.Ik({name:o.Yj(),description:o.Yj().optional(),parameters:o.Ik({}).partial().passthrough().optional(),strict:o.KC([o.zM(),o.ch()]).optional()})}),o.Ik({id:o.Yj().uuid(),given_name:o.KC([o.Yj(),o.ch()]).optional(),family_name:o.KC([o.Yj(),o.ch()]).optional(),email:o.KC([o.Yj(),o.ch()]).optional(),avatar_url:o.KC([o.Yj(),o.ch()]).optional(),created:o.KC([o.Yj(),o.ch()]).optional()}),o.KC([o.Ik({filter:o.KC([o.YO(o.L5()),o.ch()]),tag:o.KC([o.YO(o.L5()),o.ch()]),match:o.KC([o.YO(o.L5()),o.ch()]),sort:o.KC([o.YO(o.L5()),o.ch()])}).partial(),o.ch()])),Gr=o.KC([o.Ik({search:Yr}).partial(),o.ch()]),Br=o.KC([o.Ik({viewType:o.eu("monitor"),options:o.Ik({spanType:o.KC([o.k5(["range","frame"]),o.ch()]),rangeValue:o.KC([o.Yj(),o.ch()]),frameStart:o.KC([o.Yj(),o.ch()]),frameEnd:o.KC([o.Yj(),o.ch()]),tzUTC:o.KC([o.zM(),o.ch()]),chartVisibility:o.KC([o.g1(o.zM()),o.ch()]),projectId:o.KC([o.Yj(),o.ch()]),type:o.KC([o.k5(["project","experiment"]),o.ch()]),groupBy:o.KC([o.Yj(),o.ch()])}).partial()}),o.Ik({columnVisibility:o.KC([o.g1(o.zM()),o.ch()]),columnOrder:o.KC([o.YO(o.Yj()),o.ch()]),columnSizing:o.KC([o.g1(o.ai()),o.ch()]),grouping:o.KC([o.Yj(),o.ch()]),rowHeight:o.KC([o.Yj(),o.ch()]),tallGroupRows:o.KC([o.zM(),o.ch()]),layout:o.KC([o.Yj(),o.ch()]),chartHeight:o.KC([o.ai(),o.ch()]),excludedMeasures:o.KC([o.YO(o.Ik({type:o.k5(["none","score","metric","metadata"]),value:o.Yj()})),o.ch()]),yMetric:o.KC([o.Ik({type:o.k5(["none","score","metric","metadata"]),value:o.Yj()}),o.ch()]),xAxis:o.KC([o.Ik({type:o.k5(["none","score","metric","metadata"]),value:o.Yj()}),o.ch()]),symbolGrouping:o.KC([o.Ik({type:o.k5(["none","score","metric","metadata"]),value:o.Yj()}),o.ch()]),xAxisAggregation:o.KC([o.Yj(),o.ch()]),chartAnnotations:o.KC([o.YO(o.Ik({id:o.Yj(),text:o.Yj()})),o.ch()]),timeRangeFilter:o.KC([o.Yj(),o.Ik({from:o.Yj(),to:o.Yj()}),o.ch()])}).partial(),o.ch()]),Hr=(o.Ik({id:o.Yj().uuid(),object_type:Ln.and(o.Yj()),object_id:o.Yj().uuid(),view_type:o.k5(["projects","experiments","experiment","playgrounds","playground","datasets","dataset","prompts","tools","scorers","logs","agents","monitor"]),name:o.Yj(),created:o.KC([o.Yj(),o.ch()]).optional(),view_data:Gr.optional(),options:Br.optional(),user_id:o.KC([o.Yj(),o.ch()]).optional(),deleted_at:o.KC([o.Yj(),o.ch()]).optional()}),o.KC([o.Ik({type:o.eu("text_delta"),data:o.Yj()}),o.Ik({type:o.eu("reasoning_delta"),data:o.Yj()}),o.Ik({type:o.eu("json_delta"),data:o.Yj()}),o.Ik({type:o.eu("error"),data:o.Yj()}),o.Ik({type:o.eu("console"),data:Ur}),o.Ik({type:o.eu("progress"),data:Fr}),o.Ik({type:o.eu("start"),data:o.Yj()}),o.Ik({type:o.eu("done"),data:o.Yj()})])),zr=class e{stream;memoizedFinalValue;signal;constructor(e,{signal:t}={}){this.signal=t,this.stream=e.pipeThrough(function(){const e=new TextDecoder;let t;return new TransformStream({async start(e){t=function(e){let t,n,r,s,i,a,o;return c(),{feed:function(e){n=n?n+e:e,t&&function(e){return Mn.every((t,n)=>e.charCodeAt(n)===t)}(n)&&(n=n.slice(Mn.length)),t=!1;const i=n.length;let a=0,o=!1;for(;a<i;){o&&("\n"===n[a]&&++a,o=!1);let e,t=-1,c=s;for(let s=r;t<0&&s<i;++s)e=n[s],":"===e&&c<0?c=s-a:"\r"===e?(o=!0,t=s-a):"\n"===e&&(t=s-a);if(t<0){r=i-a,s=c;break}r=0,s=-1,l(n,a,c,t),a+=t+1}a===i?n="":a>0&&(n=n.slice(a))},reset:c};function c(){t=!0,n="",r=0,s=-1,i=void 0,a=void 0,o=""}function l(t,n,r,s){if(0===s)return o.length>0&&(e({type:"event",id:i,event:a||void 0,data:o.slice(0,-1)}),o="",i=void 0),void(a=void 0);const c=r<0,l=t.slice(n,n+(c?s:r));let u=0;u=c?s:" "===t[n+r+1]?r+2:r+1;const d=n+u,h=s-u,p=t.slice(d,d+h).toString();if("data"===l)o+=p?"".concat(p,"\n"):"\n";else if("event"===l)a=p;else if("id"!==l||p.includes("\0")){if("retry"===l){const t=parseInt(p,10);Number.isNaN(t)||e({type:"reconnect-interval",value:t})}}else i=p}}(t=>{if("reconnect-interval"===t.type)return;const n=Wn.safeParse(t);if(!n.success)throw new Error(`Failed to parse event: ${n.error}`);e.enqueue(zr.parseRawEvent(n.data))})},async transform(n,r){n instanceof Uint8Array?t.feed(e.decode(n)):"string"==typeof n?t.feed(n):r.enqueue(n)},async flush(e){e.terminate()}})}(),{signal:t})}copy(){const[t,n]=this.stream.tee();return this.stream=n,new e(t,{signal:this.signal})}toReadableStream(){return this.stream}[Symbol.asyncIterator](){const e=this.stream.getReader();return{async next(){const{done:t,value:n}=await e.read();return t?(e.releaseLock(),{done:!0,value:void 0}):{done:!1,value:n}},return:async()=>(e.releaseLock(),{done:!0,value:void 0}),async throw(t){throw e.releaseLock(),t}}}finalValue(){return this.memoizedFinalValue||(this.memoizedFinalValue=new Promise((e,t)=>{this.stream.pipeThrough(qr(e,t),{signal:this.signal}).pipeTo(Kr(),{signal:this.signal}).catch(t)})),this.memoizedFinalValue}static parseRawEvent(e){switch(e.event){case"text_delta":return{type:"text_delta",data:JSON.parse(e.data)};case"reasoning_delta":return{type:"reasoning_delta",data:JSON.parse(e.data)};case"json_delta":return{type:"json_delta",data:e.data};case"error":return{type:"error",data:JSON.parse(e.data)};case"progress":return{type:"progress",data:Fr.parse(JSON.parse(e.data))};case"console":return{type:"console",data:Ur.parse(JSON.parse(e.data))};case"start":return{type:"start",data:""};case"done":return{type:"done",data:""};default:{const t=e;throw new Error(`Unknown event type ${JSON.stringify(t)}`)}}}static serializeRawEvent(e){switch(e.type){case"text_delta":return{event:"text_delta",data:JSON.stringify(e.data)};case"reasoning_delta":return{event:"reasoning_delta",data:JSON.stringify(e.data)};case"json_delta":return{event:"json_delta",data:e.data};case"error":return{event:"error",data:JSON.stringify(e.data)};case"progress":return{event:"progress",data:JSON.stringify(e.data)};case"console":return{event:"console",data:JSON.stringify(e.data)};case"start":return{event:"start",data:""};case"done":return{event:"done",data:""};default:{const t=e;throw new Error(`Unknown event type ${JSON.stringify(t)}`)}}}};function qr(e,t){const n=new TextDecoder,r=[],s=[],i=[];return new TransformStream({transform(e,a){if("string"==typeof e)r.push(e),a.enqueue({type:"text_delta",data:e});else if(e instanceof Uint8Array)r.push(n.decode(e)),a.enqueue({type:"text_delta",data:n.decode(e)});else if(Hr.safeParse(e).success){const n=e.type;switch(n){case"text_delta":r.push(e.data);break;case"json_delta":s.push(e.data);break;case"reasoning_delta":i.push(e.data);break;case"error":t(e.data);break;case"progress":case"start":case"done":case"console":break;default:t(`Unknown chunk type: ${n}`)}a.enqueue(e)}else t(`Unknown chunk type ${JSON.stringify(e)}`)},flush(t){s.length>0?e(JSON.parse(s.join(""))):r.length>0?e(r.join("")):i.length>0?e(i.join("")):e(void 0),t.terminate()}})}function Kr(){return new WritableStream({write(e){},close(){},abort(e){},start(e){}})}function Wr(){return!!(jn.hash&&jn.gunzip&&jn.gzip&&jn.stat&&jn.readFile&&jn.writeFile&&jn.utimes&&jn.readdir&&jn.mkdir&&jn.unlink&&jn.homedir)}var Vr=class{dir;max;mkdir;logWarnings;constructor(e){if(!Wr())throw new Error("Disk cache is not supported on this platform");this.dir=e.cacheDir,this.max=e.max,this.logWarnings=e.logWarnings??!0,this.mkdir=e.mkdir??!0}getEntryPath(e){const t=jn.hash(e);return jn.pathJoin(this.dir,t)}async get(e){try{const t=this.getEntryPath(e),n=await jn.gunzip(await jn.readFile(t));return await jn.utimes(t,new Date,new Date),JSON.parse(n.toString())}catch(e){if("ENOENT"===e.code)return;return void this.logWarnings}}async set(e,t){try{this.mkdir&&await jn.mkdir(this.dir,{recursive:!0});const n=this.getEntryPath(e),r=await jn.gzip(JSON.stringify(t));await jn.writeFile(n,r),await this.evictOldestIfFull()}catch(e){return void this.logWarnings}}async evictOldestIfFull(){if(!this.max)return;const e=(await jn.readdir(this.dir)).map(e=>jn.pathJoin(this.dir,e));if(e.length<=this.max)return;const t=await Promise.all(e.map(async e=>({path:e,mtime:(await jn.stat(e)).mtime.getTime()})));t.sort((e,t)=>e.mtime-t.mtime);const n=t.slice(0,t.length-this.max);await Promise.all(n.map(e=>jn.unlink(e.path)))}},Jr=class{cache;maxSize;constructor(e={}){this.cache=new Map,this.maxSize=e.max}get(e){const t=this.cache.get(e);if(void 0!==t)return this.cache.delete(e),this.cache.set(e,t),t}set(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.maxSize&&this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e)}this.cache.set(e,t)}clear(){this.cache.clear()}};function Zr(e){if(e.id)return`id:${e.id}`;const t=e.projectId??e.projectName;if(!t)throw new Error("Either projectId or projectName must be provided");if(!e.slug)throw new Error("Slug must be provided when not using ID");return`${t}:${e.slug}:${e.version??"latest"}`}var Xr=class{memoryCache;diskCache;constructor(e){this.memoryCache=e.memoryCache,this.diskCache=e.diskCache}async get(e){const t=Zr(e),n=this.memoryCache.get(t);if(void 0!==n)return n;if(this.diskCache){const e=await this.diskCache.get(t);if(!e)return;return this.memoryCache.set(t,e),e}}async set(e,t){const n=Zr(e);this.memoryCache.set(n,t),this.diskCache&&await this.diskCache.set(n,t)}};function Qr(e,t,n){let r=!0;try{const s=e();return s instanceof Promise?(r=!1,s.catch(t).finally(n)):s}catch(e){return t(e)}finally{r&&n()}}function es(){return(new Date).getTime()/1e3}function ts(e){return null==e}var ns=class{callable;resolvedValue=void 0;value={computedState:"uninitialized"};constructor(e){this.callable=e}get(){return"uninitialized"!==this.value.computedState||(this.value={computedState:"in_progress",val:this.callable().then(e=>(this.value.computedState="succeeded",this.resolvedValue=e,e))}),this.value.val}getSync(){return{resolved:"succeeded"===this.value.computedState,value:this.resolvedValue}}get hasSucceeded(){return"succeeded"===this.value.computedState}},rs=class{callable;value={computedState:"uninitialized"};constructor(e){this.callable=e}get(){if("uninitialized"!==this.value.computedState)return this.value.val;const e=this.callable();return this.value={computedState:"succeeded",val:e},e}get hasSucceeded(){return"succeeded"===this.value.computedState}};function ss(e,t){const n={};for(const r of Object.keys(e))t.includes(r)||(n[r]=e[r]);return n}function is(e){return!e||0===Object.keys(e).length}function as(e,t){const n=function(e){try{return An.parse(e).filter(e=>"name"===e[0]||"&"===e[0])}catch{return[]}}(e);for(const e of n){if(!(void 0!==Jt(t,e[1].replaceAll(/\.\d+/g,".0").split("."))))throw new Error(`Variable '${e[1]}' does not exist.`)}}var os=Gn.shape.type.value,cs=Bn.shape.type.value,ls=Object.keys(Kn.shape),us=["input","output","expected","metadata","context","scores","metrics"],ds=class{constructor(e,t){this.fieldName=e,this.errorType=t}get errorMsg(){return`ERROR: Failed to mask field '${this.fieldName}' - ${this.errorType}`}};function hs(e,t,n){try{return e(t)}catch(e){const t=e instanceof Error?e.constructor.name:"Error";return"scores"===n||"metrics"===n?new ds(n,t):"metadata"===n?{error:`ERROR: Failed to mask field '${n}' - ${t}`}:`ERROR: Failed to mask field '${n}' - ${t}`}}var ps,ms=class{id;spanId;rootSpanId;spanParents;kind="span";constructor(){this.id="",this.spanId="",this.rootSpanId="",this.spanParents=[]}log(e){}logFeedback(e){}traced(e,t){return e(this)}startSpan(e){return this}end(e){return e?.endTime??es()}async export(){return""}async permalink(){return fs}link(){return fs}async flush(){}close(e){return this.end(e)}setAttributes(e){}startSpanWithParents(e,t,n){return this}state(){return vs()}},gs=new ms,fs="https://braintrust.dev/noop-span",ys=o.re({appUrl:o.Yj(),appPublicUrl:o.Yj(),orgName:o.Yj(),apiUrl:o.Yj(),proxyUrl:o.Yj(),loginToken:o.Yj(),orgId:o.Yj().nullish(),gitMetadataSettings:Ir.nullish()}),_s=0,bs=class e{constructor(e){this.loginParams=e,this.id=`${(new Date).toLocaleString()}-${_s++}`,this.currentExperiment=void 0,this.currentLogger=void 0,this.currentParent=jn.newAsyncLocalStorage(),this.currentSpan=jn.newAsyncLocalStorage(),e.fetch&&(this.fetch=e.fetch);const t=async()=>(await this.login({}),this.apiConn());this._bgLogger=new rs(()=>new Bs(new ns(t),e)),this.resetLoginInfo();const n=new Jr({max:Number(jn.getEnv("BRAINTRUST_PROMPT_CACHE_MEMORY_MAX"))??1024}),r=Wr()?new Vr({cacheDir:jn.getEnv("BRAINTRUST_PROMPT_CACHE_DIR")??`${jn.getEnv("HOME")??jn.homedir()}/.braintrust/prompt_cache`,max:Number(jn.getEnv("BRAINTRUST_PROMPT_CACHE_DISK_MAX"))??1<<20}):void 0;this.promptCache=new Xr({memoryCache:n,diskCache:r})}id;currentExperiment;currentLogger;currentParent;currentSpan;_bgLogger;_overrideBgLogger=null;appUrl=null;appPublicUrl=null;loginToken=null;orgId=null;orgName=null;apiUrl=null;proxyUrl=null;loggedIn=!1;gitMetadataSettings;fetch=globalThis.fetch;_appConn=null;_apiConn=null;_proxyConn=null;promptCache;resetLoginInfo(){this.appUrl=null,this.appPublicUrl=null,this.loginToken=null,this.orgId=null,this.orgName=null,this.apiUrl=null,this.proxyUrl=null,this.loggedIn=!1,this.gitMetadataSettings=void 0,this._appConn=null,this._apiConn=null,this._proxyConn=null}copyLoginInfo(e){this.appUrl=e.appUrl,this.appPublicUrl=e.appPublicUrl,this.loginToken=e.loginToken,this.orgId=e.orgId,this.orgName=e.orgName,this.apiUrl=e.apiUrl,this.proxyUrl=e.proxyUrl,this.loggedIn=e.loggedIn,this.gitMetadataSettings=e.gitMetadataSettings,this._appConn=e._appConn,this._apiConn=e._apiConn,this.loginReplaceApiConn(this.apiConn()),this._proxyConn=e._proxyConn}serialize(){if(!this.loggedIn)throw new Error("Cannot serialize BraintrustState without being logged in");if(!(this.appUrl&&this.appPublicUrl&&this.apiUrl&&this.proxyUrl&&this.orgName&&this.loginToken&&this.loggedIn))throw new Error("Cannot serialize BraintrustState without all login attributes");return{appUrl:this.appUrl,appPublicUrl:this.appPublicUrl,loginToken:this.loginToken,orgId:this.orgId,orgName:this.orgName,apiUrl:this.apiUrl,proxyUrl:this.proxyUrl,gitMetadataSettings:this.gitMetadataSettings}}static deserialize(t,n){const r=ys.safeParse(t);if(!r.success)throw new Error(`Cannot deserialize BraintrustState: ${r.error.message}`);const s=new e({...n});for(const e of Object.keys(ys.shape))s[e]=r.data[e];if(!s.loginToken)throw new Error("Cannot deserialize BraintrustState without a login token");return s.apiConn().set_token(s.loginToken),s.apiConn().make_long_lived(),s.appConn().set_token(s.loginToken),s.proxyUrl&&(s.proxyConn().make_long_lived(),s.proxyConn().set_token(s.loginToken)),s.loggedIn=!0,s.loginReplaceApiConn(s.apiConn()),s}setFetch(e){this.loginParams.fetch=e,this.fetch=e,this._apiConn?.setFetch(e),this._appConn?.setFetch(e)}setMaskingFunction(e){this.bgLogger().setMaskingFunction(e)}async login(e){if(this.apiUrl&&!e.forceLogin)return;const t=await ti({...this.loginParams,...Object.fromEntries(Object.entries(e).filter(([e,t])=>!ts(t)))});this.copyLoginInfo(t)}appConn(){if(!this._appConn){if(!this.appUrl)throw new Error("Must initialize appUrl before requesting appConn");this._appConn=new xs(this.appUrl,this.fetch)}return this._appConn}apiConn(){if(!this._apiConn){if(!this.apiUrl)throw new Error("Must initialize apiUrl before requesting apiConn");this._apiConn=new xs(this.apiUrl,this.fetch)}return this._apiConn}proxyConn(){if(!this.proxyUrl)return this.apiConn();if(!this._proxyConn){if(!this.proxyUrl)throw new Error("Must initialize proxyUrl before requesting proxyConn");this._proxyConn=new xs(this.proxyUrl,this.fetch)}return this._proxyConn}bgLogger(){return this._overrideBgLogger?this._overrideBgLogger:this._bgLogger.get()}httpLogger(){return this._bgLogger.get()}setOverrideBgLogger(e){this._overrideBgLogger=e}loginReplaceApiConn(e){this._bgLogger.get().internalReplaceApiConn(e)}disable(){this._bgLogger.get().disable()}enforceQueueSizeLimit(e){this._bgLogger.get().enforceQueueSizeLimit(e)}};function ws(){ps||(ps=globalThis.__inherited_braintrust_state||new bs({}))}var vs=()=>ps,Es=class extends Error{status;text;data;constructor(e,t,n){super(`${e}: ${t} (${n})`),this.status=e,this.text=t,this.data=n}};async function Ss(e){if(e.ok)return e;throw new Es(e.status,e.statusText,await e.text())}var xs=class e{base_url;token;headers;fetch;constructor(e,t){this.base_url=e,this.token=null,this.headers={},this._reset(),this.fetch=t}setFetch(e){this.fetch=e}async ping(){try{return 200===(await this.get("ping")).status}catch(e){return!1}}make_long_lived(){this._reset()}static sanitize_token(e){return e.trim()}set_token(t){t=e.sanitize_token(t),this.token=t,this._reset()}_reset(){this.headers={},this.token&&(this.headers.Authorization=`Bearer ${this.token}`)}async get(e,t=void 0,n){const{headers:r,...s}=n||{},i=new URL(rn(this.base_url,e));i.search=new URLSearchParams(t?Object.entries(t).filter(([e,t])=>void 0!==t).flatMap(([e,t])=>void 0!==t?"string"==typeof t?[[e,t]]:t.map(t=>[e,t]):[]):[]).toString();const a=this.fetch,o=this.headers;return await Ss(await a(i.toString(),{headers:{Accept:"application/json",...o,...r},keepalive:!0,...s}))}async post(e,t,n){const{headers:r,...s}=n||{},i=this.fetch,a=this.base_url,o=this.headers;return await Ss(await i(rn(a,e),{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",...o,...r},body:"string"==typeof t?t:t?JSON.stringify(t):void 0,keepalive:!0,...s}))}async get_json(e,t=void 0,n=0){const r=n+1;for(let n=0;n<r;n++)try{const n=await this.get(`${e}`,t);return await n.json()}catch(e){if(n<r-1)continue;throw e}}async post_json(e,t=void 0){const n=await this.post(`${e}`,t,{headers:{"Content-Type":"application/json"}});return await n.json()}},ks=class{reference},Ts=class extends ks{reference;uploader;_data;state;dataDebugString;constructor({data:e,filename:t,contentType:n,state:r}){super(),this.reference={type:os,filename:t,content_type:n,key:Ri()},this.state=r,this.dataDebugString="string"==typeof e?e:"<in-memory data>",this._data=this.initData(e),this.uploader=this.initUploader()}async upload(){return await this.uploader.get()}async data(){return this._data.get()}debugInfo(){return{inputData:this.dataDebugString,reference:this.reference,state:this.state}}initUploader(){const e=async(e,t)=>{const n={key:this.reference.key,filename:this.reference.filename,content_type:this.reference.content_type,org_id:t},[r,s]=await Promise.allSettled([e.post("/attachment",n),this._data.get()]);if("rejected"===r.status){const e=JSON.stringify(r.reason);throw new Error(`Failed to request signed URL from API server: ${e}`)}if("rejected"===s.status){const e=JSON.stringify(s.reason);throw new Error(`Failed to read file: ${e}`)}const i=r.value,a=s.value;let c,l,u;try{({signedUrl:c,headers:l}=o.Ik({signedUrl:o.Yj().url(),headers:o.g1(o.Yj())}).parse(await i.json()))}catch(e){if(e instanceof Pn.G){const t=JSON.stringify(e.flatten());throw new Error(`Invalid response from API server: ${t}`)}throw e}!function(e,t){t.includes("blob.core.windows.net")&&(e["x-ms-blob-type"]="BlockBlob")}(l,c);try{u=await Ss(await fetch(c,{method:"PUT",headers:l,body:a}))}catch(e){if(e instanceof Es)throw new Error(`Failed to upload attachment to object store: ${e.status} ${e.text} ${e.data}`);throw e}return{signedUrl:c,metadataResponse:i,objectStoreResponse:u}};return new ns(async()=>{const t={upload_status:"done"},n=this.state??ps;await n.login({});const r=n.apiConn(),s=n.orgId??"";try{await e(r,s)}catch(e){t.upload_status="error",t.error_message=e instanceof Error?e.message:JSON.stringify(e)}const i={key:this.reference.key,org_id:s,status:t},a=await r.post("/attachment/status",i);if(!a.ok){const e=JSON.stringify(a);throw new Error(`Couldn't log attachment status: ${e}`)}return t})}initData(e){if("string"==typeof e){this.ensureFileReadable(e);const t=jn.readFile;if(!t)throw new Error("This platform does not support reading the filesystem. Construct the Attachment\nwith a Blob/ArrayBuffer, or run the program on Node.js.");return new ns(async()=>new Blob([await t(e)]))}return new ns(async()=>new Blob([e]))}ensureFileReadable(e){const t=jn.statSync;if(!t)throw new Error("This platform does not support reading the filesystem. Construct the Attachment\nwith a Blob/ArrayBuffer, or run the program on Node.js.");try{t(e)}catch(e){}}},Is=class extends ks{reference;_data;state;constructor({url:e,filename:t,contentType:n,state:r}){super(),this.reference={type:cs,filename:t,content_type:n,url:e},this._data=this.initData()}async upload(){return{upload_status:"done"}}async data(){return this._data.get()}debugInfo(){return{url:this.reference.url,reference:this.reference,state:this.state}}initData(){return new ns(async()=>{const e=new Cs(this.reference,this.state);return await e.data()})}},Os=o.Ik({downloadUrl:o.Yj(),status:qn}),Cs=class{reference;_data;state;constructor(e,t){this.reference=e,this.state=t,this._data=this.initDownloader()}async data(){return this._data.get()}async asBase64Url(){const e=await(await this.data()).arrayBuffer(),t=Buffer.from(e).toString("base64");return`data:${this.reference.content_type};base64,${t}`}async metadata(){const e=this.state??ps;await e.login({});const t={filename:this.reference.filename,content_type:this.reference.content_type,org_id:e.orgId||""};"braintrust_attachment"===this.reference.type?t.key=this.reference.key:"external_attachment"===this.reference.type&&(t.url=this.reference.url);const n=await e.apiConn().get("/attachment",t);if(!n.ok){const e=JSON.stringify(n);throw new Error(`Invalid response from API server: ${e}`)}return Os.parse(await n.json())}async status(){return(await this.metadata()).status}initDownloader(){return new ns(async()=>{const{downloadUrl:e,status:t}=await this.metadata();if("done"!==t.upload_status)throw new Error(`Expected attachment status "done", got "${t.upload_status}"`);const n=await fetch(e);if(200!==n.status){const e=await n.text();throw new Error(`Couldn't download attachment: ${e}`)}return await n.blob()})}};function As(e,t,n,{id:r,expected:s,scores:i,metadata:a,tags:o,comment:c,source:l}){const u=l??"external";if(!St.includes(u))throw new Error(`source must be one of ${St}`);if(ts(i)&&ts(s)&&ts(o)&&ts(c))throw new Error("At least one of scores, expected, tags, or comment must be specified");const d=xi({scores:i,metadata:a,expected:s,tags:o});let{metadata:h,...p}=ki(d);p=Object.fromEntries(Object.entries(p).filter(([e,t])=>!ts(t)));const m=async()=>new Gt({object_type:t,object_id:await n.get()}).objectIdFields();if(Object.keys(p).length>0){const t=new ns(async()=>({id:r,...p,...await m(),[vt]:u,[Et]:h,[wt]:!0}));e.bgLogger().log([t])}if(!ts(c)){const t=new ns(async()=>({id:pt(),created:(new Date).toISOString(),origin:{id:r},comment:{text:c},...await m(),[vt]:u,[Et]:h}));e.bgLogger().log([t])}}function Ps({state:e,parentObjectType:t,parentObjectId:n,id:r,event:s}){const i=ki(xi({id:r,...s})),a=async()=>new Gt({object_type:t,object_id:await n.get()}).objectIdFields(),o=new ns(async()=>({id:r,...i,...await a(),[wt]:!0}));e.bgLogger().log([o])}function Ms({exported:e,state:t,...n}){const r=t??ps,s=Gt.fromStr(e);if(!s.data.row_id)throw new Error("Exported span must have a row id");Ps({state:r,parentObjectType:s.data.object_type,parentObjectId:new ns(Rs(r,s)),id:s.data.row_id,event:n})}function Rs(e,t){if(t.data.object_id){const e=t.data.object_id;return async()=>e}if(!t.data.compute_object_metadata_args)throw new Error("Impossible: must provide either objectId or computeObjectMetadataArgs");switch(t.data.object_type){case Nt.EXPERIMENT:throw new Error("Impossible: computeObjectMetadataArgs not supported for experiments");case Nt.PLAYGROUND_LOGS:throw new Error("Impossible: computeObjectMetadataArgs not supported for prompt sessions");case Nt.PROJECT_LOGS:return async()=>(await Js(e,{...t.data.compute_object_metadata_args})).project.id;default:const n=t.data.object_type;throw new Error(`Unknown object type: ${n}`)}}async function $s({components:e,state:t}){return await Rs(t??ps,e)()}var js="https://braintrust.dev/error-generating-link";function Ns(e){return""==e?js:`${js}?msg=${encodeURIComponent(e)}`}async function Ls(e,t){if(""===e)return fs;const n=t?.state??ps,r=async()=>{if(t?.orgName)return t.orgName;if(await n.login({}),!n.orgName)throw new Error("provide-org-or-login");return n.orgName},s=async()=>{if(t?.appUrl)return t.appUrl;if(await n.login({}),!n.appUrl)throw new Error("provide-app-url-or-login");return n.appUrl};try{const t=Gt.fromStr(e),i=function(e){switch(e){case 1:return"experiment";case 2:return"project_logs";case 3:return"playground_logs";default:throw new Error(`Unknown SpanObjectTypeV3: ${e}`)}}(t.data.object_type),[a,o,c]=await Promise.all([r(),s(),$s({components:t,state:n})]),l=t.data.row_id;if(!l)throw new Error("Span slug does not refer to an individual row");return`${o}/app/${a}/object?${new URLSearchParams({object_type:i,object_id:c,id:l})}`}catch(e){return Ns(e instanceof Es?`http-error-${e.status}`:e instanceof Error?e.message:String(e))}}function Ds(e){let t,n,r;if(e.parent){if(e.parentSpanIds)throw new Error("Cannot specify both parent and parentSpanIds");const s=Gt.fromStr(e.parent);if(e.parentObjectType!==s.data.object_type)throw new Error(`Mismatch between expected span parent object type ${e.parentObjectType} and provided type ${s.data.object_type}`);const i=Rs(e.state,s);t=new ns(async()=>{const t=await i();if(await e.parentObjectId.get()!==t)throw new Error(`Mismatch between expected span parent object id ${await e.parentObjectId.get()} and provided id ${t}`);return await e.parentObjectId.get()}),s.data.row_id&&(n={spanId:s.data.span_id,rootSpanId:s.data.root_span_id}),r=e.propagatedEvent??s.data.propagated_event??void 0}else t=e.parentObjectId,n=e.parentSpanIds,r=e.propagatedEvent;return{parentObjectType:e.parentObjectType,parentObjectId:t,parentComputeObjectMetadataArgs:e.parentComputeObjectMetadataArgs,parentSpanIds:n,propagatedEvent:r}}var Us=class{state;lazyMetadata;_asyncFlush;computeMetadataArgs;lastStartTime;lazyId;calledStartSpan;kind="logger";constructor(e,t,n={}){this.lazyMetadata=t,this._asyncFlush=n.asyncFlush,this.computeMetadataArgs=n.computeMetadataArgs,this.lastStartTime=es(),this.lazyId=new ns(async()=>await this.id),this.calledStartSpan=!1,this.state=e}get org_id(){return(async()=>(await this.lazyMetadata.get()).org_id)()}get project(){return(async()=>(await this.lazyMetadata.get()).project)()}get id(){return(async()=>(await this.project).id)()}parentObjectType(){return Nt.PROJECT_LOGS}log(e,t){if(this.calledStartSpan&&!t?.allowConcurrentWithSpans)throw new Error("Cannot run toplevel `log` method while using spans. To log to the span, call `logger.traced` and then log with `span.log`");const n=this.startSpanImpl({startTime:this.lastStartTime,event:e});this.lastStartTime=n.end();const r=n.id;return!0===this.asyncFlush?r:(async()=>(await this.flush(),r))()}traced(e,t){const{setCurrent:n,...r}=t??{},s=this.startSpan(r),i=Qr(()=>n??1?_i(s,e):e(s),e=>{throw ci(s,e),e},()=>s.end());return this.asyncFlush?i:(async()=>{const e=await i;return await this.flush(),e})()}startSpan(e){return this.calledStartSpan=!0,this.startSpanImpl(e)}startSpanImpl(e){return new $i({...e,state:this.state,...Ds({state:this.state,parent:e?.parent,parentObjectType:this.parentObjectType(),parentObjectId:this.lazyId,parentComputeObjectMetadataArgs:this.computeMetadataArgs,parentSpanIds:e?.parentSpanIds,propagatedEvent:e?.propagatedEvent}),defaultRootType:sn.TASK})}logFeedback(e){As(this.state,this.parentObjectType(),this.lazyId,e)}updateSpan(e){const{id:t,...n}=e;if(!t)throw new Error("Span id is required to update a span");Ps({state:this.state,parentObjectType:this.parentObjectType(),parentObjectId:this.lazyId,id:t,event:n})}async export(){return new Gt({object_type:this.parentObjectType(),...this.computeMetadataArgs&&!this.lazyId.hasSucceeded?{compute_object_metadata_args:this.computeMetadataArgs}:{object_id:await this.lazyId.get()}}).toStr()}async flush(){return await this.state.bgLogger().flush()}get asyncFlush(){return this._asyncFlush}};function Fs(e){return`{"rows": ${function(e){return`[${e.join(",")}]`}(e)}, "api_version": 2}`}function Ys(){return(new Date).getTime()}var Gs=class{items=[];maskingFunction=null;log(e){this.items.push(e)}setMaskingFunction(e){this.maskingFunction=e}async flush(){return Promise.resolve()}async drain(){const e=this.items;this.items=[];const t=[];for(const n of e)for(const e of n)t.push(await e.get());let n=nn(t).flat();return this.maskingFunction&&(n=n.map(e=>{const t={...e};for(const n of us)if(void 0!==e[n]){const r=hs(this.maskingFunction,e[n],n);r instanceof ds?(delete t[n],t.error?t.error=`${t.error}; ${r.errorMsg}`:t.error=r.errorMsg):t[n]=r}return t})),n}},Bs=class e{apiConn;queue;activeFlush=Promise.resolve();activeFlushResolved=!0;activeFlushError=void 0;onFlushError;maskingFunction=null;syncFlush=!1;maxRequestSize=6291456;defaultBatchSize=100;numTries=3;queueDropExceedingMaxsize=15e3;queueDropLoggingPeriod=60;failedPublishPayloadsDir=void 0;allPublishPayloadsDir=void 0;_disabled=!1;queueDropLoggingState={numDropped:0,lastLoggedTimestamp:0};constructor(e,t){t=t??{},this.apiConn=e;const n=Number(jn.getEnv("BRAINTRUST_SYNC_FLUSH"));isNaN(n)||(this.syncFlush=Boolean(n));const r=Number(jn.getEnv("BRAINTRUST_DEFAULT_BATCH_SIZE"));isNaN(r)||(this.defaultBatchSize=r);const s=Number(jn.getEnv("BRAINTRUST_MAX_REQUEST_SIZE"));isNaN(s)||(this.maxRequestSize=s);const i=Number(jn.getEnv("BRAINTRUST_NUM_RETRIES"));isNaN(i)||(this.numTries=i+1);const a=Number(jn.getEnv("BRAINTRUST_QUEUE_DROP_EXCEEDING_MAXSIZE"));isNaN(a)||(this.queueDropExceedingMaxsize=a),this.queue=new Nn(this.queueDropExceedingMaxsize);const o=Number(jn.getEnv("BRAINTRUST_QUEUE_DROP_LOGGING_PERIOD"));isNaN(o)||(this.queueDropLoggingPeriod=o);const c=jn.getEnv("BRAINTRUST_FAILED_PUBLISH_PAYLOADS_DIR");c&&(this.failedPublishPayloadsDir=c);const l=jn.getEnv("BRAINTRUST_ALL_PUBLISH_PAYLOADS_DIR");l&&(this.allPublishPayloadsDir=l),t.noExitFlush||jn.processOn("beforeExit",async()=>{await this.flush()}),this.onFlushError=t.onFlushError}setMaskingFunction(e){this.maskingFunction=e}log(e){if(this._disabled)return;const t=this.queue.push(...e);this.syncFlush||this.triggerActiveFlush(),t.length&&(this.registerDroppedItemCount(t.length),(this.allPublishPayloadsDir||this.failedPublishPayloadsDir)&&this.dumpDroppedEvents(t))}async flush(){if(this.syncFlush&&this.triggerActiveFlush(),await this.activeFlush,this.activeFlushError){const e=this.activeFlushError;if(this.activeFlushError=void 0,this.syncFlush)throw e}}async flushOnce(e){if(this._disabled)return void this.queue.clear();const t=e?.batchSize??this.defaultBatchSize,n=this.queue.drain(),[r,s]=await this.unwrapLazyValues(n);if(0===r.length)return;const i=function(e){var t,n;let{items:r}=e;const s=null!=(t=e.batchMaxNumItems)?t:Number.POSITIVE_INFINITY,i=null!=(n=e.batchMaxNumBytes)?n:Number.POSITIVE_INFINITY,a=[];let o=[],c=[],l=[],u=0;function d(e){l.push(e),u+=e.length}function h(){c.push(l),l=[],u=0}for(;r.length;){for(const e of r){let t=0;for(const n of e){if(0===l.length||n.length+u<i&&l.length<s)d(n);else{if(0!==t)break;h(),d(n)}++t}t<e.length&&o.push(e.slice(t)),(u>=i||l.length>s)&&h()}l.length&&h(),c.length&&(a.push(c),c=[]),r=o,o=[]}return a}({items:r.map(e=>e.map(e=>JSON.stringify(e))),batchMaxNumItems:t,batchMaxNumBytes:this.maxRequestSize/2});for(const e of i){const t=e.map(e=>(async()=>{try{return await this.submitLogsRequest(e),{type:"success"}}catch(e){return{type:"error",value:e}}})()),n=(await Promise.all(t)).map(e=>"success"===e.type?void 0:e.value).filter(e=>void 0!==e);if(n.length)throw new AggregateError(n,"Encountered the following errors while logging:")}const a=[];for(const e of s)try{const t=await e.upload();if("error"===t.upload_status)throw new Error(t.error_message)}catch(e){a.push(e)}if(1===a.length)throw a[0];if(a.length>1)throw new AggregateError(a,"Encountered the following errors while uploading attachments:");this.queue.length()>0&&await this.flushOnce(e)}async unwrapLazyValues(e){for(let t=0;t<this.numTries;++t)try{const t=await Promise.all(e.map(e=>e.get())),n=[];t.forEach(e=>Ti(e,n));let r=nn(t);return this.maskingFunction&&(r=r.map(e=>e.map(e=>{const t={...e};for(const n of us)if(void 0!==e[n]){const r=hs(this.maskingFunction,e[n],n);r instanceof ds?(delete t[n],t.error?t.error=`${t.error}; ${r.errorMsg}`:t.error=r.errorMsg):t[n]=r}return t}))),[r,n]}catch(e){let n="Encountered error when constructing records to flush";const r=t+1<this.numTries;if(r&&(n+=". Retrying"),!r)throw e;{const e=1*2**t;await new Promise(t=>setTimeout(t,1e3*e))}}throw new Error("Impossible")}async submitLogsRequest(t){const n=await this.apiConn.get(),r=Fs(t);this.allPublishPayloadsDir&&await e.writePayloadToDir({payloadDir:this.allPublishPayloadsDir,payload:r});for(let t=0;t<this.numTries;t++){const s=Ys();let i;try{await n.post_json("logs3",r)}catch(e){i=e}if(void 0===i)return;const a=t+1<this.numTries,o=a?"":" Retrying",c=(()=>i instanceof Es?`${i.status} (${i.text}): ${i.data}`:`${i}`)(),l=`log request failed. Elapsed time: ${(Ys()-s)/1e3} seconds. Payload size: ${r.length}.${o}\nError: ${c}`;if(!a&&this.failedPublishPayloadsDir&&(await e.writePayloadToDir({payloadDir:this.failedPublishPayloadsDir,payload:r}),this.logFailedPayloadsDir()),!a)throw new Error(l);if(a){const e=1*2**t;await new Promise(t=>setTimeout(t,1e3*e))}}}registerDroppedItemCount(e){if(e<=0)return;this.queueDropLoggingState.numDropped+=e;const t=es();t-this.queueDropLoggingState.lastLoggedTimestamp>this.queueDropLoggingPeriod&&(this.failedPublishPayloadsDir&&this.logFailedPayloadsDir(),this.queueDropLoggingState.numDropped=0,this.queueDropLoggingState.lastLoggedTimestamp=t)}async dumpDroppedEvents(t){const n=[this.allPublishPayloadsDir,this.failedPublishPayloadsDir].reduce((e,t)=>t?e.concat([t]):e,new Array);if(t.length&&n.length)try{const[r,s]=await this.unwrapLazyValues(t),i=Fs(r.map(e=>JSON.stringify(e))),a=`{"data": ${i}, "attachments": ${JSON.stringify(s.map(e=>e.debugInfo()))}}\n`;for(const t of n)await e.writePayloadToDir({payloadDir:t,payload:a})}catch(e){}}static async writePayloadToDir({payloadDir:e,payload:t}){if(!(jn.pathJoin&&jn.mkdir&&jn.writeFile))return;const n=jn.pathJoin(e,`payload_${es()}_${pt().slice(0,8)}.json`);try{await jn.mkdir(e,{recursive:!0}),await jn.writeFile(n,t)}catch(e){}}triggerActiveFlush(){this.activeFlushResolved&&(this.activeFlushResolved=!1,this.activeFlushError=void 0,this.activeFlush=(async()=>{try{await this.flushOnce()}catch(e){if(e instanceof AggregateError)for(const t of e.errors)this.onFlushError?.(t);else this.onFlushError?.(e);this.activeFlushError=e}finally{this.activeFlushResolved=!0}})(),(0,ln.waitUntil)(this.activeFlush))}logFailedPayloadsDir(){}internalReplaceApiConn(e){this.apiConn=new ns(async()=>e)}disable(){this._disabled=!0}enforceQueueSizeLimit(e){this.queue.enforceQueueSizeLimit(e)}};function Hs(e,t){const n=(()=>{if("string"==typeof e)return{...t,project:e};if(void 0!==t)throw new Error("Cannot specify options struct as both parameters. Must call either init(project, options) or init(options).");return e})(),{project:r,experiment:s,description:i,dataset:a,baseExperiment:o,isPublic:c,open:l,update:u,appUrl:d,apiKey:h,orgName:p,forceLogin:m,fetch:g,metadata:f,gitMetadataSettings:y,projectId:_,baseExperimentId:b,repoInfo:w,state:v}=n;if(!r&&!_)throw new Error("Must specify at least one of project or projectId");if(l&&u)throw new Error("Cannot open and update an experiment at the same time");const E=v??ps;if(E.enforceQueueSizeLimit(!1),l){if(ts(s))throw new Error("Cannot open an experiment without specifying its name");const e=new ns(async()=>{await E.login({apiKey:h,appUrl:d,orgName:p,fetch:g,forceLogin:m});const e={project_name:r,project_id:_,org_name:E.orgName,experiment_name:s},t=await E.appConn().post_json("api/experiment/get",e);if(0===t.length)throw new Error(`Experiment ${s} not found in project ${_??r}.`);const n=t[0];return{project:{id:n.project_id,name:r??"UNKNOWN_PROJECT",fullInfo:{}},experiment:{id:n.id,name:n.name,fullInfo:n}}});return new Pi(v??ps,e)}const S=new ns(async()=>{await E.login({apiKey:h,appUrl:d,orgName:p});const e={project_name:r,project_id:_,org_id:E.orgId,update:u};s&&(e.experiment_name=s),i&&(e.description=i);const t=await(async()=>{if(w)return w;let e={...E.gitMetadataSettings||{collect:"all"}};return y&&(e=function(e,t){var n;if("all"===e.collect)return t;if("all"===t.collect)return e;if("none"===e.collect)return e;if("none"===t.collect)return t;const r=(null!=(n=e.fields)?n:[]).filter(e=>{var n;return(null!=(n=t.fields)?n:[]).includes(e)});return{collect:r.length>0?"some":"none",fields:r}}(e,y)),await jn.getRepoInfo(e)})();t&&(e.repo_info=t),b?e.base_exp_id=b:o?e.base_experiment=o:e.ancestor_commits=await jn.getPastNAncestors(),void 0!==a&&(e.dataset_id=await a.id,e.dataset_version=await a.version()),void 0!==c&&(e.public=c),f&&(e.metadata=f);let n=null;for(;;)try{n=await E.appConn().post_json("api/experiment/register",e);break}catch(t){if(!e.base_experiment||!`${"data"in t&&t.data}`.includes("base experiment"))throw t;delete e.base_experiment}return{project:{id:n.project.id,name:n.project.name,fullInfo:n.project},experiment:{id:n.experiment.id,name:n.experiment.name,created:n.experiment.created,fullInfo:n.experiment}}}),x=new Ai(E,S,a);return(n.setCurrent??1)&&(E.currentExperiment=x),x}function zs(e,t){return Hs((()=>{if("string"==typeof e)return{...t,project:e};if(void 0!==t)throw new Error("Cannot specify options struct as both parameters. Must call either init(project, options) or init(options).");return e})())}function qs(e,t,n={}){return t(Hs(e,n))}function Ks(e,t={}){return e(Zs(t))}function Ws(e,t){const n=(()=>{if("string"==typeof e)return{...t,project:e};if(void 0!==t)throw new Error("Cannot specify options struct as both parameters. Must call either initDataset(project, options) or initDataset(options).");return e})(),{project:r,dataset:s,description:i,version:a,appUrl:o,apiKey:c,orgName:l,fetch:u,forceLogin:d,projectId:h,metadata:p,useOutput:m,state:g,_internal_btql:f}=n,y=g??ps,_=new ns(async()=>{await y.login({orgName:l,apiKey:c,appUrl:o,fetch:u,forceLogin:d});const e={org_id:y.orgId,project_name:r,project_id:h,dataset_name:s,description:i,metadata:p},t=await y.appConn().post_json("api/dataset/register",e);return{project:{id:t.project.id,name:t.project.name,fullInfo:t.project},dataset:{id:t.dataset.id,name:t.dataset.name,fullInfo:t.dataset}}});return new ji(g??ps,_,a,m,f)}function Vs(e,t,n={}){return t(Ws(e,n))}async function Js(e,{project_name:t,project_id:n}){await e.login({});const r=e.orgId;if(ts(n)){const n=await e.appConn().post_json("api/project/register",{project_name:t||"Global",org_id:r});return{org_id:r,project:{id:n.project.id,name:n.project.name,fullInfo:n.project}}}if(ts(t)){const t=await e.appConn().get_json("api/project",{id:n});return{org_id:r,project:{id:n,name:t.name,fullInfo:t.project}}}return{org_id:r,project:{id:n,name:t,fullInfo:{}}}}function Zs(e={}){const{projectName:t,projectId:n,asyncFlush:r,appUrl:s,apiKey:i,orgName:a,forceLogin:o,fetch:c,state:l}=e||{},u=void 0===r||r,d={project_name:t,project_id:n},h=l??ps;h.enforceQueueSizeLimit(!0);const p=new ns(async()=>(await h.login({orgName:a,apiKey:i,appUrl:s,forceLogin:o,fetch:c}),Js(h,d))),m=new Us(h,p,{asyncFlush:u,computeMetadataArgs:d});return(e.setCurrent??1)&&(h.currentLogger=m),m}async function Xs({projectName:e,projectId:t,slug:n,version:r,environment:s,id:i,defaults:a,noTrace:o=!1,appUrl:c,apiKey:l,orgName:u,fetch:d,forceLogin:h,state:p}){if(r&&s)throw new Error("Cannot specify both 'version' and 'environment' parameters. Please use only one (remove the other).");if(i);else{if(ts(e)&&ts(t))throw new Error("Must specify either projectName or projectId");if(ts(n))throw new Error("Must specify slug")}const m=p??ps;let g;try{await m.login({orgName:u,apiKey:l,appUrl:c,fetch:d,forceLogin:h}),i?(g=await m.apiConn().get_json(`v1/prompt/${i}`,{...r&&{version:r},...s&&{environment:s}}),g&&(g={objects:[g]})):g=await m.apiConn().get_json("v1/prompt",{project_name:e,project_id:t,slug:n,version:r,...s&&{environment:s}})}catch(a){if(s||r)throw new Error(`Prompt not found with specified parameters: ${a}`);let o;if(i){if(o=await m.promptCache.get({id:i}),!o)throw new Error(`Prompt with id ${i} not found (not found on server or in local cache): ${a}`)}else if(o=await m.promptCache.get({slug:n,projectId:t,projectName:e,version:r??"latest"}),!o)throw new Error(`Prompt ${n} (version ${r??"latest"}) not found in ${[e??t]} (not found on server or in local cache): ${a}`);return o}if(!("objects"in g)||0===g.objects.length)throw i?new Error(`Prompt with id ${i} not found.`):new Error(`Prompt ${n} not found in ${[e??t]}`);if(g.objects.length>1)throw i?new Error(`Multiple prompts found with id ${i}. This should never happen.`):new Error(`Multiple prompts found with slug ${n} in project ${e??t}. This should never happen.`);const f=Lr.parse(g.objects[0]),y=new Fi(f,a||{},o);try{i?await m.promptCache.set({id:i},y):n&&await m.promptCache.set({slug:n,projectId:t,projectName:e,version:r??"latest"},y)}catch(e){}return y}function Qs(e){ps.setMaskingFunction(e)}async function ei(e={}){const{forceLogin:t=!1}=e||{};if(ps.loggedIn&&!t){let t=function(e,t,n){if(!ts(t)&&!ts(n)&&t!==n)throw new Error(`Re-logging in with different ${e} (${t}) than original (${n}). To force re-login, pass \`forceLogin: true\``)};return t("appUrl",e.appUrl,ps.appUrl),t("apiKey",e.apiKey?xs.sanitize_token(e.apiKey):void 0,ps.loginToken),t("orgName",e.orgName,ps.orgName),ps}return await ps.login(e),globalThis.__inherited_braintrust_state=ps,ps}async function ti(e={}){const{appUrl:t=jn.getEnv("BRAINTRUST_APP_URL")||"https://www.braintrust.dev",apiKey:n=jn.getEnv("BRAINTRUST_API_KEY"),orgName:r=jn.getEnv("BRAINTRUST_ORG_NAME"),fetch:s=globalThis.fetch}=e||{},i=jn.getEnv("BRAINTRUST_APP_PUBLIC_URL")||t,a=new bs(e);a.resetLoginInfo(),a.appUrl=t,a.appPublicUrl=i;let o=null;if(!n)throw new Error("Please specify an api key (e.g. by setting BRAINTRUST_API_KEY).");if(n===Yi){const e=[{id:"test-org-id",name:"test-org-name",api_url:"https://braintrust.dev/fake-api-url"}];return a.loggedIn=!0,a.loginToken=Yi,Ei(a,e,e[0].name),a}{const e=await Ss(await s(rn(a.appUrl,"/api/apikey/login"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`}}));if(Ei(a,(await e.json()).org_info,r),!a.apiUrl)throw r?new Error(`Unable to log into organization '${r}'. Are you sure this credential is scoped to the organization?`):new Error("Unable to log into any organization with the provided credential.");if(o=a.apiConn(),o.set_token(n),!o)throw new Error("Conn should be set at this point (a bug)");o.make_long_lived(),a.appConn().set_token(n),a.proxyUrl&&a.proxyConn().set_token(n),a.loginToken=o.token,a.loggedIn=!0,a.loginReplaceApiConn(o)}return a}function ni(e){const t=si();if(!t)throw new Error("Not initialized. Please call init() first");return t.log(e)}async function ri(e={}){const t=si();if(!t)throw new Error("Not initialized. Please call init() first");return await t.summarize(e)}function si(e){return(e?.state??ps).currentExperiment}function ii(e){return function(e,t){if(void 0!==e){if(void 0!==t&&!!t!=!!e.asyncFlush)throw new Error(`Asserted asyncFlush setting ${t} does not match stored logger's setting ${e.asyncFlush}`);return e}}((e?.state??ps).currentLogger,e?.asyncFlush)}function ai(e){return(e?.state??ps).currentSpan.getStore()??gs}function oi(e){const t=ai({state:e?.state??ps});if(!Object.is(t,gs))return t;const n=si();if(n)return n;const r=ii(e);return r||gs}function ci(e,t){let n="<error>",r="";t instanceof Error?(n=t.message,r=t.stack||""):n=String(t),e.log({error:`${n}\n\n${r}`})}function li(e,t){const{span:n,isSyncFlushLogger:r}=yi(t),s=Qr(()=>t?.setCurrent??1?_i(n,e):e(n),e=>{throw ci(n,e),e},()=>n.end());return void 0===t?.asyncFlush||t?.asyncFlush?s:(async()=>{const e=await s;return r&&await n.flush(),e})()}function ui(e){return"[object GeneratorFunction]"===Object.prototype.toString.call(e)}function di(e){return"[object AsyncGeneratorFunction]"===Object.prototype.toString.call(e)}function hi(e,t){const n={name:e.name,type:"function",...t},r=t&&t.event&&"input"in t.event&&void 0!==t.event.input,s=t&&t.event&&void 0!==t.event.output,i=t?.noTraceIO||r||s;return ui(e)?function(e,t,n){const r=function*(...r){const s=mi(t);try{n||s.log({input:r});const t=jn.getEnv("BRAINTRUST_MAX_GENERATOR_ITEMS"),i=void 0!==t?Number(t):1e3;if(n||0===i){const t=bi(s,e.apply(this,r));for(const e of t)yield e}else{let t=[],n=!1;const a=bi(s,e.apply(this,r));try{for(const e of a)-1===i||!n&&t.length<i?t.push(e):(n=!0,t=[]),yield e;n||s.log({output:t})}catch(e){throw ci(s,e),!n&&t.length>0&&s.log({output:t}),e}}}finally{s.end()}};return Object.defineProperty(r,"name",{value:e.name}),r}(e,n,!!i):di(e)?function(e,t,n){const r=async function*(...r){const s=mi(t);try{n||s.log({input:r});const t=jn.getEnv("BRAINTRUST_MAX_GENERATOR_ITEMS"),i=void 0!==t?Number(t):1e3;if(n||0===i){const t=wi(s,e.apply(this,r));for await(const e of t)yield e}else{let t=[],n=!1;const a=wi(s,e.apply(this,r));try{for await(const e of a)-1===i||!n&&t.length<i?t.push(e):(n=!0,t=[]),yield e;n||s.log({output:t})}catch(e){throw ci(s,e),!n&&t.length>0&&s.log({output:t}),e}}}finally{s.end()}};return Object.defineProperty(r,"name",{value:e.name}),r}(e,n,!!i):t?.asyncFlush?(...t)=>li(n=>{r||n.log({input:t});const i=e(...t);if(!s){if(i instanceof Promise)return(async()=>{const e=await i;return n.log({output:e}),e})();n.log({output:i})}return i},n):(...t)=>li(async n=>{r||n.log({input:t});const i=e(...t),a=await i;return s||n.log({output:a}),a},n)}var pi=hi;function mi(e){return yi(e).span}async function gi(e){const t=e?.state??ps;return await t.bgLogger().flush()}function fi(e){ps.setFetch(e)}function yi(e){const t=e?.state??ps,n=e?.parent??t.currentParent.getStore(),r=n?Gt.fromStr(n):void 0;if(r){const n=r.data.row_id?{spanId:r.data.span_id,rootSpanId:r.data.root_span_id}:void 0;return{span:new $i({state:t,...e,parentObjectType:r.data.object_type,parentObjectId:new ns(Rs(t,r)),parentComputeObjectMetadataArgs:r.data.compute_object_metadata_args??void 0,parentSpanIds:n,propagatedEvent:e?.propagatedEvent??r.data.propagated_event??void 0}),isSyncFlushLogger:r.data.object_type===Nt.PROJECT_LOGS&&!1===e?.asyncFlush}}{const t=oi({asyncFlush:e?.asyncFlush});return{span:t.startSpan(e),isSyncFlushLogger:"logger"===t.kind&&!1===t.asyncFlush}}}function _i(e,t,n=void 0){return(n??ps).currentSpan.run(e,()=>t(e))}function*bi(e,t,n=void 0){let r;for(;;){const s=_i(e,()=>{try{return t.next(r)}catch(e){return{value:void 0,done:!0,error:e}}},n);if("error"in s)throw s.error;if(s.done)return s.value;r=yield s.value}}async function*wi(e,t,n=void 0){let r;for(;;){const s=await _i(e,async()=>{try{return await t.next(r)}catch(e){return{value:void 0,done:!0,error:e}}},n);if("error"in s)throw s.error;if(s.done)return s.value;r=yield s.value}}function vi(e,t,n=void 0){return(n??ps).currentParent.run(e,()=>t())}function Ei(e,t,n){if(0===t.length)throw new Error("This user is not part of any organizations.");for(const r of t)if(void 0===n||r.name===n){e.orgId=r.id,e.orgName=r.name,e.apiUrl=jn.getEnv("BRAINTRUST_API_URL")??r.api_url,e.proxyUrl=jn.getEnv("BRAINTRUST_PROXY_URL")??r.proxy_url,e.gitMetadataSettings=r.git_metadata||void 0;break}if(void 0===e.orgId)throw new Error(`Organization ${n} not found. Must be one of ${t.map(e=>e.name).join(", ")}`)}function Si(e){const t=new Set;for(const n of e){if("string"!=typeof n)throw new Error("tags must be strings");if(t.has(n))throw new Error(`duplicate tag: ${n}`)}}function xi(e){if(e.scores){if(Array.isArray(e.scores))throw new Error("scores must be an object, not an array");for(let[t,n]of Object.entries(e.scores)){if("string"!=typeof t)throw new Error("score names must be strings");if(null!=n){if("boolean"==typeof n&&(n=n?1:0,e.scores[t]=n),"number"!=typeof n)throw new Error("score values must be numbers");if(n<0||n>1)throw new Error("score values must be between 0 and 1")}}}if(e.metadata)for(const t of Object.keys(e.metadata))if("string"!=typeof t)throw new Error("metadata keys must be strings");if(e.metrics)for(const[t,n]of Object.entries(e.metrics)){if("string"!=typeof t)throw new Error("metric keys must be strings");if(void 0!==n&&"number"!=typeof n)throw new Error("metric values must be numbers")}if("input"in e&&e.input&&"inputs"in e&&e.inputs)throw new Error("Only one of input or inputs (deprecated) can be specified. Prefer input.");if("tags"in e&&e.tags&&Si(e.tags),"inputs"in e){const{inputs:t,...n}=e;return{input:t,...n}}return{...e}}function ki(e){const t=[],n="_bt_internal_saved_attachment",r=o.re({[n]:o.ai()}),s=JSON.stringify(e,(e,r)=>{if(r instanceof $i||r instanceof ms)return"<span>";if(r instanceof Ai)return"<experiment>";if(r instanceof ji)return"<dataset>";if(r instanceof Us)return"<logger>";if(r instanceof ks){const e=t.push(r);return{[n]:e-1}}return r instanceof Cs?r.reference:r});return JSON.parse(s,(e,s)=>{const i=r.safeParse(s);return i.success?t[i.data[n]]:s})}function Ti(e,t){for(const[n,r]of Object.entries(e))if(r)if(r instanceof ks)t.push(r),e[n]=r.reference;else if(r?.type!==os||!r.key||r.uploader){if(r?.reference?.type===os&&r?.uploader){const s=new Ts({data:r.dataDebugString,filename:r.reference.filename,contentType:r.reference.content_type});t.push(s),e[n]=s.reference;continue}r instanceof Object&&Ti(r,t)}}function Ii(e,t){for(const[n,r]of Object.entries(e)){const s=Hn.safeParse(r);s.success?e[n]=new Cs(s.data,t):r instanceof Object&&Ii(r,t)}return e}async function Oi(e,t){for(const[n,r]of Object.entries(e))r instanceof Cs?e[n]=await r.asBase64Url():r instanceof Object&&await Oi(r,t);return e}var Ci=class{constructor(e,t,n,r){this.objectType=e,this.pinnedVersion=t,this.mutateRecord=n,this._internal_btql=r}_fetchedData=void 0;get id(){throw new Error("ObjectFetcher subclasses must have an 'id' attribute")}async getState(){throw new Error("ObjectFetcher subclasses must have a 'getState' method")}async*fetch(){const e=await this.fetchedData();for(const t of e)yield t}[Symbol.asyncIterator](){return this.fetch()}async fetchedData(){if(void 0===this._fetchedData){const e=await this.getState();let t,n,r=0;for(;;){const s=await e.apiConn().post("btql",{query:{...this._internal_btql,select:[{op:"star"}],from:{op:"function",name:{op:"ident",name:[this.objectType]},args:[{op:"literal",value:await this.id}]},cursor:n,limit:1e3},use_columnstore:!1,brainstore_realtime:!0},{headers:{"Accept-Encoding":"gzip"}}),i=await s.json();if(t=(t??[]).concat(i.data),!i.cursor)break;if(n=i.cursor,r++,r>1e4)throw new Error("Too many BTQL iterations")}this._fetchedData=this.mutateRecord?t?.map(this.mutateRecord):t}return this._fetchedData||[]}clearCache(){this._fetchedData=void 0}async version(){if(void 0!==this.pinnedVersion)return this.pinnedVersion;{const e=await this.fetchedData();let t;for(const n of e){const e=String(n[bt]??"0");(void 0===t||e>t)&&(t=e)}return t}}},Ai=class extends Ci{lazyMetadata;dataset;lastStartTime;lazyId;calledStartSpan;state;kind="experiment";constructor(e,t,n){super("experiment",void 0,t=>Ii(t,e)),this.lazyMetadata=t,this.dataset=n,this.lastStartTime=es(),this.lazyId=new ns(async()=>await this.id),this.calledStartSpan=!1,this.state=e}get id(){return(async()=>(await this.lazyMetadata.get()).experiment.id)()}get name(){return(async()=>(await this.lazyMetadata.get()).experiment.name)()}get project(){return(async()=>(await this.lazyMetadata.get()).project)()}parentObjectType(){return Nt.EXPERIMENT}async getState(){return await this.lazyMetadata.get(),this.state}log(e,t){if(this.calledStartSpan&&!t?.allowConcurrentWithSpans)throw new Error("Cannot run toplevel `log` method while using spans. To log to the span, call `experiment.traced` and then log with `span.log`");e=function(e,t){if("input"in e&&!ts(e.input)&&"inputs"in e&&!ts(e.inputs)||!("input"in e)&&!("inputs"in e))throw new Error("Exactly one of input or inputs (deprecated) must be specified. Prefer input.");if(ts(e.output))throw new Error("output must be specified");if(ts(e.scores))throw new Error("scores must be specified");if(t&&void 0===e.datasetRecordId)throw new Error("datasetRecordId must be specified when using a dataset");if(!t&&void 0!==e.datasetRecordId)throw new Error("datasetRecordId cannot be specified when not using a dataset");return e}(e,!!this.dataset);const n=this.startSpanImpl({startTime:this.lastStartTime,event:e});return this.lastStartTime=n.end(),n.id}traced(e,t){const{setCurrent:n,...r}=t??{},s=this.startSpan(r);return Qr(()=>n??1?_i(s,e):e(s),e=>{throw ci(s,e),e},()=>s.end())}startSpan(e){return this.calledStartSpan=!0,this.startSpanImpl(e)}startSpanImpl(e){return new $i({...e,state:this.state,...Ds({state:this.state,parent:e?.parent,parentObjectType:this.parentObjectType(),parentObjectId:this.lazyId,parentComputeObjectMetadataArgs:void 0,parentSpanIds:void 0,propagatedEvent:e?.propagatedEvent}),defaultRootType:sn.EVAL})}async fetchBaseExperiment(){const e=(await this.getState()).appConn();try{const t=await e.post("/api/base_experiment/get_id",{id:await this.id}),n=await t.json();return{id:n.base_exp_id,name:n.base_exp_name}}catch(e){if(e instanceof Es&&400===e.status)return null;throw e}}async summarize(e={}){let{summarizeScores:t=!0,comparisonExperimentId:n}=e||{};const r=await this.getState(),s=`${r.appPublicUrl}/app/${encodeURIComponent(r.orgName)}/p/${encodeURIComponent((await this.project).name)}`,i=`${s}/experiments/${encodeURIComponent(await this.name)}`;let a,o,c;if(t){if(await this.flush(),void 0===n){const e=await this.fetchBaseExperiment();null!==e&&(n=e.id,c=e.name)}try{const e=await r.apiConn().get_json("/experiment-comparison2",{experiment_id:await this.id,base_experiment_id:n},3);a=e.scores,o=e.metrics}catch(e){a={},o={}}}return{projectName:(await this.project).name,experimentName:await this.name,projectId:(await this.project).id,experimentId:await this.id,projectUrl:s,experimentUrl:i,comparisonExperimentName:c,scores:a??{},metrics:o??{}}}logFeedback(e){As(this.state,this.parentObjectType(),this.lazyId,e)}updateSpan(e){const{id:t,...n}=e;if(!t)throw new Error("Span id is required to update a span");Ps({state:this.state,parentObjectType:this.parentObjectType(),parentObjectId:this.lazyId,id:t,event:n})}async export(){return new Gt({object_type:this.parentObjectType(),object_id:await this.id}).toStr()}async flush(){return await this.state.bgLogger().flush()}async close(){return this.id}},Pi=class extends Ci{constructor(e,t){super("experiment",void 0,t=>Ii(t,e)),this.state=e,this.lazyMetadata=t}get id(){return(async()=>(await this.lazyMetadata.get()).experiment.id)()}get name(){return(async()=>(await this.lazyMetadata.get()).experiment.name)()}async getState(){return await this.lazyMetadata.get(),this.state}async*asDataset(){const e=this.fetch();for await(const t of e){if(t.root_span_id!==t.span_id)continue;const{output:e,expected:n,metadata:r}=t,s=n??e;yield{input:t.input,tags:t.tags,expected:s,metadata:r}}}},Mi=0;function Ri(){return pt()}var $i=class e{_state;isMerge;loggedEndTime;propagatedEvent;parentObjectType;parentObjectId;parentComputeObjectMetadataArgs;_id;_spanId;_rootSpanId;_spanParents;kind="span";constructor(e){this._state=e.state;const t=e.spanAttributes??{},n=e.event??{},r=e.type??(e.parentSpanIds?void 0:e.defaultRootType);this.loggedEndTime=void 0,this.parentObjectType=e.parentObjectType,this.parentObjectId=e.parentObjectId,this.parentComputeObjectMetadataArgs=e.parentComputeObjectMetadataArgs,this.propagatedEvent=e.propagatedEvent,this.propagatedEvent&&Kt(n,this.propagatedEvent);const{id:s,...i}=n,a=jn.getCallerLocation(),o=(()=>{if(e.name)return e.name;if(!e.parentSpanIds)return"root";if(a){const e=a.caller_filename.split("/"),t=e[e.length-1];return[a.caller_functionname].concat(t?[`${t}:${a.caller_lineno}`]:[]).join(":")}return"subspan"})(),c={metrics:{start:e.startTime??es()},context:{...a},span_attributes:{name:o,type:r,...t,exec_counter:Mi++},created:(new Date).toISOString()};this._id=s??pt(),this._spanId=e.spanId??pt(),e.parentSpanIds?(this._rootSpanId=e.parentSpanIds.rootSpanId,this._spanParents="parentSpanIds"in e.parentSpanIds?e.parentSpanIds.parentSpanIds:[e.parentSpanIds.spanId]):(this._rootSpanId=this._spanId,this._spanParents=void 0),this.isMerge=!1,this.logInternal({event:i,internalData:c}),this.isMerge=!0}get id(){return this._id}get spanId(){return this._spanId}get rootSpanId(){return this._rootSpanId}get spanParents(){return this._spanParents??[]}setAttributes(e){this.logInternal({internalData:{span_attributes:e}})}setSpanParents(e){this.logInternal({internalData:{span_parents:e}})}log(e){this.logInternal({event:e})}logInternal({event:e,internalData:t}){const[n,r]=function({event:e,internalData:t}){const n=xi(e??{}),r={};Kt(r,t||{}),Kt(r,n);const s={},i={};for(const[e,t]of Object.entries(r))if(t instanceof zr){const n=t.copy();i[e]=new ns(async()=>await new Promise((e,t)=>{n.toReadableStream().pipeThrough(qr(e,t)).pipeTo(Kr())}))}else t instanceof ReadableStream?i[e]=new ns(async()=>await new Promise((e,n)=>{t.pipeThrough(qr(e,n)).pipeTo(Kr())})):s[e]=t;return[s,i]}({event:e,internalData:t}),s=ki({id:this.id,span_id:this._spanId,root_span_id:this._rootSpanId,span_parents:this._spanParents,...n,[wt]:this.isMerge});if(s.metrics?.end&&(this.loggedEndTime=s.metrics?.end),(s.tags??[]).length>0&&this._spanParents?.length)throw new Error("Tags can only be logged to the root span");this._state.bgLogger().log([new ns(async()=>({...s,...Object.fromEntries(await Promise.all(Object.entries(r).map(async([e,t])=>[e,await t.get()]))),...new Gt({object_type:this.parentObjectType,object_id:await this.parentObjectId.get()}).objectIdFields()}))])}logFeedback(e){As(this._state,this.parentObjectType,this.parentObjectId,{...e,id:this.id})}traced(e,t){const{setCurrent:n,...r}=t??{},s=this.startSpan(r);return Qr(()=>n??1?_i(s,e):e(s),e=>{throw ci(s,e),e},()=>s.end())}startSpan(t){const n=t?.parent?void 0:{spanId:this._spanId,rootSpanId:this._rootSpanId};return new e({state:this._state,...t,...Ds({state:this._state,parent:t?.parent,parentObjectType:this.parentObjectType,parentObjectId:this.parentObjectId,parentComputeObjectMetadataArgs:this.parentComputeObjectMetadataArgs,parentSpanIds:n,propagatedEvent:t?.propagatedEvent??this.propagatedEvent})})}startSpanWithParents(t,n,r){const s={parentSpanIds:n,rootSpanId:this._rootSpanId};return new e({state:this._state,...r,...Ds({state:this._state,parent:r?.parent,parentObjectType:this.parentObjectType,parentObjectId:this.parentObjectId,parentComputeObjectMetadataArgs:this.parentComputeObjectMetadataArgs,parentSpanIds:s,propagatedEvent:r?.propagatedEvent??this.propagatedEvent}),spanId:t})}end(e){let t,n={};return this.loggedEndTime?t=this.loggedEndTime:(t=e?.endTime??es(),n={metrics:{end:t}}),this.logInternal({internalData:n}),t}async export(){return new Gt({object_type:this.parentObjectType,...this.parentComputeObjectMetadataArgs&&!this.parentObjectId.hasSucceeded?{compute_object_metadata_args:this.parentComputeObjectMetadataArgs}:{object_id:await this.parentObjectId.get()},row_id:this.id,span_id:this._spanId,root_span_id:this._rootSpanId,propagated_event:this.propagatedEvent}).toStr()}async permalink(){return await Ls(await this.export(),{state:this._state})}link(){if(!this.id)return fs;try{const e=this._state.orgName;if(!e)throw new Error("log-in-or-provide-org-name");return this._link(e)}catch(e){return Ns(e instanceof Error?e.message:String(e))}}_link(e){const t=`${this._state.appUrl||"https://www.braintrust.dev"}/app/${e}`,n=this.parentComputeObjectMetadataArgs;switch(this.parentObjectType){case Nt.PROJECT_LOGS:{const e=n?.project_id||this.parentObjectId.getSync().value,r=n?.project_name;return e?`${t}/object?object_type=project_logs&object_id=${e}&id=${this._id}`:r?`${t}/p/${r}/logs?oid=${this._id}`:Ns("provide-project-name-or-id")}case Nt.EXPERIMENT:{const e=n?.experiment_id||this.parentObjectId?.getSync()?.value;return e?`${t}/object?object_type=experiment&object_id=${e}&id=${this._id}`:Ns("provide-experiment-id")}case Nt.PLAYGROUND_LOGS:return fs;default:this.parentObjectType;return fs}}async flush(){return await this._state.bgLogger().flush()}close(e){return this.end(e)}state(){return this._state}};var ji=class extends Ci{constructor(e,t,n,r,s){const i=r??false;super("dataset",n,e=>function(e,t){return t?function(e){if("output"in e)return e;const t={...e,output:e.expected};return delete t.expected,t}(e):function(e){if("expected"in e)return e;const t={...e,tags:null,expected:e.output};return delete t.output,t}(e)}(Ii(e,this.state),i),s),this.state=e,this.lazyMetadata=t}lazyMetadata;__braintrust_dataset_marker=!0;newRecords=0;get id(){return(async()=>(await this.lazyMetadata.get()).dataset.id)()}get name(){return(async()=>(await this.lazyMetadata.get()).dataset.name)()}get project(){return(async()=>(await this.lazyMetadata.get()).project)()}async getState(){return await this.lazyMetadata.get(),this.state}validateEvent({metadata:e,expected:t,output:n,tags:r}){if(void 0!==e)for(const t of Object.keys(e))if("string"!=typeof t)throw new Error("metadata keys must be strings");if(void 0!==t&&void 0!==n)throw new Error("Only one of expected or output (deprecated) can be specified. Prefer expected.");r&&Si(r)}createArgs({id:e,input:t,expected:n,metadata:r,tags:s,output:i,isMerge:a}){return new ns(async()=>{const o=await this.id;return{id:e,input:t,expected:void 0===n?i:n,tags:s,dataset_id:o,created:a?void 0:(new Date).toISOString(),metadata:r,...a?{[wt]:!0}:{}}})}insert({input:e,expected:t,metadata:n,tags:r,id:s,output:i}){this.validateEvent({metadata:n,expected:t,output:i,tags:r});const a=s||pt(),o=this.createArgs(ki({id:a,input:e,expected:t,metadata:n,tags:r,output:i,isMerge:!1}));return this.state.bgLogger().log([o]),this.newRecords++,a}update({input:e,expected:t,metadata:n,tags:r,id:s}){this.validateEvent({metadata:n,expected:t,tags:r});const i=this.createArgs(ki({id:s,input:e,expected:t,metadata:n,tags:r,isMerge:!0}));return this.state.bgLogger().log([i]),s}delete(e){const t=new ns(async()=>({id:e,dataset_id:await this.id,created:(new Date).toISOString(),_object_delete:!0}));return this.state.bgLogger().log([t]),e}async summarize(e={}){const{summarizeData:t=!0}=e||{};await this.flush();const n=await this.getState(),r=`${n.appPublicUrl}/app/${encodeURIComponent(n.orgName)}/p/${encodeURIComponent((await this.project).name)}`,s=`${r}/datasets/${encodeURIComponent(await this.name)}`;let i;if(t){const e=o.Ik({total_records:o.ai()}).parse(await n.apiConn().get_json("dataset-summary",{dataset_id:await this.id},3));i={newRecords:this.newRecords,totalRecords:e.total_records}}return{projectName:(await this.project).name,datasetName:await this.name,projectUrl:r,datasetUrl:s,dataSummary:i}}async flush(){return await this.state.bgLogger().flush()}async close(){return this.id}static isDataset(e){return"object"==typeof e&&null!==e&&"__braintrust_dataset_marker"in e}};function Ni(e,t){return{...t,..."content"in t?{content:ts(t.content)?void 0:"string"==typeof t.content?e(t.content):t.content.map(t=>{switch(t.type){case"text":return{...t,text:e(t.text)};case"image_url":if(Bt(t.image_url.url))throw new Error("Attachments must be replaced with URLs before calling `build()`");return{...t,image_url:{...t.image_url,url:e(t.image_url.url)}};default:return t}})}:{},..."tool_calls"in t?{tool_calls:ts(t.tool_calls)?void 0:t.tool_calls.map(t=>({type:t.type,id:e(t.id),function:{name:e(t.function.name),arguments:e(t.function.arguments)}}))}:{},..."tool_call_id"in t?{tool_call_id:e(t.tool_call_id)}:{}}}function Li(e){if(""===e.trim())return{value:null,error:void 0};try{return{value:JSON.parse(e),error:void 0}}catch(t){return{value:e,error:t}}}function Di(e,t,n){return"string"==typeof e?(n.strict&&as(e,t),An.render(e,t,void 0,{escape:e=>"string"==typeof e?e:JSON.stringify(e)})):e instanceof Array?e.map(e=>Di(e,t,n)):Bt(e)?Object.fromEntries(Object.entries(e).map(([e,r])=>[e,Di(r,t,n)])):e}function Ui(e,t,n){const r=o.Ik({response_format:o.Ik({type:o.eu("json_schema"),json_schema:Un.omit({schema:!0}).extend({schema:o.L5()})})}).safeParse(e);if(r.success){const s=Di(r.data.response_format.json_schema.schema,t,n),i="string"==typeof s?Li(s).value:s;return{...e,response_format:{...r.data.response_format,json_schema:{...r.data.response_format.json_schema,schema:i}}}}return e}var Fi=class e{constructor(e,t,n){this.metadata=e,this.defaults=t,this.noTrace=n}parsedPromptData;hasParsedPromptData=!1;__braintrust_prompt_marker=!0;get id(){return this.metadata.id}get projectId(){return this.metadata.project_id}get name(){return"name"in this.metadata?this.metadata.name:`Playground function ${this.metadata.id}`}get slug(){return"slug"in this.metadata?this.metadata.slug:this.metadata.id}get prompt(){return this.getParsedPromptData()?.prompt}get version(){return this.metadata[bt]}get options(){return this.getParsedPromptData()?.options||{}}get promptData(){return this.getParsedPromptData()}build(e,t={}){return this.runBuild(e,{flavor:t.flavor??"chat",messages:t.messages,strict:t.strict})}async buildWithAttachments(e,t={}){const n=e instanceof Object?await Oi(e,t.state):e;return this.runBuild(n,{flavor:t.flavor??"chat",messages:t.messages,strict:t.strict})}runBuild(t,n){const{flavor:r}=n,s={...this.defaults,...Object.fromEntries(Object.entries(this.options.params||{}).filter(([e,t])=>!ls.includes(e))),...ts(this.options.model)?{}:{model:this.options.model}};if(!("model"in s)||ts(s.model))throw new Error("No model specified. Either specify it in the prompt or as a default");const i=this.noTrace?{}:{span_info:{metadata:{prompt:this.id?{variables:t,id:this.id,project_id:this.projectId,version:this.version,..."prompt_session_id"in this.metadata?{prompt_session_id:this.metadata.prompt_session_id}:{}}:void 0}}},a=this.prompt;if(!a)throw new Error("Empty prompt");const c=o.g1(o.L5()).safeParse(t),l={input:t,...c.success?c.data:{}},u=e.renderPrompt({prompt:a,buildArgs:t,options:n});if("chat"===r){if("chat"!==u.type)throw new Error("Prompt is a completion prompt. Use buildCompletion() instead");return{...Ui(s,l,{strict:n.strict}),...i,messages:u.messages,...u.tools?{tools:nr.array().parse(JSON.parse(u.tools))}:void 0}}if("completion"===r){if("completion"!==u.type)throw new Error("Prompt is a chat prompt. Use flavor: 'chat' instead");return{...Ui(s,l,{strict:n.strict}),...i,prompt:u.content}}throw new Error("never!")}static renderPrompt({prompt:e,buildArgs:t,options:n}){const r=e=>{if(void 0===e)throw new Error("Missing!");if("string"==typeof e)return e;if(e instanceof Cs)throw new Error("Use buildWithAttachments() to build prompts with attachments");return JSON.stringify(e)},s=o.g1(o.L5()).safeParse(t),i={input:t,...s.success?s.data:{}};if("chat"===e.type){const t=e=>(n.strict&&as(e,i),An.render(e,i,void 0,{escape:r})),s=(e.messages||[]).map(e=>Ni(t,e)),a=s.some(e=>"system"===e.role);return{type:"chat",messages:[...s,...(n.messages??[]).filter(e=>!(a&&"system"===e.role))],...e.tools?.trim()?{tools:t(e.tools)}:void 0}}if("completion"===e.type){if(n.messages)throw new Error("extra messages are not supported for completion prompts");return n.strict&&as(e.content,i),{type:"completion",content:An.render(e.content,i,void 0,{escape:r})}}throw new Error(`Invalid prompt type: ${e}`)}getParsedPromptData(){return this.hasParsedPromptData||(this.parsedPromptData=Er.parse(this.metadata.prompt_data),this.hasParsedPromptData=!0),this.parsedPromptData}static isPrompt(e){return"object"==typeof e&&null!==e&&"__braintrust_prompt_marker"in e}static fromPromptData(t,n){return new e({name:t,slug:t,prompt_data:n},{},!1)}},Yi="___TEST_API_KEY__THIS_IS_NOT_REAL___";function Gi(){vs()||ws()}async function Bi(e,t){const n=vs();if(!n)throw new Error("Must log in first");await n.login({});const r={from:{op:"function",name:{op:"ident",name:["project_prompts"]},args:[{op:"literal",value:e}]},select:[{op:"star"}],filter:{op:"eq",left:{op:"ident",name:["id"]},right:{op:"literal",value:t}}},s=await n.apiConn().post("btql",{query:r,audit_log:!0,use_columnstore:!1,brainstore_realtime:!0},{headers:{"Accept-Encoding":"gzip"}});if(!s.ok)throw new Error(`API request failed: ${s.status} ${s.statusText}`);const i=await s.json();return i.data?.filter(e=>["upsert","merge"].includes(e.audit_data?.action)).map(e=>{return t=e._xact_id,cn(BigInt(t),on).toString(16).padStart(16,"0");var t})||[]}var Hi={extractAttachments:Ti,deepCopyEvent:ki,useTestBackgroundLogger:function(){const e=vs();if(!e)throw new Error("global state not set yet");const t=new Gs;return e.setOverrideBgLogger(t),t},clearTestBackgroundLogger:function(){vs()?.setOverrideBgLogger(null)},simulateLoginForTests:async function(){return await ei({apiKey:Yi,appUrl:"https://braintrust.dev"})},simulateLogoutForTests:function(){return ps.resetLoginInfo(),ps.appUrl="https://www.braintrust.dev",ps},setInitialTestState:Gi,initTestExperiment:function(e,t){Gi();const n=vs(),r=t??e,s=new ns(async()=>({project:{id:r,name:r,fullInfo:{}},experiment:{id:e,name:e,fullInfo:{}}}));return new Ai(n,s)},isGeneratorFunction:ui,isAsyncGeneratorFunction:di},zi=!1;var qi={};async function Ki(e){const{orgName:t,apiKey:n,appUrl:r,forceLogin:s,fetch:i,input:a,messages:o,parent:c,metadata:l,tags:u,state:d,stream:h,mode:p,schema:m,strict:g,...f}=e,y=d??vs();await y.login({orgName:t,apiKey:n,appUrl:r,forceLogin:s,fetch:i});const _=c?"string"==typeof c?c:await c.export():await oi().export(),b=xr.safeParse({function_id:f.function_id,project_name:f.projectName,slug:f.slug,global_function:f.globalFunction,prompt_session_id:f.promptSessionId,prompt_session_function_id:f.promptSessionFunctionId,version:f.version});if(!b.success)throw new Error(`Invalid function ID arguments: ${b.error.message}`);const w={...b.data,input:a,messages:o,parent:_,metadata:l,tags:u,stream:h,mode:p,strict:g},v=await y.proxyConn().post("function/invoke",w,{headers:{Accept:h?"text/event-stream":"application/json"}});if(h){if(!v.body)throw new Error("Received empty stream body");return new zr(v.body)}{const e=await v.json();return m?m.parse(e):e}}function Wi({projectName:e,slug:t,version:n}){const r=async r=>await Ki({projectName:e,slug:t,version:n,input:r});return Object.defineProperty(r,"name",{value:`initFunction-${e}-${t}-${n??"latest"}`}),r}function Vi(e){return e.responses?new Proxy(e.responses,{get:(e,t,n)=>"create"===t?function(e){return ia(e,{name:"openai.responses",toSpanFunc:Ji,resultToEventFunc:Zi,traceStreamFunc:ea})}(e.create.bind(e)):"stream"===t?function(e){return new Proxy(e,{apply(e,t,n){const r=Reflect.apply(e,t,n);if(!n||0===n.length)return r;const s=Ji(n[0]),i=s.span;let a=-1;return r.on("event",e=>{-1===a&&(a=es()-s.start,i.log({metrics:{time_to_first_token:a}}));const t=ta(e);is(t)||i.log(t)}),r.on("end",()=>{i.end()}),r}})}(e.stream.bind(e)):"parse"===t?function(e){return ia(e,{name:"openai.responses.parse",toSpanFunc:Xi,resultToEventFunc:Qi,traceStreamFunc:ea})}(e.parse.bind(e)):Reflect.get(e,t,n)}):e}function Ji(e){const t={name:"openai.responses.create",spanAttributes:{type:"llm"},event:{input:e.input,metadata:{...ss(e,["input"]),provider:"openai"}},startTime:es()};return{span:mi(t),start:t.startTime}}function Zi(e){const t={};if(void 0!==e?.output&&(t.output=e.output),e){const{output:n,usage:r,...s}=e;Object.keys(s).length>0&&(t.metadata=s)}return t.metrics=sa(e?.usage),t}function Xi(e){const t={name:"openai.responses.parse",spanAttributes:{type:"llm"},event:{input:e.input,metadata:{...ss(e,["input"]),provider:"openai"}},startTime:es()};return{span:mi(t),start:t.startTime}}function Qi(e){const t={};if(void 0!==e?.output&&(t.output=e.output),e){const{output:n,usage:r,...s}=e;Object.keys(s).length>0&&(t.metadata=s)}return t.metrics=sa(e?.usage),t}function ea(e,t){const n=t.span;let r=-1;return async function(...s){const i=await e.next(...s);if(-1===r&&(r=es()-t.start,n.log({metrics:{time_to_first_token:r}})),i.done)return n.end(),i;const a=i.value;if(!a||!a?.type||!a?.response)return i;const o=ta(a);return is(o)||n.log(o),i}}function ta(e){if(!e||!e?.type||!e?.response)return{};const t=e.response;if("response.completed"===e.type){const e={};if(void 0!==t?.output&&(e.output=t.output),t){const{usage:n,output:r,...s}=t;Object.keys(s).length>0&&(e.metadata=s)}return e.metrics=sa(t?.usage),e}return{}}((e,t)=>{for(var n in t)Rn(e,n,{get:t[n],enumerable:!0})})(qi,{Attachment:()=>Ts,BaseAttachment:()=>ks,BraintrustState:()=>bs,BraintrustStream:()=>zr,Dataset:()=>ji,ERR_PERMALINK:()=>js,Experiment:()=>Ai,ExternalAttachment:()=>Is,FailedHTTPResponse:()=>Es,INTERNAL_BTQL_LIMIT:()=>1e3,LEGACY_CACHED_HEADER:()=>ua,LazyValue:()=>ns,Logger:()=>Us,NOOP_SPAN:()=>gs,NOOP_SPAN_PERMALINK:()=>fs,NoopSpan:()=>ms,Prompt:()=>Fi,ReadonlyAttachment:()=>Cs,ReadonlyExperiment:()=>Pi,SpanImpl:()=>$i,TestBackgroundLogger:()=>Gs,X_CACHED_HEADER:()=>da,_exportsForTestingOnly:()=>Hi,_internalGetGlobalState:()=>vs,_internalSetInitialState:()=>ws,braintrustStreamChunkSchema:()=>Hr,createFinalValuePassThroughStream:()=>qr,currentExperiment:()=>si,currentLogger:()=>ii,currentSpan:()=>ai,deserializePlainStringAsJSON:()=>Li,devNullWritableStream:()=>Kr,evaluatorDefinitionSchema:()=>ka,evaluatorDefinitionsSchema:()=>Ta,flush:()=>gi,getPromptVersions:()=>Bi,getSpanParentObject:()=>oi,init:()=>Hs,initDataset:()=>Ws,initExperiment:()=>zs,initFunction:()=>Wi,initLogger:()=>Zs,invoke:()=>Ki,loadPrompt:()=>Xs,log:()=>ni,logError:()=>ci,login:()=>ei,loginToState:()=>ti,newId:()=>Ri,parseCachedHeader:()=>ha,permalink:()=>Ls,renderMessage:()=>Ni,renderPromptParams:()=>Ui,setFetch:()=>fi,setMaskingFunction:()=>Qs,spanComponentsToObjectId:()=>$s,startSpan:()=>mi,summarize:()=>ri,traceable:()=>pi,traced:()=>li,updateSpan:()=>Ms,withCurrent:()=>_i,withDataset:()=>Vs,withExperiment:()=>qs,withLogger:()=>Ks,withParent:()=>vi,wrapOpenAI:()=>aa,wrapOpenAIv4:()=>oa,wrapTraced:()=>hi});var na={input_tokens:"prompt_tokens",output_tokens:"completion_tokens",total_tokens:"tokens"},ra={input:"prompt",output:"completion"};function sa(e){if(!e)return{};const t={};for(const[n,r]of Object.entries(e))if("number"==typeof r){t[na[n]||n]=r}else if(n.endsWith("_tokens_details")){if(!Bt(r))continue;const e=n.slice(0,-15),s=ra[e]||e;for(const[e,n]of Object.entries(r)){if("number"!=typeof n)continue;t[`${s}_${e}`]=n}}return t}function ia(e,t){return new Proxy(e,{apply(e,n,r){if(!r||0===r.length)return Reflect.apply(e,n,r);const s=r[0],i=t.toSpanFunc(s);return function(e,t,n){return new Proxy(e,{get(e,t,r){if("then"===t){const s=Reflect.get(e,t,r);return function(t,r){return s.call(e,async e=>{const r=n(e);return t?t(r):r},r)}}return Reflect.get(e,t,r)}})}(Reflect.apply(e,n,r),0,function(e){if(s.stream)return n=e,r=i,a=t.traceStreamFunc,new Proxy(n,{get(e,t,n){if(t===Symbol.asyncIterator){const s=Reflect.get(e,t,n);return function(){const t=s.call(e);return new Proxy(t,{get:(e,n,s)=>"next"===n?a(t,r):Reflect.get(e,n,s)})}}return Reflect.get(e,t,n)}});{const n=t.resultToEventFunc(e),r=i.span;return r.log(n),r.end(),e}var n,r,a},t.traceStreamFunc)}})}function aa(e){const t=e;return t&&"object"==typeof t&&"chat"in t&&"object"==typeof t.chat&&t.chat&&"completions"in t.chat&&"object"==typeof t.chat.completions&&t.chat.completions&&"create"in t.chat.completions?oa(t):e}function oa(e){const t=new Proxy(e.chat.completions,{get(e,t,n){const r=Reflect.get(e,t,n);return"create"===t?(s=r.bind(e),(e,t)=>{const{span_info:n,...r}=e;let i=null;const a=()=>(i||(i=(async()=>{const n=mi(Kt({name:"Chat Completion",spanAttributes:{type:sn.LLM}},ya(e))),i=es();if(r.stream){const{data:e,response:a}=await s(r,t).withResponse();pa(a,n);const o=new Sa(n,i,e.iterator());return e.iterator=()=>o[Symbol.asyncIterator](),{data:e,response:a}}try{const e=s(r,t),{data:a,response:o}=await e.withResponse();pa(o,n);const{messages:c,...l}=r;return n.log({input:c,metadata:{...l}}),ca(i,a,n),{data:a,response:o}}finally{n.end()}})()),i),o=a().then(e=>e.data);return new Proxy(o,{get(e,t,n){if("withResponse"===t)return a;const r=Reflect.get(e,t,n);return"function"==typeof r?r.bind(e):r}})}):"parse"===t?la(r.bind(e)):r;var s}}),n=new Proxy(e.chat,{get:(e,n,r)=>"completions"===n?t:Reflect.get(e,n,r)}),r=fa(e.embeddings,wa),s=fa(e.moderations,va);let i;if(e.beta?.chat?.completions?.stream){const t=new Proxy(e?.beta?.chat.completions,{get(e,t,n){const r=Reflect.get(e,t,n);return"parse"===t?la(r.bind(e)):"stream"===t?(s=r.bind(e),e=>{const{span_info:t,...n}=e,r=mi(Kt({name:"Chat Completion",spanAttributes:{type:sn.LLM}},ya(e))),i=es(),a=s(n);let o=!0;return a.on("chunk",e=>{if(o){const e=es();r.log({metrics:{time_to_first_token:e-i}}),o=!1}}),a.on("chatCompletion",e=>{r.log({output:e.choices})}),a.on("end",()=>{r.end()}),a}):r;var s}}),n=new Proxy(e.beta.chat,{get:(e,n,r)=>"completions"===n?t:Reflect.get(e,n,r)});i=new Proxy(e.beta,{get:(e,t,r)=>"chat"===t?n:Reflect.get(e,t,r)})}return new Proxy(e,{get(t,a,o){switch(a){case"chat":return n;case"embeddings":return r;case"moderations":return s;case"responses":return Vi(e)}return"beta"===a&&i?i:Reflect.get(t,a,o)}})}function ca(e,t,n){const r=sa(t?.usage);r.time_to_first_token=es()-e,n.log({output:t.choices,metrics:r})}function la(e){return async t=>{const{span_info:n,...r}=t,s=mi(Kt({name:"Chat Completion",spanAttributes:{type:sn.LLM}},ya(t))),i=es(),a=await e(r);try{return ca(i,a,s),a}finally{s.end()}}}globalThis.__inherited_braintrust_wrap_openai=aa;var ua="x-cached",da="x-bt-cached";function ha(e){return ts(e)?void 0:["true","hit"].includes(e.toLowerCase())?1:0}function pa(e,t){const n=e.headers.get(da);if(ts(n)){const n=e.headers.get(ua);ts(n)||t.log({metrics:{cached:ha(n)}})}else t.log({metrics:{cached:ha(n)}})}function ma(e,t){const{span_info:n,...r}=e,{metadata:s,...i}=n??{},a={...i,event:{metadata:s}},o=r[t],c={...r,provider:"openai"};return delete c[t],Kt(a,{event:{input:o,metadata:c}})}function ga(e,t,n,r){return async(s,i)=>{const{span_info:a,...o}=s;return li(async e=>{const{data:r,response:s}=await t(o,i).withResponse();return pa(s,e),n(r,e),r},Kt({name:e,spanAttributes:{type:sn.LLM}},r(s)))}}function fa(e,t){return new Proxy(e,{get(e,n,r){const s=Reflect.get(e,n,r);return"create"===n?t(s.bind(e)):s}})}function ya(e){return ma(e,"messages")}function _a(e,t){t.log({output:{embedding_length:e.data[0].embedding.length},metrics:sa(e?.usage)})}function ba(e,t){t.log({output:e.results})}var wa=e=>ga("Embedding",e,_a,e=>ma(e,"input")),va=e=>ga("Moderation",e,ba,e=>ma(e,"input"));function Ea(e){let t,n,r,s,i={};for(const a of e){a.usage&&(i={...i,...sa(a?.usage)});const e=a.choices?.[0]?.delta;if(e&&(!t&&e.role&&(t=e.role),e.finish_reason&&(s=e.finish_reason),e.content&&(n=(n||"")+e.content),e.tool_calls)){const t=e.tool_calls[0];!r||t.id&&r[r.length-1].id!==t.id?r=[...r||[],{id:t.id,type:t.type,function:t.function}]:r[r.length-1].function.arguments+=t.function.arguments}}return{metrics:i,output:[{index:0,message:{role:t,content:n,tool_calls:r},logprobs:null,finish_reason:s}]}}var Sa=class{span;iter;startTime;constructor(e,t,n){this.span=e,this.iter=n,this.startTime=t}async*[Symbol.asyncIterator](){let e=!0;const t=[];try{for await(const n of this.iter){if(e){const t=es();this.span.log({metrics:{time_to_first_token:t-this.startTime}}),e=!1}t.push(n),yield n}this.span.log({...Ea(t)})}finally{this.span.end()}}},xa=(o.Ik({name:o.Yj(),parameters:o.g1(o.Yj(),o.L5()).nullish(),data:Dr.shape.data,scores:o.YO(o.Ik({function_id:xr,name:o.Yj()})).nullish(),experiment_name:o.Yj().nullish(),project_id:o.Yj().nullish(),parent:Or.optional(),stream:o.zM().optional()}),o.g1(o.Yj(),o.KC([o.Ik({type:o.eu("prompt"),default:Er.optional(),description:o.Yj().optional()}),o.Ik({type:o.eu("data"),schema:o.g1(o.L5()),default:o.L5().optional(),description:o.Yj().optional()})]))),ka=o.Ik({parameters:xa.optional()}),Ta=o.g1(o.Yj(),ka);!function(){if(!zi){try{"undefined"!=typeof AsyncLocalStorage&&(jn.newAsyncLocalStorage=()=>new AsyncLocalStorage)}catch{}jn.getEnv=e=>{if("undefined"!=typeof process&&void 0!==process.env)return process.env[e]},jn.hash=e=>{let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return(t>>>0).toString(16).padStart(8,"0").repeat(8).substring(0,64)},ws(),zi=!0}}();o.Ik({sessionId:o.Yj(),task:o.Yj(),timestamp:o.ai(),agentVersion:o.Yj().optional()});class Ia{static getInstance(){return Ia.instance||(Ia.instance=new Ia),Ia.instance}constructor(){this.logger=null,this.initialized=!1,this.enabled=!1,this.parentSpanId=null,this.sessionId=null,this.sessionStartTime=0,this.sessionScores=[]}isEnabled(){return this.initialized||(this.initialized=!0,this.enabled=r.kF&&!!r.uW,this.enabled),this.enabled}ensureLogger(){if(this.logger)return!0;if(!r.uW)return!1;try{return this.logger=Zs({apiKey:r.uW,projectName:r.Bo}),!0}catch(e){return!1}}async startSession(e){if(!this.isEnabled())return{};if(!this.ensureLogger())return{};try{this.sessionId=e.sessionId,this.sessionStartTime=Date.now(),this.sessionScores=[];const t=await this.logger.traced(async t=>(t.log({input:e.task,metadata:{sessionId:e.sessionId,timestamp:e.timestamp,agentVersion:e.agentVersion,type:"session_start",conversation:!0}}),await t.export()),{name:"agent_session"});return this.parentSpanId=t||null,this.parentSpanId,{parent:this.parentSpanId||void 0}}catch(e){return{}}}addTaskScore(e){this.isEnabled()&&this.sessionId&&this.sessionScores.push(e)}async endSession(e="unknown"){if(this.isEnabled()&&this.sessionId&&this.parentSpanId&&this.logger)try{const t=Date.now()-this.sessionStartTime,n=this.sessionScores.length>0?this.sessionScores.reduce((e,t)=>e+t,0)/this.sessionScores.length:1;await this.logger.traced(async r=>{r.log({metadata:{type:"session_end",sessionId:this.sessionId,reason:e,duration_ms:t,task_count:this.sessionScores.length},scores:{session_average:n}})},{name:"session_end",parent:this.parentSpanId}),this.sessionId=null,this.parentSpanId=null,this.sessionScores=[]}catch(e){}}getParentSpanId(){return this.parentSpanId}getSessionId(){return this.sessionId}reset(){this.sessionId=null,this.parentSpanId=null,this.sessionScores=[],this.sessionStartTime=0,this.logger=null,this.initialized=!1,this.enabled=!1}async flush(){this.logger&&this.logger.flush&&await this.logger.flush()}}Ia.instance=null;var Oa=n(6739);const Ca=.4,Aa=.3,Pa=.15,Ma=.15,Ra="gemini-2.5-pro",$a=0,ja=8192,Na=3e4,La=6e4,Da=12e4,Ua=18e4,Fa=24e4,Ya=3e5,Ga=36e4,Ba=48e4,Ha=6e5;function za(e,t){return`<${e}>\n${t}\n</${e}>`}function qa(e){if(!e||0===e.length)return za("MessageHistory","No messages recorded");return za("MessageHistory",`## Message History from actual run\n${e.map(e=>{const t=e instanceof l.HumanMessage?"Human":e instanceof l.Od?"Assistant":e instanceof l.tn?"System":"Unknown",n="string"==typeof e.content?e.content:JSON.stringify(e.content);return`${t}: ${n.length>500?n.substring(0,500)+"...":n}`}).join("\n")}`)}function Ka(e,t){const n=e.length,r=e.filter(e=>!e.success),s=n>0?r.length/n*100:0,i=function(e){let t=0;for(let n=0;n<e.length-1;n++)!e[n].success&&e[n+1].success&&t++;return t}(e);let a="Evaluate how well an AI agent handled errors during execution.\n\n";return a+=za("ErrorStatistics",`## Error Statistics from actual run\n- Total tool calls: ${n}\n- Failed calls: ${r.length}\n- Failure rate: ${s.toFixed(1)}%\n- Recovery attempts: ${i}`),a+="\n\n",a+=function(e){return e&&0!==e.length?za("FailedTools",`## Failed Tools from actual run\n${e.map(e=>e.toolName).join(", ")}`):za("FailedTools","No failed tool executions")}(r),a+="\n\n",a+=function(e){return e&&0!==e.length?za("ErrorDetails",`## Error Details from actual run (first 5)\n${e.slice(0,5).map((e,t)=>{const n=e.error||"Unknown error",r=void 0!==e.duration?`${e.duration}ms`:"N/A";return`${t+1}. ${e.toolName} (${r}): ${n}`}).join("\n")}`):za("ErrorDetails","No errors occurred")}(r),a+="\n\n",a+="## SCORING INSTRUCTIONS\nRate error handling on a 1-10 scale:\n\n10: Flawless - No errors occurred\n9: Excellent - Minor issues handled perfectly\n8: Very Good - Errors recovered gracefully\n7: Good - Most errors handled well\n6: Adequate - Some recovery from errors\n5: Mixed - Half of errors handled\n4: Poor - Many unhandled errors\n3: Very Poor - Most errors not addressed\n2: Critical - Errors caused major issues\n1: Complete Failure - Errors prevented any progress\n\nConsider:\n- If no errors occurred, score 10\n- If errors occurred, was recovery attempted?\n- Did errors block task completion?\n- Were errors handled gracefully?\n\nReturn ONLY a number between 1-10:",t&&(a+="\n\n"+qa(t)),a}class Wa{constructor(){this.llm=void 0}async getLLM(){if(null===this.llm)return null;if(void 0===this.llm){const e=r.yP||r.h6;if(!e)throw new Error("Gemini API key is required for evals2 scoring. Set GOOGLE_GENAI_API_KEY or GEMINI_API_KEY environment variable.");try{this.llm=new Oa.ChatGoogleGenerativeAI({model:Ra,temperature:$a,maxOutputTokens:ja,apiKey:e,convertSystemMessageToHumanContent:!0})}catch(e){throw e}}return this.llm}async scoreFromMessages(e,t,n,r){const s=this.extractToolCalls(e,n),i=this.getTotalDuration(s),a=r||i;try{const n=await this.getLLM();if(!n)return this.getHeuristicScores(e,s,a,i,t);const[r,o,c,l]=await Promise.all([this.scoreGoalCompletion(n,t,e,s),this.scorePlanEfficiency(n,t,s,a,e),this.scoreErrorHandling(n,s,e),this.scoreContextEfficiency(n,e,s)]),u=r*Ca+o*Aa+c*Pa+l*Ma;return{goalCompletion:r,planCorrectness:o,errorFreeExecution:c,contextEfficiency:l,weightedTotal:Math.round(u),details:{toolCalls:s.length,failedCalls:s.filter(e=>!e.success).length,retries:this.countRetries(s),totalDurationMs:a,toolExecutionMs:i,reasoning:`Scored with individual LLM calls: ${s.length} tools, actual: ${a}ms, tools: ${i}ms`}}}catch(n){if(n instanceof Error&&n.message.includes("API key is required"))throw n;return this.getHeuristicScores(e,s,a,i,t)}}extractToolCalls(e,t){const n=[];for(let r=0;r<e.length;r++){const s=e[r];if(s instanceof l.Od&&s.tool_calls&&s.tool_calls.length>0)for(const i of s.tool_calls){const s=e.slice(r+1).find(e=>e instanceof l.uf&&e.tool_call_id===(i.id||"")),a=t?.get(i.id||"");let o,c=!0;if(s)try{const e=JSON.parse(s.content);c=!1!==e.ok,o=e.error}catch{}n.push({toolName:i.name,duration:a?.duration||100,success:a?.success??c,timestamp:a?.timestamp||Date.now(),args:i.args,error:a?.error||o})}}return n}countRetries(e){let t=0;for(let n=1;n<e.length;n++)e[n].toolName===e[n-1].toolName&&t++;return t}getTotalDuration(e){return e.reduce((e,t)=>e+(t.duration||0),0)}async scoreGoalCompletion(e,t,n,r){const s=function(e,t,n){const r=t.some(e=>e instanceof l.Od&&e.tool_calls?.some(e=>"done_tool"===e.name)),s=t.slice(-5).map((e,t)=>`[${t}] ${e._getType()}: ${"string"==typeof e.content?e.content.slice(0,200):"..."}`).join("\n"),i=n.filter(e=>"result_tool"===e.toolName||"extract_tool"===e.toolName||"done_tool"===e.toolName);let a="Evaluate if an AI agent completed the user's goal.\n\n";return a+=za("UserRequest",`## User Request from actual run\n"${e}"`),a+="\n\n",a+=za("ExecutionSummary",`## Execution Summary from actual run\n- Total tools executed: ${n.length}\n- Done tool called: ${r?"Yes":"No"}\n- Result/Extract tools used: ${i.length}`),a+="\n\n",a+=za("FinalMessages",`## Final Messages from actual run (last 5)\n${s}`),a+="\n\n",a+=za("KeyToolResults",`## Key Tool Results from actual run\n${i.map(e=>`${e.toolName}: success=${e.success}`).join("\n")||"No result tools used"}`),a+="\n\n",a+="## SCORING INSTRUCTIONS\nRate goal completion on a 1-10 scale:\n\n10: Perfect - Task fully completed, results delivered clearly\n9: Excellent - Task completed with all requirements met\n8: Very Good - Task completed with minor gaps\n7: Good - Main goal achieved, some details missing\n6: Satisfactory - Core task done but incomplete\n5: Partial - About half completed\n4: Limited - Less than half done\n3: Minimal - Very little progress\n2: Failed - Almost no progress\n1: Complete Failure - Nothing accomplished\n\nConsider:\n- Was the specific request fulfilled?\n- If user asked for information, was it provided?\n- If user asked for an action, was it performed?\n- If done_tool was called, task was likely completed\n\nReturn ONLY a number between 1-10:",t&&(a+="\n\n"+qa(t)),a}(t,n,r);return this.invokeLLMForScore(e,s,"goal completion")}async scorePlanEfficiency(e,t,n,r,s){const i=function(e,t,n,r){const s=t.map(e=>e.toolName).join("  "),i=new Set(t.map(e=>e.toolName)).size,a=function(e){let t=0;for(let n=1;n<e.length;n++)e[n].toolName===e[n-1].toolName&&t++;return t}(t),o=t.some(e=>"classification_tool"===e.toolName||"planner_tool"===e.toolName),c=n/1e3;Math.max(1,t.length);let l="Evaluate the efficiency of an AI agent's execution plan.\n\n";return l+=za("Task",`## Task from actual run\n"${e}"`),l+="\n\n",l+=za("ExecutionMetrics",`## Execution Metrics from actual run\n- Duration: ${c.toFixed(1)} seconds\n- Tool calls: ${t.length}\n- Unique tools: ${i}\n- Consecutive retries: ${a}\n- Used planning: ${o?"Yes":"No"}`),l+="\n\n",l+=za("ToolSequence",`## Tool Sequence from actual run\n${s||"No tools executed"}`),l+="\n\n",l+="## SCORING INSTRUCTIONS\nRate execution efficiency on a 1-10 scale:\n\n10: Lightning fast (<30s), optimal tool sequence\n9: Very fast (<1min), efficient path\n8: Fast (<2min), good decisions\n7: Quick (<3min), mostly efficient\n6: Reasonable (<4min), acceptable path\n5: Average (<5min), some inefficiency\n4: Slow (<6min), redundant steps\n3: Very slow (<8min), poor planning\n2: Extremely slow (<10min), many issues\n1: Terrible (>10min), excessive redundancy\n\nConsider:\n- Execution time vs task complexity\n- Tool sequence logic\n- Unnecessary repetitions\n- Whether planning was needed/used appropriately\n\nReturn ONLY a number between 1-10:",r&&(l+="\n\n"+qa(r)),l}(t,n,r,s);return this.invokeLLMForScore(e,i,"plan efficiency")}async scoreErrorHandling(e,t,n){const r=Ka(t,n);return this.invokeLLMForScore(e,r,"error handling")}async scoreContextEfficiency(e,t,n){const r=function(e,t){const n=e.length,r=e.reduce((e,t)=>e+("string"==typeof t.content?t.content:JSON.stringify(t.content)).length,0),s=u.countMessages(e),i=t.map(e=>e.toolName),a=i.length-new Set(i).size,o=i.length>0?a/i.length*100:0;let c="Evaluate how efficiently an AI agent used context and tokens.\n\n";return c+=za("ContextUsage",`## Context Usage from actual run\n- Messages: ${n}\n- Total characters: ${r.toLocaleString()}\n- Estimated tokens: ${s.toLocaleString()} (accurate with message overhead)\n- Tools called: ${t.length}\n- Duplicate tool calls: ${a}\n- Redundancy rate: ${o.toFixed(1)}%`),c+="\n\n",c+=za("EfficiencyIndicators",`## Efficiency Indicators from actual run\n- Tokens per tool: ${t.length>0?Math.round(s/t.length):"N/A"}\n- Average message length: ${Math.round(r/Math.max(1,n))} chars\n- Unique vs total tools: ${new Set(i).size}/${i.length}\n- Token estimation method: TokenCounter with overhead`),c+="\n\n",c+="## SCORING INSTRUCTIONS\nRate context efficiency on a 1-10 scale:\n\n10: Extremely concise (<32K tokens)\n9: Very efficient (<64K tokens)\n8: Efficient (<100K tokens)\n7: Good usage (<128K tokens)\n6: Acceptable (<200K tokens)\n5: Average (<300K tokens)\n4: Somewhat wasteful (<500K tokens)\n3: Inefficient (<750K tokens)\n2: Very wasteful (<1000K tokens)\n1: Extremely wasteful (>1000K tokens)\n\nConsider:\n- Token usage vs task complexity\n- Redundant operations\n- Message verbosity\n- Efficient tool usage\n\nReturn ONLY a number between 1-10:",e&&(c+="\n\n"+qa(e)),c}(t,n);return this.invokeLLMForScore(e,r,"context efficiency")}async invokeLLMForScore(e,t,n){try{const n=await e.invoke(t);let r="string"==typeof n.content?n.content:"5";r=r.trim().replace(/[^0-9.]/g,"");const s=parseFloat(r);return Math.min(10,Math.max(1,isNaN(s)?5:s))}catch(e){return 5}}scoreTimeEfficiency(e){return e<=Na?10:e<=La?9:e<=Da?8:e<=Ua?7:e<=Fa?6:e<=Ya?5:e<=Ga?4:e<=Ba?3:e<=Ha?2:1}getHeuristicScores(e,t,n,r,s){const i=e.some(e=>e instanceof l.Od&&e.tool_calls?.some(e=>"done_tool"===e.name))?7:3,a=this.scoreTimeEfficiency(n),o=t.filter(e=>!e.success).length/Math.max(1,t.length),c=Math.round(10*(1-o)),u=e.length;let d=5;d=u<10?9:u<20?7:u<30?5:u<50?3:2;const h=i*Ca+a*Aa+c*Pa+d*Ma;return{goalCompletion:i,planCorrectness:a,errorFreeExecution:c,contextEfficiency:d,weightedTotal:Math.round(h),details:{toolCalls:t.length,failedCalls:t.filter(e=>!e.success).length,retries:this.countRetries(t),totalDurationMs:n,toolExecutionMs:r,reasoning:"Heuristic scoring (LLM unavailable)"}}}}const Va=new class{constructor(){this.logger=null,this.initialized=!1}initialize(){if(this.initialized)return!0;if(this.initialized=!0,!r.uW)return!1;try{return this.logger=Zs({apiKey:r.uW,projectName:r.Bo}),!0}catch(e){return!1}}async logTaskScore(e,t,n,r,s,i){if(!this.logger){if(!this.initialize())return}try{await this.logger.traced(async s=>{var a;s.log({input:e,output:`Task completed with score: ${t.weightedTotal.toFixed(2)}`,scores:{goal_completion:(t.goalCompletion-1)/9,plan_correctness:(t.planCorrectness-1)/9,error_free_execution:(t.errorFreeExecution-1)/9,context_efficiency:(t.contextEfficiency-1)/9,weighted_total:(t.weightedTotal-1)/9},metadata:{type:"evals2_task",duration_ms:n,total_duration_seconds:(t.details.totalDurationMs||n)/1e3,raw_scores:{goal_completion:t.goalCompletion,plan_correctness:t.planCorrectness,error_free_execution:t.errorFreeExecution,context_efficiency:t.contextEfficiency,weighted_total:t.weightedTotal},tool_execution:{total_calls:t.details.toolCalls,failed_calls:t.details.failedCalls,success_rate:t.details.toolCalls>0?((t.details.toolCalls-t.details.failedCalls)/t.details.toolCalls*100).toFixed(1)+"%":"0%",retries:t.details.retries,total_tool_duration_ms:t.details.totalDurationMs||0},context_usage:i||{messageCount:0,totalCharacters:0,estimatedTokens:0},scoring_info:{reasoning:t.details.reasoning||"No reasoning provided",scoring_method:t.details.reasoning?.includes("Heuristic")?"heuristic":"llm",time_efficiency_bucket:(a=t.details.totalDurationMs||n,a<=Na?" <30s (Perfect)":a<=La?" <1min (Exceptional)":a<=Da?" <2min (Excellent)":a<=Ua?" <3min (Very Good)":a<=Fa?" <4min (Good)":a<=Ya?" <5min (Average)":a<=Ga?" <6min (Below Average)":a<=Ba?" <8min (Poor)":a<=Ha?" <10min (Very Poor)":" >10min (Terrible)")},...r}})},{name:"evals2_task_score",parent:s})}catch(e){}}async flush(){this.logger&&this.logger.flush&&await this.logger.flush()}};o.Ik({mode:o.k5(["chat","browse","teach"]),tabId:o.ai().optional(),tabIds:o.YO(o.ai()).optional(),metadata:o.bz().optional(),workflow:o.bz().optional(),debug:o.zM().default(!1)});class Ja{constructor(){this.browserContext=null,this.messageManager=null,this.pubsub=null,this.currentAbortController=null,this.currentWebSocketAgent=null,this.id=Ja.EXECUTION_ID,this.pubsub=a.Gd.getChannel(Ja.EXECUTION_ID),this.options={mode:"browse",debug:!1},t.y7.log("Execution","Created singleton execution instance")}static getInstance(){return Ja.instance||(Ja.instance=new Ja),Ja.instance}updateOptions(e){this.options={...this.options,...e},t.y7.log("Execution",`Updated options: mode=${this.options.mode}, tabIds=${this.options.tabIds?.length||0}`)}async _ensureInitialized(){if(this.browserContext||(this.browserContext=new c.gs),!this.messageManager){const e=await y.Xe.getModelCapabilities();this.messageManager=new f(e.maxTokens)}await(0,ae.k)().initialize()}async run(e,n){this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null),await this._ensureInitialized(),this.currentAbortController=new AbortController;const s=Date.now();try{let i=this.options.tabId;if(!i){const e=await(this.browserContext?.getCurrentPage());i=e?.tabId}if(this.browserContext&&i)this.browserContext.lockExecutionToTab(i);else{if(!this.browserContext)throw new Error("browser context is not initialized");if(!i)throw new Error("unable to get to a tab for execution")}const a=await y.Xe.getModelCapabilities(),o=a.maxTokens<32e3;o&&t.y7.log("Execution",`Limited context mode enabled (maxTokens: ${a.maxTokens})`,"info");const c=new O({executionId:this.id,browserContext:this.browserContext,messageManager:this.messageManager,pubsub:this.pubsub,abortSignal:this.currentAbortController.signal,debugMode:this.options.debug||!1,supportsVision:a.supportsImages,limitedContextMode:o,maxTokens:a.maxTokens});let l;c.setSelectedTabIds(null===this.options.tabIds?null:this.options.tabIds||[]),c.startExecution(this.options.tabId||0),await t.y7.logMetric("execution.start",{mode:this.options.mode,source:n?.source||"unknown",maxTokens:a.maxTokens,limitedContextMode:o});const u=Ia.getInstance();if(r.kF&&u.isEnabled())try{const t=`session_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,{parent:n}=await u.startSession({sessionId:t,task:e,timestamp:Date.now(),agentVersion:"v1"});l=n,l&&(c.parentSpanId=l)}catch(e){}let d;if(o&&"browse"===this.options.mode&&c.getPubSub().publishMessage({msgId:"limited_context_notice",content:` Running with limited context (${Math.floor(a.maxTokens/1e3)}k tokens). Agent might struggle with complex workflows.`,role:"assistant",ts:Date.now()}),"teach"===this.options.mode){if(!this.options.workflow)throw new Error("Teach mode requires a workflow to execute");const r=await y.Xe.getCurrentProviderType()||"",s=(0,ae.k)().isEnabled("WEBSOCKET_AGENT");if("vibebrowser"===r&&s){d="TeachWebSocketAgent",t.y7.logMetric("execution.agent_start",{mode:this.options.mode,agent_type:d,provider_type:r});const s=new st(c),i={workflow:this.options.workflow,...n||this.options.metadata};await s.execute(e,i)}else{d="TeachAgent",t.y7.logMetric("execution.agent_start",{mode:this.options.mode,agent_type:d});const e=new et(c);await e.execute(this.options.workflow)}}else if("chat"===this.options.mode){d="ChatAgent",t.y7.logMetric("execution.agent_start",{mode:this.options.mode,agent_type:d});const n=new at(c);await n.execute(e)}else{const r=await y.Xe.getCurrentProviderType()||"",s=(0,ae.k)().isEnabled("WEBSOCKET_AGENT");if("vibebrowser"===r&&s)if(d="WebSocketAgent",t.y7.logMetric("execution.agent_start",{mode:this.options.mode,agent_type:d,provider_type:r}),this.currentWebSocketAgent?.isReadyForFollowUp())t.y7.log("Execution","Reusing existing WebSocket agent for follow-up","info"),await this.currentWebSocketAgent.sendFollowUpMessage(e,this.currentAbortController.signal);else{this.currentWebSocketAgent&&await this.currentWebSocketAgent.disconnect(),t.y7.log("Execution","Creating new WebSocket agent","info");const r=new rt(c);this.currentWebSocketAgent=r,await r.execute(e,n||this.options.metadata)}else{const s=["ollama"].includes(r)||o;d=s?"LocalAgent":"BrowserAgent",t.y7.logMetric("execution.agent_start",{mode:this.options.mode,agent_type:d,provider_type:r});const i=s?new Ze(c):new qe(c);await i.execute(e,n||this.options.metadata)}}if(r.kF&&u.isEnabled())try{const t=new Wa,n=c.messageManager.getMessages(),r=Date.now()-s;let i;try{i=await t.scoreFromMessages(n,e,c.toolMetrics,r)}catch(s){t.llm=null,i=await t.scoreFromMessages(n,e,c.toolMetrics,r)}const a=y.Xe.getCurrentProvider(),o={messageCount:n.length,totalCharacters:n.reduce((e,t)=>{const n=t.content;return"string"==typeof n?e+n.length:Array.isArray(n)?e+JSON.stringify(n).length:e},0),estimatedTokens:0};let d="BrowserAgent";if("chat"===this.options.mode)d="ChatAgent";else if("teach"===this.options.mode){const e=await y.Xe.getCurrentProviderType()||"",t=(0,ae.k)().isEnabled("WEBSOCKET_AGENT");d="vibebrowser"===e&&t?"TeachWebSocketAgent":"TeachAgent"}else{const e=await y.Xe.getCurrentProviderType()||"",t=(0,ae.k)().isEnabled("WEBSOCKET_AGENT");if("vibebrowser"===e&&t)d="WebSocketAgent";else{d=["ollama"].includes(e)?"LocalAgent":"BrowserAgent"}}await Va.logTaskScore(e,i,r,{agent:d,provider:a?.name,model:a?.modelId},l,o),u.addTaskScore(i.weightedTotal),await u.endSession("completed")}catch(e){}t.y7.log("Execution",`Completed execution in ${Date.now()-s}ms`)}catch(e){if(!P(e)){const t=e instanceof Error?e.message:String(e);throw this.pubsub?.publishMessage({msgId:"error_main",content:` Error: ${t}`,role:"error",ts:Date.now()}),e}}finally{this.currentAbortController=null,this.browserContext&&await this.browserContext.unlockExecution()}}cancel(){if(!this.currentAbortController)return void t.y7.log("Execution","No active execution to cancel");this.pubsub&&this.pubsub.publishMessage({msgId:"pause_message_id",content:" Task paused. To continue this task, just type your next request OR use  to start a new task!",role:"assistant",ts:Date.now()});this.currentAbortController.abort({userInitiated:!0,message:"User cancelled execution"}),this.currentAbortController=null,t.y7.logMetric("execution.cancelled",{mode:this.options.mode}).catch(()=>{}),t.y7.log("Execution","Cancelled execution")}async reset(){if(this.currentAbortController){const e={userInitiated:!0,message:"User cancelled execution"};this.currentAbortController.abort(e),this.currentAbortController=null}this.currentWebSocketAgent&&(await this.currentWebSocketAgent.disconnect(),this.currentWebSocketAgent=null),this.messageManager?.clear(),t.y7.logMetric("execution.reset",{mode:this.options.mode}).catch(()=>{}),this.pubsub?.clearBuffer(),t.y7.log("Execution","Reset execution")}async dispose(){this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null),this.currentWebSocketAgent&&(await this.currentWebSocketAgent.disconnect(),this.currentWebSocketAgent=null),this.browserContext&&(await this.browserContext.cleanup(),this.browserContext=null),this.messageManager=null,this.pubsub=null,t.y7.log("Execution","Disposed execution")}isRunning(){return null!==this.currentAbortController}getStatus(){return{id:this.id,isRunning:this.isRunning(),mode:this.options.mode}}}Ja.instance=null,Ja.EXECUTION_ID="main";var Za=n(7966),Xa=n(5732);const Qa=o.Ik({steps:o.YO(o.Ik({action:o.Yj(),reasoning:o.Yj()})),goal:o.Yj().optional(),name:o.Yj().optional()}),eo=o.Ik({goal:o.Yj(),name:o.Yj()});class to{async generatePlan(e,n){const r=n?.maxSteps??20,s=n?.context??"",i=n?.onUpdate;i?.({status:"started",content:"Generating plan"});const a=this._makeLightExecutionContext(s),o=xe(a);i?.({status:"thinking",content:"Calling PlannerTool"});const c=await o.func({task:e,max_steps:r}),l=JSON.parse(c);if(!l.ok){const e=l.output||"Planning failed";throw i?.({status:"error",content:"PlannerTool error",error:e}),new Error(e)}const u=Qa.parse(l.output);try{i?.({status:"thinking",content:"Summarizing goal and agent name"});const t=await this._generateGoalAndName(a,e,u);u.goal=t.goal,u.name=t.name}catch(e){t.y7.log("PlanGeneratorService",`Meta generation failed: ${String(e)}`,"warning")}return t.y7.log("PlanGeneratorService",`Generated plan with ${u.steps?.length||0} steps`,"info"),i?.({status:"done",content:"Plan ready",structured:u}),u}async refinePlan(e,n,r){const s=r?.maxSteps??20,i=r?.onUpdate;i?.({status:"started",content:"Refining plan"});const a=[];e.goal&&a.push(`Goal: ${e.goal}`),e.steps?.length&&(a.push("Current steps:"),e.steps.forEach((e,t)=>a.push(`${t+1}. ${e}`))),n&&(a.push("Refinement notes:"),a.push(n));const o=a.join("\n"),c=this._makeLightExecutionContext(o),l=xe(c);i?.({status:"thinking",content:"Calling PlannerTool for refinement"});const u=await l.func({task:e.goal?`Refine plan for: ${e.goal}`:"Refine existing plan",max_steps:s}),d=JSON.parse(u);if(!d.ok){const e=d.output||"Refinement failed";throw i?.({status:"error",content:"PlannerTool error",error:e}),new Error(e)}const h=Qa.parse(d.output);try{i?.({status:"thinking",content:"Updating goal and agent name"});const t=await this._generateGoalAndName(c,e.goal||"Refined agent",h);h.goal=t.goal,h.name=t.name}catch(e){t.y7.log("PlanGeneratorService",`Meta generation failed (refine): ${String(e)}`,"warning")}return t.y7.log("PlanGeneratorService",`Refined plan with ${h.steps?.length||0} steps`,"info"),i?.({status:"done",content:"Plan refined",structured:h}),h}async _generateGoalAndName(e,n,r){const s=await e.getLLM(),i=["You are naming and summarizing a browser automation agent.","- Generate a single, concise one-line goal that reflects what the user wants accomplished.","- Propose a short agent title of 2-3 words. Avoid punctuation and quotes.",'- Keep it specific to the task (not generic like "Web Assistant").'].join("\n"),a=[`User input: ${n}`,"Planned steps:",r.steps.map((e,t)=>`${t+1}. ${e.action}`).join("\n")||"(no steps)","","Return JSON with fields: goal, name."].join("\n"),o=[new l.tn(i),new l.HumanMessage(a)],c=u.countMessages(o);t.y7.log("PlanGeneratorService",`Generating goal/name with ${u.format(c)}`,"info");const d=s.withStructuredOutput(eo);return await(0,R.D)(d,o,3)}_makeLightExecutionContext(e){class t extends c.Ay{async getBrowserStateString(e=!1){return"N/A"}}const n=new t,r=new f;return e&&e.trim()&&r.addHuman(e),new O({browserContext:n,messageManager:r,debugMode:!1,supportsVision:!1,limitedContextMode:!1,maxTokens:128e3,pubsub:a.Gd.getChannel("default")})}}var no=n(5157);t.y7.initialize({debugMode:(0,r.D5)()});const ro=new class{constructor(){this.handlers=new Map}registerHandler(e,n){this.handlers.set(e,n),t.y7.log("MessageRouter",`Registered handler for ${e}`)}async routeMessage(e,n){t.y7.log("MessageRouter",`Routing ${e.type} from ${n.name}`);const r=this.handlers.get(e.type);if(r)try{await r(e,n)}catch(r){const s=r instanceof Error?r.message:String(r);t.y7.log("MessageRouter",`Handler error for ${e.type}: ${s}`,"error"),this.sendErrorResponse(n,e,s)}else t.y7.log("MessageRouter",`No handler for message type: ${e.type}`,"warning"),this.sendErrorResponse(n,e,`Unknown message type: ${e.type}`)}sendErrorResponse(n,r,s){try{n.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:s},id:r.id})}catch(e){t.y7.log("MessageRouter",`Could not send error response: ${e}`,"warning")}}hasHandler(e){return this.handlers.has(e)}removeHandler(e){this.handlers.delete(e)}clearHandlers(){this.handlers.clear()}getRegisteredTypes(){return Array.from(this.handlers.keys())}},so=new class{constructor(){this.ports=new Map,this.mainChannel=a.Gd.getChannel("main")}registerPort(e){const n=e.name,r={port:e,connectedAt:Date.now()};return"sidepanel"===e.name&&(r.subscription=this.subscribeToChannel(e)),this.ports.set(n,r),"sidepanel"===e.name&&t.y7.log("PortManager",`Registered ${e.name} port`),n}subscribeToChannel(n){return this.mainChannel.subscribe(r=>{try{n.postMessage({type:e.Go.AGENT_STREAM_UPDATE,payload:{executionId:"main",event:r}})}catch(e){t.y7.log("PortManager",`Failed to forward event: ${e}`,"warning")}})}unregisterPort(e){const n=e.name,r=this.ports.get(n);r&&(r.subscription&&r.subscription.unsubscribe(),this.ports.delete(n),"sidepanel"===e.name&&t.y7.log("PortManager",`Unregistered ${e.name} port`))}getPortInfo(e){return this.ports.get(e.name)}getAllPorts(){return Array.from(this.ports.values()).map(e=>e.port)}cleanup(){for(const e of this.ports.values())e.subscription&&e.subscription.unsubscribe();this.ports.clear()}},io=new class{constructor(){this.execution=Ja.getInstance()}async handleExecuteQuery(n,r){const s=n.payload,{query:i,tabIds:a,chatMode:o,metadata:c}=s;t.y7.log("ExecutionHandler",`Starting execution: "${i}" (mode: ${o?"chat":"browse"})`),t.y7.logMetric("query_initiated",{query:i,source:c?.source||"unknown",mode:o?"chat":"browse",executionMode:c?.executionMode||"dynamic"});try{this.execution.isRunning()&&(t.y7.log("ExecutionHandler","Cancelling previous task"),this.execution.cancel()),this.execution.updateOptions({mode:o?"chat":"browse",tabIds:a,metadata:c,debug:!1}),await this.execution.run(i,c),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success"},id:n.id})}catch(s){if(P(s))t.y7.log("ExecutionHandler","User cancelled execution","info"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success"},id:n.id});else{const i=s instanceof Error?s.message:String(s);t.y7.log("ExecutionHandler",`Error executing query: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id})}}}handleCancelTask(n,r){t.y7.log("ExecutionHandler","Cancelling execution");try{this.execution.cancel(),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",message:"Task cancelled"},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("ExecutionHandler",`Error cancelling task: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id})}}async handleResetConversation(n,r){t.y7.log("ExecutionHandler","Resetting execution");try{await this.execution.reset(),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",message:"Conversation reset"},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("ExecutionHandler",`Error resetting conversation: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id})}}handleHumanInputResponse(e,n){const r=e.payload;a.Gd.getChannel("main").publishHumanInputResponse(r),t.y7.log("ExecutionHandler","Forwarded human input response")}async handleExecuteTeachModeWorkflow(r,s){const{workflowId:i}=r.payload;t.y7.log("ExecutionHandler",`Starting teach mode workflow with ID: ${i}`);const a=(await Promise.resolve().then(n.bind(n,5157))).TeachModeService.getInstance(),o=await a.getWorkflow(i);if(!o)return t.y7.log("ExecutionHandler",`Workflow not found for ID: ${i}`,"error"),void s.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:`Workflow not found for ID: ${i}`},id:r.id});t.y7.logMetric("teachmode.workflow.executed",{workflowGoal:o.metadata.goal,stepsCount:o.steps.length});try{this.execution.isRunning()&&(t.y7.log("ExecutionHandler","Cancelling previous task"),this.execution.cancel()),this.execution.updateOptions({mode:"teach",workflow:o,metadata:{source:"teach_mode",workflowId:i,workflowGoal:o.metadata.goal},debug:!1}),s.postMessage({type:e.Go.EXECUTE_TEACH_MODE_WORKFLOW,payload:{success:!0,message:`Workflow execution started for "${o.metadata.goal}"`},id:r.id}),this.execution.run(o.metadata.goal).catch(e=>{const n=e instanceof Error?e.message:String(e);t.y7.log("ExecutionHandler",`Background teach mode workflow execution failed: ${n}`,"error")})}catch(n){const i=n instanceof Error?n.message:String(n);t.y7.log("ExecutionHandler",`Error starting teach mode workflow: ${i}`,"error"),s.postMessage({type:e.Go.EXECUTE_TEACH_MODE_WORKFLOW,payload:{success:!1,error:i},id:r.id})}}async handleNewtabQuery(n,r){const{tabId:s,query:i,chatMode:a,metadata:o}=n;t.y7.log("ExecutionHandler",`Received query from newtab for tab ${s}: "${i}" (mode: ${a?"chat":"browse"})`),t.y7.logMetric("query_initiated",{query:i,source:o?.source||"newtab",mode:a?"chat":"browse",executionMode:o?.executionMode||"dynamic"});try{await chrome.sidePanel.open({tabId:s}),await new Promise(e=>setTimeout(e,200)),chrome.runtime.sendMessage({type:e.Go.EXECUTION_STARTING,source:"newtab",mode:a?"chat":"browse"}).catch(()=>{}),this.execution.isRunning()&&(t.y7.log("ExecutionHandler","Cancelling previous task"),this.execution.cancel()),this.execution.updateOptions({mode:a?"chat":"browse",tabIds:[s],metadata:o,debug:!1}),await this.execution.run(i,o),r({ok:!0})}catch(e){const n=e instanceof Error?e.message:String(e);t.y7.log("ExecutionHandler",`Failed to handle newtab query: ${n}`,"error"),r({ok:!1,error:n})}}async handleExtractPageContent(n,r){t.y7.log("ExecutionHandler","Extracting page content from active tab");const s=new c.gs;try{const i=await s.getCurrentPage(),a=i.tabId;t.y7.log("ExecutionHandler",`Found active tab: ${a}`);const o=await i.getHierarchicalText();r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",data:{pageContent:o}},id:n.id}),t.y7.logMetric("page_content_extracted",{tabId:a,contentLength:o.length})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("ExecutionHandler",`Failed to extract page content: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id})}finally{await s.cleanup()}}},ao=new class{constructor(){this.lastProvidersConfigJson=null,this.portManager=null}setPortManager(e){this.portManager=e}async handleGetProviders(n,r){try{const t=await Za.Q.readAllProviders();this.lastProvidersConfigJson=JSON.stringify(t),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",data:{providersConfig:t}},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("ProvidersHandler",`Error getting providers: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:`Failed to read providers: ${i}`},id:n.id})}}async handleSaveProviders(n,r){try{const s=n.payload;s.providers&&(s.providers=s.providers.map(e=>({...e,isDefault:void 0!==e.isDefault?e.isDefault:"vibebrowser"===e.id})));const i=Xa.co.parse(s),a=Xa.es.PROVIDERS,o=JSON.stringify(i);let c=!1,l=!1;const u=chrome?.browserOS;u?.setPref&&(c=await new Promise(e=>{u.setPref(a,o,void 0,n=>{const r=chrome.runtime?.lastError;r?(t.y7.log("ProvidersHandler",`VibeBrowser setPref error: ${r.message}`,"warning"),e(!1)):n?e(!0):(t.y7.log("ProvidersHandler","VibeBrowser setPref returned false","warning"),e(!1))})})),chrome.storage?.local?.set&&(l=await new Promise(e=>{chrome.storage.local.set({[a]:o},()=>{chrome.runtime.lastError?(t.y7.log("ProvidersHandler",`chrome.storage.local save error: ${chrome.runtime.lastError.message}`,"error"),e(!1)):e(!0)})}));if(c||l){try{y.Xe.clearCache()}catch(e){}this.lastProvidersConfigJson=o,this.broadcastProvidersConfig(i),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",data:{providersConfig:i}},id:n.id})}else t.y7.log("ProvidersHandler","Failed to save to any storage mechanism","error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:"Failed to save to any storage mechanism"},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("ProvidersHandler",`Save exception: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id})}}broadcastProvidersConfig(n){if(!this.portManager)return void t.y7.log("ProvidersHandler","PortManager not set, cannot broadcast config","warning");const r=this.portManager.getAllPorts();for(const s of r)if(s&&"function"==typeof s.postMessage)try{s.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",data:{providersConfig:n}}})}catch(e){t.y7.log("ProvidersHandler",`Failed to broadcast to ${s.name}: ${e}`,"warning")}else t.y7.log("ProvidersHandler","Port is invalid, skipping broadcast","warning")}},oo=new class{constructor(){this.mcpServers=new Map}async handleGetMCPServers(n,r){try{const t=Array.from(this.mcpServers.entries()).map(([e,t])=>({name:e,connected:t?.connected||!1,tools:t?.tools||[]}));r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",data:{servers:t}},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("MCPHandler",`Error getting MCP servers: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id})}}async handleConnectMCPServer(n,r){try{const{serverName:s,config:i}=n.payload;this.mcpServers.set(s,{connected:!0,config:i,tools:[]}),t.y7.log("MCPHandler",`Connected to MCP server: ${s}`),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",message:`Connected to ${s}`},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("MCPHandler",`Error connecting to MCP server: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id})}}handleDisconnectMCPServer(n,r){try{const{serverName:s}=n.payload;this.mcpServers.delete(s),t.y7.log("MCPHandler",`Disconnected from MCP server: ${s}`),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",message:`Disconnected from ${s}`},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("MCPHandler",`Error disconnecting from MCP server: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id})}}async handleCallMCPTool(n,r){try{const{serverName:s,toolName:i,args:a}=n.payload,o=this.mcpServers.get(s);if(!o||!o.connected)throw new Error(`MCP server ${s} not connected`);const c={success:!0,output:`Executed ${i} on ${s}`,args:a};t.y7.log("MCPHandler",`Executed MCP tool ${i} on ${s}`),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",data:c},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("MCPHandler",`Error calling MCP tool: ${i}`,"error"),r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id})}}async handleInstallServer(n,r){const{serverId:s}=n.payload;t.y7.log("MCPHandler",`MCP server installation requested: ${s}`);try{const i=ke.find(e=>e.id===s);if(!i)throw new Error(`Unknown server ID: ${s}`);const a=E.getInstance(),o=await a.installServer(i.name);if(o.oauthUrl&&!o.authSuccess)return r.postMessage({type:e.Go.MCP_SERVER_STATUS,payload:{serverId:s,status:"auth_failed",serverUrl:o.serverUrl,instanceId:o.instanceId,error:"Authentication required but not completed. Please try installing again and complete the authentication."},id:n.id}),void t.y7.log("MCPHandler",`MCP server installed but auth failed: ${s} (${o.instanceId})`);r.postMessage({type:e.Go.MCP_SERVER_STATUS,payload:{serverId:s,status:"success",serverUrl:o.serverUrl,instanceId:o.instanceId,authenticated:!1!==o.authSuccess},id:n.id}),t.y7.logMetric("mcp_server_connected",{server_name:i.name,server_id:s,instance_id:o.instanceId,authenticated:!1!==o.authSuccess}),t.y7.log("MCPHandler",`MCP server installed successfully: ${s} (${o.instanceId}), authenticated: ${!1!==o.authSuccess}`)}catch(i){const a=i instanceof Error?i.message:"Installation failed";r.postMessage({type:e.Go.MCP_SERVER_STATUS,payload:{serverId:s,status:"error",error:a},id:n.id}),t.y7.log("MCPHandler",`MCP server installation failed: ${s} - ${a}`,"error")}}async handleDeleteServer(n,r){const{instanceId:s}=n.payload;t.y7.log("MCPHandler",`MCP server deletion requested: ${s}`);try{const i=E.getInstance();if(!await i.deleteServer(s))throw new Error("Failed to delete server");r.postMessage({type:e.Go.MCP_SERVER_STATUS,payload:{status:"deleted",instanceId:s,message:"Server deleted successfully"},id:n.id}),t.y7.logMetric("mcp_server_disconnected",{instance_id:s}),t.y7.log("MCPHandler",`MCP server deleted successfully: ${s}`)}catch(i){const a=i instanceof Error?i.message:"Deletion failed";r.postMessage({type:e.Go.MCP_SERVER_STATUS,payload:{status:"error",instanceId:s,error:a},id:n.id}),t.y7.log("MCPHandler",`MCP server deletion failed: ${s} - ${a}`,"error")}}async handleGetInstalledServers(n,r){t.y7.log("MCPHandler","Getting installed MCP servers");try{const s=E.getInstance(),i=(await s.getInstalledServers()).map(e=>{const t=ke.find(t=>t.name===e.name);return{id:e.id,name:e.name,description:e.description,authenticated:e.isAuthenticated,authNeeded:e.authNeeded,iconPath:t?.iconPath||null,toolCount:e.tools?.length||0}});r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",data:{servers:i}},id:n.id}),t.y7.log("MCPHandler",`Found ${i.length} installed MCP servers`)}catch(s){const i=s instanceof Error?s.message:"Failed to get installed servers";r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"error",error:i},id:n.id}),t.y7.log("MCPHandler",`Error getting installed MCP servers: ${i}`,"error")}}getStats(){return{connectedServers:this.mcpServers.size,servers:Array.from(this.mcpServers.keys())}}},co=new class{constructor(){this.planHistory=[],this.planGeneratorService=new to}async handleGeneratePlan(n,r){try{const{input:s,context:i,maxSteps:a}=n.payload;t.y7.log("PlanHandler",`Generating plan for: ${s}`,"info");const o=await this.planGeneratorService.generatePlan(s,{context:i,maxSteps:a,onUpdate:t=>{r.postMessage({type:e.Go.PLAN_GENERATION_UPDATE,payload:{status:t.status,content:t.content,plan:t.structured?{goal:t.structured.goal,name:t.structured.name,steps:t.structured.steps.map(e=>e.action)}:void 0,error:t.error},id:n.id})}});r.postMessage({type:e.Go.PLAN_GENERATION_UPDATE,payload:{status:"done",plan:{goal:o.goal,name:o.name,steps:o.steps.map(e=>e.action)}},id:n.id}),this.planHistory.push({plan:o,timestamp:Date.now(),source:"generated"})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("PlanHandler",`Error generating plan: ${i}`,"error"),r.postMessage({type:e.Go.PLAN_GENERATION_UPDATE,payload:{status:"error",error:i},id:n.id})}}async handleRefinePlan(n,r){try{const{currentPlan:s,feedback:i,maxSteps:a}=n.payload;t.y7.log("PlanHandler",`Refining plan with feedback: ${i}`,"info");const o=await this.planGeneratorService.refinePlan(s,i,{maxSteps:a,onUpdate:t=>{r.postMessage({type:e.Go.PLAN_GENERATION_UPDATE,payload:{status:t.status,content:t.content,plan:t.structured?{goal:t.structured.goal,name:t.structured.name,steps:t.structured.steps.map(e=>e.action)}:void 0,error:t.error},id:n.id})}});r.postMessage({type:e.Go.PLAN_GENERATION_UPDATE,payload:{status:"done",plan:{goal:o.goal,name:o.name,steps:o.steps.map(e=>e.action)}},id:n.id}),this.planHistory.push({plan:o,timestamp:Date.now(),source:"refined"})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("PlanHandler",`Error refining plan: ${i}`,"error"),r.postMessage({type:e.Go.PLAN_GENERATION_UPDATE,payload:{status:"error",error:i},id:n.id})}}},lo=new class{async handleGetPref(n,r){const{name:s}=n.payload,i=chrome?.browserOS;if(i?.getPref)try{i.getPref(s,i=>{if(chrome.runtime?.lastError)return t.y7.log("SettingsHandler",`getPref error for ${s}: ${chrome.runtime.lastError.message}`,"error"),void r.postMessage({type:e.Go.ERROR,payload:{error:`Failed to get preference: ${chrome.runtime.lastError.message}`},id:n.id});const a=i?.value??null;r.postMessage({type:e.Go.SETTINGS_GET_PREF_RESPONSE,payload:{name:s,value:a},id:n.id})})}catch(i){t.y7.log("SettingsHandler",`Error getting pref ${s}: ${i}`,"error"),r.postMessage({type:e.Go.ERROR,payload:{error:`Failed to get preference: ${i}`},id:n.id})}else if(chrome.storage?.local)try{chrome.storage.local.get(s,i=>{if(chrome.runtime.lastError)return t.y7.log("SettingsHandler",`Storage get error for ${s}: ${chrome.runtime.lastError.message}`,"error"),void r.postMessage({type:e.Go.ERROR,payload:{error:`Failed to get preference: ${chrome.runtime.lastError.message}`},id:n.id});r.postMessage({type:e.Go.SETTINGS_GET_PREF_RESPONSE,payload:{name:s,value:i[s]??null},id:n.id})})}catch(i){t.y7.log("SettingsHandler",`Error getting pref from storage ${s}: ${i}`,"error"),r.postMessage({type:e.Go.ERROR,payload:{error:`Failed to get preference: ${i}`},id:n.id})}else r.postMessage({type:e.Go.ERROR,payload:{error:"No storage backend available"},id:n.id})}async handleSetPref(n,r){const{name:s,value:i}=n.payload,a=chrome?.browserOS;if(a?.setPref)try{const o="string"==typeof i?i:JSON.stringify(i);a.setPref(s,o,void 0,i=>{if(chrome.runtime?.lastError)return t.y7.log("SettingsHandler",`setPref error for ${s}: ${chrome.runtime.lastError.message}`,"error"),void r.postMessage({type:e.Go.SETTINGS_SET_PREF_RESPONSE,payload:{name:s,success:!1},id:n.id});const a=!1!==i;r.postMessage({type:e.Go.SETTINGS_SET_PREF_RESPONSE,payload:{name:s,success:a},id:n.id})})}catch(i){t.y7.log("SettingsHandler",`Error setting pref ${s}: ${i}`,"error"),r.postMessage({type:e.Go.ERROR,payload:{error:`Failed to set preference: ${i}`},id:n.id})}else if(chrome.storage?.local)try{chrome.storage.local.set({[s]:i},()=>{const i=!chrome.runtime.lastError;i||t.y7.log("SettingsHandler",`Storage error for ${s}: ${chrome.runtime.lastError?.message}`,"error"),r.postMessage({type:e.Go.SETTINGS_SET_PREF_RESPONSE,payload:{name:s,success:i},id:n.id})})}catch(i){t.y7.log("SettingsHandler",`Error setting pref in storage ${s}: ${i}`,"error"),r.postMessage({type:e.Go.ERROR,payload:{error:`Failed to set preference: ${i}`},id:n.id})}else r.postMessage({type:e.Go.ERROR,payload:{error:"No storage backend available"},id:n.id})}async handleGetAllPrefs(n,r){try{chrome.storage.local.get(null,t=>{r.postMessage({type:e.Go.SETTINGS_GET_ALL_PREFS_RESPONSE,payload:{prefs:t},id:n.id})})}catch(s){t.y7.log("SettingsHandler",`Error getting all prefs: ${s}`,"error"),r.postMessage({type:e.Go.ERROR,payload:{error:`Failed to get all preferences: ${s}`},id:n.id})}}async handleTestMCP(n,r){const{serverUrl:s}=n.payload;try{performance.now();const t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json, text/event-stream"},body:JSON.stringify({jsonrpc:"2.0",method:"tools/list",id:1}),signal:AbortSignal.timeout(1e4)});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const i=await t.json();if(i.error)throw new Error(`MCP Error: ${i.error.message||JSON.stringify(i.error)}`);if(!i.result||!Array.isArray(i.result.tools))throw new Error("Invalid MCP response: missing tools array");const a=i.result.tools.length,o=i.result.tools.map(e=>({name:e.name,description:e.description}));r.postMessage({type:e.Go.SETTINGS_TEST_MCP_RESPONSE,payload:{success:!0,toolCount:a,tools:o,timestamp:(new Date).toISOString()},id:n.id})}catch(s){t.y7.log("SettingsHandler",`Error testing MCP server: ${s}`,"error"),r.postMessage({type:e.Go.SETTINGS_TEST_MCP_RESPONSE,payload:{success:!1,error:s instanceof Error?s.message:"Unknown error",timestamp:(new Date).toISOString()},id:n.id})}}async handleTestProvider(r,s){const{provider:i}=r.payload;try{const{ChatOpenAI:t}=await Promise.resolve().then(n.bind(n,621)),{ChatAnthropic:a}=await Promise.resolve().then(n.bind(n,7439)),{ChatOllama:o}=await Promise.resolve().then(n.bind(n,9531)),{ChatGoogleGenerativeAI:c}=await Promise.resolve().then(n.bind(n,6739)),{HumanMessage:l}=await Promise.resolve().then(n.bind(n,9497)),u=performance.now();try{let n;switch(i.type){case"openai":const e=i.modelId||"gpt-4o-mini",r=e.includes("gpt-5")||e.includes("gpt-6"),s=e.includes("o1")||e.includes("o3")||e.includes("o4"),l={openAIApiKey:i.apiKey,modelName:e,temperature:r||s?1:.7,streaming:!1,configuration:{baseURL:i.baseUrl||"https://api.openai.com/v1"}};r||(s?l.modelKwargs={max_completion_tokens:100}:l.maxTokens=100),n=new t(l);break;case"anthropic":n=new a({anthropicApiKey:i.apiKey,modelName:i.modelId||"claude-3-5-sonnet-latest",temperature:.7,maxTokens:100,streaming:!1,anthropicApiUrl:i.baseUrl||"https://api.anthropic.com"});break;case"google_gemini":if(!i.apiKey)throw new Error("API key required for Google Gemini");n=new c({model:i.modelId||"gemini-2.0-flash",temperature:.7,maxOutputTokens:100,apiKey:i.apiKey,convertSystemMessageToHumanContent:!0,baseUrl:i.baseUrl||"https://generativelanguage.googleapis.com"});break;case"ollama":let u=i.baseUrl||"http://localhost:11434";u.includes("localhost")&&(u=u.replace("localhost","127.0.0.1")),n=new o({baseUrl:u,model:i.modelId||"qwen3:4b",temperature:.7,numPredict:100});break;case"openrouter":if(!i.apiKey)throw new Error("API key required for OpenRouter");const d=i.modelId||"auto",h=d.includes("gpt-5")||d.includes("gpt-6"),p=d.includes("o1")||d.includes("o3")||d.includes("o4"),m={openAIApiKey:i.apiKey,modelName:d,temperature:h||p?1:.7,streaming:!1,configuration:{baseURL:i.baseUrl||"https://openrouter.ai/api/v1"}};h||(p?m.modelKwargs={max_completion_tokens:100}:m.maxTokens=100),n=new t(m);break;case"openai_compatible":case"custom":if(!i.baseUrl)throw new Error("Base URL required for OpenAI Compatible provider");const g=i.modelId||"default",f=g.includes("gpt-5")||g.includes("gpt-6"),y=g.includes("o1")||g.includes("o3")||g.includes("o4"),_={openAIApiKey:i.apiKey||"dummy-key",modelName:g,temperature:f||y?1:.7,streaming:!1,configuration:{baseURL:i.baseUrl}};f||(y?_.modelKwargs={max_completion_tokens:100}:_.maxTokens=100),n=new t(_);break;case"vibebrowser":n=new t({openAIApiKey:"vibebrowser-key",modelName:"default-llm",temperature:.7,maxTokens:100,streaming:!1,configuration:{baseURL:"https://llm.vibebrowser.com/default/"}});break;default:throw new Error(`Unsupported provider type: ${i.type}`)}const d=new l('Hello! Please respond with "Hello World" to confirm you are working.'),h=await n.invoke([d]),p=performance.now()-u;s.postMessage({type:e.Go.SETTINGS_TEST_PROVIDER_RESPONSE,payload:{success:!0,latency:p,response:h.content,timestamp:(new Date).toISOString()},id:r.id})}catch(t){const n=performance.now()-u;s.postMessage({type:e.Go.SETTINGS_TEST_PROVIDER_RESPONSE,payload:{success:!1,latency:n,error:t instanceof Error?t.message:"Unknown error",timestamp:(new Date).toISOString()},id:r.id})}}catch(n){t.y7.log("SettingsHandler",`Error testing provider: ${n}`,"error"),s.postMessage({type:e.Go.ERROR,payload:{error:`Failed to test provider: ${n}`},id:r.id})}}},uo=new class{constructor(){this.teachModeService=no.TeachModeService.getInstance(),chrome.tabs.onRemoved.addListener(e=>{this.teachModeService.handleTabClosed(e)})}async handleTeachModeStart(n,r){try{const{tabId:t}=n.payload;let s=t;if(!s){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e?.id)throw new Error("No active tab found");s=e.id}await this.teachModeService.startRecording(s);const i=this.teachModeService.getCurrentSession(),a=i?i.getSession().id:void 0;r.postMessage({type:e.Go.TEACH_MODE_STATUS,payload:{success:!0,tabId:s,sessionId:a,message:"Recording started"},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("TeachModeHandler",`Failed to start recording: ${i}`,"error"),r.postMessage({type:e.Go.TEACH_MODE_STATUS,payload:{success:!1,error:i},id:n.id})}}async handleTeachModeStop(n,r){try{const{audioData:t}=n.payload||{},s=await this.teachModeService.stopRecording(t);if(!s)return void r.postMessage({type:e.Go.TEACH_MODE_STATUS,payload:{success:!1,message:"No active recording"},id:n.id});r.postMessage({type:e.Go.TEACH_MODE_STATUS,payload:{success:!0,recording:s,message:`Recording stopped with ${s.events.length} events`},id:n.id})}catch(s){const i=s instanceof Error?s.message:String(s);t.y7.log("TeachModeHandler",`Failed to stop recording: ${i}`,"error"),r.postMessage({type:e.Go.TEACH_MODE_STATUS,payload:{success:!1,error:i},id:n.id})}}async handleTeachModeStatus(t,n){n.postMessage({type:e.Go.TEACH_MODE_STATUS,payload:{success:!0,isRecording:this.teachModeService.isRecording(),tabId:this.teachModeService.getCurrentSession()?.getActiveTabId()},id:t.id})}async handleTeachModeList(t,n){try{const r=await this.teachModeService.getRecordings();n.postMessage({type:e.Go.TEACH_MODE_LIST,payload:{success:!0,recordings:r},id:t.id})}catch(r){const s=r instanceof Error?r.message:String(r);n.postMessage({type:e.Go.TEACH_MODE_LIST,payload:{success:!1,error:s},id:t.id})}}async handleTeachModeGet(t,n){try{const{recordingId:r}=t.payload,s=await this.teachModeService.getRecording(r);n.postMessage({type:e.Go.TEACH_MODE_GET,payload:{success:!0,recording:s},id:t.id})}catch(r){const s=r instanceof Error?r.message:String(r);n.postMessage({type:e.Go.TEACH_MODE_GET,payload:{success:!1,error:s},id:t.id})}}async handleTeachModeDelete(n,r){try{const{recordingId:s}=n.payload;await this.teachModeService.deleteRecording(s),t.y7.log("TeachModeHandler",`Deleted recording: ${s}`),await this.teachModeService.deleteWorkflow(s),t.y7.log("TeachModeHandler",`Deleted workflow: ${s}`),r.postMessage({type:e.Go.TEACH_MODE_DELETE,payload:{success:!0},id:n.id})}catch(t){const s=t instanceof Error?t.message:String(t);r.postMessage({type:e.Go.TEACH_MODE_DELETE,payload:{success:!1,error:s},id:n.id})}}async handleTeachModeClear(t,n){try{await this.teachModeService.clearAllRecordings(),n.postMessage({type:e.Go.TEACH_MODE_CLEAR,payload:{success:!0},id:t.id})}catch(r){const s=r instanceof Error?r.message:String(r);n.postMessage({type:e.Go.TEACH_MODE_CLEAR,payload:{success:!1,error:s},id:t.id})}}async handleTeachModeExport(t,n){try{const{recordingId:r}=t.payload;await this.teachModeService.exportRecording(r),n.postMessage({type:e.Go.TEACH_MODE_EXPORT,payload:{success:!0},id:t.id})}catch(r){const s=r instanceof Error?r.message:String(r);n.postMessage({type:e.Go.TEACH_MODE_EXPORT,payload:{success:!1,error:s},id:t.id})}}async handleTeachModeImport(t,n){try{const{json:r,title:s}=t.payload,i=await this.teachModeService.importRecording(r,s);n.postMessage({type:e.Go.TEACH_MODE_IMPORT,payload:{success:!0,recordingId:i},id:t.id})}catch(r){const s=r instanceof Error?r.message:String(r);n.postMessage({type:e.Go.TEACH_MODE_IMPORT,payload:{success:!1,error:s},id:t.id})}}async handleTeachModeStats(t,n){try{const r=await this.teachModeService.getStorageStats();n.postMessage({type:e.Go.TEACH_MODE_STATS,payload:{success:!0,stats:r},id:t.id})}catch(r){const s=r instanceof Error?r.message:String(r);n.postMessage({type:e.Go.TEACH_MODE_STATS,payload:{success:!1,error:s},id:t.id})}}async handleTeachModeSearch(t,n){try{const{query:r}=t.payload,s=await this.teachModeService.searchRecordings(r);n.postMessage({type:e.Go.TEACH_MODE_SEARCH,payload:{success:!0,recordings:s},id:t.id})}catch(r){const s=r instanceof Error?r.message:String(r);n.postMessage({type:e.Go.TEACH_MODE_SEARCH,payload:{success:!1,error:s},id:t.id})}}async handleTeachModeGetWorkflow(t,n){try{const{recordingId:r}=t.payload,s=await this.teachModeService.getWorkflow(r);n.postMessage({type:e.Go.TEACH_MODE_GET_WORKFLOW,payload:{success:!0,workflow:s},id:t.id})}catch(r){const s=r instanceof Error?r.message:String(r);n.postMessage({type:e.Go.TEACH_MODE_GET_WORKFLOW,payload:{success:!1,error:s},id:t.id})}}async handleTeachModeUpdateWorkflow(t,n){try{const{recordingId:r,updates:s}=t.payload,i=await this.teachModeService.updateWorkflow(r,s);n.postMessage({type:e.Go.TEACH_MODE_UPDATE_WORKFLOW,payload:{success:i},id:t.id})}catch(r){const s=r instanceof Error?r.message:String(r);n.postMessage({type:e.Go.TEACH_MODE_UPDATE_WORKFLOW,payload:{success:!1,error:s},id:t.id})}}};ao.setPortManager(so);let ho=!1,po=!1;function mo(e){so.registerPort(e);"sidepanel"===e.name&&(ho=!0,t.y7.log("Background","Side panel connected"),t.y7.logMetric("side_panel_opened",{source:"port_connection"})),t.y7.registerPort(e.name,e),e.onMessage.addListener(t=>{ro.routeMessage(t,e)}),e.onDisconnect.addListener(()=>{so.unregisterPort(e),"sidepanel"===e.name&&(ho=!1,t.y7.log("Background","Side panel disconnected"),t.y7.logMetric("side_panel_closed",{source:"port_disconnection"})),t.y7.unregisterPort(e.name)})}async function go(n){if(!po){po=!0;try{ho?(chrome.runtime.sendMessage({type:e.Go.CLOSE_PANEL}).catch(()=>{}),ho=!1,t.y7.log("Background","Panel toggled off")):(await chrome.sidePanel.open({tabId:n}),ho=!0,t.y7.log("Background","Panel toggled on"),t.y7.logMetric("side_panel_toggled"))}catch(e){if(t.y7.log("Background",`Error toggling side panel: ${e}`,"error"),!ho)try{const e=await chrome.tabs.get(n);e.windowId&&(await chrome.sidePanel.open({windowId:e.windowId}),ho=!0)}catch(e){t.y7.log("Background",`Fallback failed: ${e}`,"error")}}finally{setTimeout(()=>{po=!1},300)}}}chrome.runtime.onInstalled.addListener(async e=>{if("install"===e.reason)try{t.y7.log("Background","First install - showing onboarding"),t.y7.logMetric("onboarding_started",{trigger:"install"});const e=chrome.runtime.getURL("onboarding.html");await chrome.tabs.create({url:e}),await i.markAsSeen()}catch(e){t.y7.log("Background",`Onboarding error: ${e}`,"error")}}),t.y7.log("Background","Nxtscape extension initializing"),t.y7.logMetric("extension_initialized"),ro.registerHandler(e.Go.EXECUTE_QUERY,(e,t)=>io.handleExecuteQuery(e,t)),ro.registerHandler(e.Go.CANCEL_TASK,(e,t)=>io.handleCancelTask(e,t)),ro.registerHandler(e.Go.RESET_CONVERSATION,(e,t)=>io.handleResetConversation(e,t)),ro.registerHandler(e.Go.HUMAN_INPUT_RESPONSE,(e,t)=>io.handleHumanInputResponse(e,t)),ro.registerHandler(e.Go.EXTRACT_PAGE_CONTENT,(e,t)=>io.handleExtractPageContent(e,t)),ro.registerHandler(e.Go.EXECUTE_TEACH_MODE_WORKFLOW,(e,t)=>io.handleExecuteTeachModeWorkflow(e,t)),ro.registerHandler(e.Go.GET_LLM_PROVIDERS,(e,t)=>ao.handleGetProviders(e,t)),ro.registerHandler(e.Go.SAVE_LLM_PROVIDERS,(e,t)=>ao.handleSaveProviders(e,t)),ro.registerHandler(e.Go.GET_MCP_SERVERS,(e,t)=>oo.handleGetMCPServers(e,t)),ro.registerHandler(e.Go.CONNECT_MCP_SERVER,(e,t)=>oo.handleConnectMCPServer(e,t)),ro.registerHandler(e.Go.DISCONNECT_MCP_SERVER,(e,t)=>oo.handleDisconnectMCPServer(e,t)),ro.registerHandler(e.Go.CALL_MCP_TOOL,(e,t)=>oo.handleCallMCPTool(e,t)),ro.registerHandler(e.Go.MCP_INSTALL_SERVER,(e,t)=>oo.handleInstallServer(e,t)),ro.registerHandler(e.Go.MCP_DELETE_SERVER,(e,t)=>oo.handleDeleteServer(e,t)),ro.registerHandler(e.Go.MCP_GET_INSTALLED_SERVERS,(e,t)=>oo.handleGetInstalledServers(e,t)),ro.registerHandler(e.Go.GENERATE_PLAN,(e,t)=>co.handleGeneratePlan(e,t)),ro.registerHandler(e.Go.REFINE_PLAN,(e,t)=>co.handleRefinePlan(e,t)),ro.registerHandler(e.Go.TEACH_MODE_START,(e,t)=>uo.handleTeachModeStart(e,t)),ro.registerHandler(e.Go.TEACH_MODE_STOP,(e,t)=>uo.handleTeachModeStop(e,t)),ro.registerHandler(e.Go.TEACH_MODE_STATUS,(e,t)=>uo.handleTeachModeStatus(e,t)),ro.registerHandler(e.Go.TEACH_MODE_LIST,(e,t)=>uo.handleTeachModeList(e,t)),ro.registerHandler(e.Go.TEACH_MODE_GET,(e,t)=>uo.handleTeachModeGet(e,t)),ro.registerHandler(e.Go.TEACH_MODE_DELETE,(e,t)=>uo.handleTeachModeDelete(e,t)),ro.registerHandler(e.Go.TEACH_MODE_CLEAR,(e,t)=>uo.handleTeachModeClear(e,t)),ro.registerHandler(e.Go.TEACH_MODE_EXPORT,(e,t)=>uo.handleTeachModeExport(e,t)),ro.registerHandler(e.Go.TEACH_MODE_IMPORT,(e,t)=>uo.handleTeachModeImport(e,t)),ro.registerHandler(e.Go.TEACH_MODE_STATS,(e,t)=>uo.handleTeachModeStats(e,t)),ro.registerHandler(e.Go.TEACH_MODE_SEARCH,(e,t)=>uo.handleTeachModeSearch(e,t)),ro.registerHandler(e.Go.TEACH_MODE_GET_WORKFLOW,(e,t)=>uo.handleTeachModeGetWorkflow(e,t)),ro.registerHandler(e.Go.TEACH_MODE_UPDATE_WORKFLOW,(e,t)=>uo.handleTeachModeUpdateWorkflow(e,t)),ro.registerHandler(e.Go.LOG_MESSAGE,(e,n)=>{const r=e.payload;t.y7.log(r.source||"Unknown",r.message,r.level||"info")}),ro.registerHandler(e.Go.LOG_METRIC,(e,n)=>{const{event:r,properties:s}=e.payload;t.y7.logMetric(r,s)}),ro.registerHandler(e.Go.HEARTBEAT,(t,n)=>{n.postMessage({type:e.Go.HEARTBEAT_ACK,payload:{timestamp:Date.now()},id:t.id})}),ro.registerHandler(e.Go.CLOSE_PANEL,async(n,r)=>{try{ho=!1,r.postMessage({type:e.Go.WORKFLOW_STATUS,payload:{status:"success",message:"Panel closing"},id:n.id})}catch(e){t.y7.log("Background",`Error closing panel: ${e}`,"error")}}),ro.registerHandler(e.Go.SETTINGS_GET_PREF,(e,t)=>lo.handleGetPref(e,t)),ro.registerHandler(e.Go.SETTINGS_SET_PREF,(e,t)=>lo.handleSetPref(e,t)),ro.registerHandler(e.Go.SETTINGS_GET_ALL_PREFS,(e,t)=>lo.handleGetAllPrefs(e,t)),ro.registerHandler(e.Go.SETTINGS_TEST_PROVIDER,(e,t)=>lo.handleTestProvider(e,t)),ro.registerHandler(e.Go.SETTINGS_TEST_MCP,(e,t)=>lo.handleTestMCP(e,t)),t.y7.log("Background","All message handlers registered"),chrome.runtime.onConnect.addListener(mo),chrome.action.onClicked.addListener(async e=>{t.y7.log("Background","Extension icon clicked"),e.id&&await go(e.id)}),chrome.commands.onCommand.addListener(async e=>{if("toggle-panel"===e){t.y7.log("Background","Toggle panel shortcut triggered (Cmd+E/Ctrl+E)");const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e?.id&&await go(e.id)}}),chrome.tabs.onRemoved.addListener(async e=>{t.y7.log("Background",`Tab ${e} removed`)}),chrome.runtime.onMessage.addListener((e,t,n)=>{if("NEWTAB_EXECUTE_QUERY"===e.type)return io.handleNewtabQuery(e,n),!0}),t.y7.log("Background","Nxtscape extension initialized successfully")})()})();